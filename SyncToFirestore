function setSheetDbSyncConfig() {
  var p = PropertiesService.getScriptProperties();
  p.setProperty('SYNC_SHEET_NAME', 'データ1');
  p.setProperty('SYNC_HEADER_ROW', '3');
  p.setProperty('SYNC_DATA_START_ROW', '4');

  p.setProperty('SYNC_URL_ROW', 'https://product-sync-api-243633874255.asia-northeast1.run.app/syncRow');
  p.setProperty('SYNC_URL_BULK', 'https://product-sync-api-243633874255.asia-northeast1.run.app/syncBulk');

  p.setProperty('SYNC_SECRET', 'h75gulQ5Pw9ZUs6t5sjiycSltZUk4q');

  p.setProperty('DOCID_KEYS', 'managedId,商品ID,管理番号,id,ID');
}

function installSheetDbSyncTrigger() {
  var ss = SpreadsheetApp.getActive();
  var all = ScriptApp.getProjectTriggers();
  for (var i = 0; i < all.length; i++) {
    if (all[i].getHandlerFunction() === 'sheetDbSyncOnEdit') return;
  }
  ScriptApp.newTrigger('sheetDbSyncOnEdit').forSpreadsheet(ss).onEdit().create();
}

function sheetDbSyncOnEdit(e) {
  try {
    if (!e || !e.range) return;

    var p = PropertiesService.getScriptProperties();
    var sheetName = String(p.getProperty('SYNC_SHEET_NAME') || 'データ1');
    var headerRow = Number(p.getProperty('SYNC_HEADER_ROW') || 3);
    var dataStartRow = Number(p.getProperty('SYNC_DATA_START_ROW') || 4);
    var url = String(p.getProperty('SYNC_URL_ROW') || '');
    var secret = String(p.getProperty('SYNC_SECRET') || '');

    if (!url || !secret) return;

    var sheet = e.range.getSheet();
    if (sheet.getName() !== sheetName) return;

    var row = e.range.getRow();
    if (row < dataStartRow) return;

    var lastCol = sheet.getLastColumn();
    if (lastCol < 1) return;

    var headers = sheet.getRange(headerRow, 1, 1, lastCol).getValues()[0];
    var values = sheet.getRange(row, 1, 1, lastCol).getValues()[0];

    var rowObj = buildRowObj_(headers, values);

    var docId = pickDocId_(rowObj);
    if (!docId) return;

    var deleted = isRowEmpty_(values);

    var payload = {
      sheetName: sheetName,
      rowIndex: row,
      docId: docId,
      deleted: deleted,
      row: rowObj
    };

    var options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      headers: { 'x-sync-secret': secret },
      muteHttpExceptions: true
    };

    UrlFetchApp.fetch(url, options);
  } catch (err) {
  }
}

function syncAllRowsToDb() {
  var p = PropertiesService.getScriptProperties();
  var sheetName = String(p.getProperty('SYNC_SHEET_NAME') || 'データ1');
  var headerRow = Number(p.getProperty('SYNC_HEADER_ROW') || 3);
  var dataStartRow = Number(p.getProperty('SYNC_DATA_START_ROW') || 4);
  var url = String(p.getProperty('SYNC_URL_BULK') || '');
  var secret = String(p.getProperty('SYNC_SECRET') || '');

  if (!url || !secret) throw new Error('設定が不足しています。setSheetDbSyncConfig() を先に実行してください。');

  var ss = SpreadsheetApp.getActive();
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) throw new Error('シートが見つかりません: ' + sheetName);

  var lastRow = sheet.getLastRow();
  var lastCol = sheet.getLastColumn();
  if (lastRow < dataStartRow || lastCol < 1) return;

  var headers = sheet.getRange(headerRow, 1, 1, lastCol).getValues()[0];
  var data = sheet.getRange(dataStartRow, 1, lastRow - dataStartRow + 1, lastCol).getValues();

  var items = [];
  for (var i = 0; i < data.length; i++) {
    var rowValues = data[i];
    var rowObj = buildRowObj_(headers, rowValues);

    var docId = pickDocId_(rowObj);
    if (!docId) continue;

    items.push({
      docId: docId,
      deleted: isRowEmpty_(rowValues),
      row: rowObj
    });
  }

  var chunkSize = 200;
  for (var from = 0; from < items.length; from += chunkSize) {
    var part = items.slice(from, from + chunkSize);
    var payload = { items: part };

    var options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      headers: { 'x-sync-secret': secret },
      muteHttpExceptions: true
    };

    UrlFetchApp.fetch(url, options);
  }
}

function buildRowObj_(headers, values) {
  var out = {};
  for (var i = 0; i < headers.length; i++) {
    var k = headers[i];
    if (k === null || k === '') continue;
    out[String(k).trim()] = values[i];
  }
  return out;
}

function pickDocId_(rowObj) {
  var p = PropertiesService.getScriptProperties();
  var keys = String(p.getProperty('DOCID_KEYS') || 'managedId,商品ID,管理番号,id,ID')
    .split(',')
    .map(function (s) { return String(s).trim(); })
    .filter(function (s) { return s; });

  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    var v = rowObj[k];
    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
  }
  return '';
}

function isRowEmpty_(values) {
  for (var i = 0; i < values.length; i++) {
    var v = values[i];
    if (v === null) continue;
    if (String(v).trim() !== '') return false;
  }
  return true;
}
