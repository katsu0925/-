<!-- BulkAdminList.html -->
<!DOCTYPE html>
<html><head>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;font-size:13px;color:#222;padding:12px;overflow-y:auto}
.loading{text-align:center;padding:30px;color:#888}
.empty{text-align:center;padding:30px;color:#888}
.list{display:flex;flex-direction:column;gap:6px}
.item{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#f9fafb;border-radius:8px;border:1px solid #e6e8ee}
.item:hover{background:#edf2ff}
.thumb{width:40px;height:40px;border-radius:4px;object-fit:cover;background:#eee;flex-shrink:0}
.thumb-empty{width:40px;height:40px;border-radius:4px;background:#e0e0e0;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;color:#999}
.info{flex:1;min-width:0}
.info .nm{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.info .meta{font-size:10px;color:#666;margin-top:2px}
.info .meta span{margin-right:6px}
.badge-on{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;background:#e6f4ea;color:#1e8e3e}
.badge-off{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;background:#fce8e6;color:#d93025}
.badge-disc{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;background:#fff3cd;color:#856404}
.badge-stock{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;background:#e8f0fe;color:#1a73e8}
.badge-stock-zero{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;background:#fce8e6;color:#d93025}
.actions{display:flex;gap:4px;flex-shrink:0}
.actions button{padding:5px 10px;border-radius:5px;font-size:10px;font-weight:700;border:none;cursor:pointer}
.btn-edit{background:#e8f0fe;color:#1a73e8}
.btn-edit:hover{background:#d2e3fc}
.btn-del{background:#fce8e6;color:#d93025}
.btn-del:hover{background:#f8d7d4}
.foot{display:flex;justify-content:flex-end;margin-top:12px;padding-top:10px;border-top:1px solid #eee}
.btn-close{background:#f5f5f5;color:#333;border:1px solid #ccc;padding:7px 14px;border-radius:6px;font-size:12px;cursor:pointer}
.toast{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#333;color:#fff;padding:8px 16px;border-radius:8px;display:none;z-index:99;font-size:12px;font-weight:700}
.toast.show{display:block}
</style>
</head>
<body>
<div id="loading" class="loading">読込中...</div>
<div id="list" class="list" style="display:none"></div>
<div id="empty" class="empty" style="display:none">商品がまだ登録されていません。</div>
<div class="foot">
  <button class="btn-close" onclick="google.script.host.close()">閉じる</button>
</div>
<div class="toast" id="toast"></div>

<script>
var products = [];
function $(id){ return document.getElementById(id); }
function showToast(msg){
  var t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2200);
}
function esc(s){ var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function fmtYen(n){ return '\u00a5' + String(Number(n)||0).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

function renderList() {
  var list = $('list');
  var empty = $('empty');
  $('loading').style.display = 'none';
  if (products.length === 0) { list.style.display = 'none'; empty.style.display = 'block'; return; }
  empty.style.display = 'none'; list.style.display = 'flex';
  var h = '';
  products.forEach(function(p) {
    var thumb = '';
    for (var j = 0; j < p.images.length; j++) { if (p.images[j]) { thumb = p.images[j]; break; } }
    var bc = p.active ? 'badge-on' : 'badge-off';
    var bt = p.active ? '公開' : '非公開';
    h += '<div class="item">';
    h += thumb
      ? '<img class="thumb" src="' + esc(thumb) + '" onerror="this.style.display=\'none\'">'
      : '<div class="thumb-empty">No Img</div>';
    h += '<div class="info"><div class="nm">' + esc(p.name) + '</div>';
    h += '<div class="meta"><span>' + esc(p.productId) + '</span>';
    h += '<span>' + fmtYen(p.price) + esc(p.unit) + '</span>';
    if (p.discount > 0) h += '<span class="badge-disc">' + Math.round(p.discount * 100) + '%OFF</span>';
    if (p.tag) h += '<span style="color:#e67700">' + esc(p.tag) + '</span>';
    var stockLabel = (p.stock === -1 || p.stock === undefined || p.stock === null) ? '\u5728\u5eab:\u221e' : '\u5728\u5eab:' + p.stock;
    var stockClass = (p.stock === 0) ? 'badge-stock-zero' : 'badge-stock';
    h += '<span class="' + stockClass + '">' + stockLabel + '</span>';
    h += '<span class="' + bc + '">' + bt + '</span></div></div>';
    h += '<div class="actions">';
    h += '<button class="btn-edit" onclick="editProduct(\'' + esc(p.productId) + '\')">編集</button>';
    h += '<button class="btn-del" onclick="deleteProduct(\'' + esc(p.productId) + '\',\'' + esc(p.name) + '\')">削除</button>';
    h += '</div></div>';
  });
  list.innerHTML = h;
}

google.script.run
  .withSuccessHandler(function(res){
    if (res && res.ok) { products = res.products || []; }
    renderList();
  })
  .withFailureHandler(function(e){
    $('loading').textContent = 'エラー: ' + (e && e.message ? e.message : e);
  })
  .adminBulkGetProducts();

function editProduct(pid) {
  google.script.run.showEditProductModal(pid);
  google.script.host.close();
}

function deleteProduct(pid, name) {
  if (!confirm('「' + name + '」を削除しますか？')) return;
  google.script.run
    .withSuccessHandler(function(res){
      if (res && res.ok) {
        products = res.products || [];
        renderList();
        showToast(res.message);
      } else {
        showToast(res && res.message ? res.message : '削除失敗');
      }
    })
    .withFailureHandler(function(e){ showToast('エラー: ' + (e && e.message ? e.message : e)); })
    .adminBulkDeleteProduct(pid);
}
</script>
</body></html>
