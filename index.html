
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>NKonlineApparel</title>
  <meta property="og:title" content="NKonlineApparel">
  <meta property="og:description" content="æ¡å¯¸ãƒ‡ãƒ¼ã‚¿ä»˜ãå¤ç€å¸ - 10ç‚¹ã‹ã‚‰è¦‹ç©ã‚‚ã‚Šå¯èƒ½">
  <meta property="og:type" content="website">
  <meta name="description" content="æ¡å¯¸ãƒ‡ãƒ¼ã‚¿ä»˜ãå¤ç€å¸ - 10ç‚¹ã‹ã‚‰è¦‹ç©ã‚‚ã‚Šå¯èƒ½">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‘•</text></svg>">
  <script src="https://www.google.com/recaptcha/api.js?render=6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1" async defer></script>
  <style>
    html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; color:#111; background:#f6f7f9; -webkit-text-size-adjust:100%; }
    * { box-sizing:border-box; }
    input, select, textarea, button { font-size:16px; }
    .topbar{position:sticky;top:0;z-index:20;background:#1e293b;border-bottom:1px solid #334155;padding:12px 14px;}
    .wrap{margin:0 auto;padding:12px 14px 90px;}
        .title{font-weight:900;font-size:18px;color:#f1f5f9;}
    .subnote{margin-top:6px;font-size:12px;color:#666;line-height:1.4;}
    .topDetails{margin-top:6px;cursor:pointer;}
    .topDetails a{cursor:pointer;}
    .topSummary{font-size:12px;font-weight:900;color:#555;cursor:pointer;list-style:none;display:flex;align-items:center;gap:6px;}
    .topSummary::-webkit-details-marker{display:none;}
    .topSummary::before{content:'â–¼';font-size:10px;transition:transform .2s;}
    details:not([open])>.topSummary::before{content:'â–¶';}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .field{min-width:170px;flex:1 1 170px;}
    .field.big{min-width:240px;flex:2 1 240px;}
    .controls input,.controls select{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .btn{padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .btn.primary{background:#111;color:#fff;border-color:#111;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,280px));gap:12px;margin-top:12px;justify-content:center;}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));} .card{min-height:auto;} .cardbody{padding:6px 6px;gap:3px;} .noText{font-size:11px;} .brandText{font-size:10px;-webkit-line-clamp:2;} .price{font-size:12px;} .meta{font-size:10px;} .badge{font-size:9px;padding:2px 5px;} .selectBtn{padding:7px 5px;font-size:11px;}}
    .card{background:#fff;border:1px solid #e6e8ee;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;}
    .thumb{width:100%;aspect-ratio:1/1;background:#f0f2f7;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
    .cardbody{padding:10px 12px;display:flex;flex-direction:column;gap:6px;flex:1;}
    .row1{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;}
    .leftTitle{display:flex;flex-direction:column;gap:2px;min-width:0;font-weight:900;line-height:1.25;}
    .noText{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:900;white-space:nowrap;}
    .brandText{font-weight:900;font-size:13px;line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .defectLine{font-size:11px;min-height:16px;line-height:16px;color:transparent;}
    .defectLine.hasDefect{color:#b8002a;font-weight:700;}
    .price{font-weight:900;color:#b8002a;white-space:nowrap;}
    .meta{font-size:12px;color:#444;line-height:1.35;white-space:pre-line;}
    .badges{display:flex;gap:4px;flex-wrap:nowrap;align-items:center;}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #e6e8ee;background:#f7f8fb;color:#333;}
    .badge.ok{background:#eef7ee;border-color:#cfe9cf;}
    .badge.warn{background:#fff5e6;border-color:#ffe0ad;}
    .badge.lock{background:#ffecec;border-color:#ffd0d0;color:#a40000;}
    .actions{display:flex;gap:10px;align-items:center;}
    .selectBtn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #d9deea;background:#0b6;color:#fff;font-weight:900;cursor:pointer;display:flex;justify-content:center;align-items:center;}
    .selectBtn.off{background:#fff;color:#111;border-color:#d9deea;}
    .selectBtn.disabled{background:#f2f3f6;color:#777;border-color:#e3e5ec;cursor:not-allowed;}
    .pager{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:16px 0 0;}
    .pageBtn{min-width:36px;padding:8px 10px;border:1px solid #d9deea;background:#fff;border-radius:10px;cursor:pointer;font-weight:900;}
    .pageBtn.active{background:#111;color:#fff;border-color:#111;}
    .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(246,247,249,.9);backdrop-filter:blur(8px);border-top:1px solid #e6e8ee;padding:10px 14px;}
    .stickyInner{max-width:1200px;margin:0 auto;display:flex;justify-content:center;align-items:center;gap:10px;}
    .cartBtn{width:min(520px,100%);height:46px;border-radius:14px;border:1px solid #111;background:#f6c400;color:#111;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;}
    .countPill{min-width:28px;height:28px;border-radius:999px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;padding:0 10px;}
    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:40;}
    .overlay.open{display:block;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(860px,94vw);max-height:86vh;background:#fff;border-radius:14px;border:1px solid #e6e8ee;z-index:50;display:none;overflow:hidden;}
    .modal.open{display:block;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modalTitle{font-weight:900;}
    .modalClose{background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1;padding:6px 10px;}
    .modalBody{padding:14px 16px;overflow:auto;max-height:calc(86vh - 56px);}
    .cartList{display:flex;flex-direction:column;gap:8px;}
    .cartRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid #eef0f6;padding:10px 0;}
    .cartImg{width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;background:#f5f5f5;cursor:pointer;}
    .cartInfo{display:flex;gap:10px;align-items:center;min-width:0;flex:1;}
    .cartLeft{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .cartName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline;}
    .cartSub{font-size:12px;color:#666;}
    .dangerBtn{border:1px solid #ff4d4f;color:#ff4d4f;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900;}
    .recommendSection{margin-top:16px;padding-top:16px;border-top:1px solid #eef0f6;}
    .recommendTitle{font-weight:900;font-size:14px;color:#333;margin-bottom:10px;}
    .recommendList{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;}
    .recommendCard{flex-shrink:0;width:100px;cursor:pointer;border:1px solid #eef0f6;border-radius:8px;overflow:hidden;background:#fff;transition:box-shadow .2s;}
    .recommendCard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .recommendCard img{width:100px;height:100px;object-fit:cover;display:block;}
    .recommendCard .rcInfo{padding:6px;font-size:11px;}
    .recommendCard .rcBrand{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .recommendCard .rcPrice{color:#b8002a;font-weight:900;}
    .mainRecommendSection{margin-bottom:20px;padding:16px;background:#f8f9fc;border-radius:12px;}
    .mainRecommendTitle{font-weight:900;font-size:16px;color:#333;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .mainRecommendTitle::before{content:'â˜…';color:#ffc107;}
    .mainRecommendList{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;}
    .mainRecommendList .recommendCard{width:120px;}
    .mainRecommendList .recommendCard img{width:120px;height:120px;}
    .authArea{display:flex;align-items:center;gap:10px;font-size:13px;}
    .authBtn{background:#334155;border:1px solid #475569;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:900;font-size:13px;color:#f1f5f9;}
    .authBtn:hover{background:#475569;}
    .authBtn.logout{background:transparent;border:none;color:#94a3b8;text-decoration:underline;padding:4px 8px;}
    .authUser{display:flex;align-items:center;gap:8px;}
    .authUserName{font-weight:900;color:#f1f5f9;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .authDiscount{background:#b8002a;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .sumBox{margin-top:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
    .sumLine{font-weight:900;}
    .hint{font-size:12px;color:#666;line-height:1.45;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:700px){.formGrid{grid-template-columns:1fr;}}
    .formField label{font-size:12px;color:#555;font-weight:900;display:block;margin-bottom:6px;}
    .formField input,.formField select,.formField textarea{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .formField textarea{min-height:90px;resize:vertical;}
    .formActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
    .toast{position:fixed;left:50%;bottom:82px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:12px;display:none;z-index:60;font-weight:900;max-width:92vw;}
    .toast.show{display:block;}
    .measureWrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .measureBtn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .measureBtn input{margin:0;}
    .sendingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80;}
    .sendingOverlay.on{display:flex;}
    .sendingBox{background:#fff;border:1px solid #e6e8ee;border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .sendingSpinner{width:26px;height:26px;border-radius:999px;border:3px solid rgba(0,0,0,.15);border-top-color:#111;animation:sendingSpin 0.9s linear infinite;}
    .sendingText{font-weight:900;font-size:14px;color:#111;}
    @keyframes sendingSpin{to{transform:rotate(360deg);}}
    .selectFieldBtn{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .selectFieldBtn .muted{font-weight:900;color:#666;font-size:12px;}
    .brandTools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .brandTools input{flex:1 1 240px;min-width:200px;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;font-size:14px;transition:border-color .2s,box-shadow .2s;}
    .brandTools input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .brandToolsBar{background:#fff;border-bottom:1px solid #eef0f6;padding:14px 16px 12px;}
    .brandIndexNav{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;padding-bottom:8px;}
    .brandIndexBtn{padding:6px 10px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
    .brandIndexBtn:hover{background:#e2e8f0;}
    .brandIndexBtn.active{background:#3b82f6;color:#fff;}
    .brandIndexBtn.filter-active{background:#10b981;color:#fff;}
    .brandGroupHeader{padding:12px 16px;margin:8px -16px 8px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);font-size:16px;font-weight:900;color:#1e293b;display:flex;align-items:center;gap:8px;}
    .brandGroupHeader::before{content:'';width:4px;height:20px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .brandList{display:flex;flex-direction:column;gap:4px;padding-top:8px;}
    .brandItem{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:#fff;cursor:pointer;user-select:none;transition:all .15s;}
    .brandItem:hover{background:#f8fafc;}
    .brandItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;}
    .brandItem input{display:none;}
    .brandItem .brand-check{width:22px;height:22px;border:2px solid #cbd5e1;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .brandItem.selected .brand-check{background:#3b82f6;border-color:#3b82f6;}
    .brandItem .brand-check::after{content:'âœ“';color:#fff;font-size:13px;font-weight:700;opacity:0;transition:opacity .15s;}
    .brandItem.selected .brand-check::after{opacity:1;}
    .brandName{font-weight:600;line-height:1.3;word-break:break-word;color:#334155;}
    .toTop{position:fixed;right:14px;bottom:86px;width:46px;height:46px;border-radius:999px;border:1px solid #d9deea;background:#fff;display:none;align-items:center;justify-content:center;font-weight:900;z-index:70;box-shadow:0 6px 18px rgba(0,0,0,.12);}
    .toTop.show{display:flex;}
    .price-old { text-decoration: line-through; color:#999; }
    .price-new { color:#b8002a; font-weight:700; }
    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆUIã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ç‰ˆ */
    .filter-sort-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .filter-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
    .filter-group:last-child{margin-bottom:0;}
    .filter-group-label{width:100%;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:flex;align-items:center;gap:6px;}
    .filter-group-label::before{content:'';width:3px;height:12px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .multiSelectField{position:relative;}
    .multiSelectBtn{padding:8px 14px;border:none;border-radius:20px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);transition:all .2s;}
    .multiSelectBtn:hover{box-shadow:0 2px 6px rgba(0,0,0,.12);transform:translateY(-1px);}
    .multiSelectBtn.active{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;}
    .multiSelectBtn .filterCount{background:#ef4444;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;font-weight:700;}
    .multiSelectBtn .filterCount:empty{display:none;}
    .multiSelectDropdown{display:none;position:absolute;top:calc(100% + 8px);left:0;min-width:180px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:100;max-height:240px;overflow-y:auto;padding:8px 0;}
    .multiSelectDropdown.open{display:block;animation:dropdownIn .2s ease;}
    @keyframes dropdownIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .multiSelectItem{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;font-size:13px;transition:background .15s;}
    .multiSelectItem:hover{background:#f1f5f9;}
    .multiSelectItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);color:#1d4ed8;font-weight:600;}
    .multiSelectItem input{display:none;}
    .multiSelectItem .check-icon{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .multiSelectItem.selected .check-icon{background:#3b82f6;border-color:#3b82f6;color:#fff;}
    .multiSelectItem .check-icon::after{content:'âœ“';font-size:11px;opacity:0;transition:opacity .15s;}
    .multiSelectItem.selected .check-icon::after{opacity:1;}
    .sort-wrap{display:flex;gap:8px;align-items:center;}
    .sort-control{border:none !important;border-radius:20px !important;background:#fff !important;padding:8px 14px !important;font-weight:600 !important;font-size:13px !important;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer;}
    .sort-control:focus{outline:2px solid #8b5cf6;outline-offset:2px;}
    .detail-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center; }
    .detail-modal-overlay.active { display: flex; }
    .detail-modal { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .detail-modal-close { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
    .detail-modal-image { width: 100%; max-height: 300px; object-fit: contain; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-modal-content { padding: 20px; }
    .detail-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
    .detail-section { margin-bottom: 16px; }
    .detail-section-title { font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
    .detail-defect { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 14px; color: #92400e; }
    .measurement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    .measurement-item { background: #f3f4f6; border-radius: 6px; padding: 8px 12px; text-align: center; }
    .measurement-label { font-size: 12px; color: #6b7280; }
    .measurement-value { font-size: 16px; font-weight: 600; color: #111827; }
    .detail-modal-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }
    .detail-add-btn { flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .detail-add-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .detail-loading { display: flex; justify-content: center; align-items: center; min-height: 100px; color: #6b7280; }
    .product-image-clickable { cursor: zoom-in; }
    .detail-info-grid { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-bottom: 8px; }
    .detail-info-item { font-size: 14px; color: #374151; background: #f9fafb; padding: 4px 10px; border-radius: 6px; }
    .detail-info-label { font-weight: 600; color: #6b7280; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap" style="padding:0 14px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <div class="title" id="appTitle">NKonlineApparel</div>
          <div class="badge ok" id="totalCountBadge"></div>
        </div>
        <div class="authArea" id="authArea">
          <button class="authBtn" id="openAuthBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
      </div>
      <div style="display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; align-items:center;">
        <a href="#" id="openGuideLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">ğŸ“¦ å•†å“ã‚¬ã‚¤ãƒ‰</a>
        <a href="#" id="openShippingLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">ğŸšš é€æ–™è¡¨</a>
        <a href="#" id="openContactLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">âœ‰ ãŠå•ã„åˆã‚ã›</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="filter-sort-section">
      <!-- ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠ -->
      <div class="filter-group">
        <div class="filter-group-label">ãƒ–ãƒ©ãƒ³ãƒ‰</div>
        <button class="selectFieldBtn" id="brandBtn" type="button" style="flex:1;max-width:300px;">
          <span id="brandBtnText">ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é¸æŠ</span>
          <span class="muted" id="brandBtnSub">æœªé¸æŠ</span>
        </button>
      </div>
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="filter-group">
        <div class="filter-group-label">çµã‚Šè¾¼ã¿</div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fCategoryBtn" type="button">ã‚«ãƒ†ã‚´ãƒª <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fCategoryDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fStateBtn" type="button">çŠ¶æ…‹ <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fStateDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fGenderBtn" type="button">æ€§åˆ¥ <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fGenderDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fSizeBtn" type="button">ã‚µã‚¤ã‚º <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fSizeDropdown"></div>
        </div>
      </div>
      <!-- ã‚½ãƒ¼ãƒˆ -->
      <div class="filter-group">
        <div class="filter-group-label">ä¸¦ã¹æ›¿ãˆ</div>
        <div class="sort-wrap">
          <select id="sortKey" class="sort-control"></select>
          <select id="sortDir" class="sort-control">
            <option value="asc">æ˜‡é †</option>
            <option value="desc">é™é †</option>
          </select>
          <button class="btn" id="btnReset" type="button" style="padding:8px 16px;border-radius:20px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ãŠã™ã™ã‚å•†å“ -->
    <div class="mainRecommendSection" id="mainRecommend" style="display:none;">
      <div class="mainRecommendTitle">ãŠã™ã™ã‚å•†å“</div>
      <div class="mainRecommendList" id="mainRecommendList"></div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pager" class="pager"></div>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <button class="cartBtn" id="openCartBtn" type="button">
       <span>ã‚«ãƒ¼ãƒˆã‚’ç¢ºèª</span>
       <span class="countPill" id="cartCount">0</span>
       <span id="cartTotal" style="font-weight:900; margin-left:8px;">0å††</span>
      </button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="modal" id="brandModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠ</div>
      <button class="modalClose" id="brandCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="brandToolsBar">
      <div class="brandTools">
        <input id="brandSearch" type="text" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰åã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šãƒŠã‚¤ã‚­ã€NIKEï¼‰">
        <button class="btn" id="brandClearBtn" type="button">ã‚¯ãƒªã‚¢</button>
        <button class="btn primary" id="brandApplyBtn" type="button">é©ç”¨</button>
      </div>
      <div class="hint" style="margin-top:8px;" id="brandHint"></div>
      <div class="brandIndexNav" id="brandIndexNav"></div>
    </div>
    <div class="modalBody" style="max-height:calc(86vh - 180px);">
      <div id="brandList" class="brandList"></div>
    </div>
  </div>

  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">ã‚«ãƒ¼ãƒˆ</div>
      <button class="modalClose" id="cartCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody">
      <div class="cartList" id="cartList"></div>
      <!-- ãŠã™ã™ã‚å•†å“ -->
      <div class="recommendSection" id="cartRecommend" style="display:none;">
        <div class="recommendTitle">ãŠã™ã™ã‚å•†å“</div>
        <div class="recommendList" id="cartRecommendList"></div>
      </div>
      <div class="sumBox">
        <div class="sumLine" id="sumCount"></div>
        <div class="sumLine" id="sumPrice"></div>
        <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; width:100%;">
          <button class="btn" id="clearCartBtn" style="min-width:160px;" type="button">ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹</button>
          <button class="btn primary" id="goFormBtn" style="min-width:220px;" type="button">è³¼å…¥æ‰‹ç¶šãã¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="authModalTitle">ãƒ­ã‚°ã‚¤ãƒ³</div>
      <button class="modalClose" id="authCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody">
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="loginForm">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
            <input id="loginEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
            <input id="loginPassword" type="password" autocomplete="current-password">
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="loginBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ <a href="#" id="showRegisterLink">æ–°è¦ç™»éŒ²</a>
          </div>
        </div>
      </div>
      <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="registerForm" style="display:none;">
        <div class="formGrid">
          <div class="formField">
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
            <input id="regEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰ *</label>
            <input id="regPassword" type="password" autocomplete="new-password">
          </div>
          <div class="formField">
            <label>ä¼šç¤¾å/æ°å *</label>
            <input id="regCompanyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>é›»è©±ç•ªå·</label>
            <input id="regPhone" type="tel" inputmode="numeric">
          </div>
          <div class="formField">
            <label>éƒµä¾¿ç•ªå·</label>
            <input id="regPostal" type="text" inputmode="numeric" placeholder="0000000">
          </div>
          <div class="formField">
            <label>ä½æ‰€</label>
            <input id="regAddress" type="text" autocomplete="street-address">
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="regNewsletter" checked style="width:18px;height:18px;">
              <span>ãŠå¾—ãªæƒ…å ±ã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹</span>
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;margin-top:14px;">
          <button class="btn primary" id="registerBtn" type="button">ç™»éŒ²ã™ã‚‹</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ <a href="#" id="showLoginLink">ãƒ­ã‚°ã‚¤ãƒ³</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="formModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">ãŠå±Šã‘å…ˆæƒ…å ±</div>
      <button class="modalClose" id="formCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="formField">
          <label>ä¼šç¤¾å/æ°å *</label>
          <input id="companyName" type="text" autocomplete="name">
        </div>
        <div class="formField">
          <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
          <input id="contact" type="email" autocomplete="email" placeholder="example@example.com">
        </div>
        <div class="formField">
          <label>éƒµä¾¿ç•ªå·</label>
          <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="0000000">
        </div>
        <div class="formField">
          <label>ä½æ‰€</label>
          <input id="address" type="text" autocomplete="street-address">
        </div>
        <div class="formField">
          <label>é›»è©±ç•ªå·</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="00000000000" autocomplete="tel">
        </div>
        <div class="formField">
          <label>å‚™è€ƒ</label>
          <textarea id="note"></textarea>
        </div>
      </div>
      <div class="formActions">
        <button class="btn" id="formBackBtn" type="button">æˆ»ã‚‹</button>
        <button class="btn primary" id="submitBtn" type="button">è¦‹ç©ã‚‚ã‚Šã‚’é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div class="modal" id="doneModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">è¦‹ç©ã‚‚ã‚Šé€ä¿¡å®Œäº†</div>
      <button class="modalClose" id="doneCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody" style="text-align:center;">
      <div style="font-weight:900; font-size:14px;">å—ä»˜ç•ªå·</div>
      <div style="margin-top:8px; font-size:24px; font-weight:900; color:#3b82f6;" id="doneReceipt"></div>
      <div style="margin-top:16px; font-size:14px; color:#333; line-height:1.6;">
        è¦‹ç©ã‚‚ã‚Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ç¢ºå®šé‡‘é¡ãƒ»é€æ–™ã‚’ãƒ¡ãƒ¼ãƒ«ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã®ã§ã€å—ä»˜ç•ªå·ã‚’ãŠæ§ãˆã®ä¸Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <!-- ãŠå•ã„åˆã‚ã›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="contactModal" aria-hidden="true" style="width:min(500px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">ãŠå•ã„åˆã‚ã›</div>
      <button class="modalClose" id="contactCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody">
      <div class="formField">
        <label>ãŠåå‰ *</label>
        <input type="text" id="contactName" placeholder="ä¼šç¤¾å/æ°å">
      </div>
      <div class="formField">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
        <input type="email" id="contactEmail" placeholder="è¿”ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
      </div>
      <div class="formField">
        <label>ãŠå•ã„åˆã‚ã›å†…å®¹ *</label>
        <textarea id="contactMessage" rows="6" placeholder="ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’ã”è¨˜å…¥ãã ã•ã„"></textarea>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn primary" id="contactSubmitBtn" type="button">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div id="sendingOverlay" class="sendingOverlay" aria-hidden="true">
    <div class="sendingBox" role="status" aria-live="polite">
      <div class="sendingSpinner"></div>
      <div id="sendingText" class="sendingText">ä¾é ¼é€ä¿¡ä¸­...</div>
    </div>
  </div>
  <button class="toTop" id="toTopBtn" type="button" aria-label="ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã¸">â†‘</button>

  <div class="detail-modal-overlay" id="detailModal">
    <div class="detail-modal">
      <button class="detail-modal-close" onclick="closeDetailModal()">Ã—</button>
      <div id="detailModalBody">
        <div class="detail-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- å•†å“ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="guideModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">ğŸ“¦ å•†å“ã‚¬ã‚¤ãƒ‰</div>
      <button class="modalClose" id="guideCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">å•†å“ã«ã¤ã„ã¦</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>ã™ã¹ã¦ã®å•†å“ã«ã¯<strong>æ¡å¯¸ãƒ‡ãƒ¼ã‚¿</strong>ãŒä»˜ã„ã¦ã„ã¾ã™</li>
          <li>å†™çœŸã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚å®Ÿç‰©ã¨å¤šå°‘ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</li>
          <li>çŠ¶æ…‹ãƒ©ãƒ³ã‚¯ã¯ç›®è¦–ã«ã‚ˆã‚‹åˆ¤å®šã¨ãªã‚Šã¾ã™</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">çŠ¶æ…‹ãƒ©ãƒ³ã‚¯ã«ã¤ã„ã¦</h3>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr style="background:#f1f5f9;"><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">ãƒ©ãƒ³ã‚¯</th><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">çŠ¶æ…‹</th></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#10b981;">S</td><td style="padding:10px;border:1px solid #e2e8f0;">æ–°å“ãƒ»æœªä½¿ç”¨ãƒ»ã‚¿ã‚°ä»˜ããªã©</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#3b82f6;">A</td><td style="padding:10px;border:1px solid #e2e8f0;">ä½¿ç”¨æ„ŸãŒã»ã¨ã‚“ã©ãªã„ç¾å“</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#6366f1;">AB</td><td style="padding:10px;border:1px solid #e2e8f0;">å¤šå°‘ã®ä½¿ç”¨æ„ŸãŒã‚ã‚‹ãŒçŠ¶æ…‹è‰¯å¥½</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#8b5cf6;">B</td><td style="padding:10px;border:1px solid #e2e8f0;">ä¸€èˆ¬çš„ãªä½¿ç”¨æ„Ÿãƒ»è»½å¾®ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚ã‚Š</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#a855f7;">C</td><td style="padding:10px;border:1px solid #e2e8f0;">ä½¿ç”¨æ„Ÿå¼·ã‚ãƒ»ç›®ç«‹ã¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚ã‚Š</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#d946ef;">D</td><td style="padding:10px;border:1px solid #e2e8f0;">ã‚¸ãƒ£ãƒ³ã‚¯ãƒ»é›£ã‚ã‚Šå“</td></tr>
        </table>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ã”æ³¨æ–‡ã«ã¤ã„ã¦</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong style="color:#1e293b;">10ç‚¹ã‹ã‚‰</strong>è¦‹ç©ã‚‚ã‚Šå¯èƒ½ã§ã™</li>
          <li style="margin-bottom:8px;">åˆè¨ˆé‡‘é¡ã¯å•†å“ä»£ã®ã¿ã§ã™ï¼ˆ<a href="https://drive.google.com/file/d/1g7UYUBw3-Y6M5HkSv3mfMe5jEjs795E3/view?usp=sharing" target="_blank" rel="noopener noreferrer">é€æ–™åˆ¥</a>ï¼‰ã€‚é€æ–™ã¯BASEå´ã§ç¢ºå®šã—ã¾ã™</li>
          <li style="margin-bottom:8px;">åœ¨åº«ã¯å…ˆç€ã®ãŸã‚ã€é€ä¿¡å¾Œã«æ¬ å“ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆç¢ºä¿ä¸­è¡¨ç¤ºãŒã‚ã‚‹å ´åˆã¯ãã®æ™‚é–“å†…ã¯ç¢ºä¿ï¼‰</li>
          <li>é€ä¿¡å¾Œã€å—ä»˜ç•ªå·ã‚’ãŠæ§ãˆãã ã•ã„ã€‚ç¢ºå®šé‡‘é¡ãƒ»é€æ–™ã‚’ã”æ¡ˆå†…å¾Œã€BASEã§æ±ºæ¸ˆã¨ãªã‚Šã¾ã™</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ã”æ³¨æ–‡ã®æµã‚Œ</h3>
        <ol style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong>å•†å“é¸æŠ</strong>ï¼šãŠå¥½ã¿ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ </li>
          <li style="margin-bottom:8px;"><strong>è¦‹ç©ã‚‚ã‚Šé€ä¿¡</strong>ï¼šãŠå±Šã‘å…ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦é€ä¿¡</li>
          <li style="margin-bottom:8px;"><strong>ã”æ¡ˆå†…</strong>ï¼šç¢ºå®šé‡‘é¡ãƒ»é€æ–™ã‚’ãƒ¡ãƒ¼ãƒ«ã§ã”æ¡ˆå†…</li>
          <li><strong>ç™ºé€</strong>ï¼šãŠæ”¯æ‰•ã„ç¢ºèªå¾Œã€å•†å“ã‚’ç™ºé€ã„ãŸã—ã¾ã™</li>
        </ol>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">å‰²å¼•ã«ã¤ã„ã¦</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><span style="color:#b8002a;font-weight:700;">30ç‚¹ä»¥ä¸Šã§10%å‰²å¼•</span></li>
          <li><strong>ä¼šå“¡å‰²å¼•</strong>ï¼šä¼šå“¡ç™»éŒ²ã§<span style="color:#b8002a;font-weight:700;">10%OFF</span></li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">æ³¨æ„äº‹é …</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>å•†å“ã®ç¢ºä¿æœŸé–“ã¯<strong>15åˆ†</strong>ã§ã™ï¼ˆã‚«ãƒ¼ãƒˆã«å…¥ã‚ŒãŸæ™‚ç‚¹ã‹ã‚‰ï¼‰</li>
          <li>ã”æ³¨æ–‡ç¢ºå®šå¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯ã§ãã¾ã›ã‚“</li>
          <li>è¿”å“ãƒ»äº¤æ›ã¯åŸå‰‡ãŠå—ã‘ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ä¸‡ä¸€ã€å•†å“å†…å®¹ãŒè¨˜è¼‰äº‹é …ã¨å¤§ããç•°ãªã‚‹å ´åˆã¯ã€å•†å“åˆ°ç€å¾Œ7æ—¥ä»¥å†…ã«ã”é€£çµ¡ãã ã•ã„</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- é€æ–™è¡¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="shippingModal" aria-hidden="true" style="width:min(800px,96vw);">
    <div class="modalHeader">
      <div class="modalTitle">ğŸšš é€æ–™è¡¨</div>
      <button class="modalClose" id="shippingCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <!-- è¥¿æ—¥æœ¬ -->
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f472b6;padding-bottom:8px;">è¥¿æ—¥æœ¬ï¼ˆå—ä¹å·ã€œåŒ—é™¸ï¼‰</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#fce7f3;">
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;width:80px;">å®…é…ä¾¿</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">å—ä¹å·</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">åŒ—ä¹å·</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">å››å›½</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">ä¸­å›½</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">é–¢è¥¿</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">åŒ—é™¸</th>
            </tr>
            <tr style="background:#fdf2f8;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">éƒ½é“åºœçœŒ</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">é¹¿å…å³¶ãƒ»ç†Šæœ¬ãƒ»å®®å´</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">ç¦å²¡ãƒ»ä½è³€ãƒ»å¤§åˆ†ãƒ»é•·å´</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">é¦™å·ãƒ»æ„›åª›ãƒ»é«˜çŸ¥ãƒ»å¾³å³¶</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">åºƒå³¶ãƒ»å²¡å±±ãƒ»å³¶æ ¹ãƒ»å±±å£ãƒ»é³¥å–</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">å¤§é˜ªãƒ»å…µåº«ãƒ»äº¬éƒ½ãƒ»å¥ˆè‰¯ãƒ»å’Œæ­Œå±±ãƒ»æ»‹è³€</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">çŸ³å·ãƒ»ç¦äº•ãƒ»å¯Œå±±</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">å®…é…ä¾¿ï¼ˆå°ï¼‰</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,320å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,280å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,180å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,200å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,100å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,160å††</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">å®…é…ä¾¿ï¼ˆå¤§ï¼‰</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,700å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,620å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,440å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,480å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,260å††</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,420å††</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- æ±æ—¥æœ¬ -->
      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #67e8f9;padding-bottom:8px;">æ±æ—¥æœ¬ï¼ˆæ±æµ·ã€œåŒ—æµ·é“ï¼‰</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#cffafe;">
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;width:80px;">å®…é…ä¾¿</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">æ±æµ·</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">ä¿¡è¶Š</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">é–¢æ±</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">å—æ±åŒ—</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">åŒ—æ±åŒ—</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">åŒ—æµ·é“</th>
            </tr>
            <tr style="background:#ecfeff;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">éƒ½é“åºœçœŒ</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">æ„›çŸ¥ãƒ»é™å²¡ãƒ»å²é˜œãƒ»ä¸‰é‡</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">æ–°æ½Ÿãƒ»é•·é‡</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">æ±äº¬ãƒ»ç¥å¥ˆå·ãƒ»åŸ¼ç‰ãƒ»åƒè‘‰ãƒ»èŒ¨åŸãƒ»æ ƒæœ¨ãƒ»ç¾¤é¦¬ãƒ»å±±æ¢¨</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">å®®åŸãƒ»ç¦å³¶ãƒ»å±±å½¢</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">å²©æ‰‹ãƒ»ç§‹ç”°ãƒ»é’æ£®</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">åŒ—æµ·é“</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">å®…é…ä¾¿ï¼ˆå°ï¼‰</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,180å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,220å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,300å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,400å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,460å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,640å††</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">å®…é…ä¾¿ï¼ˆå¤§ï¼‰</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,440å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,540å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,680å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,900å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,980å††</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">2,380å††</td>
            </tr>
          </table>
        </div>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">ã‚µã‚¤ã‚ºã®ç›®å®‰</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;font-size:13px;">
          <li><strong>å®…é…ä¾¿ï¼ˆå°ï¼‰</strong>ï¼š10ç€ç¨‹åº¦</li>
          <li><strong>å®…é…ä¾¿ï¼ˆå¤§ï¼‰</strong>ï¼š11ã€œ40ç€ç¨‹åº¦</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">é…é€ã«ã¤ã„ã¦</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>ç™ºé€ã¯ãŠæ”¯æ‰•ã„ç¢ºèªå¾Œ<strong>2ã€œ5å–¶æ¥­æ—¥</strong>ä»¥å†…</li>
          <li>é…é€æ¥­è€…ï¼šä½å·æ€¥ä¾¿ãƒ»ãƒ¤ãƒãƒˆé‹è¼¸ãƒ»éƒµä¾¿å±€ã®ã„ãšã‚Œã‹ï¼ˆæŒ‡å®šä¸å¯ï¼‰</li>
          <li>æ—¥æ™‚æŒ‡å®šä¸å¯</li>
        </ul>
      </div>
    </div>
  </div>


  <!-- ç‰¹å®šå•†å–å¼•æ³•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="legalModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</div>
      <button class="modalClose" id="legalCloseBtn" aria-label="close">Ã—</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <table style="width:100%;border-collapse:collapse;font-size:14px;">
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;width:140px;vertical-align:top;">è²©å£²æ¥­è€…</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">NKonline</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">é‹å–¶çµ±æ‹¬è²¬ä»»è€…</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">è¥¿å‡ºå…‹åˆ©</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">æ‰€åœ¨åœ°</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">å¤§é˜ªåºœå¤§æ±å¸‚ç°å¡š4-16-15</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">é›»è©±ç•ªå·</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">080-3130-9250</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">nkonline1030@gmail.com</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">è²©å£²ä¾¡æ ¼</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">å„å•†å“ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚ŒãŸä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">é€æ–™</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">åœ°åŸŸãƒ»ã‚µã‚¤ã‚ºã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯<a href="#" id="legalShippingLink" style="color:#3b82f6;">é€æ–™è¡¨</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">æ”¯æ‰•æ–¹æ³•</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆã€éŠ€è¡ŒæŒ¯è¾¼ã€PayPayã€LINE Payã€ãƒ¡ãƒ«ãƒšã‚¤</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">æ”¯æ‰•æ™‚æœŸ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼šã”æ³¨æ–‡æ™‚ã«æ±ºæ¸ˆ<br>
            ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆï¼šã”æ³¨æ–‡å¾Œ7æ—¥ä»¥å†…ã«ãŠæ”¯æ‰•ã„<br>
            éŠ€è¡ŒæŒ¯è¾¼ï¼šã”æ³¨æ–‡å¾Œ7æ—¥ä»¥å†…ã«ãŠæŒ¯è¾¼ã¿<br>
            ãã®ä»–é›»å­æ±ºæ¸ˆï¼šã”æ³¨æ–‡æ™‚ã«æ±ºæ¸ˆ
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">å•†å“å¼•æ¸¡ã—æ™‚æœŸ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">ã”å…¥é‡‘ç¢ºèªå¾Œã€2ã€œ5å–¶æ¥­æ—¥ä»¥å†…ã«ç™ºé€</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">è¿”å“ãƒ»äº¤æ›</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            åŸå‰‡ã¨ã—ã¦è¿”å“ãƒ»äº¤æ›ã¯ãŠå—ã‘ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚<br>
            ä¸‡ä¸€ã€å•†å“å†…å®¹ãŒè¨˜è¼‰äº‹é …ã¨å¤§ããç•°ãªã‚‹å ´åˆã¯ã€å•†å“åˆ°ç€å¾Œ7æ—¥ä»¥å†…ã«ã”é€£çµ¡ãã ã•ã„ã€‚
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">è¿”é‡‘ã«ã¤ã„ã¦</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            å½“æ–¹ã®éƒ½åˆã«ã‚ˆã‚‹è¿”é‡‘ã®å ´åˆã€ã”åˆ©ç”¨ã®æ±ºæ¸ˆæ–¹æ³•ã«å¿œã˜ã¦è¿”é‡‘å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚<br>
            ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼šã‚«ãƒ¼ãƒ‰ä¼šç¤¾çµŒç”±ã§ã®è¿”é‡‘<br>
            ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆãƒ»éŠ€è¡ŒæŒ¯è¾¼ï¼šã”æŒ‡å®šã®éŠ€è¡Œå£åº§ã¸è¿”é‡‘<br>
            é›»å­æ±ºæ¸ˆï¼šå„ã‚µãƒ¼ãƒ“ã‚¹çµŒç”±ã§ã®è¿”é‡‘
          </td>
        </tr>
      </table>
    </div>
  </div>

<footer style="background:#1e293b; color:#94a3b8; padding:32px 16px; margin-top:40px; font-size:13px;">
  <div style="max-width:900px; margin:0 auto; text-align:center;">
    <div style="display:flex; justify-content:center; gap:24px; flex-wrap:wrap; margin-bottom:16px;">
      <a href="#" id="openLegalLink" style="color:#cbd5e1; text-decoration:none;">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>
      <a href="https://nkonline.buyshop.jp/privacy" target="_blank" rel="noopener noreferrer" style="color:#cbd5e1; text-decoration:none;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
    </div>
    <div style="color:#64748b;">&copy; 2025 NKonlineApparel</div>
  </div>
</footer>

<script>
// =====================================================
// çŠ¶æ…‹ç®¡ç†
// =====================================================

var state = {
  userKey: '',
  allProducts: [],
  filteredProducts: [],
  settings: null,
  options: null,
  query: {
    filters: { brand: [], category: [], state: [], gender: [], size: [] },
    sort: { key: 'default', dir: 'asc' },
    page: 1,
    pageSize: 60
  },
  cart: { ids: [], itemsById: {}, digest: {} },
  ui: { cardEls: {} },
  timers: { statusPoll: null },
  brandUi: { all: [], selected: {}, cbByName: {}, built: false },
  // é¡§å®¢èªè¨¼
  customer: null,  // { id, email, companyName, phone, postal, address, newsletter }
  sessionId: null,
  dataLoaded: false
};

// =====================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =====================================================

function $(id) { return document.getElementById(id); }

function escapeHtml_(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function yen(n) {
  var x = Math.round(Number(n || 0));
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'å††';
}

// ãƒ–ãƒ©ãƒ³ãƒ‰åã‚’æ­£è¦åŒ–ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹çµ±ä¸€ï¼‰
function normalizeBrand_(name) {
  if (!name) return '';
  // ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã€å¤§æ–‡å­—ã«çµ±ä¸€
  return String(name).replace(/\s+/g, '').toUpperCase();
}

// æ­£è¦åŒ–ãƒ–ãƒ©ãƒ³ãƒ‰ã‚­ãƒ¼ â†’ è¡¨ç¤ºåã®ãƒãƒƒãƒ—ï¼ˆæœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
var brandDisplayMap_ = {};
var brandNormalizedMap_ = {}; // å…ƒã®ãƒ–ãƒ©ãƒ³ãƒ‰å â†’ æ­£è¦åŒ–ã‚­ãƒ¼

function showToast(msg) {
  var t = $('toast');
  t.textContent = String(msg || '');
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2600);
}

// =====================================================
// é¡§å®¢èªè¨¼
// =====================================================

var SESSION_KEY = 'estimate_session';
var MEMBER_DISCOUNT_RATE = 0.10;  // ä¼šå“¡å‰²å¼•10%
var BULK_DISCOUNT_RATE = 0.10;    // 30ç‚¹ä»¥ä¸Šå‰²å¼•10%

function loadSession_() {
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) { return null; }
}

function saveSession_(sessionId, customer) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: sessionId, customer: customer }));
  } catch (e) {}
}

function clearSession_() {
  try { localStorage.removeItem(SESSION_KEY); } catch (e) {}
  state.sessionId = null;
  state.customer = null;
}

function updateAuthUi_() {
  var area = $('authArea');
  if (!area) return;

  if (state.customer) {
    area.innerHTML = '<div class="authUser">' +
      '<span class="authUserName">' + escapeHtml_(state.customer.companyName || state.customer.email) + '</span>' +
      '<span class="authDiscount">10%OFF</span>' +
      '</div>' +
      '<button class="authBtn logout" id="logoutBtn" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';

    var logoutBtn = $('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() {
        doLogout_();
      });
    }
  } else {
    area.innerHTML = '<button class="authBtn" id="openAuthBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>';
    var openAuthBtn = $('openAuthBtn');
    if (openAuthBtn) {
      openAuthBtn.addEventListener('click', function() {
        openAuthModal_('login');
      });
    }
  }
}

function openAuthModal_(mode) {
  var modal = $('authModal');
  if (!modal) return;

  if (mode === 'register') {
    $('authModalTitle').textContent = 'æ–°è¦ç™»éŒ²';
    $('loginForm').style.display = 'none';
    $('registerForm').style.display = '';
  } else {
    $('authModalTitle').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
    $('loginForm').style.display = '';
    $('registerForm').style.display = 'none';
  }

  openModal(modal);
}

function doLogin_() {
  var email = ($('loginEmail').value || '').trim();
  var password = $('loginPassword').value || '';

  if (!email || !password) {
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  setSending_(true, 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');

  runApi('apiLoginCustomer', state.userKey, { email: email, password: password })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
        // å‰²å¼•ã‚’åæ˜ 
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function doRegister_() {
  var email = ($('regEmail').value || '').trim();
  var password = $('regPassword').value || '';
  var companyName = ($('regCompanyName').value || '').trim();
  var phone = ($('regPhone').value || '').trim();
  var postal = ($('regPostal').value || '').trim();
  var address = ($('regAddress').value || '').trim();
  var newsletter = $('regNewsletter').checked;

  if (!email || !email.includes('@')) {
    showToast('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  if (!password || password.length < 6) {
    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  if (!companyName) {
    showToast('ä¼šç¤¾å/æ°åã¯å¿…é ˆã§ã™');
    return;
  }

  setSending_(true, 'ç™»éŒ²ä¸­...');

  runApi('apiRegisterCustomer', state.userKey, {
    email: email,
    password: password,
    companyName: companyName,
    phone: phone,
    postal: postal,
    address: address,
    newsletter: newsletter
  })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼10%å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™');
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function doLogout_() {
  var sessionId = state.sessionId;
  clearSession_();
  updateAuthUi_();
  updateCartPrice();
  if ($('cartModal').classList.contains('open')) renderCartModal_();
  showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');

  if (sessionId) {
    runApi('apiLogoutCustomer', state.userKey, { sessionId: sessionId }).catch(function() {});
  }
}

function validateSession_() {
  var saved = loadSession_();
  if (!saved || !saved.sessionId) return;

  runApi('apiValidateSession', state.userKey, { sessionId: saved.sessionId })
    .then(function(res) {
      if (res.ok && res.data && res.data.customer) {
        state.sessionId = saved.sessionId;
        state.customer = res.data.customer;
        updateAuthUi_();
        updateCartPrice();
      } else {
        clearSession_();
      }
    })
    .catch(function() {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ—¦ä½¿ç”¨
      state.sessionId = saved.sessionId;
      state.customer = saved.customer;
      updateAuthUi_();
    });
}

function setupAuthUi_() {
  // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
  var openAuthBtn = $('openAuthBtn');
  if (openAuthBtn) {
    openAuthBtn.addEventListener('click', function() {
      openAuthModal_('login');
    });
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  var authCloseBtn = $('authCloseBtn');
  if (authCloseBtn) {
    authCloseBtn.addEventListener('click', function() {
      closeModal($('authModal'));
    });
  }

  // å•†å“ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
  var openGuideLink = $('openGuideLink');
  if (openGuideLink) {
    openGuideLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('guideModal'));
    });
  }
  var guideCloseBtn = $('guideCloseBtn');
  if (guideCloseBtn) {
    guideCloseBtn.addEventListener('click', function() {
      closeModal($('guideModal'));
    });
  }

  // é€æ–™è¡¨ãƒ¢ãƒ¼ãƒ€ãƒ«
  var openShippingLink = $('openShippingLink');
  if (openShippingLink) {
    openShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('shippingModal'));
    });
  }
  var shippingCloseBtn = $('shippingCloseBtn');
  if (shippingCloseBtn) {
    shippingCloseBtn.addEventListener('click', function() {
      closeModal($('shippingModal'));
    });
  }

  // ç‰¹å®šå•†å–å¼•æ³•ãƒ¢ãƒ¼ãƒ€ãƒ«
  var openLegalLink = $('openLegalLink');
  if (openLegalLink) {
    openLegalLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('legalModal'));
    });
  }
  var legalCloseBtn = $('legalCloseBtn');
  if (legalCloseBtn) {
    legalCloseBtn.addEventListener('click', function() {
      closeModal($('legalModal'));
    });
  }
  var legalShippingLink = $('legalShippingLink');
  if (legalShippingLink) {
    legalShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      closeModal($('legalModal'));
      openModal($('shippingModal'));
    });
  }

  // ãŠå•ã„åˆã‚ã›ãƒ¢ãƒ¼ãƒ€ãƒ«
  var openContactLink = $('openContactLink');
  if (openContactLink) {
    openContactLink.addEventListener('click', function(e) {
      e.preventDefault();
      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰åå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•å…¥åŠ›
      if (state.customer) {
        $('contactName').value = state.customer.companyName || '';
        $('contactEmail').value = state.customer.email || '';
      }
      openModal($('contactModal'));
    });
  }
  var contactCloseBtn = $('contactCloseBtn');
  if (contactCloseBtn) {
    contactCloseBtn.addEventListener('click', function() {
      closeModal($('contactModal'));
    });
  }
  var contactSubmitBtn = $('contactSubmitBtn');
  if (contactSubmitBtn) {
    contactSubmitBtn.addEventListener('click', function() {
      var name = ($('contactName').value || '').trim();
      var email = ($('contactEmail').value || '').trim();
      var message = ($('contactMessage').value || '').trim();
      if (!name) { showToast('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!message) { showToast('ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      contactSubmitBtn.disabled = true;
      contactSubmitBtn.textContent = 'é€ä¿¡ä¸­...';
      runApi('apiSendContactForm', { name: name, email: email, message: message })
        .then(function(res) {
          if (res && res.ok) {
            closeModal($('contactModal'));
            $('contactName').value = '';
            $('contactEmail').value = '';
            $('contactMessage').value = '';
            showToast('ãŠå•ã„åˆã‚ã›ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
          } else {
            showToast((res && res.message) || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .catch(function(e) { showToast(e.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); })
        .finally(function() { contactSubmitBtn.disabled = false; contactSubmitBtn.textContent = 'é€ä¿¡'; });
    });
  }


  // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
  var loginBtn = $('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', doLogin_);
  }

  // ç™»éŒ²ãƒœã‚¿ãƒ³
  var registerBtn = $('registerBtn');
  if (registerBtn) {
    registerBtn.addEventListener('click', doRegister_);
  }

  // ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
  var showRegisterLink = $('showRegisterLink');
  if (showRegisterLink) {
    showRegisterLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  var showLoginLink = $('showLoginLink');
  if (showLoginLink) {
    showLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }
}

function setSending_(on, text) {
  var ov = $('sendingOverlay');
  var tx = $('sendingText');
  if (tx) tx.textContent = String(text || 'ä¾é ¼é€ä¿¡ä¸­...');
  if (!ov) return;
  if (on) { ov.classList.add('on'); document.body.style.overflow = 'hidden'; }
  else { ov.classList.remove('on'); document.body.style.overflow = ''; }
}

function loadUserKey() {
  var k = localStorage.getItem('estimate_userKey');
  if (k) return k;
  var nk = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem('estimate_userKey', nk);
  return nk;
}

function loadCartStorage() {
  try {
    var raw = localStorage.getItem('estimate_cart_v2');
    if (!raw) return { ids: [], itemsById: {} };
    var j = JSON.parse(raw);
    return { ids: Array.isArray(j.ids) ? j.ids : [], itemsById: j.itemsById || {} };
  } catch (e) { return { ids: [], itemsById: {} }; }
}

function saveCartStorage() {
  try { localStorage.setItem('estimate_cart_v2', JSON.stringify({ ids: state.cart.ids || [], itemsById: state.cart.itemsById || {} })); } catch (e) {}
}

function openModal(modal) { $('overlay').classList.add('open'); modal.classList.add('open'); }
function closeModal(modal) { modal.classList.remove('open'); if (!document.querySelector('.modal.open')) $('overlay').classList.remove('open'); }
function closeAllModals() { document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); }); $('overlay').classList.remove('open'); }

function convertDriveImageUrl(url) {
  if (!url) return '';
  var m = url.match(/(?:id=|\/d\/)([A-Za-z0-9_-]{10,})/);
  if (m && m[1]) return 'https://lh3.googleusercontent.com/d/' + m[1];
  return url;
}

function normalizeStatus_(s) { return String(s || '').trim(); }
function statusKind_(s) {
  var t = normalizeStatus_(s);
  if (!t) return 'available';
  if (t.indexOf('ä¾é ¼ä¸­') !== -1) return 'open';
  if (t.indexOf('ç¢ºä¿ä¸­') !== -1) return 'hold';
  if (t.indexOf('åœ¨åº«') !== -1) return 'available';
  return 'available';
}

function getMeasureOptValue_() { return 'with'; }
function setMeasureOptValue_(v) {}
function loadMeasureOpt_() { return 'with'; }
function saveMeasureOpt_() {}

// =====================================================
// GAS APIå‘¼ã³å‡ºã—ï¼ˆGASãƒ¢ãƒ¼ãƒ‰ / ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•åˆ¤å®šï¼‰
// =====================================================

// â˜… ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ï¼ˆCloudflare Pagesç­‰ï¼‰ã§ä½¿ã†å ´åˆã¯ã“ã“ã«GAS Web App URLã‚’è¨­å®š
var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';

var IS_STANDALONE = (typeof google === 'undefined' || !google.script);

// reCAPTCHA v3 ã‚µã‚¤ãƒˆã‚­ãƒ¼ï¼ˆâ˜… Google reCAPTCHAç®¡ç†ç”»é¢ã§å–å¾—ã—ã¦è¨­å®šï¼‰
var RECAPTCHA_SITE_KEY = '6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1';
var ADMIN_KEY = (new URLSearchParams(window.location.search)).get('admin') || '';

function getRecaptchaToken_() {
  if (typeof grecaptcha === 'undefined' || !RECAPTCHA_SITE_KEY || RECAPTCHA_SITE_KEY.indexOf('RECAPTCHA') !== -1) {
    console.warn('reCAPTCHA not available: grecaptcha=' + (typeof grecaptcha) + ' siteKey=' + !!RECAPTCHA_SITE_KEY);
    return Promise.resolve('');
  }
  try {
    return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }).catch(function(e) {
      console.warn('reCAPTCHA execute failed:', e);
      return '';
    });
  } catch (e) {
    console.warn('reCAPTCHA execute error:', e);
    return Promise.resolve('');
  }
}

function runApi(fn, _extra) {
  var args = Array.prototype.slice.call(arguments, 1);
  var extra = {};
  // æœ€å¾Œã®å¼•æ•°ãŒ _runApiExtra_ ãªã‚‰å–ã‚Šå‡ºã™
  if (args.length > 0 && args[args.length - 1] && args[args.length - 1]._runApiExtra_) {
    extra = args.pop();
  }

  if (IS_STANDALONE) {
    var payload = { action: fn, args: args };
    if ('recaptchaToken' in extra) payload.recaptchaToken = extra.recaptchaToken;
    if (ADMIN_KEY) payload.adminKey = ADMIN_KEY;
    return fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      if (data && data.ok === false) throw new Error(data.message || 'APIã‚¨ãƒ©ãƒ¼');
      return data;
    });
  }

  return new Promise(function(resolve, reject) {
    var done = false;
    var timer = setTimeout(function() {
      if (done) return;
      done = true;
      reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
    }, 30000);

    try {
      var runner = google.script.run
        .withSuccessHandler(function(res) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve(res);
        })
        .withFailureHandler(function(err) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          reject(err);
        });

      runner[fn].apply(runner, args);
    } catch (e) {
      if (done) return;
      done = true;
      clearTimeout(timer);
      reject(e);
    }
  });
}

// =====================================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰é«˜é€Ÿå–å¾—ï¼‰
// =====================================================

var PRODUCT_CACHE_KEY = 'estimate_products_cache';
var PRODUCT_CACHE_TTL = 5 * 60 * 1000; // 5åˆ†

function saveProductCache_(data) {
  try {
    var cache = { ts: Date.now(), data: data };
    localStorage.setItem(PRODUCT_CACHE_KEY, JSON.stringify(cache));
  } catch (e) { console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å¤±æ•—:', e); }
}

function loadProductCache_() {
  try {
    var raw = localStorage.getItem(PRODUCT_CACHE_KEY);
    if (!raw) return null;
    var cache = JSON.parse(raw);
    // 5åˆ†ä»¥å†…ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã‚‰ä½¿ç”¨
    if (cache && cache.ts && (Date.now() - cache.ts < PRODUCT_CACHE_TTL) && cache.data) {
      return cache.data;
    }
    return cache && cache.data ? { data: cache.data, stale: true } : null;
  } catch (e) { return null; }
}

function loadProductData() {
  if (IS_STANDALONE) {
    return runApi('apiGetCachedProducts').then(function(res) {
      if (res && res.ok && res.data) {
        console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', res.data.totalCount + 'ä»¶');
        saveProductCache_(res.data);
        return res.data;
      }
      throw new Error(res && res.message ? res.message : 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—');
    });
  }

  return new Promise(function(resolve, reject) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res && res.ok && res.data) {
          console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', res.data.totalCount + 'ä»¶');
          saveProductCache_(res.data);
          resolve(res.data);
        } else {
          reject(new Error(res && res.message ? res.message : 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—'));
        }
      })
      .withFailureHandler(function(err) {
        reject(err);
      })
      .apiGetCachedProducts();
  });
}

// =====================================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å³æ™‚å‡¦ç†ï¼‰
// =====================================================

function applyFilters_() {
  var f = state.query.filters;
  var products = state.allProducts.slice();

  if (f.brand && f.brand.length > 0) {
    products = products.filter(function(p) {
      var normalizedBrand = normalizeBrand_(p.brand);
      return f.brand.indexOf(normalizedBrand) !== -1;
    });
  }
  if (f.category && f.category.length > 0) {
    products = products.filter(function(p) { return f.category.indexOf(p.category) !== -1; });
  }
  if (f.state && f.state.length > 0) {
    products = products.filter(function(p) { return f.state.indexOf(p.state) !== -1; });
  }
  if (f.gender && f.gender.length > 0) {
    products = products.filter(function(p) { return f.gender.indexOf(p.gender) !== -1; });
  }
  if (f.size && f.size.length > 0) {
    products = products.filter(function(p) { return f.size.indexOf(p.size) !== -1; });
  }

  return products;
}

function applySort_(products) {
  var s = state.query.sort;
  var sorted = products.slice();
  
  if (s.key === 'default') return sorted;
  
  sorted.sort(function(a, b) {
    var va, vb;
    switch (s.key) {
      case 'price': va = Number(a.price) || 0; vb = Number(b.price) || 0; break;
      case 'brand': va = String(a.brand || ''); vb = String(b.brand || ''); break;
      case 'category': va = String(a.category || ''); vb = String(b.category || ''); break;
      default: return 0;
    }
    if (typeof va === 'string') {
      var cmp = va.localeCompare(vb, 'ja');
      return s.dir === 'desc' ? -cmp : cmp;
    }
    return s.dir === 'desc' ? (vb - va) : (va - vb);
  });
  
  return sorted;
}

function filterAndRender(scrollTop) {
  var filtered = applyFilters_();
  filtered = applySort_(filtered);
  state.filteredProducts = filtered;
  
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var totalPages = Math.ceil(filtered.length / pageSize) || 1;
  
  if (page > totalPages) { page = totalPages; state.query.page = page; }
  
  var start = (page - 1) * pageSize;
  var pageItems = filtered.slice(start, start + pageSize);
  
  updateTotalCountBadge_(filtered.length);
  renderGrid_(pageItems);
  renderPager_(totalPages, page);
  
  if (scrollTop) window.scrollTo({ top: 0, behavior: 'auto' });
  
  pollStatusNow_();
}

// =====================================================
// ç¢ºä¿çŠ¶æ…‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
// =====================================================

function pollStatusNow_() {
  if (state.timers.statusPoll) { clearTimeout(state.timers.statusPoll); state.timers.statusPoll = null; }
  
  var ids = [];
  var pageItems = getCurrentPageItems_();
  for (var i = 0; i < pageItems.length; i++) {
    if (pageItems[i] && pageItems[i].managedId) ids.push(pageItems[i].managedId);
  }
  for (var j = 0; j < state.cart.ids.length; j++) {
    if (ids.indexOf(state.cart.ids[j]) === -1) ids.push(state.cart.ids[j]);
  }
  
  if (ids.length === 0) return;
  
  runApi('apiGetStatusDigest', state.userKey, ids)
    .then(function(res) {
      if (res && res.ok && res.map) {
        state.cart.digest = res.map;
        for (var id in state.ui.cardEls) updateCardUi_(id);
      }
    })
    .catch(function(e) { console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', e); });
  
  state.timers.statusPoll = setTimeout(pollStatusNow_, 10000);
}

function getCurrentPageItems_() {
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var start = (page - 1) * pageSize;
  return state.filteredProducts.slice(start, start + pageSize);
}

// =====================================================
// è¡¨ç¤ºç³»
// =====================================================

function updateTotalCountBadge_(total) {
  var el = $('totalCountBadge');
  if (el) el.textContent = total ? ('å•†å“ç‚¹æ•°ï¼š' + total + 'ç‚¹') : '';
}

function renderLoadingGrid_() {
  var g = $('grid'); g.innerHTML = '';
  for (var i = 0; i < 8; i++) {
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'LOADING';
    var body = document.createElement('div'); body.className = 'cardbody';
    var line = document.createElement('div'); line.className = 'meta'; line.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    body.appendChild(line); card.appendChild(thumb); card.appendChild(body); g.appendChild(card);
  }
}

function setSelectOptions(select, list, placeholder) {
  select.innerHTML = '';
  var op0 = document.createElement('option'); op0.value = ''; op0.textContent = placeholder; select.appendChild(op0);
  for (var i = 0; i < list.length; i++) {
    var op = document.createElement('option'); op.value = String(list[i]); op.textContent = String(list[i]); select.appendChild(op);
  }
}

// ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
var multiSelectState = { category: [], state: [], gender: [], size: [] };

function buildMultiSelectDropdown(filterKey, options) {
  var dropdown = $('f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Dropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var val = String(options[i]);
    var item = document.createElement('div');
    item.className = 'multiSelectItem';
    item.dataset.value = val;
    if (multiSelectState[filterKey].indexOf(val) !== -1) item.classList.add('selected');

    var checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    var span = document.createElement('span');
    span.textContent = val;

    item.appendChild(checkIcon);
    item.appendChild(span);

    item.addEventListener('click', (function(key, v, el) {
      return function(e) {
        e.stopPropagation();
        var isSelected = el.classList.contains('selected');
        if (isSelected) {
          el.classList.remove('selected');
          var idx = multiSelectState[key].indexOf(v);
          if (idx !== -1) multiSelectState[key].splice(idx, 1);
        } else {
          el.classList.add('selected');
          if (multiSelectState[key].indexOf(v) === -1) multiSelectState[key].push(v);
        }
        state.query.filters[key] = multiSelectState[key].slice();
        updateMultiSelectBtn(key);
        filterAndRender(true);
      };
    })(filterKey, val, item));
    dropdown.appendChild(item);
  }
}

function updateMultiSelectBtn(filterKey) {
  var btnId = 'f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Btn';
  var btn = $(btnId);
  if (!btn) return;
  var count = multiSelectState[filterKey].length;
  var countSpan = btn.querySelector('.filterCount');
  if (countSpan) countSpan.textContent = count > 0 ? count : '';
}

function setupMultiSelectFilters() {
  var filters = ['category', 'state', 'gender', 'size'];
  var labels = { category: 'ã‚«ãƒ†ã‚´ãƒª', state: 'çŠ¶æ…‹', gender: 'æ€§åˆ¥', size: 'ã‚µã‚¤ã‚º' };

  filters.forEach(function(key) {
    var btnId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Btn';
    var dropdownId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown';
    var btn = $(btnId);
    var dropdown = $(dropdownId);
    if (!btn || !dropdown) return;

    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      // ä»–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        if (d.id !== dropdownId) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
    });
  });

  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.multiSelectField')) {
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        d.classList.remove('open');
      });
    }
  });
}

function resetMultiSelectFilters() {
  multiSelectState = { category: [], state: [], gender: [], size: [] };
  state.query.filters.category = [];
  state.query.filters.state = [];
  state.query.filters.gender = [];
  state.query.filters.size = [];
  ['category', 'state', 'gender', 'size'].forEach(function(key) {
    updateMultiSelectBtn(key);
    var dropdown = $('f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown');
    if (dropdown) {
      dropdown.querySelectorAll('.multiSelectItem').forEach(function(item) {
        item.classList.remove('selected');
      });
    }
  });
}

function setSortOptions(select, sortDefs) {
  select.innerHTML = '';
  for (var i = 0; i < sortDefs.length; i++) {
    var s = sortDefs[i];
    var op = document.createElement('option'); op.value = s.key; op.textContent = s.label; select.appendChild(op);
  }
}

function setStatusBadge_(el, status) {
  if (!el) return;
  var t = normalizeStatus_(status);
  var k = statusKind_(t);
  el.className = 'badge';
  if (k === 'available') el.className = 'badge ok';
  else if (k === 'open') el.className = 'badge lock';
  else if (k === 'hold') el.className = 'badge warn';
  el.textContent = t || '';
}

function effectiveStatusFor_(id, selected, itemStatus) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  var ds = d && d.status ? normalizeStatus_(d.status) : '';
  if (selected) {
    if (d) {
      var k = statusKind_(ds);
      if (k === 'open') return ds || 'ä¾é ¼ä¸­';
      if (k === 'hold' && d.heldByOther) return ds || 'ç¢ºä¿ä¸­';
    }
    return 'ç¢ºä¿ä¸­';
  }
  return ds || normalizeStatus_(itemStatus);
}

function effectiveHeldByOtherFor_(id) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  return !!(d && d.heldByOther);
}

function computeDisabledForCard_(it, id) {
  var selected = state.cart.ids.indexOf(id) !== -1;
  var effectiveStatus = effectiveStatusFor_(id, selected, it.status);
  var effectiveHeldByOther = effectiveHeldByOtherFor_(id);
  var disabled = (!it.selectable) || (statusKind_(effectiveStatus) === 'open') || (statusKind_(effectiveStatus) === 'hold' && effectiveHeldByOther);
  return { selected: selected, effectiveStatus: effectiveStatus, effectiveHeldByOther: effectiveHeldByOther, disabled: disabled };
}

function applyBtnUi_(btn, it, id) {
  if (!btn || !it) return;
  var r = computeDisabledForCard_(it, id);
  if (r.disabled) {
    btn.className = 'selectBtn disabled'; btn.disabled = true;
    btn.textContent = statusKind_(r.effectiveStatus) === 'open' ? 'ä¾é ¼ä¸­ï¼ˆé¸æŠä¸å¯ï¼‰' : 'ç¢ºä¿ä¸­ï¼ˆé¸æŠä¸å¯ï¼‰';
    return;
  }
  if (r.selected) { btn.className = 'selectBtn'; btn.disabled = false; btn.textContent = 'é¸æŠä¸­ï¼ˆè§£é™¤ï¼‰'; return; }
  btn.className = 'selectBtn off'; btn.disabled = false; btn.textContent = 'ã‚«ãƒ¼ãƒˆã¸è¿½åŠ ';
}

function updateCardUi_(id) {
  var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
  if (!rec) return;
  var it = rec.item;
  if (!it) return;
  var r = computeDisabledForCard_(it, id);
  if (rec.bStatus) setStatusBadge_(rec.bStatus, r.effectiveStatus);
  if (rec.btn) applyBtnUi_(rec.btn, it, id);
}

function upsertCartItem_(it) {
  if (!it || !it.managedId) return;
  state.cart.itemsById[it.managedId] = {
    managedId: it.managedId, noLabel: it.noLabel, imageUrl: it.imageUrl, brand: it.brand,
    size: it.size, gender: it.gender, category: it.category, color: it.color, state: it.state,
    price: Number(it.price || 0), measurements: it.measurements || {}, defectDetail: it.defectDetail || ''
  };
}

function renderGrid_(items) {
  var g = $('grid'); g.innerHTML = ''; state.ui.cardEls = {};
  
  if (!items || items.length === 0) {
    var msg = document.createElement('div'); msg.textContent = 'è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“'; msg.style.padding = '12px'; g.appendChild(msg); return;
  }
  
  var frag = document.createDocumentFragment();
  
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    if (!it) continue;
    upsertCartItem_(it);
    var id = it.managedId;
    var r = computeDisabledForCard_(it, id);
    
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb';
    var imgEl = null;
    
    if (it.imageUrl) {
      var img = document.createElement('img');
      var fixedUrl = convertDriveImageUrl(it.imageUrl);
      img.src = fixedUrl; img.alt = it.noLabel || id; img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
      img.className = 'product-image-clickable'; img.style.cursor = 'zoom-in';
      (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, fixedUrl);
      imgEl = img; thumb.appendChild(img);
    } else { thumb.textContent = 'NO IMAGE'; }
    card.appendChild(thumb);
    
    var body = document.createElement('div'); body.className = 'cardbody';
    var row1 = document.createElement('div'); row1.className = 'row1';
    var leftTitle = document.createElement('div'); leftTitle.className = 'leftTitle'; leftTitle.style.cursor = 'pointer';
    var spanNo = document.createElement('span'); spanNo.className = 'noText'; spanNo.textContent = it.noLabel ? it.noLabel : ('No. ' + id);
    var spanBrand = document.createElement('div'); spanBrand.className = 'brandText'; spanBrand.textContent = it.brand || '';
    spanBrand.style.cursor = 'pointer';
    leftTitle.appendChild(spanNo);
    (function(mid, iurl) { leftTitle.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '');
    (function(mid, iurl) { spanBrand.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '');
    var price = document.createElement('div'); price.className = 'price'; price.textContent = yen(it.price);
    row1.appendChild(leftTitle); row1.appendChild(price); body.appendChild(row1);
    if (spanBrand.textContent) body.appendChild(spanBrand);
    
    // å‚·æ±šã‚Œè©³ç´°ã®æœ‰ç„¡ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰ã®é«˜ã•ã‚’æƒãˆã‚‹ãŸã‚å¸¸ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ï¼‰
    var defectLine = document.createElement('div'); defectLine.className = 'defectLine';
    if (it.defectDetail && it.defectDetail.trim()) {
      defectLine.textContent = 'è©³ç´°äº‹é …ã‚ã‚Š';
      defectLine.classList.add('hasDefect');
    } else {
      defectLine.innerHTML = '&nbsp;'; // ç©ºç™½ã§ã‚‚é«˜ã•ã‚’ç¢ºä¿
    }
    body.appendChild(defectLine);

    var badges = document.createElement('div'); badges.className = 'badges';
    var bState = document.createElement('div'); bState.className = 'badge'; bState.textContent = it.state || ''; badges.appendChild(bState);
    var bStatus = document.createElement('div'); setStatusBadge_(bStatus, r.effectiveStatus); badges.appendChild(bStatus); body.appendChild(badges);
    
    var btn = document.createElement('button'); btn.type = 'button'; applyBtnUi_(btn, it, id);
    (function(itemRef, idRef) { btn.addEventListener('click', function() { if (computeDisabledForCard_(itemRef, idRef).disabled) return; toggleCartOptimistic_(idRef); }); })(it, id);
    
    var actions = document.createElement('div'); actions.className = 'actions'; actions.appendChild(btn); body.appendChild(actions);
    card.appendChild(body); frag.appendChild(card);
    state.ui.cardEls[id] = { bStatus: bStatus, btn: btn, item: it, img: imgEl };
  }
  
  g.appendChild(frag);
}

function renderPager_(totalPages, currentPage) {
  var p = $('pager'); p.innerHTML = '';
  if (totalPages <= 1) return;
  var maxButtons = 9;
  var start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  var end = Math.min(totalPages, start + maxButtons - 1);
  start = Math.max(1, end - maxButtons + 1);
  for (var i = start; i <= end; i++) {
    var b = document.createElement('button');
    b.className = 'pageBtn' + (i === currentPage ? ' active' : '');
    b.textContent = String(i);
    (function(pn) { b.addEventListener('click', function() { state.query.page = pn; filterAndRender(true); }); })(i);
    p.appendChild(b);
  }
}

// =====================================================
// ã‚«ãƒ¼ãƒˆ
// =====================================================

function updateCartCount() {
  $('cartCount').textContent = String((state.cart.ids || []).length);
  updateCartPrice();
}

function updateCartPrice() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var count = ids.length;
  // å‰²å¼•ã‚’ç´¯ç©ï¼ˆä¼šå“¡10% + 30ç‚¹ä»¥ä¸Š10% = æœ€å¤§20%ï¼‰
  var discountRate = 0;
  if (count >= 30) discountRate += BULK_DISCOUNT_RATE;
  if (state.customer) discountRate += MEMBER_DISCOUNT_RATE;
  if (discountRate > 0) {
    var discounted = Math.round(sum * (1 - discountRate));
    $('cartTotal').innerHTML = '<span class="price-old">' + yen(sum) + '</span> â†’ <span class="price-new">' + yen(discounted) + '</span>';
  } else { $('cartTotal').textContent = yen(sum); }
}

function toggleCartOptimistic_(id) {
  var idx = state.cart.ids.indexOf(id);
  if (idx !== -1) { state.cart.ids.splice(idx, 1); } else { state.cart.ids.push(id); }
  saveCartStorage(); updateCartCount(); updateCardUi_(id);
  
  runApi('apiSyncHolds', state.userKey, state.cart.ids.slice())
    .then(function(res) {
      if (res && res.failed && res.failed.length) {
        for (var i = 0; i < res.failed.length; i++) {
          var fid = res.failed[i].id;
          var j = state.cart.ids.indexOf(fid);
          if (j !== -1) state.cart.ids.splice(j, 1);
          updateCardUi_(fid);
        }
        updateCartCount(); saveCartStorage();
        var reasons = res.failed.map(function(f) { return f.reason; }).filter(function(v, i, a) { return a.indexOf(v) === i; });
        showToast(reasons.join('ãƒ»') + 'ã®å•†å“ãŒã‚ã‚Šã¾ã™');
      }
    })
    .catch(function(e) { console.log('åŒæœŸã‚¨ãƒ©ãƒ¼:', e); });
  
  pollStatusNow_();
}

// =====================================================
// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
// =====================================================

function openDetailModal(managedId, imageUrl) {
  var modal = document.getElementById('detailModal');
  var body = document.getElementById('detailModalBody');
  if (!modal || !body) return;
  
  var item = null;
  for (var i = 0; i < state.allProducts.length; i++) {
    if (state.allProducts[i] && state.allProducts[i].managedId === managedId) { item = state.allProducts[i]; break; }
  }
  if (!item) item = state.cart.itemsById ? state.cart.itemsById[managedId] : null;
  
  if (item) { renderDetailModalLocal(item, imageUrl); }
  else { body.innerHTML = '<div class="detail-loading">å•†å“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
  
  modal.classList.add('active');
}

function renderDetailModalLocal(item, imageUrl) {
  var body = document.getElementById('detailModalBody');
  if (!body) return;
  
  var basicItems = [];
  if (item.category) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">ã‚«ãƒ†ã‚´ãƒª:</span> ' + escapeHtml_(item.category) + '</span>');
  if (item.size) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">ã‚µã‚¤ã‚º:</span> ' + escapeHtml_(item.size) + '</span>');
  if (item.gender) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">æ€§åˆ¥:</span> ' + escapeHtml_(item.gender) + '</span>');
  if (item.color) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">ã‚«ãƒ©ãƒ¼:</span> ' + escapeHtml_(item.color) + '</span>');
  if (item.state) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">çŠ¶æ…‹:</span> ' + escapeHtml_(item.state) + '</span>');
  if (item.price) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">ä¾¡æ ¼:</span> ' + yen(item.price) + '</span>');
  
  var basicInfoHtml = basicItems.length > 0 ?
    '<div class="detail-section"><div class="detail-section-title">å•†å“æƒ…å ±</div><div class="detail-info-grid">' + basicItems.join('') + '</div></div>' : '';
  
  var defectHtml = '';
  if (item.defectDetail) {
    var escaped = escapeHtml_(item.defectDetail).replace(/\n/g, '<br>');
    defectHtml = '<div class="detail-section"><div class="detail-section-title">å‚·ãƒ»æ±šã‚Œè©³ç´°</div><div class="detail-defect">' + escaped + '</div></div>';
  }
  
  var measurementsHtml = '';
  if (item.measurements && Object.keys(item.measurements).length > 0) {
    var measureOrder = ['ç€ä¸ˆ', 'è‚©å¹…', 'èº«å¹…', 'è¢–ä¸ˆ', 'æ¡ä¸ˆ', 'ç·ä¸ˆ', 'ã‚¦ã‚¨ã‚¹ãƒˆ', 'è‚¡ä¸Š', 'è‚¡ä¸‹', 'ãƒ¯ã‚¿ãƒª', 'è£¾å¹…', 'ãƒ’ãƒƒãƒ—'];
    var measureItems = [];
    for (var i = 0; i < measureOrder.length; i++) {
      var label = measureOrder[i];
      if (item.measurements[label] !== undefined && item.measurements[label] !== null) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + label + '</div><div class="measurement-value">' + item.measurements[label] + ' cm</div></div>');
      }
    }
    for (var lbl in item.measurements) {
      if (measureOrder.indexOf(lbl) === -1) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + lbl + '</div><div class="measurement-value">' + item.measurements[lbl] + ' cm</div></div>');
      }
    }
    if (measureItems.length > 0) {
      measurementsHtml = '<div class="detail-section"><div class="detail-section-title">æ¡å¯¸ãƒ‡ãƒ¼ã‚¿</div><div class="measurement-grid">' + measureItems.join('') + '</div></div>';
    }
  }
  
  var inCart = state.cart.ids && state.cart.ids.indexOf(item.managedId) !== -1;
  var btnText = inCart ? 'âœ“ ã‚«ãƒ¼ãƒˆã«å…¥ã£ã¦ã„ã¾ã™' : 'ã‚«ãƒ¼ãƒˆã«è¿½åŠ ';
  var btnDisabled = inCart ? 'disabled' : '';
  var safeImageUrl = String(imageUrl || '').replace(/"/g, '&quot;');
  var safeBrand = escapeHtml_(item.brand || '');
  var safeManagedId = escapeHtml_(item.managedId || '');
  var noInfo = (!basicInfoHtml && !defectHtml && !measurementsHtml) ? '<div class="detail-loading" style="color:#999;">è¿½åŠ æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</div>' : '';
  
  body.innerHTML =
    '<img class="detail-modal-image" src="' + safeImageUrl + '" alt="' + safeBrand + '" onerror="this.style.display=\'none\'">' +
    '<div class="detail-modal-content"><div class="detail-modal-title">' + safeBrand + ' - ' + safeManagedId + '</div>' +
    basicInfoHtml + defectHtml + measurementsHtml + noInfo + '</div>' +
    '<div class="detail-modal-footer"><button class="detail-add-btn" ' + btnDisabled + ' onclick="addToCartFromModal(\'' + safeManagedId + '\')">' + btnText + '</button></div>';
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸå¾Œã®æˆ»ã‚Šå…ˆ
var detailReturnTo_ = null;

function closeDetailModal() {
  var modal = document.getElementById('detailModal');
  if (modal) modal.classList.remove('active');
  if (detailReturnTo_ === 'cart') {
    detailReturnTo_ = null;
    renderCartModal_(); openModal($('cartModal'));
  }
  detailReturnTo_ = null;
}

function addToCartFromModal(managedId) {
  var idx = state.cart.ids.indexOf(managedId);
  if (idx === -1) toggleCartOptimistic_(managedId);
  closeDetailModal();
}

function setupDetailModalEvents_() {
  var modal = document.getElementById('detailModal');
  if (modal) { modal.addEventListener('click', function(e) { if (e.target === modal) closeDetailModal(); }); }
}

// =====================================================
// ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠ
// =====================================================

function brandCount_() { return Object.keys(state.brandUi.selected || {}).length; }

function updateBrandBtn_() {
  var n = brandCount_();
  if ($('brandBtnText')) $('brandBtnText').textContent = 'ãƒ–ãƒ©ãƒ³ãƒ‰';
  if ($('brandBtnSub')) $('brandBtnSub').textContent = n ? (n + 'ä»¶é¸æŠ') : 'æœªé¸æŠ';
  if ($('brandHint')) $('brandHint').textContent = n ? ('é¸æŠä¸­ï¼š' + n + 'ä»¶') : 'è¤‡æ•°é¸æŠã—ã¦ã€Œé©ç”¨ã€ã§æ¤œç´¢ã—ã¾ã™';
}

// æ—¥æœ¬èªãƒ–ãƒ©ãƒ³ãƒ‰åã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆæ¤œç´¢ç”¨ï¼‰- ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠä¸¡å¯¾å¿œ
var brandAliases_ = {
  'nike': ['ãƒŠã‚¤ã‚­', 'ãªã„ã'],
  'adidas': ['ã‚¢ãƒ‡ã‚£ãƒ€ã‚¹', 'ã‚ã§ãƒã ã™', 'ã‚ã§ã„ã ã™'],
  'puma': ['ãƒ—ãƒ¼ãƒ', 'ã·ãƒ¼ã¾'],
  'gucci': ['ã‚°ãƒƒãƒ', 'ãã£ã¡'],
  'chanel': ['ã‚·ãƒ£ãƒãƒ«', 'ã—ã‚ƒã­ã‚‹'],
  'louis vuitton': ['ãƒ«ã‚¤ãƒ´ã‚£ãƒˆãƒ³', 'ã‚‹ã„ã³ã¨ã‚“', 'ãƒ«ã‚¤ãƒ»ãƒ´ã‚£ãƒˆãƒ³'],
  'hermes': ['ã‚¨ãƒ«ãƒ¡ã‚¹', 'ãˆã‚‹ã‚ã™'],
  'prada': ['ãƒ—ãƒ©ãƒ€', 'ã·ã‚‰ã '],
  'burberry': ['ãƒãƒ¼ãƒãƒªãƒ¼', 'ã°ãƒ¼ã°ã‚Šãƒ¼'],
  'coach': ['ã‚³ãƒ¼ãƒ', 'ã“ãƒ¼ã¡'],
  'michael kors': ['ãƒã‚¤ã‚±ãƒ«ã‚³ãƒ¼ã‚¹', 'ã¾ã„ã‘ã‚‹ã“ãƒ¼ã™'],
  'ralph lauren': ['ãƒ©ãƒ«ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ³', 'ã‚‰ã‚‹ãµã‚ãƒ¼ã‚Œã‚“'],
  'uniqlo': ['ãƒ¦ãƒ‹ã‚¯ãƒ­', 'ã‚†ã«ãã‚'],
  'zara': ['ã‚¶ãƒ©', 'ã–ã‚‰'],
  'gap': ['ã‚®ãƒ£ãƒƒãƒ—', 'ãã‚ƒã£ã·'],
  'h&m': ['ã‚¨ã‚¤ãƒã‚¢ãƒ³ãƒ‰ã‚¨ãƒ ', 'ãˆã„ã¡ã‚ã‚“ã©ãˆã‚€'],
  'supreme': ['ã‚·ãƒ¥ãƒ—ãƒªãƒ¼ãƒ ', 'ã—ã‚…ã·ã‚Šãƒ¼ã‚€'],
  'stussy': ['ã‚¹ãƒ†ãƒ¥ãƒ¼ã‚·ãƒ¼', 'ã™ã¦ã‚…ãƒ¼ã—ãƒ¼'],
  'north face': ['ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹', 'ã®ãƒ¼ã™ãµã‡ã„ã™'],
  'patagonia': ['ãƒ‘ã‚¿ã‚´ãƒ‹ã‚¢', 'ã±ãŸã”ã«ã‚'],
  'champion': ['ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³', 'ã¡ã‚ƒã‚“ã´ãŠã‚“'],
  'levis': ['ãƒªãƒ¼ãƒã‚¤ã‚¹', 'ã‚Šãƒ¼ã°ã„ã™'],
  'tommy hilfiger': ['ãƒˆãƒŸãƒ¼ãƒ’ãƒ«ãƒ•ã‚£ã‚¬ãƒ¼', 'ã¨ã¿ãƒ¼ã²ã‚‹ãµãƒãŒãƒ¼'],
  'calvin klein': ['ã‚«ãƒ«ãƒãƒ³ã‚¯ãƒ©ã‚¤ãƒ³', 'ã‹ã‚‹ã°ã‚“ãã‚‰ã„ã‚“'],
  'diesel': ['ãƒ‡ã‚£ãƒ¼ã‚¼ãƒ«', 'ã§ãƒãƒ¼ãœã‚‹'],
  'jill stuart': ['ã‚¸ãƒ«ã‚¹ãƒãƒ¥ã‚¢ãƒ¼ãƒˆ', 'ã˜ã‚‹ã™ã¡ã‚…ã‚ãƒ¼ã¨'],
  'marc jacobs': ['ãƒãƒ¼ã‚¯ã‚¸ã‚§ã‚¤ã‚³ãƒ–ã‚¹', 'ã¾ãƒ¼ãã˜ã‡ã„ã“ã¶ã™'],
  'versace': ['ãƒ´ã‚§ãƒ«ã‚µãƒ¼ãƒ', 'ã¹ã‚‹ã•ãƒ¼ã¡', 'ãƒ™ãƒ«ã‚µãƒ¼ãƒ'],
  'armani': ['ã‚¢ãƒ«ãƒãƒ¼ãƒ‹', 'ã‚ã‚‹ã¾ãƒ¼ã«'],
  'fendi': ['ãƒ•ã‚§ãƒ³ãƒ‡ã‚£', 'ãµã‡ã‚“ã§ãƒ'],
  'balenciaga': ['ãƒãƒ¬ãƒ³ã‚·ã‚¢ã‚¬', 'ã°ã‚Œã‚“ã—ã‚ãŒ'],
  'celine': ['ã‚»ãƒªãƒ¼ãƒŒ', 'ã›ã‚Šãƒ¼ã¬'],
  'dior': ['ãƒ‡ã‚£ã‚ªãƒ¼ãƒ«', 'ã§ãƒãŠãƒ¼ã‚‹'],
  'ysl': ['ã‚¤ãƒ´ã‚µãƒ³ãƒ­ãƒ¼ãƒ©ãƒ³', 'ã„ã¶ã•ã‚“ã‚ãƒ¼ã‚‰ã‚“'],
  'comme des garcons': ['ã‚³ãƒ ãƒ‡ã‚®ãƒ£ãƒ«ã‚½ãƒ³', 'ã“ã‚€ã§ãã‚ƒã‚‹ãã‚“'],
  'issey miyake': ['ã‚¤ãƒƒã‚»ã‚¤ãƒŸãƒ¤ã‚±', 'ã„ã£ã›ã„ã¿ã‚„ã‘'],
  'yohji yamamoto': ['ãƒ¨ã‚¦ã‚¸ãƒ¤ãƒãƒ¢ãƒˆ', 'ã‚ˆã†ã˜ã‚„ã¾ã‚‚ã¨'],
  'asics': ['ã‚¢ã‚·ãƒƒã‚¯ã‚¹', 'ã‚ã—ã£ãã™'],
  'adam et rope': ['ã‚¢ãƒ€ãƒ ã‚¨ãƒ­ãƒš', 'ã‚ã ã‚€ãˆã‚ãº'],
  'adam et rope\'': ['ã‚¢ãƒ€ãƒ ã‚¨ãƒ­ãƒš', 'ã‚ã ã‚€ãˆã‚ãº'],
  'new balance': ['ãƒ‹ãƒ¥ãƒ¼ãƒãƒ©ãƒ³ã‚¹', 'ã«ã‚…ãƒ¼ã°ã‚‰ã‚“ã™'],
  'converse': ['ã‚³ãƒ³ãƒãƒ¼ã‚¹', 'ã“ã‚“ã°ãƒ¼ã™'],
  'vans': ['ãƒ´ã‚¡ãƒ³ã‚º', 'ã°ã‚“ãš', 'ãƒãƒ³ã‚º'],
  'reebok': ['ãƒªãƒ¼ãƒœãƒƒã‚¯', 'ã‚Šãƒ¼ã¼ã£ã'],
  'under armour': ['ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ¼ãƒãƒ¼', 'ã‚ã‚“ã ãƒ¼ã‚ãƒ¼ã¾ãƒ¼'],
  'columbia': ['ã‚³ãƒ­ãƒ³ãƒ“ã‚¢', 'ã“ã‚ã‚“ã³ã‚'],
  'arc\'teryx': ['ã‚¢ãƒ¼ã‚¯ãƒ†ãƒªã‚¯ã‚¹', 'ã‚ãƒ¼ãã¦ã‚Šãã™'],
  'the north face': ['ã‚¶ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹', 'ã–ã®ãƒ¼ã™ãµã‡ã„ã™', 'ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹'],
  'beams': ['ãƒ“ãƒ¼ãƒ ã‚¹', 'ã³ãƒ¼ã‚€ã™'],
  'united arrows': ['ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰ã‚¢ãƒ­ãƒ¼ã‚º', 'ã‚†ãªã„ã¦ã£ã©ã‚ã‚ãƒ¼ãš'],
  'ships': ['ã‚·ãƒƒãƒ—ã‚¹', 'ã—ã£ã·ã™'],
  'journal standard': ['ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰', 'ã˜ã‚ƒãƒ¼ãªã‚‹ã™ãŸã‚“ã ãƒ¼ã©'],
  'urban research': ['ã‚¢ãƒ¼ãƒãƒ³ãƒªã‚µãƒ¼ãƒ', 'ã‚ãƒ¼ã°ã‚“ã‚Šã•ãƒ¼ã¡'],
  'nano universe': ['ãƒŠãƒãƒ¦ãƒ‹ãƒãƒ¼ã‚¹', 'ãªã®ã‚†ã«ã°ãƒ¼ã™'],
  'green label relaxing': ['ã‚°ãƒªãƒ¼ãƒ³ãƒ¬ãƒ¼ãƒ™ãƒ«', 'ãã‚Šãƒ¼ã‚“ã‚Œãƒ¼ã¹ã‚‹'],
  'beauty&youth': ['ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã‚¢ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¹', 'ã³ã‚…ãƒ¼ã¦ãƒãƒ¼ã‚ã‚“ã©ã‚†ãƒ¼ã™'],
  'lowrys farm': ['ãƒ­ãƒ¼ãƒªãƒ¼ã‚ºãƒ•ã‚¡ãƒ¼ãƒ ', 'ã‚ãƒ¼ã‚Šãƒ¼ãšãµããƒ¼ã‚€'],
  'global work': ['ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¯ãƒ¼ã‚¯', 'ãã‚ãƒ¼ã°ã‚‹ã‚ãƒ¼ã'],
  'snidel': ['ã‚¹ãƒŠã‚¤ãƒ‡ãƒ«', 'ã™ãªã„ã§ã‚‹'],
  'moussy': ['ãƒã‚¦ã‚¸ãƒ¼', 'ã¾ã†ã˜ãƒ¼'],
  'sly': ['ã‚¹ãƒ©ã‚¤', 'ã™ã‚‰ã„'],
  'emoda': ['ã‚¨ãƒ¢ãƒ€', 'ãˆã‚‚ã '],
  'murua': ['ãƒ ãƒ«ãƒ¼ã‚¢', 'ã‚€ã‚‹ãƒ¼ã‚'],
  'mercuryduo': ['ãƒãƒ¼ã‚­ãƒ¥ãƒªãƒ¼ãƒ‡ãƒ¥ã‚ª', 'ã¾ãƒ¼ãã‚…ã‚Šãƒ¼ã§ã‚…ãŠ'],
  'dazzlin': ['ãƒ€ã‚ºãƒªãƒ³', 'ã ãšã‚Šã‚“'],
  'lily brown': ['ãƒªãƒªãƒ¼ãƒ–ãƒ©ã‚¦ãƒ³', 'ã‚Šã‚Šãƒ¼ã¶ã‚‰ã†ã‚“'],
  'fray i.d': ['ãƒ•ãƒ¬ã‚¤ã‚¢ã‚¤ãƒ‡ã‚£ãƒ¼', 'ãµã‚Œã„ã‚ã„ã§ãƒãƒ¼'],
  'theory': ['ã‚»ã‚ªãƒªãƒ¼', 'ã›ãŠã‚Šãƒ¼'],
  'untitled': ['ã‚¢ãƒ³ã‚¿ã‚¤ãƒˆãƒ«', 'ã‚ã‚“ãŸã„ã¨ã‚‹'],
  'natural beauty basic': ['ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ™ãƒ¼ã‚·ãƒƒã‚¯', 'ãªã¡ã‚…ã‚‰ã‚‹ã³ã‚…ãƒ¼ã¦ãƒãƒ¼ã¹ãƒ¼ã—ã£ã'],
  'rope': ['ãƒ­ãƒš', 'ã‚ãº'],
  'iena': ['ã‚¤ã‚¨ãƒŠ', 'ã„ãˆãª'],
  'spick and span': ['ã‚¹ãƒ”ãƒƒã‚¯ã‚¢ãƒ³ãƒ‰ã‚¹ãƒ‘ãƒ³', 'ã™ã´ã£ãã‚ã‚“ã©ã™ã±ã‚“'],
  'tomorrowland': ['ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰', 'ã¨ã…ã‚‚ã‚ãƒ¼ã‚‰ã‚“ã©'],
  'macphee': ['ãƒã‚«ãƒ•ã‚£ãƒ¼', 'ã¾ã‹ãµãƒãƒ¼'],
  'onward': ['ã‚ªãƒ³ãƒ¯ãƒ¼ãƒ‰', 'ãŠã‚“ã‚ãƒ¼ã©'],
  'world': ['ãƒ¯ãƒ¼ãƒ«ãƒ‰', 'ã‚ãƒ¼ã‚‹ã©']
};

// ç¾åœ¨ã®é ­æ–‡å­—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
var currentInitialFilter_ = null;

// æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒ‰åå€™è£œã‚’å–å¾—
function getBrandSearchKeys_(brandKey) {
  var keys = [brandKey.toLowerCase()];
  // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿½åŠ 
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      keys = keys.concat(brandAliases_[eng].map(function(a) { return a.toLowerCase(); }));
    }
  }
  return keys;
}

// æ¤œç´¢ã‚¯ã‚¨ãƒªãŒãƒ–ãƒ©ãƒ³ãƒ‰ã«ãƒãƒƒãƒã™ã‚‹ã‹
function matchesBrandSearch_(brandKey, query) {
  if (!query) return true;
  var q = query.toLowerCase();
  // ãƒ–ãƒ©ãƒ³ãƒ‰åè‡ªä½“ã«ãƒãƒƒãƒ
  if (brandKey.toLowerCase().indexOf(q) !== -1) return true;
  // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‹ã‚‰ãƒãƒƒãƒ
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      for (var i = 0; i < brandAliases_[eng].length; i++) {
        if (brandAliases_[eng][i].toLowerCase().indexOf(q) !== -1) return true;
      }
    }
    // é€†æ–¹å‘: æ—¥æœ¬èªå…¥åŠ›ã§è‹±èªãƒ–ãƒ©ãƒ³ãƒ‰ã‚’æ¤œç´¢
    for (var j = 0; j < brandAliases_[eng].length; j++) {
      if (q.indexOf(brandAliases_[eng][j].toLowerCase()) !== -1 || brandAliases_[eng][j].toLowerCase().indexOf(q) !== -1) {
        if (brandKey.toLowerCase().indexOf(eng) !== -1) return true;
      }
    }
  }
  return false;
}

// é ­æ–‡å­—ã‚’å–å¾—
function getInitialChar_(name) {
  if (!name) return '#';
  var c = name.charAt(0).toUpperCase();
  // è‹±å­—
  if (/[A-Z]/.test(c)) return c;
  // æ•°å­—
  if (/[0-9]/.test(c)) return '#';
  // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®è¡Œåˆ¤å®š
  var hiraOrder = 'ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“';
  var kataOrder = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³';
  var idx = hiraOrder.indexOf(c);
  if (idx === -1) idx = kataOrder.indexOf(c);
  if (idx !== -1) {
    var row = Math.floor(idx / 5);
    var rowHeads = ['ã‚', 'ã‹', 'ã•', 'ãŸ', 'ãª', 'ã¯', 'ã¾', 'ã‚„', 'ã‚‰', 'ã‚'];
    return rowHeads[Math.min(row, rowHeads.length - 1)] || 'ã‚';
  }
  // æ¼¢å­—ãªã©
  return 'ä»–';
}

function buildBrandListOnce_(brands) {
  if (state.brandUi.built) return;
  state.brandUi.built = true;
  state.brandUi.all = Array.isArray(brands) ? brands.slice() : [];
  state.brandUi.selected = {};
  state.brandUi.itemsByKey = {};

  // ãƒ–ãƒ©ãƒ³ãƒ‰åã‚’æ­£è¦åŒ–ã—ã¦çµ±åˆ
  brandDisplayMap_ = {};
  brandNormalizedMap_ = {};
  var normalizedOrder = [];

  for (var i = 0; i < state.brandUi.all.length; i++) {
    var name = String(state.brandUi.all[i] || '').trim();
    if (!name) continue;
    var key = normalizeBrand_(name);
    brandNormalizedMap_[name] = key;
    if (!brandDisplayMap_[key]) {
      brandDisplayMap_[key] = name;
      normalizedOrder.push(key);
    }
  }

  // é ­æ–‡å­—ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  var groups = {};
  var groupOrder = [];
  for (var i = 0; i < normalizedOrder.length; i++) {
    var key = normalizedOrder[i];
    var displayName = brandDisplayMap_[key];
    var initial = getInitialChar_(displayName);
    if (!groups[initial]) {
      groups[initial] = [];
      groupOrder.push(initial);
    }
    groups[initial].push({ key: key, displayName: displayName });
  }

  // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
  groupOrder.sort(function(a, b) {
    var orderA = /[A-Z]/.test(a) ? a.charCodeAt(0) : (a === '#' ? 999 : 1000 + 'ã‚ã‹ã•ãŸãªã¯ã¾ã‚„ã‚‰ã‚ä»–'.indexOf(a));
    var orderB = /[A-Z]/.test(b) ? b.charCodeAt(0) : (b === '#' ? 999 : 1000 + 'ã‚ã‹ã•ãŸãªã¯ã¾ã‚„ã‚‰ã‚ä»–'.indexOf(b));
    return orderA - orderB;
  });

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ§‹ç¯‰
  var nav = $('brandIndexNav');
  if (nav) {
    nav.innerHTML = '';
    // ã€Œã™ã¹ã¦ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    var allBtn = document.createElement('button');
    allBtn.className = 'brandIndexBtn filter-active';
    allBtn.textContent = 'ã™ã¹ã¦';
    allBtn.dataset.initial = 'all';
    allBtn.addEventListener('click', function() {
      currentInitialFilter_ = null;
      filterBrandList_();
      updateIndexBtnState_('all');
    });
    nav.appendChild(allBtn);

    groupOrder.forEach(function(initial) {
      var btn = document.createElement('button');
      btn.className = 'brandIndexBtn';
      btn.textContent = initial;
      btn.dataset.initial = initial;
      btn.addEventListener('click', function() {
        // åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰è§£é™¤
        if (currentInitialFilter_ === initial) {
          currentInitialFilter_ = null;
          updateIndexBtnState_('all');
        } else {
          currentInitialFilter_ = initial;
          updateIndexBtnState_(initial);
        }
        filterBrandList_();
      });
      nav.appendChild(btn);
    });
  }

  function updateIndexBtnState_(activeInitial) {
    document.querySelectorAll('.brandIndexBtn').forEach(function(b) {
      b.classList.remove('filter-active');
      if (b.dataset.initial === activeInitial) b.classList.add('filter-active');
    });
  }

  // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªã‚¹ãƒˆæ§‹ç¯‰
  var list = $('brandList');
  list.innerHTML = '';

  groupOrder.forEach(function(initial) {
    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼
    var header = document.createElement('div');
    header.className = 'brandGroupHeader';
    header.dataset.initial = initial;
    header.textContent = initial;
    list.appendChild(header);

    // ã‚°ãƒ«ãƒ¼ãƒ—å†…ãƒ–ãƒ©ãƒ³ãƒ‰
    groups[initial].forEach(function(brand) {
      var row = document.createElement('div');
      row.className = 'brandItem';
      row.dataset.name = brand.key;
      row.dataset.key = brand.key.toLowerCase();
      row.dataset.initial = initial;

      var checkEl = document.createElement('span');
      checkEl.className = 'brand-check';
      var label = document.createElement('div');
      label.className = 'brandName';
      label.textContent = brand.displayName;

      row.appendChild(checkEl);
      row.appendChild(label);
      state.brandUi.itemsByKey[brand.key] = row;
      list.appendChild(row);
    });
  });

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  list.addEventListener('click', function(ev) {
    var item = ev.target.closest ? ev.target.closest('.brandItem') : null;
    if (!item) return;
    var key = String(item.dataset.name || '');
    if (!key) return;

    var isSelected = item.classList.contains('selected');
    if (isSelected) {
      item.classList.remove('selected');
      delete state.brandUi.selected[key];
    } else {
      item.classList.add('selected');
      state.brandUi.selected[key] = true;
    }
    updateBrandBtn_();
  });
}

function filterBrandList_() {
  var q = String($('brandSearch').value || '').trim();
  var list = $('brandList');
  var shown = 0;
  var visibleGroups = {};

  // ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  list.querySelectorAll('.brandItem').forEach(function(el) {
    var key = String(el.dataset.key || '');
    var initial = el.dataset.initial;
    // æ¤œç´¢ã‚¯ã‚¨ãƒªã¨é ­æ–‡å­—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
    var matchQuery = matchesBrandSearch_(key, q);
    var matchInitial = !currentInitialFilter_ || initial === currentInitialFilter_;
    var ok = matchQuery && matchInitial;
    el.style.display = ok ? '' : 'none';
    if (ok) {
      shown++;
      visibleGroups[initial] = true;
    }
  });

  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
  list.querySelectorAll('.brandGroupHeader').forEach(function(header) {
    var initial = header.dataset.initial;
    var showHeader = currentInitialFilter_ ? (initial === currentInitialFilter_) : visibleGroups[initial];
    header.style.display = showHeader ? '' : 'none';
  });

  if ($('brandHint')) {
    var n = brandCount_();
    $('brandHint').textContent = n ? ('é¸æŠä¸­ï¼š' + n + 'ä»¶ / è¡¨ç¤ºï¼š' + shown + 'ä»¶') : ('è¡¨ç¤ºï¼š' + shown + 'ä»¶');
  }
}

// =====================================================
// ãŠã™ã™ã‚å•†å“
// =====================================================

// ãŠã™ã™ã‚å¯¾è±¡ã®çŠ¶æ…‹ï¼ˆS, A, AB ã¾ãŸã¯åŒç­‰ã®æ—¥æœ¬èªè¡¨ç¾ï¼‰
var RECOMMEND_STATES = ['S', 'A', 'AB', 'æ–°å“', 'ç¾å“', 'è‰¯å“', 'æ–°å“åŒæ§˜', 'æœªä½¿ç”¨', 'æœªä½¿ç”¨ã«è¿‘ã„'];

function isRecommendableState_(state) {
  if (!state) return false;
  var s = String(state).trim().toUpperCase();
  for (var i = 0; i < RECOMMEND_STATES.length; i++) {
    if (s === RECOMMEND_STATES[i].toUpperCase() || s.indexOf(RECOMMEND_STATES[i].toUpperCase()) !== -1) return true;
  }
  return false;
}

function getRecommendedProducts_(maxCount, excludeIds) {
  if (!state.allProducts || !state.allProducts.length) return [];

  var cartIds = excludeIds || state.cart.ids || [];
  var cartItems = [];
  for (var i = 0; i < cartIds.length; i++) {
    var it = state.cart.itemsById[cartIds[i]];
    if (it) cartItems.push(it);
  }

  // ã‚«ãƒ¼ãƒˆå†…ã®ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»æ€§åˆ¥ãƒ»ã‚µã‚¤ã‚ºãƒ»ä¾¡æ ¼å¸¯ã‚’åé›†
  var cartBrands = {}, cartCategories = {}, cartGenders = {}, cartSizes = {};
  var priceSum = 0, priceCount = 0;
  for (var i = 0; i < cartItems.length; i++) {
    var ci = cartItems[i];
    if (ci.brand) cartBrands[normalizeBrand_(ci.brand)] = true;
    if (ci.category) cartCategories[ci.category] = true;
    if (ci.gender) cartGenders[ci.gender] = true;
    if (ci.size) cartSizes[ci.size] = true;
    if (ci.price) { priceSum += ci.price; priceCount++; }
  }
  var avgPrice = priceCount > 0 ? (priceSum / priceCount) : 0;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
  var candidates = [];
  for (var i = 0; i < state.allProducts.length; i++) {
    var p = state.allProducts[i];

    // ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã¯é™¤å¤–
    if (cartIds.indexOf(p.managedId) !== -1) continue;

    // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆS, A, ABç­‰ï¼‰
    if (!isRecommendableState_(p.state)) continue;

    // å‚·æ±šã‚Œè©³ç´°ãŒã‚ã‚‹å ´åˆã¯é™¤å¤–
    if (p.defectDetail && p.defectDetail.trim()) continue;

    // ãƒ–ãƒ©ãƒ³ãƒ‰ä¸æ˜ãƒ»è¨˜è¼‰ãªã—ã¯é™¤å¤–
    var brand = String(p.brand || '').trim().toLowerCase();
    if (!brand || brand === 'ä¸æ˜' || brand === 'è¨˜è¼‰ãªã—' || brand === 'ãªã—' || brand === 'ç„¡ã—' || brand === 'ãƒãƒ¼ãƒ–ãƒ©ãƒ³ãƒ‰' || brand === 'unknown' || brand === 'none') continue;

    // ã‚¹ã‚³ã‚¢è¨ˆç®—
    var score = 0;
    if (cartBrands[normalizeBrand_(p.brand)]) score += 30;
    if (cartCategories[p.category]) score += 20;
    if (cartGenders[p.gender]) score += 15;
    if (cartSizes[p.size]) score += 10;
    if (avgPrice > 0 && p.price) {
      var priceDiff = Math.abs(p.price - avgPrice) / avgPrice;
      if (priceDiff <= 0.3) score += 5;
    }

    // ã‚«ãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ä¾¡æ ¼ãŒé«˜ã„é †ã«ãƒ©ãƒ³ãƒ€ãƒ 
    if (cartItems.length === 0) {
      score = p.price || 0;
    }

    candidates.push({ product: p, score: score });
  }

  // ã‚¹ã‚³ã‚¢é™é †ã€åŒã‚¹ã‚³ã‚¢ãªã‚‰ä¾¡æ ¼é™é †ã§ã‚½ãƒ¼ãƒˆå¾Œã€ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ è¿½åŠ 
  candidates.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return (b.product.price || 0) - (a.product.price || 0);
  });

  // ä¸Šä½ã‚’å–å¾—ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆåŒã‚¹ã‚³ã‚¢å¸¯ã§ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‡ºã™ï¼‰
  var top = candidates.slice(0, Math.min(maxCount * 3, candidates.length));
  for (var i = top.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = top[i]; top[i] = top[j]; top[j] = temp;
  }

  var result = [];
  for (var i = 0; i < Math.min(maxCount, top.length); i++) {
    result.push(top[i].product);
  }
  return result;
}

function renderRecommendations_(containerId, sectionId, maxCount, isMainScreen) {
  var container = $(containerId);
  var section = $(sectionId);
  if (!container || !section) return;

  var recommendations = getRecommendedProducts_(maxCount || 6, state.cart.ids);

  if (recommendations.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  container.innerHTML = '';

  for (var i = 0; i < recommendations.length; i++) {
    var p = recommendations[i];
    var card = document.createElement('div');
    card.className = 'recommendCard';

    var imgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl) : '';
    var img = document.createElement('img');
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23eee" width="100" height="100"/%3E%3Ctext x="50" y="55" text-anchor="middle" fill="%23999" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = p.noLabel || p.managedId;

    var info = document.createElement('div');
    info.className = 'rcInfo';
    var brand = document.createElement('div');
    brand.className = 'rcBrand';
    brand.textContent = p.brand || '-';
    var price = document.createElement('div');
    price.className = 'rcPrice';
    price.textContent = yen(p.price);
    info.appendChild(brand);
    info.appendChild(price);

    card.appendChild(img);
    card.appendChild(info);

    (function(mid, iurl, mainScreen) {
      card.addEventListener('click', function() {
        if (!mainScreen) closeModal($('cartModal'));
        detailReturnTo_ = mainScreen ? null : 'cart';
        openDetailModal(mid, iurl);
      });
    })(p.managedId, imgUrl, isMainScreen);

    container.appendChild(card);
  }
}

function renderMainRecommendations_() {
  renderRecommendations_('mainRecommendList', 'mainRecommend', 8, true);
}

// =====================================================
// ã‚«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»é€ä¿¡
// =====================================================

function renderCartModal_() {
  var listEl = $('cartList'); listEl.innerHTML = '';
  var ids = (state.cart.ids || []).slice();
  var sum = 0;
  
  for (var i = 0; i < ids.length; i++) {
    var id = ids[i];
    var it = state.cart.itemsById[id];
    if (!it) continue;
    var row = document.createElement('div'); row.className = 'cartRow';

    // ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ
    var info = document.createElement('div'); info.className = 'cartInfo';

    // å•†å“ç”»åƒ
    var imgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '';
    var img = document.createElement('img'); img.className = 'cartImg';
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"%3E%3Crect fill="%23eee" width="50" height="50"/%3E%3Ctext x="25" y="30" text-anchor="middle" fill="%23999" font-size="10"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = it.noLabel || id;
    (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, imgUrl);

    var left = document.createElement('div'); left.className = 'cartLeft';
    var name = document.createElement('div'); name.className = 'cartName'; name.style.cursor = 'pointer';
    name.textContent = (it.noLabel ? it.noLabel : id) + (it.brand ? (' ' + it.brand) : '');
    (function(mid, iurl) { name.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, imgUrl);
    var sub = document.createElement('div'); sub.className = 'cartSub';
    sub.textContent = [it.category, it.color, it.gender, it.size].filter(Boolean).join(' / ') + ' / ' + yen(it.price);
    left.appendChild(name); left.appendChild(sub);
    info.appendChild(img); info.appendChild(left);

    var btn = document.createElement('button'); btn.className = 'dangerBtn'; btn.type = 'button'; btn.textContent = 'å‰Šé™¤';
    (function(idRef) {
      btn.addEventListener('click', function() {
        var idx = state.cart.ids.indexOf(idRef);
        if (idx !== -1) state.cart.ids.splice(idx, 1);
        saveCartStorage(); updateCartCount(); updateCardUi_(idRef);
        runApi('apiSyncHolds', state.userKey, state.cart.ids.slice()).catch(function() {});
        renderCartModal_();
      });
    })(id);
    row.appendChild(info); row.appendChild(btn); listEl.appendChild(row);
    sum += Number(it.price || 0);
  }
  
  var count = ids.length;
  $('sumCount').textContent = 'åˆè¨ˆç‚¹æ•°ï¼š' + count + 'ç‚¹';
  // å‰²å¼•ã‚’ç´¯ç©ï¼ˆä¼šå“¡10%ï¼‰
  var discountRate = 0;
  var discountLabels = [];
  if (state.customer) { discountRate += MEMBER_DISCOUNT_RATE; discountLabels.push('ä¼šå“¡10%OFF'); }
  var discounted = Math.round(sum * (1 - discountRate));
  var discountLabel = discountLabels.length > 0 ? 'ï¼ˆ' + discountLabels.join('ï¼‹') + 'ï¼‰' : '';
  if (discountRate > 0) {
    $('sumPrice').innerHTML = 'åˆè¨ˆé‡‘é¡ï¼š<span class="price-old">' + yen(sum) + '</span> â†’ <span class="price-new">' + yen(discounted) + '</span>' + discountLabel;
  } else { $('sumPrice').innerHTML = 'åˆè¨ˆé‡‘é¡ï¼š' + yen(discounted); }

  $('goFormBtn').disabled = (count === 0);

  // ãŠã™ã™ã‚å•†å“ã‚’è¡¨ç¤º
  renderRecommendations_('cartRecommendList', 'cartRecommend', 6);
}

function readForm_() {
  return {
    companyName: $('companyName').value || '', contact: $('contact').value || '',
    postal: $('postal').value || '', address: $('address').value || '',
    phone: $('phone').value || '', note: $('note').value || '', measureOpt: getMeasureOptValue_()
  };
}

function validateForm_(f) {
  if (!f.companyName.trim()) return 'ä¼šç¤¾å/æ°åã¯å¿…é ˆã§ã™';
  if (!f.contact.trim()) return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.contact.trim())) return 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
  return '';
}

var submitting_ = false;
function submitNow_() {
  if (submitting_) return;
  submitting_ = true;
  if ((state.cart.ids || []).length === 0) { showToast('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™'); submitting_ = false; return; }
  var f = readForm_();
  var err = validateForm_(f);
  if (err) { showToast(err); submitting_ = false; return; }
  $('submitBtn').disabled = true;
  setSending_(true, 'è¦‹ç©ã‚‚ã‚Šé€ä¿¡ä¸­...');
  var ids = (state.cart.ids || []).slice();

  runApi('apiSyncHolds', state.userKey, ids)
    .then(function(syncResult) {
      if (!syncResult || !syncResult.ok) throw new Error(syncResult && syncResult.message ? syncResult.message : 'ç¢ºä¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      if (syncResult.failed && syncResult.failed.length) {
        state.cart.ids = state.cart.ids.filter(function(x) { return !syncResult.failed.find(function(f) { return f.id === x; }); });
        saveCartStorage(); updateCartCount(); renderCartModal_();
        throw new Error('ä¸€éƒ¨ç¢ºä¿ã§ããªã„å•†å“ãŒã‚ã‚Šã¾ã™');
      }
      return getRecaptchaToken_().then(function(token) {
        return runApi('apiSubmitEstimate', state.userKey, f, ids, { _runApiExtra_: true, recaptchaToken: token });
      });
    })
    .then(function(res) {
      if (!res || !res.ok) throw new Error(res && res.message ? res.message : 'è¦‹ç©ã‚‚ã‚Šé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      var receiptNo = res.receiptNo || '';
      // è¦‹ç©ã‚‚ã‚Šå®Œäº† â†’ ã‚«ãƒ¼ãƒˆã‚¯ãƒªã‚¢ & å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      state.cart.ids = [];
      saveCartStorage(); updateCartCount();
      $('doneReceipt').textContent = receiptNo;
      closeModal($('formModal'));
      openModal($('doneModal'));
    })
    .catch(function(e) {
      showToast(e.message || 'è¦‹ç©ã‚‚ã‚Šé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    })
    .finally(function() { setSending_(false); $('submitBtn').disabled = false; submitting_ = false; });
}

// =====================================================
// è¨­å®š
// =====================================================

function normalizeSettings_(s) {
  var src = (s && typeof s === 'object') ? s : {};
  var ui = (src.uiText && typeof src.uiText === 'object') ? src.uiText : {};
  var out = {};
  out.appTitle = String(src.appTitle || ui.appTitle || 'NKonlineApparel');
  out.minOrderCount = Number(src.minOrderCount != null ? src.minOrderCount : (ui.minOrderCount != null ? ui.minOrderCount : 10));
  out.shippingEstimateText = String(src.shippingEstimateText || ui.shippingEstimateText || '');
  out.notes = Array.isArray(src.notes) ? src.notes : (Array.isArray(ui.notes) ? ui.notes : []);
  out.nextSteps = Array.isArray(src.nextSteps) ? src.nextSteps : (Array.isArray(ui.nextSteps) ? ui.nextSteps : []);
  out.basePaymentUrl = String(src.basePaymentUrl || ui.basePaymentUrl || '');
  return out;
}

function setBaseLink_() {
  var a = $('baseLink');
  if (!a) return;
  var url = (state.settings && state.settings.basePaymentUrl) ? String(state.settings.basePaymentUrl) : '';
  if (!url) { a.textContent = ''; a.removeAttribute('href'); return; }
  a.textContent = url; a.href = url;
}

// =====================================================
// UIåˆæœŸåŒ–
// =====================================================

function bindUi_() {
  $('overlay').addEventListener('click', closeAllModals);
  
  $('brandBtn').addEventListener('click', function() {
    $('brandSearch').value = '';
    filterBrandList_(); updateBrandBtn_(); openModal($('brandModal'));
    try { $('brandSearch').focus(); } catch (e) {}
  });
  $('brandCloseBtn').addEventListener('click', function() { closeModal($('brandModal')); });
  $('brandSearch').addEventListener('input', filterBrandList_);
  $('brandClearBtn').addEventListener('click', function() {
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é¸æŠçŠ¶æ…‹ã‚‚ã‚¯ãƒªã‚¢
    $('brandList').querySelectorAll('.brandItem.selected').forEach(function(el) {
      el.classList.remove('selected');
    });
    // æ¤œç´¢å…¥åŠ›ã‚‚ã‚¯ãƒªã‚¢
    $('brandSearch').value = '';
    // é ­æ–‡å­—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚ãƒªã‚»ãƒƒãƒˆ
    currentInitialFilter_ = null;
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('brandIndexNav').querySelectorAll('.brandIndexBtn').forEach(function(btn) {
      btn.classList.remove('filter-active');
      if (btn.dataset.initial === 'all') btn.classList.add('filter-active');
    });
    // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    state.brandUi.selected = {};
    updateBrandBtn_();
    filterBrandList_();
  });
  $('brandApplyBtn').addEventListener('click', function() {
    state.query.filters.brand = Object.keys(state.brandUi.selected || {});
    state.query.page = 1; updateBrandBtn_(); closeModal($('brandModal')); filterAndRender(true);
  });
  
  var doFilter_ = function() { state.query.page = 1; filterAndRender(true); };
  // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯setupMultiSelectFilters()ã§è¨­å®š
  $('sortKey').addEventListener('change', function() { state.query.sort.key = this.value; doFilter_(); });
  $('sortDir').addEventListener('change', function() { state.query.sort.dir = this.value; doFilter_(); });
  
  $('btnReset').addEventListener('click', function() {
    state.query.filters = { brand: [], category: [], state: [], gender: [], size: [] };
    state.query.sort = { key: 'default', dir: 'asc' };
    state.query.page = 1;
    // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    state.brandUi.selected = {}; updateBrandBtn_();
    // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetMultiSelectFilters();
    $('sortKey').value = 'default'; $('sortDir').value = 'asc';
    filterAndRender(true);
  });
  
  $('openCartBtn').addEventListener('click', function() { renderCartModal_(); openModal($('cartModal')); });
  $('clearCartBtn').addEventListener('click', function() {
    state.cart.ids = []; saveCartStorage(); updateCartCount(); renderCartModal_(); filterAndRender(false);
    runApi('apiSyncHolds', state.userKey, []).catch(function() {});
    showToast('ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¾ã—ãŸ');
  });
  $('cartCloseBtn').addEventListener('click', function() { closeModal($('cartModal')); });
  $('goFormBtn').addEventListener('click', function() {
    var min = (state.settings && state.settings.minOrderCount) ? Number(state.settings.minOrderCount) : 10;
    var count = (state.cart.ids || []).length;
    if (count < min) {
      showToast(min + 'ç‚¹ä»¥ä¸Šã§è¦‹ç©ã‚‚ã‚Šå¯èƒ½ã§ã™ï¼ˆç¾åœ¨' + count + 'ç‚¹ï¼‰');
      return;
    }
    closeModal($('cartModal'));
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
    if (state.customer) {
      if (state.customer.companyName && !$('companyName').value) $('companyName').value = state.customer.companyName;
      if (state.customer.email && !$('contact').value) $('contact').value = state.customer.email;
      if (state.customer.phone && !$('phone').value) $('phone').value = state.customer.phone;
      if (state.customer.postal && !$('postal').value) $('postal').value = state.customer.postal;
      if (state.customer.address && !$('address').value) $('address').value = state.customer.address;
    }
    openModal($('formModal'));
  });
  $('formCloseBtn').addEventListener('click', function() { closeModal($('formModal')); });
  $('formBackBtn').addEventListener('click', function() { closeModal($('formModal')); renderCartModal_(); openModal($('cartModal')); });
  $('submitBtn').addEventListener('click', submitNow_);
  $('doneCloseBtn').addEventListener('click', function() { closeModal($('doneModal')); });
  
}

function setupScrollTopButton_() {
  var btn = $('toTopBtn');
  if (!btn) return;
  var threshold = 400;
  var update = function() {
    var hasModal = !!document.querySelector('.modal.open');
    var sendingOn = $('sendingOverlay') && $('sendingOverlay').classList.contains('on');
    if (hasModal || sendingOn) { btn.classList.remove('show'); return; }
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > threshold) btn.classList.add('show'); else btn.classList.remove('show');
  };
  btn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  window.addEventListener('scroll', update, { passive: true });
  window.addEventListener('resize', update);
  update();
}

// =====================================================
// ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆPVè¨˜éŒ²ï¼‰
// =====================================================

function logPageView_() {
  try {
    var payload = {
      page: 'Index',
      userKey: state.userKey || '',
      url: window.location.href || '',
      referrer: document.referrer || '',
      userAgent: navigator.userAgent || '',
      language: navigator.language || '',
      screen: (screen.width || 0) + 'x' + (screen.height || 0)
    };
    runApi('apiLogPV', payload).catch(function(e) {
      console.log('PVãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:', e);
    });
  } catch (e) {
    console.log('PVãƒ­ã‚°é€ä¿¡å¤±æ•—:', e);
  }
}

// =====================================================
// èµ·å‹•
// =====================================================

function boot() {
  state.userKey = loadUserKey();
  var c = loadCartStorage();
  state.cart.ids = c.ids || [];
  state.cart.itemsById = c.itemsById || {};
  updateCartCount();

  // ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°é€ä¿¡
  logPageView_();

  bindUi_();
  setupScrollTopButton_();
  setupDetailModalEvents_();
  setupAuthUi_();
  setupMultiSelectFilters();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹å¾©å…ƒï¼‰
  validateSession_();

  // èª¬æ˜æ¬„ã©ã“ã‚’æŠ¼ã—ã¦ã‚‚æŠ˜ã‚ŠãŸãŸã¿
  var topDet = document.querySelector('.topDetails');
  if (topDet) {
    topDet.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') return; // ãƒªãƒ³ã‚¯ã¯ãã®ã¾ã¾
      if (e.target.closest('summary')) return; // summaryã¯æ¨™æº–å‹•ä½œ
      topDet.open = !topDet.open;
    });
  }

  var mo = loadMeasureOpt_();
  if (mo) setMeasureOptValue_(mo);
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³åº§ã«è¡¨ç¤º
  var cached = loadProductCache_();
  if (cached && !cached.stale && cached.products) {
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³æ™‚è¡¨ç¤º:', cached.products.length + 'ä»¶');
    applyProductData_(cached);
  } else if (cached && cached.stale && cached.data && cached.data.products) {
    console.log('å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³æ™‚è¡¨ç¤º:', cached.data.products.length + 'ä»¶');
    applyProductData_(cached.data);
  } else {
    renderLoadingGrid_();
  }

  // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å–å¾—
  loadProductData()
    .then(function(data) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ä»¶æ•°ãŒç•°ãªã‚‹å ´åˆã®ã¿å†æç”»
      var needsRender = !state.dataLoaded || state.allProducts.length !== (data.products || []).length;
      applyProductData_(data);
      if (needsRender) {
        console.log('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°: ' + state.allProducts.length + 'ä»¶');
      }
    })
    .catch(function(err) {
      console.error('èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
      if (!state.dataLoaded) {
        showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    });
}

function applyProductData_(data) {
  state.allProducts = data.products || [];
  state.options = data.options || {};
  state.settings = normalizeSettings_(data.settings);

  $('appTitle').textContent = 'NKonlineApparel';
  setBaseLink_();

  // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
  buildMultiSelectDropdown('category', state.options.category || []);
  // çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ã¯Sâ†’Aâ†’ABâ†’Bâ†’Câ†’Dé †ã«ã‚½ãƒ¼ãƒˆ
  var stateOrder = ['S', 'A', 'AB', 'B', 'C', 'D', 'æ–°å“', 'ç¾å“', 'è‰¯å“'];
  var sortedStates = (state.options.state || []).slice().sort(function(a, b) {
    var idxA = stateOrder.indexOf(a);
    var idxB = stateOrder.indexOf(b);
    if (idxA === -1) idxA = 999;
    if (idxB === -1) idxB = 999;
    return idxA - idxB;
  });
  buildMultiSelectDropdown('state', sortedStates);
  buildMultiSelectDropdown('gender', state.options.gender || []);
  buildMultiSelectDropdown('size', state.options.size || []);
  setSortOptions($('sortKey'), state.options.sort || [{ key: 'default', label: 'æ¨™æº–' }]);
  if (!state.dataLoaded) {
    $('sortKey').value = 'default';
    $('sortDir').value = 'asc';
  }

  buildBrandListOnce_(state.options.brand || []);
  updateBrandBtn_();
  filterBrandList_();

  state.dataLoaded = true;
  filterAndRender(false);

  // ãƒ¡ã‚¤ãƒ³ç”»é¢ãŠã™ã™ã‚å•†å“ã‚’è¡¨ç¤º
  renderMainRecommendations_();
}

window.addEventListener('error', function(ev) {
  var msg = (ev && ev.error && ev.error.message) ? ev.error.message : (ev && ev.message ? ev.message : 'ã‚¨ãƒ©ãƒ¼');
  // Suppress cross-origin "Script error" messages (not useful to users)
  if (msg === 'Script error.' || msg === 'Script error') return;
  try { showToast(msg); } catch (e) {}
});

window.addEventListener('unhandledrejection', function(ev) {
  var r = ev ? ev.reason : null;
  var msg = (r && r.message) ? r.message : String(r || 'ã‚¨ãƒ©ãƒ¼');
  try { showToast(msg); } catch (e) {}
});

boot();
</script>

</body>
</html>
