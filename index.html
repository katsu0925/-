
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://www.google.com/recaptcha/api.js?render=6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1" async defer></script>
  <style>
    html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; color:#111; background:#f6f7f9; -webkit-text-size-adjust:100%; }
    * { box-sizing:border-box; }
    input, select, textarea, button { font-size:16px; }
    .topbar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #e6e8ee;padding:12px 14px;}
    .wrap{margin:0 auto;padding:12px 14px 90px;}
        .title{font-weight:900;font-size:18px;}
    .subnote{margin-top:6px;font-size:12px;color:#666;line-height:1.4;}
    .topDetails{margin-top:6px;cursor:pointer;}
    .topDetails a{cursor:pointer;}
    .topSummary{font-size:12px;font-weight:900;color:#555;cursor:pointer;list-style:none;display:flex;align-items:center;gap:6px;}
    .topSummary::-webkit-details-marker{display:none;}
    .topSummary::before{content:'▼';font-size:10px;transition:transform .2s;}
    details:not([open])>.topSummary::before{content:'▶';}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .field{min-width:170px;flex:1 1 170px;}
    .field.big{min-width:240px;flex:2 1 240px;}
    .controls input,.controls select{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .btn{padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .btn.primary{background:#111;color:#fff;border-color:#111;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,280px));gap:12px;margin-top:12px;justify-content:center;}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));} .card{min-height:auto;} .cardbody{padding:6px 6px;gap:3px;} .noText{font-size:11px;} .brandText{font-size:10px;-webkit-line-clamp:2;} .price{font-size:12px;} .meta{font-size:10px;} .badge{font-size:9px;padding:2px 5px;} .selectBtn{padding:7px 5px;font-size:11px;}}
    .card{background:#fff;border:1px solid #e6e8ee;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;}
    .thumb{width:100%;aspect-ratio:1/1;background:#f0f2f7;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
    .cardbody{padding:10px 12px;display:flex;flex-direction:column;gap:6px;flex:1;}
    .row1{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;}
    .leftTitle{display:flex;flex-direction:column;gap:2px;min-width:0;font-weight:900;line-height:1.25;}
    .noText{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:900;white-space:nowrap;}
    .brandText{font-weight:900;font-size:13px;line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .defectLine{font-size:11px;min-height:16px;line-height:16px;color:transparent;}
    .defectLine.hasDefect{color:#b8002a;font-weight:700;}
    .price{font-weight:900;color:#b8002a;white-space:nowrap;}
    .meta{font-size:12px;color:#444;line-height:1.35;white-space:pre-line;}
    .badges{display:flex;gap:4px;flex-wrap:nowrap;align-items:center;}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #e6e8ee;background:#f7f8fb;color:#333;}
    .badge.ok{background:#eef7ee;border-color:#cfe9cf;}
    .badge.warn{background:#fff5e6;border-color:#ffe0ad;}
    .badge.lock{background:#ffecec;border-color:#ffd0d0;color:#a40000;}
    .actions{display:flex;gap:10px;align-items:center;}
    .selectBtn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #d9deea;background:#0b6;color:#fff;font-weight:900;cursor:pointer;display:flex;justify-content:center;align-items:center;}
    .selectBtn.off{background:#fff;color:#111;border-color:#d9deea;}
    .selectBtn.disabled{background:#f2f3f6;color:#777;border-color:#e3e5ec;cursor:not-allowed;}
    .pager{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:16px 0 0;}
    .pageBtn{min-width:36px;padding:8px 10px;border:1px solid #d9deea;background:#fff;border-radius:10px;cursor:pointer;font-weight:900;}
    .pageBtn.active{background:#111;color:#fff;border-color:#111;}
    .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(246,247,249,.9);backdrop-filter:blur(8px);border-top:1px solid #e6e8ee;padding:10px 14px;}
    .stickyInner{max-width:1200px;margin:0 auto;display:flex;justify-content:center;align-items:center;gap:10px;}
    .cartBtn{width:min(520px,100%);height:46px;border-radius:14px;border:1px solid #111;background:#f6c400;color:#111;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;}
    .countPill{min-width:28px;height:28px;border-radius:999px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;padding:0 10px;}
    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:40;}
    .overlay.open{display:block;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(860px,94vw);max-height:86vh;background:#fff;border-radius:14px;border:1px solid #e6e8ee;z-index:50;display:none;overflow:hidden;}
    .modal.open{display:block;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modalTitle{font-weight:900;}
    .modalClose{background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1;padding:6px 10px;}
    .modalBody{padding:14px 16px;overflow:auto;max-height:calc(86vh - 56px);}
    .cartList{display:flex;flex-direction:column;gap:8px;}
    .cartRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid #eef0f6;padding:10px 0;}
    .cartImg{width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;background:#f5f5f5;cursor:pointer;}
    .cartInfo{display:flex;gap:10px;align-items:center;min-width:0;flex:1;}
    .cartLeft{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .cartName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline;}
    .cartSub{font-size:12px;color:#666;}
    .dangerBtn{border:1px solid #ff4d4f;color:#ff4d4f;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900;}
    .recommendSection{margin-top:16px;padding-top:16px;border-top:1px solid #eef0f6;}
    .recommendTitle{font-weight:900;font-size:14px;color:#333;margin-bottom:10px;}
    .recommendList{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;}
    .recommendCard{flex-shrink:0;width:100px;cursor:pointer;border:1px solid #eef0f6;border-radius:8px;overflow:hidden;background:#fff;transition:box-shadow .2s;}
    .recommendCard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .recommendCard img{width:100px;height:100px;object-fit:cover;display:block;}
    .recommendCard .rcInfo{padding:6px;font-size:11px;}
    .recommendCard .rcBrand{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .recommendCard .rcPrice{color:#b8002a;font-weight:900;}
    .mainRecommendSection{margin-bottom:20px;padding:16px;background:#f8f9fc;border-radius:12px;}
    .mainRecommendTitle{font-weight:900;font-size:16px;color:#333;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .mainRecommendTitle::before{content:'★';color:#ffc107;}
    .mainRecommendList{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;}
    .mainRecommendList .recommendCard{width:120px;}
    .mainRecommendList .recommendCard img{width:120px;height:120px;}
    .authArea{display:flex;align-items:center;gap:10px;font-size:13px;}
    .authBtn{background:#fff;border:1px solid #d9deea;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:900;font-size:13px;}
    .authBtn:hover{background:#f8f9fc;}
    .authBtn.logout{background:transparent;border:none;color:#666;text-decoration:underline;padding:4px 8px;}
    .authUser{display:flex;align-items:center;gap:8px;}
    .authUserName{font-weight:900;color:#333;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .authDiscount{background:#b8002a;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .sumBox{margin-top:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
    .sumLine{font-weight:900;}
    .hint{font-size:12px;color:#666;line-height:1.45;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:700px){.formGrid{grid-template-columns:1fr;}}
    .formField label{font-size:12px;color:#555;font-weight:900;display:block;margin-bottom:6px;}
    .formField input,.formField select,.formField textarea{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .formField textarea{min-height:90px;resize:vertical;}
    .formActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
    .toast{position:fixed;left:50%;bottom:82px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:12px;display:none;z-index:60;font-weight:900;max-width:92vw;}
    .toast.show{display:block;}
    .measureWrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .measureBtn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .measureBtn input{margin:0;}
    .sendingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80;}
    .sendingOverlay.on{display:flex;}
    .sendingBox{background:#fff;border:1px solid #e6e8ee;border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .sendingSpinner{width:26px;height:26px;border-radius:999px;border:3px solid rgba(0,0,0,.15);border-top-color:#111;animation:sendingSpin 0.9s linear infinite;}
    .sendingText{font-weight:900;font-size:14px;color:#111;}
    @keyframes sendingSpin{to{transform:rotate(360deg);}}
    .selectFieldBtn{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .selectFieldBtn .muted{font-weight:900;color:#666;font-size:12px;}
    .brandTools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .brandTools input{flex:1 1 240px;min-width:200px;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;font-size:14px;transition:border-color .2s,box-shadow .2s;}
    .brandTools input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .brandToolsBar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #eef0f6;margin:-14px -16px 0;padding:14px 16px 12px;}
    .brandIndexNav{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;padding-bottom:8px;}
    .brandIndexBtn{padding:6px 10px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
    .brandIndexBtn:hover{background:#e2e8f0;}
    .brandIndexBtn.active{background:#3b82f6;color:#fff;}
    .brandGroupHeader{padding:12px 16px;margin:8px -16px 8px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);font-size:16px;font-weight:900;color:#1e293b;display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:5;}
    .brandGroupHeader::before{content:'';width:4px;height:20px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .brandList{display:flex;flex-direction:column;gap:4px;}
    .brandItem{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:#fff;cursor:pointer;user-select:none;transition:all .15s;}
    .brandItem:hover{background:#f8fafc;}
    .brandItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;}
    .brandItem input{display:none;}
    .brandItem .brand-check{width:22px;height:22px;border:2px solid #cbd5e1;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .brandItem.selected .brand-check{background:#3b82f6;border-color:#3b82f6;}
    .brandItem .brand-check::after{content:'✓';color:#fff;font-size:13px;font-weight:700;opacity:0;transition:opacity .15s;}
    .brandItem.selected .brand-check::after{opacity:1;}
    .brandName{font-weight:600;line-height:1.3;word-break:break-word;color:#334155;}
    .toTop{position:fixed;right:14px;bottom:86px;width:46px;height:46px;border-radius:999px;border:1px solid #d9deea;background:#fff;display:none;align-items:center;justify-content:center;font-weight:900;z-index:70;box-shadow:0 6px 18px rgba(0,0,0,.12);}
    .toTop.show{display:flex;}
    .price-old { text-decoration: line-through; color:#999; }
    .price-new { color:#b8002a; font-weight:700; }
    /* フィルタ・ソートUIスタイリッシュ版 */
    .filter-sort-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .filter-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
    .filter-group:last-child{margin-bottom:0;}
    .filter-group-label{width:100%;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:flex;align-items:center;gap:6px;}
    .filter-group-label::before{content:'';width:3px;height:12px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .multiSelectField{position:relative;}
    .multiSelectBtn{padding:8px 14px;border:none;border-radius:20px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);transition:all .2s;}
    .multiSelectBtn:hover{box-shadow:0 2px 6px rgba(0,0,0,.12);transform:translateY(-1px);}
    .multiSelectBtn.active{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;}
    .multiSelectBtn .filterCount{background:#ef4444;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;font-weight:700;}
    .multiSelectBtn .filterCount:empty{display:none;}
    .multiSelectDropdown{display:none;position:absolute;top:calc(100% + 8px);left:0;min-width:180px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:100;max-height:240px;overflow-y:auto;padding:8px 0;}
    .multiSelectDropdown.open{display:block;animation:dropdownIn .2s ease;}
    @keyframes dropdownIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .multiSelectItem{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;font-size:13px;transition:background .15s;}
    .multiSelectItem:hover{background:#f1f5f9;}
    .multiSelectItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);color:#1d4ed8;font-weight:600;}
    .multiSelectItem input{display:none;}
    .multiSelectItem .check-icon{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .multiSelectItem.selected .check-icon{background:#3b82f6;border-color:#3b82f6;color:#fff;}
    .multiSelectItem .check-icon::after{content:'✓';font-size:11px;opacity:0;transition:opacity .15s;}
    .multiSelectItem.selected .check-icon::after{opacity:1;}
    .sort-wrap{display:flex;gap:8px;align-items:center;}
    .sort-control{border:none !important;border-radius:20px !important;background:#fff !important;padding:8px 14px !important;font-weight:600 !important;font-size:13px !important;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer;}
    .sort-control:focus{outline:2px solid #8b5cf6;outline-offset:2px;}
    .detail-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center; }
    .detail-modal-overlay.active { display: flex; }
    .detail-modal { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .detail-modal-close { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
    .detail-modal-image { width: 100%; max-height: 300px; object-fit: contain; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-modal-content { padding: 20px; }
    .detail-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
    .detail-section { margin-bottom: 16px; }
    .detail-section-title { font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
    .detail-defect { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 14px; color: #92400e; }
    .measurement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    .measurement-item { background: #f3f4f6; border-radius: 6px; padding: 8px 12px; text-align: center; }
    .measurement-label { font-size: 12px; color: #6b7280; }
    .measurement-value { font-size: 16px; font-weight: 600; color: #111827; }
    .detail-modal-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }
    .detail-add-btn { flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .detail-add-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .detail-loading { display: flex; justify-content: center; align-items: center; min-height: 100px; color: #6b7280; }
    .product-image-clickable { cursor: zoom-in; }
    .detail-info-grid { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-bottom: 8px; }
    .detail-info-item { font-size: 14px; color: #374151; background: #f9fafb; padding: 4px 10px; border-radius: 6px; }
    .detail-info-label { font-weight: 600; color: #6b7280; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap" style="padding:0 14px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <div class="title" id="appTitle">選べる古着卸</div>
          <div class="badge ok" id="totalCountBadge"></div>
        </div>
        <div class="authArea" id="authArea">
          <button class="authBtn" id="openAuthBtn" type="button">ログイン</button>
        </div>
      </div>
      <details open class="topDetails">
        <summary class="topSummary">ご利用案内・注意事項</summary>
        <div class="subnote" id="topNotes"></div>
      </details>
    </div>
  </div>

  <div class="wrap">
    <div class="filter-sort-section">
      <!-- ブランド選択 -->
      <div class="filter-group">
        <div class="filter-group-label">ブランド</div>
        <button class="selectFieldBtn" id="brandBtn" type="button" style="flex:1;max-width:300px;">
          <span id="brandBtnText">ブランドを選択</span>
          <span class="muted" id="brandBtnSub">未選択</span>
        </button>
      </div>
      <!-- フィルタ -->
      <div class="filter-group">
        <div class="filter-group-label">絞り込み</div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fCategoryBtn" type="button">カテゴリ <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fCategoryDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fStateBtn" type="button">状態 <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fStateDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fGenderBtn" type="button">性別 <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fGenderDropdown"></div>
        </div>
        <div class="multiSelectField">
          <button class="multiSelectBtn" id="fSizeBtn" type="button">サイズ <span class="filterCount"></span></button>
          <div class="multiSelectDropdown" id="fSizeDropdown"></div>
        </div>
      </div>
      <!-- ソート -->
      <div class="filter-group">
        <div class="filter-group-label">並べ替え</div>
        <div class="sort-wrap">
          <select id="sortKey" class="sort-control"></select>
          <select id="sortDir" class="sort-control">
            <option value="asc">昇順</option>
            <option value="desc">降順</option>
          </select>
          <button class="btn" id="btnReset" type="button" style="padding:8px 16px;border-radius:20px;">リセット</button>
        </div>
      </div>
    </div>
    <!-- メイン画面おすすめ商品 -->
    <div class="mainRecommendSection" id="mainRecommend" style="display:none;">
      <div class="mainRecommendTitle">おすすめ商品</div>
      <div class="mainRecommendList" id="mainRecommendList"></div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pager" class="pager"></div>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <button class="cartBtn" id="openCartBtn" type="button">
       <span>見積もりを確認</span>
       <span class="countPill" id="cartCount">0</span>
       <span id="cartTotal" style="font-weight:900; margin-left:8px;">0円</span>
      </button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="modal" id="brandModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">ブランド選択</div>
      <button class="modalClose" id="brandCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div class="brandToolsBar">
        <div class="brandTools">
          <input id="brandSearch" type="text" placeholder="ブランド名を検索（例：ナイキ、NIKE）">
          <button class="btn" id="brandClearBtn" type="button">クリア</button>
          <button class="btn primary" id="brandApplyBtn" type="button">適用</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="brandHint"></div>
        <div class="brandIndexNav" id="brandIndexNav"></div>
      </div>
      <div id="brandList" class="brandList"></div>
    </div>
  </div>

  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">見積もり内容</div>
      <button class="modalClose" id="cartCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div class="hint" id="shippingHint"></div>
      <div class="hint" style="margin-top:6px;" id="shippingNote"></div>
      <div class="cartList" id="cartList" style="margin-top:10px;"></div>
      <!-- おすすめ商品 -->
      <div class="recommendSection" id="cartRecommend" style="display:none;">
        <div class="recommendTitle">おすすめ商品</div>
        <div class="recommendList" id="cartRecommendList"></div>
      </div>
      <div class="sumBox">
        <div class="sumLine" id="sumCount"></div>
        <div class="sumLine" id="sumPrice"></div>
        <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; width:100%;">
          <button class="btn" id="clearCartBtn" style="min-width:160px;" type="button">カートを空にする</button>
          <button class="btn primary" id="goFormBtn" style="min-width:220px;" type="button">見積もりを送信</button>
        </div>
        <div class="hint" id="minNotice"></div>
      </div>
    </div>
  </div>

  <!-- ログイン/登録モーダル -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="authModalTitle">ログイン</div>
      <button class="modalClose" id="authCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <!-- ログインフォーム -->
      <div id="loginForm">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="loginEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>パスワード *</label>
            <input id="loginPassword" type="password" autocomplete="current-password">
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="loginBtn" type="button">ログイン</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            アカウントをお持ちでない方は <a href="#" id="showRegisterLink">新規登録</a>
          </div>
        </div>
      </div>
      <!-- 登録フォーム -->
      <div id="registerForm" style="display:none;">
        <div class="formGrid">
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="regEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>パスワード（6文字以上） *</label>
            <input id="regPassword" type="password" autocomplete="new-password">
          </div>
          <div class="formField">
            <label>会社名/氏名 *</label>
            <input id="regCompanyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>電話番号</label>
            <input id="regPhone" type="tel" inputmode="numeric">
          </div>
          <div class="formField">
            <label>郵便番号</label>
            <input id="regPostal" type="text" inputmode="numeric" placeholder="0000000">
          </div>
          <div class="formField">
            <label>住所</label>
            <input id="regAddress" type="text" autocomplete="street-address">
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="regNewsletter" checked style="width:18px;height:18px;">
              <span>お得な情報をメールで受け取る</span>
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;margin-top:14px;">
          <button class="btn primary" id="registerBtn" type="button">登録する</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            既にアカウントをお持ちの方は <a href="#" id="showLoginLink">ログイン</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="formModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">依頼内容入力</div>
      <button class="modalClose" id="formCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="formField">
          <label>会社名/氏名 *</label>
          <input id="companyName" type="text" autocomplete="name">
        </div>
        <div class="formField">
          <label>メールアドレス *</label>
          <input id="contact" type="email" autocomplete="email" placeholder="example@example.com">
        </div>
        <div class="formField">
          <label>郵便番号（配送時は必須）</label>
          <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="0000000">
        </div>
        <div class="formField">
          <label>住所（配送時は必須）</label>
          <input id="address" type="text" autocomplete="street-address">
        </div>
        <div class="formField">
          <label>電話番号（配送時は必須）</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="00000000000" autocomplete="tel">
        </div>
        <div class="formField">
          <label>備考</label>
          <textarea id="note"></textarea>
        </div>
      </div>
      <div class="formActions">
        <button class="btn" id="formBackBtn" type="button">戻る</button>
        <button class="btn primary" id="submitBtn" type="button">送信</button>
      </div>
    </div>
  </div>

  <div class="modal" id="doneModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">送信完了</div>
      <button class="modalClose" id="doneCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody" style="text-align:center;">
      <div style="font-weight:900; font-size:14px;">受付番号</div>
      <div style="margin-top:8px; font-size:24px; font-weight:900; color:#3b82f6;" id="doneReceipt"></div>
      <div style="margin-top:16px; font-size:14px; color:#333; line-height:1.6;">
        BASE購入リンクをメールアドレスに送付いたしますので、しばらくお待ちください。
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div id="sendingOverlay" class="sendingOverlay" aria-hidden="true">
    <div class="sendingBox" role="status" aria-live="polite">
      <div class="sendingSpinner"></div>
      <div id="sendingText" class="sendingText">依頼送信中...</div>
    </div>
  </div>
  <button class="toTop" id="toTopBtn" type="button" aria-label="ページ上部へ">↑</button>

  <div class="detail-modal-overlay" id="detailModal">
    <div class="detail-modal">
      <button class="detail-modal-close" onclick="closeDetailModal()">×</button>
      <div id="detailModalBody">
        <div class="detail-loading">読み込み中...</div>
      </div>
    </div>
  </div>

<script>
// =====================================================
// 状態管理
// =====================================================

var state = {
  userKey: '',
  allProducts: [],
  filteredProducts: [],
  settings: null,
  options: null,
  query: {
    filters: { brand: [], category: [], state: [], gender: [], size: [] },
    sort: { key: 'default', dir: 'asc' },
    page: 1,
    pageSize: 60
  },
  cart: { ids: [], itemsById: {}, digest: {} },
  ui: { cardEls: {} },
  timers: { statusPoll: null },
  brandUi: { all: [], selected: {}, cbByName: {}, built: false },
  // 顧客認証
  customer: null,  // { id, email, companyName, phone, postal, address, newsletter }
  sessionId: null,
  dataLoaded: false
};

// =====================================================
// ユーティリティ
// =====================================================

function $(id) { return document.getElementById(id); }

function escapeHtml_(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function yen(n) {
  var x = Math.round(Number(n || 0));
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '円';
}

// ブランド名を正規化（大文字小文字・スペース統一）
function normalizeBrand_(name) {
  if (!name) return '';
  // スペースを除去し、大文字に統一
  return String(name).replace(/\s+/g, '').toUpperCase();
}

// 正規化ブランドキー → 表示名のマップ（最初に見つかったものを使用）
var brandDisplayMap_ = {};
var brandNormalizedMap_ = {}; // 元のブランド名 → 正規化キー

function showToast(msg) {
  var t = $('toast');
  t.textContent = String(msg || '');
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2600);
}

// =====================================================
// 顧客認証
// =====================================================

var SESSION_KEY = 'estimate_session';
var MEMBER_DISCOUNT_RATE = 0.10;  // 会員割引10%
var BULK_DISCOUNT_RATE = 0.10;    // 30点以上割引10%

function loadSession_() {
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) { return null; }
}

function saveSession_(sessionId, customer) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: sessionId, customer: customer }));
  } catch (e) {}
}

function clearSession_() {
  try { localStorage.removeItem(SESSION_KEY); } catch (e) {}
  state.sessionId = null;
  state.customer = null;
}

function updateAuthUi_() {
  var area = $('authArea');
  if (!area) return;

  if (state.customer) {
    area.innerHTML = '<div class="authUser">' +
      '<span class="authUserName">' + escapeHtml_(state.customer.companyName || state.customer.email) + '</span>' +
      '<span class="authDiscount">10%OFF</span>' +
      '</div>' +
      '<button class="authBtn logout" id="logoutBtn" type="button">ログアウト</button>';

    var logoutBtn = $('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() {
        doLogout_();
      });
    }
  } else {
    area.innerHTML = '<button class="authBtn" id="openAuthBtn" type="button">ログイン / 新規登録</button>';
    var openAuthBtn = $('openAuthBtn');
    if (openAuthBtn) {
      openAuthBtn.addEventListener('click', function() {
        openAuthModal_('login');
      });
    }
  }
}

function openAuthModal_(mode) {
  var modal = $('authModal');
  if (!modal) return;

  if (mode === 'register') {
    $('authModalTitle').textContent = '新規登録';
    $('loginForm').style.display = 'none';
    $('registerForm').style.display = '';
  } else {
    $('authModalTitle').textContent = 'ログイン';
    $('loginForm').style.display = '';
    $('registerForm').style.display = 'none';
  }

  openModal(modal);
}

function doLogin_() {
  var email = ($('loginEmail').value || '').trim();
  var password = $('loginPassword').value || '';

  if (!email || !password) {
    showToast('メールアドレスとパスワードを入力してください');
    return;
  }

  setSending_(true, 'ログイン中...');

  runApi('apiLoginCustomer', state.userKey, { email: email, password: password })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('ログインしました');
        // 割引を反映
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || 'ログインに失敗しました');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('ログインに失敗しました');
    });
}

function doRegister_() {
  var email = ($('regEmail').value || '').trim();
  var password = $('regPassword').value || '';
  var companyName = ($('regCompanyName').value || '').trim();
  var phone = ($('regPhone').value || '').trim();
  var postal = ($('regPostal').value || '').trim();
  var address = ($('regAddress').value || '').trim();
  var newsletter = $('regNewsletter').checked;

  if (!email || !email.includes('@')) {
    showToast('有効なメールアドレスを入力してください');
    return;
  }
  if (!password || password.length < 6) {
    showToast('パスワードは6文字以上で入力してください');
    return;
  }
  if (!companyName) {
    showToast('会社名/氏名は必須です');
    return;
  }

  setSending_(true, '登録中...');

  runApi('apiRegisterCustomer', state.userKey, {
    email: email,
    password: password,
    companyName: companyName,
    phone: phone,
    postal: postal,
    address: address,
    newsletter: newsletter
  })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('登録が完了しました！10%割引が適用されます');
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || '登録に失敗しました');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('登録に失敗しました');
    });
}

function doLogout_() {
  var sessionId = state.sessionId;
  clearSession_();
  updateAuthUi_();
  updateCartPrice();
  if ($('cartModal').classList.contains('open')) renderCartModal_();
  showToast('ログアウトしました');

  if (sessionId) {
    runApi('apiLogoutCustomer', state.userKey, { sessionId: sessionId }).catch(function() {});
  }
}

function validateSession_() {
  var saved = loadSession_();
  if (!saved || !saved.sessionId) return;

  runApi('apiValidateSession', state.userKey, { sessionId: saved.sessionId })
    .then(function(res) {
      if (res.ok && res.data && res.data.customer) {
        state.sessionId = saved.sessionId;
        state.customer = res.data.customer;
        updateAuthUi_();
        updateCartPrice();
      } else {
        clearSession_();
      }
    })
    .catch(function() {
      // ネットワークエラー時は保存されたデータを一旦使用
      state.sessionId = saved.sessionId;
      state.customer = saved.customer;
      updateAuthUi_();
    });
}

function setupAuthUi_() {
  // ログインボタン
  var openAuthBtn = $('openAuthBtn');
  if (openAuthBtn) {
    openAuthBtn.addEventListener('click', function() {
      openAuthModal_('login');
    });
  }

  // モーダル閉じる
  var authCloseBtn = $('authCloseBtn');
  if (authCloseBtn) {
    authCloseBtn.addEventListener('click', function() {
      closeModal($('authModal'));
    });
  }

  // ログインボタン
  var loginBtn = $('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', doLogin_);
  }

  // 登録ボタン
  var registerBtn = $('registerBtn');
  if (registerBtn) {
    registerBtn.addEventListener('click', doRegister_);
  }

  // フォーム切り替え
  var showRegisterLink = $('showRegisterLink');
  if (showRegisterLink) {
    showRegisterLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  var showLoginLink = $('showLoginLink');
  if (showLoginLink) {
    showLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }
}

function setSending_(on, text) {
  var ov = $('sendingOverlay');
  var tx = $('sendingText');
  if (tx) tx.textContent = String(text || '依頼送信中...');
  if (!ov) return;
  if (on) { ov.classList.add('on'); document.body.style.overflow = 'hidden'; }
  else { ov.classList.remove('on'); document.body.style.overflow = ''; }
}

function loadUserKey() {
  var k = localStorage.getItem('estimate_userKey');
  if (k) return k;
  var nk = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem('estimate_userKey', nk);
  return nk;
}

function loadCartStorage() {
  try {
    var raw = localStorage.getItem('estimate_cart_v2');
    if (!raw) return { ids: [], itemsById: {} };
    var j = JSON.parse(raw);
    return { ids: Array.isArray(j.ids) ? j.ids : [], itemsById: j.itemsById || {} };
  } catch (e) { return { ids: [], itemsById: {} }; }
}

function saveCartStorage() {
  try { localStorage.setItem('estimate_cart_v2', JSON.stringify({ ids: state.cart.ids || [], itemsById: state.cart.itemsById || {} })); } catch (e) {}
}

function openModal(modal) { $('overlay').classList.add('open'); modal.classList.add('open'); }
function closeModal(modal) { modal.classList.remove('open'); if (!document.querySelector('.modal.open')) $('overlay').classList.remove('open'); }
function closeAllModals() { document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); }); $('overlay').classList.remove('open'); }

function convertDriveImageUrl(url) {
  if (!url) return '';
  var m = url.match(/(?:id=|\/d\/)([A-Za-z0-9_-]{10,})/);
  if (m && m[1]) return 'https://lh3.googleusercontent.com/d/' + m[1];
  return url;
}

function normalizeStatus_(s) { return String(s || '').trim(); }
function statusKind_(s) {
  var t = normalizeStatus_(s);
  if (!t) return 'available';
  if (t.indexOf('依頼中') !== -1) return 'open';
  if (t.indexOf('確保中') !== -1) return 'hold';
  if (t.indexOf('在庫') !== -1) return 'available';
  return 'available';
}

function getMeasureOptValue_() { return 'with'; }
function setMeasureOptValue_(v) {}
function loadMeasureOpt_() { return 'with'; }
function saveMeasureOpt_() {}

// =====================================================
// GAS API呼び出し（GASモード / スタンドアロンモード自動判定）
// =====================================================

// ★ スタンドアロン（Cloudflare Pages等）で使う場合はここにGAS Web App URLを設定
var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxNZRfqvh7p7RTy27I-I7HCkb7E3FIZMr6SHeGPf5vP4ngrqCSUB0kvgy-hhptM45J1BQ/exec';

var IS_STANDALONE = (typeof google === 'undefined' || !google.script);

// reCAPTCHA v3 サイトキー（★ Google reCAPTCHA管理画面で取得して設定）
var RECAPTCHA_SITE_KEY = '6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1';
var ADMIN_KEY = (new URLSearchParams(window.location.search)).get('admin') || '';

function getRecaptchaToken_() {
  if (typeof grecaptcha === 'undefined' || !RECAPTCHA_SITE_KEY || RECAPTCHA_SITE_KEY.indexOf('RECAPTCHA') !== -1) {
    console.warn('reCAPTCHA not available: grecaptcha=' + (typeof grecaptcha) + ' siteKey=' + !!RECAPTCHA_SITE_KEY);
    return Promise.resolve('');
  }
  try {
    return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }).catch(function(e) {
      console.warn('reCAPTCHA execute failed:', e);
      return '';
    });
  } catch (e) {
    console.warn('reCAPTCHA execute error:', e);
    return Promise.resolve('');
  }
}

function runApi(fn, _extra) {
  var args = Array.prototype.slice.call(arguments, 1);
  var extra = {};
  // 最後の引数が _runApiExtra_ なら取り出す
  if (args.length > 0 && args[args.length - 1] && args[args.length - 1]._runApiExtra_) {
    extra = args.pop();
  }

  if (IS_STANDALONE) {
    var payload = { action: fn, args: args };
    if ('recaptchaToken' in extra) payload.recaptchaToken = extra.recaptchaToken;
    if (ADMIN_KEY) payload.adminKey = ADMIN_KEY;
    return fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      if (data && data.ok === false) throw new Error(data.message || 'APIエラー');
      return data;
    });
  }

  return new Promise(function(resolve, reject) {
    var done = false;
    var timer = setTimeout(function() {
      if (done) return;
      done = true;
      reject(new Error('タイムアウト'));
    }, 30000);

    try {
      var runner = google.script.run
        .withSuccessHandler(function(res) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve(res);
        })
        .withFailureHandler(function(err) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          reject(err);
        });

      runner[fn].apply(runner, args);
    } catch (e) {
      if (done) return;
      done = true;
      clearTimeout(timer);
      reject(e);
    }
  });
}

// =====================================================
// データ読み込み（キャッシュから高速取得）
// =====================================================

var PRODUCT_CACHE_KEY = 'estimate_products_cache';
var PRODUCT_CACHE_TTL = 5 * 60 * 1000; // 5分

function saveProductCache_(data) {
  try {
    var cache = { ts: Date.now(), data: data };
    localStorage.setItem(PRODUCT_CACHE_KEY, JSON.stringify(cache));
  } catch (e) { console.warn('キャッシュ保存失敗:', e); }
}

function loadProductCache_() {
  try {
    var raw = localStorage.getItem(PRODUCT_CACHE_KEY);
    if (!raw) return null;
    var cache = JSON.parse(raw);
    // 5分以内のキャッシュなら使用
    if (cache && cache.ts && (Date.now() - cache.ts < PRODUCT_CACHE_TTL) && cache.data) {
      return cache.data;
    }
    return cache && cache.data ? { data: cache.data, stale: true } : null;
  } catch (e) { return null; }
}

function loadProductData() {
  if (IS_STANDALONE) {
    return runApi('apiGetCachedProducts').then(function(res) {
      if (res && res.ok && res.data) {
        console.log('データ読み込み完了:', res.data.totalCount + '件');
        saveProductCache_(res.data);
        return res.data;
      }
      throw new Error(res && res.message ? res.message : 'データ取得に失敗');
    });
  }

  return new Promise(function(resolve, reject) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res && res.ok && res.data) {
          console.log('データ読み込み完了:', res.data.totalCount + '件');
          saveProductCache_(res.data);
          resolve(res.data);
        } else {
          reject(new Error(res && res.message ? res.message : 'データ取得に失敗'));
        }
      })
      .withFailureHandler(function(err) {
        reject(err);
      })
      .apiGetCachedProducts();
  });
}

// =====================================================
// フィルタ・ソート（クライアント側で即時処理）
// =====================================================

function applyFilters_() {
  var f = state.query.filters;
  var products = state.allProducts.slice();

  if (f.brand && f.brand.length > 0) {
    products = products.filter(function(p) {
      var normalizedBrand = normalizeBrand_(p.brand);
      return f.brand.indexOf(normalizedBrand) !== -1;
    });
  }
  if (f.category && f.category.length > 0) {
    products = products.filter(function(p) { return f.category.indexOf(p.category) !== -1; });
  }
  if (f.state && f.state.length > 0) {
    products = products.filter(function(p) { return f.state.indexOf(p.state) !== -1; });
  }
  if (f.gender && f.gender.length > 0) {
    products = products.filter(function(p) { return f.gender.indexOf(p.gender) !== -1; });
  }
  if (f.size && f.size.length > 0) {
    products = products.filter(function(p) { return f.size.indexOf(p.size) !== -1; });
  }

  return products;
}

function applySort_(products) {
  var s = state.query.sort;
  var sorted = products.slice();
  
  if (s.key === 'default') return sorted;
  
  sorted.sort(function(a, b) {
    var va, vb;
    switch (s.key) {
      case 'price': va = Number(a.price) || 0; vb = Number(b.price) || 0; break;
      case 'brand': va = String(a.brand || ''); vb = String(b.brand || ''); break;
      case 'category': va = String(a.category || ''); vb = String(b.category || ''); break;
      default: return 0;
    }
    if (typeof va === 'string') {
      var cmp = va.localeCompare(vb, 'ja');
      return s.dir === 'desc' ? -cmp : cmp;
    }
    return s.dir === 'desc' ? (vb - va) : (va - vb);
  });
  
  return sorted;
}

function filterAndRender(scrollTop) {
  var filtered = applyFilters_();
  filtered = applySort_(filtered);
  state.filteredProducts = filtered;
  
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var totalPages = Math.ceil(filtered.length / pageSize) || 1;
  
  if (page > totalPages) { page = totalPages; state.query.page = page; }
  
  var start = (page - 1) * pageSize;
  var pageItems = filtered.slice(start, start + pageSize);
  
  updateTotalCountBadge_(filtered.length);
  renderGrid_(pageItems);
  renderPager_(totalPages, page);
  
  if (scrollTop) window.scrollTo({ top: 0, behavior: 'auto' });
  
  pollStatusNow_();
}

// =====================================================
// 確保状態リアルタイム取得
// =====================================================

function pollStatusNow_() {
  if (state.timers.statusPoll) { clearTimeout(state.timers.statusPoll); state.timers.statusPoll = null; }
  
  var ids = [];
  var pageItems = getCurrentPageItems_();
  for (var i = 0; i < pageItems.length; i++) {
    if (pageItems[i] && pageItems[i].managedId) ids.push(pageItems[i].managedId);
  }
  for (var j = 0; j < state.cart.ids.length; j++) {
    if (ids.indexOf(state.cart.ids[j]) === -1) ids.push(state.cart.ids[j]);
  }
  
  if (ids.length === 0) return;
  
  runApi('apiGetStatusDigest', state.userKey, ids)
    .then(function(res) {
      if (res && res.ok && res.map) {
        state.cart.digest = res.map;
        for (var id in state.ui.cardEls) updateCardUi_(id);
      }
    })
    .catch(function(e) { console.log('ステータス取得エラー:', e); });
  
  state.timers.statusPoll = setTimeout(pollStatusNow_, 10000);
}

function getCurrentPageItems_() {
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var start = (page - 1) * pageSize;
  return state.filteredProducts.slice(start, start + pageSize);
}

// =====================================================
// 表示系
// =====================================================

function updateTotalCountBadge_(total) {
  var el = $('totalCountBadge');
  if (el) el.textContent = total ? ('商品点数：' + total + '点') : '';
}

function renderLoadingGrid_() {
  var g = $('grid'); g.innerHTML = '';
  for (var i = 0; i < 8; i++) {
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'LOADING';
    var body = document.createElement('div'); body.className = 'cardbody';
    var line = document.createElement('div'); line.className = 'meta'; line.textContent = '読み込み中...';
    body.appendChild(line); card.appendChild(thumb); card.appendChild(body); g.appendChild(card);
  }
}

function setSelectOptions(select, list, placeholder) {
  select.innerHTML = '';
  var op0 = document.createElement('option'); op0.value = ''; op0.textContent = placeholder; select.appendChild(op0);
  for (var i = 0; i < list.length; i++) {
    var op = document.createElement('option'); op.value = String(list[i]); op.textContent = String(list[i]); select.appendChild(op);
  }
}

// マルチセレクトフィルター
var multiSelectState = { category: [], state: [], gender: [], size: [] };

function buildMultiSelectDropdown(filterKey, options) {
  var dropdown = $('f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Dropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var val = String(options[i]);
    var item = document.createElement('div');
    item.className = 'multiSelectItem';
    item.dataset.value = val;
    if (multiSelectState[filterKey].indexOf(val) !== -1) item.classList.add('selected');

    var checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    var span = document.createElement('span');
    span.textContent = val;

    item.appendChild(checkIcon);
    item.appendChild(span);

    item.addEventListener('click', (function(key, v, el) {
      return function(e) {
        e.stopPropagation();
        var isSelected = el.classList.contains('selected');
        if (isSelected) {
          el.classList.remove('selected');
          var idx = multiSelectState[key].indexOf(v);
          if (idx !== -1) multiSelectState[key].splice(idx, 1);
        } else {
          el.classList.add('selected');
          if (multiSelectState[key].indexOf(v) === -1) multiSelectState[key].push(v);
        }
        state.query.filters[key] = multiSelectState[key].slice();
        updateMultiSelectBtn(key);
        filterAndRender(true);
      };
    })(filterKey, val, item);
    dropdown.appendChild(item);
  }
}

function updateMultiSelectBtn(filterKey) {
  var btnId = 'f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Btn';
  var btn = $(btnId);
  if (!btn) return;
  var count = multiSelectState[filterKey].length;
  var countSpan = btn.querySelector('.filterCount');
  if (countSpan) countSpan.textContent = count > 0 ? count : '';
}

function setupMultiSelectFilters() {
  var filters = ['category', 'state', 'gender', 'size'];
  var labels = { category: 'カテゴリ', state: '状態', gender: '性別', size: 'サイズ' };

  filters.forEach(function(key) {
    var btnId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Btn';
    var dropdownId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown';
    var btn = $(btnId);
    var dropdown = $(dropdownId);
    if (!btn || !dropdown) return;

    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      // 他のドロップダウンを閉じる
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        if (d.id !== dropdownId) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
    });
  });

  // 外側クリックでドロップダウンを閉じる
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.multiSelectField')) {
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        d.classList.remove('open');
      });
    }
  });
}

function resetMultiSelectFilters() {
  multiSelectState = { category: [], state: [], gender: [], size: [] };
  state.query.filters.category = [];
  state.query.filters.state = [];
  state.query.filters.gender = [];
  state.query.filters.size = [];
  ['category', 'state', 'gender', 'size'].forEach(function(key) {
    updateMultiSelectBtn(key);
    var dropdown = $('f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown');
    if (dropdown) {
      dropdown.querySelectorAll('.multiSelectItem').forEach(function(item) {
        item.classList.remove('selected');
      });
    }
  });
}

function setSortOptions(select, sortDefs) {
  select.innerHTML = '';
  for (var i = 0; i < sortDefs.length; i++) {
    var s = sortDefs[i];
    var op = document.createElement('option'); op.value = s.key; op.textContent = s.label; select.appendChild(op);
  }
}

function setStatusBadge_(el, status) {
  if (!el) return;
  var t = normalizeStatus_(status);
  var k = statusKind_(t);
  el.className = 'badge';
  if (k === 'available') el.className = 'badge ok';
  else if (k === 'open') el.className = 'badge lock';
  else if (k === 'hold') el.className = 'badge warn';
  el.textContent = t || '';
}

function effectiveStatusFor_(id, selected, itemStatus) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  var ds = d && d.status ? normalizeStatus_(d.status) : '';
  if (selected) {
    if (d) {
      var k = statusKind_(ds);
      if (k === 'open') return ds || '依頼中';
      if (k === 'hold' && d.heldByOther) return ds || '確保中';
    }
    return '確保中';
  }
  return ds || normalizeStatus_(itemStatus);
}

function effectiveHeldByOtherFor_(id) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  return !!(d && d.heldByOther);
}

function computeDisabledForCard_(it, id) {
  var selected = state.cart.ids.indexOf(id) !== -1;
  var effectiveStatus = effectiveStatusFor_(id, selected, it.status);
  var effectiveHeldByOther = effectiveHeldByOtherFor_(id);
  var disabled = (!it.selectable) || (statusKind_(effectiveStatus) === 'open') || (statusKind_(effectiveStatus) === 'hold' && effectiveHeldByOther);
  return { selected: selected, effectiveStatus: effectiveStatus, effectiveHeldByOther: effectiveHeldByOther, disabled: disabled };
}

function applyBtnUi_(btn, it, id) {
  if (!btn || !it) return;
  var r = computeDisabledForCard_(it, id);
  if (r.disabled) {
    btn.className = 'selectBtn disabled'; btn.disabled = true;
    btn.textContent = statusKind_(r.effectiveStatus) === 'open' ? '依頼中（選択不可）' : '確保中（選択不可）';
    return;
  }
  if (r.selected) { btn.className = 'selectBtn'; btn.disabled = false; btn.textContent = '選択中（解除）'; return; }
  btn.className = 'selectBtn off'; btn.disabled = false; btn.textContent = '見積もりへ追加';
}

function updateCardUi_(id) {
  var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
  if (!rec) return;
  var it = rec.item;
  if (!it) return;
  var r = computeDisabledForCard_(it, id);
  if (rec.bStatus) setStatusBadge_(rec.bStatus, r.effectiveStatus);
  if (rec.btn) applyBtnUi_(rec.btn, it, id);
}

function upsertCartItem_(it) {
  if (!it || !it.managedId) return;
  state.cart.itemsById[it.managedId] = {
    managedId: it.managedId, noLabel: it.noLabel, imageUrl: it.imageUrl, brand: it.brand,
    size: it.size, gender: it.gender, category: it.category, color: it.color, state: it.state,
    price: Number(it.price || 0), measurements: it.measurements || {}, defectDetail: it.defectDetail || ''
  };
}

function renderGrid_(items) {
  var g = $('grid'); g.innerHTML = ''; state.ui.cardEls = {};
  
  if (!items || items.length === 0) {
    var msg = document.createElement('div'); msg.textContent = '該当する商品がありません'; msg.style.padding = '12px'; g.appendChild(msg); return;
  }
  
  var frag = document.createDocumentFragment();
  
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    if (!it) continue;
    upsertCartItem_(it);
    var id = it.managedId;
    var r = computeDisabledForCard_(it, id);
    
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb';
    var imgEl = null;
    
    if (it.imageUrl) {
      var img = document.createElement('img');
      var fixedUrl = convertDriveImageUrl(it.imageUrl);
      img.src = fixedUrl; img.alt = it.noLabel || id; img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
      img.className = 'product-image-clickable'; img.style.cursor = 'zoom-in';
      (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, fixedUrl);
      imgEl = img; thumb.appendChild(img);
    } else { thumb.textContent = 'NO IMAGE'; }
    card.appendChild(thumb);
    
    var body = document.createElement('div'); body.className = 'cardbody';
    var row1 = document.createElement('div'); row1.className = 'row1';
    var leftTitle = document.createElement('div'); leftTitle.className = 'leftTitle'; leftTitle.style.cursor = 'pointer';
    var spanNo = document.createElement('span'); spanNo.className = 'noText'; spanNo.textContent = it.noLabel ? it.noLabel : ('No. ' + id);
    var spanBrand = document.createElement('div'); spanBrand.className = 'brandText'; spanBrand.textContent = it.brand || '';
    spanBrand.style.cursor = 'pointer';
    leftTitle.appendChild(spanNo);
    (function(mid, iurl) { leftTitle.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '');
    (function(mid, iurl) { spanBrand.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '');
    var price = document.createElement('div'); price.className = 'price'; price.textContent = yen(it.price);
    row1.appendChild(leftTitle); row1.appendChild(price); body.appendChild(row1);
    if (spanBrand.textContent) body.appendChild(spanBrand);
    
    // 傷汚れ詳細の有無を表示（カードの高さを揃えるため常にスペースを確保）
    var defectLine = document.createElement('div'); defectLine.className = 'defectLine';
    if (it.defectDetail && it.defectDetail.trim()) {
      defectLine.textContent = '詳細事項あり';
      defectLine.classList.add('hasDefect');
    } else {
      defectLine.innerHTML = '&nbsp;'; // 空白でも高さを確保
    }
    body.appendChild(defectLine);

    var badges = document.createElement('div'); badges.className = 'badges';
    var bState = document.createElement('div'); bState.className = 'badge'; bState.textContent = it.state || ''; badges.appendChild(bState);
    var bStatus = document.createElement('div'); setStatusBadge_(bStatus, r.effectiveStatus); badges.appendChild(bStatus); body.appendChild(badges);
    
    var btn = document.createElement('button'); btn.type = 'button'; applyBtnUi_(btn, it, id);
    (function(itemRef, idRef) { btn.addEventListener('click', function() { if (computeDisabledForCard_(itemRef, idRef).disabled) return; toggleCartOptimistic_(idRef); }); })(it, id);
    
    var actions = document.createElement('div'); actions.className = 'actions'; actions.appendChild(btn); body.appendChild(actions);
    card.appendChild(body); frag.appendChild(card);
    state.ui.cardEls[id] = { bStatus: bStatus, btn: btn, item: it, img: imgEl };
  }
  
  g.appendChild(frag);
}

function renderPager_(totalPages, currentPage) {
  var p = $('pager'); p.innerHTML = '';
  if (totalPages <= 1) return;
  var maxButtons = 9;
  var start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  var end = Math.min(totalPages, start + maxButtons - 1);
  start = Math.max(1, end - maxButtons + 1);
  for (var i = start; i <= end; i++) {
    var b = document.createElement('button');
    b.className = 'pageBtn' + (i === currentPage ? ' active' : '');
    b.textContent = String(i);
    (function(pn) { b.addEventListener('click', function() { state.query.page = pn; filterAndRender(true); }); })(i);
    p.appendChild(b);
  }
}

// =====================================================
// カート
// =====================================================

function updateCartCount() {
  $('cartCount').textContent = String((state.cart.ids || []).length);
  updateCartPrice();
}

function updateCartPrice() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var count = ids.length;
  // 割引を累積（会員10% + 30点以上10% = 最大20%）
  var discountRate = 0;
  if (count >= 30) discountRate += BULK_DISCOUNT_RATE;
  if (state.customer) discountRate += MEMBER_DISCOUNT_RATE;
  if (discountRate > 0) {
    var discounted = Math.round(sum * (1 - discountRate));
    $('cartTotal').innerHTML = '<span class="price-old">' + yen(sum) + '</span> → <span class="price-new">' + yen(discounted) + '</span>';
  } else { $('cartTotal').textContent = yen(sum); }
}

function toggleCartOptimistic_(id) {
  var idx = state.cart.ids.indexOf(id);
  if (idx !== -1) { state.cart.ids.splice(idx, 1); } else { state.cart.ids.push(id); }
  saveCartStorage(); updateCartCount(); updateCardUi_(id);
  
  runApi('apiSyncHolds', state.userKey, state.cart.ids.slice())
    .then(function(res) {
      if (res && res.failed && res.failed.length) {
        for (var i = 0; i < res.failed.length; i++) {
          var fid = res.failed[i].id;
          var j = state.cart.ids.indexOf(fid);
          if (j !== -1) state.cart.ids.splice(j, 1);
          updateCardUi_(fid);
        }
        updateCartCount(); saveCartStorage();
        var reasons = res.failed.map(function(f) { return f.reason; }).filter(function(v, i, a) { return a.indexOf(v) === i; });
        showToast(reasons.join('・') + 'の商品があります');
      }
    })
    .catch(function(e) { console.log('同期エラー:', e); });
  
  pollStatusNow_();
}

// =====================================================
// 詳細モーダル
// =====================================================

function openDetailModal(managedId, imageUrl) {
  var modal = document.getElementById('detailModal');
  var body = document.getElementById('detailModalBody');
  if (!modal || !body) return;
  
  var item = null;
  for (var i = 0; i < state.allProducts.length; i++) {
    if (state.allProducts[i] && state.allProducts[i].managedId === managedId) { item = state.allProducts[i]; break; }
  }
  if (!item) item = state.cart.itemsById ? state.cart.itemsById[managedId] : null;
  
  if (item) { renderDetailModalLocal(item, imageUrl); }
  else { body.innerHTML = '<div class="detail-loading">商品情報が見つかりません</div>'; }
  
  modal.classList.add('active');
}

function renderDetailModalLocal(item, imageUrl) {
  var body = document.getElementById('detailModalBody');
  if (!body) return;
  
  var basicItems = [];
  if (item.category) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">カテゴリ:</span> ' + escapeHtml_(item.category) + '</span>');
  if (item.size) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">サイズ:</span> ' + escapeHtml_(item.size) + '</span>');
  if (item.gender) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">性別:</span> ' + escapeHtml_(item.gender) + '</span>');
  if (item.color) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">カラー:</span> ' + escapeHtml_(item.color) + '</span>');
  if (item.state) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">状態:</span> ' + escapeHtml_(item.state) + '</span>');
  if (item.price) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">価格:</span> ' + yen(item.price) + '</span>');
  
  var basicInfoHtml = basicItems.length > 0 ?
    '<div class="detail-section"><div class="detail-section-title">商品情報</div><div class="detail-info-grid">' + basicItems.join('') + '</div></div>' : '';
  
  var defectHtml = '';
  if (item.defectDetail) {
    var escaped = escapeHtml_(item.defectDetail).replace(/\n/g, '<br>');
    defectHtml = '<div class="detail-section"><div class="detail-section-title">傷・汚れ詳細</div><div class="detail-defect">' + escaped + '</div></div>';
  }
  
  var measurementsHtml = '';
  if (item.measurements && Object.keys(item.measurements).length > 0) {
    var measureOrder = ['着丈', '肩幅', '身幅', '袖丈', '桁丈', '総丈', 'ウエスト', '股上', '股下', 'ワタリ', '裾幅', 'ヒップ'];
    var measureItems = [];
    for (var i = 0; i < measureOrder.length; i++) {
      var label = measureOrder[i];
      if (item.measurements[label] !== undefined && item.measurements[label] !== null) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + label + '</div><div class="measurement-value">' + item.measurements[label] + ' cm</div></div>');
      }
    }
    for (var lbl in item.measurements) {
      if (measureOrder.indexOf(lbl) === -1) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + lbl + '</div><div class="measurement-value">' + item.measurements[lbl] + ' cm</div></div>');
      }
    }
    if (measureItems.length > 0) {
      measurementsHtml = '<div class="detail-section"><div class="detail-section-title">採寸データ</div><div class="measurement-grid">' + measureItems.join('') + '</div></div>';
    }
  }
  
  var inCart = state.cart.ids && state.cart.ids.indexOf(item.managedId) !== -1;
  var btnText = inCart ? '✓ カートに入っています' : 'カートに追加';
  var btnDisabled = inCart ? 'disabled' : '';
  var safeImageUrl = String(imageUrl || '').replace(/"/g, '&quot;');
  var safeBrand = escapeHtml_(item.brand || '');
  var safeManagedId = escapeHtml_(item.managedId || '');
  var noInfo = (!basicInfoHtml && !defectHtml && !measurementsHtml) ? '<div class="detail-loading" style="color:#999;">追加情報はありません</div>' : '';
  
  body.innerHTML =
    '<img class="detail-modal-image" src="' + safeImageUrl + '" alt="' + safeBrand + '" onerror="this.style.display=\'none\'">' +
    '<div class="detail-modal-content"><div class="detail-modal-title">' + safeBrand + ' - ' + safeManagedId + '</div>' +
    basicInfoHtml + defectHtml + measurementsHtml + noInfo + '</div>' +
    '<div class="detail-modal-footer"><button class="detail-add-btn" ' + btnDisabled + ' onclick="addToCartFromModal(\'' + safeManagedId + '\')">' + btnText + '</button></div>';
}

// 詳細モーダルを閉じた後の戻り先
var detailReturnTo_ = null;

function closeDetailModal() {
  var modal = document.getElementById('detailModal');
  if (modal) modal.classList.remove('active');
  if (detailReturnTo_ === 'cart') {
    detailReturnTo_ = null;
    renderCartModal_(); openModal($('cartModal'));
  }
  detailReturnTo_ = null;
}

function addToCartFromModal(managedId) {
  var idx = state.cart.ids.indexOf(managedId);
  if (idx === -1) toggleCartOptimistic_(managedId);
  closeDetailModal();
}

function setupDetailModalEvents_() {
  var modal = document.getElementById('detailModal');
  if (modal) { modal.addEventListener('click', function(e) { if (e.target === modal) closeDetailModal(); }); }
}

// =====================================================
// ブランド選択
// =====================================================

function brandCount_() { return Object.keys(state.brandUi.selected || {}).length; }

function updateBrandBtn_() {
  var n = brandCount_();
  if ($('brandBtnText')) $('brandBtnText').textContent = 'ブランド';
  if ($('brandBtnSub')) $('brandBtnSub').textContent = n ? (n + '件選択') : '未選択';
  if ($('brandHint')) $('brandHint').textContent = n ? ('選択中：' + n + '件') : '複数選択して「適用」で検索します';
}

// 日本語ブランド名エイリアス（検索用）
var brandAliases_ = {
  'nike': ['ナイキ', 'ないき'],
  'adidas': ['アディダス', 'あでぃだす'],
  'puma': ['プーマ', 'ぷーま'],
  'gucci': ['グッチ', 'ぐっち'],
  'chanel': ['シャネル', 'しゃねる'],
  'louis vuitton': ['ルイヴィトン', 'るいびとん', 'ルイ・ヴィトン'],
  'hermes': ['エルメス', 'えるめす'],
  'prada': ['プラダ', 'ぷらだ'],
  'burberry': ['バーバリー', 'ばーばりー'],
  'coach': ['コーチ', 'こーち'],
  'michael kors': ['マイケルコース', 'まいけるこーす'],
  'ralph lauren': ['ラルフローレン', 'らるふろーれん'],
  'uniqlo': ['ユニクロ', 'ゆにくろ'],
  'zara': ['ザラ', 'ざら'],
  'gap': ['ギャップ', 'ぎゃっぷ'],
  'h&m': ['エイチアンドエム', 'えいちあんどえむ'],
  'supreme': ['シュプリーム', 'しゅぷりーむ'],
  'stussy': ['ステューシー', 'すてゅーしー'],
  'north face': ['ノースフェイス', 'のーすふぇいす'],
  'patagonia': ['パタゴニア', 'ぱたごにあ'],
  'champion': ['チャンピオン', 'ちゃんぴおん'],
  'levis': ['リーバイス', 'りーばいす'],
  'tommy hilfiger': ['トミーヒルフィガー', 'とみーひるふぃがー'],
  'calvin klein': ['カルバンクライン', 'かるばんくらいん'],
  'diesel': ['ディーゼル', 'でぃーぜる'],
  'jill stuart': ['ジルスチュアート', 'じるすちゅあーと'],
  'marc jacobs': ['マークジェイコブス', 'まーくじぇいこぶす'],
  'versace': ['ヴェルサーチ', 'べるさーち'],
  'armani': ['アルマーニ', 'あるまーに'],
  'fendi': ['フェンディ', 'ふぇんでぃ'],
  'balenciaga': ['バレンシアガ', 'ばれんしあが'],
  'celine': ['セリーヌ', 'せりーぬ'],
  'dior': ['ディオール', 'でぃおーる'],
  'ysl': ['イヴサンローラン', 'いぶさんろーらん'],
  'comme des garcons': ['コムデギャルソン', 'こむでぎゃるそん'],
  'issey miyake': ['イッセイミヤケ', 'いっせいみやけ'],
  'yohji yamamoto': ['ヨウジヤマモト', 'ようじやまもと']
};

// 検索キーワードからブランド名候補を取得
function getBrandSearchKeys_(brandKey) {
  var keys = [brandKey.toLowerCase()];
  // エイリアスを追加
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      keys = keys.concat(brandAliases_[eng].map(function(a) { return a.toLowerCase(); }));
    }
  }
  return keys;
}

// 検索クエリがブランドにマッチするか
function matchesBrandSearch_(brandKey, query) {
  if (!query) return true;
  var q = query.toLowerCase();
  // ブランド名自体にマッチ
  if (brandKey.toLowerCase().indexOf(q) !== -1) return true;
  // エイリアスからマッチ
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      for (var i = 0; i < brandAliases_[eng].length; i++) {
        if (brandAliases_[eng][i].toLowerCase().indexOf(q) !== -1) return true;
      }
    }
    // 逆方向: 日本語入力で英語ブランドを検索
    for (var j = 0; j < brandAliases_[eng].length; j++) {
      if (q.indexOf(brandAliases_[eng][j].toLowerCase()) !== -1 || brandAliases_[eng][j].toLowerCase().indexOf(q) !== -1) {
        if (brandKey.toLowerCase().indexOf(eng) !== -1) return true;
      }
    }
  }
  return false;
}

// 頭文字を取得
function getInitialChar_(name) {
  if (!name) return '#';
  var c = name.charAt(0).toUpperCase();
  // 英字
  if (/[A-Z]/.test(c)) return c;
  // 数字
  if (/[0-9]/.test(c)) return '#';
  // ひらがな・カタカナの行判定
  var hiraOrder = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
  var kataOrder = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
  var idx = hiraOrder.indexOf(c);
  if (idx === -1) idx = kataOrder.indexOf(c);
  if (idx !== -1) {
    var row = Math.floor(idx / 5);
    var rowHeads = ['あ', 'か', 'さ', 'た', 'な', 'は', 'ま', 'や', 'ら', 'わ'];
    return rowHeads[Math.min(row, rowHeads.length - 1)] || 'あ';
  }
  // 漢字など
  return '他';
}

function buildBrandListOnce_(brands) {
  if (state.brandUi.built) return;
  state.brandUi.built = true;
  state.brandUi.all = Array.isArray(brands) ? brands.slice() : [];
  state.brandUi.selected = {};
  state.brandUi.itemsByKey = {};

  // ブランド名を正規化して統合
  brandDisplayMap_ = {};
  brandNormalizedMap_ = {};
  var normalizedOrder = [];

  for (var i = 0; i < state.brandUi.all.length; i++) {
    var name = String(state.brandUi.all[i] || '').trim();
    if (!name) continue;
    var key = normalizeBrand_(name);
    brandNormalizedMap_[name] = key;
    if (!brandDisplayMap_[key]) {
      brandDisplayMap_[key] = name;
      normalizedOrder.push(key);
    }
  }

  // 頭文字でグループ化
  var groups = {};
  var groupOrder = [];
  for (var i = 0; i < normalizedOrder.length; i++) {
    var key = normalizedOrder[i];
    var displayName = brandDisplayMap_[key];
    var initial = getInitialChar_(displayName);
    if (!groups[initial]) {
      groups[initial] = [];
      groupOrder.push(initial);
    }
    groups[initial].push({ key: key, displayName: displayName });
  }

  // アルファベット順にソート
  groupOrder.sort(function(a, b) {
    var orderA = /[A-Z]/.test(a) ? a.charCodeAt(0) : (a === '#' ? 999 : 1000 + 'あかさたなはまやらわ他'.indexOf(a));
    var orderB = /[A-Z]/.test(b) ? b.charCodeAt(0) : (b === '#' ? 999 : 1000 + 'あかさたなはまやらわ他'.indexOf(b));
    return orderA - orderB;
  });

  // インデックスナビゲーション構築
  var nav = $('brandIndexNav');
  if (nav) {
    nav.innerHTML = '';
    groupOrder.forEach(function(initial) {
      var btn = document.createElement('button');
      btn.className = 'brandIndexBtn';
      btn.textContent = initial;
      btn.dataset.initial = initial;
      btn.addEventListener('click', function() {
        var header = document.querySelector('.brandGroupHeader[data-initial="' + initial + '"]');
        if (header) header.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      nav.appendChild(btn);
    });
  }

  // ブランドリスト構築
  var list = $('brandList');
  list.innerHTML = '';

  groupOrder.forEach(function(initial) {
    // グループヘッダー
    var header = document.createElement('div');
    header.className = 'brandGroupHeader';
    header.dataset.initial = initial;
    header.textContent = initial;
    list.appendChild(header);

    // グループ内ブランド
    groups[initial].forEach(function(brand) {
      var row = document.createElement('div');
      row.className = 'brandItem';
      row.dataset.name = brand.key;
      row.dataset.key = brand.key.toLowerCase();
      row.dataset.initial = initial;

      var checkEl = document.createElement('span');
      checkEl.className = 'brand-check';
      var label = document.createElement('div');
      label.className = 'brandName';
      label.textContent = brand.displayName;

      row.appendChild(checkEl);
      row.appendChild(label);
      state.brandUi.itemsByKey[brand.key] = row;
      list.appendChild(row);
    });
  });

  // クリックイベント
  list.addEventListener('click', function(ev) {
    var item = ev.target.closest ? ev.target.closest('.brandItem') : null;
    if (!item) return;
    var key = String(item.dataset.name || '');
    if (!key) return;

    var isSelected = item.classList.contains('selected');
    if (isSelected) {
      item.classList.remove('selected');
      delete state.brandUi.selected[key];
    } else {
      item.classList.add('selected');
      state.brandUi.selected[key] = true;
    }
    updateBrandBtn_();
  });
}

function filterBrandList_() {
  var q = String($('brandSearch').value || '').trim();
  var list = $('brandList');
  var shown = 0;
  var visibleGroups = {};

  // ブランドアイテムのフィルタリング
  list.querySelectorAll('.brandItem').forEach(function(el) {
    var key = String(el.dataset.key || '');
    var initial = el.dataset.initial;
    var ok = matchesBrandSearch_(key, q);
    el.style.display = ok ? '' : 'none';
    if (ok) {
      shown++;
      visibleGroups[initial] = true;
    }
  });

  // グループヘッダーの表示/非表示
  list.querySelectorAll('.brandGroupHeader').forEach(function(header) {
    var initial = header.dataset.initial;
    header.style.display = visibleGroups[initial] ? '' : 'none';
  });

  // インデックスボタンのハイライト
  document.querySelectorAll('.brandIndexBtn').forEach(function(btn) {
    var initial = btn.dataset.initial;
    btn.classList.toggle('active', !!visibleGroups[initial]);
  });

  if ($('brandHint')) {
    var n = brandCount_();
    $('brandHint').textContent = n ? ('選択中：' + n + '件 / 表示：' + shown + '件') : ('表示：' + shown + '件');
  }
}

// =====================================================
// おすすめ商品
// =====================================================

// おすすめ対象の状態（S, A, AB または同等の日本語表現）
var RECOMMEND_STATES = ['S', 'A', 'AB', '新品', '美品', '良品', '新品同様', '未使用', '未使用に近い'];

function isRecommendableState_(state) {
  if (!state) return false;
  var s = String(state).trim().toUpperCase();
  for (var i = 0; i < RECOMMEND_STATES.length; i++) {
    if (s === RECOMMEND_STATES[i].toUpperCase() || s.indexOf(RECOMMEND_STATES[i].toUpperCase()) !== -1) return true;
  }
  return false;
}

function getRecommendedProducts_(maxCount, excludeIds) {
  if (!state.allProducts || !state.allProducts.length) return [];

  var cartIds = excludeIds || state.cart.ids || [];
  var cartItems = [];
  for (var i = 0; i < cartIds.length; i++) {
    var it = state.cart.itemsById[cartIds[i]];
    if (it) cartItems.push(it);
  }

  // カート内のブランド・カテゴリ・性別・サイズ・価格帯を収集
  var cartBrands = {}, cartCategories = {}, cartGenders = {}, cartSizes = {};
  var priceSum = 0, priceCount = 0;
  for (var i = 0; i < cartItems.length; i++) {
    var ci = cartItems[i];
    if (ci.brand) cartBrands[normalizeBrand_(ci.brand)] = true;
    if (ci.category) cartCategories[ci.category] = true;
    if (ci.gender) cartGenders[ci.gender] = true;
    if (ci.size) cartSizes[ci.size] = true;
    if (ci.price) { priceSum += ci.price; priceCount++; }
  }
  var avgPrice = priceCount > 0 ? (priceSum / priceCount) : 0;

  // フィルタリング＆スコアリング
  var candidates = [];
  for (var i = 0; i < state.allProducts.length; i++) {
    var p = state.allProducts[i];

    // カート内の商品は除外
    if (cartIds.indexOf(p.managedId) !== -1) continue;

    // 状態チェック（S, A, AB等）
    if (!isRecommendableState_(p.state)) continue;

    // 傷汚れ詳細がある場合は除外
    if (p.defectDetail && p.defectDetail.trim()) continue;

    // スコア計算
    var score = 0;
    if (cartBrands[normalizeBrand_(p.brand)]) score += 30;
    if (cartCategories[p.category]) score += 20;
    if (cartGenders[p.gender]) score += 15;
    if (cartSizes[p.size]) score += 10;
    if (avgPrice > 0 && p.price) {
      var priceDiff = Math.abs(p.price - avgPrice) / avgPrice;
      if (priceDiff <= 0.3) score += 5;
    }

    // カートが空の場合は価格が高い順にランダム
    if (cartItems.length === 0) {
      score = p.price || 0;
    }

    candidates.push({ product: p, score: score });
  }

  // スコア降順、同スコアなら価格降順でソート後、ランダム要素追加
  candidates.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return (b.product.price || 0) - (a.product.price || 0);
  });

  // 上位を取得してシャッフル（同スコア帯でランダム性を出す）
  var top = candidates.slice(0, Math.min(maxCount * 3, candidates.length));
  for (var i = top.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = top[i]; top[i] = top[j]; top[j] = temp;
  }

  var result = [];
  for (var i = 0; i < Math.min(maxCount, top.length); i++) {
    result.push(top[i].product);
  }
  return result;
}

function renderRecommendations_(containerId, sectionId, maxCount, isMainScreen) {
  var container = $(containerId);
  var section = $(sectionId);
  if (!container || !section) return;

  var recommendations = getRecommendedProducts_(maxCount || 6, state.cart.ids);

  if (recommendations.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  container.innerHTML = '';

  for (var i = 0; i < recommendations.length; i++) {
    var p = recommendations[i];
    var card = document.createElement('div');
    card.className = 'recommendCard';

    var imgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl) : '';
    var img = document.createElement('img');
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23eee" width="100" height="100"/%3E%3Ctext x="50" y="55" text-anchor="middle" fill="%23999" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = p.noLabel || p.managedId;

    var info = document.createElement('div');
    info.className = 'rcInfo';
    var brand = document.createElement('div');
    brand.className = 'rcBrand';
    brand.textContent = p.brand || '-';
    var price = document.createElement('div');
    price.className = 'rcPrice';
    price.textContent = yen(p.price);
    info.appendChild(brand);
    info.appendChild(price);

    card.appendChild(img);
    card.appendChild(info);

    (function(mid, iurl, mainScreen) {
      card.addEventListener('click', function() {
        if (!mainScreen) closeModal($('cartModal'));
        detailReturnTo_ = mainScreen ? null : 'cart';
        openDetailModal(mid, iurl);
      });
    })(p.managedId, imgUrl, isMainScreen);

    container.appendChild(card);
  }
}

function renderMainRecommendations_() {
  renderRecommendations_('mainRecommendList', 'mainRecommend', 8, true);
}

// =====================================================
// カートモーダル・送信
// =====================================================

function renderCartModal_() {
  $('shippingHint').textContent = state.settings?.shippingEstimateText || '';
  var notes = (state.settings?.notes || []).map(function(x) { return '・' + String(x); });
  var steps = (state.settings?.nextSteps || []).map(function(x) { return '・' + String(x); });
  var parts = [];
  if (notes.length) parts = parts.concat(notes);
  if (steps.length) { if (parts.length) parts.push(''); parts = parts.concat(steps); }
  $('shippingNote').innerHTML = parts.join('<br>');
  
  var listEl = $('cartList'); listEl.innerHTML = '';
  var ids = (state.cart.ids || []).slice();
  var sum = 0;
  
  for (var i = 0; i < ids.length; i++) {
    var id = ids[i];
    var it = state.cart.itemsById[id];
    if (!it) continue;
    var row = document.createElement('div'); row.className = 'cartRow';

    // 画像とテキストを囲むコンテナ
    var info = document.createElement('div'); info.className = 'cartInfo';

    // 商品画像
    var imgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '';
    var img = document.createElement('img'); img.className = 'cartImg';
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"%3E%3Crect fill="%23eee" width="50" height="50"/%3E%3Ctext x="25" y="30" text-anchor="middle" fill="%23999" font-size="10"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = it.noLabel || id;
    (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, imgUrl);

    var left = document.createElement('div'); left.className = 'cartLeft';
    var name = document.createElement('div'); name.className = 'cartName'; name.style.cursor = 'pointer';
    name.textContent = (it.noLabel ? it.noLabel : id) + (it.brand ? (' ' + it.brand) : '');
    (function(mid, iurl) { name.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, imgUrl);
    var sub = document.createElement('div'); sub.className = 'cartSub';
    sub.textContent = [it.category, it.color, it.gender, it.size].filter(Boolean).join(' / ') + ' / ' + yen(it.price);
    left.appendChild(name); left.appendChild(sub);
    info.appendChild(img); info.appendChild(left);

    var btn = document.createElement('button'); btn.className = 'dangerBtn'; btn.type = 'button'; btn.textContent = '削除';
    (function(idRef) {
      btn.addEventListener('click', function() {
        var idx = state.cart.ids.indexOf(idRef);
        if (idx !== -1) state.cart.ids.splice(idx, 1);
        saveCartStorage(); updateCartCount(); updateCardUi_(idRef);
        runApi('apiSyncHolds', state.userKey, state.cart.ids.slice()).catch(function() {});
        renderCartModal_();
      });
    })(id);
    row.appendChild(info); row.appendChild(btn); listEl.appendChild(row);
    sum += Number(it.price || 0);
  }
  
  var count = ids.length;
  $('sumCount').textContent = '合計点数：' + count + '点';
  // 割引を累積（会員10% + 30点以上10% = 最大20%）
  var discountRate = 0;
  var discountLabels = [];
  if (count >= 30) { discountRate += BULK_DISCOUNT_RATE; discountLabels.push('30点以上10%OFF'); }
  if (state.customer) { discountRate += MEMBER_DISCOUNT_RATE; discountLabels.push('会員10%OFF'); }
  var discounted = Math.round(sum * (1 - discountRate));
  var shippingLink = '<a href="https://drive.google.com/file/d/1g7UYUBw3-Y6M5HkSv3mfMe5jEjs795E3/view?usp=sharing" target="_blank">(送料別)</a>';
  var discountLabel = discountLabels.length > 0 ? '（' + discountLabels.join('＋') + '）' : '';
  if (discountRate > 0) {
    $('sumPrice').innerHTML = '合計金額：<span class="price-old">' + yen(sum) + '</span> → <span class="price-new">' + yen(discounted) + '</span>' + discountLabel + shippingLink;
  } else { $('sumPrice').innerHTML = '合計金額：' + yen(discounted) + shippingLink; }
  
  var min = Number(state.settings?.minOrderCount || 10);
  var need = Math.max(0, min - count);
  $('minNotice').textContent = need > 0 ? (min + '点以上で送信できます（あと' + need + '点）') : (min + '点以上OK');
  $('goFormBtn').disabled = (count < min);

  // おすすめ商品を表示
  renderRecommendations_('cartRecommendList', 'cartRecommend', 6);
}

function readForm_() {
  return {
    companyName: $('companyName').value || '', contact: $('contact').value || '',
    postal: $('postal').value || '', address: $('address').value || '',
    phone: $('phone').value || '', note: $('note').value || '', measureOpt: getMeasureOptValue_()
  };
}

function validateForm_(f) {
  if (!f.companyName.trim()) return '会社名/氏名は必須です';
  if (!f.contact.trim()) return 'メールアドレスは必須です';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.contact.trim())) return '有効なメールアドレスを入力してください';
  return '';
}

var submitting_ = false;
function submitNow_() {
  if (submitting_) return;
  submitting_ = true;
  var min = Number(state.settings?.minOrderCount || 10);
  if ((state.cart.ids || []).length < min) { showToast(min + '点以上選択してください'); submitting_ = false; return; }
  var f = readForm_();
  var err = validateForm_(f);
  if (err) { showToast(err); submitting_ = false; return; }
  $('submitBtn').disabled = true;
  setSending_(true, '依頼送信中...');
  var ids = (state.cart.ids || []).slice();
  
  runApi('apiSyncHolds', state.userKey, ids)
    .then(function(syncResult) {
      if (!syncResult || !syncResult.ok) throw new Error(syncResult && syncResult.message ? syncResult.message : '確保に失敗しました');
      if (syncResult.failed && syncResult.failed.length) {
        state.cart.ids = state.cart.ids.filter(function(x) { return !syncResult.failed.find(function(f) { return f.id === x; }); });
        saveCartStorage(); updateCartCount(); renderCartModal_();
        throw new Error('一部確保できない商品があります');
      }
      return getRecaptchaToken_().then(function(token) {
        return runApi('apiSubmitEstimate', state.userKey, f, ids, { _runApiExtra_: true, recaptchaToken: token });
      });
    })
    .then(function(res) {
      if (!res || !res.ok) throw new Error(res && res.message ? res.message : '送信に失敗しました');
      $('doneReceipt').textContent = res.receiptNo || '';
      state.cart.ids = [];
      saveCartStorage(); updateCartCount(); closeAllModals(); openModal($('doneModal'));
      showToast('送信完了しました');
    })
    .catch(function(e) { showToast(e.message || '送信に失敗しました'); })
    .finally(function() { setSending_(false); $('submitBtn').disabled = false; submitting_ = false; });
}

// =====================================================
// 設定
// =====================================================

function normalizeSettings_(s) {
  var src = (s && typeof s === 'object') ? s : {};
  var ui = (src.uiText && typeof src.uiText === 'object') ? src.uiText : {};
  var out = {};
  out.appTitle = String(src.appTitle || ui.appTitle || '見積もりシステム');
  out.minOrderCount = Number(src.minOrderCount != null ? src.minOrderCount : (ui.minOrderCount != null ? ui.minOrderCount : 10));
  out.shippingEstimateText = String(src.shippingEstimateText || ui.shippingEstimateText || '');
  out.notes = Array.isArray(src.notes) ? src.notes : (Array.isArray(src.topNotes) ? src.topNotes : (Array.isArray(ui.notes) ? ui.notes : []));
  out.nextSteps = Array.isArray(src.nextSteps) ? src.nextSteps : (Array.isArray(ui.nextSteps) ? ui.nextSteps : []);
  out.basePaymentUrl = String(src.basePaymentUrl || ui.basePaymentUrl || '');
  out.topNotes = Array.isArray(src.topNotes) ? src.topNotes : out.notes;
  return out;
}

function buildTopNotes() {
  var el = $('topNotes');
  if (!el) return;
  var s = state.settings || {};
  var arr = Array.isArray(s.topNotes) ? s.topNotes : (Array.isArray(s.notes) ? s.notes : []);
  el.innerHTML = '';
  if (!arr.length) return;
  var ul = document.createElement('ul'); ul.style.margin = '0'; ul.style.paddingLeft = '1.1em';
  for (var i = 0; i < arr.length; i++) {
    var t = String(arr[i] || '').trim();
    if (!t) continue;
    var li = document.createElement('li'); li.innerHTML = t; ul.appendChild(li);
  }
  el.appendChild(ul);
}

function setBaseLink_() {
  var a = $('baseLink');
  if (!a) return;
  var url = (state.settings && state.settings.basePaymentUrl) ? String(state.settings.basePaymentUrl) : '';
  if (!url) { a.textContent = ''; a.removeAttribute('href'); return; }
  a.textContent = url; a.href = url;
}

// =====================================================
// UI初期化
// =====================================================

function bindUi_() {
  $('overlay').addEventListener('click', closeAllModals);
  
  $('brandBtn').addEventListener('click', function() {
    $('brandSearch').value = '';
    filterBrandList_(); updateBrandBtn_(); openModal($('brandModal'));
    try { $('brandSearch').focus(); } catch (e) {}
  });
  $('brandCloseBtn').addEventListener('click', function() { closeModal($('brandModal')); });
  $('brandSearch').addEventListener('input', filterBrandList_);
  $('brandClearBtn').addEventListener('click', function() {
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    state.brandUi.selected = {}; updateBrandBtn_(); filterBrandList_();
  });
  $('brandApplyBtn').addEventListener('click', function() {
    state.query.filters.brand = Object.keys(state.brandUi.selected || {});
    state.query.page = 1; updateBrandBtn_(); closeModal($('brandModal')); filterAndRender(true);
  });
  
  var doFilter_ = function() { state.query.page = 1; filterAndRender(true); };
  // マルチセレクトフィルターはsetupMultiSelectFilters()で設定
  $('sortKey').addEventListener('change', function() { state.query.sort.key = this.value; doFilter_(); });
  $('sortDir').addEventListener('change', function() { state.query.sort.dir = this.value; doFilter_(); });
  
  $('btnReset').addEventListener('click', function() {
    state.query.filters = { brand: [], category: [], state: [], gender: [], size: [] };
    state.query.sort = { key: 'default', dir: 'asc' };
    state.query.page = 1;
    // ブランドフィルターをリセット
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    state.brandUi.selected = {}; updateBrandBtn_();
    // マルチセレクトフィルターをリセット
    resetMultiSelectFilters();
    $('sortKey').value = 'default'; $('sortDir').value = 'asc';
    filterAndRender(true);
  });
  
  $('openCartBtn').addEventListener('click', function() { renderCartModal_(); openModal($('cartModal')); });
  $('clearCartBtn').addEventListener('click', function() {
    state.cart.ids = []; saveCartStorage(); updateCartCount(); renderCartModal_(); filterAndRender(false);
    runApi('apiSyncHolds', state.userKey, []).catch(function() {});
    showToast('カートを空にしました');
  });
  $('cartCloseBtn').addEventListener('click', function() { closeModal($('cartModal')); });
  $('goFormBtn').addEventListener('click', function() {
    closeModal($('cartModal'));
    // ログインユーザーの情報を自動入力
    if (state.customer) {
      if (state.customer.companyName && !$('companyName').value) $('companyName').value = state.customer.companyName;
      if (state.customer.email && !$('contact').value) $('contact').value = state.customer.email;
      if (state.customer.phone && !$('phone').value) $('phone').value = state.customer.phone;
      if (state.customer.postal && !$('postal').value) $('postal').value = state.customer.postal;
      if (state.customer.address && !$('address').value) $('address').value = state.customer.address;
    }
    openModal($('formModal'));
  });
  $('formCloseBtn').addEventListener('click', function() { closeModal($('formModal')); });
  $('formBackBtn').addEventListener('click', function() { closeModal($('formModal')); renderCartModal_(); openModal($('cartModal')); });
  $('submitBtn').addEventListener('click', submitNow_);
  $('doneCloseBtn').addEventListener('click', function() { closeModal($('doneModal')); });
  
}

function setupScrollTopButton_() {
  var btn = $('toTopBtn');
  if (!btn) return;
  var threshold = 400;
  var update = function() {
    var hasModal = !!document.querySelector('.modal.open');
    var sendingOn = $('sendingOverlay') && $('sendingOverlay').classList.contains('on');
    if (hasModal || sendingOn) { btn.classList.remove('show'); return; }
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > threshold) btn.classList.add('show'); else btn.classList.remove('show');
  };
  btn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  window.addEventListener('scroll', update, { passive: true });
  window.addEventListener('resize', update);
  update();
}

// =====================================================
// アクセスログ（PV記録）
// =====================================================

function logPageView_() {
  try {
    var payload = {
      page: 'Index',
      userKey: state.userKey || '',
      url: window.location.href || '',
      referrer: document.referrer || '',
      userAgent: navigator.userAgent || '',
      language: navigator.language || '',
      screen: (screen.width || 0) + 'x' + (screen.height || 0)
    };
    runApi('apiLogPV', payload).catch(function(e) {
      console.log('PVログエラー:', e);
    });
  } catch (e) {
    console.log('PVログ送信失敗:', e);
  }
}

// =====================================================
// 起動
// =====================================================

function boot() {
  state.userKey = loadUserKey();
  var c = loadCartStorage();
  state.cart.ids = c.ids || [];
  state.cart.itemsById = c.itemsById || {};
  updateCartCount();

  // アクセスログ送信
  logPageView_();

  bindUi_();
  setupScrollTopButton_();
  setupDetailModalEvents_();
  setupAuthUi_();
  setupMultiSelectFilters();

  // セッション検証（ログイン状態復元）
  validateSession_();

  // 説明欄どこを押しても折りたたみ
  var topDet = document.querySelector('.topDetails');
  if (topDet) {
    topDet.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') return; // リンクはそのまま
      if (e.target.closest('summary')) return; // summaryは標準動作
      topDet.open = !topDet.open;
    });
  }

  var mo = loadMeasureOpt_();
  if (mo) setMeasureOptValue_(mo);
  
  // キャッシュがあれば即座に表示
  var cached = loadProductCache_();
  if (cached && !cached.stale && cached.products) {
    console.log('キャッシュから即時表示:', cached.products.length + '件');
    applyProductData_(cached);
  } else if (cached && cached.stale && cached.data && cached.data.products) {
    console.log('古いキャッシュから即時表示:', cached.data.products.length + '件');
    applyProductData_(cached.data);
  } else {
    renderLoadingGrid_();
  }

  // 最新データをバックグラウンドで取得
  loadProductData()
    .then(function(data) {
      // キャッシュと件数が異なる場合のみ再描画
      var needsRender = !state.dataLoaded || state.allProducts.length !== (data.products || []).length;
      applyProductData_(data);
      if (needsRender) {
        console.log('最新データで更新: ' + state.allProducts.length + '件');
      }
    })
    .catch(function(err) {
      console.error('起動エラー:', err);
      if (!state.dataLoaded) {
        showToast('データの読み込みに失敗しました: ' + (err.message || err));
      }
    });
}

function applyProductData_(data) {
  state.allProducts = data.products || [];
  state.options = data.options || {};
  state.settings = normalizeSettings_(data.settings);

  $('appTitle').textContent = state.settings.appTitle || '見積もりシステム';
  buildTopNotes();
  setBaseLink_();

  // マルチセレクトフィルターを構築
  buildMultiSelectDropdown('category', state.options.category || []);
  buildMultiSelectDropdown('state', state.options.state || []);
  buildMultiSelectDropdown('gender', state.options.gender || []);
  buildMultiSelectDropdown('size', state.options.size || []);
  setSortOptions($('sortKey'), state.options.sort || [{ key: 'default', label: '標準' }]);
  if (!state.dataLoaded) {
    $('sortKey').value = 'default';
    $('sortDir').value = 'asc';
  }

  buildBrandListOnce_(state.options.brand || []);
  updateBrandBtn_();
  filterBrandList_();

  state.dataLoaded = true;
  filterAndRender(false);

  // メイン画面おすすめ商品を表示
  renderMainRecommendations_();
}

window.addEventListener('error', function(ev) {
  var msg = (ev && ev.error && ev.error.message) ? ev.error.message : (ev && ev.message ? ev.message : 'エラー');
  // Suppress cross-origin "Script error" messages (not useful to users)
  if (msg === 'Script error.' || msg === 'Script error') return;
  try { showToast(msg); } catch (e) {}
});

window.addEventListener('unhandledrejection', function(ev) {
  var r = ev ? ev.reason : null;
  var msg = (r && r.message) ? r.message : String(r || 'エラー');
  try { showToast(msg); } catch (e) {}
});

boot();
</script>
</body>
</html>
