<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title><?= appTitle ?> - まとめ商品管理</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif; background: #f0f2f5; color: #333; min-height: 100vh; }

/* ヘッダー */
.header { background: #1a73e8; color: #fff; padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,.15); position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 17px; font-weight: 600; }
.header .btn-new { background: #fff; color: #1a73e8; border: none; padding: 8px 18px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; }
.header .btn-new:hover { background: #e8f0fe; }

/* コンテナ */
.container { max-width: 1000px; margin: 0 auto; padding: 20px 16px; }

/* 商品カード一覧 */
.product-list { display: flex; flex-direction: column; gap: 12px; }
.product-card { background: #fff; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,.08); padding: 14px 18px; display: flex; align-items: center; gap: 14px; transition: box-shadow .2s; }
.product-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,.13); }
.product-card .thumb { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; background: #eee; flex-shrink: 0; }
.product-card .thumb-empty { width: 64px; height: 64px; border-radius: 8px; background: #e0e0e0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 11px; }
.product-card .info { flex: 1; min-width: 0; }
.product-card .info .name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.product-card .info .meta { font-size: 12px; color: #666; margin-top: 3px; }
.product-card .info .meta span { margin-right: 10px; }
.product-card .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.badge-active { background: #e6f4ea; color: #1e8e3e; }
.badge-inactive { background: #fce8e6; color: #d93025; }
.product-card .actions { display: flex; gap: 6px; flex-shrink: 0; }
.product-card .actions button { border: none; padding: 7px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
.btn-edit { background: #e8f0fe; color: #1a73e8; }
.btn-edit:hover { background: #d2e3fc; }
.btn-del { background: #fce8e6; color: #d93025; }
.btn-del:hover { background: #f8d7d4; }

.empty-msg { text-align: center; padding: 60px 20px; color: #888; font-size: 15px; }

/* オーバーレイ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 200; }
.overlay.active { display: block; }

/* モーダル */
.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); z-index: 300; width: 94vw; max-width: 640px; max-height: 90vh; overflow: hidden; flex-direction: column; }
.modal.active { display: flex; }
.modal-header { padding: 16px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.modal-header h2 { font-size: 16px; font-weight: 700; }
.modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 4px; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 14px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }

/* フォーム */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-field { display: flex; flex-direction: column; gap: 4px; }
.form-field.full { grid-column: 1 / -1; }
.form-field label { font-size: 12px; font-weight: 600; color: #555; }
.form-field label .req { color: #d93025; }
.form-field input, .form-field select, .form-field textarea {
  border: 1px solid #d0d0d0; border-radius: 6px; padding: 9px 12px; font-size: 14px;
  outline: none; transition: border-color .2s; font-family: inherit;
}
.form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: #1a73e8; }
.form-field textarea { resize: vertical; min-height: 70px; }

/* 商品IDフィールド */
.id-field { display: flex; gap: 8px; align-items: center; }
.id-field input { flex: 1; background: #f5f5f5; }
.btn-regen { border: none; background: #e8f0fe; color: #1a73e8; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap; }
.btn-regen:hover { background: #d2e3fc; }

/* 画像アップロードエリア */
.image-section { margin-top: 6px; }
.image-section h3 { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
.image-slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
.image-slot { position: relative; aspect-ratio: 1; border: 2px dashed #ccc; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; transition: border-color .2s; background: #fafafa; }
.image-slot:hover { border-color: #1a73e8; }
.image-slot.has-image { border-style: solid; border-color: #1a73e8; }
.image-slot .slot-label { font-size: 11px; color: #999; margin-top: 4px; }
.image-slot .slot-icon { font-size: 22px; color: #bbb; }
.image-slot img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.image-slot .remove-img { position: absolute; top: 3px; right: 3px; background: rgba(0,0,0,.6); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; cursor: pointer; display: none; align-items: center; justify-content: center; line-height: 1; }
.image-slot.has-image .remove-img { display: flex; }
.image-slot .slot-num { position: absolute; top: 3px; left: 3px; background: rgba(0,0,0,.5); color: #fff; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; }

/* ボタン */
.btn-save { background: #1a73e8; color: #fff; border: none; padding: 10px 28px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-save:hover { background: #1557b0; }
.btn-save:disabled { background: #aaa; cursor: not-allowed; }
.btn-cancel { background: #f5f5f5; color: #333; border: 1px solid #d0d0d0; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
.btn-cancel:hover { background: #e8e8e8; }

/* トースト */
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 13px; z-index: 400; opacity: 0; transition: opacity .3s; pointer-events: none; }
.toast.show { opacity: 1; }

/* ローディング */
.loading { display: flex; justify-content: center; padding: 60px; }
.spinner { width: 36px; height: 36px; border: 3px solid #e0e0e0; border-top-color: #1a73e8; border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* 確認ダイアログ */
.confirm-dialog { text-align: center; padding: 10px 0; }
.confirm-dialog p { font-size: 15px; margin-bottom: 20px; }
.confirm-dialog .name { font-weight: 700; color: #d93025; }
.confirm-btns { display: flex; gap: 10px; justify-content: center; }

@media (max-width: 600px) {
  .form-grid { grid-template-columns: 1fr; }
  .image-slots { grid-template-columns: repeat(3, 1fr); }
  .product-card { flex-wrap: wrap; }
  .product-card .actions { width: 100%; justify-content: flex-end; }
}
</style>
</head>
<body>

<div class="header">
  <h1>まとめ商品管理</h1>
  <button class="btn-new" onclick="openNewProduct()">+ 新規登録</button>
</div>

<div class="container">
  <div id="loadingArea" class="loading"><div class="spinner"></div></div>
  <div id="productList" class="product-list" style="display:none;"></div>
  <div id="emptyMsg" class="empty-msg" style="display:none;">商品がまだ登録されていません。<br>「+ 新規登録」から追加してください。</div>
</div>

<!-- 商品登録/編集モーダル -->
<div class="overlay" id="overlay"></div>
<div class="modal" id="productModal">
  <div class="modal-header">
    <h2 id="modalTitle">商品を登録</h2>
    <button class="modal-close" onclick="closeModal()">&times;</button>
  </div>
  <div class="modal-body">
    <div class="form-grid">
      <!-- 商品ID -->
      <div class="form-field">
        <label>商品ID <span class="req">*</span></label>
        <div class="id-field">
          <input type="text" id="fProductId" readonly>
          <button class="btn-regen" id="btnRegenId" onclick="regenerateId()">再生成</button>
        </div>
      </div>

      <!-- 商品名 -->
      <div class="form-field">
        <label>商品名 <span class="req">*</span></label>
        <input type="text" id="fName" placeholder="例: ノーブランドMIXパック">
      </div>

      <!-- 価格 -->
      <div class="form-field">
        <label>価格（税込） <span class="req">*</span></label>
        <input type="number" id="fPrice" min="1" placeholder="例: 3000">
      </div>

      <!-- 単位 -->
      <div class="form-field">
        <label>単位</label>
        <select id="fUnit">
          <option value="/kg">/kg</option>
          <option value="/点">/点</option>
          <option value="/パック">/パック</option>
          <option value="/セット">/セット</option>
          <option value="/箱">/箱</option>
          <option value="">なし</option>
        </select>
      </div>

      <!-- タグ -->
      <div class="form-field">
        <label>タグ</label>
        <select id="fTag">
          <option value="">なし</option>
          <option value="人気No.1">人気No.1</option>
          <option value="高利益率">高利益率</option>
          <option value="おすすめ">おすすめ</option>
          <option value="NEW">NEW</option>
          <option value="期間限定">期間限定</option>
          <option value="SALE">SALE</option>
        </select>
      </div>

      <!-- 最小注文数 -->
      <div class="form-field">
        <label>最小注文数</label>
        <input type="number" id="fMinQty" min="1" value="1">
      </div>

      <!-- 最大注文数 -->
      <div class="form-field">
        <label>最大注文数</label>
        <input type="number" id="fMaxQty" min="1" value="99">
      </div>

      <!-- 表示順 -->
      <div class="form-field">
        <label>表示順（小さい順）</label>
        <input type="number" id="fSortOrder" min="0" value="999">
      </div>

      <!-- 公開 -->
      <div class="form-field">
        <label>公開ステータス</label>
        <select id="fActive">
          <option value="true">公開</option>
          <option value="false">非公開</option>
        </select>
      </div>

      <!-- 説明 -->
      <div class="form-field full">
        <label>商品説明</label>
        <textarea id="fDescription" placeholder="商品の説明文を入力"></textarea>
      </div>

      <!-- 画像 -->
      <div class="form-field full image-section">
        <h3>商品画像（最大5枚 / Googleドライブから選択）</h3>
        <div class="image-slots" id="imageSlots"></div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
    <button class="btn-save" id="btnSave" onclick="saveProduct()">登録する</button>
  </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal" id="deleteModal">
  <div class="modal-header">
    <h2>商品を削除</h2>
    <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
  </div>
  <div class="modal-body">
    <div class="confirm-dialog">
      <p>以下の商品を削除しますか？<br><span class="name" id="delProductName"></span></p>
      <div class="confirm-btns">
        <button class="btn-cancel" onclick="closeDeleteModal()">キャンセル</button>
        <button class="btn-del" style="padding:10px 24px;font-size:14px;border-radius:8px;" onclick="confirmDelete()">削除する</button>
      </div>
    </div>
  </div>
</div>

<!-- トースト -->
<div class="toast" id="toast"></div>

<script src="https://apis.google.com/js/api.js"></script>
<script>
// --- グローバル状態 ---
var G = {
  products: [],
  editingId: null,  // 編集中の商品ID（nullなら新規）
  images: ['', '', '', '', '', ''], // 5スロット
  pendingDeleteId: null,
  adminKey: '',
  oauthToken: null,
  pickerSlot: 0
};

// --- 管理キー（URLパラメータから取得） ---
(function() {
  var params = new URLSearchParams(window.location.search);
  G.adminKey = params.get('key') || '';
})();

// --- API呼び出しヘルパー ---
function callApi(action, args) {
  return new Promise(function(resolve, reject) {
    var fullArgs = [G.adminKey].concat(args || []);
    google.script.run
      .withSuccessHandler(function(r) {
        if (r && r.ok) resolve(r);
        else reject(new Error((r && r.message) || '不明なエラー'));
      })
      .withFailureHandler(function(e) { reject(e); })
      [action].apply(null, fullArgs);
  });
}

// --- 初期化 ---
function init() {
  callApi('apiBulkAdminInit', []).then(function(r) {
    G.products = r.products || [];
    renderList();
    document.getElementById('loadingArea').style.display = 'none';
  }).catch(function(e) {
    document.getElementById('loadingArea').innerHTML = '<p style="color:#d93025;">読み込みエラー: ' + e.message + '</p>';
  });
}

// --- 一覧描画 ---
function renderList() {
  var list = document.getElementById('productList');
  var empty = document.getElementById('emptyMsg');

  if (G.products.length === 0) {
    list.style.display = 'none';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  list.style.display = 'flex';

  var html = '';
  for (var i = 0; i < G.products.length; i++) {
    var p = G.products[i];
    var thumbUrl = '';
    for (var j = 0; j < p.images.length; j++) {
      if (p.images[j]) { thumbUrl = p.images[j]; break; }
    }

    var badgeClass = p.active ? 'badge-active' : 'badge-inactive';
    var badgeText = p.active ? '公開' : '非公開';

    html += '<div class="product-card">';
    if (thumbUrl) {
      html += '<img class="thumb" src="' + escHtml(thumbUrl) + '" onerror="this.style.display=\'none\'">';
    } else {
      html += '<div class="thumb-empty">No Image</div>';
    }
    html += '<div class="info">';
    html += '<div class="name">' + escHtml(p.name) + '</div>';
    html += '<div class="meta">';
    html += '<span>' + escHtml(p.productId) + '</span>';
    html += '<span>' + formatYen(p.price) + escHtml(p.unit) + '</span>';
    if (p.tag) html += '<span style="color:#e67700;">' + escHtml(p.tag) + '</span>';
    html += '<span class="badge ' + badgeClass + '">' + badgeText + '</span>';
    html += '</div></div>';
    html += '<div class="actions">';
    html += '<button class="btn-edit" onclick="openEditProduct(\'' + escHtml(p.productId) + '\')">編集</button>';
    html += '<button class="btn-del" onclick="openDeleteConfirm(\'' + escHtml(p.productId) + '\')">削除</button>';
    html += '</div></div>';
  }
  list.innerHTML = html;
}

// --- 新規登録 ---
function openNewProduct() {
  G.editingId = null;
  G.images = ['', '', '', '', ''];
  document.getElementById('modalTitle').textContent = '商品を登録';
  document.getElementById('btnSave').textContent = '登録する';
  document.getElementById('btnRegenId').style.display = '';

  // フォームクリア
  document.getElementById('fName').value = '';
  document.getElementById('fPrice').value = '';
  document.getElementById('fUnit').value = '/kg';
  document.getElementById('fTag').value = '';
  document.getElementById('fMinQty').value = '1';
  document.getElementById('fMaxQty').value = '99';
  document.getElementById('fSortOrder').value = '999';
  document.getElementById('fActive').value = 'true';
  document.getElementById('fDescription').value = '';
  document.getElementById('fProductId').value = '';

  // 新しいIDを取得
  callApi('apiBulkAdminNewId', []).then(function(r) {
    document.getElementById('fProductId').value = r.id;
  });

  renderImageSlots();
  showModal('productModal');
}

// --- 編集 ---
function openEditProduct(productId) {
  var product = null;
  for (var i = 0; i < G.products.length; i++) {
    if (G.products[i].productId === productId) { product = G.products[i]; break; }
  }
  if (!product) return;

  G.editingId = productId;
  G.images = [];
  for (var j = 0; j < 5; j++) {
    G.images[j] = (product.images && product.images[j]) ? product.images[j] : '';
  }

  document.getElementById('modalTitle').textContent = '商品を編集';
  document.getElementById('btnSave').textContent = '更新する';
  document.getElementById('btnRegenId').style.display = 'none';

  document.getElementById('fProductId').value = product.productId;
  document.getElementById('fName').value = product.name;
  document.getElementById('fPrice').value = product.price;
  setSelectValue('fUnit', product.unit);
  setSelectValue('fTag', product.tag);
  document.getElementById('fMinQty').value = product.minQty;
  document.getElementById('fMaxQty').value = product.maxQty;
  document.getElementById('fSortOrder').value = product.sortOrder;
  document.getElementById('fActive').value = product.active ? 'true' : 'false';
  document.getElementById('fDescription').value = product.description;

  renderImageSlots();
  showModal('productModal');
}

function setSelectValue(id, val) {
  var sel = document.getElementById(id);
  for (var i = 0; i < sel.options.length; i++) {
    if (sel.options[i].value === val) { sel.selectedIndex = i; return; }
  }
  // 見つからなければカスタム値として最初のオプションを追加
  if (val) {
    var opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    sel.appendChild(opt);
    sel.value = val;
  }
}

// --- ID再生成 ---
function regenerateId() {
  var btn = document.getElementById('btnRegenId');
  btn.disabled = true;
  callApi('apiBulkAdminNewId', []).then(function(r) {
    document.getElementById('fProductId').value = r.id;
    btn.disabled = false;
  }).catch(function() { btn.disabled = false; });
}

// --- 画像スロット描画 ---
function renderImageSlots() {
  var container = document.getElementById('imageSlots');
  var html = '';
  for (var i = 0; i < 5; i++) {
    var url = G.images[i] || '';
    var hasImg = url ? ' has-image' : '';
    html += '<div class="image-slot' + hasImg + '" onclick="pickImage(' + i + ')" data-slot="' + i + '">';
    html += '<span class="slot-num">' + (i + 1) + '</span>';
    if (url) {
      html += '<img src="' + escHtml(url) + '" onerror="this.parentElement.classList.remove(\'has-image\');this.remove();">';
      html += '<button class="remove-img" onclick="event.stopPropagation();removeImage(' + i + ');">&times;</button>';
    } else {
      html += '<span class="slot-icon">+</span>';
      html += '<span class="slot-label">ドライブから選択</span>';
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

// --- Google Drive Picker ---
function pickImage(slotIndex) {
  G.pickerSlot = slotIndex;

  if (G.oauthToken) {
    openPicker();
    return;
  }

  // OAuthトークン取得
  callApi('apiBulkAdminGetOAuthToken', []).then(function(r) {
    G.oauthToken = r.token;
    loadPickerApi();
  }).catch(function(e) {
    showToast('認証エラー: ' + e.message);
  });
}

function loadPickerApi() {
  if (typeof google !== 'undefined' && google.picker) {
    openPicker();
    return;
  }
  gapi.load('picker', { callback: openPicker });
}

function openPicker() {
  var view = new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES)
    .setIncludeFolders(true)
    .setSelectFolderEnabled(false);

  var picker = new google.picker.PickerBuilder()
    .addView(view)
    .setOAuthToken(G.oauthToken)
    .setCallback(pickerCallback)
    .setTitle('画像を選択（スロット ' + (G.pickerSlot + 1) + '）')
    .setLocale('ja')
    .build();
  picker.setVisible(true);
}

function pickerCallback(data) {
  if (data.action !== google.picker.Action.PICKED) return;

  var fileId = data.docs[0].id;
  showToast('画像を処理中...');

  callApi('apiBulkAdminGetDriveImageUrl', [fileId]).then(function(r) {
    G.images[G.pickerSlot] = r.url;
    renderImageSlots();
    showToast('画像' + (G.pickerSlot + 1) + 'を設定しました');
  }).catch(function(e) {
    showToast('画像エラー: ' + e.message);
  });
}

function removeImage(index) {
  G.images[index] = '';
  renderImageSlots();
}

// --- 保存 ---
function saveProduct() {
  var productId = document.getElementById('fProductId').value.trim();
  var name = document.getElementById('fName').value.trim();
  var price = parseInt(document.getElementById('fPrice').value, 10);

  if (!productId) { showToast('商品IDが必要です'); return; }
  if (!name) { showToast('商品名を入力してください'); return; }
  if (!price || price <= 0) { showToast('価格を正しく入力してください'); return; }

  var product = {
    productId: productId,
    name: name,
    description: document.getElementById('fDescription').value.trim(),
    price: price,
    unit: document.getElementById('fUnit').value,
    tag: document.getElementById('fTag').value,
    images: G.images.slice(0, 5),
    minQty: parseInt(document.getElementById('fMinQty').value, 10) || 1,
    maxQty: parseInt(document.getElementById('fMaxQty').value, 10) || 99,
    sortOrder: parseInt(document.getElementById('fSortOrder').value, 10) || 999,
    active: document.getElementById('fActive').value === 'true'
  };

  var btn = document.getElementById('btnSave');
  btn.disabled = true;
  btn.textContent = '保存中...';

  callApi('apiBulkAdminSave', [product]).then(function(r) {
    G.products = r.products || [];
    renderList();
    closeModal();
    showToast(r.message);
  }).catch(function(e) {
    showToast('エラー: ' + e.message);
  }).finally(function() {
    btn.disabled = false;
    btn.textContent = G.editingId ? '更新する' : '登録する';
  });
}

// --- 削除 ---
function openDeleteConfirm(productId) {
  var product = null;
  for (var i = 0; i < G.products.length; i++) {
    if (G.products[i].productId === productId) { product = G.products[i]; break; }
  }
  if (!product) return;

  G.pendingDeleteId = productId;
  document.getElementById('delProductName').textContent = product.name + ' (' + productId + ')';
  showModal('deleteModal');
}

function confirmDelete() {
  if (!G.pendingDeleteId) return;

  callApi('apiBulkAdminDelete', [G.pendingDeleteId]).then(function(r) {
    G.products = r.products || [];
    renderList();
    closeDeleteModal();
    showToast(r.message);
  }).catch(function(e) {
    showToast('エラー: ' + e.message);
  });
}

function closeDeleteModal() {
  G.pendingDeleteId = null;
  document.getElementById('deleteModal').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
}

// --- モーダル制御 ---
function showModal(id) {
  document.getElementById('overlay').classList.add('active');
  document.getElementById(id).classList.add('active');
}

function closeModal() {
  document.getElementById('productModal').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
}

// オーバーレイクリックで閉じる
document.getElementById('overlay').addEventListener('click', function() {
  closeModal();
  closeDeleteModal();
});

// --- ユーティリティ ---
function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function formatYen(n) {
  return '¥' + String(Number(n) || 0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// Promiseポリフィル用finally
if (!Promise.prototype.finally) {
  Promise.prototype.finally = function(cb) {
    return this.then(function(v) { return Promise.resolve(cb()).then(function() { return v; }); },
                     function(r) { return Promise.resolve(cb()).then(function() { throw r; }); });
  };
}

// --- 起動 ---
init();
</script>
</body>
</html>
