<!-- === ÂâØÊ•≠Áâ©Ë≤©„ÅäÂΩπÁ´ã„Å°ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó === -->
<style>
.article-fab{
  position:fixed;left:16px;bottom:76px;z-index:90;
  display:flex;align-items:center;gap:6px;
  padding:8px 12px;border-radius:999px;
  background:rgba(30,41,59,.75);
  color:#fff;border:none;cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,.15);
  font-weight:600;font-size:12px;font-family:inherit;
  line-height:1.2;white-space:nowrap;
  transition:transform .2s,box-shadow .2s;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  opacity:0.5;
}
.article-fab:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.2);}
.article-fab .article-fab-emoji{font-size:16px;}
.article-fab .article-fab-badge{display:none!important;}
.article-fab.dismissed{display:none;}

.article-panel{
  position:fixed;left:16px;bottom:126px;z-index:91;
  width:360px;max-width:calc(100vw - 32px);
  height:480px;max-height:calc(100vh - 120px);
  background:rgba(255,255,255,.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-radius:16px;
  box-shadow:0 8px 32px rgba(0,0,0,.18);
  display:none;flex-direction:column;overflow:hidden;
  border:1px solid rgba(230,232,238,.6);
}
.article-panel.open{display:flex;}

.article-panel-header{
  padding:12px 14px;
  background:rgba(30,41,59,.9);
  color:#fff;display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0;
}
.article-panel-title{font-weight:900;font-size:15px;display:flex;align-items:center;gap:6px;}
.article-panel-close{
  background:rgba(255,255,255,.2);border:none;color:#fff;
  width:30px;height:30px;border-radius:50%;font-size:18px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.article-panel-close:hover{background:rgba(255,255,255,.35);}

.article-panel-body{flex:1;overflow-y:auto;padding:0;-webkit-overflow-scrolling:touch;}

.article-list{list-style:none;margin:0;padding:0;}
.article-list-item{padding:12px 14px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background .15s;}
.article-list-item:hover{background:#f1f5f9;}
.article-list-item:last-child{border-bottom:none;}
.article-item-header{display:flex;align-items:flex-start;gap:8px;margin-bottom:4px;}
.article-item-emoji{font-size:22px;flex-shrink:0;line-height:1;}
.article-item-title{font-weight:900;font-size:14px;color:#1a1a2e;line-height:1.4;}
.article-item-meta{display:flex;align-items:center;gap:8px;margin-top:4px;padding-left:30px;}
.article-item-date{font-size:11px;color:#888;}
.article-item-category{font-size:10px;padding:2px 6px;border-radius:4px;background:#f1f5f9;color:#64748b;font-weight:700;}
.article-item-summary{font-size:12px;color:#666;margin-top:4px;padding-left:30px;line-height:1.5;}

.article-detail{display:none;padding:0;}
.article-detail.active{display:block;}
.article-detail-back{
  display:flex;align-items:center;gap:4px;
  padding:10px 14px;border-bottom:1px solid #f0f0f0;
  cursor:pointer;font-size:13px;font-weight:700;color:#64748b;
  background:transparent;border-top:none;border-left:none;border-right:none;
  width:100%;text-align:left;transition:background .15s;font-family:inherit;
}
.article-detail-back:hover{background:#f8fafc;}
.article-detail-header{padding:14px;border-bottom:1px solid #f0f0f0;}
.article-detail-title{font-weight:900;font-size:16px;color:#1a1a2e;line-height:1.4;margin-bottom:8px;}
.article-detail-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.article-detail-date{font-size:12px;color:#888;}
.article-detail-category{font-size:11px;padding:2px 8px;border-radius:4px;background:#f1f5f9;color:#64748b;font-weight:700;}
.article-detail-tags{font-size:11px;color:#888;}
.article-detail-content{padding:14px;font-size:14px;line-height:1.8;color:#333;}
.article-detail-content h3{font-size:15px;font-weight:900;margin:16px 0 8px;color:#1a1a2e;}
.article-detail-content p{margin:0 0 12px;}
.article-detail-content ul{margin:0 0 12px;padding-left:20px;}
.article-detail-content li{margin-bottom:4px;}
.article-detail-content strong{color:#1a1a2e;}

.article-loading{text-align:center;padding:40px 14px;color:#888;font-size:13px;}
.article-loading-spinner{
  display:inline-block;width:24px;height:24px;
  border:3px solid #f0f0f0;border-top-color:#64748b;
  border-radius:50%;animation:articleSpin .8s linear infinite;
  margin-bottom:8px;
}
@keyframes articleSpin{to{transform:rotate(360deg);}}
.article-empty{text-align:center;padding:40px 14px;color:#888;font-size:13px;}

@media(max-width:480px){
  .article-panel{bottom:0;left:0;right:0;width:100%;max-width:100%;height:100%;max-height:100%;border-radius:0;}
  .article-fab{bottom:16px;left:12px;padding:7px 10px;font-size:11px;}
}
body.admin-mode .article-fab{bottom:136px;}
body.admin-mode .article-panel{bottom:186px;}
@media(max-width:480px){
  body.admin-mode .article-fab{bottom:136px;}
  body.admin-mode .article-panel{bottom:0;height:100%;max-height:100%;}
}
</style>

<button class="article-fab" id="articleFab" type="button" aria-label="ÂâØÊ•≠Áâ©Ë≤©„ÅäÂΩπÁ´ã„Å°ÊÉÖÂ†±">
  <span class="article-fab-emoji">üí°</span>
  <span>ÂâØÊ•≠Áâ©Ë≤©„ÅäÂΩπÁ´ã„Å°ÊÉÖÂ†±</span>
  <span class="article-fab-badge" id="articleBadge"></span>
</button>

<div class="article-panel" id="articlePanel">
  <div class="article-panel-header">
    <span class="article-panel-title">üí° ÂâØÊ•≠Áâ©Ë≤©„ÅäÂΩπÁ´ã„Å°ÊÉÖÂ†±</span>
    <button class="article-panel-close" id="articlePanelClose" type="button" aria-label="Èñâ„Åò„Çã">&times;</button>
  </div>
  <div class="article-panel-body" id="articlePanelBody">
    <div id="articleListView">
      <div class="article-loading" id="articleLoading">
        <div class="article-loading-spinner"></div>
        <div>Ë®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
      <ul class="article-list" id="articleList"></ul>
      <div class="article-empty" id="articleEmpty" style="display:none;">
        „Åæ„Å†Ë®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>ÊØéÊó•Êñ∞„Åó„ÅÑË®ò‰∫ã„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ
      </div>
    </div>
    <div class="article-detail" id="articleDetailView">
      <button class="article-detail-back" id="articleDetailBack" type="button">
        ‚Üê Ë®ò‰∫ã‰∏ÄË¶ß„Å´Êàª„Çã
      </button>
      <div class="article-detail-header" id="articleDetailHeader"></div>
      <div class="article-detail-content" id="articleDetailContent"></div>
    </div>
  </div>
</div>

<script>
(function(){
  var fab = document.getElementById('articleFab');
  var panel = document.getElementById('articlePanel');
  var closeBtn = document.getElementById('articlePanelClose');
  var badge = document.getElementById('articleBadge');
  var listView = document.getElementById('articleListView');
  var detailView = document.getElementById('articleDetailView');
  var listEl = document.getElementById('articleList');
  var loadingEl = document.getElementById('articleLoading');
  var emptyEl = document.getElementById('articleEmpty');
  var detailBack = document.getElementById('articleDetailBack');
  var detailHeader = document.getElementById('articleDetailHeader');
  var detailContent = document.getElementById('articleDetailContent');

  if (!fab || !panel) return;

  var isOpen = false;
  var articlesLoaded = false;
  var articlesData = [];
  var detailCache = {};

  var LS_LAST_READ = 'detauri_article_last_read_date';

  fab.addEventListener('click', function() {
    if (isOpen) { closePanel(); } else { openPanel(); }
  });
  closeBtn.addEventListener('click', function() { closePanel(); });
  detailBack.addEventListener('click', function() { showListView(); });

  function openPanel() {
    isOpen = true;
    panel.classList.add('open');
    if (!articlesLoaded) fetchArticles();
    try {
      var now = new Date();
      var y = now.getFullYear();
      var m = String(now.getMonth() + 1).padStart(2, '0');
      var d = String(now.getDate()).padStart(2, '0');
      localStorage.setItem(LS_LAST_READ, y + '-' + m + '-' + d);
    } catch(e){}
    showListView();
  }

  function closePanel() {
    isOpen = false;
    panel.classList.remove('open');
  }

  function showListView() {
    listView.style.display = 'block';
    detailView.classList.remove('active');
  }

  function showDetailView() {
    listView.style.display = 'none';
    detailView.classList.add('active');
  }

  function fetchArticles() {
    loadingEl.style.display = 'block';
    emptyEl.style.display = 'none';
    listEl.innerHTML = '';

    runApi('apiGetArticles')
      .then(function(res) {
        loadingEl.style.display = 'none';
        articlesLoaded = true;
        if (!res || !res.ok || !res.articles || res.articles.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }
        articlesData = res.articles;
        renderList(articlesData);
      })
      .catch(function(err) {
        loadingEl.style.display = 'none';
        emptyEl.textContent = 'Ë®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
        emptyEl.style.display = 'block';
      });
  }

  function renderList(articles) {
    listEl.innerHTML = '';
    for (var i = 0; i < articles.length; i++) {
      var a = articles[i];
      var li = document.createElement('li');
      li.className = 'article-list-item';
      li.setAttribute('data-article-id', a.id);
      li.innerHTML =
        '<div class="article-item-header">' +
          '<span class="article-item-emoji">' + escHtml(a.emoji) + '</span>' +
          '<span class="article-item-title">' + escHtml(a.title) + '</span>' +
        '</div>' +
        '<div class="article-item-meta">' +
          '<span class="article-item-date">' + escHtml(a.publishDate) + '</span>' +
          '<span class="article-item-category">' + escHtml(a.category) + '</span>' +
        '</div>' +
        '<div class="article-item-summary">' + escHtml(a.summary) + '</div>';
      li.addEventListener('click', (function(aid) {
        return function() { loadArticleDetail(aid); };
      })(a.id));
      listEl.appendChild(li);
    }
  }

  function loadArticleDetail(articleId) {
    showDetailView();
    if (detailCache[articleId]) { renderDetail(detailCache[articleId]); return; }

    detailHeader.innerHTML = '';
    detailContent.innerHTML =
      '<div class="article-loading"><div class="article-loading-spinner"></div><div>Ë®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div></div>';

    runApi('apiGetArticleContent', articleId)
      .then(function(res) {
        if (!res || !res.ok || !res.article) {
          detailContent.innerHTML = '<div class="article-empty">Ë®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>';
          return;
        }
        detailCache[articleId] = res.article;
        renderDetail(res.article);
      })
      .catch(function() {
        detailContent.innerHTML = '<div class="article-empty">Ë®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>';
      });
  }

  function renderDetail(article) {
    var tagsHtml = '';
    if (article.tags) {
      var tagArr = article.tags.split(',');
      var parts = [];
      for (var i = 0; i < tagArr.length; i++) {
        var t = tagArr[i].trim();
        if (t) parts.push('#' + escHtml(t));
      }
      tagsHtml = '<span class="article-detail-tags">' + parts.join(' ') + '</span>';
    }
    detailHeader.innerHTML =
      '<div class="article-detail-title">' + escHtml(article.emoji) + ' ' + escHtml(article.title) + '</div>' +
      '<div class="article-detail-meta">' +
        '<span class="article-detail-date">' + escHtml(article.publishDate) + '</span>' +
        '<span class="article-detail-category">' + escHtml(article.category) + '</span>' +
        tagsHtml +
      '</div>';
    detailContent.innerHTML = sanitizeHtml(article.content);
  }

  function escHtml(text) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(text || ''));
    return d.innerHTML;
  }

  function sanitizeHtml(html) {
    var s = String(html || '');
    s = s.replace(/<script[\s\S]*?<\/script>/gi, '');
    s = s.replace(/<style[\s\S]*?<\/style>/gi, '');
    s = s.replace(/<iframe[\s\S]*?<\/iframe>/gi, '');
    s = s.replace(/<object[\s\S]*?<\/object>/gi, '');
    s = s.replace(/<embed[\s\S]*?>/gi, '');
    s = s.replace(/<link[\s\S]*?>/gi, '');
    s = s.replace(/\son\w+\s*=\s*"[^"]*"/gi, '');
    s = s.replace(/\son\w+\s*=\s*'[^']*'/gi, '');
    s = s.replace(/\son\w+\s*=[^\s>]*/gi, '');
    s = s.replace(/javascript\s*:/gi, '');
    return s;
  }

  // „Éö„Éº„Ç∏„É≠„Éº„Éâ3ÁßíÂæå„Å´Ë®ò‰∫ã„Éá„Éº„ÇøÂÖàË™≠„Åø
  setTimeout(function() {
    if (!articlesLoaded) {
      runApi('apiGetArticles')
        .then(function(res) {
          if (res && res.ok && res.articles) {
            articlesData = res.articles;
            articlesLoaded = true;
          }
        })
        .catch(function() {});
    }
  }, 3000);
})();
</script>
