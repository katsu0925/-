<!-- BulkLP.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>デタウリ.Detauri - アソート商品</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP',sans-serif;background:#f5f5f5;color:#333;-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:0 auto;background:#fff;min-height:100vh}

/* === A案 3-Row Header === */
.header{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;position:sticky;top:0;z-index:100;max-width:1100px;margin:0 auto}
.header-row1{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 16px;flex-wrap:nowrap}
.header-logo{font-size:15px;font-weight:800;white-space:nowrap;margin:0;letter-spacing:1px;color:#fff;flex-shrink:0}
.header-nav{display:flex;gap:6px;flex-shrink:0}
.header-nav a{color:#93c5fd;text-decoration:none;font-size:11px;padding:4px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.15);transition:all .2s;white-space:nowrap}
.header-nav a.active{background:#ffd700;color:#1a1a2e;border-color:#ffd700;font-weight:700}
.header-auth-wrap{display:none;align-items:center;gap:6px;font-size:12px;flex-shrink:1;min-width:0}
.header-row2{display:flex;justify-content:center;align-items:center;gap:8px;padding:2px 16px 4px}
.header-row3{display:flex;justify-content:center;gap:16px;padding:0 16px 6px;max-height:28px;overflow:hidden;opacity:1;transition:max-height .25s ease,opacity .25s ease,padding .25s ease}
.header-row3 a{color:#93c5fd;text-decoration:none;font-size:11px;font-weight:600;transition:color .2s;white-space:nowrap}
.header-row3 a:hover{color:#bfdbfe}
.header.row2-hidden .header-row3{max-height:0;opacity:0;padding-top:0;padding-bottom:0}
.member-badge{display:inline-block;font-size:10px;background:rgba(255,215,0,.15);color:#ffd700;padding:3px 10px;border-radius:12px;border:1px solid rgba(255,215,0,.3);white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis}

/* セクション */
.section{padding:20px}
.section-title{font-size:14px;font-weight:700;color:#1a1a2e;border-left:4px solid #ffd700;padding-left:10px;margin-bottom:14px}
.divider{height:8px;background:#f5f5f5}

/* 商品グリッド */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}

/* 商品カード */
.product-card{border:1px solid #e8e8e8;border-radius:12px;overflow:hidden;background:#fff;transition:box-shadow .2s}
.product-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08)}
.product-images{position:relative;width:100%;aspect-ratio:1/1;background:#eee;overflow:hidden;cursor:pointer}
.product-images img{width:100%;height:100%;object-fit:cover;display:none}
.product-images img.active{display:block}
.img-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.img-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.5);cursor:pointer}
.img-dot.active{background:#fff}
.img-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.3);color:#fff;border:none;width:30px;height:30px;border-radius:50%;font-size:14px;cursor:pointer;display:none}
.img-nav.prev{left:8px}
.img-nav.next{right:8px}
.product-images:hover .img-nav{display:block}
.no-image{width:100%;aspect-ratio:1/1;background:#e0e0e0;display:flex;align-items:center;justify-content:center;color:#999;font-size:13px;cursor:pointer}
.product-body{padding:14px}
.product-name{font-size:14px;font-weight:700;color:#1a1a2e}
.product-desc{font-size:12px;color:#888;margin-top:4px;line-height:1.5;display:none}
.product-tag{display:inline-block;font-size:10px;background:#fff3cd;color:#856404;padding:2px 8px;border-radius:10px;margin-top:6px;font-weight:600}
.product-bottom{display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:8px}
.product-price-area{display:flex;flex-direction:column;gap:2px;min-width:0}
.product-price{font-size:20px;font-weight:800;color:#e74c3c}
.product-price small{font-size:12px;font-weight:400;color:#999}
.product-price .original{font-size:13px;font-weight:400;color:#999;text-decoration:line-through;margin-right:6px}
.product-price .disc-badge{display:inline-block;font-size:10px;background:#e74c3c;color:#fff;padding:2px 6px;border-radius:4px;margin-left:4px;font-weight:700;vertical-align:middle}
.qty-control{display:flex;align-items:center;border:1px solid #ddd;border-radius:8px;overflow:hidden}
.qty-btn{width:36px;height:36px;border:none;background:#f5f5f5;font-size:18px;cursor:pointer;color:#555;font-weight:700}
.qty-btn:active{background:#e0e0e0}
.qty-value{width:40px;height:36px;text-align:center;border:none;border-left:1px solid #ddd;border-right:1px solid #ddd;font-size:15px;font-weight:700;color:#333;background:#fff}

/* SOLD OUT */
.product-card.sold-out{opacity:.7;position:relative}
.sold-out-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:2;pointer-events:none}
.sold-out-badge{background:rgba(0,0,0,.6);color:#fff;font-size:20px;font-weight:900;padding:10px 24px;border-radius:8px;letter-spacing:2px}
.sold-out .qty-control{opacity:.3;pointer-events:none}

/* 商品詳細モーダル */
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center;padding:20px}
.modal-overlay.active{display:flex}
.modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow:hidden;position:relative;display:flex;flex-direction:column}
.modal-close{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(0,0,0,.5);color:#fff;font-size:20px;cursor:pointer;z-index:3;display:flex;align-items:center;justify-content:center;line-height:1}
.modal-close:hover{background:rgba(0,0,0,.7)}
.modal-fixed-top{flex-shrink:0}
.modal-images{position:relative;width:100%;aspect-ratio:4/3;background:#eee;overflow:hidden}
.modal-images img{width:100%;height:100%;object-fit:contain;display:none;background:#f0f0f0}
.modal-images img.active{display:block}
.modal-images .img-nav{display:block;width:36px;height:36px;font-size:18px}
.modal-images .img-dots{bottom:12px}
.modal-images .img-dot{width:10px;height:10px}
.modal-thumbs{display:flex;gap:8px;padding:12px 16px;overflow-x:auto}
.modal-thumbs img{width:64px;height:64px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid transparent;flex-shrink:0;transition:border-color .2s}
.modal-thumbs img.active{border-color:#1a1a2e}
.modal-right{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.modal-scroll{flex:1;overflow-y:auto;min-height:0}
.modal-body{padding:20px}
.modal-body .product-name{font-size:18px;margin-bottom:8px}
.modal-body .product-desc{display:block;font-size:13px;color:#666;line-height:1.7;margin-bottom:12px;white-space:pre-wrap}
.modal-body .product-tag{margin-bottom:12px}
.modal-fixed-bottom{flex-shrink:0;padding:0 20px 20px;border-top:1px solid #eee;background:#fff}
.modal-fixed-bottom .product-bottom{display:flex;align-items:center;justify-content:space-between;padding-top:14px}
.modal-fixed-bottom .product-price{font-size:24px}

/* カート */
.cart-summary{background:#f8f9fa;border-radius:12px;padding:14px}
.cart-row{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid #eee}
.cart-row:last-child{border-bottom:none}
.cart-row.total{font-weight:800;font-size:16px;color:#1a1a2e;border-top:2px solid #1a1a2e;margin-top:8px;padding-top:12px}
.cart-empty{text-align:center;color:#aaa;font-size:13px;padding:20px 0}

/* クーポン */
.coupon-row{display:flex;gap:8px;margin-bottom:14px}
.coupon-row input{flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:13px}
.coupon-row button{padding:8px 16px;border:1px solid #1a1a2e;border-radius:8px;background:#fff;font-size:12px;font-weight:700;cursor:pointer}
.coupon-result{font-size:12px;margin-bottom:10px;padding:6px 10px;border-radius:6px;display:none}
.coupon-result.ok{background:#d4edda;color:#155724;display:block}
.coupon-result.err{background:#f8d7da;color:#721c24;display:block}

/* フォーム */
.form-group{margin-bottom:12px}
.form-label{display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px}
.form-label .req{color:#e74c3c;font-size:10px;margin-left:4px}
.form-input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#fafafa}
.form-input:focus{outline:none;border-color:#1a1a2e;background:#fff}
.form-row{display:flex;gap:10px}
.form-row .form-group{flex:1}
.form-note{font-size:11px;color:#999;margin-top:3px}

/* 決済ボタン */
.pay-button{width:100%;padding:16px;border:none;border-radius:12px;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:1px;margin-top:8px;transition:box-shadow .2s}
.pay-button:hover{box-shadow:0 4px 20px rgba(26,26,46,.3)}
.pay-button:disabled{opacity:.5;cursor:not-allowed}
.pay-methods{display:flex;justify-content:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.pay-badge{font-size:10px;color:#777;background:#f0f0f0;padding:4px 10px;border-radius:4px;font-weight:600}

/* デタウリ誘導 */
.detauri-banner{margin:20px;border-radius:12px;background:linear-gradient(135deg,#0f3460,#16213e);color:#fff;padding:20px;text-align:center}
.detauri-banner h3{font-size:15px;font-weight:700}
.detauri-banner p{font-size:12px;color:#aab;margin-top:6px;line-height:1.6}
.detauri-banner .cta-btn{display:inline-block;margin-top:12px;padding:10px 24px;background:#ffd700;color:#1a1a2e;font-weight:700;font-size:13px;border-radius:24px;text-decoration:none}

/* フッター */
.footer{background:#1a1a2e;color:#888;text-align:center;padding:20px;font-size:11px}
.footer a{color:#aab;text-decoration:none}

/* ページ遷移オーバーレイ */
#pageTransition{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);z-index:9999;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity .25s ease}
#pageTransition.active,body.page-entering #pageTransition{opacity:1;pointer-events:all}
#pageTransition .pt-content{text-align:center;color:#fff}
#pageTransition .pt-title{font-size:20px;font-weight:700;letter-spacing:2px}
#pageTransition .pt-sub{font-size:12px;color:#aab;margin-top:6px}

/* ローディング */
.loading{text-align:center;padding:60px 20px;color:#999}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid #ddd;border-top-color:#1a1a2e;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* エラー */
.error-msg{background:#f8d7da;color:#721c24;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none}

/* 管理者バー */
.admin-bar{background:#b8002a;color:#fff;text-align:center;padding:6px 14px;font-size:12px;font-weight:700;letter-spacing:1px;display:none;position:sticky;top:0;z-index:22;}
.admin-bar span{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:4px;margin-left:8px;font-size:11px;font-weight:400;}
.admin-bar .admin-exit{background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.5);color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;cursor:pointer;margin-left:10px;}
.admin-bar .admin-exit:hover{background:rgba(255,255,255,.4);}
body.admin-mode .header{border-top:3px solid #b8002a}

/* プロモバナー */
.promo-banner{background:linear-gradient(90deg,#b8002a,#e63950);color:#fff;text-align:center;padding:10px 40px 10px 14px;font-size:13px;font-weight:400;position:sticky;top:0;z-index:102;display:none;max-width:1100px;margin:0 auto}
.promo-banner a{color:#fff;text-decoration:underline;margin-left:8px;font-weight:900}
.promo-banner a:hover{color:#ffd700}
.promo-banner .promo-close{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px 8px;opacity:.8}
.promo-banner .promo-close:hover{opacity:1}

/* ヘッダー認証エリア */
.header-auth{display:flex;align-items:center;gap:6px;font-size:12px}
.auth-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:6px 16px;cursor:pointer;font-weight:700;font-size:12px;color:#fff;transition:all .2s}
.auth-btn:hover{background:rgba(255,255,255,.25)}
.auth-btn.logout{background:transparent;border:none;color:#aab;text-decoration:underline;padding:4px 8px;font-size:11px}
.auth-user{display:flex;align-items:center;gap:6px;font-size:12px;color:#fff}
.auth-user-name{font-weight:700;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.auth-discount{background:#e74c3c;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700}
.auth-points{background:#e65100;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700}
.auth-btn.mypage{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);font-size:11px;padding:4px 12px;border-radius:20px}
.cart-header-btn{position:relative;padding:4px 10px!important;font-size:16px!important;background:rgba(255,255,255,.12)!important;border:1px solid rgba(255,255,255,.3)!important;border-radius:20px!important;cursor:pointer;color:#fff;line-height:1}
.mypage-tabs{display:flex;gap:0;border-bottom:2px solid #e0e0e0;margin-bottom:16px}
.mypage-tab{background:none;border:none;padding:10px 18px;font-size:14px;font-weight:600;color:#888;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:color .2s,border-color .2s}
.mypage-tab:hover{color:#333}
.mypage-tab.active{color:#b8002a;border-bottom-color:#b8002a}
.mypage-content{min-height:120px}
.mp-order-card{border:1px solid #e8e8e8;border-radius:8px;padding:14px;margin-bottom:10px;background:#fafafa}
.mp-order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px}
.mp-order-no{font-weight:700;font-size:14px;color:#333}
.mp-order-date{font-size:12px;color:#999}
.mp-order-status{font-size:12px;padding:2px 8px;border-radius:10px;font-weight:600}
.mp-order-status.done{background:#e8f5e9;color:#2e7d32}
.mp-order-status.pending{background:#fff3e0;color:#e65100}
.mp-order-status.active{background:#e3f2fd;color:#1565c0}
.mp-order-products{font-size:12px;color:#666;line-height:1.5;margin-bottom:6px}
.mp-order-footer{display:flex;justify-content:space-between;font-size:13px;flex-wrap:wrap;gap:4px}
.mp-order-total{font-weight:700;color:#333}

/* 認証モーダル */
.auth-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1001;justify-content:center;align-items:center;padding:20px}
.auth-overlay.active{display:flex}
.auth-modal{background:#fff;border-radius:16px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto;position:relative}
.auth-modal-header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
.auth-modal-title{font-size:16px;font-weight:700;color:#1a1a2e}
.auth-modal-close{background:none;border:none;font-size:22px;cursor:pointer;padding:4px 8px;color:#999;line-height:1}
.auth-modal-body{padding:20px}
.auth-field{margin-bottom:12px}
.auth-field label{display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px}
.auth-field input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#fafafa}
.auth-field input:focus{outline:none;border-color:#1a1a2e;background:#fff}
.auth-submit{width:100%;padding:14px;border:none;border-radius:10px;background:#1a1a2e;color:#fff;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px}
.auth-submit:hover{background:#16213e}
.auth-submit:disabled{opacity:.5;cursor:not-allowed}
.auth-switch{text-align:center;margin-top:14px;font-size:13px;color:#666}
.auth-switch a{color:#1a1a2e;font-weight:700;text-decoration:none}
.auth-error{background:#f8d7da;color:#721c24;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;display:none}
.pw-wrap{position:relative;display:flex;align-items:center}
.pw-wrap input{flex:1;padding-right:38px}
.pw-toggle{position:absolute;right:6px;background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:.5;line-height:1}
.pw-toggle:hover{opacity:.8}

/* 管理設定FAB */
.admin-settings-fab{position:fixed;left:16px;bottom:76px;z-index:31;width:48px;height:48px;border-radius:50%;background:#b8002a;color:#fff;border:none;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.3);font-size:22px;transition:transform .2s;}
.admin-settings-fab:hover{transform:scale(1.1);}
body.admin-mode .admin-settings-fab{display:flex;}
.settings-panel{position:fixed;left:16px;bottom:136px;z-index:55;width:min(380px,90vw);background:#fff;border-radius:14px;border:1px solid #e6e8ee;box-shadow:0 10px 30px rgba(0,0,0,.25);display:none;overflow:hidden;}
.settings-panel.open{display:block;}
.settings-panel .sp-header{padding:12px 14px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;background:#f8f9fa;}
.settings-panel .sp-title{font-weight:900;font-size:15px;}
.settings-panel .sp-close{background:transparent;border:none;font-size:20px;cursor:pointer;padding:4px 8px;line-height:1;}
.settings-panel .sp-body{padding:12px 14px;overflow:auto;max-height:60vh;}
.settings-panel .sp-section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid #f0f0f0;}
.settings-panel .sp-section:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none;}
.settings-panel .sp-section-title{font-weight:900;font-size:13px;margin-bottom:8px;color:#333;}
.settings-panel .sp-btn-row{display:flex;gap:8px;flex-wrap:wrap;}
.settings-panel .sp-btn{padding:8px 10px;border:1px solid #d9deea;border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:12px;}
.settings-panel .sp-btn.primary{background:#111;color:#fff;border-color:#111;}
.settings-panel .sp-btn:disabled{opacity:.5;cursor:not-allowed;}
.settings-panel .sp-mode-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.settings-panel .sp-badge{display:inline-block;padding:3px 8px;border-radius:6px;font-weight:900;font-size:12px;}
.settings-panel .sp-badge.test{background:#fff3cd;color:#856404;border:1px solid #ffc107;}
.settings-panel .sp-badge.live{background:#d4edda;color:#155724;border:1px solid #28a745;}
.settings-panel .sp-badge.on{background:#d4edda;color:#155724;border:1px solid #28a745;}
.settings-panel .sp-badge.off{background:#f8d7da;color:#721c24;border:1px solid #dc3545;}
.settings-panel .sp-info{font-size:11px;color:#666;margin-top:4px;}
.settings-panel .sp-log{font-size:11px;color:#333;white-space:pre-wrap;line-height:1.4;margin-top:8px;max-height:80px;overflow:auto;background:#f8f9fa;border-radius:6px;padding:6px 8px;display:none;}

/* モーダル（特商法・お問い合わせ） */
.bulk-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:500;}
.bulk-overlay.active{display:block;}
.bulk-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;width:min(700px,94vw);max-height:85vh;overflow-y:auto;z-index:501;box-shadow:0 12px 40px rgba(0,0,0,.2);}
.bulk-modal-header{padding:14px 18px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:1;border-radius:16px 16px 0 0;}
.bulk-modal-title{font-size:16px;font-weight:700;color:#1a1a2e;}
.bulk-modal-close{background:none;border:none;font-size:22px;cursor:pointer;padding:4px 8px;color:#999;line-height:1;}
.bulk-modal-body{padding:18px;}

/* スクロールトップボタン */
.toTop{position:fixed;right:14px;bottom:144px;width:46px;height:46px;border-radius:999px;border:1px solid #d9deea;background:#fff;display:none;align-items:center;justify-content:center;font-weight:900;z-index:70;box-shadow:0 6px 18px rgba(0,0,0,.12);transition:all .3s ease;}
.toTop.show{display:flex;}

/* チャットボット */
.chatbot-fab{position:fixed;bottom:80px;right:16px;z-index:9999;width:56px;height:56px;border-radius:50%;background:#1e293b;color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;transition:transform .2s,background .2s;}
.chatbot-fab:hover{transform:scale(1.08);background:#334155;}
.chatbot-fab svg{width:28px;height:28px;fill:#fff;}
.chatbot-fab .chatbot-fab-close{display:none;}
.chatbot-badge{position:absolute;top:-2px;right:-2px;width:18px;height:18px;border-radius:50%;background:#ef4444;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .2s;}
.chatbot-badge.show{opacity:1;}
.chatbot-panel{position:fixed;bottom:148px;right:16px;z-index:9998;width:360px;max-width:calc(100vw - 32px);height:480px;max-height:calc(100vh - 200px);background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.18);display:none;flex-direction:column;overflow:hidden;border:1px solid #e6e8ee;}
.chatbot-panel.open{display:flex;}
.chatbot-header{background:#1e293b;color:#fff;padding:14px 16px;font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.chatbot-header-actions{display:flex;align-items:center;gap:6px;margin-left:auto;}
.chatbot-header-toTop{width:30px;height:30px;border-radius:50%;border:1.5px solid rgba(255,255,255,.35);background:transparent;color:#fff;font-weight:900;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.chatbot-header-toTop:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.6);}
.chatbot-close-btn{width:30px;height:30px;border-radius:50%;border:1.5px solid rgba(255,255,255,.35);background:transparent;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;line-height:1;}
.chatbot-close-btn:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.6);}
.chatbot-header svg{width:20px;height:20px;fill:#fff;flex-shrink:0;}
.chatbot-messages{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;}
.chatbot-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55;word-break:break-word;white-space:pre-wrap;}
.chatbot-msg.bot{align-self:flex-start;background:#f1f5f9;color:#1e293b;border-bottom-left-radius:4px;}
.chatbot-msg.user{align-self:flex-end;background:#1e293b;color:#fff;border-bottom-right-radius:4px;}
.chatbot-msg.typing{align-self:flex-start;background:#f1f5f9;padding:10px 18px;}
.chatbot-msg.typing .dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#94a3b8;margin:0 2px;animation:chatDot 1.4s infinite both;}
.chatbot-msg.typing .dot:nth-child(2){animation-delay:.2s;}
.chatbot-msg.typing .dot:nth-child(3){animation-delay:.4s;}
@keyframes chatDot{0%,80%,100%{opacity:.3;transform:scale(.8);}40%{opacity:1;transform:scale(1);}}
.chatbot-input-area{display:flex;gap:8px;padding:10px 12px;border-top:1px solid #e6e8ee;background:#fafbfc;flex-shrink:0;}
.chatbot-input-area textarea{flex:1;border:1px solid #d9deea;border-radius:10px;padding:9px 12px;font-size:13px;resize:none;outline:none;font-family:inherit;min-height:38px;max-height:80px;line-height:1.4;}
.chatbot-input-area textarea:focus{border-color:#1e293b;}
.chatbot-send-btn{width:38px;height:38px;border-radius:10px;border:none;background:#1e293b;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s;}
.chatbot-send-btn:hover{background:#334155;}
.chatbot-send-btn:disabled{opacity:.4;cursor:not-allowed;}
.chatbot-send-btn svg{width:18px;height:18px;fill:#fff;}
.chatbot-quick-replies{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
.chatbot-quick-btn{display:inline-block;padding:7px 13px;border-radius:18px;border:1.5px solid #e2e8f0;background:#fff;color:#334155;font-size:12px;cursor:pointer;transition:all .15s;white-space:nowrap;font-weight:500;}
.chatbot-quick-btn:hover{background:#eff6ff;border-color:#93c5fd;color:#2563eb;}
.chatbot-quick-category{font-size:11px;color:#64748b;font-weight:600;margin-top:8px;margin-bottom:2px;padding-left:2px;}
.chatbot-quick-category:first-child{margin-top:0;}
.chatbot-contact-link{display:inline-flex;align-items:center;gap:4px;margin-top:10px;padding:8px 16px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;color:#dc2626;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;text-decoration:none;}
.chatbot-contact-link:hover{background:#fee2e2;border-color:#f87171;}
.chatbot-contact-form{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-top:6px;}
.chatbot-contact-form label{display:block;font-size:11px;font-weight:600;color:#555;margin-bottom:3px;margin-top:8px;}
.chatbot-contact-form label:first-child{margin-top:0;}
.chatbot-contact-form input,.chatbot-contact-form textarea{width:100%;padding:8px 10px;border:1px solid #d9deea;border-radius:8px;font-size:13px;font-family:inherit;box-sizing:border-box;}
.chatbot-contact-form textarea{resize:none;min-height:60px;}
.chatbot-contact-form input:focus,.chatbot-contact-form textarea:focus{border-color:#1e293b;outline:none;}
.chatbot-contact-btn{display:inline-block;margin-top:10px;padding:8px 18px;border:none;border-radius:8px;background:#1e293b;color:#fff;font-size:13px;font-weight:700;cursor:pointer;}
.chatbot-contact-btn:disabled{opacity:.5;cursor:not-allowed;}
.chatbot-staff-btn{display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:7px 14px;border:1px solid #1e293b;border-radius:8px;background:#fff;color:#1e293b;font-size:12px;font-weight:600;cursor:pointer;}
.chatbot-staff-btn:hover{background:#f1f5f9;}
@media(max-width:480px){.chatbot-panel{bottom:0;right:0;left:0;width:100%;max-width:100%;height:100%;max-height:100%;border-radius:0;}.chatbot-fab{bottom:72px;right:12px;width:50px;height:50px;}.chatbot-fab svg{width:24px;height:24px;}}

/* PC レスポンシブ */
@media(min-width:768px){
  body{background:#e0e0e0}
  .container{max-width:1100px;border-radius:0;box-shadow:none}
  .header-row1{padding:10px 24px}
  .header-logo{font-size:17px}
  .header-nav a{font-size:12px;padding:5px 14px}
  .header-auth-wrap{display:flex}
  .header-row2{display:none}
  .header-row3{padding:0 24px 8px;gap:20px}
  .header-row3 a{font-size:12px}
  .section{padding:28px 40px}
  .product-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
  .product-card{margin-bottom:0}
  .product-body{padding:16px}
  .product-name{font-size:15px}
  .product-price{font-size:18px}
  .product-price small{font-size:11px}
  .qty-btn{width:32px;height:32px;font-size:16px}
  .qty-value{width:36px;height:32px;font-size:14px}
  .pc-two-col{display:grid;grid-template-columns:1fr 1fr;gap:32px;align-items:start}
  .cart-summary{padding:18px}
  .detauri-banner{margin:28px 40px}
  .modal-content{max-width:900px;flex-direction:row;max-height:80vh}
  .modal-fixed-top{width:50%;flex-shrink:0;display:flex;flex-direction:column}
  .modal-images{aspect-ratio:1/1}
  .modal-right{width:50%;display:flex;flex-direction:column;overflow:hidden}
  .modal-scroll{flex:1;overflow-y:auto}
  .modal-fixed-bottom{flex-shrink:0}
  .modal-close{top:8px;right:8px}
}

@media(min-width:560px) and (max-width:767px){
  body{display:flex;justify-content:center;padding:20px;background:#e0e0e0}
  .container{border-radius:20px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.15)}
  .product-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .product-card{margin-bottom:0}
}

@media(max-width:559px){
  .product-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .product-body{padding:10px}
  .product-name{font-size:12px}
  .product-bottom{flex-direction:column;align-items:flex-start}
  .product-price{font-size:16px}
  .product-price small{font-size:10px}
  .product-price .original{font-size:11px}
  .qty-control{margin-top:6px}
  .qty-btn{width:30px;height:30px;font-size:14px}
  .qty-value{width:32px;height:30px;font-size:12px}
}
</style>
</head>
<body>
<script>(function(){try{if(sessionStorage.getItem('_pageTransition')==='1'){document.body.style.background='#1a1a2e';document.body.classList.add('page-entering');sessionStorage.removeItem('_pageTransition');}}catch(e){}})()</script>
<!-- 管理者バー -->
<div class="admin-bar" id="adminBar">管理者モード<span>アソート商品</span><button class="admin-exit" id="adminExit" type="button">管理者モード解除</button></div>

<!-- プロモバナー -->
<div class="promo-banner" id="promoBanner">
  期間限定：会員登録で全品<strong>10%OFF</strong>（2026年9月末まで・30点割引と併用可）<a href="#" id="promoRegisterLink">今すぐ無料登録 ＞</a>
  <button class="promo-close" id="promoClose" type="button">✕</button>
</div>

<div id="pageTransition"><div class="pt-content"><div class="pt-title">デタウリ.Detauri</div><div class="pt-sub">読み込み中...</div></div></div>

<!-- ヘッダー -->
<header class="header">
  <div class="header-row1">
    <h1 class="header-logo" id="appTitle">デタウリ.Detauri</h1>
    <nav class="header-nav">
      <a id="detauriLink" href="./">採寸付き個品（デタウリ）</a>
      <a class="active" href="#">アソート商品</a>
    </nav>
    <div class="header-auth-wrap">
      <div class="header-auth" id="headerAuth">
        <button class="auth-btn" id="openAuthBtn" type="button">ログイン / 新規登録</button>
      </div>
    </div>
  </div>
  <div class="header-row2">
    <div class="header-auth" id="headerAuthMob">
      <button class="auth-btn" id="openAuthBtnMob" type="button">ログイン / 新規登録</button>
    </div>
  </div>
  <div class="header-row3">
    <a href="#" id="openBulkGuideLink">商品ガイド</a>
    <a href="#" id="openBulkShippingLink">アソート送料表</a>
    <a href="#" id="openContactLinkHeader">お問い合わせ</a>
  </div>
</header>

<div class="container">

<!-- 認証モーダル -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-modal">
    <div class="auth-modal-header">
      <div class="auth-modal-title" id="authModalTitle">ログイン</div>
      <button class="auth-modal-close" id="authCloseBtn" type="button">&times;</button>
    </div>
    <div class="auth-modal-body">
      <div class="auth-error" id="authError"></div>
      <!-- ログインフォーム -->
      <div id="loginForm">
        <div class="auth-field">
          <label>メールアドレス</label>
          <input id="loginEmail" type="email" autocomplete="email">
        </div>
        <div class="auth-field">
          <label>パスワード</label>
          <div class="pw-wrap"><input id="loginPassword" type="password" autocomplete="current-password"><button type="button" class="pw-toggle" onclick="togglePw(this)">&#x1F441;</button></div>
        </div>
        <div class="auth-field" style="margin-top:-4px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:400;font-size:13px;">
            <input type="checkbox" id="rememberMe" style="width:16px;height:16px;">
            ログイン状態を保持する（30日間）
          </label>
        </div>
        <button class="auth-submit" id="loginBtn" type="button">ログイン</button>
        <div class="auth-switch">アカウントをお持ちでない方は <a href="#" id="showRegisterLink">新規登録</a></div>
        <div style="text-align:center;margin-top:8px;font-size:12px;color:#888;">
          <a href="#" id="showForgotPwLink" style="color:#666;">パスワードを忘れた方</a>
          <span style="margin:0 6px;">|</span>
          <a href="#" id="showForgotEmailLink" style="color:#666;">メールアドレスを忘れた方</a>
        </div>
      </div>
      <!-- パスワードリセットフォーム -->
      <div id="forgotPwForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">登録済みのメールアドレスを入力してください。仮パスワードをメールでお送りします。</p>
        <div class="auth-field">
          <label>メールアドレス</label>
          <input id="resetEmail" type="email" autocomplete="email">
        </div>
        <button class="auth-submit" id="resetPwBtn" type="button">仮パスワードを送信</button>
        <div class="auth-switch"><a href="#" id="backToLoginFromReset">ログインに戻る</a></div>
      </div>
      <!-- メールアドレス確認フォーム -->
      <div id="forgotEmailForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">ご登録時の会社名/氏名と電話番号を入力してください。登録メールアドレスのヒントを表示します。</p>
        <div class="auth-field">
          <label>会社名/氏名</label>
          <input id="recoverCompanyName" type="text">
        </div>
        <div class="auth-field">
          <label>電話番号</label>
          <input id="recoverPhone" type="tel" inputmode="numeric">
        </div>
        <div id="recoverEmailResult" style="display:none;margin:12px 0;padding:12px;background:#f0f7ff;border-radius:6px;font-size:14px;text-align:center;"></div>
        <button class="auth-submit" id="recoverEmailBtn" type="button">メールアドレスを確認</button>
        <div class="auth-switch"><a href="#" id="backToLoginFromRecover">ログインに戻る</a></div>
      </div>
      <!-- 登録フォーム -->
      <div id="registerForm" style="display:none;">
        <div class="auth-field">
          <label>メールアドレス *</label>
          <input id="regEmail" type="email" autocomplete="email">
        </div>
        <div class="auth-field">
          <label>パスワード（6文字以上） *</label>
          <div class="pw-wrap"><input id="regPassword" type="password" autocomplete="new-password"><button type="button" class="pw-toggle" onclick="togglePw(this)">&#x1F441;</button></div>
        </div>
        <div class="auth-field">
          <label>会社名/氏名 *</label>
          <input id="regCompanyName" type="text" autocomplete="name">
        </div>
        <div class="auth-field">
          <label>電話番号</label>
          <input id="regPhone" type="tel" inputmode="numeric">
        </div>
        <div class="auth-field">
          <label>郵便番号</label>
          <input id="regPostal" type="text" inputmode="numeric" placeholder="0000000">
        </div>
        <div class="auth-field">
          <label>住所</label>
          <input id="regAddress" type="text" autocomplete="street-address">
        </div>
        <div class="auth-field">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
            <input type="checkbox" id="regNewsletter" checked style="width:18px;height:18px;">
            <span>お得な情報をメールで受け取る</span>
          </label>
        </div>
        <button class="auth-submit" id="registerBtn" type="button">登録する</button>
        <div class="auth-switch">既にアカウントをお持ちの方は <a href="#" id="showLoginLink">ログイン</a></div>
      </div>
    </div>
  </div>
</div>

<!-- 商品一覧 -->
<section class="section" id="productSection">
  <div class="section-title">アソート商品</div>
  <div class="product-grid" id="productList">
    <div class="loading"><div class="spinner"></div><div>読み込み中...</div></div>
  </div>
</section>

<!-- 商品詳細モーダル -->
<div class="modal-overlay" id="productModal" onclick="closeModalOverlay(event)">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div class="modal-fixed-top">
      <div class="modal-images" id="modalImages"></div>
      <div class="modal-thumbs" id="modalThumbs"></div>
    </div>
    <div class="modal-right">
      <div class="modal-scroll">
        <div class="modal-body" id="modalBody"></div>
      </div>
      <div class="modal-fixed-bottom" id="modalBottom"></div>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- カート・フォーム（PC: 2カラム） -->
<div class="pc-two-col section">
<div>

<!-- カート -->
<div>
  <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;">
    <span>ご注文内容</span>
    <div id="cartClearBtns" style="display:none;gap:6px;flex-wrap:wrap;"></div>
  </div>
  <div id="cartSection">
    <div class="cart-empty">商品を選択してください</div>
  </div>
</div>

<div style="height:20px"></div>

<!-- クーポン -->
<div>
  <div class="section-title">クーポン</div>
  <div class="coupon-row">
    <input type="text" id="couponInput" placeholder="クーポンコードを入力" style="text-transform:uppercase">
    <button onclick="applyCoupon()">適用</button>
  </div>
  <div class="coupon-result" id="couponResult"></div>
</div>

</div>
<div>

<!-- お届先情報 -->
<div>
  <div class="section-title">お届先情報</div>
  <div class="error-msg" id="formError"></div>

  <div class="form-group">
    <label class="form-label">会社名 / 氏名<span class="req">必須</span></label>
    <input class="form-input" type="text" id="companyName" placeholder="例：山田太郎">
  </div>

  <div class="form-group">
    <label class="form-label">メールアドレス<span class="req">必須</span></label>
    <input class="form-input" type="email" id="contact" placeholder="example@mail.com">
  </div>

  <div class="form-row">
    <div class="form-group" style="flex:.4">
      <label class="form-label">郵便番号<span class="req">必須</span></label>
      <input class="form-input" type="text" id="postal" placeholder="000-0000" maxlength="8">
    </div>
    <div class="form-group" style="flex:.6">
      <label class="form-label">電話番号<span class="req">必須</span></label>
      <input class="form-input" type="tel" id="phone" placeholder="090-0000-0000">
    </div>
  </div>

  <div class="form-group">
    <label class="form-label">住所<span class="req">必須</span></label>
    <input class="form-input" type="text" id="address" placeholder="都道府県・市区町村・番地">
    <div class="form-note">※ 郵便番号入力で住所が自動入力されます</div>
  </div>

  <div class="form-group">
    <label class="form-label">建物名・部屋番号</label>
    <input class="form-input" type="text" id="building" placeholder="マンション名・号室など">
  </div>

  <div class="form-group">
    <label class="form-label">備考</label>
    <input class="form-input" type="text" id="note" placeholder="備考がありましたらご記入ください">
  </div>

  <!-- 決済ボタン -->
  <button class="pay-button" id="payButton" onclick="submitOrder()" disabled>
    カートが空です
  </button>

  <div class="pay-methods">
    <span class="pay-badge">クレジットカード</span>
    <span class="pay-badge">コンビニ払い</span>
    <span class="pay-badge">銀行振込</span>
    <span class="pay-badge">PayPay</span>
  </div>
</div>

</div>
</div>

<div class="divider"></div>

<!-- デタウリ誘導 -->
<div class="detauri-banner">
  <h3>1点ずつ選びたい方はこちら</h3>
  <p>全品採寸データ付き。サイズ・ブランド・状態を確認しながら1点ずつお選びいただけます。</p>
  <a id="detauriBannerLink" class="cta-btn" href="./">デタウリで商品を見る →</a>
</div>

<!-- 管理設定FAB + パネル -->
<button class="admin-settings-fab" id="adminSettingsFab" type="button" title="管理設定">&#9881;</button>
<div class="settings-panel" id="settingsPanel">
  <div class="sp-header">
    <div class="sp-title">管理設定</div>
    <button class="sp-close" id="settingsClose" type="button">&times;</button>
  </div>
  <div class="sp-body">
    <div class="sp-section">
      <div class="sp-section-title">管理</div>
      <div class="sp-btn-row">
        <button class="sp-btn primary" id="spBtnCompact" type="button">期限切れ確保の整理</button>
        <button class="sp-btn" id="spBtnRebuild" type="button">状態の再構築</button>
      </div>
      <div class="sp-btn-row" style="margin-top:6px;">
        <button class="sp-btn" id="spBtnClearCache" type="button">商品キャッシュ削除</button>
        <button class="sp-btn" id="spBtnApplyDv" type="button">ステータスのプルダウン適用</button>
      </div>
      <div class="sp-log" id="spLog"></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">KOMOJU 決済モード</div>
      <div class="sp-mode-row">
        <span class="sp-badge" id="spModeBadge">読込中...</span>
        <button class="sp-btn primary" id="spBtnToggleMode" type="button" disabled>切替</button>
      </div>
      <div class="sp-info" id="spModeKeys"></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">会員割引</div>
      <div class="sp-mode-row">
        <span class="sp-badge" id="spDiscountBadge">読込中...</span>
        <button class="sp-btn primary" id="spBtnToggleDiscount" type="button" disabled>切替</button>
      </div>
      <div class="sp-info" id="spDiscountInfo"></div>
    </div>
  </div>
</div>

<!-- 商品ガイドモーダル -->
<div class="bulk-overlay" id="bulkGuideOverlay"></div>
<div class="bulk-modal" id="bulkGuideModal" style="display:none;">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">商品ガイド</div>
    <button class="bulk-modal-close" id="bulkGuideCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body" style="line-height:1.7;">
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">アソート商品について</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li>アソート商品はカテゴリ・ブランドごとにまとめた古着セットです</li>
        <li>写真はサンプルイメージです。実物と多少異なる場合があります</li>
      </ul>
    </div>
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ご注文について</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li style="margin-bottom:8px;">数量を選んでカートに追加してください</li>
        <li>送料はお届け先に応じて自動計算されます（ダイヤモンド会員は送料無料）</li>
      </ul>
    </div>
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ご注文の流れ</h3>
      <ol style="margin:0;padding-left:20px;color:#475569;">
        <li style="margin-bottom:8px;"><strong>商品選択</strong>：数量を決めてカートに追加</li>
        <li style="margin-bottom:8px;"><strong>お届け先入力</strong>：住所を入力すると送料が自動表示されます</li>
        <li style="margin-bottom:8px;"><strong>お支払い</strong>：商品代＋送料をオンライン決済<br><span style="font-size:12px;color:#888;">※コンビニ決済は別途手数料220円、銀行振込・ペイジーの振込手数料はお客様負担</span></li>
        <li><strong>発送</strong>：決済完了後、商品を発送いたします</li>
      </ol>
    </div>
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">割引について</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li><strong>会員割引</strong>：会員登録で<span style="color:#b8002a;font-weight:700;">10%OFF</span><span style="color:#666;font-size:13px;">（2026年9月末まで）</span></li>
      </ul>
    </div>
    <div>
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">注意事項</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li>ご注文確定後のキャンセル・変更はできません</li>
        <li>返品・交換は原則お受けしておりません。万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください</li>
      </ul>
    </div>
  </div>
</div>

<!-- アソート送料表モーダル -->
<div class="bulk-overlay" id="bulkShippingOverlay"></div>
<div class="bulk-modal" id="bulkShippingModal" style="display:none;width:min(800px,96vw);">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">アソート送料表</div>
    <button class="bulk-modal-close" id="bulkShippingCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body" style="line-height:1.7;">
    <!-- 西日本 -->
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f472b6;padding-bottom:8px;">西日本（南九州〜北陸）</h3>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
          <tr style="background:#fce7f3;">
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;width:80px;">宅配便</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">南九州</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">北九州</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">四国</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">中国</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">関西</th>
            <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">北陸</th>
          </tr>
          <tr style="background:#fdf2f8;font-size:10px;color:#6b7280;">
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">都道府県</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">鹿児島・熊本・宮崎</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">福岡・佐賀・大分・長崎</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">香川・愛媛・高知・徳島</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">広島・岡山・島根・山口・鳥取</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">大阪・兵庫・京都・奈良・和歌山・滋賀</td>
            <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">石川・福井・富山</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">宅配便（大）</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,700円</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,620円</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,440円</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,480円</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,260円</td>
            <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,420円</td>
          </tr>
        </table>
      </div>
    </div>
    <!-- 東日本 -->
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #67e8f9;padding-bottom:8px;">東日本（東海〜北海道）</h3>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
          <tr style="background:#cffafe;">
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;width:80px;">宅配便</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">東海</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">信越</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">関東</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">南東北</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">北東北</th>
            <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">北海道</th>
          </tr>
          <tr style="background:#ecfeff;font-size:10px;color:#6b7280;">
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">都道府県</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">愛知・静岡・岐阜・三重</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">新潟・長野</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">東京・神奈川・埼玉・千葉・茨城・栃木・群馬・山梨</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">宮城・福島・山形</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">岩手・秋田・青森</td>
            <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">北海道</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">宅配便（大）</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,440円</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,540円</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,680円</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,900円</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,980円</td>
            <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">2,380円</td>
          </tr>
        </table>
      </div>
    </div>
    <!-- 沖縄 -->
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">沖縄本島</h3>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;max-width:300px;">
          <tr style="background:#fef3c7;">
            <th style="padding:8px;text-align:center;border:1px solid #fcd34d;width:80px;">宅配便</th>
            <th style="padding:8px;text-align:center;border:1px solid #fcd34d;">沖縄本島</th>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #fcd34d;text-align:center;font-weight:700;background:#fffbeb;">宅配便（大）</td>
            <td style="padding:8px;border:1px solid #fcd34d;text-align:center;">3,500円</td>
          </tr>
        </table>
      </div>
      <p style="margin:8px 0 0;color:#b45309;font-size:12px;">※ 沖縄県の離島（宮古島・石垣島等）は配送対象外です。</p>
    </div>
    <!-- サイズ目安 -->
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">サイズの目安</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;font-size:13px;">
        <li><strong>宅配便（大）</strong>：1〜40着程度</li>
      </ul>
    </div>
    <!-- 配送について -->
    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">配送について</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li>上記送料は全て<strong>税込み</strong>です</li>
        <li>会員割引は商品代のみに適用されます（<strong>送料は割引対象外</strong>）</li>
        <li>発送はお支払い確認後<strong>2〜5営業日</strong>以内</li>
        <li>配送業者：佐川急便・ヤマト運輸・郵便局のいずれか（指定不可）</li>
        <li>日時指定不可</li>
        <li style="color:#b8002a;"><strong>離島への配送は対象外です</strong></li>
      </ul>
    </div>
    <!-- 決済手数料 -->
    <div>
      <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">お客様ご負担の決済手数料</h3>
      <ul style="margin:0;padding-left:20px;color:#475569;">
        <li><strong>コンビニ決済</strong>：220円（税込）の決済手数料がかかります</li>
        <li><strong>銀行振込</strong>：振込手数料はお客様のご負担となります（金額は金融機関により異なります）</li>
        <li><strong>ペイジー</strong>：振込手数料はお客様のご負担となります（金額は金融機関により異なります）</li>
        <li style="color:#888;">クレジットカード・PayPay・Apple Pay：手数料はかかりません</li>
      </ul>
    </div>
  </div>
</div>

<!-- 特定商取引法モーダル -->
<div class="bulk-overlay" id="legalOverlay"></div>
<div class="bulk-modal" id="legalModal" style="display:none;">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">特定商取引法に基づく表記</div>
    <button class="bulk-modal-close" id="legalCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body" style="line-height:1.7;">
    <table style="width:100%;border-collapse:collapse;font-size:14px;">
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;width:140px;vertical-align:top;">販売業者</th><td style="padding:12px;border:1px solid #e2e8f0;">西出克利</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">運営統括責任者</th><td style="padding:12px;border:1px solid #e2e8f0;">西出克利</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">所在地</th><td style="padding:12px;border:1px solid #e2e8f0;">大阪府大東市灰塚4-16-15</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">電話番号</th><td style="padding:12px;border:1px solid #e2e8f0;">090-5820-1803</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">メールアドレス</th><td style="padding:12px;border:1px solid #e2e8f0;">nkonline1030@gmail.com</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">営業時間</th><td style="padding:12px;border:1px solid #e2e8f0;">平日 10:00〜18:00<br><span style="font-size:12px;color:#888;">※土日祝は発送・事務処理休み（メッセージ返信は対応可）</span></td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">販売価格</th><td style="padding:12px;border:1px solid #e2e8f0;">各商品ページに表示された価格（税込）</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">送料</th><td style="padding:12px;border:1px solid #e2e8f0;">地域・サイズにより異なります。</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">支払方法</th><td style="padding:12px;border:1px solid #e2e8f0;">クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）、コンビニ決済、銀行振込、PayPay、ペイジー、Apple Pay</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">支払時期</th><td style="padding:12px;border:1px solid #e2e8f0;">クレジットカード・PayPay・Apple Pay：ご注文時に決済<br>コンビニ決済：ご注文後3日以内にお支払い<br>銀行振込・ペイジー：ご注文後3日以内にお振込み</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">お客様負担の手数料</th><td style="padding:12px;border:1px solid #e2e8f0;">コンビニ決済：<strong>220円（税込）</strong><br>銀行振込・ペイジー：<strong>振込手数料</strong>はお客様負担<br><span style="font-size:12px;color:#888;">※クレジットカード・PayPay・Apple Pay：手数料なし</span></td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">商品引渡し時期</th><td style="padding:12px;border:1px solid #e2e8f0;">ご入金確認後、2〜5営業日以内に発送</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">返品・交換</th><td style="padding:12px;border:1px solid #e2e8f0;">原則として返品・交換はお受けしておりません。<br>万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。</td></tr>
      <tr><th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">返金について</th><td style="padding:12px;border:1px solid #e2e8f0;">当方の都合による返金の場合、ご利用の決済方法に応じて返金処理を行います。</td></tr>
    </table>
  </div>
</div>

<!-- お問い合わせモーダル -->
<div class="bulk-overlay" id="contactOverlay"></div>
<div class="bulk-modal" id="contactModal" style="display:none;width:min(500px,94vw);">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">お問い合わせ</div>
    <button class="bulk-modal-close" id="contactCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body">
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#475569;line-height:1.6;">
      <strong>営業時間</strong>：平日 10:00〜18:00（土日祝は発送・事務処理休み）<br>
      メッセージへの返信は土日祝も対応しております。2営業日以内にご返信いたします。
    </div>
    <div style="margin-bottom:12px;"><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">お名前 *</label><input type="text" id="contactName" placeholder="会社名/氏名" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;"></div>
    <div style="margin-bottom:12px;"><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">メールアドレス *</label><input type="email" id="contactEmail" placeholder="返信先メールアドレス" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;"></div>
    <div style="margin-bottom:12px;"><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">お問い合わせ内容 *</label><textarea id="contactMessage" rows="6" placeholder="お問い合わせ内容をご記入ください" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical;"></textarea></div>
    <div style="text-align:right;"><button id="contactSubmitBtn" type="button" style="padding:10px 24px;border:none;border-radius:10px;background:#1a1a2e;color:#fff;font-size:14px;font-weight:700;cursor:pointer;">送信</button></div>
  </div>
</div>

<!-- マイページモーダル -->
<div class="bulk-overlay" id="myPageOverlay"></div>
<div class="bulk-modal" id="myPageModal" style="display:none;width:min(600px,96vw);">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">マイページ</div>
    <button class="bulk-modal-close" id="myPageCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body">
    <div class="mypage-tabs">
      <button class="mypage-tab active" data-tab="profile" type="button">プロフィール</button>
      <button class="mypage-tab" data-tab="orders" type="button">注文履歴</button>
      <button class="mypage-tab" data-tab="points" type="button">ポイント</button>
    </div>
    <!-- プロフィールタブ -->
    <div class="mypage-content" id="mypageProfile">
      <div style="display:grid;grid-template-columns:1fr;gap:10px;">
        <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">メールアドレス</label><input id="mpEmail" type="email" readonly style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#f5f5f5;"></div>
        <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">会社名/氏名 *</label><input id="mpCompanyName" type="text" readonly style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#f5f5f5;"></div>
        <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">電話番号</label><input id="mpPhone" type="tel" inputmode="numeric" readonly style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#f5f5f5;"></div>
        <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">郵便番号</label><input id="mpPostal" type="text" inputmode="numeric" readonly style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#f5f5f5;"></div>
        <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">住所</label><input id="mpAddress" type="text" readonly style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#f5f5f5;"></div>
        <div><label style="font-size:12px;color:#999;">登録日: <span id="mpRegisteredAt">-</span></label></div>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="mpEditBtn" type="button" style="padding:8px 16px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;">編集</button>
        <button id="mpSaveBtn" type="button" style="display:none;padding:8px 16px;border:none;border-radius:8px;background:#1a1a2e;color:#fff;cursor:pointer;font-size:13px;font-weight:600;">変更を保存</button>
        <button id="mpCancelEditBtn" type="button" style="display:none;padding:8px 16px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;">キャンセル</button>
        <button id="mpTogglePasswordBtn" type="button" style="padding:8px 16px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;">パスワード変更</button>
      </div>
      <div id="mpPasswordSection" style="display:none;margin-top:14px;padding:14px;background:#f9f9f9;border-radius:8px;">
        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">現在のパスワード *</label><input id="mpCurPass" type="password" style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;"></div>
          <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">新しいパスワード（6文字以上） *</label><input id="mpNewPass" type="password" style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;"></div>
          <div><label style="display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;">新しいパスワード（確認） *</label><input id="mpNewPassConfirm" type="password" style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;"></div>
        </div>
        <button id="mpChangePassBtn" type="button" style="margin-top:10px;padding:8px 16px;border:none;border-radius:8px;background:#1a1a2e;color:#fff;cursor:pointer;font-size:13px;font-weight:600;">パスワードを変更</button>
      </div>
    </div>
    <!-- 注文履歴タブ -->
    <div class="mypage-content" id="mypageOrders" style="display:none;">
      <div id="mpOrderList" style="font-size:13px;color:#666;">読み込み中...</div>
    </div>
    <!-- ポイント・統計タブ -->
    <div class="mypage-content" id="mypagePoints" style="display:none;">
      <div id="mpRankCard" style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:12px;padding:20px;color:#fff;margin-bottom:16px;position:relative;overflow:hidden;">
        <div style="font-size:11px;opacity:0.7;">現在のランク</div>
        <div id="mpRankName" style="font-size:28px;font-weight:900;margin:4px 0;">-</div>
        <div id="mpRankPointRate" style="font-size:13px;opacity:0.9;">ポイント還元率: -</div>
        <div id="mpRankBenefits" style="font-size:12px;opacity:0.8;margin-top:4px;"></div>
        <div id="mpRankProgress" style="margin-top:12px;"></div>
      </div>
      <div style="text-align:center;padding:16px 0;">
        <div style="font-size:13px;color:#888;">ポイント残高</div>
        <div id="mpPointBalance" style="font-size:40px;font-weight:bold;color:#b8002a;margin:8px 0;">0</div>
        <div style="font-size:12px;color:#aaa;">1ポイント = 1円としてご利用いただけます</div>
      </div>
      <div style="border-top:1px solid #eee;padding-top:16px;margin-top:8px;">
        <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">ご利用状況</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:#888;">累計注文回数</div>
            <div id="mpTotalOrders" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
          </div>
          <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:#888;">年間購入金額</div>
            <div id="mpTotalSpent" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
          </div>
          <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:#888;">累計購入点数</div>
            <div id="mpTotalItems" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
          </div>
          <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:#888;">会員ランク</div>
            <div id="mpMemberRank" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- プライバシーポリシーモーダル -->
<div class="bulk-overlay" id="privacyOverlay"></div>
<div class="bulk-modal" id="privacyModal" style="display:none;">
  <div class="bulk-modal-header">
    <div class="bulk-modal-title">プライバシーポリシー</div>
    <button class="bulk-modal-close" id="privacyCloseBtn" type="button">&times;</button>
  </div>
  <div class="bulk-modal-body" style="line-height:1.8;font-size:14px;">
    <h3 style="font-size:16px;font-weight:700;margin:0 0 12px;">個人情報の取り扱いについて</h3>
    <p>デタウリ.Detauri（以下「当サービス」）は、お客様の個人情報の保護に細心の注意を払い、以下の方針に基づき適切に取り扱います。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">1. 収集する情報</h4>
    <p>当サービスでは、ご注文・会員登録・お問い合わせの際に以下の情報を収集します。</p>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>氏名・会社名</li>
      <li>メールアドレス</li>
      <li>電話番号</li>
      <li>郵便番号・住所</li>
      <li>ご注文内容・決済情報（決済処理はKOMOJU社が行います）</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">2. 利用目的</h4>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>ご注文の処理・商品の発送</li>
      <li>お問い合わせへの回答</li>
      <li>サービス改善・新商品のご案内（メルマガ登録者のみ）</li>
      <li>不正利用の防止</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">3. 第三者への提供</h4>
    <p>お客様の個人情報は、以下の場合を除き第三者に提供いたしません。</p>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>商品配送のために配送業者に必要な情報を提供する場合</li>
      <li>決済処理のためにKOMOJU社に必要な情報を提供する場合</li>
      <li>法令に基づく場合</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">4. 個人情報の管理</h4>
    <p>お客様の個人情報は、不正アクセス・紛失・破壊・改ざん・漏洩等を防止するため、適切なセキュリティ対策を講じて管理いたします。パスワードは暗号化して保存しており、当サービスのスタッフが閲覧することはできません。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">5. Cookieおよびローカルストレージ</h4>
    <p>当サービスでは、カート情報の保持・ログイン状態の維持・サービス改善のためにCookieおよびローカルストレージを使用しています。ブラウザの設定により無効化できますが、一部の機能が制限される場合があります。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">6. お問い合わせ・開示請求</h4>
    <p>個人情報の開示・訂正・削除等のご請求は、下記までご連絡ください。</p>
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px 16px;margin:8px 0;">
      <strong>デタウリ.Detauri</strong><br>
      メール：nkonline1030@gmail.com<br>
      電話：090-5820-1803（平日 10:00〜18:00）
    </div>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">7. 改定</h4>
    <p>本ポリシーは、法令の変更やサービス内容の変更に伴い、予告なく改定する場合があります。改定後のポリシーは当サービス上に掲載した時点で効力を生じます。</p>

    <p style="margin-top:20px;color:#64748b;font-size:12px;">最終更新日：2026年2月20日</p>
  </div>
</div>

<!-- フッター -->
<footer class="footer">
  <p>NKonline Apparel / デタウリ.Detauri</p>
  <p style="margin-top:6px">
    <a href="#" id="openLegalLink">特定商取引法に基づく表記</a> ｜
    <a href="#" id="openContactLink">お問い合わせ</a> ｜
    <a href="#" id="openPrivacyLink">プライバシーポリシー</a>
  </p>
  <p style="margin-top:8px;color:#64748b;">&copy; 2025-2026 デタウリ.Detauri</p>
</footer>

</div>

<script>
// =====================================================
// 状態
// =====================================================
var BULK_CART_KEY = 'bulk_cart_v1';
var DETAURI_CART_KEY = 'estimate_cart_v2';
var SESSION_KEY = 'estimate_session';

// ページ遷移用: デタウリページHTMLキャッシュ（localStorage永続化）
var _cachedDetailHtml = null;
var DETAIL_HTML_CACHE_KEY = 'page_html_detail_v1';
var PAGE_HTML_CACHE_TTL = 10 * 60 * 1000; // 10分

function loadDetailHtmlCache_() {
  try {
    var raw = localStorage.getItem(DETAIL_HTML_CACHE_KEY);
    if (!raw) return null;
    var c = JSON.parse(raw);
    if (!c || !c.ts || !c.html) return null;
    return { html: c.html, stale: (Date.now() - c.ts >= PAGE_HTML_CACHE_TTL) };
  } catch (e) { return null; }
}

function saveDetailHtmlCache_(html) {
  try {
    localStorage.setItem(DETAIL_HTML_CACHE_KEY, JSON.stringify({ ts: Date.now(), html: html }));
  } catch (e) {}
}

// 商品データキャッシュ（デタウリと同じパターン）
var BULK_PRODUCT_CACHE_KEY = 'bulk_product_cache_v1';
var BULK_PRODUCT_CACHE_TTL = 5 * 60 * 1000; // 5分

// スタンドアロンモード判定（Cloudflare Pages等からの配信時）
var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';
var IS_STANDALONE = (typeof google === 'undefined' || !google.script);

// google.script.run shim生成（document.write後のデタウリページ用）
function _buildGasShim(url) {
  return '<script>' +
    '(function(){' +
    'if(typeof google!=="undefined"&&google.script&&google.script.run)return;' +
    'var U="' + url + '";' +
    'window.google={script:{}};' +
    'function cr(){' +
      'var _o=null,_f=null,r={};' +
      'r.withSuccessHandler=function(fn){_o=fn;return r};' +
      'r.withFailureHandler=function(fn){_f=fn;return r};' +
      'return new Proxy(r,{get:function(t,p){' +
        'if(p==="withSuccessHandler"||p==="withFailureHandler")return t[p].bind(t);' +
        'return function(){' +
          'var a=[].slice.call(arguments),ok=_o,fl=_f;' +
          'fetch(U,{method:"POST",headers:{"Content-Type":"text/plain"},' +
          'body:JSON.stringify({action:p,args:a,adminKey:localStorage.getItem("_nk_owner_key")||""}),' +
          'redirect:"follow"})' +
          '.then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.json()})' +
          '.then(function(d){if(ok)ok(d)})' +
          '.catch(function(e){if(fl)fl(e)})' +
        '}' +
      '}})' +
    '}' +
    'Object.defineProperty(google.script,"run",{get:function(){return cr()}})' +
    '})()' +
    '<' + '/script>';
}

// Admin Key: URLから取得後、localStorageに保存してURLから除去
var ADMIN_KEY = (function() {
  var urlKey = (new URLSearchParams(window.location.search)).get('admin') || '';
  if (urlKey) {
    try { localStorage.setItem('_nk_owner_key', urlKey); } catch(e) {}
    try {
      var cleanUrl = new URL(window.location.href);
      cleanUrl.searchParams.delete('admin');
      window.history.replaceState({}, '', cleanUrl.toString());
    } catch(e) {}
    return urlKey;
  }
  try { return localStorage.getItem('_nk_owner_key') || ''; } catch(e) { return ''; }
})();

function runApi(fn) {
  var args = Array.prototype.slice.call(arguments, 1);
  if (IS_STANDALONE) {
    return fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: fn, args: args, adminKey: (typeof ADMIN_KEY !== 'undefined' ? ADMIN_KEY : '') }),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    });
  }
  return new Promise(function(resolve, reject) {
    var done = false;
    var timer = setTimeout(function() {
      if (done) return; done = true;
      reject(new Error('タイムアウト'));
    }, 30000);
    try {
      var runner = google.script.run
        .withSuccessHandler(function(res) {
          if (done) return; done = true; clearTimeout(timer);
          resolve(res);
        })
        .withFailureHandler(function(err) {
          if (done) return; done = true; clearTimeout(timer);
          reject(err);
        });
      runner[fn].apply(runner, args);
    } catch (e) {
      if (done) return; done = true; clearTimeout(timer);
      reject(e);
    }
  });
}

var G = {
  products: [],
  cart: {},           // { productId: qty }
  settings: {},
  sessionId: null,    // 会員セッションID
  customer: null,     // 共有会員情報
  coupon: null,       // { type, value, discountAmount, freeShipping, label }
  shipping: 0,
  shippingSize: '',
  shippingPref: '',
  submitting: false,
  detauriCartTotal: 0,
  detauriCartCount: 0,
  detauriShipping: 0,
  detauriShippingLabel: '',
  detauriShippingPref: '',
  detauriShippingSizeLabel: ''
};

// =====================================================
// 商品データキャッシュ（localStorage）
// =====================================================
function loadBulkProductCache_() {
  try {
    var raw = localStorage.getItem(BULK_PRODUCT_CACHE_KEY);
    if (!raw) return null;
    var c = JSON.parse(raw);
    if (!c || !c.ts || !c.data) return null;
    var fresh = (Date.now() - c.ts < BULK_PRODUCT_CACHE_TTL);
    return { data: c.data, stale: !fresh };
  } catch (e) { return null; }
}

function saveBulkProductCache_(data) {
  try {
    localStorage.setItem(BULK_PRODUCT_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: data }));
  } catch (e) {}
}

function applyBulkData_(r, savedCart) {
  G.products = r.products || [];
  G.settings = r.settings || {};
  // デタウリリンクのhref/targetを設定（GAS URLで通常遷移可能にする）
  var dl = document.getElementById('detauriLink');
  var dbl = document.getElementById('detauriBannerLink');
  var _detauriUrl = window.location.origin + window.location.pathname;
  if (dl) { dl.href = _detauriUrl; dl.target = '_top'; }
  if (dbl) { dbl.href = _detauriUrl; dbl.target = '_top'; }
  // シームレスページ切替（document.write方式・即時切替: 0.1秒以内）
  function navigateToDetail_() {
    if (!_cachedDetailHtml) {
      // メモリにない場合、localStorageを確認
      var cached = loadDetailHtmlCache_();
      if (cached && cached.html) _cachedDetailHtml = cached.html;
    }
    if (!_cachedDetailHtml) return false; // キャッシュ未完了 → デフォルト遷移に任せる
    var html = _cachedDetailHtml;
    // google.script.run shim注入
    var s = _buildGasShim(GAS_API_URL);
    html = html.replace('<head>', '<head>' + s);
    document.open();
    document.write(html);
    document.close();
    return true;
  }
  if (dl) dl.addEventListener('click', function(e) { if (navigateToDetail_()) e.preventDefault(); });
  if (dbl) dbl.addEventListener('click', function(e) { if (navigateToDetail_()) e.preventDefault(); });
  if (savedCart && Object.keys(savedCart).length > 0) {
    var validProducts = {};
    G.products.forEach(function(p) { validProducts[p.productId] = true; });
    Object.keys(savedCart).forEach(function(pid) {
      if (validProducts[pid] && !G.cart[pid]) G.cart[pid] = savedCart[pid];
    });
  }
  renderProducts();
  updateCart();
}

// =====================================================
// ヘッダー自動縮小（スクロール方向連動）
// =====================================================
(function() {
  var _lastScrollY = 0;
  var _row2Hidden = false;
  window.addEventListener('scroll', function() {
    var header = document.querySelector('.header');
    if (!header) return;
    var currentY = window.scrollY;
    var delta = currentY - _lastScrollY;
    if (Math.abs(delta) < 5) { _lastScrollY = currentY; return; }
    if (currentY <= 0) {
      if (_row2Hidden) { _row2Hidden = false; header.classList.remove('row2-hidden'); }
    } else if (delta > 0) {
      if (!_row2Hidden) { _row2Hidden = true; header.classList.add('row2-hidden'); }
    } else {
      if (_row2Hidden) { _row2Hidden = false; header.classList.remove('row2-hidden'); }
    }
    _lastScrollY = currentY;
  }, { passive: true });
})();

// =====================================================
// プロモバナー sticky 連動: header の top 位置を動的調整
// =====================================================
function adjustHeaderForBanner_() {
  var banner = document.getElementById('promoBanner');
  var header = document.querySelector('.header');
  if (!header) return;
  if (banner && banner.style.display !== 'none') {
    header.style.top = banner.offsetHeight + 'px';
  } else {
    header.style.top = '0';
  }
}

// =====================================================
// 初期化（キャッシュ優先 → バックグラウンド更新）
// =====================================================
window.addEventListener('DOMContentLoaded', function() {
  loadDetauriCart();
  var savedCart = loadBulkCart();
  loadSharedSession();
  window.addEventListener('resize', adjustHeaderForBanner_);

  // キャッシュから即時表示
  var cached = loadBulkProductCache_();
  var cacheApplied = false;
  if (cached && cached.data) {
    console.log('BulkLP: ' + (cached.stale ? '古い' : '') + 'キャッシュから即時表示:', (cached.data.products || []).length + '件');
    applyBulkData_(cached.data, savedCart);
    cacheApplied = true;
  }
  // ページ遷移オーバーレイのフェードアウト
  document.body.classList.remove('page-entering');
  document.body.style.background = '';
  var pt = document.getElementById('pageTransition');
  if (pt) pt.classList.remove('active');

  // バックグラウンドで最新データを取得
  var initDone = false;
  var loadTimer = setTimeout(function() {
    if (!initDone && !cacheApplied) {
      showProductError('読み込みがタイムアウトしました。ページを再読み込みしてください。');
    }
  }, 30000);

  runApi('apiBulkInit')
    .then(function(r) {
      initDone = true;
      clearTimeout(loadTimer);
      try {
        if (!r || !r.ok) {
          if (!cacheApplied) showProductError(r && r.message ? r.message : '読み込みに失敗しました');
          return;
        }
        saveBulkProductCache_(r);
        var newCount = (r.products || []).length;
        if (!cacheApplied || newCount !== G.products.length) {
          console.log('BulkLP: 最新データで更新:', newCount + '件');
          applyBulkData_(r, savedCart);
        } else {
          // settings（会員割引等）だけ静かに更新
          G.settings = r.settings || {};
          updateCart();
        }
      } catch (err) {
        if (!cacheApplied) showProductError('表示エラー: ' + (err.message || err));
      }
    })
    .catch(function(e) {
      initDone = true;
      clearTimeout(loadTimer);
      if (!cacheApplied) showProductError(e && e.message ? e.message : '接続エラー');
    });

  document.getElementById('postal').addEventListener('input', onPostalInput);

  // デタウリページHTMLをバックグラウンドでプリフェッチ（シームレス切替用）
  setTimeout(function() { prefetchDetailPage_(); }, 3000);
});

// =====================================================
// デタウリページHTMLプリフェッチ（document.write遷移用）
// =====================================================
function prefetchDetailPage_() {
  if (_cachedDetailHtml) return;
  var cached = loadDetailHtmlCache_();
  if (cached && cached.html) {
    _cachedDetailHtml = cached.html;
    if (!cached.stale) return;
  }
  runApi('apiDetailPage')
    .then(function(r) {
      if (r && r.ok && r.html) {
        _cachedDetailHtml = r.html;
        saveDetailHtmlCache_(r.html);
        console.log('プリフェッチ完了: デタウリページHTML');
      }
    })
    .catch(function(e) { console.log('プリフェッチ失敗:', e); });
}

// =====================================================
// 商品一覧レンダリング
// =====================================================
function showProductError(msg) {
  document.getElementById('productList').innerHTML = '<div class="cart-empty">' + escHtml(msg) + '</div>';
}

function renderProducts() {
  var el = document.getElementById('productList');
  if (!G.products.length) { el.innerHTML = '<div class="cart-empty">商品がありません</div>'; return; }

  var html = '';
  for (var i = 0; i < G.products.length; i++) {
    var p = G.products[i];
    html += renderProductCard(p, i);
  }
  el.innerHTML = html;
}

// =====================================================
// 商品詳細モーダル
// =====================================================
function openProductModal(idx) {
  var p = G.products[idx];
  if (!p) return;

  var modal = document.getElementById('productModal');
  var imagesEl = document.getElementById('modalImages');
  var thumbsEl = document.getElementById('modalThumbs');
  var bodyEl = document.getElementById('modalBody');

  // 画像
  var imgHtml = '';
  var thumbHtml = '';
  if (p.images && p.images.length > 0) {
    for (var i = 0; i < p.images.length; i++) {
      imgHtml += '<img src="' + escAttr(p.images[i]) + '" alt="' + escAttr(p.name) + '" class="' + (i === 0 ? 'active' : '') + '" data-idx="' + i + '">';
    }
    if (p.images.length > 1) {
      imgHtml += '<button class="img-nav prev" onclick="slideModalImg(-1)">&#8249;</button>';
      imgHtml += '<button class="img-nav next" onclick="slideModalImg(1)">&#8250;</button>';
      imgHtml += '<div class="img-dots">';
      for (var d = 0; d < p.images.length; d++) {
        imgHtml += '<div class="img-dot' + (d === 0 ? ' active' : '') + '" onclick="goModalImg(' + d + ')"></div>';
      }
      imgHtml += '</div>';
    }
    // サムネイル
    for (var t = 0; t < p.images.length; t++) {
      thumbHtml += '<img src="' + escAttr(p.images[t]) + '" alt="" class="' + (t === 0 ? 'active' : '') + '" onclick="goModalImg(' + t + ')">';
    }
  } else {
    imgHtml = '<div class="no-image" style="aspect-ratio:4/3">画像なし</div>';
  }
  imagesEl.innerHTML = imgHtml;
  thumbsEl.innerHTML = thumbHtml;
  thumbsEl.style.display = (p.images && p.images.length > 1) ? 'flex' : 'none';

  // 本文（スクロール領域: タイトル + 説明）
  var tagHtml = p.tag ? '<span class="product-tag">' + escHtml(p.tag) + '</span>' : '';
  var isSoldOut = p.soldOut === true;
  var soldOutLabel = isSoldOut ? '<div style="text-align:center;padding:10px 0;font-size:16px;font-weight:900;color:#d93025;letter-spacing:2px">SOLD OUT</div>' : '';
  bodyEl.innerHTML =
    '<div class="product-name">' + escHtml(p.name) + '</div>'
    + (p.description ? '<div class="product-desc">' + escHtml(p.description) + '</div>' : '')
    + soldOutLabel;

  // 固定下部: 価格 + 数量コントロール
  var bottomEl = document.getElementById('modalBottom');
  var priceHtml = '';
  if (p.discountRate > 0) {
    priceHtml = '<span class="original">¥' + numFmt(p.price) + '</span>'
      + '¥' + numFmt(p.discountedPrice) + '<small>' + escHtml(p.unit) + '</small>'
      + '<span class="disc-badge">' + Math.round(p.discountRate * 100) + '%OFF</span>';
  } else {
    priceHtml = '¥' + numFmt(p.price) + '<small>' + escHtml(p.unit) + '</small>';
  }
  var qty = isSoldOut ? 0 : (G.cart[p.productId] || 0);
  var qtyClass = 'qty-control' + (isSoldOut ? '" style="opacity:.3;pointer-events:none' : '');
  bottomEl.innerHTML =
    '<div class="product-bottom">'
    + '<div class="product-price-area">' + tagHtml + '<div class="product-price">' + priceHtml + '</div></div>'
    + '<div class="' + qtyClass + '">'
    + '<button class="qty-btn" onclick="changeQty(\'' + escAttr(p.productId) + '\',-1)">−</button>'
    + '<input class="qty-value" id="modal_qty_' + escAttr(p.productId) + '" value="' + qty + '" readonly>'
    + '<button class="qty-btn" onclick="changeQty(\'' + escAttr(p.productId) + '\',1)">+</button>'
    + '</div></div>';

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  if (typeof hideFabsForModal_ === 'function') hideFabsForModal_();
}

function closeModal() {
  var modal = document.getElementById('productModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  if (typeof showFabsAfterModal_ === 'function') showFabsAfterModal_();
  // モーダル内の数量変更をリスト側にも反映
  G.products.forEach(function(p) {
    var qty = G.cart[p.productId] || 0;
    var input = document.getElementById('qty_' + p.productId);
    if (input) input.value = qty;
  });
}

function closeModalOverlay(e) {
  if (e.target === e.currentTarget) closeModal();
}

function slideModalImg(dir) {
  var wrap = document.getElementById('modalImages');
  if (!wrap) return;
  var imgs = wrap.querySelectorAll('img');
  var cur = 0;
  for (var i = 0; i < imgs.length; i++) { if (imgs[i].classList.contains('active')) { cur = i; break; } }
  goModalImg((cur + dir + imgs.length) % imgs.length);
}

function goModalImg(to) {
  var wrap = document.getElementById('modalImages');
  if (!wrap) return;
  var imgs = wrap.querySelectorAll('img');
  var dots = wrap.querySelectorAll('.img-dot');
  var thumbs = document.getElementById('modalThumbs').querySelectorAll('img');
  for (var i = 0; i < imgs.length; i++) { imgs[i].classList.toggle('active', i === to); }
  for (var d = 0; d < dots.length; d++) { dots[d].classList.toggle('active', d === to); }
  for (var t = 0; t < thumbs.length; t++) { thumbs[t].classList.toggle('active', t === to); }
}

function renderProductCard(p, idx) {
  var isSoldOut = p.soldOut === true;
  var cardClass = 'product-card' + (isSoldOut ? ' sold-out' : '');

  var imgHtml = '';
  if (p.images && p.images.length > 0) {
    imgHtml += '<div class="product-images" id="imgs_' + idx + '" onclick="openProductModal(' + idx + ')">';
    imgHtml += '<img src="' + escAttr(p.images[0]) + '" alt="' + escAttr(p.name) + '" class="active">';
    if (p.images.length > 1) {
      imgHtml += '<div class="img-dots">';
      for (var d = 0; d < p.images.length; d++) {
        imgHtml += '<div class="img-dot' + (d === 0 ? ' active' : '') + '"></div>';
      }
      imgHtml += '</div>';
    }
    imgHtml += '</div>';
  } else {
    imgHtml = '<div class="no-image" onclick="openProductModal(' + idx + ')">画像なし</div>';
  }

  var soldOutHtml = isSoldOut ? '<div class="sold-out-overlay"><span class="sold-out-badge">SOLD OUT</span></div>' : '';

  var tagHtml = p.tag ? '<span class="product-tag">' + escHtml(p.tag) + '</span>' : '';
  var qty = isSoldOut ? 0 : (G.cart[p.productId] || 0);

  var priceHtml = '';
  if (p.discountRate > 0) {
    priceHtml = '<span class="original">¥' + numFmt(p.price) + '</span>'
      + '¥' + numFmt(p.discountedPrice) + '<small>' + escHtml(p.unit) + '</small>'
      + '<span class="disc-badge">' + Math.round(p.discountRate * 100) + '%OFF</span>';
  } else {
    priceHtml = '¥' + numFmt(p.price) + '<small>' + escHtml(p.unit) + '</small>';
  }

  return '<div class="' + cardClass + '">'
    + imgHtml
    + soldOutHtml
    + '<div class="product-body">'
    + '<div class="product-name">' + escHtml(p.name) + '</div>'
    + '<div class="product-bottom">'
    + '<div class="product-price-area">' + tagHtml + '<div class="product-price">' + priceHtml + '</div></div>'
    + '<div class="qty-control">'
    + '<button class="qty-btn" onclick="changeQty(\'' + escAttr(p.productId) + '\',-1)">−</button>'
    + '<input class="qty-value" id="qty_' + escAttr(p.productId) + '" value="' + qty + '" readonly>'
    + '<button class="qty-btn" onclick="changeQty(\'' + escAttr(p.productId) + '\',1)">+</button>'
    + '</div></div></div></div>';
}

// =====================================================
// 数量変更
// =====================================================
function changeQty(productId, delta) {
  var p = G.products.find(function(x) { return x.productId === productId; });
  if (!p) return;
  if (p.soldOut) return;
  var cur = G.cart[productId] || 0;
  var next = Math.max(0, Math.min(p.maxQty, cur + delta));
  if (next === 0) { delete G.cart[productId]; }
  else { G.cart[productId] = next; }

  var input = document.getElementById('qty_' + productId);
  if (input) input.value = next;
  var modalInput = document.getElementById('modal_qty_' + productId);
  if (modalInput) modalInput.value = next;

  updateCart();
  saveBulkCart();

  // クーポン適用中にカートが変わったら再検証
  revalidateCoupon();
}

// =====================================================
// カート更新
// =====================================================
function updateCart() {
  var el = document.getElementById('cartSection');
  var keys = Object.keys(G.cart);
  if (keys.length === 0) {
    recalcDetauriShipping_(); // デタウリ送料もリアルタイム計算
    var emptyHtml = '<div class="cart-empty">商品を選択してください</div>';
    if (G.detauriCartCount > 0) {
      var detRows = '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
        + '<span>デタウリ 商品代（' + G.detauriCartCount + '点）</span>'
        + '<span>¥' + numFmt(G.detauriCartTotal) + '</span></div>';
      var shippingDesc0 = 'デタウリ 送料';
      if (G.detauriShippingPref && G.detauriShippingSizeLabel) {
        shippingDesc0 = 'デタウリ 送料（' + escHtml(G.detauriShippingPref) + '・' + escHtml(G.detauriShippingSizeLabel) + '）';
      }
      if (G.detauriShipping > 0) {
        detRows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
          + '<span>' + shippingDesc0 + '</span>'
          + '<span>¥' + numFmt(G.detauriShipping) + '</span></div>';
      }
      var detauriSub0 = G.detauriCartTotal + G.detauriShipping;
      detRows += '<div class="cart-row" style="color:#5B86C5;font-size:13px;font-weight:700;border-top:1px solid #c8d8f0;margin-top:4px;padding-top:8px;">'
        + '<span>デタウリ 小計</span>'
        + '<span>¥' + numFmt(detauriSub0) + '</span></div>';
      emptyHtml += '<div class="cart-summary" style="margin-top:10px;">' + detRows + '</div>';
    }
    el.innerHTML = emptyHtml;
    var emptyGrand = G.detauriCartTotal + G.detauriShipping;
    updatePayButton(emptyGrand > 0 ? emptyGrand : 0);
    updateCartClearBtns_();
    return;
  }

  var productMap = {};
  G.products.forEach(function(p) { productMap[p.productId] = p; });

  var subtotal = 0;
  var totalQty = 0;
  var rows = '';
  for (var i = 0; i < keys.length; i++) {
    var pid = keys[i];
    var qty = G.cart[pid];
    var p = productMap[pid];
    if (!p) continue;
    var unitPrice = (p.discountedPrice !== undefined) ? p.discountedPrice : p.price;
    var line = unitPrice * qty;
    subtotal += line;
    totalQty += qty;
    rows += '<div class="cart-row"><span>' + escHtml(p.name) + ' x' + qty + escHtml(p.unit) + '</span><span>¥' + numFmt(line) + '</span></div>';
  }

  // 割引
  var discounted = subtotal;
  var discountRows = '';

  if (G.coupon) {
    var cd = G.coupon.discountAmount || 0;
    if (G.coupon.type === 'shipping_free') {
      discountRows += '<div class="cart-row"><span>' + escHtml(G.coupon.label) + '</span><span>-送料</span></div>';
    } else if (cd > 0) {
      discounted -= cd;
      discountRows += '<div class="cart-row"><span>' + escHtml(G.coupon.label) + '</span><span>-¥' + numFmt(cd) + '</span></div>';
    }
  }

  if (totalQty >= 30 && (!G.coupon || G.coupon.comboBulk !== false)) {
    var bulkDisc = Math.round(discounted * 0.10);
    discounted -= bulkDisc;
    discountRows += '<div class="cart-row"><span>30点以上割引 (10%OFF)</span><span>-¥' + numFmt(bulkDisc) + '</span></div>';
  }

  // 会員割引
  var md = G.settings.memberDiscount;
  if (G.customer && md && md.enabled && (!G.coupon || G.coupon.comboMember !== false)) {
    var memberDisc = Math.round(discounted * md.rate);
    discounted -= memberDisc;
    discountRows += '<div class="cart-row"><span>会員割引 (' + Math.round(md.rate * 100) + '%OFF)</span><span>-¥' + numFmt(memberDisc) + '</span></div>';
  }

  discounted = Math.max(0, discounted);

  // 送料
  calcShipping(totalQty);
  recalcDetauriShipping_(); // デタウリ送料もリアルタイム計算
  var shipping = (G.coupon && G.coupon.freeShipping) ? 0 : G.shipping;

  if (shipping > 0) {
    rows += '<div class="cart-row"><span>送料（' + escHtml(G.shippingPref || '未入力') + '・大×' + totalQty + '）</span><span>¥' + numFmt(shipping) + '</span></div>';
  } else if (shipping === 0 && G.shippingPref) {
    rows += '<div class="cart-row"><span>送料</span><span>¥0（無料）</span></div>';
  }

  var total = discounted + shipping;
  rows += discountRows;
  rows += '<div class="cart-row total"><span>アソート商品 小計</span><span>¥' + numFmt(total) + '</span></div>';

  // デタウリカートの合算表示
  var grandTotal = total;
  if (G.detauriCartCount > 0) {
    rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;padding-top:10px;">'
      + '<span>デタウリ 商品代（' + G.detauriCartCount + '点）</span>'
      + '<span>¥' + numFmt(G.detauriCartTotal) + '</span></div>';
    var shippingDesc = 'デタウリ 送料';
    if (G.detauriShippingPref && G.detauriShippingSizeLabel) {
      shippingDesc = 'デタウリ 送料（' + escHtml(G.detauriShippingPref) + '・' + escHtml(G.detauriShippingSizeLabel) + '）';
    }
    if (G.detauriShipping > 0) {
      rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
        + '<span>' + shippingDesc + '</span>'
        + '<span>¥' + numFmt(G.detauriShipping) + '</span></div>';
    }
    var detauriTotal = G.detauriCartTotal + G.detauriShipping;
    rows += '<div class="cart-row" style="color:#5B86C5;font-size:13px;font-weight:700;border-top:1px solid #c8d8f0;margin-top:4px;padding-top:8px;">'
      + '<span>デタウリ 小計</span>'
      + '<span>¥' + numFmt(detauriTotal) + '</span></div>';
    grandTotal = total + detauriTotal;
    rows += '<div class="cart-row total" style="border-top-color:#5B86C5;"><span>両チャネル合計（税込）</span><span>¥' + numFmt(grandTotal) + '</span></div>';
  }

  el.innerHTML = '<div class="cart-summary">' + rows + '</div>';
  updatePayButton(grandTotal);
  updateCartClearBtns_();
}

function updatePayButton(total) {
  var btn = document.getElementById('payButton');
  if (total > 0) {
    btn.disabled = false;
    btn.textContent = 'お支払いへ進む — ¥' + numFmt(total);
  } else {
    btn.disabled = true;
    btn.textContent = 'カートが空です';
  }
}

// =====================================================
// 送料計算（クライアント側で即時反映）
// =====================================================
function calcShipping(totalQty) {
  var addr = document.getElementById('address').value;
  if (!addr) { G.shipping = 0; G.shippingPref = ''; G.shippingSize = ''; return; }

  var pref = detectPrefClient(addr);
  if (!pref) { G.shipping = 0; G.shippingPref = ''; G.shippingSize = ''; return; }

  G.shippingPref = pref;

  var areas = G.settings.shippingAreas || {};
  var rates = G.settings.shippingRates || {};
  var area = areas[pref];
  if (!area || !rates[area]) { G.shipping = 0; return; }

  // アソート商品: 常に大サイズ × 数量
  G.shippingSize = 'large';
  var largeRate = rates[area][1]; // [1] = 大
  G.shipping = largeRate * totalQty;
}

// 複数口送料計算（上限超過時に分割）
function calculateMultiShipment_(thick, thin, rates) {
  var smallRate = rates[0], largeRate = rates[1];
  var totalAmount = 0, largeCnt = 0, smallCnt = 0;
  if (thick > 0) {
    var n = Math.ceil(thick / 20);
    largeCnt += n;
    totalAmount += n * largeRate;
  }
  var rem = thin;
  while (rem > 0) {
    var batch = Math.min(rem, 40);
    if (batch <= 10) { smallCnt++; totalAmount += smallRate; }
    else { largeCnt++; totalAmount += largeRate; }
    rem -= batch;
  }
  var parts = [];
  if (largeCnt > 0) parts.push('大×' + largeCnt);
  if (smallCnt > 0) parts.push('小×' + smallCnt);
  return { amount: totalAmount, sizeLabel: parts.join('、'), largeCnt: largeCnt, smallCnt: smallCnt };
}

// デタウリ送料をリアルタイム計算（アソート商品ページ上で住所入力時）
function recalcDetauriShipping_() {
  if (G.detauriCartCount === 0) return;
  var addr = document.getElementById('address').value;
  if (!addr) return; // 住所未入力時はloadDetauriCart()で読み込んだ値を維持

  var pref = detectPrefClient(addr);
  if (!pref) { G.detauriShipping = 0; G.detauriShippingPref = ''; G.detauriShippingSizeLabel = ''; return; }

  var areas = G.settings.shippingAreas || {};
  var rates = G.settings.shippingRates || {};
  var area = areas[pref];
  if (!area || !rates[area]) { G.detauriShipping = 0; return; }

  // estimate_cart_v2 からアイテムの厚み情報を取得
  try {
    var raw = localStorage.getItem(DETAURI_CART_KEY);
    if (!raw) return;
    var j = JSON.parse(raw);
    var ids = Array.isArray(j.ids) ? j.ids : [];
    var items = j.itemsById || {};
    var thick = 0, thin = 0;
    for (var i = 0; i < ids.length; i++) {
      var it = items[ids[i]];
      if (!it) continue;
      if (String(it.shippingMethod || '').trim() === 'ゆうパケットポスト') thin++;
      else thick++;
    }
    var total = thick + thin;
    if (total === 0) return;

    // サイズ判定（デタウリと同じロジック）
    var size = null, sizeLabel = '', overLimit = false;
    if (thin === 0) {
      if (total > 20) overLimit = true;
      else { size = 'large'; sizeLabel = '大'; }
    } else if (thick === 0) {
      if (total > 40) overLimit = true;
      else { size = total <= 10 ? 'small' : 'large'; sizeLabel = total <= 10 ? '小' : '大'; }
    } else {
      if (total > 40) overLimit = true;
      else if (thick >= 10) { size = 'large'; sizeLabel = '大'; }
      else { size = total <= 10 ? 'small' : 'large'; sizeLabel = total <= 10 ? '小' : '大'; }
    }

    if (overLimit) {
      var multi = calculateMultiShipment_(thick, thin, [rates[area][0], rates[area][1]]);
      G.detauriShipping = multi.amount;
      G.detauriShippingPref = pref;
      G.detauriShippingSizeLabel = multi.sizeLabel;
      return;
    }

    var rateIdx = (size === 'small') ? 0 : 1;
    G.detauriShipping = rates[area][rateIdx];
    G.detauriShippingPref = pref;
    G.detauriShippingSizeLabel = sizeLabel;
  } catch (e) {}
}

function detectPrefClient(text) {
  var prefs = ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
    '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
    '新潟県','富山県','石川県','福井県','山梨県','長野県',
    '岐阜県','静岡県','愛知県','三重県',
    '滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県',
    '鳥取県','島根県','岡山県','広島県','山口県',
    '徳島県','香川県','愛媛県','高知県',
    '福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'];
  for (var i = 0; i < prefs.length; i++) {
    if (text.indexOf(prefs[i]) === 0) return prefs[i];
  }
  for (var j = 0; j < prefs.length; j++) {
    var sh = prefs[j].replace(/[都府県]$/, '');
    if (text.indexOf(sh) === 0) return prefs[j];
  }
  return null;
}

// 住所入力で送料リアルタイム更新
document.addEventListener('input', function(e) {
  if (e.target.id === 'address') updateCart();
});

// =====================================================
// 郵便番号→住所自動入力
// =====================================================
var postalTimer = null;
function onPostalInput() {
  clearTimeout(postalTimer);
  var val = this.value.replace(/[^0-9]/g, '');
  if (val.length === 7) {
    postalTimer = setTimeout(function() {
      fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + val)
        .then(function(r) { return r.json(); })
        .then(function(j) {
          if (j.results && j.results[0]) {
            var r = j.results[0];
            document.getElementById('address').value = r.address1 + r.address2 + r.address3;
            updateCart();
          }
        })
        .catch(function() {});
    }, 300);
  }
}

// =====================================================
// クーポン適用
// =====================================================
function applyCoupon() {
  var code = document.getElementById('couponInput').value.trim();
  var resEl = document.getElementById('couponResult');
  if (!code) { resEl.className = 'coupon-result err'; resEl.textContent = 'コードを入力してください'; return; }

  var email = document.getElementById('contact').value.trim();
  var subtotal = calcSubtotal();

  runApi('apiValidateCoupon', code, email, subtotal, 'bulk', Object.keys(G.cart))
    .then(function(r) {
      if (r && r.ok) {
        G.coupon = r;
        resEl.className = 'coupon-result ok';
        resEl.textContent = r.label + ' が適用されました';
        updateCart();
      } else {
        G.coupon = null;
        resEl.className = 'coupon-result err';
        resEl.textContent = r && r.message ? r.message : 'クーポンが無効です';
        updateCart();
      }
    })
    .catch(function(e) {
      resEl.className = 'coupon-result err';
      resEl.textContent = e && e.message ? e.message : 'エラーが発生しました';
    });
}

function calcSubtotal() {
  var productMap = {};
  G.products.forEach(function(p) { productMap[p.productId] = p; });
  var sum = 0;
  Object.keys(G.cart).forEach(function(pid) {
    var p = productMap[pid];
    if (p) {
      var unitPrice = (p.discountedPrice !== undefined) ? p.discountedPrice : p.price;
      sum += unitPrice * G.cart[pid];
    }
  });
  return sum;
}

// =====================================================
// 注文送信
// =====================================================
function submitOrder() {
  if (G.submitting) return;

  var errEl = document.getElementById('formError');
  errEl.style.display = 'none';

  var companyName = document.getElementById('companyName').value.trim();
  var contact = document.getElementById('contact').value.trim();
  var postal = document.getElementById('postal').value.trim();
  var address = document.getElementById('address').value.trim();
  var building = document.getElementById('building').value.trim();
  var phone = document.getElementById('phone').value.trim();
  var note = document.getElementById('note').value.trim();

  if (!companyName || !contact || !postal || !address || !phone) {
    errEl.textContent = '必須項目を入力してください';
    errEl.style.display = 'block';
    return;
  }

  var fullAddress = address + (building ? ' ' + building : '');

  var items = [];
  Object.keys(G.cart).forEach(function(pid) {
    items.push({ productId: pid, qty: G.cart[pid] });
  });
  if (items.length === 0) return;

  var totalQty = 0;
  items.forEach(function(it) { totalQty += it.qty; });
  var shipping = (G.coupon && G.coupon.freeShipping) ? 0 : G.shipping;

  // デタウリカートの金額も含める（両チャネル合算決済）
  var detauriProductAmount = G.detauriCartTotal || 0;
  var detauriShippingAmount = G.detauriShipping || 0;
  var detauriItemCount = G.detauriCartCount || 0;

  var form = {
    companyName: companyName,
    contact: contact,
    postal: postal,
    address: fullAddress,
    phone: phone,
    note: note,
    couponCode: G.coupon ? document.getElementById('couponInput').value.trim() : '',
    shippingAmount: shipping,
    shippingSize: G.shippingSize,
    shippingPref: G.shippingPref,
    detauriProductAmount: detauriProductAmount,
    detauriShipping: detauriShippingAmount,
    detauriItemCount: detauriItemCount
  };

  G.submitting = true;
  var btn = document.getElementById('payButton');
  btn.disabled = true;
  btn.textContent = '処理中...';

  runApi('apiBulkSubmit', form, items)
    .then(function(r) {
      G.submitting = false;
      if (r && r.ok && r.sessionUrl) {
        window.location.href = r.sessionUrl;
      } else {
        btn.disabled = false;
        updateCart();
        errEl.textContent = r && r.message ? r.message : '注文に失敗しました';
        errEl.style.display = 'block';
      }
    })
    .catch(function(e) {
      G.submitting = false;
      btn.disabled = false;
      updateCart();
      errEl.textContent = e && e.message ? e.message : 'エラーが発生しました';
      errEl.style.display = 'block';
    });
}

// =====================================================
// ユーティリティ
// =====================================================
// =====================================================
// クーポン再検証（カート変更時）
// =====================================================
function revalidateCoupon() {
  if (!G.coupon) return;
  var code = document.getElementById('couponInput').value.trim();
  if (!code) { G.coupon = null; updateCart(); return; }

  var cartKeys = Object.keys(G.cart);
  if (cartKeys.length === 0) {
    // カートが空になったらクーポンをクリア
    G.coupon = null;
    var resEl = document.getElementById('couponResult');
    resEl.className = 'coupon-result';
    resEl.textContent = '';
    updateCart();
    return;
  }

  var email = document.getElementById('contact').value.trim();
  var subtotal = calcSubtotal();

  runApi('apiValidateCoupon', code, email, subtotal, 'bulk', cartKeys)
    .then(function(r) {
      if (r && r.ok) {
        G.coupon = r;
      } else {
        G.coupon = null;
        var resEl = document.getElementById('couponResult');
        resEl.className = 'coupon-result err';
        resEl.textContent = r && r.message ? r.message : 'カート変更によりクーポンが無効になりました';
      }
      updateCart();
    })
    .catch(function() {
      // ネットワークエラー時はクーポンを維持
    });
}

// =====================================================
// 会員セッション共有
// =====================================================
function loadSharedSession() {
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return;
    var saved = JSON.parse(raw);
    if (!saved || !saved.sessionId) return;

    // 即時反映: localStorageのデータで先にUI更新
    if (saved.customer) {
      G.sessionId = saved.sessionId;
      G.customer = saved.customer;
      autoFillCustomerForm();
      updateAuthUi_();
      updateCart();
    }

    // バックエンドでセッション検証
    runApi('apiValidateSession', 'bulk', { sessionId: saved.sessionId })
      .then(function(r) {
        if (r && r.ok && r.data && r.data.customer) {
          G.sessionId = saved.sessionId;
          G.customer = r.data.customer;
          autoFillCustomerForm();
          updateAuthUi_();
          updateCart();
        } else {
          // セッション無効 → ログアウト
          G.sessionId = null;
          G.customer = null;
          updateAuthUi_();
          updateCart();
        }
      })
      .catch(function() {
        // 検証失敗時はlocalStorageのデータを維持
      });
  } catch (e) {}
}

function autoFillCustomerForm() {
  if (!G.customer) return;
  var fields = [
    ['companyName', G.customer.companyName],
    ['contact', G.customer.email],
    ['phone', G.customer.phone],
    ['postal', G.customer.postal],
    ['address', G.customer.address]
  ];
  fields.forEach(function(f) {
    var el = document.getElementById(f[0]);
    if (el && !el.value && f[1]) {
      el.value = f[1];
    }
  });
  // 住所が入力されたら送料を再計算
  if (G.customer.address) updateCart();
}

function updateMemberUI() {
  if (!G.customer) return;
  var wrap = document.querySelector('.header-auth-wrap');
  if (!wrap) return;
  // 既存バッジがあれば削除
  var old = document.getElementById('memberBadge');
  if (old) old.remove();
  var badge = document.createElement('div');
  badge.id = 'memberBadge';
  badge.className = 'member-badge';
  var md = G.settings.memberDiscount;
  var discountText = (md && md.enabled) ? ' ・ 会員割引' + Math.round(md.rate * 100) + '%OFF適用中' : '';
  badge.textContent = '会員ログイン中: ' + (G.customer.companyName || G.customer.email) + discountText;
  wrap.appendChild(badge);
}

// =====================================================
// カート永続化 (localStorage)
// =====================================================
function saveBulkCart() {
  try {
    var subtotal = calcSubtotal();
    var totalQty = 0;
    Object.keys(G.cart).forEach(function(pid) { totalQty += G.cart[pid]; });
    var shipping = (G.coupon && G.coupon.freeShipping) ? 0 : G.shipping;
    localStorage.setItem(BULK_CART_KEY, JSON.stringify({
      cart: G.cart,
      subtotal: subtotal,
      totalQty: totalQty,
      shipping: shipping
    }));
  } catch (e) {}
}

function loadBulkCart() {
  try {
    var raw = localStorage.getItem(BULK_CART_KEY);
    if (!raw) return {};
    var j = JSON.parse(raw);
    return j.cart || {};
  } catch (e) { return {}; }
}

function loadDetauriCart() {
  try {
    var raw = localStorage.getItem(DETAURI_CART_KEY);
    if (!raw) return;
    var j = JSON.parse(raw);
    var ids = Array.isArray(j.ids) ? j.ids : [];
    var items = j.itemsById || {};
    var sum = 0;
    for (var i = 0; i < ids.length; i++) {
      var it = items[ids[i]];
      if (it) sum += Number(it.price || 0);
    }
    G.detauriCartTotal = sum;
    G.detauriCartCount = ids.length;
    G.detauriShipping = Number(j.shipping || 0);
    G.detauriShippingLabel = j.shippingLabel || '';
    G.detauriShippingPref = j.shippingPref || '';
    G.detauriShippingSizeLabel = j.shippingSizeLabel || '';
  } catch (e) {}
}

// =====================================================
// カートクリア
// =====================================================
function clearBulkCartOnly() {
  if (!confirm('アソートカートを空にしますか？')) return;
  G.cart = {};
  G.coupon = null;
  saveBulkCart();
  updateCart();
  revalidateCoupon();
  var cr = document.getElementById('couponResult');
  if (cr) { cr.className = 'coupon-result'; cr.textContent = ''; }
}

function clearDetauriCartOnly() {
  if (!confirm('デタウリカートを空にしますか？')) return;
  try { localStorage.removeItem(DETAURI_CART_KEY); } catch (e) {}
  G.detauriCartTotal = 0;
  G.detauriCartCount = 0;
  G.detauriShipping = 0;
  G.detauriShippingLabel = '';
  G.detauriShippingPref = '';
  G.detauriShippingSizeLabel = '';
  updateCart();
}

function clearAllCarts() {
  if (!confirm('すべてのカートを空にしますか？')) return;
  G.cart = {};
  G.coupon = null;
  saveBulkCart();
  try { localStorage.removeItem(DETAURI_CART_KEY); } catch (e) {}
  G.detauriCartTotal = 0;
  G.detauriCartCount = 0;
  G.detauriShipping = 0;
  G.detauriShippingLabel = '';
  G.detauriShippingPref = '';
  G.detauriShippingSizeLabel = '';
  updateCart();
  renderProducts();
  var cr = document.getElementById('couponResult');
  if (cr) { cr.className = 'coupon-result'; cr.textContent = ''; }
}

function updateCartClearBtns_() {
  var wrap = document.getElementById('cartClearBtns');
  if (!wrap) return;
  var hasBulk = Object.keys(G.cart).length > 0;
  var hasDetauri = G.detauriCartCount > 0;
  if (!hasBulk && !hasDetauri) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'flex';
  var btns = '';
  if (hasBulk) btns += '<button type="button" onclick="clearBulkCartOnly()" style="font-size:10px;padding:3px 8px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;white-space:nowrap;">アソート空</button>';
  if (hasDetauri) btns += '<button type="button" onclick="clearDetauriCartOnly()" style="font-size:10px;padding:3px 8px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;white-space:nowrap;">デタウリ空</button>';
  if (hasBulk && hasDetauri) btns += '<button type="button" onclick="clearAllCarts()" style="font-size:10px;padding:3px 8px;border:1px solid #e74c3c;border-radius:6px;background:#fff;color:#e74c3c;cursor:pointer;white-space:nowrap;">すべて空</button>';
  wrap.innerHTML = btns;
}

// ESCキーでモーダル閉じる
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function escAttr(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;'); }
function numFmt(n) { return String(Math.round(n)).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

// =====================================================
// 住所共有（localStorage経由で両ページ間で共有）
// =====================================================
var SHARED_ADDRESS_KEY = 'shared_address_v1';

function saveSharedAddress_() {
  try {
    var data = {
      companyName: (document.getElementById('companyName').value || '').trim(),
      contact: (document.getElementById('contact').value || '').trim(),
      postal: (document.getElementById('postal').value || '').trim(),
      address: (document.getElementById('address').value || '').trim(),
      building: (document.getElementById('building').value || '').trim(),
      phone: (document.getElementById('phone').value || '').trim(),
      note: (document.getElementById('note').value || '').trim(),
      ts: Date.now()
    };
    localStorage.setItem(SHARED_ADDRESS_KEY, JSON.stringify(data));
  } catch (e) {}
}

function loadSharedAddress_() {
  try {
    var raw = localStorage.getItem(SHARED_ADDRESS_KEY);
    if (!raw) return;
    var data = JSON.parse(raw);
    if (!data || !data.ts) return;
    var fields = ['companyName', 'contact', 'postal', 'address', 'building', 'phone', 'note'];
    for (var i = 0; i < fields.length; i++) {
      var el = document.getElementById(fields[i]);
      if (el && data[fields[i]]) el.value = data[fields[i]];
    }
    if (data.address) updateCart();
  } catch (e) {}
}

// フォームフィールドの入力時に共有住所を保存
(function() {
  var fields = ['companyName', 'contact', 'postal', 'address', 'building', 'phone', 'note'];
  for (var i = 0; i < fields.length; i++) {
    var el = document.getElementById(fields[i]);
    if (el) {
      el.addEventListener('input', saveSharedAddress_);
    }
  }
})();

// 他タブでの住所変更をリアルタイム反映
window.addEventListener('storage', function(e) {
  if (e.key === SHARED_ADDRESS_KEY && e.newValue) {
    try {
      var data = JSON.parse(e.newValue);
      if (!data || !data.ts) return;
      var fields = ['companyName', 'contact', 'postal', 'address', 'building', 'phone', 'note'];
      for (var i = 0; i < fields.length; i++) {
        var el = document.getElementById(fields[i]);
        if (el && data[fields[i]] !== undefined) el.value = data[fields[i]];
      }
      if (data.address) updateCart();
    } catch (e) {}
  }
});

// =====================================================
// 認証UI
// =====================================================
function togglePw(btn) {
  var input = btn.previousElementSibling;
  if (input.type === 'password') { input.type = 'text'; btn.textContent = '\u{1F441}\u{FE0F}\u200D\u{1F5E8}\u{FE0F}'; }
  else { input.type = 'password'; btn.textContent = '\u{1F441}'; }
}

function openAuthModal_(mode) {
  var overlay = document.getElementById('authOverlay');
  if (!overlay) return;
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('forgotPwForm').style.display = 'none';
  document.getElementById('forgotEmailForm').style.display = 'none';
  var errEl = document.getElementById('authError');
  if (errEl) errEl.style.display = 'none';
  var recoverResult = document.getElementById('recoverEmailResult');
  if (recoverResult) recoverResult.style.display = 'none';

  if (mode === 'register') {
    document.getElementById('authModalTitle').textContent = '新規登録';
    document.getElementById('registerForm').style.display = '';
  } else if (mode === 'forgotPassword') {
    document.getElementById('authModalTitle').textContent = 'パスワードをお忘れの方';
    document.getElementById('forgotPwForm').style.display = '';
  } else if (mode === 'forgotEmail') {
    document.getElementById('authModalTitle').textContent = 'メールアドレスをお忘れの方';
    document.getElementById('forgotEmailForm').style.display = '';
  } else {
    document.getElementById('authModalTitle').textContent = 'ログイン';
    document.getElementById('loginForm').style.display = '';
  }
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeAuthModal_() {
  var overlay = document.getElementById('authOverlay');
  if (overlay) overlay.classList.remove('active');
  document.body.style.overflow = '';
}

function showAuthError_(msg) {
  var el = document.getElementById('authError');
  if (el) { el.textContent = msg; el.style.display = 'block'; }
}

function updateAuthUi_() {
  var area = document.getElementById('headerAuth');
  if (!area) return;

  // プロモバナーの表示制御
  var banner = document.getElementById('promoBanner');
  if (banner) {
    var dismissed = false;
    try { dismissed = sessionStorage.getItem('promoBannerDismissed') === '1'; } catch (e) {}
    var md = G.settings.memberDiscount;
    if (G.customer || dismissed || !(md && md.enabled)) {
      banner.style.display = 'none';
    } else {
      banner.style.display = 'block';
    }
    adjustHeaderForBanner_();
  }

  var cartBtnHtml = '<button class="auth-btn cart-header-btn" id="headerCartBtn" type="button" title="カート">&#x1F6D2;</button>';

  if (G.customer) {
    var md = G.settings.memberDiscount;
    var discountHtml = (md && md.enabled) ? '<span class="auth-discount">' + Math.round(md.rate * 100) + '%OFF</span>' : '';
    var pointsHtml = (G.customer.points > 0) ? '<span class="auth-points">' + G.customer.points + 'pt</span>' : '';
    var rankHtml = '';
    if (G.customer.rank && G.customer.rank.name) {
      rankHtml = '<span style="background:' + safeColor_(G.customer.rank.color) + ';color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700;">' + escHtml(G.customer.rank.name) + '</span>';
    }
    area.innerHTML = cartBtnHtml +
      '<div class="auth-user">' +
        '<span class="auth-user-name">' + escHtml(G.customer.companyName || G.customer.email) + '</span>' +
        rankHtml + discountHtml + pointsHtml +
      '</div>' +
      '<button class="auth-btn mypage" id="openMyPageBtn" type="button">マイページ</button>' +
      '<button class="auth-btn logout" id="logoutBtn" type="button">ログアウト</button>';
    var openMyPageBtn = document.getElementById('openMyPageBtn');
    if (openMyPageBtn) {
      openMyPageBtn.addEventListener('click', function() { openMyPage_(); });
    }
    var logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() { doLogout_(); });
    }
    // memberBadgeも更新
    updateMemberUI();
  } else {
    area.innerHTML = cartBtnHtml + '<button class="auth-btn" id="openAuthBtn" type="button">ログイン / 新規登録</button>';
    var openBtn = document.getElementById('openAuthBtn');
    if (openBtn) {
      openBtn.addEventListener('click', function() { openAuthModal_('login'); });
    }
    // memberBadgeがあれば削除
    var old = document.getElementById('memberBadge');
    if (old) old.remove();
  }

  // カートボタンのイベント
  var headerCart = document.getElementById('headerCartBtn');
  if (headerCart) {
    headerCart.addEventListener('click', function() {
      var cs = document.getElementById('cartSection');
      if (cs) cs.scrollIntoView({ behavior: 'smooth' });
    });
  }

  // モバイル認証エリアにミラーコピー
  var mobArea = document.getElementById('headerAuthMob');
  if (mobArea) {
    mobArea.innerHTML = area.innerHTML;
    var mobCart = mobArea.querySelector('#headerCartBtn');
    if (mobCart) {
      mobCart.id = 'headerCartBtnMob';
      mobCart.addEventListener('click', function() {
        var cs = document.getElementById('cartSection');
        if (cs) cs.scrollIntoView({ behavior: 'smooth' });
      });
    }
    var mobMyPage = mobArea.querySelector('#openMyPageBtn');
    if (mobMyPage) {
      mobMyPage.id = 'openMyPageBtnMob';
      mobMyPage.addEventListener('click', function() { openMyPage_(); });
    }
    var mobLogout = mobArea.querySelector('#logoutBtn');
    if (mobLogout) {
      mobLogout.id = 'logoutBtnMob';
      mobLogout.addEventListener('click', function() { doLogout_(); });
    }
    var mobAuth = mobArea.querySelector('#openAuthBtn');
    if (mobAuth) {
      mobAuth.id = 'openAuthBtnMob';
      mobAuth.addEventListener('click', function() { openAuthModal_('login'); });
    }
  }
}

function doLogin_() {
  var email = (document.getElementById('loginEmail').value || '').trim();
  var password = document.getElementById('loginPassword').value || '';
  var rememberMe = document.getElementById('rememberMe') ? document.getElementById('rememberMe').checked : false;

  if (!email || !password) { showAuthError_('メールアドレスとパスワードを入力してください'); return; }

  var btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'ログイン中...';

  runApi('apiLoginCustomer', 'bulk', { email: email, password: password, rememberMe: rememberMe })
    .then(function(res) {
      btn.disabled = false; btn.textContent = 'ログイン';
      if (res.ok && res.data) {
        G.sessionId = res.data.sessionId;
        G.customer = res.data.customer;
        try {
          localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: res.data.sessionId, customer: res.data.customer }));
        } catch (e) {}
        updateAuthUi_();
        closeAuthModal_();
        autoFillCustomerForm();
        updateCart();
      } else {
        showAuthError_(res.message || 'ログインに失敗しました');
      }
    })
    .catch(function(e) {
      btn.disabled = false; btn.textContent = 'ログイン';
      showAuthError_('ログインに失敗しました');
    });
}

function doRegister_() {
  var email = (document.getElementById('regEmail').value || '').trim();
  var password = document.getElementById('regPassword').value || '';
  var companyName = (document.getElementById('regCompanyName').value || '').trim();
  var phone = (document.getElementById('regPhone').value || '').trim();
  var postal = (document.getElementById('regPostal').value || '').trim();
  var address = (document.getElementById('regAddress').value || '').trim();
  var newsletter = document.getElementById('regNewsletter').checked;

  if (!email || !email.includes('@')) { showAuthError_('有効なメールアドレスを入力してください'); return; }
  if (!password || password.length < 6) { showAuthError_('パスワードは6文字以上で入力してください'); return; }
  if (!companyName) { showAuthError_('会社名/氏名は必須です'); return; }

  var btn = document.getElementById('registerBtn');
  btn.disabled = true; btn.textContent = '登録中...';

  runApi('apiRegisterCustomer', 'bulk', {
    email: email, password: password, companyName: companyName,
    phone: phone, postal: postal, address: address, newsletter: newsletter
  })
    .then(function(res) {
      btn.disabled = false; btn.textContent = '登録する';
      if (res.ok && res.data) {
        G.sessionId = res.data.sessionId;
        G.customer = res.data.customer;
        try {
          localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: res.data.sessionId, customer: res.data.customer }));
        } catch (e) {}
        updateAuthUi_();
        closeAuthModal_();
        autoFillCustomerForm();
        updateCart();
        var md = G.settings.memberDiscount;
        alert((md && md.enabled) ? '登録が完了しました！' + Math.round(md.rate * 100) + '%割引が適用されます' : '登録が完了しました！');
      } else {
        showAuthError_(res.message || '登録に失敗しました');
      }
    })
    .catch(function(e) {
      btn.disabled = false; btn.textContent = '登録する';
      showAuthError_('登録に失敗しました');
    });
}

function doLogout_() {
  var saved = null;
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (raw) saved = JSON.parse(raw);
  } catch (e) {}

  G.sessionId = null;
  G.customer = null;
  try { localStorage.removeItem(SESSION_KEY); } catch (e) {}
  updateAuthUi_();
  updateCart();

  if (saved && saved.sessionId) {
    runApi('apiLogoutCustomer', 'bulk', { sessionId: saved.sessionId }).catch(function() {});
  }
}

// =====================================================
// マイページ
// =====================================================
function safeColor_(c) { return /^#[0-9a-fA-F]{3,8}$/.test(c) ? c : '#64748b'; }
function showToast(msg) {
  var el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s;';
  document.body.appendChild(el);
  requestAnimationFrame(function() { el.style.opacity = '1'; });
  setTimeout(function() { el.style.opacity = '0'; setTimeout(function() { el.remove(); }, 300); }, 2500);
}

function openMyPage_() {
  var modal = document.getElementById('myPageModal');
  var overlay = document.getElementById('myPageOverlay');
  if (!modal) return;

  // ローカルデータで即時表示
  if (G.customer) {
    document.getElementById('mpEmail').value = G.customer.email || '';
    document.getElementById('mpCompanyName').value = G.customer.companyName || '';
    document.getElementById('mpPhone').value = String(G.customer.phone || '').replace(/^'/, '');
    document.getElementById('mpPostal').value = String(G.customer.postal || '').replace(/^'/, '');
    document.getElementById('mpAddress').value = G.customer.address || '';
    document.getElementById('mpPointBalance').textContent = String(G.customer.points || 0);
  }

  openBulkModal_(modal, overlay);
  loadMyPage_();
}

function loadMyPage_() {
  if (!G.sessionId) return;
  var orderList = document.getElementById('mpOrderList');
  if (orderList) orderList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">読み込み中...</div>';

  runApi('apiGetMyPage', 'bulk', { sessionId: G.sessionId })
    .then(function(res) {
      if (!res || !res.ok || !res.data) {
        showToast((res && res.message) || 'マイページの読み込みに失敗しました');
        return;
      }
      var d = res.data;
      // プロフィール
      document.getElementById('mpEmail').value = d.profile.email || '';
      document.getElementById('mpCompanyName').value = d.profile.companyName || '';
      document.getElementById('mpPhone').value = d.profile.phone || '';
      document.getElementById('mpPostal').value = d.profile.postal || '';
      document.getElementById('mpAddress').value = d.profile.address || '';
      document.getElementById('mpRegisteredAt').textContent = d.profile.registeredAt || '-';
      // ポイント
      document.getElementById('mpPointBalance').textContent = String(d.points || 0);
      if (G.customer) G.customer.points = d.points || 0;
      updateAuthUi_();
      // 統計データ
      if (d.stats) {
        document.getElementById('mpTotalOrders').textContent = String(d.stats.totalOrders || 0) + '回';
        document.getElementById('mpTotalItems').textContent = String(d.stats.totalItems || 0) + '点';
      }
      // ランク情報
      if (d.rank) {
        var r = d.rank;
        document.getElementById('mpTotalSpent').textContent = '¥' + numFmt(r.annualSpent || 0);
        document.getElementById('mpMemberRank').innerHTML = '<span style="color:' + safeColor_(r.color) + ';">' + escHtml(r.name || 'レギュラー') + '</span>';
        var rankCard = document.getElementById('mpRankCard');
        if (rankCard) {
          var gradients = {
            'DIAMOND': 'linear-gradient(135deg,#006064,#00838f)',
            'GOLD': 'linear-gradient(135deg,#78350f,#b45309)',
            'SILVER': 'linear-gradient(135deg,#475569,#64748b)',
            'REGULAR': 'linear-gradient(135deg,#1e293b,#334155)'
          };
          rankCard.style.background = gradients[r.rank] || gradients['REGULAR'];
        }
        document.getElementById('mpRankName').textContent = r.name || 'レギュラー';
        document.getElementById('mpRankPointRate').textContent = 'ポイント還元率: ' + Math.round((r.pointRate || 0.01) * 100) + '%';
        var benefits = [];
        if (r.freeShipping) benefits.push('送料無料');
        document.getElementById('mpRankBenefits').textContent = benefits.length > 0 ? '特典: ' + benefits.join('、') : '';
        var progressEl = document.getElementById('mpRankProgress');
        if (progressEl && r.nextRank && r.nextThreshold > 0) {
          var pct = Math.min(100, Math.round((r.annualSpent / r.nextThreshold) * 100));
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;margin-bottom:4px;">次のランク（' + escHtml(r.nextRank) + '）まであと ¥' + numFmt(r.remaining || 0) + '</div>'
            + '<div style="background:rgba(255,255,255,0.2);border-radius:4px;height:6px;overflow:hidden;"><div style="background:#fff;height:100%;border-radius:4px;width:' + pct + '%;transition:width .5s;"></div></div>'
            + '<div style="font-size:10px;opacity:0.6;margin-top:2px;text-align:right;">¥' + numFmt(r.annualSpent) + ' / ¥' + numFmt(r.nextThreshold) + '</div>';
        } else if (progressEl) {
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;">最高ランクに到達しています</div>';
        }
        if (G.customer) G.customer.rank = r;
        updateAuthUi_();
      } else if (d.stats) {
        document.getElementById('mpTotalSpent').textContent = '¥' + numFmt(d.stats.totalSpent || 0);
        var rank = getMemberRank_(d.stats.totalSpent || 0);
        document.getElementById('mpMemberRank').innerHTML = '<span style="color:' + safeColor_(rank.color) + ';">' + escHtml(rank.name) + '</span>';
      }
      // 注文履歴
      renderOrderHistory_(d.orders || []);
    })
    .catch(function() { showToast('マイページの読み込みに失敗しました'); });
}

function getMemberRank_(totalSpent) {
  if (totalSpent >= 500000) return { name: 'ダイヤモンド', color: '#00bcd4', pointRate: 5, freeShipping: true };
  if (totalSpent >= 200000) return { name: 'ゴールド', color: '#f59e0b', pointRate: 5, freeShipping: false };
  if (totalSpent >= 50000) return { name: 'シルバー', color: '#94a3b8', pointRate: 3, freeShipping: false };
  return { name: 'レギュラー', color: '#64748b', pointRate: 1, freeShipping: false };
}

function renderOrderHistory_(orders) {
  var el = document.getElementById('mpOrderList');
  if (!el) return;
  if (!orders || orders.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">注文履歴はまだありません</div>';
    return;
  }
  var html = '';
  for (var i = 0; i < orders.length; i++) {
    var o = orders[i];
    var statusClass = (o.status === '完了') ? 'done' : (o.status === '依頼中') ? 'active' : 'pending';
    var trackHtml = '';
    if (o.carrier && o.tracking) {
      trackHtml = '<div style="font-size:11px;color:#888;margin-top:4px;">配送: ' + escHtml(o.carrier) + ' ' + escHtml(o.tracking) + '</div>';
    }
    html += '<div class="mp-order-card">'
      + '<div class="mp-order-header">'
      + '<span class="mp-order-no">' + escHtml(o.receiptNo) + '</span>'
      + '<span class="mp-order-date">' + escHtml(o.date) + '</span>'
      + '<span class="mp-order-status ' + statusClass + '">' + escHtml(o.status) + '</span>'
      + '</div>'
      + '<div class="mp-order-products">' + escHtml(o.products) + '</div>'
      + '<div class="mp-order-footer">'
      + '<span>' + o.count + '点</span>'
      + '<span class="mp-order-total">¥' + numFmt(o.total) + '</span>'
      + '</div>'
      + trackHtml
      + '</div>';
  }
  el.innerHTML = html;
}

// =====================================================
// 認証UIイベント設定
// =====================================================
(function() {
  // モーダル開閉
  var openBtn = document.getElementById('openAuthBtn');
  if (openBtn) openBtn.addEventListener('click', function() { openAuthModal_('login'); });

  var closeBtn = document.getElementById('authCloseBtn');
  if (closeBtn) closeBtn.addEventListener('click', closeAuthModal_);

  // オーバーレイクリックで閉じる
  var overlay = document.getElementById('authOverlay');
  if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) closeAuthModal_(); });

  // ログイン/登録ボタン
  var loginBtn = document.getElementById('loginBtn');
  if (loginBtn) loginBtn.addEventListener('click', doLogin_);

  var registerBtn = document.getElementById('registerBtn');
  if (registerBtn) registerBtn.addEventListener('click', doRegister_);

  // フォーム切り替え
  var showReg = document.getElementById('showRegisterLink');
  if (showReg) showReg.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('register'); });

  var showLogin = document.getElementById('showLoginLink');
  if (showLogin) showLogin.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('login'); });

  var showForgotPw = document.getElementById('showForgotPwLink');
  if (showForgotPw) showForgotPw.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('forgotPassword'); });

  var showForgotEmail = document.getElementById('showForgotEmailLink');
  if (showForgotEmail) showForgotEmail.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('forgotEmail'); });

  // パスワードリセット
  var resetPwBtn = document.getElementById('resetPwBtn');
  if (resetPwBtn) {
    resetPwBtn.addEventListener('click', function() {
      var email = (document.getElementById('resetEmail').value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showAuthError_('有効なメールアドレスを入力してください'); return; }
      resetPwBtn.disabled = true; resetPwBtn.textContent = '送信中...';
      runApi('apiRequestPasswordReset', 'bulk', { email: email })
        .then(function(res) {
          if (res && res.ok) { alert(res.message || '仮パスワードを送信しました'); document.getElementById('resetEmail').value = ''; setTimeout(function() { openAuthModal_('login'); }, 500); }
          else { showAuthError_((res && res.message) || '送信に失敗しました'); }
        })
        .catch(function() { showAuthError_('送信に失敗しました'); })
        .finally(function() { resetPwBtn.disabled = false; resetPwBtn.textContent = '仮パスワードを送信'; });
    });
  }

  var backFromReset = document.getElementById('backToLoginFromReset');
  if (backFromReset) backFromReset.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('login'); });

  // メールアドレス確認
  var recoverBtn = document.getElementById('recoverEmailBtn');
  if (recoverBtn) {
    recoverBtn.addEventListener('click', function() {
      var cn = (document.getElementById('recoverCompanyName').value || '').trim();
      var ph = (document.getElementById('recoverPhone').value || '').trim();
      if (!cn) { showAuthError_('会社名/氏名を入力してください'); return; }
      if (!ph) { showAuthError_('電話番号を入力してください'); return; }
      recoverBtn.disabled = true; recoverBtn.textContent = '確認中...';
      var resultDiv = document.getElementById('recoverEmailResult');
      resultDiv.style.display = 'none';
      runApi('apiRecoverEmail', 'bulk', { companyName: cn, phone: ph })
        .then(function(res) {
          if (res && res.ok && res.data && res.data.maskedEmail) {
            resultDiv.innerHTML = 'ご登録のメールアドレス:<br><strong style="font-size:16px;">' + escHtml(res.data.maskedEmail) + '</strong>';
            resultDiv.style.display = 'block';
          } else { showAuthError_((res && res.message) || '一致する情報が見つかりませんでした'); }
        })
        .catch(function() { showAuthError_('確認に失敗しました'); })
        .finally(function() { recoverBtn.disabled = false; recoverBtn.textContent = 'メールアドレスを確認'; });
    });
  }

  var backFromRecover = document.getElementById('backToLoginFromRecover');
  if (backFromRecover) backFromRecover.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('login'); });

  // マイページモーダル
  var myPageCloseBtn = document.getElementById('myPageCloseBtn');
  if (myPageCloseBtn) myPageCloseBtn.addEventListener('click', function() { closeBulkModal_(document.getElementById('myPageModal'), document.getElementById('myPageOverlay')); });
  var myPageOverlay = document.getElementById('myPageOverlay');
  if (myPageOverlay) myPageOverlay.addEventListener('click', function() { closeBulkModal_(document.getElementById('myPageModal'), document.getElementById('myPageOverlay')); });

  // タブ切り替え
  var mpTabs = document.querySelectorAll('.mypage-tab');
  mpTabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      mpTabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      var target = tab.getAttribute('data-tab');
      document.getElementById('mypageProfile').style.display = (target === 'profile') ? '' : 'none';
      document.getElementById('mypageOrders').style.display = (target === 'orders') ? '' : 'none';
      document.getElementById('mypagePoints').style.display = (target === 'points') ? '' : 'none';
    });
  });

  // プロフィール編集
  var mpEditBtn = document.getElementById('mpEditBtn');
  var mpProfileFields = ['mpCompanyName', 'mpPhone', 'mpPostal', 'mpAddress'];
  function setProfileEditable_(editable) {
    for (var fi = 0; fi < mpProfileFields.length; fi++) {
      var inp = document.getElementById(mpProfileFields[fi]);
      if (inp) { inp.readOnly = !editable; inp.style.background = editable ? '#fff' : '#f5f5f5'; }
    }
    var eb = document.getElementById('mpEditBtn'); if (eb) eb.style.display = editable ? 'none' : '';
    var sb = document.getElementById('mpSaveBtn'); if (sb) sb.style.display = editable ? '' : 'none';
    var cb = document.getElementById('mpCancelEditBtn'); if (cb) cb.style.display = editable ? '' : 'none';
  }
  if (mpEditBtn) {
    mpEditBtn.addEventListener('click', function() {
      mpEditBtn._backup = {};
      for (var fi = 0; fi < mpProfileFields.length; fi++) {
        mpEditBtn._backup[mpProfileFields[fi]] = document.getElementById(mpProfileFields[fi]).value;
      }
      setProfileEditable_(true);
    });
  }
  var mpCancelEditBtn = document.getElementById('mpCancelEditBtn');
  if (mpCancelEditBtn) {
    mpCancelEditBtn.addEventListener('click', function() {
      if (mpEditBtn && mpEditBtn._backup) {
        for (var fi = 0; fi < mpProfileFields.length; fi++) {
          document.getElementById(mpProfileFields[fi]).value = mpEditBtn._backup[mpProfileFields[fi]] || '';
        }
      }
      setProfileEditable_(false);
    });
  }
  var mpSaveBtn = document.getElementById('mpSaveBtn');
  if (mpSaveBtn) {
    mpSaveBtn.addEventListener('click', function() {
      var pw = prompt('本人確認のため現在のパスワードを入力してください');
      if (!pw) return;
      mpSaveBtn.disabled = true; mpSaveBtn.textContent = '保存中...';
      runApi('apiUpdateCustomerProfile', 'bulk', {
        sessionId: G.sessionId,
        currentPassword: pw,
        companyName: document.getElementById('mpCompanyName').value,
        phone: document.getElementById('mpPhone').value,
        postal: document.getElementById('mpPostal').value,
        address: document.getElementById('mpAddress').value
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || '更新しました');
          if (G.customer) {
            G.customer.companyName = document.getElementById('mpCompanyName').value;
            G.customer.phone = document.getElementById('mpPhone').value;
            G.customer.postal = document.getElementById('mpPostal').value;
            G.customer.address = document.getElementById('mpAddress').value;
            try { localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: G.sessionId, customer: G.customer })); } catch (e) {}
            updateAuthUi_();
          }
          setProfileEditable_(false);
        } else {
          showToast((res && res.message) || '更新に失敗しました');
        }
      }).catch(function() { showToast('更新に失敗しました'); })
        .finally(function() { mpSaveBtn.disabled = false; mpSaveBtn.textContent = '変更を保存'; });
    });
  }
  var mpTogglePasswordBtn = document.getElementById('mpTogglePasswordBtn');
  if (mpTogglePasswordBtn) {
    mpTogglePasswordBtn.addEventListener('click', function() {
      var section = document.getElementById('mpPasswordSection');
      section.style.display = section.style.display === 'none' ? '' : 'none';
    });
  }
  var mpChangePassBtn = document.getElementById('mpChangePassBtn');
  if (mpChangePassBtn) {
    mpChangePassBtn.addEventListener('click', function() {
      var cur = document.getElementById('mpCurPass').value;
      var np = document.getElementById('mpNewPass').value;
      var npc = document.getElementById('mpNewPassConfirm').value;
      if (!cur) { showToast('現在のパスワードを入力してください'); return; }
      if (!np || np.length < 6) { showToast('新しいパスワードは6文字以上で入力してください'); return; }
      if (np !== npc) { showToast('新しいパスワードが一致しません'); return; }
      mpChangePassBtn.disabled = true; mpChangePassBtn.textContent = '変更中...';
      runApi('apiChangePassword', 'bulk', {
        sessionId: G.sessionId,
        currentPassword: cur,
        newPassword: np
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || 'パスワードを変更しました');
          document.getElementById('mpCurPass').value = '';
          document.getElementById('mpNewPass').value = '';
          document.getElementById('mpNewPassConfirm').value = '';
          document.getElementById('mpPasswordSection').style.display = 'none';
        } else {
          showToast((res && res.message) || 'パスワード変更に失敗しました');
        }
      }).catch(function() { showToast('パスワード変更に失敗しました'); })
        .finally(function() { mpChangePassBtn.disabled = false; mpChangePassBtn.textContent = 'パスワードを変更'; });
    });
  }

  // プロモバナー
  var promoClose = document.getElementById('promoClose');
  if (promoClose) {
    promoClose.addEventListener('click', function() {
      var b = document.getElementById('promoBanner');
      if (b) b.style.display = 'none';
      try { sessionStorage.setItem('promoBannerDismissed', '1'); } catch (e) {}
    });
  }
  var promoLink = document.getElementById('promoRegisterLink');
  if (promoLink) {
    promoLink.addEventListener('click', function(e) { e.preventDefault(); openAuthModal_('register'); });
  }

  // 共有住所を読み込み（セッション読み込み後に実行）
  setTimeout(function() {
    loadSharedAddress_();
    updateAuthUi_();
  }, 100);

  // 管理者モード: グローバル ADMIN_KEY を参照
  if (ADMIN_KEY) {
    document.body.classList.add('admin-mode');
    var adminBar = document.getElementById('adminBar');
    if (adminBar) adminBar.style.display = 'block';
    var adminExit = document.getElementById('adminExit');
    if (adminExit) {
      adminExit.addEventListener('click', function() {
        if (confirm('管理者モードを解除しますか？\n再度アクセスするには ?admin=xxx のURLが必要です。')) {
          try { localStorage.removeItem('_nk_owner_key'); } catch(e) {}
          location.reload();
        }
      });
    }

    // --- 管理設定パネル ---
    (function() {
      var fab = document.getElementById('adminSettingsFab');
      var panel = document.getElementById('settingsPanel');
      var closeBtn = document.getElementById('settingsClose');
      if (!fab || !panel) return;

      function showToast(msg) { alert(msg); }

      fab.addEventListener('click', function() {
        var isOpen = panel.classList.contains('open');
        if (isOpen) { panel.classList.remove('open'); return; }
        panel.classList.add('open');
        spLoadKomoju();
        spLoadDiscount();
      });
      if (closeBtn) closeBtn.addEventListener('click', function() { panel.classList.remove('open'); });

      function spLog(msg) {
        var el = document.getElementById('spLog');
        if (!el) return;
        el.style.display = 'block';
        el.textContent = (el.textContent ? el.textContent + '\n' : '') + msg;
        el.scrollTop = el.scrollHeight;
      }

      function spRunAdmin(fn, label) {
        spLog('実行: ' + label);
        runApi(fn).then(function(res) {
          if (res && res.ok) { showToast(label + ' 完了'); spLog('完了'); }
          else { showToast(res && res.message ? res.message : label + ' 失敗'); spLog('失敗'); }
        }).catch(function(e) { showToast(e.message || label + ' 失敗'); spLog('失敗: ' + (e.message || '')); });
      }
      document.getElementById('spBtnCompact').addEventListener('click', function() { spRunAdmin('adminCompactHolds', '期限切れ確保の整理'); });
      document.getElementById('spBtnRebuild').addEventListener('click', function() { spRunAdmin('adminRebuildStates', '状態の再構築'); });
      document.getElementById('spBtnClearCache').addEventListener('click', function() { spRunAdmin('adminClearProductsCache', '商品キャッシュ削除'); });
      document.getElementById('spBtnApplyDv').addEventListener('click', function() { spRunAdmin('adminApplyStatusDropdown', 'ステータスのプルダウン適用'); });

      // KOMOJU
      function spUpdateMode(mode, hasTestKey, hasLiveKey) {
        var badge = document.getElementById('spModeBadge');
        var btn = document.getElementById('spBtnToggleMode');
        var keys = document.getElementById('spModeKeys');
        if (!badge || !btn) return;
        badge.textContent = (mode === 'live') ? '本番' : 'テスト';
        badge.className = 'sp-badge ' + (mode === 'live' ? 'live' : 'test');
        btn.disabled = false;
        btn.textContent = (mode === 'live') ? 'テストに切替' : '本番に切替';
        if (keys) keys.textContent = 'テストキー: ' + (hasTestKey ? '設定済' : '未設定') + ' ／ 本番キー: ' + (hasLiveKey ? '設定済' : '未設定');
      }
      function spLoadKomoju() {
        runApi('adminGetKomojuMode').then(function(res) {
          if (res && res.ok) spUpdateMode(res.mode, res.hasTestKey, res.hasLiveKey);
          else document.getElementById('spModeBadge').textContent = '取得失敗';
        }).catch(function() { document.getElementById('spModeBadge').textContent = 'エラー'; });
      }
      document.getElementById('spBtnToggleMode').addEventListener('click', function() {
        var badge = document.getElementById('spModeBadge');
        var target = (badge.textContent === '本番') ? 'テスト' : '本番';
        if (!confirm('決済モードを「' + target + '」に切り替えますか？')) return;
        document.getElementById('spBtnToggleMode').disabled = true;
        runApi('adminToggleKomojuMode').then(function(res) {
          if (!res || !res.ok) { showToast(res && res.message ? res.message : '切替失敗'); document.getElementById('spBtnToggleMode').disabled = false; return; }
          return runApi('adminGetKomojuMode');
        }).then(function(info) {
          if (info && info.ok) spUpdateMode(info.mode, info.hasTestKey, info.hasLiveKey);
          showToast('切替完了');
        }).catch(function(e) { showToast(e.message || '切替失敗'); document.getElementById('spBtnToggleMode').disabled = false; });
      });

      // 会員割引
      function spUpdateDiscount(enabled, rate, endDate, reason) {
        var badge = document.getElementById('spDiscountBadge');
        var btn = document.getElementById('spBtnToggleDiscount');
        var info = document.getElementById('spDiscountInfo');
        if (!badge || !btn) return;
        badge.textContent = enabled ? 'ON' : 'OFF';
        badge.className = 'sp-badge ' + (enabled ? 'on' : 'off');
        btn.disabled = false;
        btn.textContent = enabled ? 'OFFにする' : 'ONにする';
        var t = '割引率: ' + Math.round((rate || 0) * 100) + '% ／ 期限: ' + (endDate || '未設定');
        if (reason === 'expired') t += '（期限切れ）';
        if (info) info.textContent = t;
      }
      function spLoadDiscount() {
        runApi('adminGetMemberDiscountStatus').then(function(res) {
          if (res && res.ok) spUpdateDiscount(res.enabled, res.rate, res.endDate, res.reason);
          else document.getElementById('spDiscountBadge').textContent = '取得失敗';
        }).catch(function() { document.getElementById('spDiscountBadge').textContent = 'エラー'; });
      }
      document.getElementById('spBtnToggleDiscount').addEventListener('click', function() {
        var badge = document.getElementById('spDiscountBadge');
        var target = (badge.textContent === 'ON') ? 'OFF' : 'ON';
        if (!confirm('会員割引を「' + target + '」に切り替えますか？')) return;
        document.getElementById('spBtnToggleDiscount').disabled = true;
        runApi('adminToggleMemberDiscount').then(function(res) {
          if (!res || !res.ok) { showToast(res && res.message ? res.message : '切替失敗'); document.getElementById('spBtnToggleDiscount').disabled = false; return; }
          spUpdateDiscount(res.enabled, res.rate, res.endDate, res.reason);
          showToast(res.message || '切替完了');
          document.getElementById('spBtnToggleDiscount').disabled = false;
        }).catch(function(e) { showToast(e.message || '切替失敗'); document.getElementById('spBtnToggleDiscount').disabled = false; });
      });
    })();
  }

  // 特商法モーダル
  var legalLink = document.getElementById('openLegalLink');
  var legalModal = document.getElementById('legalModal');
  var legalOverlay = document.getElementById('legalOverlay');
  var legalClose = document.getElementById('legalCloseBtn');
  function openBulkModal_(modal, overlay) {
    modal.style.display = 'block'; overlay.classList.add('active');
    if (typeof hideFabsForModal_ === 'function') hideFabsForModal_();
  }
  function closeBulkModal_(modal, overlay) {
    modal.style.display = 'none'; overlay.classList.remove('active');
    if (typeof showFabsAfterModal_ === 'function') showFabsAfterModal_();
  }

  if (legalLink && legalModal) {
    legalLink.addEventListener('click', function(e) { e.preventDefault(); openBulkModal_(legalModal, legalOverlay); });
    legalClose.addEventListener('click', function() { closeBulkModal_(legalModal, legalOverlay); });
    legalOverlay.addEventListener('click', function() { closeBulkModal_(legalModal, legalOverlay); });
  }

  // 商品ガイドモーダル
  var bulkGuideLink = document.getElementById('openBulkGuideLink');
  var bulkGuideModal = document.getElementById('bulkGuideModal');
  var bulkGuideOverlay = document.getElementById('bulkGuideOverlay');
  var bulkGuideClose = document.getElementById('bulkGuideCloseBtn');
  if (bulkGuideLink && bulkGuideModal) {
    bulkGuideLink.addEventListener('click', function(e) { e.preventDefault(); openBulkModal_(bulkGuideModal, bulkGuideOverlay); });
    bulkGuideClose.addEventListener('click', function() { closeBulkModal_(bulkGuideModal, bulkGuideOverlay); });
    bulkGuideOverlay.addEventListener('click', function() { closeBulkModal_(bulkGuideModal, bulkGuideOverlay); });
  }

  // 送料表モーダル
  var bulkShippingLink = document.getElementById('openBulkShippingLink');
  var bulkShippingModal = document.getElementById('bulkShippingModal');
  var bulkShippingOverlay = document.getElementById('bulkShippingOverlay');
  var bulkShippingClose = document.getElementById('bulkShippingCloseBtn');
  if (bulkShippingLink && bulkShippingModal) {
    bulkShippingLink.addEventListener('click', function(e) { e.preventDefault(); openBulkModal_(bulkShippingModal, bulkShippingOverlay); });
    bulkShippingClose.addEventListener('click', function() { closeBulkModal_(bulkShippingModal, bulkShippingOverlay); });
    bulkShippingOverlay.addEventListener('click', function() { closeBulkModal_(bulkShippingModal, bulkShippingOverlay); });
  }

  // プライバシーポリシーモーダル
  var privacyLink = document.getElementById('openPrivacyLink');
  var privacyModal = document.getElementById('privacyModal');
  var privacyOverlay = document.getElementById('privacyOverlay');
  var privacyClose = document.getElementById('privacyCloseBtn');
  if (privacyLink && privacyModal) {
    privacyLink.addEventListener('click', function(e) { e.preventDefault(); openBulkModal_(privacyModal, privacyOverlay); });
    privacyClose.addEventListener('click', function() { closeBulkModal_(privacyModal, privacyOverlay); });
    privacyOverlay.addEventListener('click', function() { closeBulkModal_(privacyModal, privacyOverlay); });
  }

  // お問い合わせモーダル
  var contactLink = document.getElementById('openContactLink');
  var contactLinkHeader = document.getElementById('openContactLinkHeader');
  var contactModal = document.getElementById('contactModal');
  var contactOverlay = document.getElementById('contactOverlay');
  var contactClose = document.getElementById('contactCloseBtn');
  if (contactModal) {
    var openContact = function(e) { e.preventDefault(); openBulkModal_(contactModal, contactOverlay); };
    if (contactLink) contactLink.addEventListener('click', openContact);
    if (contactLinkHeader) contactLinkHeader.addEventListener('click', openContact);
    if (contactClose) contactClose.addEventListener('click', function() { closeBulkModal_(contactModal, contactOverlay); });
    if (contactOverlay) contactOverlay.addEventListener('click', function() { closeBulkModal_(contactModal, contactOverlay); });
  }

  // お問い合わせ送信
  var contactSubmit = document.getElementById('contactSubmitBtn');
  if (contactSubmit) {
    contactSubmit.addEventListener('click', function() {
      var name = (document.getElementById('contactName').value || '').trim();
      var email = (document.getElementById('contactEmail').value || '').trim();
      var message = (document.getElementById('contactMessage').value || '').trim();
      if (!name || !email || !message) { alert('全ての項目を入力してください'); return; }
      contactSubmit.disabled = true;
      contactSubmit.textContent = '送信中...';
      runApi('apiSendContactForm', { name: name, email: email, message: message, page: 'アソート' })
        .then(function(res) {
          if (res && res.ok) {
            alert('お問い合わせを送信しました');
            document.getElementById('contactName').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('contactMessage').value = '';
            contactModal.style.display = 'none';
            contactOverlay.classList.remove('active');
          } else { alert((res && res.message) || '送信に失敗しました'); }
        })
        .catch(function(e) { alert(e.message || '送信に失敗しました'); })
        .finally(function() { contactSubmit.disabled = false; contactSubmit.textContent = '送信'; });
    });
  }
})();

</script>

<!-- スクロールトップボタン -->
<button class="toTop" id="toTopBtn" type="button" aria-label="ページ上部へ">↑</button>

<!-- === AI Chatbot Widget === -->
<button class="chatbot-fab" id="chatbotFab" type="button" aria-label="チャットで質問する">
  <span class="chatbot-fab-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/><circle cx="8" cy="10" r="1.2"/><circle cx="12" cy="10" r="1.2"/><circle cx="16" cy="10" r="1.2"/></svg></span>
  <span class="chatbot-fab-close"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></span>
  <span class="chatbot-badge" id="chatbotBadge">1</span>
</button>

<div class="chatbot-panel" id="chatbotPanel">
  <div class="chatbot-header">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    AIアシスタント
    <span class="chatbot-header-actions">
      <button class="chatbot-header-toTop" id="chatbotHeaderToTop" type="button" aria-label="ページ上部へ" title="ページ上部へ">↑</button>
      <button class="chatbot-close-btn" id="chatbotCloseBtn" type="button" aria-label="閉じる" title="閉じる">×</button>
    </span>
  </div>
  <div class="chatbot-messages" id="chatbotMessages"></div>
  <div class="chatbot-input-area">
    <textarea id="chatbotInput" placeholder="質問を入力してください..." rows="1"></textarea>
    <button class="chatbot-send-btn" id="chatbotSend" type="button" aria-label="送信"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
</div>

<script>
(function(){
  var fab = document.getElementById('chatbotFab');
  var panel = document.getElementById('chatbotPanel');
  var messagesEl = document.getElementById('chatbotMessages');
  var input = document.getElementById('chatbotInput');
  var sendBtn = document.getElementById('chatbotSend');
  var badge = document.getElementById('chatbotBadge');
  var closeBtn = document.getElementById('chatbotCloseBtn');
  var headerToTop = document.getElementById('chatbotHeaderToTop');
  var isOpen = false;
  var chatHistory = [];
  var isSending = false;
  var greeted = false;

  window.closeChatbot = function(){
    if (!isOpen) return;
    isOpen = false;
    window._chatbotIsOpen = false;
    panel.classList.remove('open');
    fab.classList.remove('open');
    updateToTopBtn_();
  };

  var FAQ = [
    // --- 注文・購入 ---
    { q: '注文方法を教えて', category: '注文・購入',
      a: '【ご注文方法】\n1. 商品を選んで数量を指定\n2. お届け先を入力\n3. 送料が自動計算されます\n4. お支払い方法を選んで注文確定\n\n詳しくは画面上部の「商品ガイド」もご覧ください。' },
    { q: '最低注文数は？', category: '注文・購入',
      a: 'アソート商品は各商品ごとに最低注文数が設定されています。商品カードに表示されている数量からご注文いただけます。' },
    { q: '注文後のキャンセルはできる？', category: '注文・購入',
      a: 'ご注文確定後のキャンセル・変更はお受けしておりません。\nご注文前に商品内容をよくご確認ください。\n\n万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。' },
    { q: 'デタウリとの違いは？', category: '注文・購入',
      a: '【アソートとデタウリの違い】\n・アソート：まとめ買い向け。数量指定で注文。\n・デタウリ：1点ずつ選ぶ個品販売。採寸データ付き。\n\n画面上部のナビから切り替えできます。' },

    // --- 送料・配送 ---
    { q: '送料はいくら？', category: '送料・配送',
      a: '【送料について】\n送料はお届け先の地域と荷物のサイズによって異なります。\n住所を入力すると自動計算されます。\n\n詳しくは画面上部の「アソート送料表」ボタンからご確認ください。' },
    { q: '配送にかかる日数は？', category: '送料・配送',
      a: '決済完了後、通常2〜5営業日で発送いたします。\nお届けまでの日数は地域により異なりますが、発送から1〜3日程度です。\n\n※繁忙期や天候・災害等により遅延する場合がございます。' },
    { q: '送料無料になる条件は？', category: '送料・配送',
      a: 'ダイヤモンド会員のお客様は送料無料です！\n\nダイヤモンド会員になるには、累計購入額30万円以上が条件となります。\n詳しくは「会員ランクについて」をご確認ください。' },

    // --- 決済 ---
    { q: '決済方法は？', category: '決済',
      a: '【ご利用可能な決済方法】\n・クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）\n・Apple Pay\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n・PayPay\n・ペイジー（振込手数料はお客様負担）\n\nクレジットカード・Apple Pay・PayPayが最もスムーズにお手続きいただけます。' },
    { q: 'コンビニ決済の手数料は？', category: '決済',
      a: 'コンビニ決済をご利用の場合、別途220円の手数料がかかります。\n\n手数料を抑えたい場合は、クレジットカード・Apple Pay・PayPay決済がおすすめです。' },
    { q: '銀行振込の手数料は？', category: '決済',
      a: '銀行振込をご利用の場合、振込手数料はお客様のご負担となります。\n手数料の金額はご利用の金融機関により異なります。\nペイジーも同様です。' },

    // --- 割引・セール ---
    { q: '割引はある？', category: '割引・セール',
      a: '【現在の割引制度】\n\n1. 会員登録割引：10%OFF（2026年9月末まで）\n2. クーポンコードによる割引\n\n詳しくはスタッフまでお問い合わせください。' },
    { q: '会員割引の期間は？', category: '割引・セール',
      a: '会員登録で全品10%OFFの特典は2026年9月末までの期間限定です。\n\n・無料登録するだけで適用\n・期間中はいつでもご利用いただけます\n\nお早めの登録がおすすめです！' },

    // --- 会員 ---
    { q: '会員登録の方法は？', category: '会員',
      a: '【会員登録の方法】\n画面上部の「ログイン / 新規登録」ボタンからお手続きいただけます。\n\n・メールアドレスとパスワードの設定だけで完了\n・登録は無料です\n・登録直後から会員割引（10%OFF）が適用されます' },
    { q: '会員ランクについて', category: '会員',
      a: '【会員ランク制度】\n\n・レギュラー：初回登録時（10%OFF特典）\n・シルバー：累計5万円以上\n・ゴールド：累計15万円以上\n・ダイヤモンド：累計30万円以上（送料無料！）\n\nランクが上がるほど特典が充実します。' },
    { q: 'ダイヤモンド会員の特典は？', category: '会員',
      a: '【ダイヤモンド会員特典】\n・送料無料（国内全域）\n・優先在庫確保\n\n条件：累計購入額30万円以上\nたくさんご利用いただくほどお得になります！' },

    // --- 返品・サポート ---
    { q: '返品・交換はできる？', category: '返品・サポート',
      a: '返品・交換は原則お受けしておりません。\n\nただし、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。\n\n✉ お問い合わせ よりご連絡いただけます。' },
    { q: 'お問い合わせしたい', category: '返品・サポート',
      a: 'お問い合わせは以下の方法で承っております：\n\n✉ お問い合わせ フォームからご連絡ください。\n\n営業時間内にご返信いたします。\nお気軽にどうぞ！' },
    { q: '営業時間は？', category: '返品・サポート',
      a: '営業時間：平日 10:00〜18:00\n（土日祝はお休みです）\n\n営業時間外のお問い合わせは翌営業日にご返信いたします。' }
  ];

  var GREETING = 'こんにちは！アソート商品についてご質問があればお気軽にどうぞ。\nご質問のカテゴリをお選びいただくか、下の入力欄から自由にご質問ください。';

  function toggleChat(){
    isOpen = !isOpen;
    window._chatbotIsOpen = isOpen;
    panel.classList.toggle('open', isOpen);
    fab.classList.toggle('open', isOpen);
    badge.classList.remove('show');
    if (isOpen && !greeted) {
      greeted = true;
      appendMessage('bot', GREETING);
      showCategoryButtons();
    }
    if (isOpen) {
      setTimeout(function(){ input.focus(); }, 200);
      scrollToBottom();
    }
    updateToTopBtn_();
  }

  function showCategoryButtons(){
    var categories = [];
    var seen = {};
    FAQ.forEach(function(item){
      if (!seen[item.category]) { seen[item.category] = true; categories.push(item.category); }
    });
    var wrap = document.createElement('div');
    wrap.className = 'chatbot-quick-replies';
    wrap.style.cssText = 'margin-top:6px;';
    categories.forEach(function(cat){
      var b = document.createElement('button');
      b.className = 'chatbot-quick-btn';
      b.textContent = cat;
      b.type = 'button';
      b.addEventListener('click', function(){
        showQuestionsForCategory(cat);
      });
      wrap.appendChild(b);
    });
    messagesEl.appendChild(wrap);
    scrollToBottom();
  }

  function showQuestionsForCategory(cat){
    appendMessage('user', cat);
    var items = FAQ.filter(function(f){ return f.category === cat; });
    var botMsg = document.createElement('div');
    botMsg.className = 'chatbot-msg bot';
    botMsg.style.cssText = 'padding-bottom:6px;';
    botMsg.textContent = '「' + cat + '」に関するご質問をお選びください。';
    messagesEl.appendChild(botMsg);

    var wrap = document.createElement('div');
    wrap.className = 'chatbot-quick-replies';
    wrap.style.cssText = 'padding:0 2px;margin-top:4px;';
    items.forEach(function(item){
      var b = document.createElement('button');
      b.className = 'chatbot-quick-btn';
      b.textContent = item.q;
      b.type = 'button';
      b.addEventListener('click', function(){
        handleQuickReply(item);
      });
      wrap.appendChild(b);
    });
    var back = document.createElement('button');
    back.className = 'chatbot-quick-btn';
    back.style.cssText = 'border-color:#94a3b8;color:#64748b;';
    back.textContent = '\u2190 カテゴリに戻る';
    back.type = 'button';
    back.addEventListener('click', function(){
      appendMessage('user', 'カテゴリに戻る');
      var note = document.createElement('div');
      note.className = 'chatbot-msg bot';
      note.textContent = 'カテゴリをお選びください。';
      messagesEl.appendChild(note);
      showCategoryButtons();
    });
    wrap.appendChild(back);
    messagesEl.appendChild(wrap);
    scrollToBottom();
  }

  function handleQuickReply(item){
    appendMessage('user', item.q);
    chatHistory.push({ role: 'user', content: item.q });
    var answerDiv = appendMessageAndReturn('bot', item.a);
    chatHistory.push({ role: 'assistant', content: item.a });
    showAfterAnswer(answerDiv);
  }

  function showAfterAnswer(answerEl){
    var note = document.createElement('div');
    note.className = 'chatbot-msg bot';
    note.textContent = '他にもご質問がありましたら、カテゴリをお選びいただくか、自由に入力してください。';
    messagesEl.appendChild(note);
    showCategoryButtons();
    appendStaffContactButton();
    scrollToElement(answerEl);
  }

  function appendStaffContactButton(){
    var wrap = document.createElement('div');
    wrap.style.cssText = 'padding:0 2px;margin-top:4px;text-align:center;';
    var btn = document.createElement('button');
    btn.className = 'chatbot-staff-btn';
    btn.type = 'button';
    btn.textContent = '\u2709 スタッフに問い合わせる';
    btn.addEventListener('click', function(){ showContactForm_(); });
    wrap.appendChild(btn);
    messagesEl.appendChild(wrap);
  }

  function showContactForm_(){
    // Tawk.to が読み込み済みならライブチャットを起動
    if (typeof Tawk_API !== 'undefined' && Tawk_API.maximize) {
      appendMessage('bot', 'スタッフとのライブチャットを開きます。');
      scrollToBottom();
      window.closeChatbot();
      Tawk_API.maximize();
      return;
    }
    // フォールバック: インラインフォームでメール問い合わせ
    appendMessage('user', 'スタッフに問い合わせる');
    var cust = (typeof G !== 'undefined' && G && G.customer) ? G.customer : null;
    var prefillName = (cust && cust.companyName) || '';
    var prefillEmail = (cust && cust.email) || '';
    var lastUserMsg = '';
    for (var i = chatHistory.length - 1; i >= 0; i--) {
      if (chatHistory[i].role === 'user' && chatHistory[i].content !== 'スタッフに問い合わせる') {
        lastUserMsg = chatHistory[i].content; break;
      }
    }
    var formDiv = document.createElement('div');
    formDiv.className = 'chatbot-msg bot';
    formDiv.innerHTML =
      '<div style="margin-bottom:6px;font-weight:600;">スタッフへのお問い合わせ</div>' +
      '<div style="font-size:12px;color:#64748b;margin-bottom:8px;">内容を入力して送信してください。2営業日以内にメールでご返信いたします。</div>' +
      '<div class="chatbot-contact-form">' +
      '<label>お名前 *</label><input type="text" id="chatContactName" value="' + escAttr(prefillName) + '" placeholder="会社名/氏名">' +
      '<label>メールアドレス *</label><input type="email" id="chatContactEmail" value="' + escAttr(prefillEmail) + '" placeholder="返信先メールアドレス">' +
      '<label>お問い合わせ内容 *</label><textarea id="chatContactMsg" placeholder="お問い合わせ内容をご記入ください">' + escHtml(lastUserMsg) + '</textarea>' +
      '<button class="chatbot-contact-btn" id="chatContactSubmit" type="button">送信</button>' +
      '</div>';
    messagesEl.appendChild(formDiv);
    scrollToBottom();
    var nameEl = document.getElementById('chatContactName');
    if (nameEl && !prefillName) nameEl.focus();
    document.getElementById('chatContactSubmit').addEventListener('click', submitChatContact_);
  }
  window.showChatContactForm_ = showContactForm_;

  function submitChatContact_(){
    var nameEl = document.getElementById('chatContactName');
    var emailEl = document.getElementById('chatContactEmail');
    var msgEl = document.getElementById('chatContactMsg');
    var btn = document.getElementById('chatContactSubmit');
    if (!nameEl || !emailEl || !msgEl || !btn) return;
    var name = (nameEl.value || '').trim();
    var email = (emailEl.value || '').trim();
    var message = (msgEl.value || '').trim();
    if (!name || !email || !message) {
      appendMessage('bot', '全ての項目を入力してください。');
      scrollToBottom();
      return;
    }
    btn.disabled = true;
    btn.textContent = '送信中...';
    runApi('apiSendContactForm', { name: name, email: email, message: message, page: 'アソート' })
      .then(function(res){
        if (res && res.ok) {
          appendMessage('bot', 'お問い合わせを送信しました。2営業日以内にご返信いたします。\n引き続きご質問がありましたらお気軽にどうぞ。');
          showCategoryButtons();
          appendStaffContactButton();
        } else {
          appendMessage('bot', (res && res.message) || '送信に失敗しました。お手数ですがもう一度お試しください。');
          btn.disabled = false;
          btn.textContent = '送信';
        }
      })
      .catch(function(){
        appendMessage('bot', '送信に失敗しました。お手数ですがもう一度お試しください。');
        btn.disabled = false;
        btn.textContent = '送信';
      });
  }

  function appendMessage(role, text){
    appendMessageAndReturn(role, text);
  }

  function appendMessageAndReturn(role, text){
    var div = document.createElement('div');
    div.className = 'chatbot-msg ' + role;
    if (role === 'bot') {
      var span = document.createElement('span');
      span.textContent = text;
      var safe = span.innerHTML;
      safe = safe.replace(/✉\s*お問い合わせ/g, '<a href="#" style="color:#3b82f6;text-decoration:underline;cursor:pointer;" onclick="event.preventDefault();if(typeof showChatContactForm_===\'function\')showChatContactForm_();return false;">✉ お問い合わせ</a>');
      div.innerHTML = safe;
    } else {
      div.textContent = text;
    }
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function showTyping(){
    var div = document.createElement('div');
    div.className = 'chatbot-msg typing';
    div.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function removeTyping(el){
    if (el && el.parentNode) el.parentNode.removeChild(el);
  }

  function scrollToBottom(){
    requestAnimationFrame(function(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  function scrollToElement(el){
    if (!el) return;
    requestAnimationFrame(function(){
      var containerTop = messagesEl.getBoundingClientRect().top;
      var elTop = el.getBoundingClientRect().top;
      var offset = elTop - containerTop;
      messagesEl.scrollTop = messagesEl.scrollTop + offset - 8;
    });
  }

  function getKeywords(q){
    var words = q.replace(/[\s　?？!！。、.,を・はのにてでがもとへ]/g, ' ').split(/\s+/).filter(function(w){ return w.length >= 2; });
    return words.map(function(w){ return w.toLowerCase(); });
  }

  function matchFaq(text){
    var t = text.toLowerCase().replace(/[\s　?？!！。、.,]/g, '');
    var best = null;
    var bestScore = 0;
    FAQ.forEach(function(item){
      var score = 0;
      var keywords = getKeywords(item.q);
      keywords.forEach(function(kw){
        if (t.indexOf(kw) !== -1) score += kw.length;
      });
      if (score > bestScore) { bestScore = score; best = item; }
    });
    return bestScore >= 2 ? best : null;
  }

  function isUnanswerable(reply){
    var markers = ['わかりません', 'お答えできません', '情報がありません', '対応できません'];
    var r = reply.toLowerCase();
    return markers.some(function(m){ return r.indexOf(m) !== -1; });
  }

  function getUserKey_(){
    if (typeof bulkState_ !== 'undefined' && bulkState_ && bulkState_.userKey) return bulkState_.userKey;
    try {
      var k = localStorage.getItem('detauri_userKey');
      if (k) return k;
    } catch(e){}
    return 'chatbot_anon_' + Math.random().toString(36).slice(2, 10);
  }

  function sendMessage(){
    if (isSending) return;
    var text = (input.value || '').trim();
    if (!text) return;
    if (text.length > 500) {
      appendMessage('bot', 'メッセージは500文字以内でお願いします。');
      return;
    }

    appendMessage('user', text);
    chatHistory.push({ role: 'user', content: text });
    input.value = '';
    input.style.height = 'auto';

    var matched = matchFaq(text);
    if (matched) {
      var ansDiv = appendMessageAndReturn('bot', matched.a);
      chatHistory.push({ role: 'assistant', content: matched.a });
      showAfterAnswer(ansDiv);
      return;
    }

    isSending = true;
    sendBtn.disabled = true;
    var typingEl = showTyping();

    runApi('apiChatbot', getUserKey_(), { message: text, history: chatHistory.slice(-6) })
      .then(function(res){
        removeTyping(typingEl);
        var reply = (res && res.reply) ? res.reply : '';
        var ansDiv;
        if (!reply || isUnanswerable(reply)) {
          var fallback = '申し訳ございません。お探しの情報が見つかりませんでした。\n\n詳しくは ✉ お問い合わせ よりスタッフにお問い合わせください。\n担当者が直接ご対応いたします。';
          ansDiv = appendMessageAndReturn('bot', fallback);
          chatHistory.push({ role: 'assistant', content: fallback });
        } else {
          ansDiv = appendMessageAndReturn('bot', reply);
          chatHistory.push({ role: 'assistant', content: reply });
        }
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-12);
        showAfterAnswer(ansDiv);
      })
      .catch(function(){
        removeTyping(typingEl);
        var fallback = '一時的に接続できませんでした。\n\nお手数ですが、もう一度お試しいただくか、✉ お問い合わせ よりスタッフにご連絡ください。';
        var ansDiv = appendMessageAndReturn('bot', fallback);
        chatHistory.push({ role: 'assistant', content: fallback });
        showAfterAnswer(ansDiv);
      })
      .finally(function(){
        isSending = false;
        sendBtn.disabled = false;
        input.focus();
      });
  }

  fab.addEventListener('click', toggleChat);
  closeBtn.addEventListener('click', function() { window.closeChatbot(); });
  if (headerToTop) {
    headerToTop.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  }
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
  });

  setTimeout(function() { badge.classList.add('show'); }, 3000);
})();

// スクロールトップボタン & モーダル時チャットボット非表示
(function() {
  var topBtn = document.getElementById('toTopBtn');
  var chatFab = document.getElementById('chatbotFab');
  var threshold = 400;
  var ticking = false;

  window.updateToTopBtn_ = function() {
    var chatOpen = window._chatbotIsOpen;
    var hasModal = document.querySelector('.bulk-modal[style*="display: block"]') ||
                   document.querySelector('.bulk-modal[style*="display:block"]') ||
                   (document.getElementById('productModal') && document.getElementById('productModal').classList.contains('active'));
    if (chatOpen || hasModal) {
      if (topBtn) topBtn.classList.remove('show');
      return;
    }
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > threshold) { if (topBtn) topBtn.classList.add('show'); }
    else { if (topBtn) topBtn.classList.remove('show'); }
  };

  window.hideFabsForModal_ = function() {
    if (chatFab) chatFab.style.display = 'none';
    if (topBtn) topBtn.classList.remove('show');
  };

  window.showFabsAfterModal_ = function() {
    if (chatFab) chatFab.style.display = '';
    updateToTopBtn_();
  };

  if (topBtn) {
    topBtn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  }

  var onScroll = function() {
    if (!ticking) { ticking = true; requestAnimationFrame(function() { ticking = false; updateToTopBtn_(); }); }
  };
  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', onScroll);
  updateToTopBtn_();
})();
</script>

<!--Start of Tawk.to Script-->
<!--
  Tawk.to ライブチャット設定
  1. https://www.tawk.to/ でアカウント作成（無料）
  2. ダッシュボードの Administration > Chat Widget > Direct Chat Link から
     プロパティID と ウィジェットID を取得
     （URL形式: https://tawk.to/chat/PROPERTY_ID/WIDGET_ID）
  3. 下の YOUR_TAWK_PROPERTY_ID と YOUR_TAWK_WIDGET_ID を実際のIDに置き換える
  4. 設定完了後、「スタッフに問い合わせる」ボタンからライブチャットが起動
-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{};
Tawk_API.onLoad=function(){ Tawk_API.hideWidget(); };
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/YOUR_TAWK_PROPERTY_ID/YOUR_TAWK_WIDGET_ID';
s1.charset='UTF-8';s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->
</body>
</html>
