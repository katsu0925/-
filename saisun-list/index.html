<!-- v2.1.0 -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>„Éá„Çø„Ç¶„É™.Detauri</title>
  <meta property="og:title" content="„Éá„Çø„Ç¶„É™.Detauri">
  <meta property="og:description" content="Êé°ÂØ∏„Éá„Éº„Çø‰ªò„ÅçÂè§ÁùÄÂç∏ - 10ÁÇπ„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ">
  <meta property="og:type" content="website">
  <meta name="description" content="Êé°ÂØ∏„Éá„Éº„Çø‰ªò„ÅçÂè§ÁùÄÂç∏ - 10ÁÇπ„Åã„ÇâË≥ºÂÖ•ÂèØËÉΩ">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20100%20100%22%3E%0A%20%20%3C%21--%20Cart%20body%20--%3E%0A%20%20%3Cpath%20d%3D%22M22%2032%20L28%2068%20H74%20L82%2032%20Z%22%20fill%3D%22%23fff5f5%22%20stroke%3D%22%23333%22%20stroke-width%3D%224%22%20stroke-linejoin%3D%22round%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3C%21--%20Handle%20--%3E%0A%20%20%3Cpath%20d%3D%22M22%2032%20L14%2018%22%20fill%3D%22none%22%20stroke%3D%22%23333%22%20stroke-width%3D%224%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3C%21--%20Red%20items%20inside%20cart%20--%3E%0A%20%20%3Crect%20x%3D%2234%22%20y%3D%2240%22%20width%3D%2213%22%20height%3D%2220%22%20rx%3D%223%22%20fill%3D%22%23dc2626%22/%3E%0A%20%20%3Crect%20x%3D%2251%22%20y%3D%2244%22%20width%3D%2213%22%20height%3D%2216%22%20rx%3D%223%22%20fill%3D%22%23ef4444%22/%3E%0A%20%20%3C%21--%20Red%20badge%20%28notification%20dot%29%20--%3E%0A%20%20%3Ccircle%20cx%3D%2280%22%20cy%3D%2222%22%20r%3D%2212%22%20fill%3D%22%23dc2626%22/%3E%0A%20%20%3Ctext%20x%3D%2280%22%20y%3D%2227%22%20text-anchor%3D%22middle%22%20fill%3D%22%23fff%22%20font-size%3D%2216%22%20font-weight%3D%22bold%22%20font-family%3D%22Arial%2Csans-serif%22%3E%21%3C/text%3E%0A%20%20%3C%21--%20Wheels%20--%3E%0A%20%20%3Ccircle%20cx%3D%2236%22%20cy%3D%2276%22%20r%3D%225%22%20fill%3D%22%23333%22/%3E%0A%20%20%3Ccircle%20cx%3D%2266%22%20cy%3D%2276%22%20r%3D%225%22%20fill%3D%22%23333%22/%3E%0A%3C/svg%3E">
  <link rel="icon" type="image/png" sizes="48x48" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABmJLR0QA/wD/AP+gvaeTAAAFDklEQVRoge2YXWhbZRjH/885Tda0a3UVt64bnfbTWZxtQ1u8EDomFPFCBTcY7Gpj7GLQCzt7IXMgqBdTZxW24c3KGMjUbRcTBGHYXs2mppStS1tjk3RQaz/d1vTrnJycx4smTXJyTs85aaaD5QchOc/7PC//f95z3udNgBw5nm7o/xagx2htbZmD6DkZmNw7Ojq/Ue4TY4ABGqupOUbMnSCqXg8T9RHzmUq//5Ze3RNhgAEhWFNzmYEjRikMdFT7/V9pBwSjSd1ud0t9ff2zWVO5AYHq6vc3EA8ARMAXY7W1+7UDugYaGhpeBtCXl5d3LVsijfDV1TlB9GGqqjI8c8WDHQecKVGo6hltva6BcDgcABBk5gNut/udbArW4opEWgBsSwmyBJZWoUqcmkz0+p19+wqTQ7oGxsbGJCLqjF1+WVVVtSVrijVEiUrTgixBXZXAMmtHRNfq6o7kgOEz4PV6rzPzLQAVxcXF7dkQqwcBOtvkCuRbP2BlQtUOsKgoKfmGBgCAmU8BiBLRR01NTenfVBYoCIf7CFhKCQo74XrvGApfytOmeyuDwUcpqRtNPjg4eAdAN4AiZv44C3rTKJucXGbg65SgOoFHR17DzK+yNv0zbcC0D7S0tOxQFOVPZt5KRNeJ6J9NKdbBySx8srT0Zrmq7jLKIeBcpd/foRM3x+12fwfg8CY0mpIH4F1JwluRCFyceHgjRLMO5g+q/P7LRnWmENF5Zj784p49OHH0aHYUGzCtKHBOTODHK1cwKctYFIRXfxkY+Nso35IBURSHFEXh5ZUVemN/WjPMOrNzc7jd3Q0IQmBgA/GAyUMcx+PxLAD4a2Z2FotLS6b5m2XI54t/7DPLtbQCMYaZeXdofByv1NWtB+VAAHNnz0INhxOTlpbi+dOnIZaU2Jg+wd179wAAzPybWa6lFYhN5gOA0P37KfGHly5hpb8f0sjI+muppwePrl61pzqJu7EVICJTA5ZXgIiGASAQCqXEVUnSzVeXl9feZ2awfO4c1AcPEnO5XCg4eRJidXVanaIo+MPvB4DloqKiu2a6LK+AqqprKzA+brUEACD39EAZGYE6NbX+ioZCWL2mf9Ad9fshyTKY+ffe3l7FbH7LBpxOpw8Aa1fAlEhEN8wGKzdk4/YBbBj4r3aioeFhAI/BQAwfM9u+jewQ34FEUfRYybdlgJmHASD4mAzMzs1hanoaAIIej2faSo0tA4Ig+IBUA4LLpZ8bjxuMU35+WiypgVm6fQB7jQzRaHRYEAQEkx7kbcePIzo/j+jDh4lJt29H8cGDAIAtbW2IBgJQp6YS4gsKkH/oUNr8dhpYRgacTqdPURQOjo+vn2Id5eXYeeGCYQ1t3YrCzk7D8WTsNLA4tm6hx7kT2W1gcWytQAwfM+++cfMmykqz9ytzemYGkiyDiLxWGlicTAwMAWj75uLFDErNYebbdvJtGxBF8YKqqi4ADru1ZqiqKjscjvN2ajb132hjY6ObiLoA7ALwE4BTAwMD+meHJFpbW/MXFha6iKgNQIiI2r1e771MNGRyC8UhIroBoDx23Q4gCO0/DDosLi52ENGJ2OULzPw9gLqNaoywe5RYp7m5uQQJ8XEardQyc70mtLe1tTW9s1kgYwP9/f3zAAKasKXzCzP3a0J3ent7VzPRkbEBABAE4W0AP2Nta/20oqLiWyt1RNRFRJ9j7WfqzWg0mt6Wc+TIkSNHjqeBfwFCnxOlKDYxhQAAAABJRU5ErkJggg==">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,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">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAABmJLR0QA/wD/AP+gvaeTAAAQLklEQVR4nO3df3Ac5XkH8O+7d5LOkiXbgE2QCGD9MljFMjqjmtZpnJAxk2Q6BRqFSd3UmZSmM2UggYzbtENJG1MmhZQ6E/gjacMPkwwUd/B0AsEDBAyt61riZFv2GeskWcQkyDaSbf2y7uc+/UNakIRuT7f77o937/nM8Mdxu+8+ix9ev/s8u3sAY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGOMMcYYYzIJrwNg/vd+bW3lZGXlJk3TNkOI3yGiZgCrACyd2WQCwFkQ9UKIYxrRvsjk5P7a99+/6HasnNAsr/41az4jiL5OQtwOospi9hXAJAEvkK7/tKm//02nYlzguIzN1dfYuEXTtO8R8LtSBhTigCB6oCGReE3KeGaHcvoATB2DLS2f0NPpH5EQX3LoEM9rmcw99YODZxwanxOaTRtobv4cAT8DcLnDhzoNIbY29va+7sTgmhODMrX0Nzf/GQEvw/lkBoBPgOiV/ubmv3BicE7oEtff1HQPgKcAhF08bAjAj/ubmu6WPTAvOUrYwJo1W4loF7yb2HQAWxsTiedkDcgJXaIGrr32etL1gwCWeBxKUie6qbmv77CMwXjJUYLeu/LKJaTr/wnvkxkAIkKIZwevuSYiYzDH102tra115eXly6uqqnr37duXdfp4rLBUVdXfYbrbZ42oQeT2P0VlbWj6M2WR3vsTTPTnrA0HXJstL/8OgH+wHNNHYzmjtbW1LhwO7wLw2Zl/dQbA3bFYbLdTx2SFDdTXX0XhcAJAheVBtMux7Mlf4bKNZdOfaRITd23EmV+l7YSWJF1vaurv/42dQRxZcnR0dITC4fCL+CiZgemS0HNtbW2fcuKYbHEoHN4OO8kMAJSGnqb8n62JiFBou91BHEnokydP/gGA9QsdTwjxWEdHR8iJ4zJzA/X1yyDE120PRGnQnIROzf1s3Z19jY01dgZw6qLwKpPv1g0ODt7p0HGZCT0c7ij2JqOFZUBpfdbnNMjWamMGUaUmxB/bGcKRhCaiYwW+/140Gl3mxLFZfoJI2j0alMrM+iRthobd+0gcSeju7u4YgDdMNlkF4H4njs0WFm9pKRdCbJIzGoFSs6ZkkjRDT/vU29FomdWdHatD67p+LwCzOs497e3t1ktHrCiRbHYdAVVyRiNQel5Cp+TM0ACql42OXm91Z8cS+tChQ0eEED812aQ8l8v9s1PHZ3PpwLXyRptO6I9SWOoMDU2INZb3lRfGx6XT6b8HMGqyya3RaHSLkzGwaRpRvczxPr7kkDZDg4AGq/s6mtA9PT1nieifCmz2r5s3b3bzTq+SRICtctjHxpuX0Lq8JQegaZYLBo7fy5FKpX4IoM9kk7UTExN/7nQcpY6klOs+HA1IpT76qKdAEm9qIF23vNZ3PKHj8XiaiP7GbBsi2sFlPMelCm+yWPOqHJkUSOYELcSU5X3lhZFfd3f3HgCvmmyyElzGc5QAxmWON6fKkZab0LqNWF27fVTTtHsBmP3FxGU8B5EQpySOBv30CSS7u6f/iQ0gpxfea7E0ol9b3de1i7Gurq74hg0bniCib+TZxCjj3eZWTKVEA05InERB+x/F+/slDjh77FCo1+q+rj6xsm7dulVlZWUJAGbr5VtisdgrbsVUKuItLUsrMplzACx34T4klqJiyx8istK4H3oK6df3YGpIyjSdnoxELmnt6Zm0FJqMCIrR1ta2XQjxsMkmx6urq1v5YQD5+pub9wP4PdsDaZ/E8p+/jEvbZv7f0IcxdudmfLA/Y77fIgjgrYZE4tOWQ7MdQZG4jOchIf7L6xAK0QFbMbqe0Ist461fv365WzGViuz0i2SsPSflDl0H/sPOAJ7caD80NHSitrb295G/xVmlaVp4aGjIrNTHivTYyMj4Ny+55HoIsdb2YJRC7p23kezsRLKzE1Odh5AZs33Z+XxzIvGknQE8e43BjTfe2KLr+mHkr7SkQ6HQ9Z2dnQk34wq6RFPTek2IbvjvFRakCbG+vre3x84gnr3GoKurKy6EeMJkE74bzwEz7794xus45iOiJ+0mM+Dxezn4bjyP5HLbAYx4HcYswyD6joyBPE1ovhvPG40DA2cF0TYAMnstVhEJcWdTf/8HMgbz/M1JXMbzRkNf30sQ4iGv4yBgR1Nvr7Ryoi8uDNra2m4TQrzgdRylRgD4y2QSn8nYb4hY9O8NicQ3hMS/KXzxfoyZMt6nAaz2OpZSEwuHEQHQnHO9PP1YQyJxl8xkBnyw5DAs4qFa5gAC8ExFBXZFIqa3QkqUBtE3GxOJu8X063Sl8sUMDQCnT58+U1dXVwcg6nUspagvFEJPOIw1uRxqZN7cPFdcAH/U2Ne3x6kD+GaGBj4s40n/v5YtTn8ohL+uqsLPKyowIaReXg2DaPuF6uobGhKJLpkDz+eLi8LZotHoCQCWH2NnckQA3JxO47OZDK7ULc4xRMdIiCfSZWX/1hKPT0gNMA8/1nf3ghPac0kAL5WX46Xyclydy6E1l0NLLodP6jouzZPgI5qG9zQN8VAIg6HQL586fPiL7kbtw4QmorjI89ddTXU1Hn/0UZcjYvOl02nQ+fP4x+9+F5lMBlMARoVAetafmxDiZS9i811Ca5p2nPJclIyNj6OuthY11dUuR8Xm6xsYwEAuB2gLX4YR0f+6HBIAn10UAkA2m42bfT/47rsuRcLMHI2b/jFNATjqUihz+C6hDx8+fAHAUL7vBwYHXYyG5WOW0ETUGYvFPGk/+i6hgel1dL7vBn9t+Ql3JlHPsfyvABdCHHAxlDl8mdBCiLwJPXDypJuhsAWMjY/j1G/y/7aPEOL/XAxnDl8mNBEdz/cdz9DeOxqPI9+FOwAIIQ66GM4cvkxoTdPyztAfDA9jbFzqW61YkcyWGwBOdnV1nXYrlvl8mdBc6fC3AhUOz9bPgE8Tmisd/qXrOuLvvJP3eyLihF4IVzr8aWBwEJMXL+b93ssKB+DDTqFhptLxuYW+k1XpyI2M4MLTT2PyjTeQHRoCFXmTu4hEULFmDWo6OlD9hS8Acu9Q86UCy42L1dXVtp/ctsO3CU1Ex/Pd0yFjhk719mLorruQG7H+8DMlk0geOYLkkSO4+OabWPXQQxBh3/4nlcLsgpCIurx+J6FvlxxCiLylO7uVDn1qCqe/9S1byTzfxKuvYmTnTmnj+ZXZDO31cgPwcUKn02nHKh3je/Yge1p+ZWn0ueeQOSXxveI+4+eGisG3CX306NHzMKl0nLSR0FOdnZb3NZXLYfL1150Z2wf83FAx+DahAfNKh52EzkpcasyX+e1vHRvba35uqBh8ndBm6+iTdmrRVh8pWgznHjD1nJ8bKgZfX5KbPb1iZ4b2A/3cOaT37kX2xAnQRPGP22nLlyPc2oryW26BiEQciHAuvzdUDL5O6MVUOlR8eiVz4AAu7twJSiYtj5EDkInFkHrxRVTdfz9CV18tL8AF+L2hYvD1ksPJSodXsr29mPzBD2wl82z62bOYeOAB6OfOSRkvH783VAy+TmgnKx1eSe7aBWTl9h7owgUkn35a6pjz+b2hYvB1QgPOVTq8QBMTyJrPdJal9+8HTVn+ReGCenzeUDH4PqEdq3R4QB8edq4KkslAP3vWkaHHxsfxnnlDhRN6sYI0Q8PpN3xKXsoYCjVUQqGQ5w0Vg+8T2sl7OtjiFGqoHDx48IxbsRTi+4QOYqVDNSo0VAy+T+ggVjpUokpDxeD7hAYCto5WjCoNFYMSCR2kSodqVGmoGJRIaJ6hvaNKQ8WgREJzpcM7qjRUDEokNFc6vDE6NqZMQ8WgREJzpcMbKjVUDEokNMDraC8UuCAc8FNDxaBMQnOlw30FEtrzB2IXokxC8wztLtUaKgZlEporHe5SraFiUCahudLhLtUaKgZlEporHe5SraFiUCahAV5Hu0m1hopBqYSWVunI89t6Upi9gdTJ4xY6dhFUbKgYlEpoWTN02RVXyAhnQeGVK/N+p112maOv3BUrVkgZR8WGikGphJZV6ajaskVaTPMt2bgx73eiuhrh1lZHjhu65hpoEhPahC8bKgalElpWpWPpzTdjSTQqI6Q5KjdtQmTdOtNtlnzta0B5ufRjR7ZulTaW31+Za0aphJZW6RAClz/yCCquu05OYAAq1q7FqgcfLLhdaPVqVH372/KSWghEvvpVlLW3SxmuUENF13VfdggNvn4V2EKEEMeJaMFFcDFv9g+tWIG6p57C6LPPYvwXv0Dm1ClQprhf8xWRCMpXr8bSz38ey+64A2KRSVq2cSNqdu5E8vnnkT1yBPr580UdFwBETQ3C112HiltvRXjt2qL3z0fVhopBuYSeuTC8eaHviv3tFVFejuXbtmH5tm0yQiuKVleHynvvdf24hajaUDEoteQACpTuuBZtm6oNFYNyCW1WuuN7OuxTtaFiUC6hC1U63uXfMLRM5YaKQbmELlTp4F+ZtU7lhopBuYQGzNfR/Cuz1hV45ZevGyoGJRPabB0t61dmS9Gx43nnCSWWG4CiCc2VDvlUb6gYlExornTIp3pDxaBkQnOlQz7VGyoG5TqFwHSlIxqNDgFYsAV+oLMTZWVlLkeltgMmv64rhHjb7w0Vg3M35zpsw4YNrxHRgi1wJt33Y7HY33odxGIoueQAzNfRTC5V1s8AJzRbBBUaKgZlE9qsdMek8tVvqBSibEJnMplDACa9jiPohBCveR1DMZRN6J6enkkA3/c6joAb1XX9Ea+DKEbI6wDsGBoaequurm4EQBOAFVC4auMzUwDeIKI/6e7uzt8+ZIw5q6RntJtuuumSbDZ7hRDiYmVl5dC+ffuSXsckQ1DPazFKLqFbW1vrwuHwfQBuA7B61ldZAG8R0c8aGhp27d692+HfMZYrqOdVrJJK6Gg0eh+ABwEsKbBpXNO0O7q6upSodQf1vKwomYSORqOPA/irInYZA/DFWCz2Pw6FJEVQz8uqkkjomRnsXyzs+gGADbFY7JTkkKQI6nnZoWwderFuuOGGWgA7LO6+UgjxsMx4ZAnqedkV+ITWNO0+AJVW9yeiL7e3tzdLDEmKoJ6XXYFPaAC329xf5HK526REIldQz8uWQCd0e3v7pZhbwrJK/qtKbQjqeckQ6ITOZDKXSxrKuTekWxDU85Ih0AldVlY2JWmo/E+PeiCo5yVDoBO6srJyCNOdMrt8Vd4K6nnJEOiEnrmH4b8lDPWKhDGkCep5yRDohAYAItplc4jhZDL5spRgJArqedkV+IRuaGh4BoCdexd2xOPxCVnxyBLU87Ir8Am9e/fuHBF1ABgtdl8hxN76+vrHHQjLtqCel10lcS8HAESj0U0AXgCQ/4cE53oxmUx+xe+zWFDPy6qSSWgAiEajVwkhHiaiLyP/uQ8D2BGLxR4DoLsXnXVBPS8rSiqhDe3t7c26rt9KRBsA1GL66fH3iOiVVCr1S1Vnr6CeF2OMMcYYY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGivX/wylYNQa5qpAAAAAASUVORK5CYII=">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="„Éá„Çø„Ç¶„É™.Detauri">
  <script src="https://www.google.com/recaptcha/api.js?render=6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1" async defer></script>
  <style>
    html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; color:#111; background:#f6f7f9; -webkit-text-size-adjust:100%; }
    * { box-sizing:border-box; }
    input, select, textarea, button { font-size:16px; }
    .promo-banner{background:linear-gradient(90deg,#b8002a,#e63950);color:#fff;text-align:center;padding:10px 40px 10px 14px;font-size:13px;font-weight:700;position:relative;z-index:21;display:none;}
    .promo-banner a{color:#fff;text-decoration:underline;margin-left:8px;font-weight:900;}
    .promo-banner a:hover{color:#ffd700;}
    .promo-banner .promo-close{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px 8px;opacity:0.8;}
    .promo-banner .promo-close:hover{opacity:1;}
    .mypage-tabs{display:flex;gap:0;border-bottom:2px solid #e0e0e0;margin-bottom:16px;}
    .mypage-tab{background:none;border:none;padding:10px 18px;font-size:14px;font-weight:600;color:#888;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:color .2s,border-color .2s;}
    .mypage-tab:hover{color:#333;}
    .mypage-tab.active{color:#b8002a;border-bottom-color:#b8002a;}
    .mypage-content{min-height:120px;}
    .mp-order-card{border:1px solid #e8e8e8;border-radius:8px;padding:14px;margin-bottom:10px;background:#fafafa;}
    .mp-order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;}
    .mp-order-no{font-weight:700;font-size:14px;color:#333;}
    .mp-order-date{font-size:12px;color:#999;}
    .mp-order-status{font-size:12px;padding:2px 8px;border-radius:10px;font-weight:600;}
    .mp-order-status.done{background:#e8f5e9;color:#2e7d32;}
    .mp-order-status.pending{background:#fff3e0;color:#e65100;}
    .mp-order-status.active{background:#e3f2fd;color:#1565c0;}
    .mp-order-products{font-size:12px;color:#666;line-height:1.5;margin-bottom:6px;}
    .mp-order-footer{display:flex;justify-content:space-between;font-size:13px;flex-wrap:wrap;gap:4px;}
    .mp-order-total{font-weight:700;color:#333;}
    .pw-wrap{position:relative;display:flex;align-items:center;}
    .pw-wrap input{flex:1;padding-right:38px;}
    .pw-toggle{position:absolute;right:6px;background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:0.5;line-height:1;}
    .pw-toggle:hover{opacity:0.8;}
    .pw-toggle.active{opacity:1;}
    .topbar{position:sticky;top:0;z-index:20;background:#1e293b;border-bottom:1px solid #334155;padding:12px 14px;}
    .wrap{margin:0 auto;padding:12px 14px 90px;}
        .title{font-weight:900;font-size:18px;color:#f1f5f9;}
    .subnote{margin-top:6px;font-size:12px;color:#666;line-height:1.4;}
    .topDetails{margin-top:6px;cursor:pointer;}
    .topDetails a{cursor:pointer;}
    .topSummary{font-size:12px;font-weight:900;color:#555;cursor:pointer;list-style:none;display:flex;align-items:center;gap:6px;}
    .topSummary::-webkit-details-marker{display:none;}
    .topSummary::before{content:'‚ñº';font-size:10px;transition:transform .2s;}
    details:not([open])>.topSummary::before{content:'‚ñ∂';}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .field{min-width:170px;flex:1 1 170px;}
    .field.big{min-width:240px;flex:2 1 240px;}
    .controls input,.controls select{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .btn{padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .btn.primary{background:#111;color:#fff;border-color:#111;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,280px));gap:12px;margin-top:12px;justify-content:center;}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));} .card{min-height:auto;} .cardbody{padding:6px 6px;gap:3px;} .noText{font-size:11px;} .brandText{font-size:10px;-webkit-line-clamp:2;} .price{font-size:12px;} .meta{font-size:10px;} .badge{font-size:9px;padding:2px 5px;} .selectBtn{padding:7px 5px;font-size:11px;}}
    .card{background:#fff;border:1px solid #e6e8ee;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;}
    .thumb{width:100%;aspect-ratio:1/1;background:#f0f2f7;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
    .cardbody{padding:10px 12px;display:flex;flex-direction:column;gap:6px;flex:1;}
    .row1{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;}
    .leftTitle{display:flex;flex-direction:column;gap:2px;min-width:0;font-weight:900;line-height:1.25;}
    .noText{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:900;white-space:nowrap;}
    .brandText{font-weight:900;font-size:13px;line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .defectLine{font-size:11px;min-height:16px;line-height:16px;color:transparent;}
    .defectLine.hasDefect{color:#b8002a;font-weight:700;}
    .price{font-weight:900;color:#b8002a;white-space:nowrap;}
    .meta{font-size:12px;color:#444;line-height:1.35;white-space:pre-line;}
    .badges{display:flex;gap:4px;flex-wrap:nowrap;align-items:center;}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #e6e8ee;background:#f7f8fb;color:#333;}
    .badge.ok{background:#eef7ee;border-color:#cfe9cf;}
    .badge.warn{background:#fff5e6;border-color:#ffe0ad;}
    .badge.lock{background:#ffecec;border-color:#ffd0d0;color:#a40000;}
    .actions{display:flex;gap:10px;align-items:center;}
    .selectBtn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #d9deea;background:#0b6;color:#fff;font-weight:900;cursor:pointer;display:flex;justify-content:center;align-items:center;}
    .selectBtn.off{background:#fff;color:#111;border-color:#d9deea;}
    .selectBtn.disabled{background:#f2f3f6;color:#777;border-color:#e3e5ec;cursor:not-allowed;}
    .pager{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:16px 0 0;}
    .pageBtn{min-width:36px;padding:8px 10px;border:1px solid #d9deea;background:#fff;border-radius:10px;cursor:pointer;font-weight:900;}
    .pageBtn.active{background:#111;color:#fff;border-color:#111;}
    .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(246,247,249,.9);backdrop-filter:blur(8px);border-top:1px solid #e6e8ee;padding:10px 14px;display:flex;justify-content:center;}
    .stickyInner{width:100%;max-width:1200px;display:flex;justify-content:center;align-items:center;gap:10px;}
    .cartBtn{width:100%;max-width:520px;height:46px;border-radius:14px;border:1px solid #4a76b5;background:#5B86C5;color:#fff;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin:0 auto;}
    .countPill{min-width:28px;height:28px;border-radius:999px;background:#fff;color:#2B3A5C;display:flex;align-items:center;justify-content:center;font-weight:900;padding:0 10px;}
    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:40;}
    .overlay.open{display:block;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(860px,94vw);max-height:86vh;background:#fff;border-radius:14px;border:1px solid #e6e8ee;z-index:50;display:none;overflow:hidden;}
    .modal.open{display:block;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modalTitle{font-weight:900;}
    .modalClose{background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1;padding:6px 10px;}
    .modalBody{padding:14px 16px;overflow:auto;max-height:calc(86vh - 56px);}
    .cartList{display:flex;flex-direction:column;gap:8px;}
    .cartRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid #eef0f6;padding:10px 0;}
    .cartImg{width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;background:#f5f5f5;cursor:pointer;}
    .cartInfo{display:flex;gap:10px;align-items:center;min-width:0;flex:1;}
    .cartLeft{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .cartName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline;}
    .cartSub{font-size:12px;color:#666;}
    .dangerBtn{border:1px solid #ff4d4f;color:#ff4d4f;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900;}
    .recommendSection{margin-top:16px;padding-top:16px;border-top:1px solid #eef0f6;}
    .recommendTitle{font-weight:900;font-size:14px;color:#333;margin-bottom:10px;}
    .recommendList{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;}
    .recommendCard{flex-shrink:0;width:100px;cursor:pointer;border:1px solid #eef0f6;border-radius:8px;overflow:hidden;background:#fff;transition:box-shadow .2s;}
    .recommendCard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .recommendCard img{width:100px;height:100px;object-fit:cover;display:block;}
    .recommendCard .rcInfo{padding:6px;font-size:11px;}
    .recommendCard .rcBrand{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .recommendCard .rcPrice{color:#b8002a;font-weight:900;}
    .mainRecommendSection{margin-bottom:20px;padding:16px;background:#f8f9fc;border-radius:12px;}
    .mainRecommendTitle{font-weight:900;font-size:16px;color:#333;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .mainRecommendTitle::before{content:'‚òÖ';color:#ffc107;}
    .mainRecommendList{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;}
    .mainRecommendList .recommendCard{width:120px;}
    .mainRecommendList .recommendCard img{width:120px;height:120px;}
    .authArea{display:flex;align-items:center;gap:10px;font-size:13px;}
    .authBtn{background:#334155;border:1px solid #475569;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:900;font-size:13px;color:#f1f5f9;}
    .authBtn:hover{background:#475569;}
    .authBtn.logout{background:transparent;border:none;color:#94a3b8;text-decoration:underline;padding:4px 8px;}
    .authUser{display:flex;align-items:center;gap:8px;}
    .authUserName{font-weight:900;color:#f1f5f9;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .authDiscount{background:#b8002a;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .authPoints{background:#e65100;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .authBtn.mypage{background:#475569;font-size:12px;padding:4px 10px;}
    .sumBox{margin-top:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
    .sumLine{font-weight:900;}
    .hint{font-size:12px;color:#666;line-height:1.45;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:700px){.formGrid{grid-template-columns:1fr;}}
    .formField label{font-size:12px;color:#555;font-weight:900;display:block;margin-bottom:6px;}
    .formField input,.formField select,.formField textarea{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .formField textarea{min-height:90px;resize:vertical;}
    .formActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
    .toast{position:fixed;left:50%;bottom:82px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:12px;display:none;z-index:60;font-weight:900;max-width:92vw;}
    .toast.show{display:block;}
    .measureWrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .measureBtn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .measureBtn input{margin:0;}
    .sendingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80;}
    .sendingOverlay.on{display:flex;}
    .sendingBox{background:#fff;border:1px solid #e6e8ee;border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .sendingSpinner{width:26px;height:26px;border-radius:999px;border:3px solid rgba(0,0,0,.15);border-top-color:#111;animation:sendingSpin 0.9s linear infinite;}
    .sendingText{font-weight:900;font-size:14px;color:#111;}
    @keyframes sendingSpin{to{transform:rotate(360deg);}}
    .selectFieldBtn{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .selectFieldBtn .muted{font-weight:900;color:#666;font-size:12px;}
    .brandTools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .brandTools input{flex:1 1 240px;min-width:200px;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;font-size:14px;transition:border-color .2s,box-shadow .2s;}
    .brandTools input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .brandToolsBar{background:#fff;border-bottom:1px solid #eef0f6;padding:14px 16px 12px;}
    .brandIndexNav{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;padding-bottom:8px;}
    .brandIndexBtn{padding:6px 10px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
    .brandIndexBtn:hover{background:#e2e8f0;}
    .brandIndexBtn.active{background:#3b82f6;color:#fff;}
    .brandIndexBtn.filter-active{background:#10b981;color:#fff;}
    .brandGroupHeader{padding:12px 16px;margin:8px -16px 8px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);font-size:16px;font-weight:900;color:#1e293b;display:flex;align-items:center;gap:8px;}
    .brandGroupHeader::before{content:'';width:4px;height:20px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .brandList{display:flex;flex-direction:column;gap:4px;padding-top:8px;}
    .brandItem{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:#fff;cursor:pointer;user-select:none;transition:all .15s;}
    .brandItem:hover{background:#f8fafc;}
    .brandItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;}
    .brandItem input{display:none;}
    .brandItem .brand-check{width:22px;height:22px;border:2px solid #cbd5e1;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .brandItem.selected .brand-check{background:#3b82f6;border-color:#3b82f6;}
    .brandItem .brand-check::after{content:'‚úì';color:#fff;font-size:13px;font-weight:700;opacity:0;transition:opacity .15s;}
    .brandItem.selected .brand-check::after{opacity:1;}
    .brandName{font-weight:600;line-height:1.3;word-break:break-word;color:#334155;}
    .toTop{position:fixed;right:14px;bottom:86px;width:46px;height:46px;border-radius:999px;border:1px solid #d9deea;background:#fff;display:none;align-items:center;justify-content:center;font-weight:900;z-index:70;box-shadow:0 6px 18px rgba(0,0,0,.12);}
    .toTop.show{display:flex;}
    .price-old { text-decoration: line-through; color:#999; }
    .price-new { color:#b8002a; font-weight:700; }
    /* „Éï„Ç£„É´„Çø„Éª„ÇΩ„Éº„Éà ‚Äî „Éï„É©„ÉÉ„Éà„ÉÑ„Éº„É´„Éê„Éº */
    .filter-sort-section{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px 0;margin-bottom:12px;}
    .filter-divider{width:1px;height:24px;background:#e2e8f0;margin:0 4px;flex-shrink:0;}
    .multiSelectField{position:relative;}
    .multiSelectBtn{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px;transition:all .15s;color:#475569;white-space:nowrap;}
    .multiSelectBtn:hover{border-color:#cbd5e1;background:#f8fafc;}
    .multiSelectBtn.active{border-color:#3b82f6;background:#eff6ff;color:#3b82f6;}
    .multiSelectBtn .filterCount{background:#3b82f6;color:#fff;font-size:10px;min-width:18px;height:18px;padding:0 5px;border-radius:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}
    .multiSelectBtn .filterCount:empty{display:none;}
    .multiSelectBtn .chevron{font-size:10px;opacity:.4;transition:transform .2s;}
    .multiSelectDropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;min-width:180px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.1);z-index:100;max-height:240px;overflow-y:auto;padding:4px;}
    .multiSelectDropdown.open{display:block;animation:ddIn .15s ease;}
    @keyframes ddIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
    .multiSelectItem{display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;font-size:13px;border-radius:8px;transition:background .1s;color:#334155;}
    .multiSelectItem:hover{background:#f1f5f9;}
    .multiSelectItem.selected{background:#eff6ff;color:#3b82f6;font-weight:600;}
    .multiSelectItem input{display:none;}
    .multiSelectItem .check-icon{width:18px;height:18px;border:1.5px solid #cbd5e1;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .multiSelectItem.selected .check-icon{background:#3b82f6;border-color:#3b82f6;color:#fff;}
    .multiSelectItem .check-icon::after{content:'‚úì';font-size:11px;opacity:0;transition:opacity .15s;}
    .multiSelectItem.selected .check-icon::after{opacity:1;}
    .sort-chip{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px;transition:all .15s;color:#475569;white-space:nowrap;}
    .sort-chip:hover{border-color:#cbd5e1;background:#f8fafc;}
    .sort-chip.active{border-color:#8b5cf6;background:#f5f3ff;color:#7c3aed;}
    .sort-chip .chevron{font-size:10px;opacity:.4;}
    .sort-item{padding:8px 12px;cursor:pointer;font-size:13px;border-radius:8px;transition:background .1s;color:#334155;}
    .sort-item:hover{background:#f1f5f9;}
    .sort-item.selected{background:#f5f3ff;color:#7c3aed;font-weight:600;}
    .sort-dir-toggle{width:36px;height:36px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;color:#64748b;}
    .sort-dir-toggle:hover{border-color:#cbd5e1;background:#f8fafc;}
    .btn-reset-pill{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:12px;color:#94a3b8;transition:all .15s;white-space:nowrap;}
    .btn-reset-pill:hover{border-color:#fca5a5;color:#ef4444;background:#fef2f2;}
    .detail-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center; }
    .detail-modal-overlay.active { display: flex; }
    .detail-modal { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .detail-modal-close { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
    .detail-modal-image { width: 100%; max-height: 300px; object-fit: contain; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-modal-content { padding: 20px; }
    .detail-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
    .detail-section { margin-bottom: 16px; }
    .detail-section-title { font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
    .detail-defect { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 14px; color: #92400e; }
    .measurement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    .measurement-item { background: #f3f4f6; border-radius: 6px; padding: 8px 12px; text-align: center; }
    .measurement-label { font-size: 12px; color: #6b7280; }
    .measurement-value { font-size: 16px; font-weight: 600; color: #111827; }
    .detail-modal-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }
    .detail-add-btn { flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .detail-add-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .detail-loading { display: flex; justify-content: center; align-items: center; min-height: 100px; color: #6b7280; }
    .product-image-clickable { cursor: zoom-in; }
    .detail-info-grid { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-bottom: 8px; }
    .detail-info-item { font-size: 14px; color: #374151; background: #f9fafb; padding: 4px 10px; border-radius: 6px; }
    .detail-info-label { font-weight: 600; color: #6b7280; }

    /* ===== Image Zoom (Amazon-style) ===== */
    .detail-zoom-wrap { position: relative; cursor: zoom-in; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-zoom-wrap img.detail-modal-image { pointer-events: none; }
    .detail-zoom-lens { display: none; position: absolute; width: 120px; height: 120px; border: 2.5px solid rgba(59,130,246,.7); border-radius: 8px; pointer-events: none; z-index: 2; background: rgba(59,130,246,.08); box-sizing: border-box; transform: translate(-50%, -50%); }
    .detail-zoom-result { display: none; position: fixed; width: 300px; height: 300px; border: 1px solid #e5e7eb; border-radius: 12px; background-repeat: no-repeat; background-color: #fff; box-shadow: 0 8px 30px rgba(0,0,0,.18); z-index: 10001; overflow: hidden; pointer-events: none; }
    /* lens display is controlled by JS to only show over actual image */
    .detail-zoom-hint { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color: #fff; font-size: 11px; padding: 3px 10px; border-radius: 12px; pointer-events: none; z-index: 3; white-space: nowrap; transition: opacity .3s; }
    .detail-zoom-wrap:hover .detail-zoom-hint { opacity: 0; }

    /* Mobile: zoom result inside overlay instead of side-by-side */
    @media (max-width: 700px) {
      .detail-zoom-wrap { cursor: pointer; }
      .detail-zoom-lens, .detail-zoom-result { display: none !important; }
      .detail-zoom-hint-mobile { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color: #fff; font-size: 11px; padding: 3px 10px; border-radius: 12px; pointer-events: none; z-index: 3; white-space: nowrap; }
    }
    @media (min-width: 701px) {
      .detail-zoom-hint-mobile { display: none; }
    }

    /* Fullscreen image viewer (mobile) */
    .fullscreen-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.92); z-index: 10002; justify-content: center; align-items: center; flex-direction: column; }
    .fullscreen-viewer.active { display: flex; }
    .fullscreen-viewer img { max-width: 100%; max-height: 85vh; object-fit: contain; touch-action: pinch-zoom; user-select: none; -webkit-user-select: none; transition: transform .2s ease; }
    .fullscreen-viewer-close { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,.2); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10003; backdrop-filter: blur(4px); }
    .fullscreen-viewer-hint { color: rgba(255,255,255,.6); font-size: 13px; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="promo-banner" id="promoBanner">
    ÊúüÈñìÈôêÂÆöÔºö‰ºöÂì°ÁôªÈå≤„ÅßÂÖ®ÂìÅ<strong>10%OFF</strong>Ôºà2026Âπ¥9ÊúàÊú´„Åæ„Åß„Éª30ÁÇπÂâ≤Âºï„Å®‰ΩµÁî®ÂèØÔºâ<a href="#" id="promoRegisterLink">‰ªä„Åô„ÅêÁÑ°ÊñôÁôªÈå≤ Ôºû</a>
    <button class="promo-close" id="promoClose" type="button">‚úï</button>
  </div>
  <div class="topbar">
    <div class="wrap" style="padding:0 14px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <div class="title" id="appTitle">„Éá„Çø„Ç¶„É™.Detauri</div>
          <div class="badge ok" id="totalCountBadge"></div>
        </div>
        <div class="authArea" id="authArea">
          <button class="authBtn" id="openAuthBtn" type="button">„É≠„Ç∞„Ç§„É≥/Êñ∞Ë¶èÁôªÈå≤</button>
        </div>
      </div>
      <div style="display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; align-items:center;">
        <a href="#" id="openGuideLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">üì¶ ÂïÜÂìÅ„Ç¨„Ç§„Éâ</a>
        <a href="#" id="openShippingLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">üöö ÈÄÅÊñôË°®</a>
        <a href="#" id="openContactLink" style="font-size:13px; font-weight:600; color:#93c5fd; text-decoration:none;">‚úâ „ÅäÂïè„ÅÑÂêà„Çè„Åõ</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="filter-sort-section">
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="brandBtn" type="button"><span id="brandBtnText">„Éñ„É©„É≥„Éâ</span> <span class="filterCount" id="brandBtnSub"></span><span class="chevron">‚ñæ</span></button>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fCategoryBtn" type="button">„Ç´„ÉÜ„Ç¥„É™ <span class="filterCount"></span><span class="chevron">‚ñæ</span></button>
        <div class="multiSelectDropdown" id="fCategoryDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fStateBtn" type="button">Áä∂ÊÖã <span class="filterCount"></span><span class="chevron">‚ñæ</span></button>
        <div class="multiSelectDropdown" id="fStateDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fGenderBtn" type="button">ÊÄßÂà• <span class="filterCount"></span><span class="chevron">‚ñæ</span></button>
        <div class="multiSelectDropdown" id="fGenderDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fSizeBtn" type="button">„Çµ„Ç§„Ç∫ <span class="filterCount"></span><span class="chevron">‚ñæ</span></button>
        <div class="multiSelectDropdown" id="fSizeDropdown"></div>
      </div>
      <div class="filter-divider"></div>
      <div class="multiSelectField">
        <button class="sort-chip" id="sortChipBtn" type="button"><span id="sortChipLabel">Ê®ôÊ∫ñ</span><span class="chevron">‚ñæ</span></button>
        <div class="multiSelectDropdown" id="sortDropdown"></div>
      </div>
      <button class="sort-dir-toggle" id="sortDirToggle" type="button" title="‰∏¶„ÅπÊõø„ÅàÊñπÂêë">‚Üë</button>
      <button class="btn-reset-pill" id="btnReset" type="button">„É™„Çª„ÉÉ„Éà</button>
    </div>
    <!-- „É°„Ç§„É≥ÁîªÈù¢„Åä„Åô„Åô„ÇÅÂïÜÂìÅ -->
    <div class="mainRecommendSection" id="mainRecommend" style="display:none;">
      <div class="mainRecommendTitle">„Åä„Åô„Åô„ÇÅÂïÜÂìÅ</div>
      <div class="mainRecommendList" id="mainRecommendList"></div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pager" class="pager"></div>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <button class="cartBtn" id="openCartBtn" type="button">
       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:22px;height:22px;flex-shrink:0;"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
       <span class="countPill" id="cartCount">0</span>
       <span id="cartTotal" style="font-weight:900; margin-left:8px;">0ÂÜÜ</span>
      </button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="modal" id="brandModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">„Éñ„É©„É≥„ÉâÈÅ∏Êäû</div>
      <button class="modalClose" id="brandCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="brandToolsBar">
      <div class="brandTools">
        <input id="brandSearch" type="text" placeholder="„Éñ„É©„É≥„ÉâÂêç„ÇíÊ§úÁ¥¢Ôºà‰æãÔºö„Éä„Ç§„Ç≠„ÄÅNIKEÔºâ">
        <button class="btn" id="brandClearBtn" type="button">„ÇØ„É™„Ç¢</button>
        <button class="btn primary" id="brandApplyBtn" type="button">ÈÅ©Áî®</button>
      </div>
      <div class="hint" style="margin-top:8px;" id="brandHint"></div>
      <div class="brandIndexNav" id="brandIndexNav"></div>
    </div>
    <div class="modalBody" style="max-height:calc(86vh - 180px);">
      <div id="brandList" class="brandList"></div>
    </div>
  </div>

  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="cartModalTitle">„Ç´„Éº„Éà</div>
      <button class="modalClose" id="cartCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody">
      <div class="cartList" id="cartList"></div>
      <!-- „Åä„Åô„Åô„ÇÅÂïÜÂìÅ -->
      <div class="recommendSection" id="cartRecommend" style="display:none;">
        <div class="recommendTitle">„Åä„Åô„Åô„ÇÅÂïÜÂìÅ</div>
        <div class="recommendList" id="cartRecommendList"></div>
      </div>
      <div class="sumBox" id="cartSumBox">
        <div class="sumLine" id="sumCount"></div>
        <div class="sumLine" id="sumPrice"></div>
        <div class="sumLine" id="sumShipping" style="display:none;font-size:13px;color:#475569;"></div>
        <div class="sumLine" id="sumTotal" style="display:none;font-weight:700;font-size:15px;"></div>
        <div id="shippingNote" style="display:none;font-size:11px;color:#888;text-align:right;width:100%;">‚ÄªÈÄÅÊñô„ÅØÁ®éËæº„Åø„Éª‰ºöÂì°Ââ≤ÂºïÂØæË±°Â§ñ„Åß„Åô</div>
        <div id="paymentFeeNote" style="display:none;font-size:11px;color:#888;text-align:right;width:100%;line-height:1.5;">‚Äª„Ç≥„É≥„Éì„ÉãÊ±∫Ê∏à„ÅØÂà•ÈÄîÊâãÊï∞Êñô220ÂÜÜÔºàÁ®éËæºÔºâ„Åå„Åã„Åã„Çä„Åæ„Åô<br>‚ÄªÈäÄË°åÊåØËæº„ÅÆÊåØËæºÊâãÊï∞Êñô„ÅØ„ÅäÂÆ¢ÊßòË≤†ÊãÖ„Åß„Åô</div>
        <div id="remoteIslandWarning" style="display:none;font-size:13px;color:#b8002a;text-align:right;width:100%;font-weight:600;"></div>
        <div id="cartActions" style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; width:100%;">
          <button class="btn" id="clearCartBtn" style="min-width:160px;" type="button">„Ç´„Éº„Éà„ÇíÁ©∫„Å´„Åô„Çã</button>
          <button class="btn primary" id="goFormBtn" style="min-width:220px;" type="button">Ë≥ºÂÖ•ÊâãÁ∂ö„Åç„Å∏</button>
        </div>
      </div>
      <!-- „ÅäÂ±ä„ÅëÂÖàÊÉÖÂ†±ÔºàÂàùÊúüÈùûË°®Á§∫„ÄÅ„ÄåË≥ºÂÖ•ÊâãÁ∂ö„Åç„Å∏„Äç„ÅßË°®Á§∫Ôºâ -->
      <div id="cartFormSection" style="display:none;">
        <div style="border-top:1px solid #e0e0e0;margin:16px 0 12px;"></div>
        <div style="font-weight:700;font-size:15px;margin-bottom:10px;">„ÅäÂ±ä„ÅëÂÖàÊÉÖÂ†±</div>
        <div class="formGrid">
          <div class="formField">
            <label>‰ºöÁ§æÂêç/Ê∞èÂêç *</label>
            <input id="companyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
            <input id="contact" type="email" autocomplete="email" placeholder="example@example.com">
          </div>
          <div class="formField">
            <label>ÈÉµ‰æøÁï™Âè∑ *</label>
            <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="0000000">
          </div>
          <div class="formField">
            <label>‰ΩèÊâÄ *</label>
            <input id="address" type="text" autocomplete="street-address">
          </div>
          <div class="formField">
            <label>ÈõªË©±Áï™Âè∑ *</label>
            <input id="phone" type="tel" inputmode="numeric" placeholder="00000000000" autocomplete="tel">
          </div>
          <div class="formField">
            <label>ÂÇôËÄÉ</label>
            <textarea id="note"></textarea>
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="invoiceReceipt" style="width:18px;height:18px;">
              <span>„Ç§„É≥„Éú„Ç§„Çπ‰ªò„ÅçÈ†òÂèéÊõ∏„ÇíÂ∏åÊúõ„Åô„Çã</span>
            </label>
          </div>
          <div class="formField" id="pointUseSection" style="display:none;grid-column:1/-1;">
            <label>„Éù„Ç§„É≥„ÉàÂà©Áî® <span id="pointAvailable" style="font-weight:400;color:#888;"></span></label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="usePoints" type="number" min="0" value="0" style="width:120px;" inputmode="numeric">
              <span style="font-size:13px;color:#666;">ptÔºà1pt = 1ÂÜÜÔºâ</span>
              <button class="btn" id="useAllPointsBtn" type="button" style="font-size:12px;padding:4px 10px;">ÂÖ®È°ç‰ΩøÁî®</button>
              <button class="btn primary" id="applyPointsBtn" type="button" style="font-size:12px;padding:4px 12px;">Â§âÊõ¥„ÇíÈÅ©Áî®</button>
            </div>
            <div id="pointDiscountInfo" style="font-size:12px;color:#b8002a;margin-top:4px;"></div>
          </div>
        </div>
        <div class="formActions">
          <button class="btn" id="formBackBtn" type="button">„Ç´„Éº„Éà„Å´Êàª„Çã</button>
          <button class="btn primary" id="submitBtn" type="button">Ê±∫Ê∏à„Å´ÈÄ≤„ÇÄ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- „É≠„Ç∞„Ç§„É≥/ÁôªÈå≤„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="authModalTitle">„É≠„Ç∞„Ç§„É≥</div>
      <button class="modalClose" id="authCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody">
      <!-- „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
      <div id="loginForm">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
            <input id="loginEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>„Éë„Çπ„ÉØ„Éº„Éâ *</label>
            <div class="pw-wrap"><input id="loginPassword" type="password" autocomplete="current-password"><button type="button" class="pw-toggle" data-target="loginPassword">&#x1F441;</button></div>
          </div>
          <div class="formField" style="margin-top:-4px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:400;font-size:13px;">
              <input type="checkbox" id="rememberMe" style="width:16px;height:16px;">
              „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Çí‰øùÊåÅ„Åô„ÇãÔºà30Êó•ÈñìÔºâ
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="loginBtn" type="button">„É≠„Ç∞„Ç§„É≥</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            „Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÊñπ„ÅØ <a href="#" id="showRegisterLink">Êñ∞Ë¶èÁôªÈå≤</a>
          </div>
          <div style="text-align:center;margin-top:8px;font-size:12px;color:#888;">
            <a href="#" id="showForgotPasswordLink" style="color:#666;">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ</a>
            <span style="margin:0 6px;">|</span>
            <a href="#" id="showForgotEmailLink" style="color:#666;">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂøò„Çå„ÅüÊñπ</a>
          </div>
        </div>
      </div>
      <!-- „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Éï„Ç©„Éº„É† -->
      <div id="forgotPasswordForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">ÁôªÈå≤Ê∏à„Åø„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ªÆ„Éë„Çπ„ÉØ„Éº„Éâ„Çí„É°„Éº„É´„Åß„ÅäÈÄÅ„Çä„Åó„Åæ„Åô„ÄÇ</p>
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
            <input id="resetEmail" type="email" autocomplete="email">
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="resetPasswordBtn" type="button">‰ªÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÈÄÅ‰ø°</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            <a href="#" id="backToLoginFromReset">„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</a>
          </div>
        </div>
      </div>
      <!-- „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÁ¢∫Ë™ç„Éï„Ç©„Éº„É† -->
      <div id="forgotEmailForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">„ÅîÁôªÈå≤ÊôÇ„ÅÆ‰ºöÁ§æÂêç/Ê∞èÂêç„Å®ÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁôªÈå≤„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆ„Éí„É≥„Éà„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ</p>
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>‰ºöÁ§æÂêç/Ê∞èÂêç *</label>
            <input id="recoverCompanyName" type="text">
          </div>
          <div class="formField">
            <label>ÈõªË©±Áï™Âè∑ *</label>
            <input id="recoverPhone" type="tel" inputmode="numeric">
          </div>
        </div>
        <div id="recoverEmailResult" style="display:none;margin:12px 0;padding:12px;background:#f0f7ff;border-radius:6px;font-size:14px;text-align:center;"></div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="recoverEmailBtn" type="button">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            <a href="#" id="backToLoginFromRecover">„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</a>
          </div>
        </div>
      </div>
      <!-- ÁôªÈå≤„Éï„Ç©„Éº„É† -->
      <div id="registerForm" style="display:none;">
        <div class="formGrid">
          <div class="formField">
            <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
            <input id="regEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ *</label>
            <div class="pw-wrap"><input id="regPassword" type="password" autocomplete="new-password"><button type="button" class="pw-toggle" data-target="regPassword">&#x1F441;</button></div>
          </div>
          <div class="formField">
            <label>‰ºöÁ§æÂêç/Ê∞èÂêç *</label>
            <input id="regCompanyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>ÈõªË©±Áï™Âè∑</label>
            <input id="regPhone" type="tel" inputmode="numeric">
          </div>
          <div class="formField">
            <label>ÈÉµ‰æøÁï™Âè∑</label>
            <input id="regPostal" type="text" inputmode="numeric" placeholder="0000000">
          </div>
          <div class="formField">
            <label>‰ΩèÊâÄ</label>
            <input id="regAddress" type="text" autocomplete="street-address">
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="regNewsletter" checked style="width:18px;height:18px;">
              <span>„ÅäÂæó„Å™ÊÉÖÂ†±„Çí„É°„Éº„É´„ÅßÂèó„ÅëÂèñ„Çã</span>
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;margin-top:14px;">
          <button class="btn primary" id="registerBtn" type="button">ÁôªÈå≤„Åô„Çã</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ„ÅØ <a href="#" id="showLoginLink">„É≠„Ç∞„Ç§„É≥</a>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- „Éû„Ç§„Éö„Éº„Ç∏„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="myPageModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">„Éû„Ç§„Éö„Éº„Ç∏</div>
      <button class="modalClose" id="myPageCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody">
      <div class="mypage-tabs">
        <button class="mypage-tab active" data-tab="profile" type="button">„Éó„É≠„Éï„Ç£„Éº„É´</button>
        <button class="mypage-tab" data-tab="orders" type="button">Ê≥®ÊñáÂ±•Ê≠¥</button>
        <button class="mypage-tab" data-tab="points" type="button">„Éù„Ç§„É≥„Éà</button>
      </div>

      <!-- „Éó„É≠„Éï„Ç£„Éº„É´„Çø„Éñ -->
      <div class="mypage-content" id="mypageProfile">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
            <input id="mpEmail" type="email" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>‰ºöÁ§æÂêç/Ê∞èÂêç *</label>
            <input id="mpCompanyName" type="text" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>ÈõªË©±Áï™Âè∑</label>
            <input id="mpPhone" type="tel" inputmode="numeric" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>ÈÉµ‰æøÁï™Âè∑</label>
            <input id="mpPostal" type="text" inputmode="numeric" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>‰ΩèÊâÄ</label>
            <input id="mpAddress" type="text" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label style="font-size:12px;color:#999;">ÁôªÈå≤Êó•: <span id="mpRegisteredAt">-</span></label>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="mpEditBtn" type="button">Á∑®ÈõÜ</button>
          <button class="btn primary" id="mpSaveBtn" type="button" style="display:none;">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
          <button class="btn" id="mpCancelEditBtn" type="button" style="display:none;">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn" id="mpTogglePasswordBtn" type="button">„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
        </div>
        <div id="mpPasswordSection" style="display:none;margin-top:14px;padding:14px;background:#f9f9f9;border-radius:8px;">
          <div class="formGrid" style="grid-template-columns:1fr;">
            <div class="formField"><label>ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ *</label><div class="pw-wrap"><input id="mpCurPass" type="password"><button type="button" class="pw-toggle" data-target="mpCurPass">&#x1F441;</button></div></div>
            <div class="formField"><label>Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ *</label><div class="pw-wrap"><input id="mpNewPass" type="password"><button type="button" class="pw-toggle" data-target="mpNewPass">&#x1F441;</button></div></div>
            <div class="formField"><label>Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ *</label><div class="pw-wrap"><input id="mpNewPassConfirm" type="password"><button type="button" class="pw-toggle" data-target="mpNewPassConfirm">&#x1F441;</button></div></div>
          </div>
          <button class="btn primary" id="mpChangePassBtn" type="button" style="margin-top:10px;">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥</button>
        </div>
      </div>

      <!-- Ê≥®ÊñáÂ±•Ê≠¥„Çø„Éñ -->
      <div class="mypage-content" id="mypageOrders" style="display:none;">
        <div id="mpOrderList" style="font-size:13px;color:#666;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>

      <!-- „Éù„Ç§„É≥„Éà„ÉªÁµ±Ë®à„Çø„Éñ -->
      <div class="mypage-content" id="mypagePoints" style="display:none;">
        <!-- „É©„É≥„ÇØ„Ç´„Éº„Éâ -->
        <div id="mpRankCard" style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:12px;padding:20px;color:#fff;margin-bottom:16px;position:relative;overflow:hidden;">
          <div style="font-size:11px;opacity:0.7;">ÁèæÂú®„ÅÆ„É©„É≥„ÇØ</div>
          <div id="mpRankName" style="font-size:28px;font-weight:900;margin:4px 0;">-</div>
          <div id="mpRankPointRate" style="font-size:13px;opacity:0.9;">„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉÁéá: -</div>
          <div id="mpRankBenefits" style="font-size:12px;opacity:0.8;margin-top:4px;"></div>
          <div id="mpRankProgress" style="margin-top:12px;"></div>
        </div>

        <div style="text-align:center;padding:16px 0;">
          <div style="font-size:13px;color:#888;">„Éù„Ç§„É≥„ÉàÊÆãÈ´ò</div>
          <div id="mpPointBalance" style="font-size:40px;font-weight:bold;color:#b8002a;margin:8px 0;">0</div>
          <div style="font-size:12px;color:#aaa;">1„Éù„Ç§„É≥„Éà = 1ÂÜÜ„Å®„Åó„Å¶„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô</div>
        </div>
        <div style="border-top:1px solid #eee;padding-top:16px;margin-top:8px;">
          <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">„ÅîÂà©Áî®Áä∂Ê≥Å</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">Á¥ØË®àÊ≥®ÊñáÂõûÊï∞</div>
              <div id="mpTotalOrders" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">Âπ¥ÈñìË≥ºÂÖ•ÈáëÈ°ç</div>
              <div id="mpTotalSpent" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">Á¥ØË®àË≥ºÂÖ•ÁÇπÊï∞</div>
              <div id="mpTotalItems" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">‰ºöÂì°„É©„É≥„ÇØ</div>
              <div id="mpMemberRank" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
          </div>
        </div>

        <!-- „É©„É≥„ÇØÂà∂Â∫¶Ë™¨Êòé -->
        <div style="border-top:1px solid #eee;padding-top:16px;margin-top:16px;">
          <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">„É©„É≥„ÇØ„Éª„Éù„Ç§„É≥„ÉàÂà∂Â∫¶</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;">
            <tr style="background:#f8fafc;">
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:left;">„É©„É≥„ÇØ</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">Âπ¥ÈñìË≥ºÂÖ•ÈáëÈ°ç</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">ÁâπÂÖ∏</th>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#00bcd4;font-weight:700;">„ÉÄ„Ç§„É§„É¢„É≥„Éâ</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">50‰∏áÂÜÜ„Äú</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;color:#b8002a;">5%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">ÈÄÅÊñôÁÑ°Êñô</td>
            </tr>
            <tr style="background:#fafafa;">
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#f59e0b;font-weight:700;">„Ç¥„Éº„É´„Éâ</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">20‰∏áÂÜÜ„Äú</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;color:#b8002a;">5%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#94a3b8;font-weight:700;">„Ç∑„É´„Éê„Éº</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">5‰∏áÂÜÜ„Äú</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;">3%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
            <tr style="background:#fafafa;">
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#64748b;font-weight:700;">„É¨„ÇÆ„É•„É©„Éº</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">1%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
          </table>
          <div style="font-size:11px;color:#888;line-height:1.6;">
            <div>* „É©„É≥„ÇØ„ÅØÈÅéÂéª12„É∂Êúà„ÅÆË≥ºÂÖ•ÈáëÈ°ç„ÅßÂà§ÂÆö„Åï„Çå„Åæ„ÅôÔºàÂπ¥ÈñìÊõ¥Êñ∞Ôºâ</div>
            <div>* „Éù„Ç§„É≥„Éà„ÅØ1pt = 1ÂÜÜ„Å®„Åó„Å¶Ê¨°Âõû‰ª•Èôç„ÅÆ„ÅäË≤∑„ÅÑÁâ©„Å´„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô</div>
            <div>* „ÉÄ„Ç§„É§„É¢„É≥„Éâ„Éª„Ç¥„Éº„É´„Éâ‰ºöÂì°„ÅØÊõ¥Êñ∞Âàá„ÇåÂæå1„É∂Êúà‰ª•ÂÜÖ„Å´5‰∏áÂÜÜ‰ª•‰∏äË≥ºÂÖ•„Åß„É©„É≥„ÇØÂæ©Ê¥ª</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="doneModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="doneModalTitle">Ê≥®ÊñáÂÆå‰∫Ü</div>
      <button class="modalClose" id="doneCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody" style="text-align:center;">
      <div style="font-weight:900; font-size:14px;">Âèó‰ªòÁï™Âè∑</div>
      <div style="margin-top:8px; font-size:24px; font-weight:900; color:#3b82f6;" id="doneReceipt"></div>
      <div style="margin-top:16px; font-size:14px; color:#333; line-height:1.6;" id="doneMessage">
        „ÅäÊîØÊâï„ÅÑ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÊ≥®ÊñáÁ¢∫Ë™ç„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åó„Åæ„Åó„Åü„ÅÆ„Åß„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇÂïÜÂìÅ„ÅÆÁô∫ÈÄÅÊ∫ñÂÇô„ÇíÈÄ≤„ÇÅ„Å¶„Åæ„ÅÑ„Çä„Åæ„Åô„ÄÇ
      </div>
    </div>
  </div>

  <!-- „ÅäÂïè„ÅÑÂêà„Çè„Åõ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="contactModal" aria-hidden="true" style="width:min(500px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">„ÅäÂïè„ÅÑÂêà„Çè„Åõ</div>
      <button class="modalClose" id="contactCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody">
      <div class="formField">
        <label>„ÅäÂêçÂâç *</label>
        <input type="text" id="contactName" placeholder="‰ºöÁ§æÂêç/Ê∞èÂêç">
      </div>
      <div class="formField">
        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
        <input type="email" id="contactEmail" placeholder="Ëøî‰ø°ÂÖà„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
      </div>
      <div class="formField">
        <label>„ÅäÂïè„ÅÑÂêà„Çè„ÅõÂÜÖÂÆπ *</label>
        <textarea id="contactMessage" rows="6" placeholder="„ÅäÂïè„ÅÑÂêà„Çè„ÅõÂÜÖÂÆπ„Çí„ÅîË®òÂÖ•„Åè„Å†„Åï„ÅÑ"></textarea>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn primary" id="contactSubmitBtn" type="button">ÈÄÅ‰ø°</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div id="sendingOverlay" class="sendingOverlay" aria-hidden="true">
    <div class="sendingBox" role="status" aria-live="polite">
      <div class="sendingSpinner"></div>
      <div id="sendingText" class="sendingText">‰æùÈ†ºÈÄÅ‰ø°‰∏≠...</div>
    </div>
  </div>
  <button class="toTop" id="toTopBtn" type="button" aria-label="„Éö„Éº„Ç∏‰∏äÈÉ®„Å∏">‚Üë</button>

  <div class="detail-modal-overlay" id="detailModal">
    <div class="detail-modal">
      <button class="detail-modal-close" onclick="closeDetailModal()">√ó</button>
      <div id="detailModalBody">
        <div class="detail-loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- „Éï„É´„Çπ„ÇØ„É™„Éº„É≥ÁîªÂÉè„Éì„É•„Éº„Ç¢ („É¢„Éê„Ç§„É´Áî®) -->
  <div class="fullscreen-viewer" id="fullscreenViewer">
    <button class="fullscreen-viewer-close" onclick="closeFullscreenViewer_()">√ó</button>
    <img id="fullscreenViewerImg" src="" alt="Êã°Â§ßÁîªÂÉè">
    <div class="fullscreen-viewer-hint">„ÉÄ„Éñ„É´„Çø„ÉÉ„Éó or „Éî„É≥„ÉÅ„ÅßÊã°Â§ß„ÉªÁ∏ÆÂ∞è</div>
  </div>

  <!-- ÂïÜÂìÅ„Ç¨„Ç§„Éâ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="guideModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">üì¶ ÂïÜÂìÅ„Ç¨„Ç§„Éâ</div>
      <button class="modalClose" id="guideCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ÂïÜÂìÅ„Å´„Å§„ÅÑ„Å¶</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>„Åô„Åπ„Å¶„ÅÆÂïÜÂìÅ„Å´„ÅØ<strong>Êé°ÂØ∏„Éá„Éº„Çø</strong>„Åå‰ªò„ÅÑ„Å¶„ÅÑ„Åæ„Åô</li>
          <li>ÂÜôÁúü„ÅØ„Çµ„É≥„Éó„É´„Ç§„É°„Éº„Ç∏„Åß„Åô„ÄÇÂÆüÁâ©„Å®Â§öÂ∞ëÁï∞„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô</li>
          <li>Áä∂ÊÖã„É©„É≥„ÇØ„ÅØÁõÆË¶ñ„Å´„Çà„ÇãÂà§ÂÆö„Å®„Å™„Çä„Åæ„Åô</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">Áä∂ÊÖã„É©„É≥„ÇØ„Å´„Å§„ÅÑ„Å¶</h3>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr style="background:#f1f5f9;"><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">„É©„É≥„ÇØ</th><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">Áä∂ÊÖã</th></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#10b981;">S</td><td style="padding:10px;border:1px solid #e2e8f0;">Êñ∞ÂìÅ„ÉªÊú™‰ΩøÁî®„Éª„Çø„Ç∞‰ªò„Åç„Å™„Å©</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#3b82f6;">A</td><td style="padding:10px;border:1px solid #e2e8f0;">‰ΩøÁî®ÊÑü„Åå„Åª„Å®„Çì„Å©„Å™„ÅÑÁæéÂìÅ</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#6366f1;">AB</td><td style="padding:10px;border:1px solid #e2e8f0;">Â§öÂ∞ë„ÅÆ‰ΩøÁî®ÊÑü„Åå„ÅÇ„Çã„ÅåÁä∂ÊÖãËâØÂ•Ω</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#8b5cf6;">B</td><td style="padding:10px;border:1px solid #e2e8f0;">‰∏ÄËà¨ÁöÑ„Å™‰ΩøÁî®ÊÑü„ÉªËªΩÂæÆ„Å™„ÉÄ„É°„Éº„Ç∏„ÅÇ„Çä</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#a855f7;">C</td><td style="padding:10px;border:1px solid #e2e8f0;">‰ΩøÁî®ÊÑüÂº∑„ÇÅ„ÉªÁõÆÁ´ã„Å§„ÉÄ„É°„Éº„Ç∏„ÅÇ„Çä</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#d946ef;">D</td><td style="padding:10px;border:1px solid #e2e8f0;">„Ç∏„É£„É≥„ÇØ„ÉªÈõ£„ÅÇ„ÇäÂìÅ</td></tr>
        </table>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">„ÅîÊ≥®Êñá„Å´„Å§„ÅÑ„Å¶</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong style="color:#1e293b;">10ÁÇπ„Åã„Çâ</strong>Ë≥ºÂÖ•ÂèØËÉΩ„Åß„Åô</li>
          <li style="margin-bottom:8px;">ÈÄÅÊñô„ÅØ„ÅäÂ±ä„ÅëÂÖà„Å´Âøú„Åò„Å¶Ëá™ÂãïË®àÁÆó„Åï„Çå„Åæ„ÅôÔºà„ÉÄ„Ç§„É§„É¢„É≥„Éâ‰ºöÂì°„ÅØÈÄÅÊñôÁÑ°ÊñôÔºâ</li>
          <li>Âú®Â∫´„ÅØÂÖàÁùÄ„ÅÆ„Åü„ÇÅ„ÄÅÈÄÅ‰ø°Âæå„Å´Ê¨†ÂìÅ„Å®„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÁ¢∫‰øù‰∏≠Ë°®Á§∫„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆÊôÇÈñìÂÜÖ„ÅØÁ¢∫‰øùÔºâ</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">„ÅîÊ≥®Êñá„ÅÆÊµÅ„Çå</h3>
        <ol style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong>ÂïÜÂìÅÈÅ∏Êäû</strong>Ôºö„ÅäÂ•Ω„Åø„ÅÆÂïÜÂìÅ„Çí„Ç´„Éº„Éà„Å´ËøΩÂä†</li>
          <li style="margin-bottom:8px;"><strong>„ÅäÂ±ä„ÅëÂÖàÂÖ•Âäõ</strong>Ôºö‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åô„Çã„Å®ÈÄÅÊñô„ÅåËá™ÂãïË°®Á§∫„Åï„Çå„Åæ„Åô</li>
          <li style="margin-bottom:8px;"><strong>„ÅäÊîØÊâï„ÅÑ</strong>ÔºöÂïÜÂìÅ‰ª£ÔºãÈÄÅÊñô„Çí„Ç™„É≥„É©„Ç§„É≥Ê±∫Ê∏à<br><span style="font-size:12px;color:#888;">‚Äª„Ç≥„É≥„Éì„ÉãÊ±∫Ê∏à„ÅØÂà•ÈÄîÊâãÊï∞Êñô220ÂÜÜ„ÄÅÈäÄË°åÊåØËæº„ÅÆÊåØËæºÊâãÊï∞Êñô„ÅØ„ÅäÂÆ¢ÊßòË≤†ÊãÖ</span></li>
          <li><strong>Áô∫ÈÄÅ</strong>ÔºöÊ±∫Ê∏àÂÆå‰∫ÜÂæå„ÄÅÂïÜÂìÅ„ÇíÁô∫ÈÄÅ„ÅÑ„Åü„Åó„Åæ„Åô</li>
        </ol>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">Ââ≤Âºï„Å´„Å§„ÅÑ„Å¶</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><span style="color:#b8002a;font-weight:700;">30ÁÇπ‰ª•‰∏ä„Åß10%Ââ≤Âºï</span></li>
          <li style="margin-bottom:8px;" id="guideMemberDiscount"><strong>‰ºöÂì°Ââ≤Âºï</strong>Ôºö‰ºöÂì°ÁôªÈå≤„Åß<span style="color:#b8002a;font-weight:700;">10%OFF</span><span style="color:#666;font-size:13px;">Ôºà2026Âπ¥9ÊúàÊú´„Åæ„ÅßÔºâ</span></li>
          <li id="guideCombineDiscount"><span style="color:#b8002a;font-weight:700;">‚Äª ‰ΩµÁî®ÂèØ</span>Ôºà30ÁÇπÂâ≤ÂºïÔºã‰ºöÂì°Ââ≤Âºï„ÅÆÂêåÊôÇÈÅ©Áî®OKÔºâ</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">Ê≥®ÊÑè‰∫ãÈ†Ö</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>ÂïÜÂìÅ„ÅÆÁ¢∫‰øùÊúüÈñì„ÅØ<strong>15ÂàÜ</strong>„Åß„ÅôÔºà„Ç´„Éº„Éà„Å´ÂÖ•„Çå„ÅüÊôÇÁÇπ„Åã„ÇâÔºâ</li>
          <li>„ÅîÊ≥®ÊñáÁ¢∫ÂÆöÂæå„ÅÆ„Ç≠„É£„É≥„Çª„É´„ÉªÂ§âÊõ¥„ÅØ„Åß„Åç„Åæ„Åõ„Çì</li>
          <li>ËøîÂìÅ„Éª‰∫§Êèõ„ÅØÂéüÂâá„ÅäÂèó„Åë„Åó„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ‰∏á‰∏Ä„ÄÅÂïÜÂìÅÂÜÖÂÆπ„ÅåË®òËºâ‰∫ãÈ†Ö„Å®Â§ß„Åç„ÅèÁï∞„Å™„ÇãÂ†¥Âêà„ÅØ„ÄÅÂïÜÂìÅÂà∞ÁùÄÂæå7Êó•‰ª•ÂÜÖ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ÈÄÅÊñôË°®„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="shippingModal" aria-hidden="true" style="width:min(800px,96vw);">
    <div class="modalHeader">
      <div class="modalTitle">üöö ÈÄÅÊñôË°®</div>
      <button class="modalClose" id="shippingCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <!-- Ë•øÊó•Êú¨ -->
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f472b6;padding-bottom:8px;">Ë•øÊó•Êú¨ÔºàÂçó‰πùÂ∑û„ÄúÂåóÈô∏Ôºâ</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#fce7f3;">
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;width:80px;">ÂÆÖÈÖç‰æø</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">Âçó‰πùÂ∑û</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">Âåó‰πùÂ∑û</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">ÂõõÂõΩ</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">‰∏≠ÂõΩ</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">Èñ¢Ë•ø</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">ÂåóÈô∏</th>
            </tr>
            <tr style="background:#fdf2f8;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">ÈÉΩÈÅìÂ∫úÁúå</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">ÈπøÂÖêÂ≥∂„ÉªÁÜäÊú¨„ÉªÂÆÆÂ¥é</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">Á¶èÂ≤°„Éª‰ΩêË≥Ä„ÉªÂ§ßÂàÜ„ÉªÈï∑Â¥é</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">È¶ôÂ∑ù„ÉªÊÑõÂ™õ„ÉªÈ´òÁü•„ÉªÂæ≥Â≥∂</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">Â∫ÉÂ≥∂„ÉªÂ≤°Â±±„ÉªÂ≥∂Ê†π„ÉªÂ±±Âè£„ÉªÈ≥•Âèñ</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">Â§ßÈò™„ÉªÂÖµÂ∫´„Éª‰∫¨ÈÉΩ„ÉªÂ•àËâØ„ÉªÂíåÊ≠åÂ±±„ÉªÊªãË≥Ä</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">Áü≥Â∑ù„ÉªÁ¶è‰∫ï„ÉªÂØåÂ±±</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">ÂÆÖÈÖç‰æøÔºàÂ∞èÔºâ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,320ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,280ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,180ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,200ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,100ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,160ÂÜÜ</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">ÂÆÖÈÖç‰æøÔºàÂ§ßÔºâ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,700ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,620ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,440ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,480ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,260ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,420ÂÜÜ</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Êù±Êó•Êú¨ -->
      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #67e8f9;padding-bottom:8px;">Êù±Êó•Êú¨ÔºàÊù±Êµ∑„ÄúÂåóÊµ∑ÈÅìÔºâ</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#cffafe;">
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;width:80px;">ÂÆÖÈÖç‰æø</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">Êù±Êµ∑</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">‰ø°Ë∂ä</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">Èñ¢Êù±</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">ÂçóÊù±Âåó</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">ÂåóÊù±Âåó</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">ÂåóÊµ∑ÈÅì</th>
            </tr>
            <tr style="background:#ecfeff;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">ÈÉΩÈÅìÂ∫úÁúå</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">ÊÑõÁü•„ÉªÈùôÂ≤°„ÉªÂ≤êÈòú„Éª‰∏âÈáç</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">Êñ∞ÊΩü„ÉªÈï∑Èáé</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">Êù±‰∫¨„ÉªÁ•ûÂ•àÂ∑ù„ÉªÂüºÁéâ„ÉªÂçÉËëâ„ÉªËå®Âüé„ÉªÊ†ÉÊú®„ÉªÁæ§È¶¨„ÉªÂ±±Ê¢®</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">ÂÆÆÂüé„ÉªÁ¶èÂ≥∂„ÉªÂ±±ÂΩ¢</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">Â≤©Êâã„ÉªÁßãÁî∞„ÉªÈùíÊ£Æ</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">ÂåóÊµ∑ÈÅì</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">ÂÆÖÈÖç‰æøÔºàÂ∞èÔºâ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,180ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,220ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,300ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,400ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,460ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,640ÂÜÜ</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">ÂÆÖÈÖç‰æøÔºàÂ§ßÔºâ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,440ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,540ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,680ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,900ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,980ÂÜÜ</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">2,380ÂÜÜ</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Ê≤ñÁ∏Ñ -->
      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">Ê≤ñÁ∏ÑÊú¨Â≥∂</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;max-width:300px;">
            <tr style="background:#fef3c7;">
              <th style="padding:8px;text-align:center;border:1px solid #fcd34d;width:80px;">ÂÆÖÈÖç‰æø</th>
              <th style="padding:8px;text-align:center;border:1px solid #fcd34d;">Ê≤ñÁ∏ÑÊú¨Â≥∂</th>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;font-weight:700;background:#fffbeb;">ÂÆÖÈÖç‰æøÔºàÂ∞èÔºâ</td>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;">2,500ÂÜÜ</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;font-weight:700;background:#fffbeb;">ÂÆÖÈÖç‰æøÔºàÂ§ßÔºâ</td>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;">3,500ÂÜÜ</td>
            </tr>
          </table>
        </div>
        <p style="margin:8px 0 0;color:#b45309;font-size:12px;">‚Äª Ê≤ñÁ∏ÑÁúå„ÅÆÈõ¢Â≥∂ÔºàÂÆÆÂè§Â≥∂„ÉªÁü≥Âû£Â≥∂Á≠âÔºâ„ÅØÈÖçÈÄÅÂØæË±°Â§ñ„Åß„Åô„ÄÇ</p>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">„Çµ„Ç§„Ç∫„ÅÆÁõÆÂÆâ</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;font-size:13px;">
          <li><strong>ÂÆÖÈÖç‰æøÔºàÂ∞èÔºâ</strong>Ôºö10ÁùÄÁ®ãÂ∫¶</li>
          <li><strong>ÂÆÖÈÖç‰æøÔºàÂ§ßÔºâ</strong>Ôºö11„Äú40ÁùÄÁ®ãÂ∫¶</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">ÈÖçÈÄÅ„Å´„Å§„ÅÑ„Å¶</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>‰∏äË®òÈÄÅÊñô„ÅØÂÖ®„Å¶<strong>Á®éËæº„Åø</strong>„Åß„Åô</li>
          <li>‰ºöÂì°Ââ≤Âºï„ÅØÂïÜÂìÅ‰ª£„ÅÆ„Åø„Å´ÈÅ©Áî®„Åï„Çå„Åæ„ÅôÔºà<strong>ÈÄÅÊñô„ÅØÂâ≤ÂºïÂØæË±°Â§ñ</strong>Ôºâ</li>
          <li>Áô∫ÈÄÅ„ÅØ„ÅäÊîØÊâï„ÅÑÁ¢∫Ë™çÂæå<strong>2„Äú5Âñ∂Ê•≠Êó•</strong>‰ª•ÂÜÖ</li>
          <li>ÈÖçÈÄÅÊ•≠ËÄÖÔºö‰ΩêÂ∑ùÊÄ•‰æø„Éª„É§„Éû„ÉàÈÅãËº∏„ÉªÈÉµ‰æøÂ±Ä„ÅÆ„ÅÑ„Åö„Çå„ÅãÔºàÊåáÂÆö‰∏çÂèØÔºâ</li>
          <li>Êó•ÊôÇÊåáÂÆö‰∏çÂèØ</li>
          <li style="color:#b8002a;"><strong>Èõ¢Â≥∂„Å∏„ÅÆÈÖçÈÄÅ„ÅØÂØæË±°Â§ñ„Åß„Åô</strong></li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">„ÅäÂÆ¢Êßò„ÅîË≤†ÊãÖ„ÅÆÊ±∫Ê∏àÊâãÊï∞Êñô</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li><strong>„Ç≥„É≥„Éì„ÉãÊ±∫Ê∏à</strong>Ôºö220ÂÜÜÔºàÁ®éËæºÔºâ„ÅÆÊ±∫Ê∏àÊâãÊï∞Êñô„Åå„Åã„Åã„Çä„Åæ„Åô</li>
          <li><strong>ÈäÄË°åÊåØËæº</strong>ÔºöÊåØËæºÊâãÊï∞Êñô„ÅØ„ÅäÂÆ¢Êßò„ÅÆ„ÅîË≤†ÊãÖ„Å®„Å™„Çä„Åæ„ÅôÔºàÈáëÈ°ç„ÅØÈáëËûçÊ©üÈñ¢„Å´„Çà„ÇäÁï∞„Å™„Çä„Åæ„ÅôÔºâ</li>
          <li style="color:#888;">„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºöÊâãÊï∞Êñô„ÅØ„Åã„Åã„Çä„Åæ„Åõ„Çì</li>
        </ul>
      </div>
    </div>
  </div>


  <!-- ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„É¢„Éº„ÉÄ„É´ -->
  <div class="modal" id="legalModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò</div>
      <button class="modalClose" id="legalCloseBtn" aria-label="close">√ó</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <table style="width:100%;border-collapse:collapse;font-size:14px;">
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;width:140px;vertical-align:top;">Ë≤©Â£≤Ê•≠ËÄÖ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">Ë•øÂá∫ÂÖãÂà©</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÈÅãÂñ∂Áµ±Êã¨Ë≤¨‰ªªËÄÖ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">Ë•øÂá∫ÂÖãÂà©</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÊâÄÂú®Âú∞</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">Â§ßÈò™Â∫úÂ§ßÊù±Â∏ÇÁÅ∞Â°ö4-16-15</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÈõªË©±Áï™Âè∑</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">080-3130-9250</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">nkonline1030@gmail.com</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">Ë≤©Â£≤‰æ°Ê†º</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">ÂêÑÂïÜÂìÅ„Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Åü‰æ°Ê†ºÔºàÁ®éËæºÔºâ</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÈÄÅÊñô</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">Âú∞Âüü„Éª„Çµ„Ç§„Ç∫„Å´„Çà„ÇäÁï∞„Å™„Çä„Åæ„Åô„ÄÇË©≥Á¥∞„ÅØ<a href="#" id="legalShippingLink" style="color:#3b82f6;">ÈÄÅÊñôË°®</a>„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÊîØÊâïÊñπÊ≥ï</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºàVisa/MastercardÔºâ„ÄÅ„Ç≥„É≥„Éì„ÉãÊ±∫Ê∏à„ÄÅÈäÄË°åÊåØËæº<br><span style="font-size:12px;color:#888;">‚ÄªJCB/AMEX/Diners/Discover„ÉªPayPay„ÉªPaidyÔºà„ÅÇ„Å®Êâï„ÅÑÔºâ„ÅØÊ∫ñÂÇô‰∏≠</span></td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÊîØÊâïÊôÇÊúü</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            „ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºö„ÅîÊ≥®ÊñáÊôÇ„Å´Ê±∫Ê∏à<br>
            „Ç≥„É≥„Éì„ÉãÊ±∫Ê∏àÔºö„ÅîÊ≥®ÊñáÂæå7Êó•‰ª•ÂÜÖ„Å´„ÅäÊîØÊâï„ÅÑ<br>
            ÈäÄË°åÊåØËæºÔºö„ÅîÊ≥®ÊñáÂæå7Êó•‰ª•ÂÜÖ„Å´„ÅäÊåØËæº„Åø<br>
            „Åù„ÅÆ‰ªñÈõªÂ≠êÊ±∫Ê∏àÔºö„ÅîÊ≥®ÊñáÊôÇ„Å´Ê±∫Ê∏à
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">„ÅäÂÆ¢ÊßòË≤†ÊãÖ„ÅÆÊâãÊï∞Êñô</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            „Ç≥„É≥„Éì„ÉãÊ±∫Ê∏àÔºö<strong>220ÂÜÜÔºàÁ®éËæºÔºâ</strong>„ÅÆÊ±∫Ê∏àÊâãÊï∞Êñô„Åå„Åã„Åã„Çä„Åæ„ÅôÔºà„ÅäÂÆ¢ÊßòË≤†ÊãÖÔºâ<br>
            ÈäÄË°åÊåØËæºÔºö<strong>ÊåØËæºÊâãÊï∞Êñô</strong>„ÅØ„ÅäÂÆ¢Êßò„ÅÆ„ÅîË≤†ÊãÖ„Å®„Å™„Çä„Åæ„ÅôÔºàÈáëÈ°ç„ÅØÈáëËûçÊ©üÈñ¢„Å´„Çà„ÇäÁï∞„Å™„Çä„Åæ„ÅôÔºâ<br>
            <span style="font-size:12px;color:#888;">‚Äª„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºöÊâãÊï∞Êñô„ÅØ„Åã„Åã„Çä„Åæ„Åõ„Çì</span>
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ÂïÜÂìÅÂºïÊ∏°„ÅóÊôÇÊúü</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">„ÅîÂÖ•ÈáëÁ¢∫Ë™çÂæå„ÄÅ2„Äú5Âñ∂Ê•≠Êó•‰ª•ÂÜÖ„Å´Áô∫ÈÄÅ</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ËøîÂìÅ„Éª‰∫§Êèõ</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            ÂéüÂâá„Å®„Åó„Å¶ËøîÂìÅ„Éª‰∫§Êèõ„ÅØ„ÅäÂèó„Åë„Åó„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ<br>
            ‰∏á‰∏Ä„ÄÅÂïÜÂìÅÂÜÖÂÆπ„ÅåË®òËºâ‰∫ãÈ†Ö„Å®Â§ß„Åç„ÅèÁï∞„Å™„ÇãÂ†¥Âêà„ÅØ„ÄÅÂïÜÂìÅÂà∞ÁùÄÂæå7Êó•‰ª•ÂÜÖ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">ËøîÈáë„Å´„Å§„ÅÑ„Å¶</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            ÂΩìÊñπ„ÅÆÈÉΩÂêà„Å´„Çà„ÇãËøîÈáë„ÅÆÂ†¥Âêà„ÄÅ„ÅîÂà©Áî®„ÅÆÊ±∫Ê∏àÊñπÊ≥ï„Å´Âøú„Åò„Å¶ËøîÈáëÂá¶ÁêÜ„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ<br>
            „ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºö„Ç´„Éº„Éâ‰ºöÁ§æÁµåÁî±„Åß„ÅÆËøîÈáë<br>
            „Ç≥„É≥„Éì„ÉãÊ±∫Ê∏à„ÉªÈäÄË°åÊåØËæºÔºö„ÅîÊåáÂÆö„ÅÆÈäÄË°åÂè£Â∫ß„Å∏ËøîÈáë<br>
            ÈõªÂ≠êÊ±∫Ê∏àÔºöÂêÑ„Çµ„Éº„Éì„ÇπÁµåÁî±„Åß„ÅÆËøîÈáë
          </td>
        </tr>
      </table>
    </div>
  </div>

<footer style="background:#1e293b; color:#94a3b8; padding:32px 16px; margin-top:40px; font-size:13px;">
  <div style="max-width:900px; margin:0 auto; text-align:center;">
    <div style="display:flex; justify-content:center; gap:24px; flex-wrap:wrap; margin-bottom:16px;">
      <a href="#" id="openLegalLink" style="color:#cbd5e1; text-decoration:none;">ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò</a>
      <a href="https://nkonline.buyshop.jp/privacy" target="_blank" rel="noopener noreferrer" style="color:#cbd5e1; text-decoration:none;">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>
    </div>
    <div style="color:#64748b;">&copy; 2025-2026 „Éá„Çø„Ç¶„É™.Detauri</div>
  </div>
</footer>

<script>
// =====================================================
// Áä∂ÊÖãÁÆ°ÁêÜ
// =====================================================

var state = {
  userKey: '',
  allProducts: [],
  filteredProducts: [],
  settings: null,
  options: null,
  query: {
    filters: { brand: [], category: [], state: [], gender: [], size: [] },
    sort: { key: 'default', dir: 'asc' },
    page: 1,
    pageSize: 60
  },
  cart: { ids: [], itemsById: {}, digest: {} },
  ui: { cardEls: {} },
  timers: { statusPoll: null },
  brandUi: { all: [], selected: {}, cbByName: {}, built: false },
  // È°ßÂÆ¢Ë™çË®º
  customer: null,  // { id, email, companyName, phone, postal, address, newsletter }
  sessionId: null,
  csrfToken: null,
  dataLoaded: false
};

// =====================================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
// =====================================================

function $(id) { return document.getElementById(id); }

function escapeHtml_(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function yen(n) {
  var x = Math.round(Number(n || 0));
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'ÂÜÜ';
}

// „Éñ„É©„É≥„ÉâÂêç„ÇíÊ≠£Ë¶èÂåñÔºàÂ§ßÊñáÂ≠óÂ∞èÊñáÂ≠ó„Éª„Çπ„Éö„Éº„ÇπÁµ±‰∏ÄÔºâ
function normalizeBrand_(name) {
  if (!name) return '';
  // „Çπ„Éö„Éº„Çπ„ÇíÈô§Âéª„Åó„ÄÅÂ§ßÊñáÂ≠ó„Å´Áµ±‰∏Ä
  return String(name).replace(/\s+/g, '').toUpperCase();
}

// Ê≠£Ë¶èÂåñ„Éñ„É©„É≥„Éâ„Ç≠„Éº ‚Üí Ë°®Á§∫Âêç„ÅÆ„Éû„ÉÉ„ÉóÔºàÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„Åü„ÇÇ„ÅÆ„Çí‰ΩøÁî®Ôºâ
var brandDisplayMap_ = {};
var brandNormalizedMap_ = {}; // ÂÖÉ„ÅÆ„Éñ„É©„É≥„ÉâÂêç ‚Üí Ê≠£Ë¶èÂåñ„Ç≠„Éº

function showToast(msg) {
  var t = $('toast');
  t.textContent = String(msg || '');
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2600);
}

// =====================================================
// È°ßÂÆ¢Ë™çË®º
// =====================================================

var SESSION_KEY = 'estimate_session';
var MEMBER_DISCOUNT_RATE = 0.10;  // ‰ºöÂì°Ââ≤ÂºïÔºàAPI„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„ÇãÔºâ
var MEMBER_DISCOUNT_ENABLED = true; // ‰ºöÂì°Ââ≤ÂºïON/OFFÔºàAPI„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„ÇãÔºâ
var MEMBER_DISCOUNT_END_DATE = '2026-09-30'; // ÊúüÈôêÔºàAPI„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„ÇãÔºâ
var BULK_DISCOUNT_RATE = 0.10;    // 30ÁÇπ‰ª•‰∏äÂâ≤Âºï10%

// =====================================================
// ÈÄÅÊñôË®àÁÆóÔºà„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÔºâ
// ‚ÄªÈÄÅÊñô„ÅØÂÖ®„Å¶Á®éËæº„Åø„ÄÇ‰ºöÂì°Ââ≤Âºï„ÅØÈÄÅÊñô„Å´„ÅØÈÅ©Áî®„Åó„Å™„ÅÑ„ÄÇ
// =====================================================

var SHIPPING_AREAS = {
  'ÂåóÊµ∑ÈÅì': 'hokkaido',
  'ÈùíÊ£ÆÁúå': 'kita_tohoku', 'Â≤©ÊâãÁúå': 'kita_tohoku', 'ÁßãÁî∞Áúå': 'kita_tohoku',
  'ÂÆÆÂüéÁúå': 'minami_tohoku', 'Á¶èÂ≥∂Áúå': 'minami_tohoku', 'Â±±ÂΩ¢Áúå': 'minami_tohoku',
  'Êù±‰∫¨ÈÉΩ': 'kanto', 'Á•ûÂ•àÂ∑ùÁúå': 'kanto', 'ÂüºÁéâÁúå': 'kanto', 'ÂçÉËëâÁúå': 'kanto',
  'Ëå®ÂüéÁúå': 'kanto', 'Ê†ÉÊú®Áúå': 'kanto', 'Áæ§È¶¨Áúå': 'kanto', 'Â±±Ê¢®Áúå': 'kanto',
  'Êñ∞ÊΩüÁúå': 'shinetsu', 'Èï∑ÈáéÁúå': 'shinetsu',
  'ÊÑõÁü•Áúå': 'tokai', 'ÈùôÂ≤°Áúå': 'tokai', 'Â≤êÈòúÁúå': 'tokai', '‰∏âÈáçÁúå': 'tokai',
  'Áü≥Â∑ùÁúå': 'hokuriku', 'Á¶è‰∫ïÁúå': 'hokuriku', 'ÂØåÂ±±Áúå': 'hokuriku',
  'Â§ßÈò™Â∫ú': 'kansai', 'ÂÖµÂ∫´Áúå': 'kansai', '‰∫¨ÈÉΩÂ∫ú': 'kansai',
  'Â•àËâØÁúå': 'kansai', 'ÂíåÊ≠åÂ±±Áúå': 'kansai', 'ÊªãË≥ÄÁúå': 'kansai',
  'Â∫ÉÂ≥∂Áúå': 'chugoku', 'Â≤°Â±±Áúå': 'chugoku', 'Â≥∂Ê†πÁúå': 'chugoku',
  'Â±±Âè£Áúå': 'chugoku', 'È≥•ÂèñÁúå': 'chugoku',
  'È¶ôÂ∑ùÁúå': 'shikoku', 'ÊÑõÂ™õÁúå': 'shikoku', 'È´òÁü•Áúå': 'shikoku', 'Âæ≥Â≥∂Áúå': 'shikoku',
  'Á¶èÂ≤°Áúå': 'kita_kyushu', '‰ΩêË≥ÄÁúå': 'kita_kyushu', 'Â§ßÂàÜÁúå': 'kita_kyushu', 'Èï∑Â¥éÁúå': 'kita_kyushu',
  'ÈπøÂÖêÂ≥∂Áúå': 'minami_kyushu', 'ÁÜäÊú¨Áúå': 'minami_kyushu', 'ÂÆÆÂ¥éÁúå': 'minami_kyushu',
  'Ê≤ñÁ∏ÑÁúå': 'okinawa'
};

var SHIPPING_RATES = {
  minami_kyushu: [1320, 1700], kita_kyushu: [1280, 1620],
  shikoku: [1180, 1440], chugoku: [1200, 1480],
  kansai: [1100, 1260], hokuriku: [1160, 1420],
  tokai: [1180, 1440], shinetsu: [1220, 1540],
  kanto: [1300, 1680], minami_tohoku: [1400, 1900],
  kita_tohoku: [1460, 1980], hokkaido: [1640, 2380],
  okinawa: [2500, 3500]
};

var REMOTE_ISLANDS_KEYWORDS = [
  'Â§ßÂ≥∂Áî∫','Âà©Â≥∂Êùë','Êñ∞Â≥∂Êùë','Á•ûÊ¥•Â≥∂Êùë','‰∏âÂÆÖÊùë','Âæ°ËîµÂ≥∂Êùë','ÂÖ´‰∏àÁî∫','Èùí„É∂Â≥∂Êùë','Â∞èÁ¨†ÂéüÊùë',
  'Â•ÑÁæéÂ∏Ç','Â§ßÂíåÊùë','ÂÆáÊ§úÊùë','ÁÄ¨Êà∏ÂÜÖÁî∫','ÈæçÈÉ∑Áî∫','ÂñúÁïåÁî∫','Âæ≥‰πãÂ≥∂Áî∫','Â§©ÂüéÁî∫','‰ºä‰ªôÁî∫',
  'ÂíåÊ≥äÁî∫','Áü•ÂêçÁî∫','‰∏éË´ñÁî∫','‰∏âÂ≥∂Êùë','ÂçÅÂ≥∂Êùë',
  'ÂÆÆÂè§Â≥∂Â∏Ç','Áü≥Âû£Â∏Ç','Â§öËâØÈñìÊùë','Á´πÂØåÁî∫','‰∏éÈÇ£ÂõΩÁî∫','‰πÖÁ±≥Â≥∂Áî∫','Â∫ßÈñìÂë≥Êùë','Ê∏°ÂòâÊï∑Êùë',
  'Á≤üÂõΩÊùë','Ê∏°ÂêçÂñúÊùë','ÂçóÂ§ßÊù±Êùë','ÂåóÂ§ßÊù±Êùë','‰ºäÊ±üÊùë','‰ºäÊòØÂêçÊùë','‰ºäÂπ≥Â±ãÊùë',
  '‰ΩêÊ∏°Â∏Ç','Èö†Â≤ê„ÅÆÂ≥∂Áî∫','Êµ∑Â£´Áî∫','Ë•ø„ÉéÂ≥∂Áî∫','Áü•Â§´Êùë',
  'ÂØæÈ¶¨Â∏Ç','Â£±Â≤êÂ∏Ç','‰∫îÂ≥∂Â∏Ç','Êñ∞‰∏ä‰∫îÂ≥∂Áî∫','Â∞èÂÄ§Ë≥ÄÁî∫',
  'Âà©Â∞ªÁî∫','Âà©Â∞ªÂØåÂ£´Áî∫','Á§ºÊñáÁî∫','Â••Â∞ªÁî∫'
];

var PREFECTURES = [
  'ÂåóÊµ∑ÈÅì','ÈùíÊ£ÆÁúå','Â≤©ÊâãÁúå','ÂÆÆÂüéÁúå','ÁßãÁî∞Áúå','Â±±ÂΩ¢Áúå','Á¶èÂ≥∂Áúå',
  'Ëå®ÂüéÁúå','Ê†ÉÊú®Áúå','Áæ§È¶¨Áúå','ÂüºÁéâÁúå','ÂçÉËëâÁúå','Êù±‰∫¨ÈÉΩ','Á•ûÂ•àÂ∑ùÁúå',
  'Êñ∞ÊΩüÁúå','ÂØåÂ±±Áúå','Áü≥Â∑ùÁúå','Á¶è‰∫ïÁúå','Â±±Ê¢®Áúå','Èï∑ÈáéÁúå',
  'Â≤êÈòúÁúå','ÈùôÂ≤°Áúå','ÊÑõÁü•Áúå','‰∏âÈáçÁúå',
  'ÊªãË≥ÄÁúå','‰∫¨ÈÉΩÂ∫ú','Â§ßÈò™Â∫ú','ÂÖµÂ∫´Áúå','Â•àËâØÁúå','ÂíåÊ≠åÂ±±Áúå',
  'È≥•ÂèñÁúå','Â≥∂Ê†πÁúå','Â≤°Â±±Áúå','Â∫ÉÂ≥∂Áúå','Â±±Âè£Áúå',
  'Âæ≥Â≥∂Áúå','È¶ôÂ∑ùÁúå','ÊÑõÂ™õÁúå','È´òÁü•Áúå',
  'Á¶èÂ≤°Áúå','‰ΩêË≥ÄÁúå','Èï∑Â¥éÁúå','ÁÜäÊú¨Áúå','Â§ßÂàÜÁúå','ÂÆÆÂ¥éÁúå','ÈπøÂÖêÂ≥∂Áúå','Ê≤ñÁ∏ÑÁúå'
];

function detectPrefectureFromAddress_(text) {
  text = String(text || '').trim();
  for (var i = 0; i < PREFECTURES.length; i++) {
    if (text.indexOf(PREFECTURES[i]) === 0) return PREFECTURES[i];
  }
  for (var j = 0; j < PREFECTURES.length; j++) {
    var short = PREFECTURES[j].replace(/[ÈÉΩÂ∫úÁúå]$/, '');
    if (text.indexOf(short) === 0) return PREFECTURES[j];
  }
  return null;
}

function isRemoteIslandAddress_(text) {
  text = String(text || '');
  for (var i = 0; i < REMOTE_ISLANDS_KEYWORDS.length; i++) {
    if (text.indexOf(REMOTE_ISLANDS_KEYWORDS[i]) !== -1) return true;
  }
  return false;
}

function classifyThickness_(items) {
  var thick = 0, thin = 0;
  for (var i = 0; i < items.length; i++) {
    if (String(items[i].shippingMethod || '').trim() === '„ÇÜ„ÅÜ„Éë„Ç±„ÉÉ„Éà„Éù„Çπ„Éà') thin++;
    else thick++;
  }
  return { thick: thick, thin: thin, total: thick + thin };
}

function calcShippingSize_(thick, thin) {
  var total = thick + thin;
  if (thin === 0) {
    // ÂéöÊâã„ÅÆ„Åø
    if (total > 20) return { size: null, reason: 'overLimit' };
    return { size: 'large', label: 'Â§ß' };
  }
  if (thick === 0) {
    // ËñÑÊâã„ÅÆ„Åø
    if (total > 40) return { size: null, reason: 'overLimit' };
    return total <= 10 ? { size: 'small', label: 'Â∞è' } : { size: 'large', label: 'Â§ß' };
  }
  // Ê∑∑Âêà
  if (total > 40) return { size: null, reason: 'overLimit' };
  if (thick >= 10) return { size: 'large', label: 'Â§ß' };
  return total <= 10 ? { size: 'small', label: 'Â∞è' } : { size: 'large', label: 'Â§ß' };
}

/** ÈÄÅÊñôË®àÁÆó„É°„Ç§„É≥ */
function calculateShipping_() {
  var ids = state.cart.ids || [];
  if (ids.length === 0) return { amount: null, label: '', canAutoPayment: false };

  // „ÉÄ„Ç§„É§„É¢„É≥„Éâ‰ºöÂì° ‚Üí ÈÄÅÊñôÁÑ°Êñô
  if (state.customer && state.customer.rank && state.customer.rank.freeShipping) {
    return { amount: 0, label: 'ÈÄÅÊñôÁÑ°ÊñôÔºà„ÉÄ„Ç§„É§„É¢„É≥„Éâ‰ºöÂì°ÁâπÂÖ∏Ôºâ', canAutoPayment: true };
  }

  var addressEl = $('address');
  var address = addressEl ? addressEl.value.trim() : '';
  if (!address) return { amount: null, label: '‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åô„Çã„Å®ÈÄÅÊñô„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô', canAutoPayment: false };

  // Èõ¢Â≥∂„ÉÅ„Çß„ÉÉ„ÇØ
  if (isRemoteIslandAddress_(address)) {
    return { amount: null, label: 'Èõ¢Â≥∂„Å∏„ÅÆÈÖçÈÄÅ„ÅØÂØæË±°Â§ñ„Åß„Åô', canAutoPayment: false, isRemoteIsland: true };
  }

  var pref = detectPrefectureFromAddress_(address);
  if (!pref) return { amount: null, label: '‰ΩèÊâÄ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÈÉΩÈÅìÂ∫úÁúå„Åã„ÇâÔºâ', canAutoPayment: false };

  var area = SHIPPING_AREAS[pref];
  if (!area || !SHIPPING_RATES[area]) return { amount: null, label: 'ÈÄÅÊñô„ÅØÂà•ÈÄî„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô', canAutoPayment: false };

  // „Ç´„Éº„ÉàÂïÜÂìÅ„ÅÆÂéö„ÅøÊÉÖÂ†±„ÇíÂèñÂæó
  var items = [];
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) items.push(it);
  }

  var t = classifyThickness_(items);
  var sizeResult = calcShippingSize_(t.thick, t.thin);

  if (!sizeResult.size) {
    return { amount: null, label: 'ÁÇπÊï∞„ÅåÂ§ö„ÅÑ„Åü„ÇÅÈÄÅÊñô„ÅØÂà•ÈÄî„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô', canAutoPayment: false };
  }

  var rateIdx = (sizeResult.size === 'small') ? 0 : 1;
  var amount = SHIPPING_RATES[area][rateIdx];

  return {
    amount: amount,
    label: yen(amount) + 'Ôºà' + pref + '„Éª' + sizeResult.label + '„ÉªÁ®éËæºÔºâ',
    canAutoPayment: true,
    size: sizeResult.size,
    sizeLabel: sizeResult.label,
    area: area,
    pref: pref
  };
}

/** ÈÄÅÊñôË°®Á§∫„ÇíÊõ¥Êñ∞ */
function updateShippingDisplay_() {
  var shipEl = $('sumShipping');
  var totalEl = $('sumTotal');
  var noteEl = $('shippingNote');
  var warnEl = $('remoteIslandWarning');
  var feeNoteEl = $('paymentFeeNote');
  if (!shipEl) return;

  var result = calculateShipping_();
  state.lastShipping = result; // ÈÄÅ‰ø°ÊôÇ„Å´ÂèÇÁÖß

  if (result.isRemoteIsland) {
    shipEl.style.display = 'none';
    totalEl.style.display = 'none';
    noteEl.style.display = 'none';
    if (feeNoteEl) feeNoteEl.style.display = 'none';
    warnEl.style.display = '';
    warnEl.textContent = 'Èõ¢Â≥∂„Å∏„ÅÆÈÖçÈÄÅ„ÅØÂØæË±°Â§ñ„Åß„Åô„ÄÇÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÅîÊ≥®Êñá„ÅÑ„Åü„Å†„Åë„Åæ„Åõ„Çì„ÄÇ';
    return;
  }

  warnEl.style.display = 'none';

  if (result.amount === null && !result.label) {
    shipEl.style.display = 'none';
    totalEl.style.display = 'none';
    noteEl.style.display = 'none';
    if (feeNoteEl) feeNoteEl.style.display = 'none';
    return;
  }

  if (result.amount === null) {
    shipEl.style.display = '';
    shipEl.innerHTML = 'ÈÄÅÊñôÔºö' + result.label;
    totalEl.style.display = 'none';
    noteEl.style.display = '';
    if (feeNoteEl) feeNoteEl.style.display = '';
    return;
  }

  // ÈÄÅÊñôË®àÁÆóÊàêÂäü
  shipEl.style.display = '';
  noteEl.style.display = '';
  if (feeNoteEl) feeNoteEl.style.display = '';
  shipEl.innerHTML = 'ÈÄÅÊñôÔºö' + result.label;

  // ÂïÜÂìÅÂêàË®à„ÇíË®àÁÆóÔºàÂâ≤ÂºïÂæåÔºâ
  var productTotal = calcProductTotal_();
  var grandTotal = productTotal + result.amount;
  totalEl.style.display = '';
  totalEl.innerHTML = '„ÅäÊîØÊâï„ÅÑÂêàË®àÔºö' + yen(grandTotal);
}

/** ÂïÜÂìÅ‰ª£ÂêàË®àÔºàÂâ≤Âºï„Éª„Éù„Ç§„É≥„ÉàÈÅ©Áî®ÂæåÔºâ */
function calcProductTotal_() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var discountRate = 0;
  if (ids.length >= 30) discountRate += BULK_DISCOUNT_RATE;
  if (state.customer && MEMBER_DISCOUNT_ENABLED) discountRate += MEMBER_DISCOUNT_RATE;
  var discounted = Math.round(sum * (1 - discountRate));
  // „Éù„Ç§„É≥„ÉàÈÅ©Áî®
  var pts = parseInt(($('usePoints') ? $('usePoints').value : 0), 10) || 0;
  if (pts > 0 && state.customer) {
    var maxPts = (state.customer.points || 0);
    pts = Math.min(pts, maxPts, discounted);
    discounted -= pts;
  }
  return discounted;
}

function loadSession_() {
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) { return null; }
}

function saveSession_(sessionId, customer) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: sessionId, customer: customer }));
  } catch (e) {}
}

function clearSession_() {
  try { localStorage.removeItem(SESSION_KEY); } catch (e) {}
  state.sessionId = null;
  state.customer = null;
  state.csrfToken = null;
}

function fetchCsrfToken_() {
  if (!state.userKey) return;
  runApi('apiGetCsrfToken', state.userKey)
    .then(function(res) {
      if (res && res.ok && res.csrfToken) {
        state.csrfToken = res.csrfToken;
      }
    })
    .catch(function() {});
}

function updateAuthUi_() {
  var area = $('authArea');
  if (!area) return;

  // „Éó„É≠„É¢„Éê„Éä„Éº„ÅÆË°®Á§∫Âà∂Âæ°
  var banner = $('promoBanner');
  if (banner) {
    var dismissed = false;
    try { dismissed = sessionStorage.getItem('promoBannerDismissed') === '1'; } catch (e) {}
    if (state.customer || dismissed || !MEMBER_DISCOUNT_ENABLED) {
      banner.style.display = 'none';
    } else {
      banner.style.display = 'block';
    }
  }

  if (state.customer) {
    var discountLabel = MEMBER_DISCOUNT_ENABLED ? '<span class="authDiscount">10%OFF</span>' : '';
    var pointsLabel = (state.customer.points > 0) ? '<span class="authPoints">' + state.customer.points + 'pt</span>' : '';
    // „É©„É≥„ÇØ„Éê„ÉÉ„Ç∏
    var rankLabel = '';
    if (state.customer.rank && state.customer.rank.name) {
      rankLabel = '<span style="background:' + (state.customer.rank.color || '#64748b') + ';color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700;">' + state.customer.rank.name + '</span>';
    }
    area.innerHTML = '<div class="authUser">' +
      '<span class="authUserName">' + escapeHtml_(state.customer.companyName || state.customer.email) + '</span>' +
      rankLabel + discountLabel + pointsLabel +
      '</div>' +
      '<button class="authBtn mypage" id="openMyPageBtn" type="button">„Éû„Ç§„Éö„Éº„Ç∏</button>' +
      '<button class="authBtn logout" id="logoutBtn" type="button">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>';

    var openMyPageBtn = $('openMyPageBtn');
    if (openMyPageBtn) {
      openMyPageBtn.addEventListener('click', function() { openMyPage_(); });
    }
    var logoutBtn = $('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() { doLogout_(); });
    }
  } else {
    area.innerHTML = '<button class="authBtn" id="openAuthBtn" type="button">„É≠„Ç∞„Ç§„É≥ / Êñ∞Ë¶èÁôªÈå≤</button>';
    var openAuthBtn = $('openAuthBtn');
    if (openAuthBtn) {
      openAuthBtn.addEventListener('click', function() {
        openAuthModal_('login');
      });
    }
  }
}

function openAuthModal_(mode) {
  var modal = $('authModal');
  if (!modal) return;

  // ÂÖ®„Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫
  $('loginForm').style.display = 'none';
  $('registerForm').style.display = 'none';
  $('forgotPasswordForm').style.display = 'none';
  $('forgotEmailForm').style.display = 'none';

  // ÁµêÊûúË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
  var recoverResult = $('recoverEmailResult');
  if (recoverResult) recoverResult.style.display = 'none';

  if (mode === 'register') {
    $('authModalTitle').textContent = 'Êñ∞Ë¶èÁôªÈå≤';
    $('registerForm').style.display = '';
  } else if (mode === 'forgotPassword') {
    $('authModalTitle').textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„ÅÆÊñπ';
    $('forgotPasswordForm').style.display = '';
  } else if (mode === 'forgotEmail') {
    $('authModalTitle').textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí„ÅäÂøò„Çå„ÅÆÊñπ';
    $('forgotEmailForm').style.display = '';
  } else {
    $('authModalTitle').textContent = '„É≠„Ç∞„Ç§„É≥';
    $('loginForm').style.display = '';
  }

  openModal(modal);
}

function doLogin_() {
  var email = ($('loginEmail').value || '').trim();
  var password = $('loginPassword').value || '';
  var rememberMe = $('rememberMe') ? $('rememberMe').checked : false;

  if (!email || !password) {
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  setSending_(true, '„É≠„Ç∞„Ç§„É≥‰∏≠...');

  runApi('apiLoginCustomer', state.userKey, { email: email, password: password, rememberMe: rememberMe })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        fetchCsrfToken_();
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
        // Ââ≤Âºï„ÇíÂèçÊò†
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    });
}

function doRegister_() {
  var email = ($('regEmail').value || '').trim();
  var password = $('regPassword').value || '';
  var companyName = ($('regCompanyName').value || '').trim();
  var phone = ($('regPhone').value || '').trim();
  var postal = ($('regPostal').value || '').trim();
  var address = ($('regAddress').value || '').trim();
  var newsletter = $('regNewsletter').checked;

  if (!email || !email.includes('@')) {
    showToast('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  if (!password || password.length < 6) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  if (!companyName) {
    showToast('‰ºöÁ§æÂêç/Ê∞èÂêç„ÅØÂøÖÈ†à„Åß„Åô');
    return;
  }

  setSending_(true, 'ÁôªÈå≤‰∏≠...');

  runApi('apiRegisterCustomer', state.userKey, {
    email: email,
    password: password,
    companyName: companyName,
    phone: phone,
    postal: postal,
    address: address,
    newsletter: newsletter
  })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        fetchCsrfToken_();
        updateAuthUi_();
        closeModal($('authModal'));
        showToast(MEMBER_DISCOUNT_ENABLED ? 'ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ10%Ââ≤Âºï„ÅåÈÅ©Áî®„Åï„Çå„Åæ„Åô' : 'ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    });
}

// =====================================================
// „Éû„Ç§„Éö„Éº„Ç∏
// =====================================================

function openMyPage_() {
  var modal = $('myPageModal');
  if (!modal) return;

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅßÂç≥ÊôÇË°®Á§∫ÔºàAPIÂøúÁ≠îÂâç„ÅÆ„É©„Ç∞Ëß£Ê∂àÔºâ
  if (state.customer) {
    $('mpEmail').value = state.customer.email || '';
    $('mpCompanyName').value = state.customer.companyName || '';
    $('mpPhone').value = String(state.customer.phone || '').replace(/^'/, '');
    $('mpPostal').value = String(state.customer.postal || '').replace(/^'/, '');
    $('mpAddress').value = state.customer.address || '';
    $('mpPointBalance').textContent = String(state.customer.points || 0);
  }

  openModal(modal);
  loadMyPage_();
}

function loadMyPage_() {
  if (!state.sessionId) return;
  var orderList = $('mpOrderList');
  if (orderList) orderList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

  runApi('apiGetMyPage', state.userKey || '', { sessionId: state.sessionId })
    .then(function(res) {
      if (!res || !res.ok || !res.data) {
        showToast((res && res.message) || '„Éû„Ç§„Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        return;
      }
      var d = res.data;
      // „Éó„É≠„Éï„Ç£„Éº„É´
      $('mpEmail').value = d.profile.email || '';
      $('mpCompanyName').value = d.profile.companyName || '';
      $('mpPhone').value = d.profile.phone || '';
      $('mpPostal').value = d.profile.postal || '';
      $('mpAddress').value = d.profile.address || '';
      $('mpRegisteredAt').textContent = d.profile.registeredAt || '-';
      // „Éù„Ç§„É≥„Éà
      $('mpPointBalance').textContent = String(d.points || 0);
      if (state.customer) state.customer.points = d.points || 0;
      updateAuthUi_();
      // Áµ±Ë®à„Éá„Éº„Çø
      if (d.stats) {
        $('mpTotalOrders').textContent = String(d.stats.totalOrders || 0) + 'Âõû';
        $('mpTotalItems').textContent = String(d.stats.totalItems || 0) + 'ÁÇπ';
      }
      // „É©„É≥„ÇØÊÉÖÂ†±ÔºàAPI„Åã„ÇâÂèñÂæóÔºâ
      if (d.rank) {
        var r = d.rank;
        $('mpTotalSpent').textContent = yen(r.annualSpent || 0);
        $('mpMemberRank').innerHTML = '<span style="color:' + (r.color || '#64748b') + ';">' + (r.name || '„É¨„ÇÆ„É•„É©„Éº') + '</span>';

        // „É©„É≥„ÇØ„Ç´„Éº„ÉâÊõ¥Êñ∞
        var rankCard = $('mpRankCard');
        if (rankCard) {
          var gradients = {
            'DIAMOND': 'linear-gradient(135deg,#006064,#00838f)',
            'GOLD': 'linear-gradient(135deg,#78350f,#b45309)',
            'SILVER': 'linear-gradient(135deg,#475569,#64748b)',
            'REGULAR': 'linear-gradient(135deg,#1e293b,#334155)'
          };
          rankCard.style.background = gradients[r.rank] || gradients['REGULAR'];
        }
        $('mpRankName').textContent = r.name || '„É¨„ÇÆ„É•„É©„Éº';
        $('mpRankPointRate').textContent = '„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉÁéá: ' + Math.round((r.pointRate || 0.01) * 100) + '%';
        var benefits = [];
        if (r.freeShipping) benefits.push('ÈÄÅÊñôÁÑ°Êñô');
        $('mpRankBenefits').textContent = benefits.length > 0 ? 'ÁâπÂÖ∏: ' + benefits.join('„ÄÅ') : '';

        // ÈÄ≤Êçó„Éê„Éº
        var progressEl = $('mpRankProgress');
        if (progressEl && r.nextRank && r.nextThreshold > 0) {
          var pct = Math.min(100, Math.round((r.annualSpent / r.nextThreshold) * 100));
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;margin-bottom:4px;">'
            + 'Ê¨°„ÅÆ„É©„É≥„ÇØÔºà' + r.nextRank + 'Ôºâ„Åæ„Åß„ÅÇ„Å® ' + yen(r.remaining || 0)
            + '</div>'
            + '<div style="background:rgba(255,255,255,0.2);border-radius:4px;height:6px;overflow:hidden;">'
            + '<div style="background:#fff;height:100%;border-radius:4px;width:' + pct + '%;transition:width .5s;"></div>'
            + '</div>'
            + '<div style="font-size:10px;opacity:0.6;margin-top:2px;text-align:right;">' + yen(r.annualSpent) + ' / ' + yen(r.nextThreshold) + '</div>';
        } else if (progressEl) {
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;">ÊúÄÈ´ò„É©„É≥„ÇØ„Å´Âà∞ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô</div>';
        }

        // ÊïëÊ∏àÊé™ÁΩÆ„ÅÆÈÄöÁü•
        if (r.graceInfo && !r.graceInfo.restored && r.graceInfo.prevRank) {
          var graceNotice = $('mpRankProgress');
          if (graceNotice) {
            graceNotice.innerHTML += '<div style="margin-top:8px;padding:8px;background:rgba(255,255,255,0.15);border-radius:6px;font-size:11px;">'
              + 'ÂâçÂπ¥„ÅÆ' + (r.graceInfo.prevRank === 'DIAMOND' ? '„ÉÄ„Ç§„É§„É¢„É≥„Éâ' : '„Ç¥„Éº„É´„Éâ') + '„É©„É≥„ÇØ„ÅåÊõ¥Êñ∞Âàá„Çå„Åß„Åô„ÄÇ'
              + '1„É∂Êúà‰ª•ÂÜÖ„Å´„ÅÇ„Å®' + yen(r.graceInfo.needed || 0) + 'Ë≥ºÂÖ•„Åß„É©„É≥„ÇØÂæ©Ê¥ª„Åß„Åç„Åæ„Åô„ÄÇ'
              + '</div>';
          }
        }

        // state.customer„Å´„É©„É≥„ÇØÊÉÖÂ†±„Çí‰øùÂ≠òÔºà„Éò„ÉÉ„ÉÄ„ÉºË°®Á§∫Áî®Ôºâ
        if (state.customer) {
          state.customer.rank = r;
        }
        updateAuthUi_();
      } else if (d.stats) {
        $('mpTotalSpent').textContent = yen(d.stats.totalSpent || 0);
        var rank = getMemberRank_(d.stats.totalSpent || 0);
        $('mpMemberRank').innerHTML = '<span style="color:' + rank.color + ';">' + rank.name + '</span>';
      }
      // Ê≥®ÊñáÂ±•Ê≠¥
      renderOrderHistory_(d.orders || []);
    })
    .catch(function() { showToast('„Éû„Ç§„Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); });
}

function getMemberRank_(totalSpent) {
  if (totalSpent >= 500000) return { name: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ', color: '#00bcd4', pointRate: 5, freeShipping: true };
  if (totalSpent >= 200000) return { name: '„Ç¥„Éº„É´„Éâ', color: '#f59e0b', pointRate: 5, freeShipping: false };
  if (totalSpent >= 50000) return { name: '„Ç∑„É´„Éê„Éº', color: '#94a3b8', pointRate: 3, freeShipping: false };
  return { name: '„É¨„ÇÆ„É•„É©„Éº', color: '#64748b', pointRate: 1, freeShipping: false };
}

function renderOrderHistory_(orders) {
  var el = $('mpOrderList');
  if (!el) return;
  if (!orders || orders.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">Ê≥®ÊñáÂ±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }
  var html = '';
  for (var i = 0; i < orders.length; i++) {
    var o = orders[i];
    var statusClass = (o.status === 'ÂÆå‰∫Ü') ? 'done' : (o.status === '‰æùÈ†º‰∏≠') ? 'active' : 'pending';
    var trackHtml = '';
    if (o.carrier && o.tracking) {
      trackHtml = '<div style="font-size:11px;color:#888;margin-top:4px;">ÈÖçÈÄÅ: ' + escapeHtml_(o.carrier) + ' ' + escapeHtml_(o.tracking) + '</div>';
    }
    html += '<div class="mp-order-card">'
      + '<div class="mp-order-header">'
      + '<span class="mp-order-no">' + escapeHtml_(o.receiptNo) + '</span>'
      + '<span class="mp-order-date">' + escapeHtml_(o.date) + '</span>'
      + '<span class="mp-order-status ' + statusClass + '">' + escapeHtml_(o.status) + '</span>'
      + '</div>'
      + '<div class="mp-order-products">' + escapeHtml_(o.products) + '</div>'
      + '<div class="mp-order-footer">'
      + '<span>' + o.count + 'ÁÇπ</span>'
      + '<span class="mp-order-total">' + yen(o.total) + '</span>'
      + '</div>'
      + trackHtml
      + '</div>';
  }
  el.innerHTML = html;
}

function doLogout_() {
  var sessionId = state.sessionId;
  clearSession_();
  updateAuthUi_();
  updateCartPrice();
  if ($('cartModal').classList.contains('open')) renderCartModal_();
  showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');

  if (sessionId) {
    runApi('apiLogoutCustomer', state.userKey, { sessionId: sessionId }).catch(function() {});
  }
}

function validateSession_() {
  var saved = loadSession_();
  if (!saved || !saved.sessionId) return;

  runApi('apiValidateSession', state.userKey, { sessionId: saved.sessionId })
    .then(function(res) {
      if (res.ok && res.data && res.data.customer) {
        state.sessionId = saved.sessionId;
        state.customer = res.data.customer;
        fetchCsrfToken_();
        updateAuthUi_();
        updateCartPrice();
      } else {
        clearSession_();
      }
    })
    .catch(function() {
      // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÊôÇ„ÅØ‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„Çí‰∏ÄÊó¶‰ΩøÁî®
      state.sessionId = saved.sessionId;
      state.customer = saved.customer;
      updateAuthUi_();
    });
}

function setupAuthUi_() {
  // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
  var openAuthBtn = $('openAuthBtn');
  if (openAuthBtn) {
    openAuthBtn.addEventListener('click', function() {
      openAuthModal_('login');
    });
  }

  // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
  var authCloseBtn = $('authCloseBtn');
  if (authCloseBtn) {
    authCloseBtn.addEventListener('click', function() {
      closeModal($('authModal'));
    });
  }

  // ÂïÜÂìÅ„Ç¨„Ç§„Éâ„É¢„Éº„ÉÄ„É´
  var openGuideLink = $('openGuideLink');
  if (openGuideLink) {
    openGuideLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('guideModal'));
    });
  }
  var guideCloseBtn = $('guideCloseBtn');
  if (guideCloseBtn) {
    guideCloseBtn.addEventListener('click', function() {
      closeModal($('guideModal'));
    });
  }

  // ÈÄÅÊñôË°®„É¢„Éº„ÉÄ„É´
  var openShippingLink = $('openShippingLink');
  if (openShippingLink) {
    openShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('shippingModal'));
    });
  }
  var shippingCloseBtn = $('shippingCloseBtn');
  if (shippingCloseBtn) {
    shippingCloseBtn.addEventListener('click', function() {
      closeModal($('shippingModal'));
    });
  }

  // ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„É¢„Éº„ÉÄ„É´
  var openLegalLink = $('openLegalLink');
  if (openLegalLink) {
    openLegalLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('legalModal'));
    });
  }
  var legalCloseBtn = $('legalCloseBtn');
  if (legalCloseBtn) {
    legalCloseBtn.addEventListener('click', function() {
      closeModal($('legalModal'));
    });
  }
  var legalShippingLink = $('legalShippingLink');
  if (legalShippingLink) {
    legalShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      closeModal($('legalModal'));
      openModal($('shippingModal'));
    });
  }

  // „ÅäÂïè„ÅÑÂêà„Çè„Åõ„É¢„Éº„ÉÄ„É´
  var openContactLink = $('openContactLink');
  if (openContactLink) {
    openContactLink.addEventListener('click', function(e) {
      e.preventDefault();
      // „É≠„Ç∞„Ç§„É≥‰∏≠„Å™„ÇâÂêçÂâç„Éª„É°„Éº„É´„ÇíËá™ÂãïÂÖ•Âäõ
      if (state.customer) {
        $('contactName').value = state.customer.companyName || '';
        $('contactEmail').value = state.customer.email || '';
      }
      openModal($('contactModal'));
    });
  }
  var contactCloseBtn = $('contactCloseBtn');
  if (contactCloseBtn) {
    contactCloseBtn.addEventListener('click', function() {
      closeModal($('contactModal'));
    });
  }
  var contactSubmitBtn = $('contactSubmitBtn');
  if (contactSubmitBtn) {
    contactSubmitBtn.addEventListener('click', function() {
      var name = ($('contactName').value || '').trim();
      var email = ($('contactEmail').value || '').trim();
      var message = ($('contactMessage').value || '').trim();
      if (!name) { showToast('„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (!message) { showToast('„ÅäÂïè„ÅÑÂêà„Çè„ÅõÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      contactSubmitBtn.disabled = true;
      contactSubmitBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
      runApi('apiSendContactForm', { name: name, email: email, message: message })
        .then(function(res) {
          if (res && res.ok) {
            closeModal($('contactModal'));
            $('contactName').value = '';
            $('contactEmail').value = '';
            $('contactMessage').value = '';
            showToast('„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
          } else {
            showToast((res && res.message) || 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        })
        .catch(function(e) { showToast(e.message || 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); })
        .finally(function() { contactSubmitBtn.disabled = false; contactSubmitBtn.textContent = 'ÈÄÅ‰ø°'; });
    });
  }


  // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
  var loginBtn = $('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', doLogin_);
  }

  // ÁôªÈå≤„Éú„Çø„É≥
  var registerBtn = $('registerBtn');
  if (registerBtn) {
    registerBtn.addEventListener('click', doRegister_);
  }

  // „Éï„Ç©„Éº„É†Âàá„ÇäÊõø„Åà
  var showRegisterLink = $('showRegisterLink');
  if (showRegisterLink) {
    showRegisterLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  var showLoginLink = $('showLoginLink');
  if (showLoginLink) {
    showLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ
  var showForgotPasswordLink = $('showForgotPasswordLink');
  if (showForgotPasswordLink) {
    showForgotPasswordLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('forgotPassword');
    });
  }

  // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂøò„Çå„ÅüÊñπ
  var showForgotEmailLink = $('showForgotEmailLink');
  if (showForgotEmailLink) {
    showForgotEmailLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('forgotEmail');
    });
  }

  // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÈÄÅ‰ø°
  var resetPasswordBtn = $('resetPasswordBtn');
  if (resetPasswordBtn) {
    resetPasswordBtn.addEventListener('click', function() {
      var email = ($('resetEmail').value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      resetPasswordBtn.disabled = true;
      resetPasswordBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
      runApi('apiRequestPasswordReset', state.userKey || '', { email: email })
        .then(function(res) {
          if (res && res.ok) {
            showToast(res.message || '‰ªÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
            $('resetEmail').value = '';
            // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Åô
            setTimeout(function() { openAuthModal_('login'); }, 2000);
          } else {
            showToast((res && res.message) || 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        })
        .catch(function(e) { showToast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); })
        .finally(function() {
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = '‰ªÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÈÄÅ‰ø°';
        });
    });
  }

  // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà‚Üí„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã
  var backToLoginFromReset = $('backToLoginFromReset');
  if (backToLoginFromReset) {
    backToLoginFromReset.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÁ¢∫Ë™çÈÄÅ‰ø°
  var recoverEmailBtn = $('recoverEmailBtn');
  if (recoverEmailBtn) {
    recoverEmailBtn.addEventListener('click', function() {
      var companyName = ($('recoverCompanyName').value || '').trim();
      var phone = ($('recoverPhone').value || '').trim();
      if (!companyName) { showToast('‰ºöÁ§æÂêç/Ê∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (!phone) { showToast('ÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      recoverEmailBtn.disabled = true;
      recoverEmailBtn.textContent = 'Á¢∫Ë™ç‰∏≠...';
      var resultDiv = $('recoverEmailResult');
      resultDiv.style.display = 'none';
      runApi('apiRecoverEmail', state.userKey || '', { companyName: companyName, phone: phone })
        .then(function(res) {
          if (res && res.ok && res.data && res.data.maskedEmail) {
            resultDiv.innerHTML = '„ÅîÁôªÈå≤„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ:<br><strong style="font-size:16px;">' + escapeHtml_(res.data.maskedEmail) + '</strong>';
            resultDiv.style.display = 'block';
          } else {
            showToast((res && res.message) || '‰∏ÄËá¥„Åô„ÇãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
          }
        })
        .catch(function(e) { showToast('Á¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); })
        .finally(function() {
          recoverEmailBtn.disabled = false;
          recoverEmailBtn.textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç';
        });
    });
  }

  // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÁ¢∫Ë™ç‚Üí„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã
  var backToLoginFromRecover = $('backToLoginFromRecover');
  if (backToLoginFromRecover) {
    backToLoginFromRecover.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // „Éó„É≠„É¢„Éê„Éä„ÉºÔºö√ó„Éú„Çø„É≥
  var promoClose = $('promoClose');
  if (promoClose) {
    promoClose.addEventListener('click', function() {
      var b = $('promoBanner');
      if (b) b.style.display = 'none';
      try { sessionStorage.setItem('promoBannerDismissed', '1'); } catch (e) {}
    });
  }

  // „Éó„É≠„É¢„Éê„Éä„ÉºÔºöÁôªÈå≤„É™„É≥„ÇØ
  var promoLink = $('promoRegisterLink');
  if (promoLink) {
    promoLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  // =====================================================
  // „Éë„Çπ„ÉØ„Éº„ÉâË°®Á§∫/ÈùûË°®Á§∫„Éà„Ç∞„É´
  // =====================================================
  document.querySelectorAll('.pw-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var target = $(btn.getAttribute('data-target'));
      if (!target) return;
      if (target.type === 'password') {
        target.type = 'text';
        btn.classList.add('active');
      } else {
        target.type = 'password';
        btn.classList.remove('active');
      }
    });
  });

  // =====================================================
  // „Éù„Ç§„É≥„ÉàÂà©Áî®Ôºà„ÅäÂ±ä„ÅëÂÖà„Éï„Ç©„Éº„É†Ôºâ
  // =====================================================
  var usePointsInput = $('usePoints');
  if (usePointsInput) {
    usePointsInput.addEventListener('input', function() {
      updatePointDiscountInfo_();
    });
  }
  var useAllPointsBtn = $('useAllPointsBtn');
  if (useAllPointsBtn) {
    useAllPointsBtn.addEventListener('click', function() {
      var max = (state.customer && state.customer.points) ? state.customer.points : 0;
      $('usePoints').value = max;
      updatePointDiscountInfo_();
    });
  }
  var applyPointsBtn = $('applyPointsBtn');
  if (applyPointsBtn) {
    applyPointsBtn.addEventListener('click', applyPointDiscount_);
  }

  // =====================================================
  // „Éû„Ç§„Éö„Éº„Ç∏„É¢„Éº„ÉÄ„É´
  // =====================================================
  var myPageCloseBtn = $('myPageCloseBtn');
  if (myPageCloseBtn) {
    myPageCloseBtn.addEventListener('click', function() { closeModal($('myPageModal')); });
  }

  // „Çø„ÉñÂàá„ÇäÊõø„Åà
  var tabs = document.querySelectorAll('.mypage-tab');
  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      tabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      var target = tab.getAttribute('data-tab');
      $('mypageProfile').style.display = (target === 'profile') ? '' : 'none';
      $('mypageOrders').style.display = (target === 'orders') ? '' : 'none';
      $('mypagePoints').style.display = (target === 'points') ? '' : 'none';
    });
  });

  // Á∑®ÈõÜ„Éú„Çø„É≥ÔºöreadonlyËß£Èô§Ôºã‰øùÂ≠ò/„Ç≠„É£„É≥„Çª„É´Ë°®Á§∫
  var mpEditBtn = $('mpEditBtn');
  var mpCancelEditBtn = $('mpCancelEditBtn');
  var mpProfileFields = ['mpCompanyName', 'mpPhone', 'mpPostal', 'mpAddress'];
  function setProfileEditable_(editable) {
    for (var fi = 0; fi < mpProfileFields.length; fi++) {
      var inp = $(mpProfileFields[fi]);
      if (inp) { inp.readOnly = !editable; inp.style.background = editable ? '#fff' : '#f5f5f5'; }
    }
    if ($('mpEditBtn')) $('mpEditBtn').style.display = editable ? 'none' : '';
    if ($('mpSaveBtn')) $('mpSaveBtn').style.display = editable ? '' : 'none';
    if ($('mpCancelEditBtn')) $('mpCancelEditBtn').style.display = editable ? '' : 'none';
  }
  if (mpEditBtn) {
    mpEditBtn.addEventListener('click', function() {
      // Á∑®ÈõÜÂâç„ÅÆÂÄ§„Çí‰øùÂ≠ò
      mpEditBtn._backup = {};
      for (var fi = 0; fi < mpProfileFields.length; fi++) {
        mpEditBtn._backup[mpProfileFields[fi]] = $(mpProfileFields[fi]).value;
      }
      setProfileEditable_(true);
    });
  }
  if (mpCancelEditBtn) {
    mpCancelEditBtn.addEventListener('click', function() {
      // Á∑®ÈõÜÂâç„ÅÆÂÄ§„Å´Êàª„Åô
      if (mpEditBtn && mpEditBtn._backup) {
        for (var fi = 0; fi < mpProfileFields.length; fi++) {
          $(mpProfileFields[fi]).value = mpEditBtn._backup[mpProfileFields[fi]] || '';
        }
      }
      setProfileEditable_(false);
    });
  }

  // „Éó„É≠„Éï„Ç£„Éº„É´‰øùÂ≠ò
  var mpSaveBtn = $('mpSaveBtn');
  if (mpSaveBtn) {
    mpSaveBtn.addEventListener('click', function() {
      var pw = prompt('Êú¨‰∫∫Á¢∫Ë™ç„ÅÆ„Åü„ÇÅÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (!pw) return;
      mpSaveBtn.disabled = true;
      mpSaveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
      runApi('apiUpdateCustomerProfile', state.userKey || '', {
        sessionId: state.sessionId,
        currentPassword: pw,
        companyName: $('mpCompanyName').value,
        phone: $('mpPhone').value,
        postal: $('mpPostal').value,
        address: $('mpAddress').value
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || 'Êõ¥Êñ∞„Åó„Åæ„Åó„Åü');
          if (state.customer) {
            state.customer.companyName = $('mpCompanyName').value;
            state.customer.phone = $('mpPhone').value;
            state.customer.postal = $('mpPostal').value;
            state.customer.address = $('mpAddress').value;
            saveSession_(state.sessionId, state.customer);
            updateAuthUi_();
          }
          setProfileEditable_(false);
        } else {
          showToast((res && res.message) || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      }).catch(function() { showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); })
        .finally(function() { mpSaveBtn.disabled = false; mpSaveBtn.textContent = 'Â§âÊõ¥„Çí‰øùÂ≠ò'; });
    });
  }

  // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Éà„Ç∞„É´
  var mpTogglePasswordBtn = $('mpTogglePasswordBtn');
  if (mpTogglePasswordBtn) {
    mpTogglePasswordBtn.addEventListener('click', function() {
      var section = $('mpPasswordSection');
      section.style.display = section.style.display === 'none' ? '' : 'none';
    });
  }

  // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÂÆüË°å
  var mpChangePassBtn = $('mpChangePassBtn');
  if (mpChangePassBtn) {
    mpChangePassBtn.addEventListener('click', function() {
      var cur = $('mpCurPass').value;
      var np = $('mpNewPass').value;
      var npc = $('mpNewPassConfirm').value;
      if (!cur) { showToast('ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (!np || np.length < 6) { showToast('Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (np !== npc) { showToast('Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì'); return; }
      mpChangePassBtn.disabled = true;
      mpChangePassBtn.textContent = 'Â§âÊõ¥‰∏≠...';
      runApi('apiChangePassword', state.userKey || '', {
        sessionId: state.sessionId,
        currentPassword: cur,
        newPassword: np
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
          $('mpCurPass').value = '';
          $('mpNewPass').value = '';
          $('mpNewPassConfirm').value = '';
          $('mpPasswordSection').style.display = 'none';
        } else {
          showToast((res && res.message) || '„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      }).catch(function() { showToast('„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); })
        .finally(function() { mpChangePassBtn.disabled = false; mpChangePassBtn.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥'; });
    });
  }
}

function setSending_(on, text) {
  var ov = $('sendingOverlay');
  var tx = $('sendingText');
  if (tx) tx.textContent = String(text || '‰æùÈ†ºÈÄÅ‰ø°‰∏≠...');
  if (!ov) return;
  if (on) { ov.classList.add('on'); document.body.style.overflow = 'hidden'; }
  else { ov.classList.remove('on'); document.body.style.overflow = ''; }
}

function loadUserKey() {
  var k = localStorage.getItem('estimate_userKey');
  if (k) return k;
  var nk = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem('estimate_userKey', nk);
  return nk;
}

function loadCartStorage() {
  try {
    var raw = localStorage.getItem('estimate_cart_v2');
    if (!raw) return { ids: [], itemsById: {} };
    var j = JSON.parse(raw);
    return { ids: Array.isArray(j.ids) ? j.ids : [], itemsById: j.itemsById || {} };
  } catch (e) { return { ids: [], itemsById: {} }; }
}

function saveCartStorage() {
  try { localStorage.setItem('estimate_cart_v2', JSON.stringify({ ids: state.cart.ids || [], itemsById: state.cart.itemsById || {} })); } catch (e) {}
}

function openModal(modal) { $('overlay').classList.add('open'); modal.classList.add('open'); }
function closeModal(modal) { modal.classList.remove('open'); if (!document.querySelector('.modal.open')) $('overlay').classList.remove('open'); }
function closeAllModals() { document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); }); $('overlay').classList.remove('open'); }

function convertDriveImageUrl(url, maxWidth) {
  if (!url) return '';
  var m = url.match(/(?:id=|\/d\/)([A-Za-z0-9_-]{10,})/);
  if (m && m[1]) {
    var base = 'https://lh3.googleusercontent.com/d/' + m[1];
    if (maxWidth) return base + '=w' + maxWidth;
    return base;
  }
  return url;
}

function normalizeStatus_(s) { return String(s || '').trim(); }
function statusKind_(s) {
  var t = normalizeStatus_(s);
  if (!t) return 'available';
  if (t.indexOf('‰æùÈ†º‰∏≠') !== -1) return 'open';
  if (t.indexOf('Á¢∫‰øù‰∏≠') !== -1) return 'hold';
  if (t.indexOf('Âú®Â∫´') !== -1) return 'available';
  return 'available';
}

function getMeasureOptValue_() { return 'with'; }
function setMeasureOptValue_(v) {}
function loadMeasureOpt_() { return 'with'; }
function saveMeasureOpt_() {}

// =====================================================
// GAS APIÂëº„Å≥Âá∫„ÅóÔºàGAS„É¢„Éº„Éâ / „Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥„É¢„Éº„ÉâËá™ÂãïÂà§ÂÆöÔºâ
// =====================================================

// ‚òÖ „Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥ÔºàCloudflare PagesÁ≠âÔºâ„Åß‰Ωø„ÅÜÂ†¥Âêà„ÅØ„Åì„Åì„Å´GAS Web App URL„ÇíË®≠ÂÆö
var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';

var IS_STANDALONE = (typeof google === 'undefined' || !google.script);

// reCAPTCHA v3 „Çµ„Ç§„Éà„Ç≠„ÉºÔºà‚òÖ Google reCAPTCHAÁÆ°ÁêÜÁîªÈù¢„ÅßÂèñÂæó„Åó„Å¶Ë®≠ÂÆöÔºâ
var RECAPTCHA_SITE_KEY = '6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1';
var ADMIN_KEY = (new URLSearchParams(window.location.search)).get('admin') || '';
// „Ç™„Éº„Éä„ÉºË≠òÂà•: ?admin=KEY „Åß„Ç¢„ÇØ„Çª„Çπ„Åó„ÅüÁ´ØÊú´„ÇíË®òÊÜ∂„Åó„ÄÅ‰ª•Èôç„ÅÆPV„É≠„Ç∞„ÇíÈô§Â§ñ
var IS_OWNER = false;
if (ADMIN_KEY) {
  try { localStorage.setItem('_nk_owner_key', ADMIN_KEY); } catch(e) {}
  IS_OWNER = true;
} else {
  try { IS_OWNER = !!localStorage.getItem('_nk_owner_key'); } catch(e) {}
}

function getRecaptchaToken_() {
  if (typeof grecaptcha === 'undefined' || !RECAPTCHA_SITE_KEY || RECAPTCHA_SITE_KEY.indexOf('RECAPTCHA') !== -1) {
    console.warn('reCAPTCHA not available: grecaptcha=' + (typeof grecaptcha) + ' siteKey=' + !!RECAPTCHA_SITE_KEY);
    return Promise.resolve('');
  }
  try {
    return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }).catch(function(e) {
      console.warn('reCAPTCHA execute failed:', e);
      return '';
    });
  } catch (e) {
    console.warn('reCAPTCHA execute error:', e);
    return Promise.resolve('');
  }
}

function runApi(fn, _extra) {
  var args = Array.prototype.slice.call(arguments, 1);
  var extra = {};
  // ÊúÄÂæå„ÅÆÂºïÊï∞„Åå _runApiExtra_ „Å™„ÇâÂèñ„ÇäÂá∫„Åô
  if (args.length > 0 && args[args.length - 1] && args[args.length - 1]._runApiExtra_) {
    extra = args.pop();
  }

  if (IS_STANDALONE) {
    var payload = { action: fn, args: args };
    if ('recaptchaToken' in extra) payload.recaptchaToken = extra.recaptchaToken;
    if (ADMIN_KEY) payload.adminKey = ADMIN_KEY;
    if (state.csrfToken) payload.csrfToken = state.csrfToken;
    return fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      if (data && data.ok === false) throw new Error(data.message || 'API„Ç®„É©„Éº');
      return data;
    });
  }

  return new Promise(function(resolve, reject) {
    var done = false;
    var timer = setTimeout(function() {
      if (done) return;
      done = true;
      reject(new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà'));
    }, 30000);

    try {
      var runner = google.script.run
        .withSuccessHandler(function(res) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve(res);
        })
        .withFailureHandler(function(err) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          reject(err);
        });

      runner[fn].apply(runner, args);
    } catch (e) {
      if (done) return;
      done = true;
      clearTimeout(timer);
      reject(e);
    }
  });
}

// =====================================================
// „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºà„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÈ´òÈÄüÂèñÂæóÔºâ
// =====================================================

var PRODUCT_CACHE_KEY = 'estimate_products_cache';
var PRODUCT_CACHE_TTL = 5 * 60 * 1000; // 5ÂàÜ

function saveProductCache_(data) {
  try {
    var cache = { ts: Date.now(), data: data };
    localStorage.setItem(PRODUCT_CACHE_KEY, JSON.stringify(cache));
  } catch (e) { console.warn('„Ç≠„É£„ÉÉ„Ç∑„É•‰øùÂ≠òÂ§±Êïó:', e); }
}

function loadProductCache_() {
  try {
    var raw = localStorage.getItem(PRODUCT_CACHE_KEY);
    if (!raw) return null;
    var cache = JSON.parse(raw);
    // 5ÂàÜ‰ª•ÂÜÖ„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Å™„Çâ‰ΩøÁî®
    if (cache && cache.ts && (Date.now() - cache.ts < PRODUCT_CACHE_TTL) && cache.data) {
      return cache.data;
    }
    return cache && cache.data ? { data: cache.data, stale: true } : null;
  } catch (e) { return null; }
}

function loadProductData() {
  if (IS_STANDALONE) {
    return runApi('apiGetCachedProducts').then(function(res) {
      if (res && res.ok && res.data) {
        console.log('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', res.data.totalCount + '‰ª∂');
        saveProductCache_(res.data);
        return res.data;
      }
      throw new Error(res && res.message ? res.message : '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó');
    });
  }

  return new Promise(function(resolve, reject) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res && res.ok && res.data) {
          console.log('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', res.data.totalCount + '‰ª∂');
          saveProductCache_(res.data);
          resolve(res.data);
        } else {
          reject(new Error(res && res.message ? res.message : '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó'));
        }
      })
      .withFailureHandler(function(err) {
        reject(err);
      })
      .apiGetCachedProducts();
  });
}

// =====================================================
// „Éï„Ç£„É´„Çø„Éª„ÇΩ„Éº„ÉàÔºà„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„ÅßÂç≥ÊôÇÂá¶ÁêÜÔºâ
// =====================================================

function applyFilters_() {
  var f = state.query.filters;
  var products = state.allProducts.slice();

  if (f.brand && f.brand.length > 0) {
    products = products.filter(function(p) {
      var normalizedBrand = normalizeBrand_(p.brand);
      return f.brand.indexOf(normalizedBrand) !== -1;
    });
  }
  if (f.category && f.category.length > 0) {
    products = products.filter(function(p) { return f.category.indexOf(p.category) !== -1; });
  }
  if (f.state && f.state.length > 0) {
    products = products.filter(function(p) { return f.state.indexOf(p.state) !== -1; });
  }
  if (f.gender && f.gender.length > 0) {
    products = products.filter(function(p) { return f.gender.indexOf(p.gender) !== -1; });
  }
  if (f.size && f.size.length > 0) {
    products = products.filter(function(p) { return f.size.indexOf(p.size) !== -1; });
  }

  return products;
}

function applySort_(products) {
  var s = state.query.sort;
  var sorted = products.slice();
  
  if (s.key === 'default') return s.dir === 'desc' ? sorted.reverse() : sorted;
  
  sorted.sort(function(a, b) {
    var va, vb;
    switch (s.key) {
      case 'price': va = Number(a.price) || 0; vb = Number(b.price) || 0; break;
      case 'brand': va = String(a.brand || ''); vb = String(b.brand || ''); break;
      case 'category': va = String(a.category || ''); vb = String(b.category || ''); break;
      default: return 0;
    }
    if (typeof va === 'string') {
      var cmp = va.localeCompare(vb, 'ja');
      return s.dir === 'desc' ? -cmp : cmp;
    }
    return s.dir === 'desc' ? (vb - va) : (va - vb);
  });
  
  return sorted;
}

function filterAndRender(scrollTop) {
  var filtered = applyFilters_();
  filtered = applySort_(filtered);
  state.filteredProducts = filtered;
  
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var totalPages = Math.ceil(filtered.length / pageSize) || 1;
  
  if (page > totalPages) { page = totalPages; state.query.page = page; }
  
  var start = (page - 1) * pageSize;
  var pageItems = filtered.slice(start, start + pageSize);
  
  updateTotalCountBadge_(filtered.length);
  renderGrid_(pageItems);
  renderPager_(totalPages, page);
  
  if (scrollTop) window.scrollTo({ top: 0, behavior: 'auto' });
  
  pollStatusNow_();
}

// =====================================================
// Á¢∫‰øùÁä∂ÊÖã„É™„Ç¢„É´„Çø„Ç§„É†ÂèñÂæó
// =====================================================

function pollStatusNow_() {
  if (state.timers.statusPoll) { clearTimeout(state.timers.statusPoll); state.timers.statusPoll = null; }
  
  var ids = [];
  var pageItems = getCurrentPageItems_();
  for (var i = 0; i < pageItems.length; i++) {
    if (pageItems[i] && pageItems[i].managedId) ids.push(pageItems[i].managedId);
  }
  for (var j = 0; j < state.cart.ids.length; j++) {
    if (ids.indexOf(state.cart.ids[j]) === -1) ids.push(state.cart.ids[j]);
  }
  
  if (ids.length === 0) return;
  
  runApi('apiGetStatusDigest', state.userKey, ids)
    .then(function(res) {
      if (res && res.ok && res.map) {
        state.cart.digest = res.map;
        for (var id in state.ui.cardEls) updateCardUi_(id);
      }
    })
    .catch(function(e) { console.log('„Çπ„ÉÜ„Éº„Çø„ÇπÂèñÂæó„Ç®„É©„Éº:', e); });
  
  state.timers.statusPoll = setTimeout(pollStatusNow_, 10000);
}

function getCurrentPageItems_() {
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var start = (page - 1) * pageSize;
  return state.filteredProducts.slice(start, start + pageSize);
}

// =====================================================
// Ë°®Á§∫Á≥ª
// =====================================================

function updateTotalCountBadge_(total) {
  var el = $('totalCountBadge');
  if (el) el.textContent = total ? ('ÂïÜÂìÅÁÇπÊï∞Ôºö' + total + 'ÁÇπ') : '';
}

function renderLoadingGrid_() {
  var g = $('grid'); g.innerHTML = '';
  for (var i = 0; i < 8; i++) {
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'LOADING';
    var body = document.createElement('div'); body.className = 'cardbody';
    var line = document.createElement('div'); line.className = 'meta'; line.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
    body.appendChild(line); card.appendChild(thumb); card.appendChild(body); g.appendChild(card);
  }
}

function setSelectOptions(select, list, placeholder) {
  select.innerHTML = '';
  var op0 = document.createElement('option'); op0.value = ''; op0.textContent = placeholder; select.appendChild(op0);
  for (var i = 0; i < list.length; i++) {
    var op = document.createElement('option'); op.value = String(list[i]); op.textContent = String(list[i]); select.appendChild(op);
  }
}

// „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº
var multiSelectState = { category: [], state: [], gender: [], size: [] };

function buildMultiSelectDropdown(filterKey, options) {
  var dropdown = $('f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Dropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var val = String(options[i]);
    var item = document.createElement('div');
    item.className = 'multiSelectItem';
    item.dataset.value = val;
    if (multiSelectState[filterKey].indexOf(val) !== -1) item.classList.add('selected');

    var checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    var span = document.createElement('span');
    span.textContent = val;

    item.appendChild(checkIcon);
    item.appendChild(span);

    item.addEventListener('click', (function(key, v, el) {
      return function(e) {
        e.stopPropagation();
        var isSelected = el.classList.contains('selected');
        if (isSelected) {
          el.classList.remove('selected');
          var idx = multiSelectState[key].indexOf(v);
          if (idx !== -1) multiSelectState[key].splice(idx, 1);
        } else {
          el.classList.add('selected');
          if (multiSelectState[key].indexOf(v) === -1) multiSelectState[key].push(v);
        }
        state.query.filters[key] = multiSelectState[key].slice();
        updateMultiSelectBtn(key);
        filterAndRender(true);
      };
    })(filterKey, val, item));
    dropdown.appendChild(item);
  }
}

function updateMultiSelectBtn(filterKey) {
  var btnId = 'f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Btn';
  var btn = $(btnId);
  if (!btn) return;
  var count = multiSelectState[filterKey].length;
  var countSpan = btn.querySelector('.filterCount');
  if (countSpan) countSpan.textContent = count > 0 ? count : '';
  btn.classList.toggle('active', count > 0);
}

function setupMultiSelectFilters() {
  var filters = ['category', 'state', 'gender', 'size'];
  var labels = { category: '„Ç´„ÉÜ„Ç¥„É™', state: 'Áä∂ÊÖã', gender: 'ÊÄßÂà•', size: '„Çµ„Ç§„Ç∫' };

  filters.forEach(function(key) {
    var btnId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Btn';
    var dropdownId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown';
    var btn = $(btnId);
    var dropdown = $(dropdownId);
    if (!btn || !dropdown) return;

    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      // ‰ªñ„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        if (d.id !== dropdownId) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
    });
  });

  // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„Åß„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.multiSelectField')) {
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        d.classList.remove('open');
      });
    }
  });
}

function resetMultiSelectFilters() {
  multiSelectState = { category: [], state: [], gender: [], size: [] };
  state.query.filters.category = [];
  state.query.filters.state = [];
  state.query.filters.gender = [];
  state.query.filters.size = [];
  ['category', 'state', 'gender', 'size'].forEach(function(key) {
    updateMultiSelectBtn(key);
    var dropdown = $('f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown');
    if (dropdown) {
      dropdown.querySelectorAll('.multiSelectItem').forEach(function(item) {
        item.classList.remove('selected');
      });
    }
  });
}

function setSortOptions(sortDefs) {
  var dropdown = $('sortDropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < sortDefs.length; i++) {
    var s = sortDefs[i];
    var item = document.createElement('div');
    item.className = 'sort-item' + (s.key === state.query.sort.key ? ' selected' : '');
    item.dataset.key = s.key;
    item.dataset.label = s.label;
    item.textContent = s.label;
    item.addEventListener('click', (function(key) {
      return function() {
        state.query.sort.key = key;
        updateSortChip_();
        dropdown.classList.remove('open');
        state.query.page = 1;
        filterAndRender(true);
      };
    })(s.key));
    dropdown.appendChild(item);
  }
  updateSortChip_();
}

function updateSortChip_() {
  var btn = $('sortChipBtn');
  var label = $('sortChipLabel');
  var dropdown = $('sortDropdown');
  if (!btn || !label) return;
  var items = dropdown ? dropdown.querySelectorAll('.sort-item') : [];
  var activeLabel = 'Ê®ôÊ∫ñ';
  for (var i = 0; i < items.length; i++) {
    if (items[i].dataset.key === state.query.sort.key) {
      items[i].classList.add('selected');
      activeLabel = items[i].dataset.label;
    } else {
      items[i].classList.remove('selected');
    }
  }
  label.textContent = activeLabel;
  btn.classList.toggle('active', state.query.sort.key !== 'default');
}

function setStatusBadge_(el, status) {
  if (!el) return;
  var t = normalizeStatus_(status);
  var k = statusKind_(t);
  el.className = 'badge';
  if (k === 'available') el.className = 'badge ok';
  else if (k === 'open') el.className = 'badge lock';
  else if (k === 'hold') el.className = 'badge warn';
  el.textContent = t || '';
}

function effectiveStatusFor_(id, selected, itemStatus) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  var ds = d && d.status ? normalizeStatus_(d.status) : '';
  if (selected) {
    if (d) {
      var k = statusKind_(ds);
      if (k === 'open') return ds || '‰æùÈ†º‰∏≠';
      if (k === 'hold' && d.heldByOther) return ds || 'Á¢∫‰øù‰∏≠';
    }
    return 'Á¢∫‰øù‰∏≠';
  }
  return ds || normalizeStatus_(itemStatus);
}

function effectiveHeldByOtherFor_(id) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  return !!(d && d.heldByOther);
}

function computeDisabledForCard_(it, id) {
  var selected = state.cart.ids.indexOf(id) !== -1;
  var effectiveStatus = effectiveStatusFor_(id, selected, it.status);
  var effectiveHeldByOther = effectiveHeldByOtherFor_(id);
  var disabled = (!it.selectable) || (statusKind_(effectiveStatus) === 'open') || (statusKind_(effectiveStatus) === 'hold' && effectiveHeldByOther);
  return { selected: selected, effectiveStatus: effectiveStatus, effectiveHeldByOther: effectiveHeldByOther, disabled: disabled };
}

function applyBtnUi_(btn, it, id) {
  if (!btn || !it) return;
  var r = computeDisabledForCard_(it, id);
  if (r.disabled) {
    btn.className = 'selectBtn disabled'; btn.disabled = true;
    btn.textContent = statusKind_(r.effectiveStatus) === 'open' ? '‰æùÈ†º‰∏≠ÔºàÈÅ∏Êäû‰∏çÂèØÔºâ' : 'Á¢∫‰øù‰∏≠ÔºàÈÅ∏Êäû‰∏çÂèØÔºâ';
    return;
  }
  if (r.selected) { btn.className = 'selectBtn'; btn.disabled = false; btn.textContent = 'ÈÅ∏Êäû‰∏≠ÔºàËß£Èô§Ôºâ'; return; }
  btn.className = 'selectBtn off'; btn.disabled = false; btn.textContent = '„Ç´„Éº„Éà„Å∏ËøΩÂä†';
}

function updateCardUi_(id) {
  var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
  if (!rec) return;
  var it = rec.item;
  if (!it) return;
  var r = computeDisabledForCard_(it, id);
  if (rec.bStatus) setStatusBadge_(rec.bStatus, r.effectiveStatus);
  if (rec.btn) applyBtnUi_(rec.btn, it, id);
}

function upsertCartItem_(it) {
  if (!it || !it.managedId) return;
  state.cart.itemsById[it.managedId] = {
    managedId: it.managedId, noLabel: it.noLabel, imageUrl: it.imageUrl, brand: it.brand,
    size: it.size, gender: it.gender, category: it.category, color: it.color, state: it.state,
    price: Number(it.price || 0), measurements: it.measurements || {}, defectDetail: it.defectDetail || '',
    shippingMethod: it.shippingMethod || ''
  };
}

function renderGrid_(items) {
  var g = $('grid'); g.innerHTML = ''; state.ui.cardEls = {};
  
  if (!items || items.length === 0) {
    var msg = document.createElement('div'); msg.textContent = 'Ë©≤ÂΩì„Åô„ÇãÂïÜÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'; msg.style.padding = '12px'; g.appendChild(msg); return;
  }
  
  var frag = document.createDocumentFragment();
  
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    if (!it) continue;
    upsertCartItem_(it);
    var id = it.managedId;
    var r = computeDisabledForCard_(it, id);
    
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb';
    var imgEl = null;
    
    if (it.imageUrl) {
      var img = document.createElement('img');
      var fixedUrl = convertDriveImageUrl(it.imageUrl, 300);
      var fullUrl = convertDriveImageUrl(it.imageUrl);
      img.src = fixedUrl; img.alt = it.noLabel || id; img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
      img.className = 'product-image-clickable'; img.style.cursor = 'zoom-in';
      (function(mid, iurl, thumbUrl) {
        img.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); });
        img.addEventListener('mouseenter', function() { var p = new Image(); p.src = iurl; }, { once: true });
      })(id, fullUrl, fixedUrl);
      imgEl = img; thumb.appendChild(img);
    } else { thumb.textContent = 'NO IMAGE'; }
    card.appendChild(thumb);
    
    var body = document.createElement('div'); body.className = 'cardbody';
    var row1 = document.createElement('div'); row1.className = 'row1';
    var leftTitle = document.createElement('div'); leftTitle.className = 'leftTitle'; leftTitle.style.cursor = 'pointer';
    var spanNo = document.createElement('span'); spanNo.className = 'noText'; spanNo.textContent = it.noLabel ? it.noLabel : ('No. ' + id);
    var spanBrand = document.createElement('div'); spanBrand.className = 'brandText'; spanBrand.textContent = it.brand || '';
    spanBrand.style.cursor = 'pointer';
    leftTitle.appendChild(spanNo);
    (function(mid, iurl, thumbUrl) { leftTitle.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '', it.imageUrl ? convertDriveImageUrl(it.imageUrl, 300) : '');
    (function(mid, iurl, thumbUrl) { spanBrand.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '', it.imageUrl ? convertDriveImageUrl(it.imageUrl, 300) : '');
    var price = document.createElement('div'); price.className = 'price'; price.textContent = yen(it.price);
    row1.appendChild(leftTitle); row1.appendChild(price); body.appendChild(row1);
    if (spanBrand.textContent) body.appendChild(spanBrand);
    
    // ÂÇ∑Ê±ö„ÇåË©≥Á¥∞„ÅÆÊúâÁÑ°„ÇíË°®Á§∫Ôºà„Ç´„Éº„Éâ„ÅÆÈ´ò„Åï„ÇíÊèÉ„Åà„Çã„Åü„ÇÅÂ∏∏„Å´„Çπ„Éö„Éº„Çπ„ÇíÁ¢∫‰øùÔºâ
    var defectLine = document.createElement('div'); defectLine.className = 'defectLine';
    if (it.defectDetail && it.defectDetail.trim()) {
      defectLine.textContent = 'Ë©≥Á¥∞‰∫ãÈ†Ö„ÅÇ„Çä';
      defectLine.classList.add('hasDefect');
    } else {
      defectLine.innerHTML = '&nbsp;'; // Á©∫ÁôΩ„Åß„ÇÇÈ´ò„Åï„ÇíÁ¢∫‰øù
    }
    body.appendChild(defectLine);

    var badges = document.createElement('div'); badges.className = 'badges';
    var bState = document.createElement('div'); bState.className = 'badge'; bState.textContent = it.state || ''; badges.appendChild(bState);
    var bStatus = document.createElement('div'); setStatusBadge_(bStatus, r.effectiveStatus); badges.appendChild(bStatus); body.appendChild(badges);
    
    var btn = document.createElement('button'); btn.type = 'button'; applyBtnUi_(btn, it, id);
    (function(itemRef, idRef) { btn.addEventListener('click', function() { if (computeDisabledForCard_(itemRef, idRef).disabled) return; toggleCartOptimistic_(idRef); }); })(it, id);
    
    var actions = document.createElement('div'); actions.className = 'actions'; actions.appendChild(btn); body.appendChild(actions);
    card.appendChild(body); frag.appendChild(card);
    state.ui.cardEls[id] = { bStatus: bStatus, btn: btn, item: it, img: imgEl };
  }
  
  g.appendChild(frag);
}

function renderPager_(totalPages, currentPage) {
  var p = $('pager'); p.innerHTML = '';
  if (totalPages <= 1) return;
  var maxButtons = 9;
  var start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  var end = Math.min(totalPages, start + maxButtons - 1);
  start = Math.max(1, end - maxButtons + 1);
  for (var i = start; i <= end; i++) {
    var b = document.createElement('button');
    b.className = 'pageBtn' + (i === currentPage ? ' active' : '');
    b.textContent = String(i);
    (function(pn) { b.addEventListener('click', function() { state.query.page = pn; filterAndRender(true); }); })(i);
    p.appendChild(b);
  }
}

// =====================================================
// „Ç´„Éº„Éà
// =====================================================

function updateCartCount() {
  $('cartCount').textContent = String((state.cart.ids || []).length);
  updateCartPrice();
}

function updateCartPrice() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var count = ids.length;
  // Ââ≤Âºï„ÇíÁ¥ØÁ©çÔºà‰ºöÂì°10% + 30ÁÇπ‰ª•‰∏ä10% = ÊúÄÂ§ß20%Ôºâ
  var discountRate = 0;
  if (count >= 30) discountRate += BULK_DISCOUNT_RATE;
  if (state.customer && MEMBER_DISCOUNT_ENABLED) discountRate += MEMBER_DISCOUNT_RATE;
  if (discountRate > 0) {
    var discounted = Math.round(sum * (1 - discountRate));
    $('cartTotal').innerHTML = '<span class="price-old">' + yen(sum) + '</span> ‚Üí <span class="price-new">' + yen(discounted) + '</span>';
  } else { $('cartTotal').textContent = yen(sum); }
}

function toggleCartOptimistic_(id) {
  var idx = state.cart.ids.indexOf(id);
  var adding = (idx === -1);
  if (idx !== -1) { state.cart.ids.splice(idx, 1); } else { state.cart.ids.push(id); }

  // ËøΩÂä†ÊôÇ: itemsById „Å´„Éá„Éº„Çø„Åå„Å™„Åë„Çå„Å∞„Ç´„Éº„Éâ„Åã„ÇâÂæ©ÂÖÉÔºà„Ç´„Éº„Éà„É¢„Éº„ÉÄ„É´ÂâäÈô§Âæå„ÅÆÂÜçËøΩÂä†ÂØæÁ≠ñÔºâ
  if (adding && !state.cart.itemsById[id]) {
    var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
    if (rec && rec.item) upsertCartItem_(rec.item);
  }

  // Á¢∫‰øù„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊ•ΩË¶≥ÁöÑÊõ¥Êñ∞ÔºàAPIÂøúÁ≠î„ÇíÂæÖ„Åü„ÅöÂç≥ÊôÇÂèçÊò†Ôºâ
  if (adding) {
    // ËøΩÂä†ÊôÇ: heldByOther „Çí„ÇØ„É™„Ç¢„Åó„Å¶Ëá™ÂàÜ„ÅÆÁ¢∫‰øù„Å®„Åó„Å¶Êâ±„ÅÜ
    if (state.cart.digest[id]) { state.cart.digest[id].heldByOther = false; }
  } else {
    // ÂâäÈô§ÊôÇ: digest „Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÖÉ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÂú®Â∫´„ÅÇ„ÇäÔºâ„Å´Âç≥ÊôÇÊàª„Åô
    delete state.cart.digest[id];
  }

  state.lastShipping = null; // „Ç´„Éº„ÉàÂ§âÊõ¥ÊôÇ„Å´ÈÄÅÊñô„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁÑ°ÂäπÂåñ
  saveCartStorage(); updateCartCount(); updateCardUi_(id);
  updateShippingDisplay_(); // ÈÄÅÊñô„ÇíÂç≥ÊôÇÂÜçË®àÁÆó

  runApi('apiSyncHolds', state.userKey, state.cart.ids.slice())
    .then(function(res) {
      if (res && res.failed && res.failed.length) {
        for (var i = 0; i < res.failed.length; i++) {
          var fid = res.failed[i].id;
          var j = state.cart.ids.indexOf(fid);
          if (j !== -1) state.cart.ids.splice(j, 1);
          delete state.cart.digest[fid];
          updateCardUi_(fid);
        }
        updateCartCount(); saveCartStorage();
        updateShippingDisplay_(); // Â§±Êïó„Ç¢„Ç§„ÉÜ„É†Èô§Â§ñÂæå„ÇÇÈÄÅÊñôÂÜçË®àÁÆó
        var reasons = res.failed.map(function(f) { return f.reason; }).filter(function(v, i, a) { return a.indexOf(v) === i; });
        showToast(reasons.join('„Éª') + '„ÅÆÂïÜÂìÅ„Åå„ÅÇ„Çä„Åæ„Åô');
      }
    })
    .catch(function(e) { console.log('ÂêåÊúü„Ç®„É©„Éº:', e); });

  pollStatusNow_();
}

// =====================================================
// Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´
// =====================================================

function openDetailModal(managedId, imageUrl, thumbUrl) {
  var modal = document.getElementById('detailModal');
  var body = document.getElementById('detailModalBody');
  if (!modal || !body) return;

  var item = null;
  for (var i = 0; i < state.allProducts.length; i++) {
    if (state.allProducts[i] && state.allProducts[i].managedId === managedId) { item = state.allProducts[i]; break; }
  }
  if (!item) item = state.cart.itemsById ? state.cart.itemsById[managedId] : null;

  if (item) { renderDetailModalLocal(item, imageUrl, thumbUrl); }
  else { body.innerHTML = '<div class="detail-loading">ÂïÜÂìÅÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>'; }

  modal.classList.add('active');
}

function renderDetailModalLocal(item, imageUrl, thumbUrl) {
  var body = document.getElementById('detailModalBody');
  if (!body) return;
  
  var basicItems = [];
  if (item.category) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">„Ç´„ÉÜ„Ç¥„É™:</span> ' + escapeHtml_(item.category) + '</span>');
  if (item.size) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">„Çµ„Ç§„Ç∫:</span> ' + escapeHtml_(item.size) + '</span>');
  if (item.gender) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">ÊÄßÂà•:</span> ' + escapeHtml_(item.gender) + '</span>');
  if (item.color) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">„Ç´„É©„Éº:</span> ' + escapeHtml_(item.color) + '</span>');
  if (item.state) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">Áä∂ÊÖã:</span> ' + escapeHtml_(item.state) + '</span>');
  if (item.price) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">‰æ°Ê†º:</span> ' + yen(item.price) + '</span>');
  
  var basicInfoHtml = basicItems.length > 0 ?
    '<div class="detail-section"><div class="detail-section-title">ÂïÜÂìÅÊÉÖÂ†±</div><div class="detail-info-grid">' + basicItems.join('') + '</div></div>' : '';
  
  var defectHtml = '';
  if (item.defectDetail) {
    var escaped = escapeHtml_(item.defectDetail).replace(/\n/g, '<br>');
    defectHtml = '<div class="detail-section"><div class="detail-section-title">ÂÇ∑„ÉªÊ±ö„ÇåË©≥Á¥∞</div><div class="detail-defect">' + escaped + '</div></div>';
  }
  
  var measurementsHtml = '';
  if (item.measurements && Object.keys(item.measurements).length > 0) {
    var measureOrder = ['ÁùÄ‰∏à', 'ËÇ©ÂπÖ', 'Ë∫´ÂπÖ', 'Ë¢ñ‰∏à', 'Ê°Å‰∏à', 'Á∑è‰∏à', '„Ç¶„Ç®„Çπ„Éà', 'ËÇ°‰∏ä', 'ËÇ°‰∏ã', '„ÉØ„Çø„É™', 'Ë£æÂπÖ', '„Éí„ÉÉ„Éó'];
    var measureItems = [];
    for (var i = 0; i < measureOrder.length; i++) {
      var label = measureOrder[i];
      if (item.measurements[label] !== undefined && item.measurements[label] !== null) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + label + '</div><div class="measurement-value">' + item.measurements[label] + ' cm</div></div>');
      }
    }
    for (var lbl in item.measurements) {
      if (measureOrder.indexOf(lbl) === -1) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + lbl + '</div><div class="measurement-value">' + item.measurements[lbl] + ' cm</div></div>');
      }
    }
    if (measureItems.length > 0) {
      measurementsHtml = '<div class="detail-section"><div class="detail-section-title">Êé°ÂØ∏„Éá„Éº„Çø</div><div class="measurement-grid">' + measureItems.join('') + '</div></div>';
    }
  }
  
  var inCart = state.cart.ids && state.cart.ids.indexOf(item.managedId) !== -1;
  var btnText = inCart ? '‚úì „Ç´„Éº„Éà„Å´ÂÖ•„Å£„Å¶„ÅÑ„Åæ„Åô' : '„Ç´„Éº„Éà„Å´ËøΩÂä†';
  var btnDisabled = inCart ? 'disabled' : '';
  var safeImageUrl = String(imageUrl || '').replace(/"/g, '&quot;');
  var safeThumbUrl = String(thumbUrl || safeImageUrl).replace(/"/g, '&quot;');
  var safeBrand = escapeHtml_(item.brand || '');
  var safeManagedId = escapeHtml_(item.managedId || '');
  var noInfo = (!basicInfoHtml && !defectHtml && !measurementsHtml) ? '<div class="detail-loading" style="color:#999;">ËøΩÂä†ÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>' : '';

  // Show thumbnail immediately (already cached), then swap to full-res
  var initialSrc = safeThumbUrl || safeImageUrl;

  body.innerHTML =
    '<div class="detail-zoom-wrap" id="detailZoomWrap">' +
      '<img class="detail-modal-image" id="detailZoomImg" src="' + initialSrc + '" alt="' + safeBrand + '" onerror="this.parentNode.style.display=\'none\'">' +
      '<div class="detail-zoom-lens" id="detailZoomLens"></div>' +
      '<span class="detail-zoom-hint">üîç „Éõ„Éê„Éº„ÅßÊã°Â§ß</span>' +
      '<span class="detail-zoom-hint-mobile">„Çø„ÉÉ„Éó„ÅßÊã°Â§ß</span>' +
    '</div>' +
    '<div class="detail-zoom-result" id="detailZoomResult"></div>' +
    '<div class="detail-modal-content"><div class="detail-modal-title">' + safeBrand + ' - ' + safeManagedId + '</div>' +
    basicInfoHtml + defectHtml + measurementsHtml + noInfo + '</div>' +
    '<div class="detail-modal-footer"><button class="detail-add-btn" ' + btnDisabled + ' onclick="addToCartFromModal(\'' + safeManagedId + '\')">' + btnText + '</button></div>';

  // Swap to full-res image when loaded (if different from thumbnail)
  if (safeImageUrl && safeImageUrl !== safeThumbUrl) {
    var fullImg = new Image();
    fullImg.onload = function() {
      var el = document.getElementById('detailZoomImg');
      if (el) el.src = safeImageUrl;
      initDetailZoom_(safeImageUrl);
    };
    fullImg.src = safeImageUrl;
  }

  // Initialize zoom with current image (thumbnail or full if already cached)
  initDetailZoom_(safeImageUrl || initialSrc);
}

// =====================================================
// ÁîªÂÉè„Ç∫„Éº„É†Ê©üËÉΩ (Amazon-style)
// =====================================================

function initDetailZoom_(imageUrl) {
  var wrap = document.getElementById('detailZoomWrap');
  var img = document.getElementById('detailZoomImg');
  var lens = document.getElementById('detailZoomLens');
  var result = document.getElementById('detailZoomResult');
  if (!wrap || !img || !lens || !result) return;

  var isMobile = window.matchMedia('(max-width: 700px)').matches;

  if (isMobile) {
    // Mobile: tap to open fullscreen viewer
    wrap.addEventListener('click', function() { openFullscreenViewer_(imageUrl); });
    return;
  }

  // Desktop: Amazon-style hover magnifier
  var zoomLevel = 2.5;
  var ready = false;

  img.addEventListener('load', function() {
    ready = true;
    result.style.backgroundImage = 'url(' + imageUrl + ')';
    result.style.backgroundSize = (img.naturalWidth * zoomLevel) + 'px ' + (img.naturalHeight * zoomLevel) + 'px';
  });

  // If image is already cached and loaded
  if (img.complete && img.naturalWidth > 0) {
    ready = true;
    result.style.backgroundImage = 'url(' + imageUrl + ')';
    result.style.backgroundSize = (img.naturalWidth * zoomLevel) + 'px ' + (img.naturalHeight * zoomLevel) + 'px';
  }

  wrap.addEventListener('mouseleave', function() { result.style.display = 'none'; lens.style.display = 'none'; });

  wrap.addEventListener('mousemove', function(e) {
    if (!ready) return;
    var rect = wrap.getBoundingClientRect();
    var x = e.clientX - rect.left;
    var y = e.clientY - rect.top;

    // Calculate actual rendered image area within object-fit:contain element
    var natW = img.naturalWidth, natH = img.naturalHeight;
    var contW = rect.width, contH = rect.height;
    var scale = Math.min(contW / natW, contH / natH);
    var renderedW = natW * scale, renderedH = natH * scale;
    var imgOffsetX = (contW - renderedW) / 2;
    var imgOffsetY = (contH - renderedH) / 2;

    // Only react when cursor is over the actual image pixels
    if (x < imgOffsetX || x > imgOffsetX + renderedW || y < imgOffsetY || y > imgOffsetY + renderedH) {
      result.style.display = 'none';
      lens.style.display = 'none';
      return;
    }
    result.style.display = 'block';
    lens.style.display = 'block';

    // Position lens (centered on cursor via CSS transform: translate(-50%, -50%))
    lens.style.left = x + 'px';
    lens.style.top = y + 'px';

    // Calculate ratios based on actual rendered image size
    var relX = (x - imgOffsetX) / renderedW;
    var relY = (y - imgOffsetY) / renderedH;

    // Background position for zoom result
    var bgX = relX * (img.naturalWidth * zoomLevel) - result.offsetWidth / 2;
    var bgY = relY * (img.naturalHeight * zoomLevel) - result.offsetHeight / 2;
    result.style.backgroundPosition = '-' + Math.max(0, bgX) + 'px -' + Math.max(0, bgY) + 'px';

    // Position zoom result panel next to the modal (fixed positioning)
    var modal = wrap.closest('.detail-modal');
    if (modal) {
      var modalRect = modal.getBoundingClientRect();
      var spaceRight = window.innerWidth - modalRect.right;
      var resultTop = Math.max(10, modalRect.top);
      result.style.top = resultTop + 'px';
      if (spaceRight >= 310) {
        result.style.left = (modalRect.right + 10) + 'px';
      } else {
        result.style.left = (modalRect.left - 310) + 'px';
      }
    }
  });
}

// Fullscreen image viewer for mobile
function openFullscreenViewer_(imageUrl) {
  var viewer = document.getElementById('fullscreenViewer');
  var viewerImg = document.getElementById('fullscreenViewerImg');
  if (!viewer || !viewerImg) return;
  viewerImg.src = imageUrl;
  viewerImg.style.transform = 'scale(1)';
  viewer.classList.add('active');

  // Pinch-to-zoom state
  var scale = 1;
  var startDist = 0;
  var startScale = 1;
  var translateX = 0, translateY = 0;
  var lastTap = 0;

  function applyTransform() {
    viewerImg.style.transform = 'scale(' + scale + ') translate(' + (translateX / scale) + 'px, ' + (translateY / scale) + 'px)';
  }

  function getDistance(t1, t2) {
    var dx = t1.clientX - t2.clientX;
    var dy = t1.clientY - t2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  // Double-tap to toggle zoom
  viewerImg.ontouchend = function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      e.preventDefault();
      if (scale > 1) {
        scale = 1; translateX = 0; translateY = 0;
      } else {
        scale = 2.5;
      }
      applyTransform();
    }
    lastTap = now;
  };

  // Pinch zoom & pan
  viewerImg.ontouchmove = function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      var dist = getDistance(e.touches[0], e.touches[1]);
      scale = Math.min(5, Math.max(1, startScale * (dist / startDist)));
      applyTransform();
    } else if (e.touches.length === 1 && scale > 1) {
      e.preventDefault();
      translateX += e.touches[0].clientX - (viewerImg._lastX || e.touches[0].clientX);
      translateY += e.touches[0].clientY - (viewerImg._lastY || e.touches[0].clientY);
      viewerImg._lastX = e.touches[0].clientX;
      viewerImg._lastY = e.touches[0].clientY;
      applyTransform();
    }
  };

  viewerImg.ontouchstart = function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      startDist = getDistance(e.touches[0], e.touches[1]);
      startScale = scale;
    }
    if (e.touches.length === 1) {
      viewerImg._lastX = e.touches[0].clientX;
      viewerImg._lastY = e.touches[0].clientY;
    }
  };
}

function closeFullscreenViewer_() {
  var viewer = document.getElementById('fullscreenViewer');
  if (viewer) viewer.classList.remove('active');
}

// Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÅüÂæå„ÅÆÊàª„ÇäÂÖà
var detailReturnTo_ = null;

function closeDetailModal() {
  var modal = document.getElementById('detailModal');
  if (modal) modal.classList.remove('active');
  var zoomResult = document.getElementById('detailZoomResult');
  if (zoomResult) zoomResult.style.display = 'none';
  closeFullscreenViewer_();
  if (detailReturnTo_ === 'cart') {
    detailReturnTo_ = null;
    renderCartModal_(); openModal($('cartModal'));
  }
  detailReturnTo_ = null;
}

function addToCartFromModal(managedId) {
  var idx = state.cart.ids.indexOf(managedId);
  if (idx === -1) toggleCartOptimistic_(managedId);
  closeDetailModal();
}

function setupDetailModalEvents_() {
  var modal = document.getElementById('detailModal');
  if (modal) { modal.addEventListener('click', function(e) { if (e.target === modal) closeDetailModal(); }); }
  // Close fullscreen viewer on background tap
  var viewer = document.getElementById('fullscreenViewer');
  if (viewer) { viewer.addEventListener('click', function(e) { if (e.target === viewer) closeFullscreenViewer_(); }); }
}

// =====================================================
// „Éñ„É©„É≥„ÉâÈÅ∏Êäû
// =====================================================

function brandCount_() { return Object.keys(state.brandUi.selected || {}).length; }

function updateBrandBtn_() {
  var n = brandCount_();
  if ($('brandBtnText')) $('brandBtnText').textContent = '„Éñ„É©„É≥„Éâ';
  if ($('brandBtnSub')) $('brandBtnSub').textContent = n ? n : '';
  var btn = $('brandBtn');
  if (btn) btn.classList.toggle('active', n > 0);
  if ($('brandHint')) $('brandHint').textContent = n ? ('ÈÅ∏Êäû‰∏≠Ôºö' + n + '‰ª∂') : 'Ë§áÊï∞ÈÅ∏Êäû„Åó„Å¶„ÄåÈÅ©Áî®„Äç„ÅßÊ§úÁ¥¢„Åó„Åæ„Åô';
}

// Êó•Êú¨Ë™û„Éñ„É©„É≥„ÉâÂêç„Ç®„Ç§„É™„Ç¢„ÇπÔºàÊ§úÁ¥¢Áî®Ôºâ- „Å≤„Çâ„Åå„Å™„Éª„Ç´„Çø„Ç´„Éä‰∏°ÂØæÂøú
var brandAliases_ = {
  'nike': ['„Éä„Ç§„Ç≠', '„Å™„ÅÑ„Åç'],
  'adidas': ['„Ç¢„Éá„Ç£„ÉÄ„Çπ', '„ÅÇ„Åß„ÅÉ„Å†„Åô', '„ÅÇ„Åß„ÅÑ„Å†„Åô'],
  'puma': ['„Éó„Éº„Éû', '„Å∑„Éº„Åæ'],
  'gucci': ['„Ç∞„ÉÉ„ÉÅ', '„Åê„Å£„Å°'],
  'chanel': ['„Ç∑„É£„Éç„É´', '„Åó„ÇÉ„Å≠„Çã'],
  'louis vuitton': ['„É´„Ç§„É¥„Ç£„Éà„É≥', '„Çã„ÅÑ„Å≥„Å®„Çì', '„É´„Ç§„Éª„É¥„Ç£„Éà„É≥'],
  'hermes': ['„Ç®„É´„É°„Çπ', '„Åà„Çã„ÇÅ„Åô'],
  'prada': ['„Éó„É©„ÉÄ', '„Å∑„Çâ„Å†'],
  'burberry': ['„Éê„Éº„Éê„É™„Éº', '„Å∞„Éº„Å∞„Çä„Éº'],
  'coach': ['„Ç≥„Éº„ÉÅ', '„Åì„Éº„Å°'],
  'michael kors': ['„Éû„Ç§„Ç±„É´„Ç≥„Éº„Çπ', '„Åæ„ÅÑ„Åë„Çã„Åì„Éº„Åô'],
  'ralph lauren': ['„É©„É´„Éï„É≠„Éº„É¨„É≥', '„Çâ„Çã„Åµ„Çç„Éº„Çå„Çì'],
  'uniqlo': ['„É¶„Éã„ÇØ„É≠', '„ÇÜ„Å´„Åè„Çç'],
  'zara': ['„Ç∂„É©', '„Åñ„Çâ'],
  'gap': ['„ÇÆ„É£„ÉÉ„Éó', '„Åé„ÇÉ„Å£„Å∑'],
  'h&m': ['„Ç®„Ç§„ÉÅ„Ç¢„É≥„Éâ„Ç®„É†', '„Åà„ÅÑ„Å°„ÅÇ„Çì„Å©„Åà„ÇÄ'],
  'supreme': ['„Ç∑„É•„Éó„É™„Éº„É†', '„Åó„ÇÖ„Å∑„Çä„Éº„ÇÄ'],
  'stussy': ['„Çπ„ÉÜ„É•„Éº„Ç∑„Éº', '„Åô„Å¶„ÇÖ„Éº„Åó„Éº'],
  'north face': ['„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ', '„ÅÆ„Éº„Åô„Åµ„Åá„ÅÑ„Åô'],
  'patagonia': ['„Éë„Çø„Ç¥„Éã„Ç¢', '„Å±„Åü„Åî„Å´„ÅÇ'],
  'champion': ['„ÉÅ„É£„É≥„Éî„Ç™„É≥', '„Å°„ÇÉ„Çì„Å¥„Åä„Çì'],
  'levis': ['„É™„Éº„Éê„Ç§„Çπ', '„Çä„Éº„Å∞„ÅÑ„Åô'],
  'tommy hilfiger': ['„Éà„Éü„Éº„Éí„É´„Éï„Ç£„Ç¨„Éº', '„Å®„Åø„Éº„Å≤„Çã„Åµ„ÅÉ„Åå„Éº'],
  'calvin klein': ['„Ç´„É´„Éê„É≥„ÇØ„É©„Ç§„É≥', '„Åã„Çã„Å∞„Çì„Åè„Çâ„ÅÑ„Çì'],
  'diesel': ['„Éá„Ç£„Éº„Çº„É´', '„Åß„ÅÉ„Éº„Åú„Çã'],
  'jill stuart': ['„Ç∏„É´„Çπ„ÉÅ„É•„Ç¢„Éº„Éà', '„Åò„Çã„Åô„Å°„ÇÖ„ÅÇ„Éº„Å®'],
  'marc jacobs': ['„Éû„Éº„ÇØ„Ç∏„Çß„Ç§„Ç≥„Éñ„Çπ', '„Åæ„Éº„Åè„Åò„Åá„ÅÑ„Åì„Å∂„Åô'],
  'versace': ['„É¥„Çß„É´„Çµ„Éº„ÉÅ', '„Åπ„Çã„Åï„Éº„Å°', '„Éô„É´„Çµ„Éº„ÉÅ'],
  'armani': ['„Ç¢„É´„Éû„Éº„Éã', '„ÅÇ„Çã„Åæ„Éº„Å´'],
  'fendi': ['„Éï„Çß„É≥„Éá„Ç£', '„Åµ„Åá„Çì„Åß„ÅÉ'],
  'balenciaga': ['„Éê„É¨„É≥„Ç∑„Ç¢„Ç¨', '„Å∞„Çå„Çì„Åó„ÅÇ„Åå'],
  'celine': ['„Çª„É™„Éº„Éå', '„Åõ„Çä„Éº„Å¨'],
  'dior': ['„Éá„Ç£„Ç™„Éº„É´', '„Åß„ÅÉ„Åä„Éº„Çã'],
  'ysl': ['„Ç§„É¥„Çµ„É≥„É≠„Éº„É©„É≥', '„ÅÑ„Å∂„Åï„Çì„Çç„Éº„Çâ„Çì'],
  'comme des garcons': ['„Ç≥„É†„Éá„ÇÆ„É£„É´„ÇΩ„É≥', '„Åì„ÇÄ„Åß„Åé„ÇÉ„Çã„Åù„Çì'],
  'issey miyake': ['„Ç§„ÉÉ„Çª„Ç§„Éü„É§„Ç±', '„ÅÑ„Å£„Åõ„ÅÑ„Åø„ÇÑ„Åë'],
  'yohji yamamoto': ['„É®„Ç¶„Ç∏„É§„Éû„É¢„Éà', '„Çà„ÅÜ„Åò„ÇÑ„Åæ„ÇÇ„Å®'],
  'asics': ['„Ç¢„Ç∑„ÉÉ„ÇØ„Çπ', '„ÅÇ„Åó„Å£„Åè„Åô'],
  'adam et rope': ['„Ç¢„ÉÄ„É†„Ç®„É≠„Éö', '„ÅÇ„Å†„ÇÄ„Åà„Çç„Å∫'],
  'adam et rope\'': ['„Ç¢„ÉÄ„É†„Ç®„É≠„Éö', '„ÅÇ„Å†„ÇÄ„Åà„Çç„Å∫'],
  'new balance': ['„Éã„É•„Éº„Éê„É©„É≥„Çπ', '„Å´„ÇÖ„Éº„Å∞„Çâ„Çì„Åô'],
  'converse': ['„Ç≥„É≥„Éê„Éº„Çπ', '„Åì„Çì„Å∞„Éº„Åô'],
  'vans': ['„É¥„Ç°„É≥„Ç∫', '„Å∞„Çì„Åö', '„Éê„É≥„Ç∫'],
  'reebok': ['„É™„Éº„Éú„ÉÉ„ÇØ', '„Çä„Éº„Åº„Å£„Åè'],
  'under armour': ['„Ç¢„É≥„ÉÄ„Éº„Ç¢„Éº„Éû„Éº', '„ÅÇ„Çì„Å†„Éº„ÅÇ„Éº„Åæ„Éº'],
  'columbia': ['„Ç≥„É≠„É≥„Éì„Ç¢', '„Åì„Çç„Çì„Å≥„ÅÇ'],
  'arc\'teryx': ['„Ç¢„Éº„ÇØ„ÉÜ„É™„ÇØ„Çπ', '„ÅÇ„Éº„Åè„Å¶„Çä„Åè„Åô'],
  'the north face': ['„Ç∂„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ', '„Åñ„ÅÆ„Éº„Åô„Åµ„Åá„ÅÑ„Åô', '„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ'],
  'beams': ['„Éì„Éº„É†„Çπ', '„Å≥„Éº„ÇÄ„Åô'],
  'united arrows': ['„É¶„Éä„Ç§„ÉÜ„ÉÉ„Éâ„Ç¢„É≠„Éº„Ç∫', '„ÇÜ„Å™„ÅÑ„Å¶„Å£„Å©„ÅÇ„Çç„Éº„Åö'],
  'ships': ['„Ç∑„ÉÉ„Éó„Çπ', '„Åó„Å£„Å∑„Åô'],
  'journal standard': ['„Ç∏„É£„Éº„Éä„É´„Çπ„Çø„É≥„ÉÄ„Éº„Éâ', '„Åò„ÇÉ„Éº„Å™„Çã„Åô„Åü„Çì„Å†„Éº„Å©'],
  'urban research': ['„Ç¢„Éº„Éê„É≥„É™„Çµ„Éº„ÉÅ', '„ÅÇ„Éº„Å∞„Çì„Çä„Åï„Éº„Å°'],
  'nano universe': ['„Éä„Éé„É¶„Éã„Éê„Éº„Çπ', '„Å™„ÅÆ„ÇÜ„Å´„Å∞„Éº„Åô'],
  'green label relaxing': ['„Ç∞„É™„Éº„É≥„É¨„Éº„Éô„É´', '„Åê„Çä„Éº„Çì„Çå„Éº„Åπ„Çã'],
  'beauty&youth': ['„Éì„É•„Éº„ÉÜ„Ç£„Éº„Ç¢„É≥„Éâ„É¶„Éº„Çπ', '„Å≥„ÇÖ„Éº„Å¶„ÅÉ„Éº„ÅÇ„Çì„Å©„ÇÜ„Éº„Åô'],
  'lowrys farm': ['„É≠„Éº„É™„Éº„Ç∫„Éï„Ç°„Éº„É†', '„Çç„Éº„Çä„Éº„Åö„Åµ„ÅÅ„Éº„ÇÄ'],
  'global work': ['„Ç∞„É≠„Éº„Éê„É´„ÉØ„Éº„ÇØ', '„Åê„Çç„Éº„Å∞„Çã„Çè„Éº„Åè'],
  'snidel': ['„Çπ„Éä„Ç§„Éá„É´', '„Åô„Å™„ÅÑ„Åß„Çã'],
  'moussy': ['„Éû„Ç¶„Ç∏„Éº', '„Åæ„ÅÜ„Åò„Éº'],
  'sly': ['„Çπ„É©„Ç§', '„Åô„Çâ„ÅÑ'],
  'emoda': ['„Ç®„É¢„ÉÄ', '„Åà„ÇÇ„Å†'],
  'murua': ['„É†„É´„Éº„Ç¢', '„ÇÄ„Çã„Éº„ÅÇ'],
  'mercuryduo': ['„Éû„Éº„Ç≠„É•„É™„Éº„Éá„É•„Ç™', '„Åæ„Éº„Åç„ÇÖ„Çä„Éº„Åß„ÇÖ„Åä'],
  'dazzlin': ['„ÉÄ„Ç∫„É™„É≥', '„Å†„Åö„Çä„Çì'],
  'lily brown': ['„É™„É™„Éº„Éñ„É©„Ç¶„É≥', '„Çä„Çä„Éº„Å∂„Çâ„ÅÜ„Çì'],
  'fray i.d': ['„Éï„É¨„Ç§„Ç¢„Ç§„Éá„Ç£„Éº', '„Åµ„Çå„ÅÑ„ÅÇ„ÅÑ„Åß„ÅÉ„Éº'],
  'theory': ['„Çª„Ç™„É™„Éº', '„Åõ„Åä„Çä„Éº'],
  'untitled': ['„Ç¢„É≥„Çø„Ç§„Éà„É´', '„ÅÇ„Çì„Åü„ÅÑ„Å®„Çã'],
  'natural beauty basic': ['„Éä„ÉÅ„É•„É©„É´„Éì„É•„Éº„ÉÜ„Ç£„Éº„Éô„Éº„Ç∑„ÉÉ„ÇØ', '„Å™„Å°„ÇÖ„Çâ„Çã„Å≥„ÇÖ„Éº„Å¶„ÅÉ„Éº„Åπ„Éº„Åó„Å£„Åè'],
  'rope': ['„É≠„Éö', '„Çç„Å∫'],
  'iena': ['„Ç§„Ç®„Éä', '„ÅÑ„Åà„Å™'],
  'spick and span': ['„Çπ„Éî„ÉÉ„ÇØ„Ç¢„É≥„Éâ„Çπ„Éë„É≥', '„Åô„Å¥„Å£„Åè„ÅÇ„Çì„Å©„Åô„Å±„Çì'],
  'tomorrowland': ['„Éà„Ç•„É¢„É≠„Éº„É©„É≥„Éâ', '„Å®„ÅÖ„ÇÇ„Çç„Éº„Çâ„Çì„Å©'],
  'macphee': ['„Éû„Ç´„Éï„Ç£„Éº', '„Åæ„Åã„Åµ„ÅÉ„Éº'],
  'onward': ['„Ç™„É≥„ÉØ„Éº„Éâ', '„Åä„Çì„Çè„Éº„Å©'],
  'world': ['„ÉØ„Éº„É´„Éâ', '„Çè„Éº„Çã„Å©']
};

// ÁèæÂú®„ÅÆÈ†≠ÊñáÂ≠ó„Éï„Ç£„É´„Çø„Éº
var currentInitialFilter_ = null;

// Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Åã„Çâ„Éñ„É©„É≥„ÉâÂêçÂÄôË£ú„ÇíÂèñÂæó
function getBrandSearchKeys_(brandKey) {
  var keys = [brandKey.toLowerCase()];
  // „Ç®„Ç§„É™„Ç¢„Çπ„ÇíËøΩÂä†
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      keys = keys.concat(brandAliases_[eng].map(function(a) { return a.toLowerCase(); }));
    }
  }
  return keys;
}

// Ê§úÁ¥¢„ÇØ„Ç®„É™„Åå„Éñ„É©„É≥„Éâ„Å´„Éû„ÉÉ„ÉÅ„Åô„Çã„Åã
function matchesBrandSearch_(brandKey, query) {
  if (!query) return true;
  var q = query.toLowerCase();
  // „Éñ„É©„É≥„ÉâÂêçËá™‰Ωì„Å´„Éû„ÉÉ„ÉÅ
  if (brandKey.toLowerCase().indexOf(q) !== -1) return true;
  // „Ç®„Ç§„É™„Ç¢„Çπ„Åã„Çâ„Éû„ÉÉ„ÉÅ
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      for (var i = 0; i < brandAliases_[eng].length; i++) {
        if (brandAliases_[eng][i].toLowerCase().indexOf(q) !== -1) return true;
      }
    }
    // ÈÄÜÊñπÂêë: Êó•Êú¨Ë™ûÂÖ•Âäõ„ÅßËã±Ë™û„Éñ„É©„É≥„Éâ„ÇíÊ§úÁ¥¢
    for (var j = 0; j < brandAliases_[eng].length; j++) {
      if (q.indexOf(brandAliases_[eng][j].toLowerCase()) !== -1 || brandAliases_[eng][j].toLowerCase().indexOf(q) !== -1) {
        if (brandKey.toLowerCase().indexOf(eng) !== -1) return true;
      }
    }
  }
  return false;
}

// È†≠ÊñáÂ≠ó„ÇíÂèñÂæó
function getInitialChar_(name) {
  if (!name) return '#';
  var c = name.charAt(0).toUpperCase();
  // Ëã±Â≠ó
  if (/[A-Z]/.test(c)) return c;
  // Êï∞Â≠ó
  if (/[0-9]/.test(c)) return '#';
  // „Å≤„Çâ„Åå„Å™„Éª„Ç´„Çø„Ç´„Éä„ÅÆË°åÂà§ÂÆö
  var hiraOrder = '„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çí„Çì';
  var kataOrder = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
  var idx = hiraOrder.indexOf(c);
  if (idx === -1) idx = kataOrder.indexOf(c);
  if (idx !== -1) {
    var row = Math.floor(idx / 5);
    var rowHeads = ['„ÅÇ', '„Åã', '„Åï', '„Åü', '„Å™', '„ÅØ', '„Åæ', '„ÇÑ', '„Çâ', '„Çè'];
    return rowHeads[Math.min(row, rowHeads.length - 1)] || '„ÅÇ';
  }
  // Êº¢Â≠ó„Å™„Å©
  return '‰ªñ';
}

function buildBrandListOnce_(brands) {
  if (state.brandUi.built) return;
  state.brandUi.built = true;
  state.brandUi.all = Array.isArray(brands) ? brands.slice() : [];
  state.brandUi.selected = {};
  state.brandUi.itemsByKey = {};

  // „Éñ„É©„É≥„ÉâÂêç„ÇíÊ≠£Ë¶èÂåñ„Åó„Å¶Áµ±Âêà
  brandDisplayMap_ = {};
  brandNormalizedMap_ = {};
  var normalizedOrder = [];

  for (var i = 0; i < state.brandUi.all.length; i++) {
    var name = String(state.brandUi.all[i] || '').trim();
    if (!name) continue;
    var key = normalizeBrand_(name);
    brandNormalizedMap_[name] = key;
    if (!brandDisplayMap_[key]) {
      brandDisplayMap_[key] = name;
      normalizedOrder.push(key);
    }
  }

  // È†≠ÊñáÂ≠ó„Åß„Ç∞„É´„Éº„ÉóÂåñ
  var groups = {};
  var groupOrder = [];
  for (var i = 0; i < normalizedOrder.length; i++) {
    var key = normalizedOrder[i];
    var displayName = brandDisplayMap_[key];
    var initial = getInitialChar_(displayName);
    if (!groups[initial]) {
      groups[initial] = [];
      groupOrder.push(initial);
    }
    groups[initial].push({ key: key, displayName: displayName });
  }

  // „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü„Å´„ÇΩ„Éº„Éà
  groupOrder.sort(function(a, b) {
    var orderA = /[A-Z]/.test(a) ? a.charCodeAt(0) : (a === '#' ? 999 : 1000 + '„ÅÇ„Åã„Åï„Åü„Å™„ÅØ„Åæ„ÇÑ„Çâ„Çè‰ªñ'.indexOf(a));
    var orderB = /[A-Z]/.test(b) ? b.charCodeAt(0) : (b === '#' ? 999 : 1000 + '„ÅÇ„Åã„Åï„Åü„Å™„ÅØ„Åæ„ÇÑ„Çâ„Çè‰ªñ'.indexOf(b));
    return orderA - orderB;
  });

  // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÊßãÁØâ
  var nav = $('brandIndexNav');
  if (nav) {
    nav.innerHTML = '';
    // „Äå„Åô„Åπ„Å¶„Äç„Éú„Çø„É≥„ÇíËøΩÂä†
    var allBtn = document.createElement('button');
    allBtn.className = 'brandIndexBtn filter-active';
    allBtn.textContent = '„Åô„Åπ„Å¶';
    allBtn.dataset.initial = 'all';
    allBtn.addEventListener('click', function() {
      currentInitialFilter_ = null;
      filterBrandList_();
      updateIndexBtnState_('all');
    });
    nav.appendChild(allBtn);

    groupOrder.forEach(function(initial) {
      var btn = document.createElement('button');
      btn.className = 'brandIndexBtn';
      btn.textContent = initial;
      btn.dataset.initial = initial;
      btn.addEventListener('click', function() {
        // Âêå„Åò„Éú„Çø„É≥„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâËß£Èô§
        if (currentInitialFilter_ === initial) {
          currentInitialFilter_ = null;
          updateIndexBtnState_('all');
        } else {
          currentInitialFilter_ = initial;
          updateIndexBtnState_(initial);
        }
        filterBrandList_();
      });
      nav.appendChild(btn);
    });
  }

  function updateIndexBtnState_(activeInitial) {
    document.querySelectorAll('.brandIndexBtn').forEach(function(b) {
      b.classList.remove('filter-active');
      if (b.dataset.initial === activeInitial) b.classList.add('filter-active');
    });
  }

  // „Éñ„É©„É≥„Éâ„É™„Çπ„ÉàÊßãÁØâ
  var list = $('brandList');
  list.innerHTML = '';

  groupOrder.forEach(function(initial) {
    // „Ç∞„É´„Éº„Éó„Éò„ÉÉ„ÉÄ„Éº
    var header = document.createElement('div');
    header.className = 'brandGroupHeader';
    header.dataset.initial = initial;
    header.textContent = initial;
    list.appendChild(header);

    // „Ç∞„É´„Éº„ÉóÂÜÖ„Éñ„É©„É≥„Éâ
    groups[initial].forEach(function(brand) {
      var row = document.createElement('div');
      row.className = 'brandItem';
      row.dataset.name = brand.key;
      row.dataset.key = brand.key.toLowerCase();
      row.dataset.initial = initial;

      var checkEl = document.createElement('span');
      checkEl.className = 'brand-check';
      var label = document.createElement('div');
      label.className = 'brandName';
      label.textContent = brand.displayName;

      row.appendChild(checkEl);
      row.appendChild(label);
      state.brandUi.itemsByKey[brand.key] = row;
      list.appendChild(row);
    });
  });

  // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
  list.addEventListener('click', function(ev) {
    var item = ev.target.closest ? ev.target.closest('.brandItem') : null;
    if (!item) return;
    var key = String(item.dataset.name || '');
    if (!key) return;

    var isSelected = item.classList.contains('selected');
    if (isSelected) {
      item.classList.remove('selected');
      delete state.brandUi.selected[key];
    } else {
      item.classList.add('selected');
      state.brandUi.selected[key] = true;
    }
    updateBrandBtn_();
  });
}

function filterBrandList_() {
  var q = String($('brandSearch').value || '').trim();
  var list = $('brandList');
  var shown = 0;
  var visibleGroups = {};

  // „Éñ„É©„É≥„Éâ„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
  list.querySelectorAll('.brandItem').forEach(function(el) {
    var key = String(el.dataset.key || '');
    var initial = el.dataset.initial;
    // Ê§úÁ¥¢„ÇØ„Ç®„É™„Å®È†≠ÊñáÂ≠ó„Éï„Ç£„É´„Çø„Éº„ÅÆ‰∏°Êñπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    var matchQuery = matchesBrandSearch_(key, q);
    var matchInitial = !currentInitialFilter_ || initial === currentInitialFilter_;
    var ok = matchQuery && matchInitial;
    el.style.display = ok ? '' : 'none';
    if (ok) {
      shown++;
      visibleGroups[initial] = true;
    }
  });

  // „Ç∞„É´„Éº„Éó„Éò„ÉÉ„ÉÄ„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫
  list.querySelectorAll('.brandGroupHeader').forEach(function(header) {
    var initial = header.dataset.initial;
    var showHeader = currentInitialFilter_ ? (initial === currentInitialFilter_) : visibleGroups[initial];
    header.style.display = showHeader ? '' : 'none';
  });

  if ($('brandHint')) {
    var n = brandCount_();
    $('brandHint').textContent = n ? ('ÈÅ∏Êäû‰∏≠Ôºö' + n + '‰ª∂ / Ë°®Á§∫Ôºö' + shown + '‰ª∂') : ('Ë°®Á§∫Ôºö' + shown + '‰ª∂');
  }
}

// =====================================================
// „Åä„Åô„Åô„ÇÅÂïÜÂìÅ
// =====================================================

// „Åä„Åô„Åô„ÇÅÂØæË±°„ÅÆÁä∂ÊÖãÔºàS, A, AB „Åæ„Åü„ÅØÂêåÁ≠â„ÅÆÊó•Êú¨Ë™ûË°®ÁèæÔºâ
var RECOMMEND_STATES = ['S', 'A', 'AB', 'Êñ∞ÂìÅ', 'ÁæéÂìÅ', 'ËâØÂìÅ', 'Êñ∞ÂìÅÂêåÊßò', 'Êú™‰ΩøÁî®', 'Êú™‰ΩøÁî®„Å´Ëøë„ÅÑ'];

function isRecommendableState_(state) {
  if (!state) return false;
  var s = String(state).trim().toUpperCase();
  for (var i = 0; i < RECOMMEND_STATES.length; i++) {
    if (s === RECOMMEND_STATES[i].toUpperCase() || s.indexOf(RECOMMEND_STATES[i].toUpperCase()) !== -1) return true;
  }
  return false;
}

function getRecommendedProducts_(maxCount, excludeIds) {
  if (!state.allProducts || !state.allProducts.length) return [];

  var cartIds = excludeIds || state.cart.ids || [];
  var cartItems = [];
  for (var i = 0; i < cartIds.length; i++) {
    var it = state.cart.itemsById[cartIds[i]];
    if (it) cartItems.push(it);
  }

  // „Ç´„Éº„ÉàÂÜÖ„ÅÆ„Éñ„É©„É≥„Éâ„Éª„Ç´„ÉÜ„Ç¥„É™„ÉªÊÄßÂà•„Éª„Çµ„Ç§„Ç∫„Éª‰æ°Ê†ºÂ∏Ø„ÇíÂèéÈõÜ
  var cartBrands = {}, cartCategories = {}, cartGenders = {}, cartSizes = {};
  var priceSum = 0, priceCount = 0;
  for (var i = 0; i < cartItems.length; i++) {
    var ci = cartItems[i];
    if (ci.brand) cartBrands[normalizeBrand_(ci.brand)] = true;
    if (ci.category) cartCategories[ci.category] = true;
    if (ci.gender) cartGenders[ci.gender] = true;
    if (ci.size) cartSizes[ci.size] = true;
    if (ci.price) { priceSum += ci.price; priceCount++; }
  }
  var avgPrice = priceCount > 0 ? (priceSum / priceCount) : 0;

  // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºÜ„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞
  var candidates = [];
  for (var i = 0; i < state.allProducts.length; i++) {
    var p = state.allProducts[i];

    // „Ç´„Éº„ÉàÂÜÖ„ÅÆÂïÜÂìÅ„ÅØÈô§Â§ñ
    if (cartIds.indexOf(p.managedId) !== -1) continue;

    // Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÔºàS, A, ABÁ≠âÔºâ
    if (!isRecommendableState_(p.state)) continue;

    // ÂÇ∑Ê±ö„ÇåË©≥Á¥∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ
    if (p.defectDetail && p.defectDetail.trim()) continue;

    // „Éñ„É©„É≥„Éâ‰∏çÊòé„ÉªË®òËºâ„Å™„Åó„ÅØÈô§Â§ñ
    var brand = String(p.brand || '').trim().toLowerCase();
    if (!brand || brand === '‰∏çÊòé' || brand === 'Ë®òËºâ„Å™„Åó' || brand === '„Å™„Åó' || brand === 'ÁÑ°„Åó' || brand === '„Éé„Éº„Éñ„É©„É≥„Éâ' || brand === 'unknown' || brand === 'none') continue;

    // „Çπ„Ç≥„Ç¢Ë®àÁÆó
    var score = 0;
    if (cartBrands[normalizeBrand_(p.brand)]) score += 30;
    if (cartCategories[p.category]) score += 20;
    if (cartGenders[p.gender]) score += 15;
    if (cartSizes[p.size]) score += 10;
    if (avgPrice > 0 && p.price) {
      var priceDiff = Math.abs(p.price - avgPrice) / avgPrice;
      if (priceDiff <= 0.3) score += 5;
    }

    // „Ç´„Éº„Éà„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ‰æ°Ê†º„ÅåÈ´ò„ÅÑÈ†Ü„Å´„É©„É≥„ÉÄ„É†
    if (cartItems.length === 0) {
      score = p.price || 0;
    }

    candidates.push({ product: p, score: score });
  }

  // „Çπ„Ç≥„Ç¢ÈôçÈ†Ü„ÄÅÂêå„Çπ„Ç≥„Ç¢„Å™„Çâ‰æ°Ê†ºÈôçÈ†Ü„Åß„ÇΩ„Éº„ÉàÂæå„ÄÅ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†ËøΩÂä†
  candidates.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return (b.product.price || 0) - (a.product.price || 0);
  });

  // ‰∏ä‰Ωç„ÇíÂèñÂæó„Åó„Å¶„Ç∑„É£„ÉÉ„Éï„É´ÔºàÂêå„Çπ„Ç≥„Ç¢Â∏Ø„Åß„É©„É≥„ÉÄ„É†ÊÄß„ÇíÂá∫„ÅôÔºâ
  var top = candidates.slice(0, Math.min(maxCount * 3, candidates.length));
  for (var i = top.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = top[i]; top[i] = top[j]; top[j] = temp;
  }

  var result = [];
  for (var i = 0; i < Math.min(maxCount, top.length); i++) {
    result.push(top[i].product);
  }
  return result;
}

function renderRecommendations_(containerId, sectionId, maxCount, isMainScreen) {
  var container = $(containerId);
  var section = $(sectionId);
  if (!container || !section) return;

  var recommendations = getRecommendedProducts_(maxCount || 6, state.cart.ids);

  if (recommendations.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  container.innerHTML = '';

  for (var i = 0; i < recommendations.length; i++) {
    var p = recommendations[i];
    var card = document.createElement('div');
    card.className = 'recommendCard';

    var imgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl, 200) : '';
    var fullImgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl) : '';
    var img = document.createElement('img');
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23eee" width="100" height="100"/%3E%3Ctext x="50" y="55" text-anchor="middle" fill="%23999" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = p.noLabel || p.managedId;
    img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';

    var info = document.createElement('div');
    info.className = 'rcInfo';
    var brand = document.createElement('div');
    brand.className = 'rcBrand';
    brand.textContent = p.brand || '-';
    var price = document.createElement('div');
    price.className = 'rcPrice';
    price.textContent = yen(p.price);
    info.appendChild(brand);
    info.appendChild(price);

    card.appendChild(img);
    card.appendChild(info);

    (function(mid, iurl, mainScreen) {
      card.addEventListener('click', function() {
        if (!mainScreen) closeModal($('cartModal'));
        detailReturnTo_ = mainScreen ? null : 'cart';
        openDetailModal(mid, iurl);
      });
    })(p.managedId, fullImgUrl, isMainScreen);

    container.appendChild(card);
  }
}

function renderMainRecommendations_() {
  renderRecommendations_('mainRecommendList', 'mainRecommend', 8, true);
}

// =====================================================
// „Ç´„Éº„Éà„É¢„Éº„ÉÄ„É´„ÉªÈÄÅ‰ø°
// =====================================================

/**
 * „Ç´„Éº„ÉàÂÜÖ„ÅÆË°®Á§∫ÂàáÊõø: true=„Ç´„Éº„Éà‰∏ÄË¶ß, false=„ÅäÂ±ä„ÅëÂÖà„Éï„Ç©„Éº„É†
 */
function showCartSection_(showCart) {
  var cartList = $('cartList');
  var cartRecommend = $('cartRecommend');
  var cartActions = $('cartActions');
  var cartForm = $('cartFormSection');
  var title = $('cartModalTitle');
  var sumBox = $('cartSumBox');
  if (showCart) {
    if (cartList) cartList.style.display = '';
    if (cartRecommend) cartRecommend.style.display = '';
    if (cartActions) cartActions.style.display = '';
    if (cartForm) cartForm.style.display = 'none';
    if (title) title.textContent = '„Ç´„Éº„Éà';
    // sumBox„ÇíÂÖÉ„ÅÆ‰ΩçÁΩÆÔºàcartFormSection„ÅÆÂâçÔºâ„Å´Êàª„Åô
    if (sumBox && cartForm) {
      cartForm.parentNode.insertBefore(sumBox, cartForm);
    }
  } else {
    if (cartList) cartList.style.display = 'none';
    if (cartRecommend) cartRecommend.style.display = 'none';
    if (cartActions) cartActions.style.display = 'none';
    if (cartForm) cartForm.style.display = '';
    if (title) title.textContent = '„ÅîÊ≥®ÊñáÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç';
    // sumBox„Çí„Éï„Ç©„Éº„É†ÂÜÖ„ÅÆformActions„ÅÆÁõ¥Ââç„Å´ÁßªÂãïÔºà„Ç´„Éº„Éà„Å®Âêå„Åò‰∏ãÈÉ®‰ΩçÁΩÆÔºâ
    if (sumBox && cartForm) {
      var formActs = cartForm.querySelector('.formActions');
      if (formActs) cartForm.insertBefore(sumBox, formActs);
      else cartForm.appendChild(sumBox);
    }
  }
}

function renderCartModal_() {
  showCartSection_(true); // „Ç´„Éº„Éà‰∏ÄË¶ß„Éì„É•„Éº„ÅßË°®Á§∫
  var listEl = $('cartList'); listEl.innerHTML = '';
  var ids = (state.cart.ids || []).slice();
  var sum = 0;
  
  for (var i = 0; i < ids.length; i++) {
    var id = ids[i];
    var it = state.cart.itemsById[id];
    if (!it) continue;
    var row = document.createElement('div'); row.className = 'cartRow';

    // ÁîªÂÉè„Å®„ÉÜ„Ç≠„Çπ„Éà„ÇíÂõ≤„ÇÄ„Ç≥„É≥„ÉÜ„Éä
    var info = document.createElement('div'); info.className = 'cartInfo';

    // ÂïÜÂìÅÁîªÂÉè
    var imgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl, 150) : '';
    var fullImgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '';
    var img = document.createElement('img'); img.className = 'cartImg';
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"%3E%3Crect fill="%23eee" width="50" height="50"/%3E%3Ctext x="25" y="30" text-anchor="middle" fill="%23999" font-size="10"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = it.noLabel || id;
    img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
    (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, fullImgUrl);

    var left = document.createElement('div'); left.className = 'cartLeft';
    var name = document.createElement('div'); name.className = 'cartName'; name.style.cursor = 'pointer';
    name.textContent = (it.noLabel ? it.noLabel : id) + (it.brand ? (' ' + it.brand) : '');
    (function(mid, iurl) { name.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, fullImgUrl);
    var sub = document.createElement('div'); sub.className = 'cartSub';
    sub.textContent = [it.category, it.color, it.gender, it.size].filter(Boolean).join(' / ') + ' / ' + yen(it.price);
    left.appendChild(name); left.appendChild(sub);
    info.appendChild(img); info.appendChild(left);

    var btn = document.createElement('button'); btn.className = 'dangerBtn'; btn.type = 'button'; btn.textContent = 'ÂâäÈô§';
    (function(idRef) {
      btn.addEventListener('click', function() {
        var idx = state.cart.ids.indexOf(idRef);
        if (idx !== -1) state.cart.ids.splice(idx, 1);
        delete state.cart.itemsById[idRef];
        delete state.cart.digest[idRef]; // Á¢∫‰øù„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂç≥ÊôÇ„ÇØ„É™„Ç¢
        saveCartStorage(); updateCartCount(); updateCardUi_(idRef);
        runApi('apiSyncHolds', state.userKey, state.cart.ids.slice()).catch(function() {});
        renderCartModal_();
        updateShippingDisplay_();
      });
    })(id);
    row.appendChild(info); row.appendChild(btn); listEl.appendChild(row);
    sum += Number(it.price || 0);
  }
  
  var count = ids.length;
  $('sumCount').textContent = 'ÂêàË®àÁÇπÊï∞Ôºö' + count + 'ÁÇπ';
  // Ââ≤Âºï„ÇíÁ¥ØÁ©çÔºà30ÁÇπ‰ª•‰∏ä10% + ‰ºöÂì°10%Ôºâ
  var discountRate = 0;
  var discountLabels = [];
  if (count >= 30) { discountRate += BULK_DISCOUNT_RATE; discountLabels.push('30ÁÇπÂâ≤Âºï10%OFF'); }
  if (state.customer && MEMBER_DISCOUNT_ENABLED) { discountRate += MEMBER_DISCOUNT_RATE; discountLabels.push('‰ºöÂì°10%OFF'); }
  var discounted = Math.round(sum * (1 - discountRate));
  var discountLabel = discountLabels.length > 0 ? 'Ôºà' + discountLabels.join('Ôºã') + 'Ôºâ' : '';
  if (discountRate > 0) {
    $('sumPrice').innerHTML = 'ÂêàË®àÈáëÈ°çÔºö<span class="price-old">' + yen(sum) + '</span> ‚Üí <span class="price-new">' + yen(discounted) + '</span>' + discountLabel;
  } else { $('sumPrice').innerHTML = 'ÂêàË®àÈáëÈ°çÔºö' + yen(discounted); }

  $('goFormBtn').disabled = (count === 0);

  // „Åä„Åô„Åô„ÇÅÂïÜÂìÅ„ÇíË°®Á§∫
  renderRecommendations_('cartRecommendList', 'cartRecommend', 6);

  // „Ç´„Éº„ÉàÂ§âÊõ¥ÊôÇ„Å´ÈÄÅÊñô„ÇíÂÜçË®àÁÆó
  updateShippingDisplay_();
}

function readForm_() {
  var f = {
    companyName: $('companyName').value || '', contact: $('contact').value || '',
    postal: $('postal').value || '', address: $('address').value || '',
    phone: $('phone').value || '', note: $('note').value || '', measureOpt: getMeasureOptValue_()
  };
  // „Éù„Ç§„É≥„ÉàÂà©Áî®
  var pts = parseInt($('usePoints').value, 10) || 0;
  if (pts > 0 && state.customer) f.usePoints = pts;
  // „Ç§„É≥„Éú„Ç§„ÇπÈ†òÂèéÊõ∏
  if ($('invoiceReceipt') && $('invoiceReceipt').checked) f.invoiceReceipt = true;
  // ÈÄÅÊñôÊÉÖÂ†±„ÇíËøΩÂä†
  var shipping = state.lastShipping || calculateShipping_();
  if (shipping && shipping.amount != null) {
    f.shippingAmount = shipping.amount;
    f.shippingSize = shipping.size || '';
    f.shippingArea = shipping.area || '';
    f.shippingPref = shipping.pref || '';
  }
  return f;
}

function showPointSection_() {
  var section = $('pointUseSection');
  if (!section) return;
  if (state.customer && state.customer.points > 0) {
    section.style.display = '';
    $('pointAvailable').textContent = 'Ôºà‰øùÊúâ: ' + state.customer.points + ' ptÔºâ';
    $('usePoints').value = 0;
    $('usePoints').max = state.customer.points;
    updatePointDiscountInfo_();
  } else {
    section.style.display = 'none';
  }
}

function updatePointDiscountInfo_() {
  var info = $('pointDiscountInfo');
  if (!info) return;
  var pts = parseInt($('usePoints').value, 10) || 0;
  var max = (state.customer && state.customer.points) ? state.customer.points : 0;
  if (pts > max) { pts = max; $('usePoints').value = max; }
  if (pts < 0) { pts = 0; $('usePoints').value = 0; }
  if (pts > 0) {
    info.textContent = pts + '„Éù„Ç§„É≥„ÉàÂà©Áî®„Åß -' + yen(pts) + ' Ââ≤ÂºïÔºà„ÄåÂ§âÊõ¥„ÇíÈÅ©Áî®„Äç„ÅßÂêàË®à„Å´ÂèçÊò†Ôºâ';
  } else {
    info.textContent = '';
  }
}

function applyPointDiscount_() {
  var pts = parseInt($('usePoints').value, 10) || 0;
  var max = (state.customer && state.customer.points) ? state.customer.points : 0;
  if (pts > max) { pts = max; $('usePoints').value = max; }
  if (pts < 0) { pts = 0; $('usePoints').value = 0; }

  // „Ç´„Éº„ÉàÂêàË®à„ÇíÂÜçË®àÁÆó
  var sum = 0;
  var ids = state.cart.ids || [];
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }

  var discountRate = 0;
  var discountLabels = [];
  if (ids.length >= 30) { discountRate += BULK_DISCOUNT_RATE; discountLabels.push('30ÁÇπÂâ≤Âºï10%OFF'); }
  if (state.customer && MEMBER_DISCOUNT_ENABLED) { discountRate += MEMBER_DISCOUNT_RATE; discountLabels.push('‰ºöÂì°10%OFF'); }
  var discounted = Math.round(sum * (1 - discountRate));

  var pointsApplied = Math.min(pts, discounted);
  var finalPrice = discounted - pointsApplied;
  var discountLabel = discountLabels.length > 0 ? 'Ôºà' + discountLabels.join('Ôºã') + 'Ôºâ' : '';

  var priceHtml = '';
  if (pointsApplied > 0) {
    if (discountRate > 0) {
      priceHtml = 'ÂêàË®àÈáëÈ°çÔºö<span class="price-old">' + yen(sum) + '</span> ‚Üí <span class="price-new">' + yen(finalPrice) + '</span>' + discountLabel;
    } else {
      priceHtml = 'ÂêàË®àÈáëÈ°çÔºö<span class="price-old">' + yen(discounted) + '</span> ‚Üí <span class="price-new">' + yen(finalPrice) + '</span>';
    }
    priceHtml += '<div style="font-size:12px;color:#b8002a;margin-top:2px;">Ôºà„Éù„Ç§„É≥„ÉàÂà©Áî®: -' + yen(pointsApplied) + 'Ôºâ</div>';
  } else {
    if (discountRate > 0) {
      priceHtml = 'ÂêàË®àÈáëÈ°çÔºö<span class="price-old">' + yen(sum) + '</span> ‚Üí <span class="price-new">' + yen(discounted) + '</span>' + discountLabel;
    } else {
      priceHtml = 'ÂêàË®àÈáëÈ°çÔºö' + yen(discounted);
    }
  }
  $('sumPrice').innerHTML = priceHtml;

  var info = $('pointDiscountInfo');
  if (info) {
    if (pointsApplied > 0) {
      info.innerHTML = '<span style="color:#2e7d32;">&#10003; ' + pointsApplied + '„Éù„Ç§„É≥„ÉàÈÅ©Áî®Ê∏à„ÅøÔºà-' + yen(pointsApplied) + 'Ôºâ</span>';
    } else {
      info.textContent = '';
    }
  }
  if (pointsApplied > 0) showToast('„Éù„Ç§„É≥„ÉàÂâ≤Âºï„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü');
  // „Éù„Ç§„É≥„ÉàÈÅ©Áî®Âæå„Å´ÈÄÅÊñôËæº„ÅøÂêàË®à„ÇÇÊõ¥Êñ∞
  updateShippingDisplay_();
}

function validateForm_(f) {
  if (!f.companyName.trim()) return '‰ºöÁ§æÂêç/Ê∞èÂêç„ÅØÂøÖÈ†à„Åß„Åô';
  if (!f.contact.trim()) return '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÂøÖÈ†à„Åß„Åô';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.contact.trim())) return 'ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  if (!String(f.postal || '').trim()) return 'ÈÉµ‰æøÁï™Âè∑„ÅØÂøÖÈ†à„Åß„Åô';
  if (!String(f.address || '').trim()) return '‰ΩèÊâÄ„ÅØÂøÖÈ†à„Åß„Åô';
  if (!String(f.phone || '').trim()) return 'ÈõªË©±Áï™Âè∑„ÅØÂøÖÈ†à„Åß„Åô';
  // Èõ¢Â≥∂„ÉÅ„Çß„ÉÉ„ÇØ
  var address = String(f.address || '').trim();
  if (address && isRemoteIslandAddress_(address)) return 'Èõ¢Â≥∂„Å∏„ÅÆÈÖçÈÄÅ„ÅØÂØæË±°Â§ñ„Åß„Åô„ÄÇÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÅîÊ≥®Êñá„ÅÑ„Åü„Å†„Åë„Åæ„Åõ„Çì„ÄÇ';
  return '';
}

var submitting_ = false;
function submitNow_() {
  if (submitting_) return;
  submitting_ = true;
  if ((state.cart.ids || []).length === 0) { showToast('„Ç´„Éº„Éà„ÅåÁ©∫„Åß„Åô'); submitting_ = false; return; }
  var f = readForm_();
  var err = validateForm_(f);
  if (err) { showToast(err); submitting_ = false; return; }
  $('submitBtn').disabled = true;
  setSending_(true, 'Ê≥®Êñá„ÇíÊ∫ñÂÇô‰∏≠...');
  var ids = (state.cart.ids || []).slice();

  // „Çπ„ÉÜ„ÉÉ„Éó1: CSRFÊõ¥Êñ∞ + reCAPTCHA + Á¢∫‰øùÂêåÊúü„Çí‰∏¶ÂàóÂÆüË°åÔºàÈ´òÈÄüÂåñÔºâ
  Promise.all([
    runApi('apiGetCsrfToken', state.userKey).then(function(csrfRes) {
      if (csrfRes && csrfRes.ok && csrfRes.csrfToken) state.csrfToken = csrfRes.csrfToken;
    }).catch(function() {}),
    getRecaptchaToken_().catch(function() { return ''; }),
    runApi('apiSyncHolds', state.userKey, ids)
  ])
    .then(function(results) {
      var recaptchaToken = results[1] || '';
      var syncResult = results[2];
      if (!syncResult || !syncResult.ok) throw new Error(syncResult && syncResult.message ? syncResult.message : 'Á¢∫‰øù„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      if (syncResult.failed && syncResult.failed.length) {
        state.cart.ids = state.cart.ids.filter(function(x) { return !syncResult.failed.find(function(f) { return f.id === x; }); });
        saveCartStorage(); updateCartCount(); renderCartModal_();
        throw new Error('‰∏ÄÈÉ®Á¢∫‰øù„Åß„Åç„Å™„ÅÑÂïÜÂìÅ„Åå„ÅÇ„Çä„Åæ„Åô');
      }
      // „Çπ„ÉÜ„ÉÉ„Éó2: Ê≥®ÊñáÈÄÅ‰ø°
      setSending_(true, 'Ê≥®ÊñáÈÄÅ‰ø°‰∏≠...');
      return runApi('apiSubmitEstimate', state.userKey, f, ids, { _runApiExtra_: true, recaptchaToken: recaptchaToken });
    })
    .then(function(res) {
      if (!res || !res.ok) throw new Error(res && res.message ? res.message : 'Ê≥®ÊñáÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      var sessionUrl = res.sessionUrl || '';
      if (!sessionUrl) throw new Error('Ê±∫Ê∏àURL„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      // „Ç´„Éº„Éà„ÇØ„É™„Ç¢ÔºàÊ±∫Ê∏àÂÆå‰∫ÜÂæå„Å´„Éö„Éº„Ç∏„Å´Êàª„Å£„Å¶„Åè„Çã„ÅÆ„ÅßÂÖà„Å´„ÇØ„É™„Ç¢Ôºâ
      state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
      saveCartStorage(); updateCartCount();
      // KOMOJUÊ±∫Ê∏à„Éö„Éº„Ç∏„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
      setSending_(true, 'Ê±∫Ê∏à„Éö„Éº„Ç∏„Å∏ÁßªÂãï‰∏≠...');
      window.location.href = sessionUrl;
    })
    .catch(function(e) {
      showToast(e.message || 'Ê≥®ÊñáÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    })
    .finally(function() { setSending_(false); $('submitBtn').disabled = false; submitting_ = false; });
}

// =====================================================
// KOMOJUÊ±∫Ê∏à„Åã„Çâ„ÅÆÊàª„ÇäÂá¶ÁêÜ
// =====================================================

function handlePaymentReturn_() {
  var params = new URLSearchParams(window.location.search);
  var receipt = params.get('receipt');
  var status = params.get('status');
  if (!receipt || !status) return;

  // URL„Åã„Çâ„ÇØ„Ç®„É™„Éë„É©„É°„Éº„Çø„ÇíÂâäÈô§ÔºàÂ±•Ê≠¥„ÇíÊ±ö„Åï„Å™„ÅÑÔºâ
  if (window.history && window.history.replaceState) {
    var cleanUrl = window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }

  if (status === 'complete') {
    // Ê±∫Ê∏àÂÆå‰∫Ü
    $('doneReceipt').textContent = receipt;
    if ($('doneModalTitle')) $('doneModalTitle').textContent = 'Ê≥®ÊñáÂÆå‰∫Ü';
    if ($('doneMessage')) $('doneMessage').textContent = '„ÅäÊîØÊâï„ÅÑ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÊ≥®ÊñáÁ¢∫Ë™ç„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åó„Åæ„Åó„Åü„ÅÆ„Åß„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇÂïÜÂìÅ„ÅÆÁô∫ÈÄÅÊ∫ñÂÇô„ÇíÈÄ≤„ÇÅ„Å¶„Åæ„ÅÑ„Çä„Åæ„Åô„ÄÇ';
    openModal($('doneModal'));
    // Webhook„ÅåÊú™Âá¶ÁêÜ„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÅ„Çß„ÉÉ„ÇØÁµåÁî±„ÅßÊ≥®ÊñáÁ¢∫ÂÆö„ÇíË©¶Ë°å
    runApi('apiCheckPaymentStatus', receipt).catch(function(e) {
      console.log('Payment status check on return:', e);
    });
  } else if (status === 'cancel') {
    // Ê±∫Ê∏à„Ç≠„É£„É≥„Çª„É´
    $('doneReceipt').textContent = receipt;
    if ($('doneModalTitle')) $('doneModalTitle').textContent = 'Ê±∫Ê∏à„Ç≠„É£„É≥„Çª„É´';
    if ($('doneMessage')) $('doneMessage').textContent = 'Ê±∫Ê∏à„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇÂïÜÂìÅ„ÅØËá™ÂãïÁöÑ„Å´Ëß£Êîæ„Åï„Çå„Åæ„Åô„ÄÇÂÜçÂ∫¶„ÅîÊ≥®Êñá„ÅÑ„Åü„Å†„ÅèÂ†¥Âêà„ÅØ„Ç´„Éº„Éà„Åã„ÇâÂïÜÂìÅ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    openModal($('doneModal'));
    // „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ„Çí„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÈÄöÁü•
    runApi('apiCancelOrder', receipt).catch(function() {});
  }
}

// =====================================================
// Ë®≠ÂÆö
// =====================================================

function normalizeSettings_(s) {
  var src = (s && typeof s === 'object') ? s : {};
  var ui = (src.uiText && typeof src.uiText === 'object') ? src.uiText : {};
  var out = {};
  out.appTitle = String(src.appTitle || ui.appTitle || '„Éá„Çø„Ç¶„É™.Detauri');
  out.minOrderCount = Number(src.minOrderCount != null ? src.minOrderCount : (ui.minOrderCount != null ? ui.minOrderCount : 10));
  out.shippingEstimateText = String(src.shippingEstimateText || ui.shippingEstimateText || '');
  out.notes = Array.isArray(src.notes) ? src.notes : (Array.isArray(ui.notes) ? ui.notes : []);
  out.nextSteps = Array.isArray(src.nextSteps) ? src.nextSteps : (Array.isArray(ui.nextSteps) ? ui.nextSteps : []);
  out.basePaymentUrl = String(src.basePaymentUrl || ui.basePaymentUrl || '');
  return out;
}

function setBaseLink_() {
  var a = $('baseLink');
  if (!a) return;
  var url = (state.settings && state.settings.basePaymentUrl) ? String(state.settings.basePaymentUrl) : '';
  if (!url) { a.textContent = ''; a.removeAttribute('href'); return; }
  a.textContent = url; a.href = url;
}

// =====================================================
// UIÂàùÊúüÂåñ
// =====================================================

function bindUi_() {
  $('overlay').addEventListener('click', closeAllModals);
  
  $('brandBtn').addEventListener('click', function() {
    $('brandSearch').value = '';
    filterBrandList_(); updateBrandBtn_(); openModal($('brandModal'));
    try { $('brandSearch').focus(); } catch (e) {}
  });
  $('brandCloseBtn').addEventListener('click', function() { closeModal($('brandModal')); });
  $('brandSearch').addEventListener('input', filterBrandList_);
  $('brandClearBtn').addEventListener('click', function() {
    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    // „Éì„Ç∏„É•„Ç¢„É´ÈÅ∏ÊäûÁä∂ÊÖã„ÇÇ„ÇØ„É™„Ç¢
    $('brandList').querySelectorAll('.brandItem.selected').forEach(function(el) {
      el.classList.remove('selected');
    });
    // Ê§úÁ¥¢ÂÖ•Âäõ„ÇÇ„ÇØ„É™„Ç¢
    $('brandSearch').value = '';
    // È†≠ÊñáÂ≠ó„Éï„Ç£„É´„Çø„Éº„ÇÇ„É™„Çª„ÉÉ„Éà
    currentInitialFilter_ = null;
    // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
    $('brandIndexNav').querySelectorAll('.brandIndexBtn').forEach(function(btn) {
      btn.classList.remove('filter-active');
      if (btn.dataset.initial === 'all') btn.classList.add('filter-active');
    });
    // Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
    state.brandUi.selected = {};
    updateBrandBtn_();
    filterBrandList_();
  });
  $('brandApplyBtn').addEventListener('click', function() {
    state.query.filters.brand = Object.keys(state.brandUi.selected || {});
    state.query.page = 1; updateBrandBtn_(); closeModal($('brandModal')); filterAndRender(true);
  });
  
  var doFilter_ = function() { state.query.page = 1; filterAndRender(true); };
  // „ÇΩ„Éº„Éà„ÉÅ„ÉÉ„ÉóÔºö„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ÈñãÈñâ
  $('sortChipBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
      if (d.id !== 'sortDropdown') d.classList.remove('open');
    });
    $('sortDropdown').classList.toggle('open');
  });
  // „ÇΩ„Éº„ÉàÊñπÂêë„Éà„Ç∞„É´
  $('sortDirToggle').addEventListener('click', function() {
    var dir = state.query.sort.dir === 'asc' ? 'desc' : 'asc';
    state.query.sort.dir = dir;
    this.textContent = dir === 'asc' ? '‚Üë' : '‚Üì';
    doFilter_();
  });

  $('btnReset').addEventListener('click', function() {
    state.query.filters = { brand: [], category: [], state: [], gender: [], size: [] };
    state.query.sort = { key: 'default', dir: 'asc' };
    state.query.page = 1;
    // „Éñ„É©„É≥„Éâ„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    state.brandUi.selected = {}; updateBrandBtn_();
    // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
    resetMultiSelectFilters();
    updateSortChip_();
    $('sortDirToggle').textContent = '‚Üë';
    filterAndRender(true);
  });
  
  $('openCartBtn').addEventListener('click', function() { renderCartModal_(); openModal($('cartModal')); });
  $('clearCartBtn').addEventListener('click', function() {
    state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
    saveCartStorage(); updateCartCount(); renderCartModal_(); updateShippingDisplay_(); filterAndRender(false);
    runApi('apiSyncHolds', state.userKey, []).catch(function() {});
    showToast('„Ç´„Éº„Éà„ÇíÁ©∫„Å´„Åó„Åæ„Åó„Åü');
  });
  $('cartCloseBtn').addEventListener('click', function() {
    showCartSection_(true); // „Ç´„Éº„Éà„Éì„É•„Éº„Å´Êàª„Åó„Å¶„Åã„ÇâÈñâ„Åò„Çã
    closeModal($('cartModal'));
  });
  $('goFormBtn').addEventListener('click', function() {
    var min = (state.settings && state.settings.minOrderCount) ? Number(state.settings.minOrderCount) : 10;
    var count = (state.cart.ids || []).length;
    if (count < min) {
      showToast(min + 'ÁÇπ‰ª•‰∏ä„ÅßË≥ºÂÖ•ÂèØËÉΩ„Åß„ÅôÔºàÁèæÂú®' + count + 'ÁÇπÔºâ');
      return;
    }
    // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆÊÉÖÂ†±„ÇíËá™ÂãïÂÖ•Âäõ
    if (state.customer) {
      if (state.customer.companyName && !$('companyName').value) $('companyName').value = state.customer.companyName;
      if (state.customer.email && !$('contact').value) $('contact').value = state.customer.email;
      if (state.customer.phone && !$('phone').value) $('phone').value = state.customer.phone;
      if (state.customer.postal && !$('postal').value) $('postal').value = state.customer.postal;
      if (state.customer.address && !$('address').value) $('address').value = state.customer.address;
    }
    showPointSection_();
    showCartSection_(false); // „Éï„Ç©„Éº„É†Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
    // „Éï„Ç©„Éº„É†Ë°®Á§∫ÊôÇ„Å´‰ΩèÊâÄ„Åå„ÅÇ„Çå„Å∞ÈÄÅÊñô„ÇíË®àÁÆó
    updateShippingDisplay_();
  });
  $('formBackBtn').addEventListener('click', function() { showCartSection_(true); });
  $('submitBtn').addEventListener('click', submitNow_);
  // ‰ΩèÊâÄÂÖ•ÂäõÊôÇ„Å´ÈÄÅÊñô„Çí„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
  if ($('address')) {
    $('address').addEventListener('input', function() { updateShippingDisplay_(); });
  }
  $('doneCloseBtn').addEventListener('click', function() { closeModal($('doneModal')); });
  
}

function setupScrollTopButton_() {
  var btn = $('toTopBtn');
  if (!btn) return;
  var threshold = 400;
  var update = function() {
    var hasModal = !!document.querySelector('.modal.open');
    var sendingOn = $('sendingOverlay') && $('sendingOverlay').classList.contains('on');
    if (hasModal || sendingOn) { btn.classList.remove('show'); return; }
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > threshold) btn.classList.add('show'); else btn.classList.remove('show');
  };
  btn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  window.addEventListener('scroll', update, { passive: true });
  window.addEventListener('resize', update);
  update();
}

// =====================================================
// „Ç¢„ÇØ„Çª„Çπ„É≠„Ç∞ÔºàPVË®òÈå≤Ôºâ
// =====================================================

function logPageView_() {
  if (IS_OWNER) return;  // „Ç™„Éº„Éä„Éº„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØ„É≠„Ç∞„Åó„Å™„ÅÑ
  // „Éú„ÉÉ„Éà„Éª„ÇØ„É≠„Éº„É©„ÉºÈô§Â§ñ
  var ua = navigator.userAgent || '';
  if (/HeadlessChrome|Google-Read-Aloud|bot|crawl|spider|slurp/i.test(ua)) return;
  var sw = screen.width || 0, sh = screen.height || 0;
  if ((sw === 0 && sh === 0) || (sw >= 2000 && sh >= 2000) || (sw === 400 && sh === 400)) return;
  try {
    var payload = {
      page: 'Index',
      userKey: state.userKey || '',
      url: window.location.href || '',
      referrer: document.referrer || '',
      userAgent: navigator.userAgent || '',
      language: navigator.language || '',
      screen: (screen.width || 0) + 'x' + (screen.height || 0)
    };
    runApi('apiLogPV', payload).catch(function(e) {
      console.log('PV„É≠„Ç∞„Ç®„É©„Éº:', e);
    });
  } catch (e) {
    console.log('PV„É≠„Ç∞ÈÄÅ‰ø°Â§±Êïó:', e);
  }
}

// =====================================================
// Ëµ∑Âãï
// =====================================================

function boot() {
  state.userKey = loadUserKey();
  var c = loadCartStorage();
  state.cart.ids = c.ids || [];
  state.cart.itemsById = c.itemsById || {};
  updateCartCount();

  // „Ç¢„ÇØ„Çª„Çπ„É≠„Ç∞ÈÄÅ‰ø°
  logPageView_();

  bindUi_();
  setupScrollTopButton_();
  setupDetailModalEvents_();
  setupAuthUi_();
  updateAuthUi_();  // ÂàùÂõûË°®Á§∫Ôºà„Éó„É≠„É¢„Éê„Éä„ÉºÁ≠âÔºâ
  setupMultiSelectFilters();

  // KOMOJUÊ±∫Ê∏à„Åã„Çâ„ÅÆÊàª„Çä„ÇíÂá¶ÁêÜ
  handlePaymentReturn_();

  // „Çª„ÉÉ„Ç∑„Éß„É≥Ê§úË®ºÔºà„É≠„Ç∞„Ç§„É≥Áä∂ÊÖãÂæ©ÂÖÉÔºâ
  validateSession_();

  // ÂÖ®„É¶„Éº„Ç∂„Éº„Å´CSRF„Éà„Éº„ÇØ„É≥„ÇíÁô∫Ë°åÔºàÈùû„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„Åß„ÇÇÊ≥®ÊñáÈÄÅ‰ø°„Å´ÂøÖË¶ÅÔºâ
  fetchCsrfToken_();

  // Ë™¨ÊòéÊ¨Ñ„Å©„Åì„ÇíÊäº„Åó„Å¶„ÇÇÊäò„Çä„Åü„Åü„Åø
  var topDet = document.querySelector('.topDetails');
  if (topDet) {
    topDet.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') return; // „É™„É≥„ÇØ„ÅØ„Åù„ÅÆ„Åæ„Åæ
      if (e.target.closest('summary')) return; // summary„ÅØÊ®ôÊ∫ñÂãï‰Ωú
      topDet.open = !topDet.open;
    });
  }

  var mo = loadMeasureOpt_();
  if (mo) setMeasureOptValue_(mo);
  
  // „Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„Çå„Å∞Âç≥Â∫ß„Å´Ë°®Á§∫
  var cached = loadProductCache_();
  if (cached && !cached.stale && cached.products) {
    console.log('„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂç≥ÊôÇË°®Á§∫:', cached.products.length + '‰ª∂');
    applyProductData_(cached);
  } else if (cached && cached.stale && cached.data && cached.data.products) {
    console.log('Âè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂç≥ÊôÇË°®Á§∫:', cached.data.products.length + '‰ª∂');
    applyProductData_(cached.data);
  } else {
    renderLoadingGrid_();
  }

  // ÊúÄÊñ∞„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßÂèñÂæó
  loadProductData()
    .then(function(data) {
      // „Ç≠„É£„ÉÉ„Ç∑„É•„Å®‰ª∂Êï∞„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÜçÊèèÁîª
      var needsRender = !state.dataLoaded || state.allProducts.length !== (data.products || []).length;
      applyProductData_(data);
      if (needsRender) {
        console.log('ÊúÄÊñ∞„Éá„Éº„Çø„ÅßÊõ¥Êñ∞: ' + state.allProducts.length + '‰ª∂');
      }
    })
    .catch(function(err) {
      console.error('Ëµ∑Âãï„Ç®„É©„Éº:', err);
      if (!state.dataLoaded) {
        showToast('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (err.message || err));
      }
    });
}

function applyProductData_(data) {
  state.allProducts = data.products || [];
  state.options = data.options || {};
  state.settings = normalizeSettings_(data.settings);

  // ‰ºöÂì°Ââ≤ÂºïË®≠ÂÆö„ÇíAPI„Åã„ÇâÂèçÊò†
  if (data.settings && data.settings.memberDiscount) {
    var md = data.settings.memberDiscount;
    MEMBER_DISCOUNT_ENABLED = !!md.enabled;
    MEMBER_DISCOUNT_RATE = MEMBER_DISCOUNT_ENABLED ? Number(md.rate || 0.10) : 0;
    MEMBER_DISCOUNT_END_DATE = md.endDate || '2026-09-30';
  }

  // ‰ºöÂì°Ââ≤ÂºïOFF„ÅÆÂ†¥Âêà„ÄÅ„Ç¨„Ç§„Éâ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ‰ºöÂì°Ââ≤ÂºïË°®Á§∫„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
  var guideMember = $('guideMemberDiscount');
  var guideCombine = $('guideCombineDiscount');
  if (guideMember) guideMember.style.display = MEMBER_DISCOUNT_ENABLED ? '' : 'none';
  if (guideCombine) guideCombine.style.display = MEMBER_DISCOUNT_ENABLED ? '' : 'none';

  // Ââ≤ÂºïË®≠ÂÆöÂèçÊò†Âæå„Å´UIÊõ¥Êñ∞Ôºà„Éê„ÉÉ„Ç∏„Éª„Éó„É≠„É¢„Éê„Éä„Éº„Éª‰æ°Ê†ºÔºâ
  updateAuthUi_();
  updateCartPrice();

  $('appTitle').textContent = '„Éá„Çø„Ç¶„É™.Detauri';
  setBaseLink_();

  // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„ÇíÊßãÁØâ
  buildMultiSelectDropdown('category', state.options.category || []);
  // Áä∂ÊÖã„Éï„Ç£„É´„Çø„ÅØS‚ÜíA‚ÜíAB‚ÜíB‚ÜíC‚ÜíDÈ†Ü„Å´„ÇΩ„Éº„Éà
  var stateOrder = ['S', 'A', 'AB', 'B', 'C', 'D', 'Êñ∞ÂìÅ', 'ÁæéÂìÅ', 'ËâØÂìÅ'];
  var sortedStates = (state.options.state || []).slice().sort(function(a, b) {
    var idxA = stateOrder.indexOf(a);
    var idxB = stateOrder.indexOf(b);
    if (idxA === -1) idxA = 999;
    if (idxB === -1) idxB = 999;
    return idxA - idxB;
  });
  buildMultiSelectDropdown('state', sortedStates);
  buildMultiSelectDropdown('gender', state.options.gender || []);
  buildMultiSelectDropdown('size', state.options.size || []);
  setSortOptions(state.options.sort || [{ key: 'default', label: 'Ê®ôÊ∫ñ' }]);
  if (!state.dataLoaded) {
    state.query.sort = { key: 'default', dir: 'asc' };
    updateSortChip_();
    $('sortDirToggle').textContent = '‚Üë';
  }

  buildBrandListOnce_(state.options.brand || []);
  updateBrandBtn_();
  filterBrandList_();

  state.dataLoaded = true;
  filterAndRender(false);

  // „É°„Ç§„É≥ÁîªÈù¢„Åä„Åô„Åô„ÇÅÂïÜÂìÅ„ÇíË°®Á§∫
  renderMainRecommendations_();
}

window.addEventListener('error', function(ev) {
  var msg = (ev && ev.error && ev.error.message) ? ev.error.message : (ev && ev.message ? ev.message : '„Ç®„É©„Éº');
  // Suppress cross-origin "Script error" messages (not useful to users)
  if (msg === 'Script error.' || msg === 'Script error') return;
  try { showToast(msg); } catch (e) {}
});

window.addEventListener('unhandledrejection', function(ev) {
  var r = ev ? ev.reason : null;
  var msg = (r && r.message) ? r.message : String(r || '„Ç®„É©„Éº');
  try { showToast(msg); } catch (e) {}
});

boot();
</script>

</body>
</html>
