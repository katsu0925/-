<!-- index.html -->
<!-- v2.1.0 -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>デタウリ.Detauri</title>
  <meta property="og:title" content="デタウリ.Detauri">
  <meta property="og:description" content="採寸データ付き古着卸 - 10点から購入可能">
  <meta property="og:type" content="website">
  <meta name="description" content="採寸データ付き古着卸 - 10点から購入可能">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%229%202.5%2086%2086%22%3E%0A%20%20%3C%21--%20Cart%20body%20--%3E%0A%20%20%3Cpath%20d%3D%22M22%2032%20L28%2068%20H74%20L82%2032%20Z%22%20fill%3D%22%23fff5f5%22%20stroke%3D%22%23333%22%20stroke-width%3D%224%22%20stroke-linejoin%3D%22round%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3C%21--%20Handle%20--%3E%0A%20%20%3Cpath%20d%3D%22M22%2032%20L14%2018%22%20fill%3D%22none%22%20stroke%3D%22%23333%22%20stroke-width%3D%224%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3C%21--%20Red%20items%20inside%20cart%20--%3E%0A%20%20%3Crect%20x%3D%2234%22%20y%3D%2240%22%20width%3D%2213%22%20height%3D%2220%22%20rx%3D%223%22%20fill%3D%22%23dc2626%22/%3E%0A%20%20%3Crect%20x%3D%2251%22%20y%3D%2244%22%20width%3D%2213%22%20height%3D%2216%22%20rx%3D%223%22%20fill%3D%22%23ef4444%22/%3E%0A%20%20%3C%21--%20Red%20badge%20%28notification%20dot%29%20--%3E%0A%20%20%3Ccircle%20cx%3D%2280%22%20cy%3D%2222%22%20r%3D%2212%22%20fill%3D%22%23dc2626%22/%3E%0A%20%20%3Ctext%20x%3D%2280%22%20y%3D%2227%22%20text-anchor%3D%22middle%22%20fill%3D%22%23fff%22%20font-size%3D%2216%22%20font-weight%3D%22bold%22%20font-family%3D%22Arial%2Csans-serif%22%3E%21%3C/text%3E%0A%20%20%3C%21--%20Wheels%20--%3E%0A%20%20%3Ccircle%20cx%3D%2236%22%20cy%3D%2276%22%20r%3D%225%22%20fill%3D%22%23333%22/%3E%0A%20%20%3Ccircle%20cx%3D%2266%22%20cy%3D%2276%22%20r%3D%225%22%20fill%3D%22%23333%22/%3E%0A%3C/svg%3E">
  <link rel="icon" type="image/png" sizes="48x48" href="data:image/png;base64,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">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,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">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAABmJLR0QA/wD/AP+gvaeTAAAS90lEQVR4nO3dfXAc9XkH8O+zdyfJerFlm2Bk4dp6NcIxg+8se8CUmKQDOIEMZEoCbRrSIUnTGBoCmfA6BcLEOHEGEmDSYSiEziSEwYUkkJQMJtiBUmr7TrIlBDr5LBmwffgFC7/q3nZ//UPaImTd7t3pt7u/PT2fGf7x7T77HH5Y9p7nt7sAY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGGJtGyOsEmP8NLVlylq7rjQKoC+h6SBAJoWnDAeDDRf397xFguJULFzQrSt+SJRUV6fRqaNolRPQZCHEugFkWu6QI6AfwBoTYbAixqS2ROOZUflzQrCCDixefJ4T4lgCuBTB3CqFGAPyOgCdbBgZekZTe/+OCZpZ2L168HMC/CiGugPx62S4M4/62ROJFWQG5oNmkhhYtqtcrK++DEGsBBBw+3KsBYG3TwED/VANxQbPTDLS1XawRPQ2g0cXDjhDRHS3x+M+nEoQLmn1Cor39VgA/hvNn5UkJIZ48OnPmt5fHYtlS9ueCZgAAAdDutrb1IPqB17kAeCVH9KVz4vHjxe7IBc0AAInFi38OIf7F6zzGeVUYxufbEol0MTtpTmXD/GNXe/udihUzAHxWI/qVKLJGPblOYupItLevIeAJqPh/a6Jzh+fMyT585MjrBe/iZD5MbfH29sYAsAPAGV7nYiGnAZ9tHhgoqKj5kmMaCwAPQ+1iBoCgIcQTu1pbKwva2G6Dzs7OCw3D+LoQoomIdhHR49FotHvqeTIvJdrb1wD4kpRg2gLU3X8/6v5q3BXsiddw5KbHkcpJiE/UBqJbAayz3dTqw0gkchuAByZspxPR2mg0+tjUsmReSrS3RwFEpAQLNKH+mT9g7nnjzo+HfoP9l9yLkZK6yZM6FqqsXLSwt3fYaqO8lxyRSGQlTi9mAAgIIR6NRCJLJSTJPLC7vf3zkFXMACAyEBnxyT9LZyDE5JuXaGY2k7nRbiOra+jrkf8MHgQwpREl844AbpIbMH1aQYtMSnZBA0Ks3bx6teVlct6CFkLYzfEvCYfDV5eUGPPMYFPTPAB/IzWoyEBMHH+kU5BdzwDmLUgmLXO3OkPvtotORBtaC/z1ydRgBINfRgHNgOJkJ7/kkHuQUUJca/WxVUE/BUC3Cd9SX1//3WJzYh4i+pz8oDpEZsKvPycuOUaVdobu6urqAfBLu+hCiLsjkUhDCYkxl42NkS92IrJIZz75R5m0UwXduLujoy3fh5aDlWw2exeAozYHqANwXwmJMZcNdXQsADBbfuRJCjrtWEEDuVzeDptlQff09BzEaOvOzg3hcFheG4g5Qs9mFzsVW6TG/yoUo2doh45lEOX9Hraj71Qq9RCAXTabaUT002ITY+4iTVvoTOTRM/T4AhapTN6tp4qARfk+sy3ovr6+jBDi9gKOs5rbeMqb6VRgkRlfwAIiXdQy5mLl/R4FLU7q6up6Xghhe8s5Ef2U23jqIqDGmchiwhnZ8YKuy/dBwavthBDfh30br5nbeOoSQtj9/ZUee8KPwtN+JMqVd4VIwQXd3d29E9zG87ui79ErzMQzsoCRcu5HIYC8T14qaj00t/H8TWjaEYciT7iGdvgMLUTeFXdF37EytqR0vc1mhhBiRVdXV6zY+Mw5A21tKzWi/3Uk+JlLUbN03lhFGdAH3kTqvRFHDiWAtW0DA7+Y7LOiZ/qpVOqhqqqqGwDkndbg4zbeJcXGZ84JZbNxvaLCmeAHe3Hyz73OxJ5AAwYsPitOkW08OXdEMCma9uz5CEBcfuQKBM5uQqi5+eN/zp7j1A2rupbJRPN9WPIxw+HwJiKyW4Y4ePTo0XMTRT5bgTlnV1vbL4jon6UGDXRgzu+fw+y2j2/BErsfw74rH0Racl9FANvaBgZW5vu85JtkuY3nU0K85HUKU2SZf8kFzW08fzo6a9afABzyOo9SaZr2tOXnUwnObTz/WR6LZSGEZVEo7L9b+vvz/iAEJDxohtt4/pNoaVmAQCABQE7Lg6oRXPJphKrH/dnIfqTf2gtD4nRFGMYX7R6OPuWCXrJkSUVVVdVbsG7jAcCWWCzGbTxF7Fq8+EkS4h+9zqMI3S0DAxGC9QByyk9O4jaePwWDwTthf7moDqJb7YoZkPQosCJW4/FNtYpo6uv7gIju9TqPQhDwq9Z4fHMh20p7th238fynOR5/WACbvM7DEtF7GU27udDNpRU0t/H8hwAjkM3+A4Ck17nkkTYM48sd/f0fFrqD1Onkeeedd2YoFBqA9YsYQUTbhBDPyzw2K90KXT/ruyMj/xQUYobXuYxjCKLr2uLxZ4vZSfq4vcA2HlPMubqO20+dgiI/cAQRrW2Jx/+t2B2lP8G/pqYmWlVV9Xdw5HZ55pRDmoaeYBCduZzXRZ0jom+1xOOPl7Kz9II+cuSI3tDQsJeIviI7NnPWsKYhGgqhQ9dR79hDNSwlhaZd1RqP/7bUAI68YyWZTL4zf/781bC43Zyp6QQRtgSDqBECzYbh5jtLXtKy2TWtiUTfVII4lm9nZ+f5hmHwk/59rFXXcUMqhWbDcO4gRO+RYdzSsmvXc1LCyQiSTzgc3ktEbr5el0lGAJbncrg6nUaL3MLeQ0L82BDil8W+i9CK5Meqnua/AHzT4WMwBwkA24NBbA8G0WwYuDibxcpcDnNKKO4TAD7QtK6WXO6O1kTiz2Q/iCuaowVNRF1229RUVyMQ4Ncl+sFhAM+P/TMvl0N7JoP52SzOyuUwyzBQZRiYYRgYAZDWNBwFkAwEsE/T0B8IYA8RckJ8r7u7+zWncnS0oA3DeFvTrIeRD61fj/D55zuZBnPJg48+iqeftZyDZDWivPcDyuDoewpDoZDtL9bBPXucTIG5qLfP+q+biHbGYrFTTubgaEFv27btQwAHrLbhgi4PmUwG8V3WD6kVQrzpdB5uvEnW8j/bwaEhF1JgTusfGEAmY/20JCLyf0ELId62+pzP0OXB7nIDAHK5nP8Lmogsv+mR4WF8dNQ/N06wyfXYF/SBHTt27HE6D8cL2jAMyzM0wJcd5aCAM/T/uJGH4wXNnY7yd+DgQRw8ZP2oD3LqIZETOF7Q3Okofz1vvWW7jWEYjl8/A+50OQDudJS13rdtryqzROTKM1lcKWjudJQ3FQYqJlcKmogsC5o7Hf6lykDF5PRqOwCAYRh9dms6BoeGHFnTkd23DyPbtiF34EDJb2bSqqsRWrgQ1RddBK262n6HaUSVgYrJlYIOhUJ9um69UnBwzx6pBa0PD+PwAw/gxCuvQNY7erWaGsxZuxazrrtOSrxyoMpAxeTKJYfbnQ79ww+x72tfw4lNm6QVMwAYJ0/i8E9+gkPr1kmL6XeqDFRMbnU5AMD6h6HETseBu+5Cdu9eafEmOrZxI449J+WOId9TZaBicq2ghRDWrTtJZ+jUzp0Y2bpVSiwrRx55BMaIM2958guVBiom1wrarU7Hqddfn3KMQuhHj+LUG2+4cixVqTRQMblW0IZh2I/AJVx2ZPfvn3KMgo+1e7drx1KRSgMVk2sF7dqajmze10BLZ6RSrh1LRSoNVEyutO2A0U5HJBI5AGBevm2my8RQHD8OcfJkyftTXR2opkZiRsVTbaBicq2gx7wNq4Iu4zUd4tQppJ9/HpnNm2EcPjzleIHGRlRccQUqL78csBlaOUG1gYrJ1X8TbnU6VGMkkzh+yy1IbdwopZgBQN+3DyOPPYYT994L4UG3RbWBisnVgp6OazrEyAhO/PCHMJLOPFM8t3MnTm3YIHWAVAjVBiomVwvarU6HStIvvgjD4c5LNhZD5i9/cfQYE6k2UDG5WtDT8e6VzJYtrhwn/cILrhwHUHOgYnK1oKfb3Ssik3H87GzSBwdLXk1YrEKun90eqJjc/3ns4poOz5065d61rRAQx465cqgCrp9dH6iYXC/o6drpKCcqDlRMrhf0dOx0lBNVByom1wt6OnY6yomqAxWT6wU9HTsd5UTVgYrJ9YKebp2OcqPqQMXkRZcDmE6djjKj6kDF5ElBc6fDn1QeqJg8KWjudPiTygMVkycFzZ0Of1J5oGLypKC50+FPKg9UTJ4UNHc6/Ef1gYrJqy4HwJ0OX1F9oGLyrKC50+Evqg9UTJ4VNHc6/EX1gYrJs4LmToe/qD5QMXlW0IV0OobefdeNVJiNQ4cPKz9QMXlW0GOdjoNW2+zmM7QSdvb22m7j9UDF5GWXA7B598oQ/zBUgh8GKiZPC9qu08FnaDX4YaBi8rSgudOhPr8MVEyeFrQTnQ43n/lm+76VGTPcSWQMOXA8vwxUTJ4WtBOdjspzzik5n2KFFi60/JwqKxFobHQlF5o5E1RbKz2uXwYqJk8L2olOR+1ll7nypiqtuhrVF1xgu13FpZc6ngsAhC680JG4BfwgPKjCQMXkdZcDkNzpCMyejTk33TSVfAoy+xvfgFZXZ7td5Re+gEBTk6O5UHU1qq65xpHYfhmomDwvaCc6HbOuvRb1X/1qyTnZqV2zBvXXX1/YxqEQau68E9r8+Y7kQlVVqLntNmhnnCE9doEDFWUuNwAFCtqpTsfcW2/FvHXrEJJ4DRucNw+fuvtuzPvRj4p6JrN25pmo27ABFZddBlRUyEmGCKFwGLUbNiDowAtLAX8NVExuP/D8NE6+ZbZ2zRrUXn450v39yCWTEDYv/8yHQiEEGxpQ2dZW8sPFqbYW1d/5DmZcf/3oc+im8NguqqlBYNEiUH19yTEK4aeBisnzgi7kLbND775b+ltmiVDZ0YHKjo7S9peMamoQXLrU6zQKUshAJRqNKjFQMXl+ycFrOtTkt4GKyfOCHsNrOhTjt4GKSYmC5jUd6vHbQMWkREHzmg71+G2gYlKioPnuFfX4baBiUqKg+e4VtfhxoGJSoqC506EWPw5UTEoU9BjudCjCjwMVkzIFzZ0OdfjpDpWJlClo7nSowa8DFZPno29TIWs6+t55B0uXLHEpo+mpkIEKACUeWTAZ8joB04oVK+bqui7nze7MUYFAoHnbtm1KXgMqU9AAEIlEDgA40+s8mKWDsVhsntdJ5KPMNfQY+3kr85qSAxWTUgVt1+lgSlD2+hlQrKCJiAtacaoOVEyqFfRmAC697Z2V4KPjx49v9ToJK0oVdDQajRPRU17nwfK6J5FIpL1OwkrA6wQmqq6u/tOMGTNmA1gGBfObpo4BuCsWi/3M60TsKNW2G2/FihVzDcNYSkTKDH+mI8MwUtlstrunp+ek17kwNu0oe4aeinA43EpElwJYQERzhBBHhBB7DcN4eceOHdYLFfyNOjs7lxuG8ddCiLMBVBPRASHEUCgUemnr1q2Wr9IrB2VV0OFw+Eoiug+j19/57CSie6LR6O/dystpkUgkBOCbAG4HsCDPZgaATUKIu7q6upRc+ilDWRT0ypUrZ+ZyuV8DuKKI3f4I4O9jsZivl/BFIpEWAL8D8OkCdxEAHmxubr5t48aNpT15R2G+L+hIJHIGgC0ASlmG15/NZj/T09NjebeMqiKRSBjAywDmlrD7H+rq6q7esmVLTnJanlKqD12ssf/VPovSihkAzgkGg79tbW2tlJiWKzo7O8/C6Jm5lGIGgCuOHTv2kMSUlODrghZC3AzgkqnEIKILZ82adbOklFxjGMbDyH+9XBAiunHZsmWfk5SSEnx7yRGJRGYBGAQwR0K4jzKZTHNvb++whFiOC4fDESLaDgl/f0KI7V1dXSskpKUEP5+hr4KcYgaA+srKyqslxXLD1yHpZEREncuXLy/0B6Xy/FzQxXQ0bAkhrpQZz0lEJDVXP313O34uaNlvB1osOZ4jLrjgghkArN9WVDxffPdC+LmgZd8G5Mw7IyTTdf0sB8L64rsXws8FLXsZ44jkeI7QdT0lO6YQwhffvRB+Luj9kuMlJcdzRHNz80EAsid8vvjuhfBzQcu+c0LpW4tMY+Pq7TJjqvrgxVL4tqANw5C6uEgI8YLMeA6T+d11jK5rKQu+Leju7u5XAchaNdbT1dW1SVIsN/w7AFmLqp6KxWJl84Af3xY0ACGE+AGmflOtIKLvY3R5pS/EYrHDRLROQqjjuVzuHglxlOHre/aSyeRQQ0MDiGj1FMLcH4vFnpCVk1v279//ZkNDwzIiKrWHbBDRV7q7u6NSE/OYrwsaAJLJ5Gvz58+vA2D/JvnTPRyLxe6APx+dIJqbm/+o6/oyAK1F7pshom9Ho9FnnEjMS74vaABIJpMvNzY2DgK4CEBNAbscArA2Fouthz+LGQDw/vvvZ1atWvXM8PCwBmAFCnuabD+Av43FYmVzx854vl1tN5lVq1bVpVKpGwFcg8lvw9pBRP8ZCAQe2bp1a+nvJlZQZ2fnAl3Xv0dEVwFomvBxDsDrRPTr2tra/yi3Rf3jlVVBj7ds2bJPaZq2QNO0ObquD+dyuff9emdKsVauXHl2JpNZEAwGa4QQHwQCgffK7T9gxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGOMMcYA/B+DSS19TZUomwAAAABJRU5ErkJggg==">
  <link rel="apple-touch-icon" sizes="192x192" href="data:image/png;base64,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">
  <link rel="manifest" href="https://wholesale.nkonline-tool.com/public/manifest.json">
  <meta name="theme-color" content="#b8002a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="デタウリ.Detauri">
  <link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.google.com">
  <style>
    html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; color:#111; background:#f6f7f9; -webkit-text-size-adjust:100%; }
    * { box-sizing:border-box; }
    input, select, textarea, button { font-size:16px; }
    .promo-banner{background:linear-gradient(90deg,#b8002a,#e63950);color:#fff;text-align:center;padding:10px 40px 10px 14px;font-size:13px;font-weight:700;position:relative;z-index:21;display:none;}
    .promo-banner a{color:#fff;text-decoration:underline;margin-left:8px;font-weight:900;}
    .promo-banner a:hover{color:#ffd700;}
    .promo-banner .promo-close{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px 8px;opacity:0.8;}
    .promo-banner .promo-close:hover{opacity:1;}
    .mypage-tabs{display:flex;gap:0;border-bottom:2px solid #e0e0e0;margin-bottom:16px;}
    .mypage-tab{background:none;border:none;padding:10px 18px;font-size:14px;font-weight:600;color:#888;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:color .2s,border-color .2s;}
    .mypage-tab:hover{color:#333;}
    .mypage-tab.active{color:#b8002a;border-bottom-color:#b8002a;}
    .mypage-content{min-height:120px;}
    .mp-order-card{border:1px solid #e8e8e8;border-radius:8px;padding:14px;margin-bottom:10px;background:#fafafa;}
    .mp-order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;}
    .mp-order-no{font-weight:700;font-size:14px;color:#333;}
    .mp-order-date{font-size:12px;color:#999;}
    .mp-order-status{font-size:12px;padding:2px 8px;border-radius:10px;font-weight:600;}
    .mp-order-status.done{background:#e8f5e9;color:#2e7d32;}
    .mp-order-status.pending{background:#fff3e0;color:#e65100;}
    .mp-order-status.active{background:#e3f2fd;color:#1565c0;}
    .mp-order-products{font-size:12px;color:#666;line-height:1.5;margin-bottom:6px;}
    .mp-order-footer{display:flex;justify-content:space-between;font-size:13px;flex-wrap:wrap;gap:4px;}
    .mp-order-total{font-weight:700;color:#333;}
    .pw-wrap{position:relative;display:flex;align-items:center;}
    .pw-wrap input{flex:1;padding-right:38px;}
    .pw-toggle{position:absolute;right:6px;background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:0.5;line-height:1;}
    .pw-toggle:hover{opacity:0.8;}
    .pw-toggle.active{opacity:1;}
    .topbar{position:sticky;top:0;z-index:100;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;padding:18px 20px 12px;text-align:center;max-width:1100px;margin:0 auto;}
    .topbar h1{font-size:20px;letter-spacing:2px;font-weight:700;margin:0;color:#fff;}
    .topbar .subtitle{font-size:12px;color:#aab;margin-top:4px;}
    .header-nav{display:flex;justify-content:center;gap:10px;margin-top:12px;}
    .header-nav a{color:#fff;text-decoration:none;font-size:12px;padding:6px 16px;border:1px solid rgba(255,255,255,.3);border-radius:20px;transition:all .2s;}
    .header-nav a.active{background:#ffd700;color:#1a1a2e;border-color:#ffd700;font-weight:700;}
    .header-links{display:flex;justify-content:center;gap:16px;margin-top:10px;}
    .header-links a{color:#93c5fd;text-decoration:none;font-size:12px;font-weight:600;transition:color .2s;}
    .header-links a:hover{color:#bfdbfe;}
    .admin-bar{background:#b8002a;color:#fff;text-align:center;padding:6px 14px;font-size:12px;font-weight:700;letter-spacing:1px;display:none;position:sticky;top:0;z-index:101;}
    .admin-bar span{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:4px;margin-left:8px;font-size:11px;font-weight:400;}
    .admin-bar .admin-exit{background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.5);color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;cursor:pointer;margin-left:10px;}
    .admin-bar .admin-exit:hover{background:rgba(255,255,255,.4);}
    body.admin-mode .topbar{border-top:3px solid #b8002a;}
    @media(min-width:768px){
      .topbar{padding:20px 40px 14px;}
      .topbar h1{font-size:26px;}
      .topbar .subtitle{font-size:13px;}
      .header-nav a{font-size:13px;padding:8px 20px;}
      .header-links a{font-size:13px;}
    }
    .wrap{max-width:1100px;margin:0 auto;padding:12px 14px 90px;}
    .title{font-weight:900;font-size:18px;color:#f1f5f9;}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .field{min-width:170px;flex:1 1 170px;}
    .field.big{min-width:240px;flex:2 1 240px;}
    .controls input,.controls select{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .btn{padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .btn.primary{background:#111;color:#fff;border-color:#111;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,280px));gap:12px;margin-top:12px;justify-content:center;}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));} .card{min-height:auto;} .cardbody{padding:6px 6px;gap:3px;} .noText{font-size:11px;} .brandText{font-size:10px;-webkit-line-clamp:2;} .price{font-size:12px;} .meta{font-size:10px;} .badge{font-size:9px;padding:2px 5px;} .selectBtn{padding:7px 5px;font-size:11px;}}
    .card{background:#fff;border:1px solid #e6e8ee;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;}
    .thumb{width:100%;aspect-ratio:1/1;background:#f0f2f7;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
    .thumb img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center top;display:block;}
    .cardbody{padding:10px 12px;display:flex;flex-direction:column;gap:6px;flex:1;}
    .row1{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;}
    .leftTitle{display:flex;flex-direction:column;gap:2px;min-width:0;font-weight:900;line-height:1.25;}
    .noText{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:900;white-space:nowrap;}
    .brandText{font-weight:900;font-size:13px;line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .defectLine{font-size:11px;min-height:16px;line-height:16px;color:transparent;}
    .defectLine.hasDefect{color:#b8002a;font-weight:700;}
    .price{font-weight:900;color:#b8002a;white-space:nowrap;}
    .meta{font-size:12px;color:#444;line-height:1.35;white-space:pre-line;}
    .badges{display:flex;gap:4px;flex-wrap:nowrap;align-items:center;}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #e6e8ee;background:#f7f8fb;color:#333;}
    .badge.ok{background:#eef7ee;border-color:#cfe9cf;}
    .badge.warn{background:#fff5e6;border-color:#ffe0ad;}
    .badge.lock{background:#ffecec;border-color:#ffd0d0;color:#a40000;}
    .actions{display:flex;gap:10px;align-items:center;}
    .selectBtn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #d9deea;background:#0b6;color:#fff;font-weight:900;cursor:pointer;display:flex;justify-content:center;align-items:center;}
    .selectBtn.off{background:#fff;color:#111;border-color:#d9deea;}
    .selectBtn.disabled{background:#f2f3f6;color:#777;border-color:#e3e5ec;cursor:not-allowed;}
    .pager{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:16px 0 0;}
    .pageBtn{min-width:36px;padding:8px 10px;border:1px solid #d9deea;background:#fff;border-radius:10px;cursor:pointer;font-weight:900;}
    .pageBtn.active{background:#111;color:#fff;border-color:#111;}
    .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(246,247,249,.9);backdrop-filter:blur(8px);border-top:1px solid #e6e8ee;padding:10px 14px;display:flex;justify-content:center;}
    .stickyInner{width:100%;max-width:1200px;display:flex;justify-content:center;align-items:center;gap:10px;}
    .cartBtn{width:100%;max-width:520px;height:46px;border-radius:14px;border:1px solid #4a76b5;background:#5B86C5;color:#fff;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin:0 auto;}
    .countPill{min-width:28px;height:28px;border-radius:999px;background:#fff;color:#2B3A5C;display:flex;align-items:center;justify-content:center;font-weight:900;padding:0 10px;}
    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:40;}
    .overlay.open{display:block;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(860px,94vw);max-height:86vh;background:#fff;border-radius:14px;border:1px solid #e6e8ee;z-index:50;display:none;overflow:hidden;}
    .modal.open{display:block;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modalTitle{font-weight:900;}
    .modalClose{background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1;padding:6px 10px;}
    .modalBody{padding:14px 16px;overflow:auto;max-height:calc(86vh - 56px);}
    .cartList{display:flex;flex-direction:column;gap:8px;}
    .cartRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid #eef0f6;padding:10px 0;}
    .cartImg{width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;background:#f5f5f5;cursor:pointer;}
    .cartInfo{display:flex;gap:10px;align-items:center;min-width:0;flex:1;}
    .cartLeft{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .cartName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline;}
    .cartSub{font-size:12px;color:#666;}
    .dangerBtn{border:1px solid #ff4d4f;color:#ff4d4f;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900;}
    .recommendSection{margin-top:16px;padding-top:16px;border-top:1px solid #eef0f6;}
    .recommendTitle{font-weight:900;font-size:14px;color:#333;margin-bottom:10px;}
    .recommendList{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;}
    .recommendCard{flex-shrink:0;width:100px;cursor:pointer;border:1px solid #eef0f6;border-radius:8px;overflow:hidden;background:#fff;transition:box-shadow .2s;}
    .recommendCard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .recommendCard img{width:100px;height:100px;object-fit:cover;display:block;}
    .recommendCard .rcInfo{padding:6px;font-size:11px;}
    .recommendCard .rcBrand{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .recommendCard .rcPrice{color:#b8002a;font-weight:900;}
    .mainRecommendSection{margin-bottom:20px;padding:16px;background:#f8f9fc;border-radius:12px;}
    .mainRecommendTitle{font-weight:900;font-size:16px;color:#333;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .mainRecommendTitle::before{content:'★';color:#ffc107;}
    .mainRecommendList{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;}
    .mainRecommendList .recommendCard{width:120px;}
    .mainRecommendList .recommendCard img{width:120px;height:120px;}
    .authArea{display:flex;align-items:center;justify-content:center;gap:10px;font-size:13px;margin-top:10px;}
    .authBtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:6px 16px;cursor:pointer;font-weight:700;font-size:12px;color:#fff;transition:all .2s;}
    .authBtn:hover{background:rgba(255,255,255,.2);}
    .authBtn.logout{background:transparent;border:1px solid rgba(255,255,255,.2);color:#94a3b8;text-decoration:none;padding:4px 12px;border-radius:20px;font-size:11px;}
    .authUser{display:flex;align-items:center;gap:8px;}
    .authUserName{font-weight:900;color:#f1f5f9;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .authDiscount{background:#b8002a;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .authPoints{background:#e65100;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;font-weight:900;}
    .authBtn.mypage{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);font-size:11px;padding:4px 12px;border-radius:20px;}
    .footer{background:#1a1a2e;color:#888;text-align:center;padding:20px;font-size:11px;margin-top:40px;}
    .footer a{color:#aab;text-decoration:none;}
    #pageTransition{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);z-index:9999;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity .25s ease;}
    #pageTransition.active,body.page-entering #pageTransition{opacity:1;pointer-events:all;}
    #pageTransition .pt-content{text-align:center;color:#fff;}
    #pageTransition .pt-title{font-size:20px;font-weight:700;letter-spacing:2px;}
    #pageTransition .pt-sub{font-size:12px;color:#aab;margin-top:6px;}
    .cart-summary{background:#f8f9fa;border-radius:12px;padding:14px;margin-top:10px;}
    .cart-row{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid #eee;}
    .cart-row:last-child{border-bottom:none;}
    .cart-row.total{font-weight:800;font-size:16px;color:#1a1a2e;border-top:2px solid #1a1a2e;margin-top:8px;padding-top:12px;border-bottom:none;}
    .hint{font-size:12px;color:#666;line-height:1.45;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:700px){.formGrid{grid-template-columns:1fr;}}
    .formField label{font-size:12px;color:#555;font-weight:900;display:block;margin-bottom:6px;}
    .formField input,.formField select,.formField textarea{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;outline:none;}
    .formField textarea{min-height:90px;resize:vertical;}
    .formActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
    .toast{position:fixed;left:50%;bottom:82px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:12px;display:none;z-index:60;font-weight:900;max-width:92vw;}
    .toast.show{display:block;}
    .admin-settings-fab{position:fixed;left:16px;bottom:76px;z-index:31;width:48px;height:48px;border-radius:50%;background:#b8002a;color:#fff;border:none;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.3);font-size:22px;transition:transform .2s;}
    .admin-settings-fab:hover{transform:scale(1.1);}
    body.admin-mode .admin-settings-fab{display:flex;}
    .settings-panel{position:fixed;left:16px;bottom:136px;z-index:55;width:min(380px,90vw);background:#fff;border-radius:14px;border:1px solid #e6e8ee;box-shadow:0 10px 30px rgba(0,0,0,.25);display:none;overflow:hidden;}
    .settings-panel.open{display:block;}
    .settings-panel .sp-header{padding:12px 14px;border-bottom:1px solid #e6e8ee;display:flex;align-items:center;justify-content:space-between;background:#f8f9fa;}
    .settings-panel .sp-title{font-weight:900;font-size:15px;}
    .settings-panel .sp-close{background:transparent;border:none;font-size:20px;cursor:pointer;padding:4px 8px;line-height:1;}
    .settings-panel .sp-body{padding:12px 14px;overflow:auto;max-height:60vh;}
    .settings-panel .sp-section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid #f0f0f0;}
    .settings-panel .sp-section:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none;}
    .settings-panel .sp-section-title{font-weight:900;font-size:13px;margin-bottom:8px;color:#333;}
    .settings-panel .sp-btn-row{display:flex;gap:8px;flex-wrap:wrap;}
    .settings-panel .sp-btn{padding:8px 10px;border:1px solid #d9deea;border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:12px;}
    .settings-panel .sp-btn.primary{background:#111;color:#fff;border-color:#111;}
    .settings-panel .sp-btn:disabled{opacity:.5;cursor:not-allowed;}
    .settings-panel .sp-mode-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .settings-panel .sp-badge{display:inline-block;padding:3px 8px;border-radius:6px;font-weight:900;font-size:12px;}
    .settings-panel .sp-badge.test{background:#fff3cd;color:#856404;border:1px solid #ffc107;}
    .settings-panel .sp-badge.live{background:#d4edda;color:#155724;border:1px solid #28a745;}
    .settings-panel .sp-badge.on{background:#d4edda;color:#155724;border:1px solid #28a745;}
    .settings-panel .sp-badge.off{background:#f8d7da;color:#721c24;border:1px solid #dc3545;}
    .settings-panel .sp-info{font-size:11px;color:#666;margin-top:4px;}
    .settings-panel .sp-log{font-size:11px;color:#333;white-space:pre-wrap;line-height:1.4;margin-top:8px;max-height:80px;overflow:auto;background:#f8f9fa;border-radius:6px;padding:6px 8px;display:none;}
    .measureWrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .measureBtn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;}
    .measureBtn input{margin:0;}
    .sendingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80;}
    .sendingOverlay.on{display:flex;}
    .sendingBox{background:#fff;border:1px solid #e6e8ee;border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .sendingSpinner{width:26px;height:26px;border-radius:999px;border:3px solid rgba(0,0,0,.15);border-top-color:#111;animation:sendingSpin 0.9s linear infinite;}
    .sendingText{font-weight:900;font-size:14px;color:#111;}
    @keyframes sendingSpin{to{transform:rotate(360deg);}}
    .selectFieldBtn{width:100%;padding:10px 12px;border:1px solid #d9deea;border-radius:10px;background:#fff;cursor:pointer;font-weight:900;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .selectFieldBtn .muted{font-weight:900;color:#666;font-size:12px;}
    .brandTools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .brandTools input{flex:1 1 240px;min-width:200px;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;font-size:14px;transition:border-color .2s,box-shadow .2s;}
    .brandTools input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .brandToolsBar{background:#fff;border-bottom:1px solid #eef0f6;padding:14px 16px 12px;}
    .brandIndexNav{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;padding-bottom:8px;}
    .brandIndexBtn{padding:6px 10px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
    .brandIndexBtn:hover{background:#e2e8f0;}
    .brandIndexBtn.active{background:#3b82f6;color:#fff;}
    .brandIndexBtn.filter-active{background:#10b981;color:#fff;}
    .brandGroupHeader{padding:12px 16px;margin:8px -16px 8px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);font-size:16px;font-weight:900;color:#1e293b;display:flex;align-items:center;gap:8px;}
    .brandGroupHeader::before{content:'';width:4px;height:20px;background:linear-gradient(180deg,#3b82f6,#8b5cf6);border-radius:2px;}
    .brandList{display:flex;flex-direction:column;gap:4px;padding-top:8px;}
    .brandItem{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:#fff;cursor:pointer;user-select:none;transition:all .15s;}
    .brandItem:hover{background:#f8fafc;}
    .brandItem.selected{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;}
    .brandItem input{display:none;}
    .brandItem .brand-check{width:22px;height:22px;border:2px solid #cbd5e1;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .brandItem.selected .brand-check{background:#3b82f6;border-color:#3b82f6;}
    .brandItem .brand-check::after{content:'✓';color:#fff;font-size:13px;font-weight:700;opacity:0;transition:opacity .15s;}
    .brandItem.selected .brand-check::after{opacity:1;}
    .brandName{font-weight:600;line-height:1.3;word-break:break-word;color:#334155;}
    .toTop{position:fixed;right:14px;bottom:144px;width:46px;height:46px;border-radius:999px;border:1px solid #d9deea;background:#fff;display:none;align-items:center;justify-content:center;font-weight:900;z-index:70;box-shadow:0 6px 18px rgba(0,0,0,.12);transition:all .3s ease;}
    .toTop.show{display:flex;}
    .toTop.chatbot-open{right:auto;left:auto;bottom:auto;position:static;}
    .price-old { text-decoration: line-through; color:#999; }
    .price-new { color:#b8002a; font-weight:700; }
    /* フィルタ・ソート — フラットツールバー */
    .filter-sort-section{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px 0;margin-bottom:12px;}
    .filter-divider{width:1px;height:24px;background:#e2e8f0;margin:0 4px;flex-shrink:0;}
    .multiSelectField{position:relative;}
    .multiSelectBtn{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px;transition:all .15s;color:#475569;white-space:nowrap;}
    .multiSelectBtn:hover{border-color:#cbd5e1;background:#f8fafc;}
    .multiSelectBtn.active{border-color:#3b82f6;background:#eff6ff;color:#3b82f6;}
    .multiSelectBtn .filterCount{background:#3b82f6;color:#fff;font-size:10px;min-width:18px;height:18px;padding:0 5px;border-radius:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}
    .multiSelectBtn .filterCount:empty{display:none;}
    .multiSelectBtn .chevron{font-size:10px;opacity:.4;transition:transform .2s;}
    .multiSelectDropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;min-width:180px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.1);z-index:100;max-height:240px;overflow-y:auto;padding:4px;}
    .multiSelectDropdown.open{display:block;animation:ddIn .15s ease;}
    @keyframes ddIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
    .multiSelectItem{display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;font-size:13px;border-radius:8px;transition:background .1s;color:#334155;}
    .multiSelectItem:hover{background:#f1f5f9;}
    .multiSelectItem.selected{background:#eff6ff;color:#3b82f6;font-weight:600;}
    .multiSelectItem input{display:none;}
    .multiSelectItem .check-icon{width:18px;height:18px;border:1.5px solid #cbd5e1;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .multiSelectItem.selected .check-icon{background:#3b82f6;border-color:#3b82f6;color:#fff;}
    .multiSelectItem .check-icon::after{content:'✓';font-size:11px;opacity:0;transition:opacity .15s;}
    .multiSelectItem.selected .check-icon::after{opacity:1;}
    .sort-chip{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px;transition:all .15s;color:#475569;white-space:nowrap;}
    .sort-chip:hover{border-color:#cbd5e1;background:#f8fafc;}
    .sort-chip.active{border-color:#8b5cf6;background:#f5f3ff;color:#7c3aed;}
    .sort-chip .chevron{font-size:10px;opacity:.4;}
    .sort-item{padding:8px 12px;cursor:pointer;font-size:13px;border-radius:8px;transition:background .1s;color:#334155;}
    .sort-item:hover{background:#f1f5f9;}
    .sort-item.selected{background:#f5f3ff;color:#7c3aed;font-weight:600;}
    .sort-dir-toggle{width:36px;height:36px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;color:#64748b;}
    .sort-dir-toggle:hover{border-color:#cbd5e1;background:#f8fafc;}
    .btn-reset-pill{height:36px;padding:0 14px;border:1.5px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:12px;color:#94a3b8;transition:all .15s;white-space:nowrap;}
    .btn-reset-pill:hover{border-color:#fca5a5;color:#ef4444;background:#fef2f2;}
    .detail-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center; }
    .detail-modal-overlay.active { display: flex; }
    .detail-modal { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .detail-modal-close { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
    .detail-modal-image { width: 100%; max-height: 300px; object-fit: contain; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-modal-content { padding: 20px; }
    .detail-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
    .detail-section { margin-bottom: 16px; }
    .detail-section-title { font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
    .detail-defect { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 14px; color: #92400e; }
    .measurement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    .measurement-item { background: #f3f4f6; border-radius: 6px; padding: 8px 12px; text-align: center; }
    .measurement-label { font-size: 12px; color: #6b7280; }
    .measurement-value { font-size: 16px; font-weight: 600; color: #111827; }
    .detail-modal-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }
    .detail-add-btn { flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .detail-add-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .detail-loading { display: flex; justify-content: center; align-items: center; min-height: 100px; color: #6b7280; }
    .product-image-clickable { cursor: zoom-in; }
    .detail-info-grid { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-bottom: 8px; }
    .detail-info-item { font-size: 14px; color: #374151; background: #f9fafb; padding: 4px 10px; border-radius: 6px; }
    .detail-info-label { font-weight: 600; color: #6b7280; }

    /* ===== Image Zoom (Amazon-style) ===== */
    .detail-zoom-wrap { position: relative; cursor: zoom-in; background: #f9fafb; border-radius: 12px 12px 0 0; }
    .detail-zoom-wrap img.detail-modal-image { pointer-events: none; }
    .detail-zoom-lens { display: none; position: absolute; width: 120px; height: 120px; border: 2.5px solid rgba(59,130,246,.7); border-radius: 8px; pointer-events: none; z-index: 2; background: rgba(59,130,246,.08); box-sizing: border-box; transform: translate(-50%, -50%); }
    .detail-zoom-result { display: none; position: fixed; width: 300px; height: 300px; border: 1px solid #e5e7eb; border-radius: 12px; background-repeat: no-repeat; background-color: #fff; box-shadow: 0 8px 30px rgba(0,0,0,.18); z-index: 10001; overflow: hidden; pointer-events: none; }
    /* lens display is controlled by JS to only show over actual image */
    .detail-zoom-hint { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color: #fff; font-size: 11px; padding: 3px 10px; border-radius: 12px; pointer-events: none; z-index: 3; white-space: nowrap; transition: opacity .3s; }
    .detail-zoom-wrap:hover .detail-zoom-hint { opacity: 0; }

    /* Mobile: zoom result inside overlay instead of side-by-side */
    @media (max-width: 700px) {
      .detail-zoom-wrap { cursor: pointer; }
      .detail-zoom-lens, .detail-zoom-result { display: none !important; }
      .detail-zoom-hint-mobile { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color: #fff; font-size: 11px; padding: 3px 10px; border-radius: 12px; pointer-events: none; z-index: 3; white-space: nowrap; }
    }
    @media (min-width: 701px) {
      .detail-zoom-hint-mobile { display: none; }
    }

    /* Fullscreen image viewer (mobile) */
    .fullscreen-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.92); z-index: 10002; justify-content: center; align-items: center; flex-direction: column; }
    .fullscreen-viewer.active { display: flex; }
    .fullscreen-viewer img { max-width: 100%; max-height: 85vh; object-fit: contain; touch-action: pinch-zoom; user-select: none; -webkit-user-select: none; transition: transform .2s ease; }
    .fullscreen-viewer-close { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,.2); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10003; backdrop-filter: blur(4px); }
    .fullscreen-viewer-hint { color: rgba(255,255,255,.6); font-size: 13px; margin-top: 12px; }

    /* === Shipping Table Scroll Indicator === */
    .shipping-scroll-wrap{position:relative;}
    .shipping-scroll-wrap.can-scroll-right::after{content:'';position:absolute;top:0;right:0;width:32px;height:100%;background:linear-gradient(to right,transparent,rgba(0,0,0,.08));pointer-events:none;border-radius:0 4px 4px 0;transition:opacity .2s;}
    .shipping-scroll-wrap.scrolled-end::after{opacity:0;}
    .shipping-scroll-hint{display:none;text-align:center;font-size:11px;color:#94a3b8;margin-top:4px;animation:scrollHintPulse 2s ease-in-out infinite;}
    .shipping-scroll-wrap.can-scroll-right+.shipping-scroll-hint{display:block;}
    @keyframes scrollHintPulse{0%,100%{opacity:.6;}50%{opacity:1;}}
    /* === AI Chatbot Widget === */
    .chatbot-fab{position:fixed;bottom:80px;right:16px;z-index:9999;width:56px;height:56px;border-radius:50%;background:#1e293b;color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;transition:transform .2s,background .2s;}
    .chatbot-fab:hover{transform:scale(1.08);background:#334155;}
    .chatbot-fab svg{width:28px;height:28px;fill:#fff;}
    .chatbot-fab .chatbot-fab-close{display:none;}
    .chatbot-badge{position:absolute;top:-2px;right:-2px;width:18px;height:18px;border-radius:50%;background:#ef4444;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .2s;}
    .chatbot-badge.show{opacity:1;}
    .chatbot-panel{position:fixed;bottom:148px;right:16px;z-index:9998;width:360px;max-width:calc(100vw - 32px);height:480px;max-height:calc(100vh - 200px);background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.18);display:none;flex-direction:column;overflow:hidden;border:1px solid #e6e8ee;}
    .chatbot-panel.open{display:flex;}
    .chatbot-header{background:#1e293b;color:#fff;padding:14px 16px;font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px;flex-shrink:0;position:relative;}
    .chatbot-header-actions{display:flex;align-items:center;gap:6px;margin-left:auto;}
    .chatbot-header-toTop{width:30px;height:30px;border-radius:50%;border:1.5px solid rgba(255,255,255,.35);background:transparent;color:#fff;font-weight:900;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .chatbot-header-toTop:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.6);}
    .chatbot-close-btn{width:30px;height:30px;border-radius:50%;border:1.5px solid rgba(255,255,255,.35);background:transparent;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;line-height:1;}
    .chatbot-close-btn:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.6);}
    .chatbot-header svg{width:20px;height:20px;fill:#fff;flex-shrink:0;}
    .chatbot-messages{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;}
    .chatbot-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55;word-break:break-word;white-space:pre-wrap;}
    .chatbot-msg.bot{align-self:flex-start;background:#f1f5f9;color:#1e293b;border-bottom-left-radius:4px;}
    .chatbot-msg.user{align-self:flex-end;background:#1e293b;color:#fff;border-bottom-right-radius:4px;}
    .chatbot-msg.typing{align-self:flex-start;background:#f1f5f9;padding:10px 18px;}
    .chatbot-msg.typing .dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#94a3b8;margin:0 2px;animation:chatDot 1.4s infinite both;}
    .chatbot-msg.typing .dot:nth-child(2){animation-delay:.2s;}
    .chatbot-msg.typing .dot:nth-child(3){animation-delay:.4s;}
    @keyframes chatDot{0%,80%,100%{opacity:.3;transform:scale(.8);}40%{opacity:1;transform:scale(1);}}
    .chatbot-input-area{display:flex;gap:8px;padding:10px 12px;border-top:1px solid #e6e8ee;background:#fafbfc;flex-shrink:0;}
    .chatbot-input-area textarea{flex:1;border:1px solid #d9deea;border-radius:10px;padding:9px 12px;font-size:13px;resize:none;outline:none;font-family:inherit;min-height:38px;max-height:80px;line-height:1.4;}
    .chatbot-input-area textarea:focus{border-color:#1e293b;}
    .chatbot-send-btn{width:38px;height:38px;border-radius:10px;border:none;background:#1e293b;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s;}
    .chatbot-send-btn:hover{background:#334155;}
    .chatbot-send-btn:disabled{opacity:.4;cursor:not-allowed;}
    .chatbot-send-btn svg{width:18px;height:18px;fill:#fff;}
    .chatbot-quick-replies{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
    .chatbot-quick-btn{display:inline-block;padding:7px 13px;border-radius:18px;border:1.5px solid #e2e8f0;background:#fff;color:#334155;font-size:12px;cursor:pointer;transition:all .15s;white-space:nowrap;font-weight:500;line-height:1.3;}
    .chatbot-quick-btn:hover{background:#eff6ff;border-color:#93c5fd;color:#2563eb;}
    .chatbot-quick-btn:active{transform:scale(.96);}
    .chatbot-quick-category{font-size:11px;color:#64748b;font-weight:600;margin-top:8px;margin-bottom:2px;padding-left:2px;}
    .chatbot-quick-category:first-child{margin-top:0;}
    .chatbot-contact-link{display:inline-flex;align-items:center;gap:4px;margin-top:10px;padding:8px 16px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;color:#dc2626;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;text-decoration:none;}
    .chatbot-contact-link:hover{background:#fee2e2;border-color:#f87171;}
    @media(max-width:480px){.chatbot-panel{bottom:0;right:0;left:0;width:100%;max-width:100%;height:100%;max-height:100%;border-radius:0;}.chatbot-fab{bottom:72px;right:12px;width:50px;height:50px;}.chatbot-fab svg{width:24px;height:24px;}}
  </style>
</head>
<body>
<script>
// ページ遷移フラッシュ防止: 遷移フラグがあればbody背景を暗くしオーバーレイ表示
(function(){try{if(sessionStorage.getItem('_pageTransition')==='1'){document.body.style.background='#1a1a2e';document.body.classList.add('page-entering');sessionStorage.removeItem('_pageTransition');}}catch(e){}})();
// クライアントサイドルーター: ?page=bulk の場合、BulkLP.htmlを動的に読み込む
// 1. localStorageにキャッシュ済みHTML → 即座に表示（GAS API不要）
// 2. 初回のみGAS APIから取得 → キャッシュに保存
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('page') !== 'bulk') return;

  var BULK_HTML_KEY = 'bulk_html_cache_v7';
  var BULK_HTML_TTL = 24 * 60 * 60 * 1000; // 24時間
  var GAS_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';

  // デタウリページの描画を完全に抑制 + 背景を暗色化
  var hideStyle = document.createElement('style');
  hideStyle.textContent = 'body{background:#1a1a2e !important;} body > *:not(#__bulkLoader) { display: none !important; }';
  document.head.appendChild(hideStyle);

  // localStorageキャッシュを確認
  var cachedHtml = null;
  try {
    var raw = localStorage.getItem(BULK_HTML_KEY);
    if (raw) {
      var c = JSON.parse(raw);
      if (c && c.html && c.ts && (Date.now() - c.ts < BULK_HTML_TTL)) {
        cachedHtml = c.html;
      }
    }
  } catch (e) {}

  if (cachedHtml) {
    // キャッシュあり → DOMContentLoaded後に即座にBulkLPを表示
    // （hideStyleで背景は暗色、コンテンツは非表示のため白フラッシュなし）
    // 追加保護: <html>タグにも背景色を注入
    var safeHtml = cachedHtml.replace(/<html([^>]*)>/, '<html$1 style="background:#1a1a2e">');
    window.addEventListener('DOMContentLoaded', function() {
      document.open();
      document.write(safeHtml);
      document.close();
    });
    return;
  }

  // キャッシュなし → GAS APIからフェッチしてキャッシュに保存
  window.addEventListener('DOMContentLoaded', function() {
    var loader = document.createElement('div');
    loader.id = '__bulkLoader';
    loader.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;min-height:100vh;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a2e;color:#fff;"><div style="text-align:center;"><div style="width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#ffd700;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px;"></div><div style="font-size:20px;font-weight:700;margin-bottom:8px;">アソート商品</div><div style="font-size:13px;color:#aaa;">読み込み中...</div></div></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
    document.body.insertBefore(loader, document.body.firstChild);

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'apiBulkPage', args: [] }),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      if (data && data.ok && data.html) {
        // HTMLをlocalStorageにキャッシュ（次回即時表示のため）
        try {
          localStorage.setItem(BULK_HTML_KEY, JSON.stringify({ ts: Date.now(), html: data.html }));
        } catch (e) {}
        document.open();
        document.write(data.html);
        document.close();
      } else {
        throw new Error(data && data.message ? data.message : '読み込みに失敗しました');
      }
    })
    .catch(function(err) {
      var el = document.getElementById('__bulkLoader');
      if (el) el.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;min-height:100vh;font-family:sans-serif;background:#1a1a2e;color:#ff6b6b;"><div style="text-align:center;"><div style="font-size:18px;margin-bottom:12px;">読み込みエラー</div><div style="font-size:14px;">' + (err.message || 'エラーが発生しました') + '</div><div style="margin-top:20px;"><a href="./" style="color:#93c5fd;font-size:14px;">デタウリに戻る</a></div></div></div>';
    });
  });
})();
</script>
  <div class="admin-bar" id="adminBar">管理者モード<span>受付番号紐付け</span><button class="admin-exit" id="adminExit" type="button">管理者モード解除</button></div>
  <button class="admin-settings-fab" id="adminSettingsFab" type="button" title="管理設定">&#9881;</button>
  <div class="settings-panel" id="settingsPanel">
    <div class="sp-header">
      <div class="sp-title">管理設定</div>
      <button class="sp-close" id="settingsClose" type="button">&times;</button>
    </div>
    <div class="sp-body">
      <div class="sp-section">
        <div class="sp-section-title">管理</div>
        <div class="sp-btn-row">
          <button class="sp-btn primary" id="spBtnCompact" type="button">期限切れ確保の整理</button>
          <button class="sp-btn" id="spBtnRebuild" type="button">状態の再構築</button>
        </div>
        <div class="sp-btn-row" style="margin-top:6px;">
          <button class="sp-btn" id="spBtnClearCache" type="button">商品キャッシュ削除</button>
          <button class="sp-btn" id="spBtnApplyDv" type="button">ステータスのプルダウン適用</button>
        </div>
        <div class="sp-log" id="spLog"></div>
      </div>
      <div class="sp-section">
        <div class="sp-section-title">KOMOJU 決済モード</div>
        <div class="sp-mode-row">
          <span class="sp-badge" id="spModeBadge">読込中...</span>
          <button class="sp-btn primary" id="spBtnToggleMode" type="button" disabled>切替</button>
        </div>
        <div class="sp-info" id="spModeKeys"></div>
      </div>
      <div class="sp-section">
        <div class="sp-section-title">会員割引</div>
        <div class="sp-mode-row">
          <span class="sp-badge" id="spDiscountBadge">読込中...</span>
          <button class="sp-btn primary" id="spBtnToggleDiscount" type="button" disabled>切替</button>
        </div>
        <div class="sp-info" id="spDiscountInfo"></div>
      </div>
    </div>
  </div>
  <div id="pageTransition"><div class="pt-content"><div class="pt-title">デタウリ.Detauri</div><div class="pt-sub">読み込み中...</div></div></div>
  <div class="promo-banner" id="promoBanner">
    期間限定：会員登録で全品<strong>10%OFF</strong>（2026年9月末まで・30点割引と併用可）<a href="#" id="promoRegisterLink">今すぐ無料登録 ＞</a>
    <button class="promo-close" id="promoClose" type="button">✕</button>
  </div>
  <div class="topbar">
    <h1 id="appTitle">デタウリ.Detauri</h1>
    <p class="subtitle">古着卸売 - 副業物販のための仕入れ</p>
    <nav class="header-nav">
      <a class="active" href="#">採寸付き個品（デタウリ）</a>
      <a href="?page=bulk" id="bulkLink" target="_top" onclick="navigateToBulk(event)">アソート商品</a>
    </nav>
    <div class="header-links">
      <a href="#" id="openGuideLink">商品ガイド</a>
      <a href="#" id="openShippingLink">デタウリ送料表</a>
      <a href="#" id="openContactLink">お問い合わせ</a>
    </div>
    <div class="authArea" id="authArea">
      <button class="authBtn" id="openAuthBtn" type="button">ログイン / 新規登録</button>
    </div>
    <div class="badge ok" id="totalCountBadge" style="display:inline-block;margin-top:8px;"></div>
  </div>

  <div class="wrap">
    <div class="filter-sort-section">
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="brandBtn" type="button"><span id="brandBtnText">ブランド</span> <span class="filterCount" id="brandBtnSub"></span><span class="chevron">▾</span></button>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fCategoryBtn" type="button">カテゴリ <span class="filterCount"></span><span class="chevron">▾</span></button>
        <div class="multiSelectDropdown" id="fCategoryDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fStateBtn" type="button">状態 <span class="filterCount"></span><span class="chevron">▾</span></button>
        <div class="multiSelectDropdown" id="fStateDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fGenderBtn" type="button">性別 <span class="filterCount"></span><span class="chevron">▾</span></button>
        <div class="multiSelectDropdown" id="fGenderDropdown"></div>
      </div>
      <div class="multiSelectField">
        <button class="multiSelectBtn" id="fSizeBtn" type="button">サイズ <span class="filterCount"></span><span class="chevron">▾</span></button>
        <div class="multiSelectDropdown" id="fSizeDropdown"></div>
      </div>
      <div class="filter-divider"></div>
      <div class="multiSelectField">
        <button class="sort-chip" id="sortChipBtn" type="button"><span id="sortChipLabel">標準</span><span class="chevron">▾</span></button>
        <div class="multiSelectDropdown" id="sortDropdown"></div>
      </div>
      <button class="sort-dir-toggle" id="sortDirToggle" type="button" title="並べ替え方向">↑</button>
      <button class="btn-reset-pill" id="btnReset" type="button">リセット</button>
    </div>
    <!-- メイン画面おすすめ商品 -->
    <div class="mainRecommendSection" id="mainRecommend" style="display:none;">
      <div class="mainRecommendTitle">おすすめ商品</div>
      <div class="mainRecommendList" id="mainRecommendList"></div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pager" class="pager"></div>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <button class="cartBtn" id="openCartBtn" type="button">
       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:22px;height:22px;flex-shrink:0;"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
       <span class="countPill" id="cartCount">0</span>
       <span id="cartTotal" style="font-weight:900; margin-left:8px;">0円</span>
      </button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="modal" id="brandModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">ブランド選択</div>
      <button class="modalClose" id="brandCloseBtn" aria-label="close">×</button>
    </div>
    <div class="brandToolsBar">
      <div class="brandTools">
        <input id="brandSearch" type="text" placeholder="ブランド名を検索（例：ナイキ、NIKE）">
        <button class="btn" id="brandClearBtn" type="button">クリア</button>
        <button class="btn primary" id="brandApplyBtn" type="button">適用</button>
      </div>
      <div class="hint" style="margin-top:8px;" id="brandHint"></div>
      <div class="brandIndexNav" id="brandIndexNav"></div>
    </div>
    <div class="modalBody" style="max-height:calc(86vh - 180px);">
      <div id="brandList" class="brandList"></div>
    </div>
  </div>

  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="cartModalTitle">カート</div>
      <button class="modalClose" id="cartCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div class="cartList" id="cartList"></div>
      <!-- おすすめ商品 -->
      <div class="recommendSection" id="cartRecommend" style="display:none;">
        <div class="recommendTitle">おすすめ商品</div>
        <div class="recommendList" id="cartRecommendList"></div>
      </div>
      <div id="cartSumBox">
        <div class="cart-summary" id="cartSummaryRows"></div>
        <div id="shippingNote" style="display:none;font-size:11px;color:#888;text-align:right;width:100%;margin-top:6px;">※送料は税込み・会員割引対象外です</div>
        <div id="paymentFeeNote" style="display:none;font-size:11px;color:#888;text-align:right;width:100%;line-height:1.5;margin-top:2px;">※コンビニ決済は別途手数料220円（税込）がかかります<br>※銀行振込・ペイジーの振込手数料はお客様負担です</div>
        <div id="remoteIslandWarning" style="display:none;font-size:13px;color:#b8002a;text-align:right;width:100%;font-weight:600;"></div>
        <div id="cartActions" style="display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; width:100%; margin-top:10px;">
          <div id="cartClearBtns" style="display:flex;gap:6px;flex-wrap:wrap;margin-right:auto;"></div>
          <button class="btn primary" id="goFormBtn" style="min-width:220px;" type="button">購入手続きへ</button>
        </div>
      </div>
      <!-- お届け先情報（初期非表示、「購入手続きへ」で表示） -->
      <div id="cartFormSection" style="display:none;">
        <div style="border-top:1px solid #e0e0e0;margin:16px 0 12px;"></div>
        <div style="font-weight:700;font-size:15px;margin-bottom:10px;">お届先情報</div>
        <div class="formGrid">
          <div class="formField">
            <label>会社名/氏名 *</label>
            <input id="companyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="contact" type="email" autocomplete="email" placeholder="example@example.com">
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <div style="display:flex;gap:10px;">
              <div style="flex:.4;">
                <label>郵便番号 *</label>
                <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="0000000" style="width:100%;padding:6px 10px;border:1px solid #e0e0e0;border-radius:8px;font-size:14px;">
              </div>
              <div style="flex:.6;">
                <label>電話番号 *</label>
                <input id="phone" type="tel" inputmode="numeric" placeholder="00000000000" autocomplete="tel" style="width:100%;padding:6px 10px;border:1px solid #e0e0e0;border-radius:8px;font-size:14px;">
              </div>
            </div>
          </div>
          <div class="formField">
            <label>住所 *</label>
            <input id="address" type="text" autocomplete="street-address">
          </div>
          <div class="formField">
            <label>備考</label>
            <textarea id="note"></textarea>
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="invoiceReceipt" style="width:18px;height:18px;">
              <span>インボイス付き領収書を希望する</span>
            </label>
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label>クーポンコード</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="couponCode" type="text" placeholder="クーポンコードを入力" style="width:200px;text-transform:uppercase;">
              <button class="btn primary" id="applyCouponBtn" type="button" style="font-size:12px;padding:4px 12px;">適用</button>
              <button class="btn" id="removeCouponBtn" type="button" style="font-size:12px;padding:4px 10px;display:none;">解除</button>
            </div>
            <div id="couponInfo" style="font-size:12px;margin-top:4px;"></div>
            <p style="font-size:12px;margin:6px 0 0;color:#c00;font-weight:700;">2月末まで「FREE_SHIPPING_20260228」を入力で送料無料</p>
          </div>
          <div class="formField" id="pointUseSection" style="display:none;grid-column:1/-1;">
            <label>ポイント利用 <span id="pointAvailable" style="font-weight:400;color:#888;"></span></label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="usePoints" type="number" min="0" value="0" style="width:120px;" inputmode="numeric">
              <span style="font-size:13px;color:#666;">pt（1pt = 1円）</span>
              <button class="btn" id="useAllPointsBtn" type="button" style="font-size:12px;padding:4px 10px;">全額使用</button>
              <button class="btn primary" id="applyPointsBtn" type="button" style="font-size:12px;padding:4px 12px;">変更を適用</button>
            </div>
            <div id="pointDiscountInfo" style="font-size:12px;color:#b8002a;margin-top:4px;"></div>
          </div>
        </div>
        <div class="formActions">
          <button class="btn" id="formBackBtn" type="button">カートに戻る</button>
          <button class="btn primary" id="submitBtn" type="button">決済に進む</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ログイン/登録モーダル -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="authModalTitle">ログイン</div>
      <button class="modalClose" id="authCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <!-- ログインフォーム -->
      <div id="loginForm">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="loginEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>パスワード *</label>
            <div class="pw-wrap"><input id="loginPassword" type="password" autocomplete="current-password"><button type="button" class="pw-toggle" data-target="loginPassword">&#x1F441;</button></div>
          </div>
          <div class="formField" style="margin-top:-4px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:400;font-size:13px;">
              <input type="checkbox" id="rememberMe" style="width:16px;height:16px;">
              ログイン状態を保持する（30日間）
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="loginBtn" type="button">ログイン</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            アカウントをお持ちでない方は <a href="#" id="showRegisterLink">新規登録</a>
          </div>
          <div style="text-align:center;margin-top:8px;font-size:12px;color:#888;">
            <a href="#" id="showForgotPasswordLink" style="color:#666;">パスワードを忘れた方</a>
            <span style="margin:0 6px;">|</span>
            <a href="#" id="showForgotEmailLink" style="color:#666;">メールアドレスを忘れた方</a>
          </div>
        </div>
      </div>
      <!-- パスワードリセットフォーム -->
      <div id="forgotPasswordForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">登録済みのメールアドレスを入力してください。仮パスワードをメールでお送りします。</p>
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="resetEmail" type="email" autocomplete="email">
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="resetPasswordBtn" type="button">仮パスワードを送信</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            <a href="#" id="backToLoginFromReset">ログインに戻る</a>
          </div>
        </div>
      </div>
      <!-- メールアドレス確認フォーム -->
      <div id="forgotEmailForm" style="display:none;">
        <p style="font-size:13px;color:#555;margin:0 0 14px;">ご登録時の会社名/氏名と電話番号を入力してください。登録メールアドレスのヒントを表示します。</p>
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>会社名/氏名 *</label>
            <input id="recoverCompanyName" type="text">
          </div>
          <div class="formField">
            <label>電話番号 *</label>
            <input id="recoverPhone" type="tel" inputmode="numeric">
          </div>
        </div>
        <div id="recoverEmailResult" style="display:none;margin:12px 0;padding:12px;background:#f0f7ff;border-radius:6px;font-size:14px;text-align:center;"></div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;">
          <button class="btn primary" id="recoverEmailBtn" type="button">メールアドレスを確認</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            <a href="#" id="backToLoginFromRecover">ログインに戻る</a>
          </div>
        </div>
      </div>
      <!-- 登録フォーム -->
      <div id="registerForm" style="display:none;">
        <div class="formGrid">
          <div class="formField">
            <label>メールアドレス *</label>
            <input id="regEmail" type="email" autocomplete="email">
          </div>
          <div class="formField">
            <label>パスワード（6文字以上） *</label>
            <div class="pw-wrap"><input id="regPassword" type="password" autocomplete="new-password"><button type="button" class="pw-toggle" data-target="regPassword">&#x1F441;</button></div>
          </div>
          <div class="formField">
            <label>会社名/氏名 *</label>
            <input id="regCompanyName" type="text" autocomplete="name">
          </div>
          <div class="formField">
            <label>電話番号</label>
            <input id="regPhone" type="tel" inputmode="numeric">
          </div>
          <div class="formField">
            <label>郵便番号</label>
            <input id="regPostal" type="text" inputmode="numeric" placeholder="0000000">
          </div>
          <div class="formField">
            <label>住所</label>
            <input id="regAddress" type="text" autocomplete="street-address">
          </div>
          <div class="formField" style="grid-column:1/-1;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
              <input type="checkbox" id="regNewsletter" checked style="width:18px;height:18px;">
              <span>お得な情報をメールで受け取る</span>
            </label>
          </div>
        </div>
        <div class="formActions" style="flex-direction:column;align-items:stretch;margin-top:14px;">
          <button class="btn primary" id="registerBtn" type="button">登録する</button>
          <div style="text-align:center;margin-top:12px;font-size:13px;">
            既にアカウントをお持ちの方は <a href="#" id="showLoginLink">ログイン</a>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- マイページモーダル -->
  <div class="modal" id="myPageModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle">マイページ</div>
      <button class="modalClose" id="myPageCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div class="mypage-tabs">
        <button class="mypage-tab active" data-tab="profile" type="button">プロフィール</button>
        <button class="mypage-tab" data-tab="orders" type="button">注文履歴</button>
        <button class="mypage-tab" data-tab="points" type="button">ポイント</button>
      </div>

      <!-- プロフィールタブ -->
      <div class="mypage-content" id="mypageProfile">
        <div class="formGrid" style="grid-template-columns:1fr;">
          <div class="formField">
            <label>メールアドレス</label>
            <input id="mpEmail" type="email" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>会社名/氏名 *</label>
            <input id="mpCompanyName" type="text" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>電話番号</label>
            <input id="mpPhone" type="tel" inputmode="numeric" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>郵便番号</label>
            <input id="mpPostal" type="text" inputmode="numeric" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label>住所</label>
            <input id="mpAddress" type="text" readonly style="background:#f5f5f5;">
          </div>
          <div class="formField">
            <label style="font-size:12px;color:#999;">登録日: <span id="mpRegisteredAt">-</span></label>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="mpEditBtn" type="button">編集</button>
          <button class="btn primary" id="mpSaveBtn" type="button" style="display:none;">変更を保存</button>
          <button class="btn" id="mpCancelEditBtn" type="button" style="display:none;">キャンセル</button>
          <button class="btn" id="mpTogglePasswordBtn" type="button">パスワード変更</button>
        </div>
        <div id="mpPasswordSection" style="display:none;margin-top:14px;padding:14px;background:#f9f9f9;border-radius:8px;">
          <div class="formGrid" style="grid-template-columns:1fr;">
            <div class="formField"><label>現在のパスワード *</label><div class="pw-wrap"><input id="mpCurPass" type="password"><button type="button" class="pw-toggle" data-target="mpCurPass">&#x1F441;</button></div></div>
            <div class="formField"><label>新しいパスワード（6文字以上） *</label><div class="pw-wrap"><input id="mpNewPass" type="password"><button type="button" class="pw-toggle" data-target="mpNewPass">&#x1F441;</button></div></div>
            <div class="formField"><label>新しいパスワード（確認） *</label><div class="pw-wrap"><input id="mpNewPassConfirm" type="password"><button type="button" class="pw-toggle" data-target="mpNewPassConfirm">&#x1F441;</button></div></div>
          </div>
          <button class="btn primary" id="mpChangePassBtn" type="button" style="margin-top:10px;">パスワードを変更</button>
        </div>
      </div>

      <!-- 注文履歴タブ -->
      <div class="mypage-content" id="mypageOrders" style="display:none;">
        <div id="mpOrderList" style="font-size:13px;color:#666;">読み込み中...</div>
      </div>

      <!-- ポイント・統計タブ -->
      <div class="mypage-content" id="mypagePoints" style="display:none;">
        <!-- ランクカード -->
        <div id="mpRankCard" style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:12px;padding:20px;color:#fff;margin-bottom:16px;position:relative;overflow:hidden;">
          <div style="font-size:11px;opacity:0.7;">現在のランク</div>
          <div id="mpRankName" style="font-size:28px;font-weight:900;margin:4px 0;">-</div>
          <div id="mpRankPointRate" style="font-size:13px;opacity:0.9;">ポイント還元率: -</div>
          <div id="mpRankBenefits" style="font-size:12px;opacity:0.8;margin-top:4px;"></div>
          <div id="mpRankProgress" style="margin-top:12px;"></div>
        </div>

        <div style="text-align:center;padding:16px 0;">
          <div style="font-size:13px;color:#888;">ポイント残高</div>
          <div id="mpPointBalance" style="font-size:40px;font-weight:bold;color:#b8002a;margin:8px 0;">0</div>
          <div style="font-size:12px;color:#aaa;">1ポイント = 1円としてご利用いただけます</div>
        </div>
        <div style="border-top:1px solid #eee;padding-top:16px;margin-top:8px;">
          <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">ご利用状況</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">累計注文回数</div>
              <div id="mpTotalOrders" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">年間購入金額</div>
              <div id="mpTotalSpent" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">累計購入点数</div>
              <div id="mpTotalItems" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
            <div style="background:#f8fafc;border-radius:8px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:#888;">会員ランク</div>
              <div id="mpMemberRank" style="font-size:22px;font-weight:bold;color:#1e293b;margin-top:4px;">-</div>
            </div>
          </div>
        </div>

        <!-- ランク制度説明 -->
        <div style="border-top:1px solid #eee;padding-top:16px;margin-top:16px;">
          <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">ランク・ポイント制度</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;">
            <tr style="background:#f8fafc;">
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:left;">ランク</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">年間購入金額</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">ポイント還元</th>
              <th style="padding:8px;border:1px solid #e2e8f0;text-align:center;">特典</th>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#00bcd4;font-weight:700;">ダイヤモンド</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">50万円〜</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;color:#b8002a;">5%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">送料無料</td>
            </tr>
            <tr style="background:#fafafa;">
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#f59e0b;font-weight:700;">ゴールド</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">20万円〜</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;color:#b8002a;">5%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#94a3b8;font-weight:700;">シルバー</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">5万円〜</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:700;">3%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
            <tr style="background:#fafafa;">
              <td style="padding:8px;border:1px solid #e2e8f0;"><span style="color:#64748b;font-weight:700;">レギュラー</span></td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">1%</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">-</td>
            </tr>
          </table>
          <div style="font-size:11px;color:#888;line-height:1.6;">
            <div>* ランクは過去12ヶ月の購入金額で判定されます（年間更新）</div>
            <div>* ポイントは1pt = 1円として次回以降のお買い物にご利用いただけます</div>
            <div>* ダイヤモンド・ゴールド会員は更新切れ後1ヶ月以内に5万円以上購入でランク復活</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="doneModal" aria-hidden="true">
    <div class="modalHeader">
      <div class="modalTitle" id="doneModalTitle">注文完了</div>
      <button class="modalClose" id="doneCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody" style="text-align:center;">
      <div style="font-weight:900; font-size:14px;">受付番号</div>
      <div style="margin-top:8px; font-size:24px; font-weight:900; color:#3b82f6;" id="doneReceipt"></div>
      <div style="margin-top:16px; font-size:14px; color:#333; line-height:1.6;" id="doneMessage">
        お支払いが完了しました。注文確認メールをお送りしましたのでご確認ください。商品の発送準備を進めてまいります。
      </div>
    </div>
  </div>

  <!-- お問い合わせモーダル -->
  <div class="modal" id="contactModal" aria-hidden="true" style="width:min(500px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">お問い合わせ</div>
      <button class="modalClose" id="contactCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody">
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#475569;line-height:1.6;">
        <strong>営業時間</strong>：平日 10:00〜18:00（土日祝は発送・事務処理休み）<br>
        メッセージへの返信は土日祝も対応しております。2営業日以内にご返信いたします。
      </div>
      <div class="formField">
        <label>お名前 *</label>
        <input type="text" id="contactName" placeholder="会社名/氏名">
      </div>
      <div class="formField">
        <label>メールアドレス *</label>
        <input type="email" id="contactEmail" placeholder="返信先メールアドレス">
      </div>
      <div class="formField">
        <label>お問い合わせ内容 *</label>
        <textarea id="contactMessage" rows="6" placeholder="お問い合わせ内容をご記入ください"></textarea>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn primary" id="contactSubmitBtn" type="button">送信</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div id="sendingOverlay" class="sendingOverlay" aria-hidden="true">
    <div class="sendingBox" role="status" aria-live="polite">
      <div class="sendingSpinner"></div>
      <div id="sendingText" class="sendingText">依頼送信中...</div>
    </div>
  </div>
  <button class="toTop" id="toTopBtn" type="button" aria-label="ページ上部へ">↑</button>

  <div class="detail-modal-overlay" id="detailModal">
    <div class="detail-modal">
      <button class="detail-modal-close" onclick="closeDetailModal()">×</button>
      <div id="detailModalBody">
        <div class="detail-loading">読み込み中...</div>
      </div>
    </div>
  </div>

  <!-- フルスクリーン画像ビューア (モバイル用) -->
  <div class="fullscreen-viewer" id="fullscreenViewer">
    <button class="fullscreen-viewer-close" onclick="closeFullscreenViewer_()">×</button>
    <img id="fullscreenViewerImg" src="" alt="拡大画像">
    <div class="fullscreen-viewer-hint">ダブルタップ or ピンチで拡大・縮小</div>
  </div>

  <!-- 商品ガイドモーダル -->
  <div class="modal" id="guideModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">📦 商品ガイド</div>
      <button class="modalClose" id="guideCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">商品について</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>すべての商品には<strong>採寸データ</strong>が付いています</li>
          <li>写真はサンプルイメージです。実物と多少異なる場合があります</li>
          <li>状態ランクは目視による判定となります</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">状態ランクについて</h3>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr style="background:#f1f5f9;"><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">ランク</th><th style="padding:10px;text-align:left;border:1px solid #e2e8f0;">状態</th></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#10b981;">S</td><td style="padding:10px;border:1px solid #e2e8f0;">新品・未使用・タグ付きなど</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#3b82f6;">A</td><td style="padding:10px;border:1px solid #e2e8f0;">使用感がほとんどない美品</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#6366f1;">AB</td><td style="padding:10px;border:1px solid #e2e8f0;">多少の使用感があるが状態良好</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#8b5cf6;">B</td><td style="padding:10px;border:1px solid #e2e8f0;">一般的な使用感・軽微なダメージあり</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#a855f7;">C</td><td style="padding:10px;border:1px solid #e2e8f0;">使用感強め・目立つダメージあり</td></tr>
          <tr><td style="padding:10px;border:1px solid #e2e8f0;font-weight:700;color:#d946ef;">D</td><td style="padding:10px;border:1px solid #e2e8f0;">ジャンク・難あり品</td></tr>
        </table>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ご注文について</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong style="color:#1e293b;">10点から</strong>購入可能です</li>
          <li style="margin-bottom:8px;">送料はお届け先に応じて自動計算されます（ダイヤモンド会員は送料無料）</li>
          <li>在庫は先着のため、送信後に欠品となる場合があります（確保中表示がある場合はその時間内は確保）</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">ご注文の流れ</h3>
        <ol style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><strong>商品選択</strong>：お好みの商品をカートに追加</li>
          <li style="margin-bottom:8px;"><strong>お届け先入力</strong>：住所を入力すると送料が自動表示されます</li>
          <li style="margin-bottom:8px;"><strong>お支払い</strong>：商品代＋送料をオンライン決済<br><span style="font-size:12px;color:#888;">※コンビニ決済は別途手数料220円、銀行振込・ペイジーの振込手数料はお客様負担</span></li>
          <li><strong>発送</strong>：決済完了後、商品を発送いたします</li>
        </ol>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">割引について</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li style="margin-bottom:8px;"><span style="color:#b8002a;font-weight:700;">30点以上で10%割引</span></li>
          <li style="margin-bottom:8px;" id="guideMemberDiscount"><strong>会員割引</strong>：会員登録で<span style="color:#b8002a;font-weight:700;">10%OFF</span><span style="color:#666;font-size:13px;">（2026年9月末まで）</span></li>
          <li id="guideCombineDiscount"><span style="color:#b8002a;font-weight:700;">※ 併用可</span>（30点割引＋会員割引の同時適用OK）</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #3b82f6;padding-bottom:8px;">注意事項</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>商品の確保期間は<strong>15分</strong>です（カートに入れた時点から）</li>
          <li>ご注文確定後のキャンセル・変更はできません</li>
          <li>返品・交換は原則お受けしておりません。万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 送料表モーダル -->
  <div class="modal" id="shippingModal" aria-hidden="true" style="width:min(800px,96vw);">
    <div class="modalHeader">
      <div class="modalTitle">🚚 デタウリ送料表</div>
      <button class="modalClose" id="shippingCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <!-- 西日本 -->
      <div class="guide-section">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f472b6;padding-bottom:8px;">西日本（南九州〜北陸）</h3>
        <div class="shipping-scroll-wrap" style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#fce7f3;">
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;width:80px;">宅配便</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">南九州</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">北九州</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">四国</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">中国</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">関西</th>
              <th style="padding:8px;text-align:center;border:1px solid #f9a8d4;">北陸</th>
            </tr>
            <tr style="background:#fdf2f8;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">都道府県</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">鹿児島・熊本・宮崎</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">福岡・佐賀・大分・長崎</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">香川・愛媛・高知・徳島</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">広島・岡山・島根・山口・鳥取</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">大阪・兵庫・京都・奈良・和歌山・滋賀</td>
              <td style="padding:6px;border:1px solid #f9a8d4;text-align:center;">石川・福井・富山</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">宅配便（小）</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,320円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,280円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,180円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,200円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,100円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,160円</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;font-weight:700;background:#fff0f6;">宅配便（大）</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,700円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,620円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,440円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,480円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,260円</td>
              <td style="padding:8px;border:1px solid #f9a8d4;text-align:center;">1,420円</td>
            </tr>
          </table>
        </div>
        <div class="shipping-scroll-hint">&larr; 横にスクロールできます &rarr;</div>
      </div>

      <!-- 東日本 -->
      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #67e8f9;padding-bottom:8px;">東日本（東海〜北海道）</h3>
        <div class="shipping-scroll-wrap" style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
            <tr style="background:#cffafe;">
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;width:80px;">宅配便</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">東海</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">信越</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">関東</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">南東北</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">北東北</th>
              <th style="padding:8px;text-align:center;border:1px solid #a5f3fc;">北海道</th>
            </tr>
            <tr style="background:#ecfeff;font-size:10px;color:#6b7280;">
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">都道府県</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">愛知・静岡・岐阜・三重</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">新潟・長野</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">東京・神奈川・埼玉・千葉・茨城・栃木・群馬・山梨</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">宮城・福島・山形</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">岩手・秋田・青森</td>
              <td style="padding:6px;border:1px solid #a5f3fc;text-align:center;">北海道</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">宅配便（小）</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,180円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,220円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,300円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,400円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,460円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,640円</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;font-weight:700;background:#f0fdff;">宅配便（大）</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,440円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,540円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,680円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,900円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">1,980円</td>
              <td style="padding:8px;border:1px solid #a5f3fc;text-align:center;">2,380円</td>
            </tr>
          </table>
        </div>
        <div class="shipping-scroll-hint">&larr; 横にスクロールできます &rarr;</div>
      </div>

      <!-- 沖縄 -->
      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">沖縄本島</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;max-width:300px;">
            <tr style="background:#fef3c7;">
              <th style="padding:8px;text-align:center;border:1px solid #fcd34d;width:80px;">宅配便</th>
              <th style="padding:8px;text-align:center;border:1px solid #fcd34d;">沖縄本島</th>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;font-weight:700;background:#fffbeb;">宅配便（小）</td>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;">2,500円</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;font-weight:700;background:#fffbeb;">宅配便（大）</td>
              <td style="padding:8px;border:1px solid #fcd34d;text-align:center;">3,500円</td>
            </tr>
          </table>
        </div>
        <p style="margin:8px 0 0;color:#b45309;font-size:12px;">※ 沖縄県の離島（宮古島・石垣島等）は配送対象外です。</p>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">サイズの目安</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;font-size:13px;">
          <li><strong>宅配便（小）</strong>：10着程度</li>
          <li><strong>宅配便（大）</strong>：11〜40着程度</li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #10b981;padding-bottom:8px;">配送について</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li>上記送料は全て<strong>税込み</strong>です</li>
          <li>会員割引は商品代のみに適用されます（<strong>送料は割引対象外</strong>）</li>
          <li>発送はお支払い確認後<strong>2〜5営業日</strong>以内</li>
          <li>配送業者：佐川急便・ヤマト運輸・郵便局のいずれか（指定不可）</li>
          <li>日時指定不可</li>
          <li style="color:#b8002a;"><strong>離島への配送は対象外です</strong></li>
        </ul>
      </div>

      <div class="guide-section" style="margin-top:20px;">
        <h3 style="margin:0 0 12px;font-size:16px;color:#1e293b;border-bottom:2px solid #f59e0b;padding-bottom:8px;">お客様ご負担の決済手数料</h3>
        <ul style="margin:0;padding-left:20px;color:#475569;">
          <li><strong>コンビニ決済</strong>：220円（税込）の決済手数料がかかります</li>
          <li><strong>銀行振込</strong>：振込手数料はお客様のご負担となります（金額は金融機関により異なります）</li>
          <li><strong>ペイジー</strong>：振込手数料はお客様のご負担となります（金額は金融機関により異なります）</li>
          <li style="color:#888;">クレジットカード・PayPay・Apple Pay：手数料はかかりません</li>
        </ul>
      </div>
    </div>
  </div>


  <!-- 特定商取引法モーダル -->
  <div class="modal" id="legalModal" aria-hidden="true" style="width:min(700px,94vw);">
    <div class="modalHeader">
      <div class="modalTitle">特定商取引法に基づく表記</div>
      <button class="modalClose" id="legalCloseBtn" aria-label="close">×</button>
    </div>
    <div class="modalBody" style="line-height:1.7;">
      <table style="width:100%;border-collapse:collapse;font-size:14px;">
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;width:140px;vertical-align:top;">販売業者</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">西出克利</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">運営統括責任者</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">西出克利</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">所在地</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">大阪府大東市灰塚4-16-15</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">電話番号</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">090-5820-1803</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">メールアドレス</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">nkonline1030@gmail.com</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">営業時間</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">平日 10:00〜18:00<br><span style="font-size:12px;color:#888;">※土日祝は発送・事務処理休み（メッセージ返信は対応可）</span></td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">販売価格</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">各商品ページに表示された価格（税込）</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">送料</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">地域・サイズにより異なります。詳細は<a href="#" id="legalShippingLink" style="color:#3b82f6;">送料表</a>をご確認ください。</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">支払方法</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）、コンビニ決済、銀行振込、PayPay、ペイジー、Apple Pay</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">支払時期</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            クレジットカード・PayPay・Apple Pay：ご注文時に決済<br>
            コンビニ決済：ご注文後3日以内にお支払い<br>
            銀行振込・ペイジー：ご注文後3日以内にお振込み
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">お客様負担の手数料</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            コンビニ決済：<strong>220円（税込）</strong>の決済手数料がかかります（お客様負担）<br>
            銀行振込・ペイジー：<strong>振込手数料</strong>はお客様のご負担となります（金額は金融機関により異なります）<br>
            <span style="font-size:12px;color:#888;">※クレジットカード・PayPay・Apple Pay：手数料はかかりません</span>
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">商品引渡し時期</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">ご入金確認後、2〜5営業日以内に発送</td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">返品・交換</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            原則として返品・交換はお受けしておりません。<br>
            万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。
          </td>
        </tr>
        <tr>
          <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;background:#f8fafc;vertical-align:top;">返金について</th>
          <td style="padding:12px;border:1px solid #e2e8f0;">
            当方の都合による返金の場合、ご利用の決済方法に応じて返金処理を行います。<br>
            クレジットカード：カード会社経由での返金<br>
            コンビニ決済・銀行振込・ペイジー：ご指定の銀行口座へ返金<br>
            PayPay：PayPay残高への返金<br>
            Apple Pay：カード会社経由での返金
          </td>
        </tr>
      </table>
    </div>
  </div>

<footer class="footer">
  <p>NKonline Apparel / デタウリ.Detauri</p>
  <p style="margin-top:6px;">
    <a href="#" id="openLegalLink">特定商取引法に基づく表記</a> ｜
    <a href="#" id="openContactLink2">お問い合わせ</a> ｜
    <a href="#" id="openPrivacyLink">プライバシーポリシー</a>
  </p>
  <p style="margin-top:8px;color:#64748b;">&copy; 2025-2026 デタウリ.Detauri</p>
</footer>

<!-- プライバシーポリシーモーダル -->
<div class="modal" id="privacyModal" aria-hidden="true" style="width:min(700px,94vw);">
  <div class="modalHeader">
    <div class="modalTitle">プライバシーポリシー</div>
    <button class="modalClose" id="privacyCloseBtn" aria-label="close">×</button>
  </div>
  <div class="modalBody" style="line-height:1.8;font-size:14px;">
    <h3 style="font-size:16px;font-weight:700;margin:0 0 12px;">個人情報の取り扱いについて</h3>
    <p>デタウリ.Detauri（以下「当サービス」）は、お客様の個人情報の保護に細心の注意を払い、以下の方針に基づき適切に取り扱います。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">1. 収集する情報</h4>
    <p>当サービスでは、ご注文・会員登録・お問い合わせの際に以下の情報を収集します。</p>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>氏名・会社名</li>
      <li>メールアドレス</li>
      <li>電話番号</li>
      <li>郵便番号・住所</li>
      <li>ご注文内容・決済情報（決済処理はKOMOJU社が行います）</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">2. 利用目的</h4>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>ご注文の処理・商品の発送</li>
      <li>お問い合わせへの回答</li>
      <li>サービス改善・新商品のご案内（メルマガ登録者のみ）</li>
      <li>不正利用の防止</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">3. 第三者への提供</h4>
    <p>お客様の個人情報は、以下の場合を除き第三者に提供いたしません。</p>
    <ul style="margin:8px 0;padding-left:24px;">
      <li>商品配送のために配送業者に必要な情報を提供する場合</li>
      <li>決済処理のためにKOMOJU社に必要な情報を提供する場合</li>
      <li>法令に基づく場合</li>
    </ul>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">4. 個人情報の管理</h4>
    <p>お客様の個人情報は、不正アクセス・紛失・破壊・改ざん・漏洩等を防止するため、適切なセキュリティ対策を講じて管理いたします。パスワードは暗号化して保存しており、当サービスのスタッフが閲覧することはできません。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">5. Cookieおよびローカルストレージ</h4>
    <p>当サービスでは、カート情報の保持・ログイン状態の維持・サービス改善のためにCookieおよびローカルストレージを使用しています。ブラウザの設定により無効化できますが、一部の機能が制限される場合があります。</p>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">6. お問い合わせ・開示請求</h4>
    <p>個人情報の開示・訂正・削除等のご請求は、下記までご連絡ください。</p>
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px 16px;margin:8px 0;">
      <strong>デタウリ.Detauri</strong><br>
      メール：nkonline1030@gmail.com<br>
      電話：090-5820-1803（平日 10:00〜18:00）
    </div>

    <h4 style="font-size:14px;font-weight:700;margin:20px 0 8px;">7. 改定</h4>
    <p>本ポリシーは、法令の変更やサービス内容の変更に伴い、予告なく改定する場合があります。改定後のポリシーは当サービス上に掲載した時点で効力を生じます。</p>

    <p style="margin-top:20px;color:#64748b;font-size:12px;">最終更新日：2026年2月20日</p>
  </div>
</div>

<script>
// =====================================================
// 状態管理
// =====================================================

var state = {
  userKey: '',
  allProducts: [],
  filteredProducts: [],
  settings: null,
  options: null,
  query: {
    filters: { brand: [], category: [], state: [], gender: [], size: [] },
    sort: { key: 'default', dir: 'asc' },
    page: 1,
    pageSize: 60
  },
  cart: { ids: [], itemsById: {}, digest: {} },
  ui: { cardEls: {} },
  timers: { statusPoll: null },
  _holdSyncing: false,
  brandUi: { all: [], selected: {}, cbByName: {}, built: false },
  // 顧客認証
  customer: null,  // { id, email, companyName, phone, postal, address, newsletter }
  sessionId: null,
  csrfToken: null,
  dataLoaded: false,
  appliedCoupon: null  // { code, type, value, discountAmount, label, comboMember, comboBulk }
};

// =====================================================
// ユーティリティ
// =====================================================

function $(id) { return document.getElementById(id); }

function escapeHtml_(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function safeColor_(c) { return /^#[0-9a-fA-F]{3,8}$/.test(c) ? c : '#64748b'; }

function yen(n) {
  var x = Math.round(Number(n || 0));
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '円';
}
function numFmt_(n) { return String(Math.round(Number(n || 0))).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

// ブランド名を正規化（大文字小文字・スペース統一）
function normalizeBrand_(name) {
  if (!name) return '';
  // スペースを除去し、大文字に統一
  return String(name).replace(/\s+/g, '').toUpperCase();
}

// 正規化ブランドキー → 表示名のマップ（最初に見つかったものを使用）
var brandDisplayMap_ = {};
var brandNormalizedMap_ = {}; // 元のブランド名 → 正規化キー

function showToast(msg) {
  var t = $('toast');
  t.textContent = String(msg || '');
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2600);
}

// =====================================================
// 顧客認証
// =====================================================

var SESSION_KEY = 'estimate_session';
var MEMBER_DISCOUNT_RATE = 0.10;  // 会員割引（APIから更新される）
var MEMBER_DISCOUNT_ENABLED = true; // 会員割引ON/OFF（APIから更新される）
var MEMBER_DISCOUNT_END_DATE = '2026-09-30'; // 期限（APIから更新される）
var BULK_DISCOUNT_RATE = 0.10;    // 30点以上割引10%

// =====================================================
// 送料計算（フロントエンド）
// ※送料は全て税込み。会員割引は送料には適用しない。
// =====================================================

var SHIPPING_AREAS = {
  '北海道': 'hokkaido',
  '青森県': 'kita_tohoku', '岩手県': 'kita_tohoku', '秋田県': 'kita_tohoku',
  '宮城県': 'minami_tohoku', '福島県': 'minami_tohoku', '山形県': 'minami_tohoku',
  '東京都': 'kanto', '神奈川県': 'kanto', '埼玉県': 'kanto', '千葉県': 'kanto',
  '茨城県': 'kanto', '栃木県': 'kanto', '群馬県': 'kanto', '山梨県': 'kanto',
  '新潟県': 'shinetsu', '長野県': 'shinetsu',
  '愛知県': 'tokai', '静岡県': 'tokai', '岐阜県': 'tokai', '三重県': 'tokai',
  '石川県': 'hokuriku', '福井県': 'hokuriku', '富山県': 'hokuriku',
  '大阪府': 'kansai', '兵庫県': 'kansai', '京都府': 'kansai',
  '奈良県': 'kansai', '和歌山県': 'kansai', '滋賀県': 'kansai',
  '広島県': 'chugoku', '岡山県': 'chugoku', '島根県': 'chugoku',
  '山口県': 'chugoku', '鳥取県': 'chugoku',
  '香川県': 'shikoku', '愛媛県': 'shikoku', '高知県': 'shikoku', '徳島県': 'shikoku',
  '福岡県': 'kita_kyushu', '佐賀県': 'kita_kyushu', '大分県': 'kita_kyushu', '長崎県': 'kita_kyushu',
  '鹿児島県': 'minami_kyushu', '熊本県': 'minami_kyushu', '宮崎県': 'minami_kyushu',
  '沖縄県': 'okinawa'
};

var SHIPPING_RATES = {
  minami_kyushu: [1320, 1700], kita_kyushu: [1280, 1620],
  shikoku: [1180, 1440], chugoku: [1200, 1480],
  kansai: [1100, 1260], hokuriku: [1160, 1420],
  tokai: [1180, 1440], shinetsu: [1220, 1540],
  kanto: [1300, 1680], minami_tohoku: [1400, 1900],
  kita_tohoku: [1460, 1980], hokkaido: [1640, 2380],
  okinawa: [2500, 3500]
};

var REMOTE_ISLANDS_KEYWORDS = [
  '大島町','利島村','新島村','神津島村','三宅村','御蔵島村','八丈町','青ヶ島村','小笠原村',
  '奄美市','大和村','宇検村','瀬戸内町','龍郷町','喜界町','徳之島町','天城町','伊仙町',
  '和泊町','知名町','与論町','三島村','十島村',
  '宮古島市','石垣市','多良間村','竹富町','与那国町','久米島町','座間味村','渡嘉敷村',
  '粟国村','渡名喜村','南大東村','北大東村','伊江村','伊是名村','伊平屋村',
  '佐渡市','隠岐の島町','海士町','西ノ島町','知夫村',
  '対馬市','壱岐市','五島市','新上五島町','小値賀町',
  '利尻町','利尻富士町','礼文町','奥尻町'
];

var PREFECTURES = [
  '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
  '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
  '新潟県','富山県','石川県','福井県','山梨県','長野県',
  '岐阜県','静岡県','愛知県','三重県',
  '滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県',
  '鳥取県','島根県','岡山県','広島県','山口県',
  '徳島県','香川県','愛媛県','高知県',
  '福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'
];

function detectPrefectureFromAddress_(text) {
  text = String(text || '').trim();
  for (var i = 0; i < PREFECTURES.length; i++) {
    if (text.indexOf(PREFECTURES[i]) === 0) return PREFECTURES[i];
  }
  for (var j = 0; j < PREFECTURES.length; j++) {
    var short = PREFECTURES[j].replace(/[都府県]$/, '');
    if (text.indexOf(short) === 0) return PREFECTURES[j];
  }
  return null;
}

function isRemoteIslandAddress_(text) {
  text = String(text || '');
  for (var i = 0; i < REMOTE_ISLANDS_KEYWORDS.length; i++) {
    if (text.indexOf(REMOTE_ISLANDS_KEYWORDS[i]) !== -1) return true;
  }
  return false;
}

function classifyThickness_(items) {
  var thick = 0, thin = 0;
  for (var i = 0; i < items.length; i++) {
    if (String(items[i].shippingMethod || '').trim() === 'ゆうパケットポスト') thin++;
    else thick++;
  }
  return { thick: thick, thin: thin, total: thick + thin };
}

function calcShippingSize_(thick, thin) {
  var total = thick + thin;
  if (thin === 0) {
    // 厚手のみ
    if (total > 20) return { size: null, reason: 'overLimit' };
    return { size: 'large', label: '大' };
  }
  if (thick === 0) {
    // 薄手のみ
    if (total > 40) return { size: null, reason: 'overLimit' };
    return total <= 10 ? { size: 'small', label: '小' } : { size: 'large', label: '大' };
  }
  // 混合
  if (total > 40) return { size: null, reason: 'overLimit' };
  if (thick >= 10) return { size: 'large', label: '大' };
  return total <= 10 ? { size: 'small', label: '小' } : { size: 'large', label: '大' };
}

/** 複数口送料計算（上限超過時に分割） */
function calculateMultiShipment_(thick, thin, rates) {
  var smallRate = rates[0], largeRate = rates[1];
  var totalAmount = 0, largeCnt = 0, smallCnt = 0;
  // 厚手: 1口最大20点、常に大サイズ
  if (thick > 0) {
    var n = Math.ceil(thick / 20);
    largeCnt += n;
    totalAmount += n * largeRate;
  }
  // 薄手: 1口最大40点、10点以下→小、11点以上→大
  var rem = thin;
  while (rem > 0) {
    var batch = Math.min(rem, 40);
    if (batch <= 10) { smallCnt++; totalAmount += smallRate; }
    else { largeCnt++; totalAmount += largeRate; }
    rem -= batch;
  }
  var parts = [];
  if (largeCnt > 0) parts.push('大×' + largeCnt);
  if (smallCnt > 0) parts.push('小×' + smallCnt);
  return { amount: totalAmount, sizeLabel: parts.join('、'), largeCnt: largeCnt, smallCnt: smallCnt };
}

/** 送料計算メイン */
function calculateShipping_() {
  var ids = state.cart.ids || [];
  if (ids.length === 0) return { amount: null, label: '', canAutoPayment: false };

  // ダイヤモンド会員 → 送料無料
  if (state.customer && state.customer.rank && state.customer.rank.freeShipping) {
    return { amount: 0, label: '送料無料（ダイヤモンド会員特典）', canAutoPayment: true };
  }

  // 送料無料クーポン適用中
  if (state.appliedCoupon && state.appliedCoupon.type === 'shipping_free') {
    return { amount: 0, label: '送料無料（クーポン適用）', canAutoPayment: true };
  }

  var addressEl = $('address');
  var address = addressEl ? addressEl.value.trim() : '';
  if (!address) return { amount: null, label: '住所を入力すると送料が表示されます', canAutoPayment: false };

  // 離島チェック
  if (isRemoteIslandAddress_(address)) {
    return { amount: null, label: '離島への配送は対象外です', canAutoPayment: false, isRemoteIsland: true };
  }

  var pref = detectPrefectureFromAddress_(address);
  if (!pref) return { amount: null, label: '住所を正しく入力してください（都道府県から）', canAutoPayment: false };

  var area = SHIPPING_AREAS[pref];
  if (!area || !SHIPPING_RATES[area]) return { amount: null, label: '送料は別途ご案内します', canAutoPayment: false };

  // カート商品の厚み情報を取得
  var items = [];
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) items.push(it);
  }

  var t = classifyThickness_(items);
  var sizeResult = calcShippingSize_(t.thick, t.thin);

  if (!sizeResult.size) {
    // 上限超過: 複数口に分割して計算
    var multi = calculateMultiShipment_(t.thick, t.thin, SHIPPING_RATES[area]);
    return {
      amount: multi.amount,
      label: yen(multi.amount) + '（' + pref + '・' + multi.sizeLabel + '・税込）',
      canAutoPayment: true,
      size: 'multi',
      sizeLabel: multi.sizeLabel,
      area: area,
      pref: pref
    };
  }

  var rateIdx = (sizeResult.size === 'small') ? 0 : 1;
  var amount = SHIPPING_RATES[area][rateIdx];

  return {
    amount: amount,
    label: yen(amount) + '（' + pref + '・' + sizeResult.label + '・税込）',
    canAutoPayment: true,
    size: sizeResult.size,
    sizeLabel: sizeResult.label,
    area: area,
    pref: pref
  };
}

/** 送料表示を更新 */
/** 送料表示を更新（renderSummary_に委譲） */
function updateShippingDisplay_() {
  renderSummary_();
}

/** アソート商品の送料を現在の住所から計算 */
function calcBulkShipping_(bulkTotalQty) {
  if (bulkTotalQty === 0) return 0;
  var addressEl = $('address');
  var address = addressEl ? addressEl.value.trim() : '';
  if (!address) return 0;
  var pref = detectPrefectureFromAddress_(address);
  if (!pref) return 0;
  var area = SHIPPING_AREAS[pref];
  if (!area || !SHIPPING_RATES[area]) return 0;
  // アソート商品は常に大サイズ × 数量
  return SHIPPING_RATES[area][1] * bulkTotalQty;
}

/** 商品代合計（割引・ポイント適用後） */
function calcProductTotal_() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var discounted;
  if (state.appliedCoupon && state.appliedCoupon.code && state.appliedCoupon.type !== 'shipping_free') {
    var cd = state.appliedCoupon.discountAmount || 0;
    var afterCoupon = Math.max(0, sum - cd);
    var comboRate = 0;
    if (state.appliedCoupon.comboBulk && ids.length >= 30) comboRate += BULK_DISCOUNT_RATE;
    if (state.appliedCoupon.comboMember && state.customer && MEMBER_DISCOUNT_ENABLED) comboRate += MEMBER_DISCOUNT_RATE;
    discounted = Math.round(afterCoupon * (1 - comboRate));
  } else {
    var discountRate = 0;
    if (ids.length >= 30) discountRate += BULK_DISCOUNT_RATE;
    if (state.customer && MEMBER_DISCOUNT_ENABLED) discountRate += MEMBER_DISCOUNT_RATE;
    discounted = Math.round(sum * (1 - discountRate));
  }
  // ポイント適用
  var pts = parseInt(($('usePoints') ? $('usePoints').value : 0), 10) || 0;
  if (pts > 0 && state.customer) {
    var maxPts = (state.customer.points || 0);
    pts = Math.min(pts, maxPts, discounted);
    discounted -= pts;
  }
  return discounted;
}

/** カート金額サマリーを統一フォーマットで描画（アソート商品と同じcart-row形式） */
function renderSummary_() {
  var el = $('cartSummaryRows');
  var noteEl = $('shippingNote');
  var feeNoteEl = $('paymentFeeNote');
  var warnEl = $('remoteIslandWarning');
  var goFormBtn = $('goFormBtn');
  if (!el) return;

  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var count = ids.length;

  // 割引計算
  var discountLabels = [];
  var discounted;
  if (state.appliedCoupon && state.appliedCoupon.code) {
    var cd = state.appliedCoupon.discountAmount || 0;
    discounted = Math.max(0, sum - cd);
    if (state.appliedCoupon.type !== 'shipping_free') {
      discountLabels.push(escapeHtml_(state.appliedCoupon.label));
    }
    var comboRate = 0;
    if (state.appliedCoupon.comboBulk && count >= 30) { comboRate += BULK_DISCOUNT_RATE; discountLabels.push('30点割引10%OFF'); }
    if (state.appliedCoupon.comboMember && state.customer && MEMBER_DISCOUNT_ENABLED) { comboRate += MEMBER_DISCOUNT_RATE; discountLabels.push('会員10%OFF'); }
    discounted = Math.round(discounted * (1 - comboRate));
  } else {
    var discountRate = 0;
    if (count >= 30) { discountRate += BULK_DISCOUNT_RATE; discountLabels.push('30点割引10%OFF'); }
    if (state.customer && MEMBER_DISCOUNT_ENABLED) { discountRate += MEMBER_DISCOUNT_RATE; discountLabels.push('会員10%OFF'); }
    discounted = Math.round(sum * (1 - discountRate));
  }

  // ポイント利用
  var pts = parseInt(($('usePoints') ? $('usePoints').value : '0'), 10) || 0;
  var pointsApplied = 0;
  if (pts > 0 && state.customer) {
    var maxPts = state.customer.points || 0;
    pts = Math.min(pts, maxPts, discounted);
    pointsApplied = pts;
  }
  var afterPoints = discounted - pointsApplied;

  // 送料計算
  var shippingResult = calculateShipping_();
  state.lastShipping = shippingResult;

  // 離島チェック
  if (shippingResult.isRemoteIsland) {
    el.innerHTML = '';
    noteEl.style.display = 'none';
    if (feeNoteEl) feeNoteEl.style.display = 'none';
    warnEl.style.display = '';
    warnEl.textContent = '離島への配送は対象外です。恐れ入りますがご注文いただけません。';
    if (goFormBtn) goFormBtn.disabled = true;
    return;
  }
  warnEl.style.display = 'none';

  var rows = '';
  var shippingAmount = 0;
  var hasShippingInfo = false;

  if (count > 0) {
    // デタウリ 商品代
    rows += '<div class="cart-row"><span>デタウリ 商品代（' + count + '点）</span><span>¥' + numFmt_(sum) + '</span></div>';

    // 割引行
    if (discounted < sum) {
      var totalDisc = sum - discounted;
      rows += '<div class="cart-row"><span>' + discountLabels.join('＋') + '</span><span>-¥' + numFmt_(totalDisc) + '</span></div>';
    }

    // ポイント利用行
    if (pointsApplied > 0) {
      rows += '<div class="cart-row"><span>ポイント利用</span><span>-¥' + numFmt_(pointsApplied) + '</span></div>';
    }

    // デタウリ 送料
    if (shippingResult.amount !== null) {
      shippingAmount = shippingResult.amount;
      hasShippingInfo = true;
      if (shippingResult.amount === 0) {
        var freeReason = '';
        if (shippingResult.label && shippingResult.label.indexOf('ダイヤモンド') >= 0) freeReason = 'ダイヤモンド会員特典';
        else if (shippingResult.label && shippingResult.label.indexOf('クーポン') >= 0) freeReason = 'クーポン適用';
        rows += '<div class="cart-row"><span>デタウリ 送料</span><span>¥0' + (freeReason ? '（' + freeReason + '）' : '（無料）') + '</span></div>';
      } else {
        var shipDesc = 'デタウリ 送料';
        if (shippingResult.pref && shippingResult.sizeLabel) {
          shipDesc += '（' + escapeHtml_(shippingResult.pref) + '・' + escapeHtml_(shippingResult.sizeLabel) + '）';
        }
        rows += '<div class="cart-row"><span>' + shipDesc + '</span><span>¥' + numFmt_(shippingResult.amount) + '</span></div>';
      }
    } else if (shippingResult.label) {
      hasShippingInfo = true;
      rows += '<div class="cart-row"><span>デタウリ 送料</span><span style="font-size:11px;color:#888;">' + escapeHtml_(shippingResult.label) + '</span></div>';
    }

    // デタウリ 小計
    var detauriTotal = afterPoints + shippingAmount;
    rows += '<div class="cart-row total"><span>デタウリ 小計</span><span>¥' + numFmt_(detauriTotal) + '</span></div>';
  }

  // note表示制御
  if (hasShippingInfo) {
    noteEl.style.display = '';
    if (feeNoteEl) feeNoteEl.style.display = '';
  } else {
    noteEl.style.display = 'none';
    if (feeNoteEl) feeNoteEl.style.display = 'none';
  }

  // アソート商品カート
  var bulk = loadBulkCartStorage();
  if (bulk.subtotal > 0) {
    var bulkShip = calcBulkShipping_(bulk.totalQty);
    rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;padding-top:10px;">'
      + '<span>アソート商品 商品代（' + bulk.totalQty + '点）</span>'
      + '<span>¥' + numFmt_(bulk.subtotal) + '</span></div>';
    if (bulkShip > 0) {
      var bulkShipPref = detectPrefectureFromAddress_($('address') ? $('address').value.trim() : '');
      var bulkShipDesc = 'アソート商品 送料';
      if (bulkShipPref) bulkShipDesc += '（' + escapeHtml_(bulkShipPref) + '・大×' + bulk.totalQty + '）';
      rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
        + '<span>' + bulkShipDesc + '</span>'
        + '<span>¥' + numFmt_(bulkShip) + '</span></div>';
    } else {
      var addrVal = $('address') ? $('address').value.trim() : '';
      if (addrVal) {
        rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
          + '<span>アソート商品 送料</span><span>¥0（無料）</span></div>';
      } else {
        rows += '<div class="cart-row" style="color:#5B86C5;font-size:12px;border-bottom:none;">'
          + '<span>アソート商品 送料</span><span style="font-size:11px;color:#888;">住所入力で計算</span></div>';
      }
    }
    var bulkTotal = bulk.subtotal + bulkShip;
    rows += '<div class="cart-row" style="color:#5B86C5;font-size:13px;font-weight:700;border-top:1px solid #c8d8f0;margin-top:4px;padding-top:8px;">'
      + '<span>アソート商品 小計</span>'
      + '<span>¥' + numFmt_(bulkTotal) + '</span></div>';
    var detauriFull = afterPoints + shippingAmount;
    var grandTotal = detauriFull + bulkTotal;
    rows += '<div class="cart-row total" style="border-top-color:#5B86C5;"><span>両チャネル合計（税込）</span><span>¥' + numFmt_(grandTotal) + '</span></div>';
  }

  el.innerHTML = rows;
  if (goFormBtn) goFormBtn.disabled = (count === 0);

  // ポイント情報更新
  var info = $('pointDiscountInfo');
  if (info) {
    if (pointsApplied > 0) {
      info.innerHTML = '<span style="color:#2e7d32;">&#10003; ' + pointsApplied + 'ポイント適用済み（-' + yen(pointsApplied) + '）</span>';
    } else {
      info.textContent = '';
    }
  }

  // 送料詳細をlocalStorageに保存（アソート商品ページでの表示用）
  saveCartStorage();
  updateCartClearBtns_();
}

function loadSession_() {
  try {
    var raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) { return null; }
}

function saveSession_(sessionId, customer) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({ sessionId: sessionId, customer: customer }));
  } catch (e) {}
}

function clearSession_() {
  try { localStorage.removeItem(SESSION_KEY); } catch (e) {}
  state.sessionId = null;
  state.customer = null;
  state.csrfToken = null;
}

function fetchCsrfToken_() {
  if (!state.userKey) return;
  runApi('apiGetCsrfToken', state.userKey)
    .then(function(res) {
      if (res && res.ok && res.csrfToken) {
        state.csrfToken = res.csrfToken;
      }
    })
    .catch(function() {});
}

function updateAuthUi_() {
  var area = $('authArea');
  if (!area) return;

  // プロモバナーの表示制御
  var banner = $('promoBanner');
  if (banner) {
    var dismissed = false;
    try { dismissed = sessionStorage.getItem('promoBannerDismissed') === '1'; } catch (e) {}
    if (state.customer || dismissed || !MEMBER_DISCOUNT_ENABLED) {
      banner.style.display = 'none';
    } else {
      banner.style.display = 'block';
    }
  }

  if (state.customer) {
    var discountLabel = MEMBER_DISCOUNT_ENABLED ? '<span class="authDiscount">10%OFF</span>' : '';
    var pointsLabel = (state.customer.points > 0) ? '<span class="authPoints">' + state.customer.points + 'pt</span>' : '';
    // ランクバッジ
    var rankLabel = '';
    if (state.customer.rank && state.customer.rank.name) {
      rankLabel = '<span style="background:' + safeColor_(state.customer.rank.color) + ';color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700;">' + escapeHtml_(state.customer.rank.name) + '</span>';
    }
    area.innerHTML = '<div class="authUser">' +
      '<span class="authUserName">' + escapeHtml_(state.customer.companyName || state.customer.email) + '</span>' +
      rankLabel + discountLabel + pointsLabel +
      '</div>' +
      '<button class="authBtn mypage" id="openMyPageBtn" type="button">マイページ</button>' +
      '<button class="authBtn logout" id="logoutBtn" type="button">ログアウト</button>';

    var openMyPageBtn = $('openMyPageBtn');
    if (openMyPageBtn) {
      openMyPageBtn.addEventListener('click', function() { openMyPage_(); });
    }
    var logoutBtn = $('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() { doLogout_(); });
    }
  } else {
    area.innerHTML = '<button class="authBtn" id="openAuthBtn" type="button">ログイン / 新規登録</button>';
    var openAuthBtn = $('openAuthBtn');
    if (openAuthBtn) {
      openAuthBtn.addEventListener('click', function() {
        openAuthModal_('login');
      });
    }
  }
}

function openAuthModal_(mode) {
  var modal = $('authModal');
  if (!modal) return;

  // 全フォームを非表示
  $('loginForm').style.display = 'none';
  $('registerForm').style.display = 'none';
  $('forgotPasswordForm').style.display = 'none';
  $('forgotEmailForm').style.display = 'none';

  // 結果表示をリセット
  var recoverResult = $('recoverEmailResult');
  if (recoverResult) recoverResult.style.display = 'none';

  if (mode === 'register') {
    $('authModalTitle').textContent = '新規登録';
    $('registerForm').style.display = '';
  } else if (mode === 'forgotPassword') {
    $('authModalTitle').textContent = 'パスワードをお忘れの方';
    $('forgotPasswordForm').style.display = '';
  } else if (mode === 'forgotEmail') {
    $('authModalTitle').textContent = 'メールアドレスをお忘れの方';
    $('forgotEmailForm').style.display = '';
  } else {
    $('authModalTitle').textContent = 'ログイン';
    $('loginForm').style.display = '';
  }

  openModal(modal);
}

function doLogin_() {
  var email = ($('loginEmail').value || '').trim();
  var password = $('loginPassword').value || '';
  var rememberMe = $('rememberMe') ? $('rememberMe').checked : false;

  if (!email || !password) {
    showToast('メールアドレスとパスワードを入力してください');
    return;
  }

  setSending_(true, 'ログイン中...');

  runApi('apiLoginCustomer', state.userKey, { email: email, password: password, rememberMe: rememberMe })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        fetchCsrfToken_();
        updateAuthUi_();
        closeModal($('authModal'));
        showToast('ログインしました');
        // 割引を反映
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || 'ログインに失敗しました');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('ログインに失敗しました');
    });
}

function doRegister_() {
  var email = ($('regEmail').value || '').trim();
  var password = $('regPassword').value || '';
  var companyName = ($('regCompanyName').value || '').trim();
  var phone = ($('regPhone').value || '').trim();
  var postal = ($('regPostal').value || '').trim();
  var address = ($('regAddress').value || '').trim();
  var newsletter = $('regNewsletter').checked;

  if (!email || !email.includes('@')) {
    showToast('有効なメールアドレスを入力してください');
    return;
  }
  if (!password || password.length < 6) {
    showToast('パスワードは6文字以上で入力してください');
    return;
  }
  if (!companyName) {
    showToast('会社名/氏名は必須です');
    return;
  }

  setSending_(true, '登録中...');

  runApi('apiRegisterCustomer', state.userKey, {
    email: email,
    password: password,
    companyName: companyName,
    phone: phone,
    postal: postal,
    address: address,
    newsletter: newsletter
  })
    .then(function(res) {
      setSending_(false);
      if (res.ok && res.data) {
        state.sessionId = res.data.sessionId;
        state.customer = res.data.customer;
        saveSession_(res.data.sessionId, res.data.customer);
        fetchCsrfToken_();
        updateAuthUi_();
        closeModal($('authModal'));
        showToast(MEMBER_DISCOUNT_ENABLED ? '登録が完了しました！10%割引が適用されます' : '登録が完了しました！');
        updateCartPrice();
        if ($('cartModal').classList.contains('open')) renderCartModal_();
      } else {
        showToast(res.message || '登録に失敗しました');
      }
    })
    .catch(function(e) {
      setSending_(false);
      showToast('登録に失敗しました');
    });
}

// =====================================================
// マイページ
// =====================================================

function openMyPage_() {
  var modal = $('myPageModal');
  if (!modal) return;

  // ローカルデータで即時表示（API応答前のラグ解消）
  if (state.customer) {
    $('mpEmail').value = state.customer.email || '';
    $('mpCompanyName').value = state.customer.companyName || '';
    $('mpPhone').value = String(state.customer.phone || '').replace(/^'/, '');
    $('mpPostal').value = String(state.customer.postal || '').replace(/^'/, '');
    $('mpAddress').value = state.customer.address || '';
    $('mpPointBalance').textContent = String(state.customer.points || 0);
  }

  openModal(modal);
  loadMyPage_();
}

function loadMyPage_() {
  if (!state.sessionId) return;
  var orderList = $('mpOrderList');
  if (orderList) orderList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">読み込み中...</div>';

  runApi('apiGetMyPage', state.userKey || '', { sessionId: state.sessionId })
    .then(function(res) {
      if (!res || !res.ok || !res.data) {
        showToast((res && res.message) || 'マイページの読み込みに失敗しました');
        return;
      }
      var d = res.data;
      // プロフィール
      $('mpEmail').value = d.profile.email || '';
      $('mpCompanyName').value = d.profile.companyName || '';
      $('mpPhone').value = d.profile.phone || '';
      $('mpPostal').value = d.profile.postal || '';
      $('mpAddress').value = d.profile.address || '';
      $('mpRegisteredAt').textContent = d.profile.registeredAt || '-';
      // ポイント
      $('mpPointBalance').textContent = String(d.points || 0);
      if (state.customer) state.customer.points = d.points || 0;
      updateAuthUi_();
      // 統計データ
      if (d.stats) {
        $('mpTotalOrders').textContent = String(d.stats.totalOrders || 0) + '回';
        $('mpTotalItems').textContent = String(d.stats.totalItems || 0) + '点';
      }
      // ランク情報（APIから取得）
      if (d.rank) {
        var r = d.rank;
        $('mpTotalSpent').textContent = yen(r.annualSpent || 0);
        $('mpMemberRank').innerHTML = '<span style="color:' + safeColor_(r.color) + ';">' + escapeHtml_(r.name || 'レギュラー') + '</span>';

        // ランクカード更新
        var rankCard = $('mpRankCard');
        if (rankCard) {
          var gradients = {
            'DIAMOND': 'linear-gradient(135deg,#006064,#00838f)',
            'GOLD': 'linear-gradient(135deg,#78350f,#b45309)',
            'SILVER': 'linear-gradient(135deg,#475569,#64748b)',
            'REGULAR': 'linear-gradient(135deg,#1e293b,#334155)'
          };
          rankCard.style.background = gradients[r.rank] || gradients['REGULAR'];
        }
        $('mpRankName').textContent = r.name || 'レギュラー';
        $('mpRankPointRate').textContent = 'ポイント還元率: ' + Math.round((r.pointRate || 0.01) * 100) + '%';
        var benefits = [];
        if (r.freeShipping) benefits.push('送料無料');
        $('mpRankBenefits').textContent = benefits.length > 0 ? '特典: ' + benefits.join('、') : '';

        // 進捗バー
        var progressEl = $('mpRankProgress');
        if (progressEl && r.nextRank && r.nextThreshold > 0) {
          var pct = Math.min(100, Math.round((r.annualSpent / r.nextThreshold) * 100));
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;margin-bottom:4px;">'
            + '次のランク（' + escapeHtml_(r.nextRank) + '）まであと ' + yen(r.remaining || 0)
            + '</div>'
            + '<div style="background:rgba(255,255,255,0.2);border-radius:4px;height:6px;overflow:hidden;">'
            + '<div style="background:#fff;height:100%;border-radius:4px;width:' + pct + '%;transition:width .5s;"></div>'
            + '</div>'
            + '<div style="font-size:10px;opacity:0.6;margin-top:2px;text-align:right;">' + yen(r.annualSpent) + ' / ' + yen(r.nextThreshold) + '</div>';
        } else if (progressEl) {
          progressEl.innerHTML = '<div style="font-size:11px;opacity:0.8;">最高ランクに到達しています</div>';
        }

        // 救済措置の通知
        if (r.graceInfo && !r.graceInfo.restored && r.graceInfo.prevRank) {
          var graceNotice = $('mpRankProgress');
          if (graceNotice) {
            graceNotice.innerHTML += '<div style="margin-top:8px;padding:8px;background:rgba(255,255,255,0.15);border-radius:6px;font-size:11px;">'
              + '前年の' + (r.graceInfo.prevRank === 'DIAMOND' ? 'ダイヤモンド' : 'ゴールド') + 'ランクが更新切れです。'
              + '1ヶ月以内にあと' + yen(r.graceInfo.needed || 0) + '購入でランク復活できます。'
              + '</div>';
          }
        }

        // state.customerにランク情報を保存（ヘッダー表示用）
        if (state.customer) {
          state.customer.rank = r;
        }
        updateAuthUi_();
      } else if (d.stats) {
        $('mpTotalSpent').textContent = yen(d.stats.totalSpent || 0);
        var rank = getMemberRank_(d.stats.totalSpent || 0);
        $('mpMemberRank').innerHTML = '<span style="color:' + safeColor_(rank.color) + ';">' + escapeHtml_(rank.name) + '</span>';
      }
      // 注文履歴
      renderOrderHistory_(d.orders || []);
    })
    .catch(function() { showToast('マイページの読み込みに失敗しました'); });
}

function getMemberRank_(totalSpent) {
  if (totalSpent >= 500000) return { name: 'ダイヤモンド', color: '#00bcd4', pointRate: 5, freeShipping: true };
  if (totalSpent >= 200000) return { name: 'ゴールド', color: '#f59e0b', pointRate: 5, freeShipping: false };
  if (totalSpent >= 50000) return { name: 'シルバー', color: '#94a3b8', pointRate: 3, freeShipping: false };
  return { name: 'レギュラー', color: '#64748b', pointRate: 1, freeShipping: false };
}

function renderOrderHistory_(orders) {
  var el = $('mpOrderList');
  if (!el) return;
  if (!orders || orders.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">注文履歴はまだありません</div>';
    return;
  }
  var html = '';
  for (var i = 0; i < orders.length; i++) {
    var o = orders[i];
    var statusClass = (o.status === '完了') ? 'done' : (o.status === '依頼中') ? 'active' : 'pending';
    var trackHtml = '';
    if (o.carrier && o.tracking) {
      trackHtml = '<div style="font-size:11px;color:#888;margin-top:4px;">配送: ' + escapeHtml_(o.carrier) + ' ' + escapeHtml_(o.tracking) + '</div>';
    }
    html += '<div class="mp-order-card">'
      + '<div class="mp-order-header">'
      + '<span class="mp-order-no">' + escapeHtml_(o.receiptNo) + '</span>'
      + '<span class="mp-order-date">' + escapeHtml_(o.date) + '</span>'
      + '<span class="mp-order-status ' + statusClass + '">' + escapeHtml_(o.status) + '</span>'
      + '</div>'
      + '<div class="mp-order-products">' + escapeHtml_(o.products) + '</div>'
      + '<div class="mp-order-footer">'
      + '<span>' + o.count + '点</span>'
      + '<span class="mp-order-total">' + yen(o.total) + '</span>'
      + '</div>'
      + trackHtml
      + '</div>';
  }
  el.innerHTML = html;
}

function doLogout_() {
  var sessionId = state.sessionId;
  clearSession_();
  updateAuthUi_();
  updateCartPrice();
  if ($('cartModal').classList.contains('open')) renderCartModal_();
  showToast('ログアウトしました');

  if (sessionId) {
    runApi('apiLogoutCustomer', state.userKey, { sessionId: sessionId }).catch(function() {});
  }
}

function validateSession_() {
  var saved = loadSession_();
  if (!saved || !saved.sessionId) return;

  // 即時反映: localStorageのデータで先にUI更新
  if (saved.customer) {
    state.sessionId = saved.sessionId;
    state.customer = saved.customer;
    updateAuthUi_();
    updateCartPrice();
  }

  runApi('apiValidateSession', state.userKey, { sessionId: saved.sessionId })
    .then(function(res) {
      if (res.ok && res.data && res.data.customer) {
        state.sessionId = saved.sessionId;
        state.customer = res.data.customer;
        fetchCsrfToken_();
        updateAuthUi_();
        updateCartPrice();
      } else {
        clearSession_();
        updateAuthUi_();
        updateCartPrice();
      }
    })
    .catch(function() {
      // ネットワークエラー時は保存されたデータを維持（既に設定済み）
    });
}

function setupAuthUi_() {
  // ログインボタン
  var openAuthBtn = $('openAuthBtn');
  if (openAuthBtn) {
    openAuthBtn.addEventListener('click', function() {
      openAuthModal_('login');
    });
  }

  // モーダル閉じる
  var authCloseBtn = $('authCloseBtn');
  if (authCloseBtn) {
    authCloseBtn.addEventListener('click', function() {
      closeModal($('authModal'));
    });
  }

  // 商品ガイドモーダル
  var openGuideLink = $('openGuideLink');
  if (openGuideLink) {
    openGuideLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('guideModal'));
    });
  }
  var guideCloseBtn = $('guideCloseBtn');
  if (guideCloseBtn) {
    guideCloseBtn.addEventListener('click', function() {
      closeModal($('guideModal'));
    });
  }

  // 送料表モーダル
  var openShippingLink = $('openShippingLink');
  if (openShippingLink) {
    openShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('shippingModal'));
    });
  }
  var shippingCloseBtn = $('shippingCloseBtn');
  if (shippingCloseBtn) {
    shippingCloseBtn.addEventListener('click', function() {
      closeModal($('shippingModal'));
    });
  }

  // 送料表テーブル横スクロールインジケーター
  (function(){
    var wraps = document.querySelectorAll('.shipping-scroll-wrap');
    function checkScroll(el){
      var canScroll = el.scrollWidth > el.clientWidth + 1;
      el.classList.toggle('can-scroll-right', canScroll);
      if (canScroll) {
        var atEnd = el.scrollLeft + el.clientWidth >= el.scrollWidth - 2;
        el.classList.toggle('scrolled-end', atEnd);
      }
    }
    wraps.forEach(function(w){
      w.addEventListener('scroll', function(){ checkScroll(w); }, { passive: true });
      // モーダルが開かれたとき（表示後に計算するため少し遅延）
      var observer = new MutationObserver(function(){ setTimeout(function(){ checkScroll(w); }, 50); });
      var modal = w.closest('.modal');
      if (modal) observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
      checkScroll(w);
    });
    window.addEventListener('resize', function(){ wraps.forEach(checkScroll); });
  })();

  // 特定商取引法モーダル
  var openLegalLink = $('openLegalLink');
  if (openLegalLink) {
    openLegalLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('legalModal'));
    });
  }
  var legalCloseBtn = $('legalCloseBtn');
  if (legalCloseBtn) {
    legalCloseBtn.addEventListener('click', function() {
      closeModal($('legalModal'));
    });
  }
  var legalShippingLink = $('legalShippingLink');
  if (legalShippingLink) {
    legalShippingLink.addEventListener('click', function(e) {
      e.preventDefault();
      closeModal($('legalModal'));
      openModal($('shippingModal'));
    });
  }

  // プライバシーポリシーモーダル
  var openPrivacyLink = $('openPrivacyLink');
  if (openPrivacyLink) {
    openPrivacyLink.addEventListener('click', function(e) {
      e.preventDefault();
      openModal($('privacyModal'));
    });
  }
  var privacyCloseBtn = $('privacyCloseBtn');
  if (privacyCloseBtn) {
    privacyCloseBtn.addEventListener('click', function() {
      closeModal($('privacyModal'));
    });
  }

  // お問い合わせモーダル
  var openContactLink = $('openContactLink');
  var openContactLink2 = $('openContactLink2');
  function handleContactOpen_(e) {
    e.preventDefault();
    if (state.customer) {
      $('contactName').value = state.customer.companyName || '';
      $('contactEmail').value = state.customer.email || '';
    }
    openModal($('contactModal'));
  }
  if (openContactLink) openContactLink.addEventListener('click', handleContactOpen_);
  if (openContactLink2) openContactLink2.addEventListener('click', handleContactOpen_);
  var contactCloseBtn = $('contactCloseBtn');
  if (contactCloseBtn) {
    contactCloseBtn.addEventListener('click', function() {
      closeModal($('contactModal'));
    });
  }
  var contactSubmitBtn = $('contactSubmitBtn');
  if (contactSubmitBtn) {
    contactSubmitBtn.addEventListener('click', function() {
      var name = ($('contactName').value || '').trim();
      var email = ($('contactEmail').value || '').trim();
      var message = ($('contactMessage').value || '').trim();
      if (!name) { showToast('お名前を入力してください'); return; }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('有効なメールアドレスを入力してください'); return; }
      if (!message) { showToast('お問い合わせ内容を入力してください'); return; }
      contactSubmitBtn.disabled = true;
      contactSubmitBtn.textContent = '送信中...';
      runApi('apiSendContactForm', { name: name, email: email, message: message })
        .then(function(res) {
          if (res && res.ok) {
            closeModal($('contactModal'));
            $('contactName').value = '';
            $('contactEmail').value = '';
            $('contactMessage').value = '';
            showToast('お問い合わせを送信しました');
          } else {
            showToast((res && res.message) || '送信に失敗しました');
          }
        })
        .catch(function(e) { showToast(e.message || '送信に失敗しました'); })
        .finally(function() { contactSubmitBtn.disabled = false; contactSubmitBtn.textContent = '送信'; });
    });
  }


  // ログインボタン
  var loginBtn = $('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', doLogin_);
  }

  // 登録ボタン
  var registerBtn = $('registerBtn');
  if (registerBtn) {
    registerBtn.addEventListener('click', doRegister_);
  }

  // フォーム切り替え
  var showRegisterLink = $('showRegisterLink');
  if (showRegisterLink) {
    showRegisterLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  var showLoginLink = $('showLoginLink');
  if (showLoginLink) {
    showLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // パスワードを忘れた方
  var showForgotPasswordLink = $('showForgotPasswordLink');
  if (showForgotPasswordLink) {
    showForgotPasswordLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('forgotPassword');
    });
  }

  // メールアドレスを忘れた方
  var showForgotEmailLink = $('showForgotEmailLink');
  if (showForgotEmailLink) {
    showForgotEmailLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('forgotEmail');
    });
  }

  // パスワードリセット送信
  var resetPasswordBtn = $('resetPasswordBtn');
  if (resetPasswordBtn) {
    resetPasswordBtn.addEventListener('click', function() {
      var email = ($('resetEmail').value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('有効なメールアドレスを入力してください');
        return;
      }
      resetPasswordBtn.disabled = true;
      resetPasswordBtn.textContent = '送信中...';
      runApi('apiRequestPasswordReset', state.userKey || '', { email: email })
        .then(function(res) {
          if (res && res.ok) {
            showToast(res.message || '仮パスワードを送信しました');
            $('resetEmail').value = '';
            // ログイン画面に戻す
            setTimeout(function() { openAuthModal_('login'); }, 2000);
          } else {
            showToast((res && res.message) || '送信に失敗しました');
          }
        })
        .catch(function(e) { showToast('送信に失敗しました'); })
        .finally(function() {
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = '仮パスワードを送信';
        });
    });
  }

  // パスワードリセット→ログインに戻る
  var backToLoginFromReset = $('backToLoginFromReset');
  if (backToLoginFromReset) {
    backToLoginFromReset.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // メールアドレス確認送信
  var recoverEmailBtn = $('recoverEmailBtn');
  if (recoverEmailBtn) {
    recoverEmailBtn.addEventListener('click', function() {
      var companyName = ($('recoverCompanyName').value || '').trim();
      var phone = ($('recoverPhone').value || '').trim();
      if (!companyName) { showToast('会社名/氏名を入力してください'); return; }
      if (!phone) { showToast('電話番号を入力してください'); return; }
      recoverEmailBtn.disabled = true;
      recoverEmailBtn.textContent = '確認中...';
      var resultDiv = $('recoverEmailResult');
      resultDiv.style.display = 'none';
      runApi('apiRecoverEmail', state.userKey || '', { companyName: companyName, phone: phone })
        .then(function(res) {
          if (res && res.ok && res.data && res.data.maskedEmail) {
            resultDiv.innerHTML = 'ご登録のメールアドレス:<br><strong style="font-size:16px;">' + escapeHtml_(res.data.maskedEmail) + '</strong>';
            resultDiv.style.display = 'block';
          } else {
            showToast((res && res.message) || '一致する情報が見つかりませんでした');
          }
        })
        .catch(function(e) { showToast('確認に失敗しました'); })
        .finally(function() {
          recoverEmailBtn.disabled = false;
          recoverEmailBtn.textContent = 'メールアドレスを確認';
        });
    });
  }

  // メールアドレス確認→ログインに戻る
  var backToLoginFromRecover = $('backToLoginFromRecover');
  if (backToLoginFromRecover) {
    backToLoginFromRecover.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('login');
    });
  }

  // プロモバナー：×ボタン
  var promoClose = $('promoClose');
  if (promoClose) {
    promoClose.addEventListener('click', function() {
      var b = $('promoBanner');
      if (b) b.style.display = 'none';
      try { sessionStorage.setItem('promoBannerDismissed', '1'); } catch (e) {}
    });
  }

  // プロモバナー：登録リンク
  var promoLink = $('promoRegisterLink');
  if (promoLink) {
    promoLink.addEventListener('click', function(e) {
      e.preventDefault();
      openAuthModal_('register');
    });
  }

  // =====================================================
  // パスワード表示/非表示トグル
  // =====================================================
  document.querySelectorAll('.pw-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var target = $(btn.getAttribute('data-target'));
      if (!target) return;
      if (target.type === 'password') {
        target.type = 'text';
        btn.classList.add('active');
      } else {
        target.type = 'password';
        btn.classList.remove('active');
      }
    });
  });

  // =====================================================
  // ポイント利用（お届け先フォーム）
  // =====================================================
  var usePointsInput = $('usePoints');
  if (usePointsInput) {
    usePointsInput.addEventListener('input', function() {
      updatePointDiscountInfo_();
    });
  }
  var useAllPointsBtn = $('useAllPointsBtn');
  if (useAllPointsBtn) {
    useAllPointsBtn.addEventListener('click', function() {
      var max = (state.customer && state.customer.points) ? state.customer.points : 0;
      $('usePoints').value = max;
      updatePointDiscountInfo_();
    });
  }
  var applyPointsBtn = $('applyPointsBtn');
  if (applyPointsBtn) {
    applyPointsBtn.addEventListener('click', applyPointDiscount_);
  }
  var applyCouponBtn = $('applyCouponBtn');
  if (applyCouponBtn) applyCouponBtn.addEventListener('click', applyCoupon_);
  var removeCouponBtn = $('removeCouponBtn');
  if (removeCouponBtn) removeCouponBtn.addEventListener('click', removeCoupon_);

  // =====================================================
  // マイページモーダル
  // =====================================================
  var myPageCloseBtn = $('myPageCloseBtn');
  if (myPageCloseBtn) {
    myPageCloseBtn.addEventListener('click', function() { closeModal($('myPageModal')); });
  }

  // タブ切り替え
  var tabs = document.querySelectorAll('.mypage-tab');
  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      tabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      var target = tab.getAttribute('data-tab');
      $('mypageProfile').style.display = (target === 'profile') ? '' : 'none';
      $('mypageOrders').style.display = (target === 'orders') ? '' : 'none';
      $('mypagePoints').style.display = (target === 'points') ? '' : 'none';
    });
  });

  // 編集ボタン：readonly解除＋保存/キャンセル表示
  var mpEditBtn = $('mpEditBtn');
  var mpCancelEditBtn = $('mpCancelEditBtn');
  var mpProfileFields = ['mpCompanyName', 'mpPhone', 'mpPostal', 'mpAddress'];
  function setProfileEditable_(editable) {
    for (var fi = 0; fi < mpProfileFields.length; fi++) {
      var inp = $(mpProfileFields[fi]);
      if (inp) { inp.readOnly = !editable; inp.style.background = editable ? '#fff' : '#f5f5f5'; }
    }
    if ($('mpEditBtn')) $('mpEditBtn').style.display = editable ? 'none' : '';
    if ($('mpSaveBtn')) $('mpSaveBtn').style.display = editable ? '' : 'none';
    if ($('mpCancelEditBtn')) $('mpCancelEditBtn').style.display = editable ? '' : 'none';
  }
  if (mpEditBtn) {
    mpEditBtn.addEventListener('click', function() {
      // 編集前の値を保存
      mpEditBtn._backup = {};
      for (var fi = 0; fi < mpProfileFields.length; fi++) {
        mpEditBtn._backup[mpProfileFields[fi]] = $(mpProfileFields[fi]).value;
      }
      setProfileEditable_(true);
    });
  }
  if (mpCancelEditBtn) {
    mpCancelEditBtn.addEventListener('click', function() {
      // 編集前の値に戻す
      if (mpEditBtn && mpEditBtn._backup) {
        for (var fi = 0; fi < mpProfileFields.length; fi++) {
          $(mpProfileFields[fi]).value = mpEditBtn._backup[mpProfileFields[fi]] || '';
        }
      }
      setProfileEditable_(false);
    });
  }

  // プロフィール保存
  var mpSaveBtn = $('mpSaveBtn');
  if (mpSaveBtn) {
    mpSaveBtn.addEventListener('click', function() {
      var pw = prompt('本人確認のため現在のパスワードを入力してください');
      if (!pw) return;
      mpSaveBtn.disabled = true;
      mpSaveBtn.textContent = '保存中...';
      runApi('apiUpdateCustomerProfile', state.userKey || '', {
        sessionId: state.sessionId,
        currentPassword: pw,
        companyName: $('mpCompanyName').value,
        phone: $('mpPhone').value,
        postal: $('mpPostal').value,
        address: $('mpAddress').value
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || '更新しました');
          if (state.customer) {
            state.customer.companyName = $('mpCompanyName').value;
            state.customer.phone = $('mpPhone').value;
            state.customer.postal = $('mpPostal').value;
            state.customer.address = $('mpAddress').value;
            saveSession_(state.sessionId, state.customer);
            updateAuthUi_();
          }
          setProfileEditable_(false);
        } else {
          showToast((res && res.message) || '更新に失敗しました');
        }
      }).catch(function() { showToast('更新に失敗しました'); })
        .finally(function() { mpSaveBtn.disabled = false; mpSaveBtn.textContent = '変更を保存'; });
    });
  }

  // パスワード変更トグル
  var mpTogglePasswordBtn = $('mpTogglePasswordBtn');
  if (mpTogglePasswordBtn) {
    mpTogglePasswordBtn.addEventListener('click', function() {
      var section = $('mpPasswordSection');
      section.style.display = section.style.display === 'none' ? '' : 'none';
    });
  }

  // パスワード変更実行
  var mpChangePassBtn = $('mpChangePassBtn');
  if (mpChangePassBtn) {
    mpChangePassBtn.addEventListener('click', function() {
      var cur = $('mpCurPass').value;
      var np = $('mpNewPass').value;
      var npc = $('mpNewPassConfirm').value;
      if (!cur) { showToast('現在のパスワードを入力してください'); return; }
      if (!np || np.length < 6) { showToast('新しいパスワードは6文字以上で入力してください'); return; }
      if (np !== npc) { showToast('新しいパスワードが一致しません'); return; }
      mpChangePassBtn.disabled = true;
      mpChangePassBtn.textContent = '変更中...';
      runApi('apiChangePassword', state.userKey || '', {
        sessionId: state.sessionId,
        currentPassword: cur,
        newPassword: np
      }).then(function(res) {
        if (res && res.ok) {
          showToast(res.message || 'パスワードを変更しました');
          $('mpCurPass').value = '';
          $('mpNewPass').value = '';
          $('mpNewPassConfirm').value = '';
          $('mpPasswordSection').style.display = 'none';
        } else {
          showToast((res && res.message) || 'パスワード変更に失敗しました');
        }
      }).catch(function() { showToast('パスワード変更に失敗しました'); })
        .finally(function() { mpChangePassBtn.disabled = false; mpChangePassBtn.textContent = 'パスワードを変更'; });
    });
  }
}

function setSending_(on, text) {
  var ov = $('sendingOverlay');
  var tx = $('sendingText');
  if (tx) tx.textContent = String(text || '依頼送信中...');
  if (!ov) return;
  if (on) { ov.classList.add('on'); document.body.style.overflow = 'hidden'; }
  else { ov.classList.remove('on'); document.body.style.overflow = ''; }
}

function loadUserKey() {
  var k = localStorage.getItem('estimate_userKey');
  if (k) return k;
  var nk = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem('estimate_userKey', nk);
  return nk;
}

function loadCartStorage() {
  try {
    var raw = localStorage.getItem('estimate_cart_v2');
    if (!raw) return { ids: [], itemsById: {} };
    var j = JSON.parse(raw);
    return { ids: Array.isArray(j.ids) ? j.ids : [], itemsById: j.itemsById || {} };
  } catch (e) { return { ids: [], itemsById: {} }; }
}

function saveCartStorage() {
  try {
    var sh = state.lastShipping || {};
    var shippingAmount = (sh.amount !== undefined && sh.amount !== null) ? sh.amount : 0;
    localStorage.setItem('estimate_cart_v2', JSON.stringify({
      ids: state.cart.ids || [],
      itemsById: state.cart.itemsById || {},
      shipping: shippingAmount,
      shippingLabel: sh.label || '',
      shippingPref: sh.pref || '',
      shippingSizeLabel: sh.sizeLabel || ''
    }));
  } catch (e) {}
}

function loadBulkCartStorage() {
  try {
    var raw = localStorage.getItem('bulk_cart_v1');
    if (!raw) return { subtotal: 0, totalQty: 0, shipping: 0 };
    var j = JSON.parse(raw);
    return { subtotal: Number(j.subtotal || 0), totalQty: Number(j.totalQty || 0), shipping: Number(j.shipping || 0) };
  } catch (e) { return { subtotal: 0, totalQty: 0, shipping: 0 }; }
}

// =====================================================
// カートクリア（3ボタン）
// =====================================================
function clearDetauriCartOnly_() {
  if (!confirm('デタウリカートを空にしますか？')) return;
  state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
  saveCartStorage(); updateCartCount(); renderCartModal_(); updateShippingDisplay_(); filterAndRender(false);
  runApi('apiSyncHolds', state.userKey, []).catch(function() {});
  showToast('デタウリカートを空にしました');
}

function clearBulkCartOnly_() {
  if (!confirm('アソートカートを空にしますか？')) return;
  try { localStorage.removeItem('bulk_cart_v1'); } catch (e) {}
  updateCartCount(); renderCartModal_();
  showToast('アソートカートを空にしました');
}

function clearAllCarts_() {
  if (!confirm('すべてのカートを空にしますか？')) return;
  state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
  saveCartStorage(); updateCartCount(); updateShippingDisplay_(); filterAndRender(false);
  runApi('apiSyncHolds', state.userKey, []).catch(function() {});
  try { localStorage.removeItem('bulk_cart_v1'); } catch (e) {}
  renderCartModal_();
  showToast('すべてのカートを空にしました');
}

function updateCartClearBtns_() {
  var wrap = $('cartClearBtns');
  if (!wrap) return;
  var hasDetauri = (state.cart.ids || []).length > 0;
  var bulk = loadBulkCartStorage();
  var hasBulk = bulk.subtotal > 0;
  if (!hasDetauri && !hasBulk) { wrap.innerHTML = ''; return; }
  var btns = '';
  if (hasDetauri) btns += '<button class="btn" type="button" onclick="clearDetauriCartOnly_()" style="font-size:11px;padding:6px 10px;min-width:auto;">デタウリ空</button>';
  if (hasBulk) btns += '<button class="btn" type="button" onclick="clearBulkCartOnly_()" style="font-size:11px;padding:6px 10px;min-width:auto;">アソート空</button>';
  if (hasDetauri && hasBulk) btns += '<button class="btn" type="button" onclick="clearAllCarts_()" style="font-size:11px;padding:6px 10px;min-width:auto;color:#b8002a;border-color:#b8002a;">すべて空</button>';
  wrap.innerHTML = btns;
}

// 住所共有（localStorage経由で両ページ間で共有）
var SHARED_ADDRESS_KEY = 'shared_address_v1';
function saveSharedAddress_() {
  try {
    var prev = {};
    try { prev = JSON.parse(localStorage.getItem(SHARED_ADDRESS_KEY)) || {}; } catch(e2){}
    var data = {
      companyName: ($('companyName') ? $('companyName').value : '').trim(),
      contact: ($('contact') ? $('contact').value : '').trim(),
      postal: ($('postal') ? $('postal').value : '').trim(),
      address: ($('address') ? $('address').value : '').trim(),
      building: prev.building || '',
      phone: ($('phone') ? $('phone').value : '').trim(),
      note: ($('note') ? $('note').value : '').trim(),
      ts: Date.now()
    };
    localStorage.setItem(SHARED_ADDRESS_KEY, JSON.stringify(data));
  } catch (e) {}
}
function loadSharedAddress_() {
  try {
    var raw = localStorage.getItem(SHARED_ADDRESS_KEY);
    if (!raw) return;
    var data = JSON.parse(raw);
    if (!data || !data.ts) return;
    var fields = ['companyName', 'contact', 'postal', 'address', 'phone', 'note'];
    for (var i = 0; i < fields.length; i++) {
      var el = $(fields[i]);
      if (el && data[fields[i]]) el.value = data[fields[i]];
    }
  } catch (e) {}
}

// 他タブでの住所変更をリアルタイム反映
window.addEventListener('storage', function(e) {
  if (e.key === SHARED_ADDRESS_KEY && e.newValue) {
    try {
      var data = JSON.parse(e.newValue);
      if (!data || !data.ts) return;
      var fields = ['companyName', 'contact', 'postal', 'address', 'phone', 'note'];
      for (var i = 0; i < fields.length; i++) {
        var el = $(fields[i]);
        if (el && data[fields[i]] !== undefined) el.value = data[fields[i]];
      }
      updateShippingDisplay_();
    } catch (err) {}
  }
});

function openModal(modal) {
  $('overlay').classList.add('open'); modal.classList.add('open');
  // モーダル表示中はチャットボットFABとスクロールトップボタンを非表示
  var chatFab = document.getElementById('chatbotFab');
  var topBtn = document.getElementById('toTopBtn');
  if (chatFab) chatFab.style.display = 'none';
  if (topBtn) topBtn.classList.remove('show');
}
function closeModal(modal) {
  modal.classList.remove('open');
  if (!document.querySelector('.modal.open')) {
    $('overlay').classList.remove('open');
    // 他にモーダルがなければボタン類を再表示
    var chatFab = document.getElementById('chatbotFab');
    if (chatFab) chatFab.style.display = '';
  }
}
function closeAllModals() {
  document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); });
  $('overlay').classList.remove('open');
  var chatFab = document.getElementById('chatbotFab');
  if (chatFab) chatFab.style.display = '';
}

function convertDriveImageUrl(url, maxWidth) {
  if (!url) return '';
  var m = url.match(/(?:id=|\/d\/)([A-Za-z0-9_-]{10,})/);
  if (m && m[1]) {
    var base = 'https://lh3.googleusercontent.com/d/' + m[1];
    if (maxWidth) return base + '=w' + maxWidth;
    return base;
  }
  return url;
}

function normalizeStatus_(s) { return String(s || '').trim(); }
function statusKind_(s) {
  var t = normalizeStatus_(s);
  if (!t) return 'available';
  if (t.indexOf('依頼中') !== -1) return 'open';
  if (t.indexOf('確保中') !== -1) return 'hold';
  if (t.indexOf('在庫') !== -1) return 'available';
  return 'available';
}

function getMeasureOptValue_() { return 'with'; }
function setMeasureOptValue_(v) {}
function loadMeasureOpt_() { return 'with'; }
function saveMeasureOpt_() {}

// =====================================================
// GAS API呼び出し（GASモード / スタンドアロンモード自動判定）
// =====================================================

// ★ スタンドアロン（Cloudflare Pages等）で使う場合はここにGAS Web App URLを設定
var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';

var IS_STANDALONE = (typeof google === 'undefined' || !google.script);

// reCAPTCHA v3 サイトキー（★ Google reCAPTCHA管理画面で取得して設定）
var RECAPTCHA_SITE_KEY = '6LeMeF0sAAAAAK1DLANrMyfuugoe6mdWMQbY2ao1';
// Admin Key: URLから取得後、localStorageに保存してURLから除去（ブラウザ履歴・Refererへの漏洩対策）
var ADMIN_KEY = (function() {
  var urlKey = (new URLSearchParams(window.location.search)).get('admin') || '';
  if (urlKey) {
    try { localStorage.setItem('_nk_owner_key', urlKey); } catch(e) {}
    // URLからadminパラメータを除去（ブラウザ履歴・Refererヘッダーへの漏洩防止）
    try {
      var cleanUrl = new URL(window.location.href);
      cleanUrl.searchParams.delete('admin');
      window.history.replaceState({}, '', cleanUrl.toString());
    } catch(e) {}
    return urlKey;
  }
  try { return localStorage.getItem('_nk_owner_key') || ''; } catch(e) { return ''; }
})();
var IS_OWNER = !!ADMIN_KEY;

// reCAPTCHAスクリプトを遅延ロード（初回呼出し時にのみ読み込み）
var _recaptchaLoadPromise = null;
function loadRecaptchaScript_() {
  if (_recaptchaLoadPromise) return _recaptchaLoadPromise;
  if (typeof grecaptcha !== 'undefined') return Promise.resolve();
  _recaptchaLoadPromise = new Promise(function(resolve) {
    var s = document.createElement('script');
    s.src = 'https://www.google.com/recaptcha/api.js?render=' + RECAPTCHA_SITE_KEY;
    s.async = true;
    s.defer = true;
    s.onload = function() {
      // grecaptcha.readyで初期化完了を待つ
      if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
        grecaptcha.ready(resolve);
      } else {
        resolve();
      }
    };
    s.onerror = function() { resolve(); };
    document.head.appendChild(s);
  });
  return _recaptchaLoadPromise;
}

function getRecaptchaToken_() {
  if (!RECAPTCHA_SITE_KEY || RECAPTCHA_SITE_KEY.indexOf('RECAPTCHA') !== -1) {
    return Promise.resolve('');
  }
  return loadRecaptchaScript_().then(function() {
    if (typeof grecaptcha === 'undefined') {
      console.warn('reCAPTCHA not available after load');
      return '';
    }
    try {
      return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }).catch(function(e) {
        console.warn('reCAPTCHA execute failed:', e);
        return '';
      });
    } catch (e) {
      console.warn('reCAPTCHA execute error:', e);
      return '';
    }
  });
}

function runApi(fn, _extra) {
  var args = Array.prototype.slice.call(arguments, 1);
  var extra = {};
  // 最後の引数が _runApiExtra_ なら取り出す
  if (args.length > 0 && args[args.length - 1] && args[args.length - 1]._runApiExtra_) {
    extra = args.pop();
  }

  if (IS_STANDALONE) {
    var payload = { action: fn, args: args };
    if ('recaptchaToken' in extra) payload.recaptchaToken = extra.recaptchaToken;
    if (ADMIN_KEY) payload.adminKey = ADMIN_KEY;
    if (state.csrfToken) payload.csrfToken = state.csrfToken;
    return fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
      redirect: 'follow'
    })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      if (data && data.ok === false) throw new Error(data.message || 'APIエラー');
      return data;
    });
  }

  return new Promise(function(resolve, reject) {
    var done = false;
    var timer = setTimeout(function() {
      if (done) return;
      done = true;
      reject(new Error('タイムアウト'));
    }, 30000);

    try {
      var runner = google.script.run
        .withSuccessHandler(function(res) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve(res);
        })
        .withFailureHandler(function(err) {
          if (done) return;
          done = true;
          clearTimeout(timer);
          reject(err);
        });

      runner[fn].apply(runner, args);
    } catch (e) {
      if (done) return;
      done = true;
      clearTimeout(timer);
      reject(e);
    }
  });
}

// =====================================================
// データ読み込み（キャッシュから高速取得）
// =====================================================

var PRODUCT_CACHE_KEY = 'estimate_products_cache';
var PRODUCT_CACHE_TTL = 5 * 60 * 1000; // 5分

function saveProductCache_(data) {
  try {
    var cache = { ts: Date.now(), data: data };
    localStorage.setItem(PRODUCT_CACHE_KEY, JSON.stringify(cache));
  } catch (e) { console.warn('キャッシュ保存失敗:', e); }
}

function loadProductCache_() {
  try {
    var raw = localStorage.getItem(PRODUCT_CACHE_KEY);
    if (!raw) return null;
    var cache = JSON.parse(raw);
    // 5分以内のキャッシュなら使用
    if (cache && cache.ts && (Date.now() - cache.ts < PRODUCT_CACHE_TTL) && cache.data) {
      return cache.data;
    }
    return cache && cache.data ? { data: cache.data, stale: true } : null;
  } catch (e) { return null; }
}

function loadProductData() {
  if (IS_STANDALONE) {
    return runApi('apiGetCachedProducts').then(function(res) {
      if (res && res.ok && res.data) {
        console.log('データ読み込み完了:', res.data.totalCount + '件');
        saveProductCache_(res.data);
        return res.data;
      }
      throw new Error(res && res.message ? res.message : 'データ取得に失敗');
    });
  }

  return new Promise(function(resolve, reject) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res && res.ok && res.data) {
          console.log('データ読み込み完了:', res.data.totalCount + '件');
          saveProductCache_(res.data);
          resolve(res.data);
        } else {
          reject(new Error(res && res.message ? res.message : 'データ取得に失敗'));
        }
      })
      .withFailureHandler(function(err) {
        reject(err);
      })
      .apiGetCachedProducts();
  });
}

// =====================================================
// フィルタ・ソート（クライアント側で即時処理）
// =====================================================

function applyFilters_() {
  var f = state.query.filters;
  var products = state.allProducts;
  var hasFilter = false;

  if (f.brand && f.brand.length > 0) {
    hasFilter = true;
    products = products.filter(function(p) {
      var normalizedBrand = normalizeBrand_(p.brand);
      return f.brand.indexOf(normalizedBrand) !== -1;
    });
  }
  if (f.category && f.category.length > 0) {
    hasFilter = true;
    products = products.filter(function(p) { return f.category.indexOf(p.category) !== -1; });
  }
  if (f.state && f.state.length > 0) {
    hasFilter = true;
    products = products.filter(function(p) { return f.state.indexOf(p.state) !== -1; });
  }
  if (f.gender && f.gender.length > 0) {
    hasFilter = true;
    products = products.filter(function(p) { return f.gender.indexOf(p.gender) !== -1; });
  }
  if (f.size && f.size.length > 0) {
    hasFilter = true;
    products = products.filter(function(p) { return f.size.indexOf(p.size) !== -1; });
  }

  // フィルタが一つもかかっていない場合は元配列参照を返す（sliceしない）
  return hasFilter ? products : products.slice();
}

function applySort_(products) {
  var s = state.query.sort;
  // filter結果は既に新配列なので再度sliceは不要
  var sorted = products;
  
  if (s.key === 'default') return s.dir === 'desc' ? sorted.reverse() : sorted;
  
  sorted.sort(function(a, b) {
    var va, vb;
    switch (s.key) {
      case 'price': va = Number(a.price) || 0; vb = Number(b.price) || 0; break;
      case 'brand': va = String(a.brand || ''); vb = String(b.brand || ''); break;
      case 'category': va = String(a.category || ''); vb = String(b.category || ''); break;
      default: return 0;
    }
    if (typeof va === 'string') {
      var cmp = va.localeCompare(vb, 'ja');
      return s.dir === 'desc' ? -cmp : cmp;
    }
    return s.dir === 'desc' ? (vb - va) : (va - vb);
  });
  
  return sorted;
}

function filterAndRender(scrollTop) {
  var filtered = applyFilters_();
  filtered = applySort_(filtered);
  state.filteredProducts = filtered;
  
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var totalPages = Math.ceil(filtered.length / pageSize) || 1;
  
  if (page > totalPages) { page = totalPages; state.query.page = page; }
  
  var start = (page - 1) * pageSize;
  var pageItems = filtered.slice(start, start + pageSize);
  
  updateTotalCountBadge_(filtered.length);
  renderGrid_(pageItems);
  renderPager_(totalPages, page);
  
  if (scrollTop) window.scrollTo({ top: 0, behavior: 'auto' });
  
  pollStatusNow_();
}

// =====================================================
// 確保状態リアルタイム取得
// =====================================================

function pollStatusNow_() {
  if (state.timers.statusPoll) { clearTimeout(state.timers.statusPoll); state.timers.statusPoll = null; }

  // 確保同期中はポーリングをスキップ（apiSyncHolds完了後に再呼び出しされる）
  if (state._holdSyncing) {
    state.timers.statusPoll = setTimeout(pollStatusNow_, 3000);
    return;
  }

  // タブが非表示の場合はポーリングを一時停止
  if (document.hidden) {
    state.timers.statusPoll = setTimeout(pollStatusNow_, 30000);
    return;
  }

  var ids = [];
  var pageItems = getCurrentPageItems_();
  for (var i = 0; i < pageItems.length; i++) {
    if (pageItems[i] && pageItems[i].managedId) ids.push(pageItems[i].managedId);
  }
  for (var j = 0; j < state.cart.ids.length; j++) {
    if (ids.indexOf(state.cart.ids[j]) === -1) ids.push(state.cart.ids[j]);
  }

  if (ids.length === 0) return;

  runApi('apiGetStatusDigest', state.userKey, ids)
    .then(function(res) {
      if (res && res.ok && res.map) {
        // マージ: 楽観的・サーバー確認済みエントリを保護
        var now = Date.now();
        var merged = {};
        for (var mk in res.map) merged[mk] = res.map[mk];
        for (var ok in state.cart.digest) {
          var existing = state.cart.digest[ok];
          if (!existing) continue;
          // 楽観的エントリ → サーバー応答に関わらず常に保護
          // （ポーリングはカート追加前に送信されており、サーバー応答は古い状態を反映するため）
          if (existing._optimistic) { merged[ok] = existing; continue; }
          // サーバー確認済み(15秒以内) → サーバー確認データを優先
          if (existing._confirmedAt && (now - existing._confirmedAt < 15000)) {
            merged[ok] = existing;
          }
        }
        state.cart.digest = merged;

        // 確保タイムアウト: カート内アイテムの確保が切れたら自動解除
        var expired = [];
        var GRACE_MS = 15000; // 15秒のグレース期間
        for (var ci = 0; ci < state.cart.ids.length; ci++) {
          var cid = state.cart.ids[ci];
          var dd = state.cart.digest[cid];
          // 楽観的更新中 → スキップ
          if (dd && dd._optimistic) continue;
          // サーバー確認済み15秒以内 → スキップ（PropertiesService伝播待ち）
          if (dd && dd._confirmedAt && (now - dd._confirmedAt < GRACE_MS)) continue;
          var d = merged[cid];
          // サーバーが「在庫あり」を返す = 確保が切れている
          if (d && d.status && statusKind_(normalizeStatus_(d.status)) === 'available') {
            expired.push(cid);
          }
        }
        if (expired.length > 0) {
          for (var ei = 0; ei < expired.length; ei++) {
            var eid = expired[ei];
            var idx = state.cart.ids.indexOf(eid);
            if (idx !== -1) state.cart.ids.splice(idx, 1);
            delete state.cart.itemsById[eid];
            delete state.cart.digest[eid];
          }
          state.lastShipping = null;
          saveCartStorage(); updateCartCount(); updateShippingDisplay_();
          showToast('確保期限が切れた商品（' + expired.length + '点）をカートから除外しました');
        }

        for (var id in state.ui.cardEls) updateCardUi_(id);
      }
    })
    .catch(function(e) { console.log('ステータス取得エラー:', e); });

  state.timers.statusPoll = setTimeout(pollStatusNow_, 10000);
}

function getCurrentPageItems_() {
  var page = state.query.page;
  var pageSize = state.query.pageSize;
  var start = (page - 1) * pageSize;
  return state.filteredProducts.slice(start, start + pageSize);
}

// =====================================================
// 表示系
// =====================================================

function updateTotalCountBadge_(total) {
  var el = $('totalCountBadge');
  if (el) el.textContent = total ? ('商品点数：' + total + '点') : '';
}

function renderLoadingGrid_() {
  var g = $('grid'); g.innerHTML = '';
  for (var i = 0; i < 8; i++) {
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'LOADING';
    var body = document.createElement('div'); body.className = 'cardbody';
    var line = document.createElement('div'); line.className = 'meta'; line.textContent = '読み込み中...';
    body.appendChild(line); card.appendChild(thumb); card.appendChild(body); g.appendChild(card);
  }
}

function setSelectOptions(select, list, placeholder) {
  select.innerHTML = '';
  var op0 = document.createElement('option'); op0.value = ''; op0.textContent = placeholder; select.appendChild(op0);
  for (var i = 0; i < list.length; i++) {
    var op = document.createElement('option'); op.value = String(list[i]); op.textContent = String(list[i]); select.appendChild(op);
  }
}

// マルチセレクトフィルター
var multiSelectState = { category: [], state: [], gender: [], size: [] };

function buildMultiSelectDropdown(filterKey, options) {
  var dropdown = $('f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Dropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var val = String(options[i]);
    var item = document.createElement('div');
    item.className = 'multiSelectItem';
    item.dataset.value = val;
    if (multiSelectState[filterKey].indexOf(val) !== -1) item.classList.add('selected');

    var checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    var span = document.createElement('span');
    span.textContent = val;

    item.appendChild(checkIcon);
    item.appendChild(span);

    item.addEventListener('click', (function(key, v, el) {
      return function(e) {
        e.stopPropagation();
        var isSelected = el.classList.contains('selected');
        if (isSelected) {
          el.classList.remove('selected');
          var idx = multiSelectState[key].indexOf(v);
          if (idx !== -1) multiSelectState[key].splice(idx, 1);
        } else {
          el.classList.add('selected');
          if (multiSelectState[key].indexOf(v) === -1) multiSelectState[key].push(v);
        }
        state.query.filters[key] = multiSelectState[key].slice();
        updateMultiSelectBtn(key);
        filterAndRender(true);
      };
    })(filterKey, val, item));
    dropdown.appendChild(item);
  }
}

function updateMultiSelectBtn(filterKey) {
  var btnId = 'f' + filterKey.charAt(0).toUpperCase() + filterKey.slice(1) + 'Btn';
  var btn = $(btnId);
  if (!btn) return;
  var count = multiSelectState[filterKey].length;
  var countSpan = btn.querySelector('.filterCount');
  if (countSpan) countSpan.textContent = count > 0 ? count : '';
  btn.classList.toggle('active', count > 0);
}

function setupMultiSelectFilters() {
  var filters = ['category', 'state', 'gender', 'size'];
  var labels = { category: 'カテゴリ', state: '状態', gender: '性別', size: 'サイズ' };

  filters.forEach(function(key) {
    var btnId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Btn';
    var dropdownId = 'f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown';
    var btn = $(btnId);
    var dropdown = $(dropdownId);
    if (!btn || !dropdown) return;

    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      // 他のドロップダウンを閉じる
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        if (d.id !== dropdownId) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
    });
  });

  // 外側クリックでドロップダウンを閉じる
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.multiSelectField')) {
      document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
        d.classList.remove('open');
      });
    }
  });
}

function resetMultiSelectFilters() {
  multiSelectState = { category: [], state: [], gender: [], size: [] };
  state.query.filters.category = [];
  state.query.filters.state = [];
  state.query.filters.gender = [];
  state.query.filters.size = [];
  ['category', 'state', 'gender', 'size'].forEach(function(key) {
    updateMultiSelectBtn(key);
    var dropdown = $('f' + key.charAt(0).toUpperCase() + key.slice(1) + 'Dropdown');
    if (dropdown) {
      dropdown.querySelectorAll('.multiSelectItem').forEach(function(item) {
        item.classList.remove('selected');
      });
    }
  });
}

function setSortOptions(sortDefs) {
  var dropdown = $('sortDropdown');
  if (!dropdown) return;
  dropdown.innerHTML = '';
  for (var i = 0; i < sortDefs.length; i++) {
    var s = sortDefs[i];
    var item = document.createElement('div');
    item.className = 'sort-item' + (s.key === state.query.sort.key ? ' selected' : '');
    item.dataset.key = s.key;
    item.dataset.label = s.label;
    item.textContent = s.label;
    item.addEventListener('click', (function(key) {
      return function() {
        state.query.sort.key = key;
        updateSortChip_();
        dropdown.classList.remove('open');
        state.query.page = 1;
        filterAndRender(true);
      };
    })(s.key));
    dropdown.appendChild(item);
  }
  updateSortChip_();
}

function updateSortChip_() {
  var btn = $('sortChipBtn');
  var label = $('sortChipLabel');
  var dropdown = $('sortDropdown');
  if (!btn || !label) return;
  var items = dropdown ? dropdown.querySelectorAll('.sort-item') : [];
  var activeLabel = '標準';
  for (var i = 0; i < items.length; i++) {
    if (items[i].dataset.key === state.query.sort.key) {
      items[i].classList.add('selected');
      activeLabel = items[i].dataset.label;
    } else {
      items[i].classList.remove('selected');
    }
  }
  label.textContent = activeLabel;
  btn.classList.toggle('active', state.query.sort.key !== 'default');
}

function setStatusBadge_(el, status) {
  if (!el) return;
  var t = normalizeStatus_(status);
  var k = statusKind_(t);
  el.className = 'badge';
  if (k === 'available') el.className = 'badge ok';
  else if (k === 'open') el.className = 'badge lock';
  else if (k === 'hold') el.className = 'badge warn';
  el.textContent = t || '在庫あり';
}

function effectiveStatusFor_(id, selected, itemStatus) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  var ds = d && d.status ? normalizeStatus_(d.status) : '';
  if (selected) {
    if (d) {
      var k = statusKind_(ds);
      if (k === 'open') return ds || '依頼中';
      if (k === 'hold' && d.heldByOther) return ds || '確保中';
    }
    return '確保中';
  }
  return ds || normalizeStatus_(itemStatus) || '在庫あり';
}

function effectiveHeldByOtherFor_(id) {
  var d = state.cart.digest ? state.cart.digest[id] : null;
  return !!(d && d.heldByOther);
}

function computeDisabledForCard_(it, id) {
  var selected = state.cart.ids.indexOf(id) !== -1;
  var effectiveStatus = effectiveStatusFor_(id, selected, it.status);
  var effectiveHeldByOther = effectiveHeldByOtherFor_(id);
  var disabled = (!it.selectable) || (statusKind_(effectiveStatus) === 'open') || (statusKind_(effectiveStatus) === 'hold' && effectiveHeldByOther);
  return { selected: selected, effectiveStatus: effectiveStatus, effectiveHeldByOther: effectiveHeldByOther, disabled: disabled };
}

function applyBtnUi_(btn, it, id) {
  if (!btn || !it) return;
  var r = computeDisabledForCard_(it, id);
  if (r.disabled) {
    btn.className = 'selectBtn disabled'; btn.disabled = true;
    btn.textContent = statusKind_(r.effectiveStatus) === 'open' ? '依頼中（選択不可）' : '確保中（選択不可）';
    return;
  }
  if (r.selected) { btn.className = 'selectBtn'; btn.disabled = false; btn.textContent = '選択中（解除）'; return; }
  btn.className = 'selectBtn off'; btn.disabled = false; btn.textContent = 'カートへ追加';
}

function updateCardUi_(id) {
  var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
  if (!rec) return;
  var it = rec.item;
  if (!it) return;
  var r = computeDisabledForCard_(it, id);
  if (rec.bStatus) setStatusBadge_(rec.bStatus, r.effectiveStatus);
  if (rec.btn) applyBtnUi_(rec.btn, it, id);
}

function upsertCartItem_(it) {
  if (!it || !it.managedId) return;
  state.cart.itemsById[it.managedId] = {
    managedId: it.managedId, noLabel: it.noLabel, imageUrl: it.imageUrl, brand: it.brand,
    size: it.size, gender: it.gender, category: it.category, color: it.color, state: it.state,
    price: Number(it.price || 0), measurements: it.measurements || {}, defectDetail: it.defectDetail || '',
    shippingMethod: it.shippingMethod || ''
  };
}

function renderGrid_(items) {
  var g = $('grid'); g.innerHTML = ''; state.ui.cardEls = {};
  
  if (!items || items.length === 0) {
    var msg = document.createElement('div'); msg.textContent = '該当する商品がありません'; msg.style.padding = '12px'; g.appendChild(msg); return;
  }
  
  var frag = document.createDocumentFragment();
  
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    if (!it) continue;
    upsertCartItem_(it);
    var id = it.managedId;
    var r = computeDisabledForCard_(it, id);
    
    var card = document.createElement('div'); card.className = 'card';
    var thumb = document.createElement('div'); thumb.className = 'thumb';
    var imgEl = null;
    
    if (it.imageUrl) {
      var img = document.createElement('img');
      var fixedUrl = convertDriveImageUrl(it.imageUrl, 300);
      var fullUrl = convertDriveImageUrl(it.imageUrl);
      img.src = fixedUrl; img.alt = it.noLabel || id; img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
      img.className = 'product-image-clickable'; img.style.cursor = 'zoom-in';
      (function(mid, iurl, thumbUrl) {
        img.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); });
        img.addEventListener('mouseenter', function() { var p = new Image(); p.src = iurl; }, { once: true });
      })(id, fullUrl, fixedUrl);
      imgEl = img; thumb.appendChild(img);
    } else { thumb.textContent = 'NO IMAGE'; }
    card.appendChild(thumb);
    
    var body = document.createElement('div'); body.className = 'cardbody';
    var row1 = document.createElement('div'); row1.className = 'row1';
    var leftTitle = document.createElement('div'); leftTitle.className = 'leftTitle'; leftTitle.style.cursor = 'pointer';
    var spanNo = document.createElement('span'); spanNo.className = 'noText'; spanNo.textContent = it.noLabel ? it.noLabel : ('No. ' + id);
    var spanBrand = document.createElement('div'); spanBrand.className = 'brandText'; spanBrand.textContent = it.brand || '';
    spanBrand.style.cursor = 'pointer';
    leftTitle.appendChild(spanNo);
    (function(mid, iurl, thumbUrl) { leftTitle.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '', it.imageUrl ? convertDriveImageUrl(it.imageUrl, 300) : '');
    (function(mid, iurl, thumbUrl) { spanBrand.addEventListener('click', function(e) { e.stopPropagation(); openDetailModal(mid, iurl, thumbUrl); }); })(id, it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '', it.imageUrl ? convertDriveImageUrl(it.imageUrl, 300) : '');
    var price = document.createElement('div'); price.className = 'price'; price.textContent = yen(it.price);
    row1.appendChild(leftTitle); row1.appendChild(price); body.appendChild(row1);
    if (spanBrand.textContent) body.appendChild(spanBrand);
    
    // 傷汚れ詳細の有無を表示（カードの高さを揃えるため常にスペースを確保）
    var defectLine = document.createElement('div'); defectLine.className = 'defectLine';
    if (it.defectDetail && it.defectDetail.trim()) {
      defectLine.textContent = '詳細事項あり';
      defectLine.classList.add('hasDefect');
    } else {
      defectLine.innerHTML = '&nbsp;'; // 空白でも高さを確保
    }
    body.appendChild(defectLine);

    var badges = document.createElement('div'); badges.className = 'badges';
    var bState = document.createElement('div'); bState.className = 'badge'; bState.textContent = it.state || ''; badges.appendChild(bState);
    var bStatus = document.createElement('div'); setStatusBadge_(bStatus, r.effectiveStatus); badges.appendChild(bStatus); body.appendChild(badges);
    
    var btn = document.createElement('button'); btn.type = 'button'; applyBtnUi_(btn, it, id);
    (function(itemRef, idRef) { btn.addEventListener('click', function() { if (computeDisabledForCard_(itemRef, idRef).disabled) return; toggleCartOptimistic_(idRef); }); })(it, id);
    
    var actions = document.createElement('div'); actions.className = 'actions'; actions.appendChild(btn); body.appendChild(actions);
    card.appendChild(body); frag.appendChild(card);
    state.ui.cardEls[id] = { bStatus: bStatus, btn: btn, item: it, img: imgEl };
  }
  
  g.appendChild(frag);
}

function renderPager_(totalPages, currentPage) {
  var p = $('pager'); p.innerHTML = '';
  if (totalPages <= 1) return;
  var maxButtons = 9;
  var start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  var end = Math.min(totalPages, start + maxButtons - 1);
  start = Math.max(1, end - maxButtons + 1);
  for (var i = start; i <= end; i++) {
    var b = document.createElement('button');
    b.className = 'pageBtn' + (i === currentPage ? ' active' : '');
    b.textContent = String(i);
    (function(pn) { b.addEventListener('click', function() { state.query.page = pn; filterAndRender(true); }); })(i);
    p.appendChild(b);
  }
}

// =====================================================
// カート
// =====================================================

function updateCartCount() {
  var detauriCount = (state.cart.ids || []).length;
  var bulk = loadBulkCartStorage();
  var totalCount = detauriCount + bulk.totalQty;
  $('cartCount').textContent = String(totalCount);
  updateCartPrice();
}

function updateCartPrice() {
  var ids = state.cart.ids || [];
  var sum = 0;
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }
  var count = ids.length;
  var discounted;
  if (state.appliedCoupon && state.appliedCoupon.code && state.appliedCoupon.type !== 'shipping_free') {
    var cd = state.appliedCoupon.discountAmount || 0;
    var afterCoupon = Math.max(0, sum - cd);
    var comboRate = 0;
    if (state.appliedCoupon.comboBulk && count >= 30) comboRate += BULK_DISCOUNT_RATE;
    if (state.appliedCoupon.comboMember && state.customer && MEMBER_DISCOUNT_ENABLED) comboRate += MEMBER_DISCOUNT_RATE;
    discounted = Math.round(afterCoupon * (1 - comboRate));
  } else {
    var discountRate = 0;
    if (count >= 30) discountRate += BULK_DISCOUNT_RATE;
    if (state.customer && MEMBER_DISCOUNT_ENABLED) discountRate += MEMBER_DISCOUNT_RATE;
    discounted = Math.round(sum * (1 - discountRate));
  }

  // アソート商品カートの合算（送料はデタウリ上でリアルタイム計算）
  var bulk = loadBulkCartStorage();
  var bulkShipCalc = calcBulkShipping_(bulk.totalQty);
  var bulkTotal = bulk.subtotal + bulkShipCalc;
  var combinedTotal = (discounted < sum ? discounted : sum) + bulkTotal;

  if (bulk.subtotal > 0) {
    // アソート商品カートがある場合は合算を表示
    var bulkLabel = yen(bulkTotal);
    if (discounted < sum) {
      $('cartTotal').innerHTML = yen(discounted) + ' <span style="font-size:11px;font-weight:400;color:#ccc;">+ アソート</span> ' + bulkLabel + ' = <span style="color:#ffd700;">' + yen(combinedTotal) + '</span>';
    } else {
      $('cartTotal').innerHTML = yen(sum) + ' <span style="font-size:11px;font-weight:400;color:#ccc;">+ アソート</span> ' + bulkLabel + ' = <span style="color:#ffd700;">' + yen(combinedTotal) + '</span>';
    }
  } else {
    if (discounted < sum) {
      $('cartTotal').innerHTML = '<span class="price-old">' + yen(sum) + '</span> → <span class="price-new">' + yen(discounted) + '</span>';
    } else { $('cartTotal').textContent = yen(sum); }
  }
}

function toggleCartOptimistic_(id) {
  var idx = state.cart.ids.indexOf(id);
  var adding = (idx === -1);
  if (idx !== -1) { state.cart.ids.splice(idx, 1); } else { state.cart.ids.push(id); }

  // 追加時: itemsById にデータがなければカードから復元（カートモーダル削除後の再追加対策）
  if (adding && !state.cart.itemsById[id]) {
    var rec = state.ui.cardEls ? state.ui.cardEls[id] : null;
    if (rec && rec.item) upsertCartItem_(rec.item);
  }

  // 確保ステータスの楽観的更新（API応答を待たず即時反映）
  if (adding) {
    // 追加時: digest エントリを作成/更新して自分の確保として扱う
    if (!state.cart.digest[id]) {
      state.cart.digest[id] = { status: '確保中', heldByOther: false, _optimistic: true };
    } else {
      state.cart.digest[id].heldByOther = false;
      state.cart.digest[id]._optimistic = true;
    }
  } else {
    // 削除時: digest をクリアして元のステータス（在庫あり）に即時戻す
    delete state.cart.digest[id];
  }

  state.lastShipping = null; // カート変更時に送料キャッシュを無効化
  saveCartStorage(); updateCartCount(); updateCardUi_(id);
  updateShippingDisplay_(); // 送料を即時再計算

  // 確保同期中はステータスポーリングを抑止（レースコンディション防止）
  state._holdSyncing = true;
  runApi('apiSyncHolds', state.userKey, state.cart.ids.slice())
    .then(function(res) {
      if (res && res.ok) {
        // 同期成功: サーバー確認済みdigestで上書き（最も信頼できるデータ）
        var now = Date.now();
        if (res.digest) {
          for (var dk in res.digest) {
            res.digest[dk]._confirmedAt = now;
            state.cart.digest[dk] = res.digest[dk];
          }
        }
        // 成功時のみ _optimistic をクリア
        for (var ck in state.cart.digest) {
          if (state.cart.digest[ck]) delete state.cart.digest[ck]._optimistic;
        }
        // digestにないカートアイテムにも _confirmedAt を付与（サーバーが省略した場合の保護）
        for (var ci2 = 0; ci2 < state.cart.ids.length; ci2++) {
          var cid2 = state.cart.ids[ci2];
          if (state.cart.digest[cid2] && !state.cart.digest[cid2]._confirmedAt) {
            state.cart.digest[cid2]._confirmedAt = now;
          }
        }
      }
      // res.ok が false の場合は _optimistic を維持（次のポーリングから保護）
      if (res && res.failed && res.failed.length) {
        for (var i = 0; i < res.failed.length; i++) {
          var fid = res.failed[i].id;
          var j = state.cart.ids.indexOf(fid);
          if (j !== -1) state.cart.ids.splice(j, 1);
          delete state.cart.digest[fid];
          updateCardUi_(fid);
        }
        updateCartCount(); saveCartStorage();
        updateShippingDisplay_();
        var reasons = res.failed.map(function(f) { return f.reason; }).filter(function(v, i, a) { return a.indexOf(v) === i; });
        showToast(reasons.join('・') + 'の商品があります');
      }
    })
    .catch(function(e) { console.log('同期エラー:', e); })
    .finally(function() {
      state._holdSyncing = false;
      pollStatusNow_(); // 同期完了後にポーリング再開
    });
}

// =====================================================
// 詳細モーダル
// =====================================================

function openDetailModal(managedId, imageUrl, thumbUrl) {
  var modal = document.getElementById('detailModal');
  var body = document.getElementById('detailModalBody');
  if (!modal || !body) return;

  var item = (state.productById && state.productById[managedId]) || null;
  if (!item) item = state.cart.itemsById ? state.cart.itemsById[managedId] : null;

  if (item) { renderDetailModalLocal(item, imageUrl, thumbUrl); }
  else { body.innerHTML = '<div class="detail-loading">商品情報が見つかりません</div>'; }

  modal.classList.add('active');
  // 詳細モーダル表示中はチャットボットFABとスクロールトップボタンを非表示
  var chatFab = document.getElementById('chatbotFab');
  var topBtn = document.getElementById('toTopBtn');
  if (chatFab) chatFab.style.display = 'none';
  if (topBtn) topBtn.classList.remove('show');
}

function renderDetailModalLocal(item, imageUrl, thumbUrl) {
  var body = document.getElementById('detailModalBody');
  if (!body) return;
  
  var basicItems = [];
  if (item.category) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">カテゴリ:</span> ' + escapeHtml_(item.category) + '</span>');
  if (item.size) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">サイズ:</span> ' + escapeHtml_(item.size) + '</span>');
  if (item.gender) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">性別:</span> ' + escapeHtml_(item.gender) + '</span>');
  if (item.color) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">カラー:</span> ' + escapeHtml_(item.color) + '</span>');
  if (item.state) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">状態:</span> ' + escapeHtml_(item.state) + '</span>');
  if (item.price) basicItems.push('<span class="detail-info-item"><span class="detail-info-label">価格:</span> ' + yen(item.price) + '</span>');
  
  var basicInfoHtml = basicItems.length > 0 ?
    '<div class="detail-section"><div class="detail-section-title">商品情報</div><div class="detail-info-grid">' + basicItems.join('') + '</div></div>' : '';
  
  var defectHtml = '';
  if (item.defectDetail) {
    var escaped = escapeHtml_(item.defectDetail).replace(/\n/g, '<br>');
    defectHtml = '<div class="detail-section"><div class="detail-section-title">傷・汚れ詳細</div><div class="detail-defect">' + escaped + '</div></div>';
  }
  
  var measurementsHtml = '';
  if (item.measurements && Object.keys(item.measurements).length > 0) {
    var measureOrder = ['着丈', '肩幅', '身幅', '袖丈', '桁丈', '総丈', 'ウエスト', '股上', '股下', 'ワタリ', '裾幅', 'ヒップ'];
    var measureItems = [];
    for (var i = 0; i < measureOrder.length; i++) {
      var label = measureOrder[i];
      if (item.measurements[label] !== undefined && item.measurements[label] !== null) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + label + '</div><div class="measurement-value">' + item.measurements[label] + ' cm</div></div>');
      }
    }
    for (var lbl in item.measurements) {
      if (measureOrder.indexOf(lbl) === -1) {
        measureItems.push('<div class="measurement-item"><div class="measurement-label">' + lbl + '</div><div class="measurement-value">' + item.measurements[lbl] + ' cm</div></div>');
      }
    }
    if (measureItems.length > 0) {
      measurementsHtml = '<div class="detail-section"><div class="detail-section-title">採寸データ</div><div class="measurement-grid">' + measureItems.join('') + '</div></div>';
    }
  }
  
  var inCart = state.cart.ids && state.cart.ids.indexOf(item.managedId) !== -1;
  var btnText = inCart ? '✓ カートに入っています' : 'カートに追加';
  var btnDisabled = inCart ? 'disabled' : '';
  var safeImageUrl = String(imageUrl || '').replace(/"/g, '&quot;');
  var safeThumbUrl = String(thumbUrl || safeImageUrl).replace(/"/g, '&quot;');
  var safeBrand = escapeHtml_(item.brand || '');
  var safeManagedId = escapeHtml_(item.managedId || '');
  var noInfo = (!basicInfoHtml && !defectHtml && !measurementsHtml) ? '<div class="detail-loading" style="color:#999;">追加情報はありません</div>' : '';

  // Show thumbnail immediately (already cached), then swap to full-res
  var initialSrc = safeThumbUrl || safeImageUrl;

  body.innerHTML =
    '<div class="detail-zoom-wrap" id="detailZoomWrap">' +
      '<img class="detail-modal-image" id="detailZoomImg" src="' + initialSrc + '" alt="' + safeBrand + '" onerror="this.parentNode.style.display=\'none\'">' +
      '<div class="detail-zoom-lens" id="detailZoomLens"></div>' +
      '<span class="detail-zoom-hint">🔍 ホバーで拡大</span>' +
      '<span class="detail-zoom-hint-mobile">タップで拡大</span>' +
    '</div>' +
    '<div class="detail-zoom-result" id="detailZoomResult"></div>' +
    '<div class="detail-modal-content"><div class="detail-modal-title">' + safeBrand + ' - ' + safeManagedId + '</div>' +
    basicInfoHtml + defectHtml + measurementsHtml + noInfo + '</div>' +
    '<div class="detail-modal-footer"><button class="detail-add-btn" ' + btnDisabled + ' onclick="addToCartFromModal(\'' + safeManagedId + '\')">' + btnText + '</button></div>';

  // Swap to full-res image when loaded (if different from thumbnail)
  if (safeImageUrl && safeImageUrl !== safeThumbUrl) {
    var fullImg = new Image();
    fullImg.onload = function() {
      var el = document.getElementById('detailZoomImg');
      if (el) el.src = safeImageUrl;
      initDetailZoom_(safeImageUrl);
    };
    fullImg.src = safeImageUrl;
  }

  // Initialize zoom with current image (thumbnail or full if already cached)
  initDetailZoom_(safeImageUrl || initialSrc);
}

// =====================================================
// 画像ズーム機能 (Amazon-style)
// =====================================================

function initDetailZoom_(imageUrl) {
  var wrap = document.getElementById('detailZoomWrap');
  var img = document.getElementById('detailZoomImg');
  var lens = document.getElementById('detailZoomLens');
  var result = document.getElementById('detailZoomResult');
  if (!wrap || !img || !lens || !result) return;

  var isMobile = window.matchMedia('(max-width: 700px)').matches;

  if (isMobile) {
    // Mobile: tap to open fullscreen viewer
    wrap.addEventListener('click', function() { openFullscreenViewer_(imageUrl); });
    return;
  }

  // Desktop: Amazon-style hover magnifier
  var zoomLevel = 2.5;
  var ready = false;

  img.addEventListener('load', function() {
    ready = true;
    result.style.backgroundImage = 'url(' + imageUrl + ')';
    result.style.backgroundSize = (img.naturalWidth * zoomLevel) + 'px ' + (img.naturalHeight * zoomLevel) + 'px';
  });

  // If image is already cached and loaded
  if (img.complete && img.naturalWidth > 0) {
    ready = true;
    result.style.backgroundImage = 'url(' + imageUrl + ')';
    result.style.backgroundSize = (img.naturalWidth * zoomLevel) + 'px ' + (img.naturalHeight * zoomLevel) + 'px';
  }

  wrap.addEventListener('mouseleave', function() { result.style.display = 'none'; lens.style.display = 'none'; });

  wrap.addEventListener('mousemove', function(e) {
    if (!ready) return;
    var rect = wrap.getBoundingClientRect();
    var x = e.clientX - rect.left;
    var y = e.clientY - rect.top;

    // Calculate actual rendered image area within object-fit:contain element
    var natW = img.naturalWidth, natH = img.naturalHeight;
    var contW = rect.width, contH = rect.height;
    var scale = Math.min(contW / natW, contH / natH);
    var renderedW = natW * scale, renderedH = natH * scale;
    var imgOffsetX = (contW - renderedW) / 2;
    var imgOffsetY = (contH - renderedH) / 2;

    // Only react when cursor is over the actual image pixels
    if (x < imgOffsetX || x > imgOffsetX + renderedW || y < imgOffsetY || y > imgOffsetY + renderedH) {
      result.style.display = 'none';
      lens.style.display = 'none';
      return;
    }
    result.style.display = 'block';
    lens.style.display = 'block';

    // Position lens (centered on cursor via CSS transform: translate(-50%, -50%))
    lens.style.left = x + 'px';
    lens.style.top = y + 'px';

    // Calculate ratios based on actual rendered image size
    var relX = (x - imgOffsetX) / renderedW;
    var relY = (y - imgOffsetY) / renderedH;

    // Background position for zoom result
    var bgX = relX * (img.naturalWidth * zoomLevel) - result.offsetWidth / 2;
    var bgY = relY * (img.naturalHeight * zoomLevel) - result.offsetHeight / 2;
    result.style.backgroundPosition = '-' + Math.max(0, bgX) + 'px -' + Math.max(0, bgY) + 'px';

    // Position zoom result panel next to the modal (fixed positioning)
    var modal = wrap.closest('.detail-modal');
    if (modal) {
      var modalRect = modal.getBoundingClientRect();
      var spaceRight = window.innerWidth - modalRect.right;
      var resultTop = Math.max(10, modalRect.top);
      result.style.top = resultTop + 'px';
      if (spaceRight >= 310) {
        result.style.left = (modalRect.right + 10) + 'px';
      } else {
        result.style.left = (modalRect.left - 310) + 'px';
      }
    }
  });
}

// Fullscreen image viewer for mobile
function openFullscreenViewer_(imageUrl) {
  var viewer = document.getElementById('fullscreenViewer');
  var viewerImg = document.getElementById('fullscreenViewerImg');
  if (!viewer || !viewerImg) return;
  viewerImg.src = imageUrl;
  viewerImg.style.transform = 'scale(1)';
  viewer.classList.add('active');

  // Pinch-to-zoom state
  var scale = 1;
  var startDist = 0;
  var startScale = 1;
  var translateX = 0, translateY = 0;
  var lastTap = 0;

  function applyTransform() {
    viewerImg.style.transform = 'scale(' + scale + ') translate(' + (translateX / scale) + 'px, ' + (translateY / scale) + 'px)';
  }

  function getDistance(t1, t2) {
    var dx = t1.clientX - t2.clientX;
    var dy = t1.clientY - t2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  // Double-tap to toggle zoom
  viewerImg.ontouchend = function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      e.preventDefault();
      if (scale > 1) {
        scale = 1; translateX = 0; translateY = 0;
      } else {
        scale = 2.5;
      }
      applyTransform();
    }
    lastTap = now;
  };

  // Pinch zoom & pan
  viewerImg.ontouchmove = function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      var dist = getDistance(e.touches[0], e.touches[1]);
      scale = Math.min(5, Math.max(1, startScale * (dist / startDist)));
      applyTransform();
    } else if (e.touches.length === 1 && scale > 1) {
      e.preventDefault();
      translateX += e.touches[0].clientX - (viewerImg._lastX || e.touches[0].clientX);
      translateY += e.touches[0].clientY - (viewerImg._lastY || e.touches[0].clientY);
      viewerImg._lastX = e.touches[0].clientX;
      viewerImg._lastY = e.touches[0].clientY;
      applyTransform();
    }
  };

  viewerImg.ontouchstart = function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      startDist = getDistance(e.touches[0], e.touches[1]);
      startScale = scale;
    }
    if (e.touches.length === 1) {
      viewerImg._lastX = e.touches[0].clientX;
      viewerImg._lastY = e.touches[0].clientY;
    }
  };
}

function closeFullscreenViewer_() {
  var viewer = document.getElementById('fullscreenViewer');
  if (viewer) viewer.classList.remove('active');
}

// 詳細モーダルを閉じた後の戻り先
var detailReturnTo_ = null;

function closeDetailModal() {
  var modal = document.getElementById('detailModal');
  if (modal) modal.classList.remove('active');
  var zoomResult = document.getElementById('detailZoomResult');
  if (zoomResult) zoomResult.style.display = 'none';
  closeFullscreenViewer_();
  // チャットボットFABを再表示
  var chatFab = document.getElementById('chatbotFab');
  if (chatFab) chatFab.style.display = '';
  if (detailReturnTo_ === 'cart') {
    detailReturnTo_ = null;
    renderCartModal_(); openModal($('cartModal'));
  }
  detailReturnTo_ = null;
}

function addToCartFromModal(managedId) {
  var idx = state.cart.ids.indexOf(managedId);
  if (idx === -1) toggleCartOptimistic_(managedId);
  closeDetailModal();
}

function setupDetailModalEvents_() {
  var modal = document.getElementById('detailModal');
  if (modal) { modal.addEventListener('click', function(e) { if (e.target === modal) closeDetailModal(); }); }
  // Close fullscreen viewer on background tap
  var viewer = document.getElementById('fullscreenViewer');
  if (viewer) { viewer.addEventListener('click', function(e) { if (e.target === viewer) closeFullscreenViewer_(); }); }
}

// =====================================================
// ブランド選択
// =====================================================

function brandCount_() { return Object.keys(state.brandUi.selected || {}).length; }

function updateBrandBtn_() {
  var n = brandCount_();
  if ($('brandBtnText')) $('brandBtnText').textContent = 'ブランド';
  if ($('brandBtnSub')) $('brandBtnSub').textContent = n ? n : '';
  var btn = $('brandBtn');
  if (btn) btn.classList.toggle('active', n > 0);
  if ($('brandHint')) $('brandHint').textContent = n ? ('選択中：' + n + '件') : '複数選択して「適用」で検索します';
}

// 日本語ブランド名エイリアス（検索用）- ひらがな・カタカナ両対応
var brandAliases_ = {
  'nike': ['ナイキ', 'ないき'],
  'adidas': ['アディダス', 'あでぃだす', 'あでいだす'],
  'puma': ['プーマ', 'ぷーま'],
  'gucci': ['グッチ', 'ぐっち'],
  'chanel': ['シャネル', 'しゃねる'],
  'louis vuitton': ['ルイヴィトン', 'るいびとん', 'ルイ・ヴィトン'],
  'hermes': ['エルメス', 'えるめす'],
  'prada': ['プラダ', 'ぷらだ'],
  'burberry': ['バーバリー', 'ばーばりー'],
  'coach': ['コーチ', 'こーち'],
  'michael kors': ['マイケルコース', 'まいけるこーす'],
  'ralph lauren': ['ラルフローレン', 'らるふろーれん'],
  'uniqlo': ['ユニクロ', 'ゆにくろ'],
  'zara': ['ザラ', 'ざら'],
  'gap': ['ギャップ', 'ぎゃっぷ'],
  'h&m': ['エイチアンドエム', 'えいちあんどえむ'],
  'supreme': ['シュプリーム', 'しゅぷりーむ'],
  'stussy': ['ステューシー', 'すてゅーしー'],
  'north face': ['ノースフェイス', 'のーすふぇいす'],
  'patagonia': ['パタゴニア', 'ぱたごにあ'],
  'champion': ['チャンピオン', 'ちゃんぴおん'],
  'levis': ['リーバイス', 'りーばいす'],
  'tommy hilfiger': ['トミーヒルフィガー', 'とみーひるふぃがー'],
  'calvin klein': ['カルバンクライン', 'かるばんくらいん'],
  'diesel': ['ディーゼル', 'でぃーぜる'],
  'jill stuart': ['ジルスチュアート', 'じるすちゅあーと'],
  'marc jacobs': ['マークジェイコブス', 'まーくじぇいこぶす'],
  'versace': ['ヴェルサーチ', 'べるさーち', 'ベルサーチ'],
  'armani': ['アルマーニ', 'あるまーに'],
  'fendi': ['フェンディ', 'ふぇんでぃ'],
  'balenciaga': ['バレンシアガ', 'ばれんしあが'],
  'celine': ['セリーヌ', 'せりーぬ'],
  'dior': ['ディオール', 'でぃおーる'],
  'ysl': ['イヴサンローラン', 'いぶさんろーらん'],
  'comme des garcons': ['コムデギャルソン', 'こむでぎゃるそん'],
  'issey miyake': ['イッセイミヤケ', 'いっせいみやけ'],
  'yohji yamamoto': ['ヨウジヤマモト', 'ようじやまもと'],
  'asics': ['アシックス', 'あしっくす'],
  'adam et rope': ['アダムエロペ', 'あだむえろぺ'],
  'adam et rope\'': ['アダムエロペ', 'あだむえろぺ'],
  'new balance': ['ニューバランス', 'にゅーばらんす'],
  'converse': ['コンバース', 'こんばーす'],
  'vans': ['ヴァンズ', 'ばんず', 'バンズ'],
  'reebok': ['リーボック', 'りーぼっく'],
  'under armour': ['アンダーアーマー', 'あんだーあーまー'],
  'columbia': ['コロンビア', 'ころんびあ'],
  'arc\'teryx': ['アークテリクス', 'あーくてりくす'],
  'the north face': ['ザノースフェイス', 'ざのーすふぇいす', 'ノースフェイス'],
  'beams': ['ビームス', 'びーむす'],
  'united arrows': ['ユナイテッドアローズ', 'ゆないてっどあろーず'],
  'ships': ['シップス', 'しっぷす'],
  'journal standard': ['ジャーナルスタンダード', 'じゃーなるすたんだーど'],
  'urban research': ['アーバンリサーチ', 'あーばんりさーち'],
  'nano universe': ['ナノユニバース', 'なのゆにばーす'],
  'green label relaxing': ['グリーンレーベル', 'ぐりーんれーべる'],
  'beauty&youth': ['ビューティーアンドユース', 'びゅーてぃーあんどゆーす'],
  'lowrys farm': ['ローリーズファーム', 'ろーりーずふぁーむ'],
  'global work': ['グローバルワーク', 'ぐろーばるわーく'],
  'snidel': ['スナイデル', 'すないでる'],
  'moussy': ['マウジー', 'まうじー'],
  'sly': ['スライ', 'すらい'],
  'emoda': ['エモダ', 'えもだ'],
  'murua': ['ムルーア', 'むるーあ'],
  'mercuryduo': ['マーキュリーデュオ', 'まーきゅりーでゅお'],
  'dazzlin': ['ダズリン', 'だずりん'],
  'lily brown': ['リリーブラウン', 'りりーぶらうん'],
  'fray i.d': ['フレイアイディー', 'ふれいあいでぃー'],
  'theory': ['セオリー', 'せおりー'],
  'untitled': ['アンタイトル', 'あんたいとる'],
  'natural beauty basic': ['ナチュラルビューティーベーシック', 'なちゅらるびゅーてぃーべーしっく'],
  'rope': ['ロペ', 'ろぺ'],
  'iena': ['イエナ', 'いえな'],
  'spick and span': ['スピックアンドスパン', 'すぴっくあんどすぱん'],
  'tomorrowland': ['トゥモローランド', 'とぅもろーらんど'],
  'macphee': ['マカフィー', 'まかふぃー'],
  'onward': ['オンワード', 'おんわーど'],
  'world': ['ワールド', 'わーるど']
};

// 現在の頭文字フィルター
var currentInitialFilter_ = null;

// 検索キーワードからブランド名候補を取得
function getBrandSearchKeys_(brandKey) {
  var keys = [brandKey.toLowerCase()];
  // エイリアスを追加
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      keys = keys.concat(brandAliases_[eng].map(function(a) { return a.toLowerCase(); }));
    }
  }
  return keys;
}

// 検索クエリがブランドにマッチするか
function matchesBrandSearch_(brandKey, query) {
  if (!query) return true;
  var q = query.toLowerCase();
  // ブランド名自体にマッチ
  if (brandKey.toLowerCase().indexOf(q) !== -1) return true;
  // エイリアスからマッチ
  for (var eng in brandAliases_) {
    if (brandKey.toLowerCase().indexOf(eng) !== -1) {
      for (var i = 0; i < brandAliases_[eng].length; i++) {
        if (brandAliases_[eng][i].toLowerCase().indexOf(q) !== -1) return true;
      }
    }
    // 逆方向: 日本語入力で英語ブランドを検索
    for (var j = 0; j < brandAliases_[eng].length; j++) {
      if (q.indexOf(brandAliases_[eng][j].toLowerCase()) !== -1 || brandAliases_[eng][j].toLowerCase().indexOf(q) !== -1) {
        if (brandKey.toLowerCase().indexOf(eng) !== -1) return true;
      }
    }
  }
  return false;
}

// 頭文字を取得
function getInitialChar_(name) {
  if (!name) return '#';
  var c = name.charAt(0).toUpperCase();
  // 英字
  if (/[A-Z]/.test(c)) return c;
  // 数字
  if (/[0-9]/.test(c)) return '#';
  // ひらがな・カタカナの行判定
  var hiraOrder = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
  var kataOrder = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
  var idx = hiraOrder.indexOf(c);
  if (idx === -1) idx = kataOrder.indexOf(c);
  if (idx !== -1) {
    var row = Math.floor(idx / 5);
    var rowHeads = ['あ', 'か', 'さ', 'た', 'な', 'は', 'ま', 'や', 'ら', 'わ'];
    return rowHeads[Math.min(row, rowHeads.length - 1)] || 'あ';
  }
  // 漢字など
  return '他';
}

function buildBrandListOnce_(brands) {
  if (state.brandUi.built) return;
  state.brandUi.built = true;
  state.brandUi.all = Array.isArray(brands) ? brands.slice() : [];
  state.brandUi.selected = {};
  state.brandUi.itemsByKey = {};

  // ブランド名を正規化して統合
  brandDisplayMap_ = {};
  brandNormalizedMap_ = {};
  var normalizedOrder = [];

  for (var i = 0; i < state.brandUi.all.length; i++) {
    var name = String(state.brandUi.all[i] || '').trim();
    if (!name) continue;
    var key = normalizeBrand_(name);
    brandNormalizedMap_[name] = key;
    if (!brandDisplayMap_[key]) {
      brandDisplayMap_[key] = name;
      normalizedOrder.push(key);
    }
  }

  // 頭文字でグループ化
  var groups = {};
  var groupOrder = [];
  for (var i = 0; i < normalizedOrder.length; i++) {
    var key = normalizedOrder[i];
    var displayName = brandDisplayMap_[key];
    var initial = getInitialChar_(displayName);
    if (!groups[initial]) {
      groups[initial] = [];
      groupOrder.push(initial);
    }
    groups[initial].push({ key: key, displayName: displayName });
  }

  // アルファベット順にソート
  groupOrder.sort(function(a, b) {
    var orderA = /[A-Z]/.test(a) ? a.charCodeAt(0) : (a === '#' ? 999 : 1000 + 'あかさたなはまやらわ他'.indexOf(a));
    var orderB = /[A-Z]/.test(b) ? b.charCodeAt(0) : (b === '#' ? 999 : 1000 + 'あかさたなはまやらわ他'.indexOf(b));
    return orderA - orderB;
  });

  // インデックスナビゲーション構築
  var nav = $('brandIndexNav');
  if (nav) {
    nav.innerHTML = '';
    // 「すべて」ボタンを追加
    var allBtn = document.createElement('button');
    allBtn.className = 'brandIndexBtn filter-active';
    allBtn.textContent = 'すべて';
    allBtn.dataset.initial = 'all';
    allBtn.addEventListener('click', function() {
      currentInitialFilter_ = null;
      filterBrandList_();
      updateIndexBtnState_('all');
    });
    nav.appendChild(allBtn);

    groupOrder.forEach(function(initial) {
      var btn = document.createElement('button');
      btn.className = 'brandIndexBtn';
      btn.textContent = initial;
      btn.dataset.initial = initial;
      btn.addEventListener('click', function() {
        // 同じボタンをもう一度クリックしたら解除
        if (currentInitialFilter_ === initial) {
          currentInitialFilter_ = null;
          updateIndexBtnState_('all');
        } else {
          currentInitialFilter_ = initial;
          updateIndexBtnState_(initial);
        }
        filterBrandList_();
      });
      nav.appendChild(btn);
    });
  }

  function updateIndexBtnState_(activeInitial) {
    document.querySelectorAll('.brandIndexBtn').forEach(function(b) {
      b.classList.remove('filter-active');
      if (b.dataset.initial === activeInitial) b.classList.add('filter-active');
    });
  }

  // ブランドリスト構築
  var list = $('brandList');
  list.innerHTML = '';

  groupOrder.forEach(function(initial) {
    // グループヘッダー
    var header = document.createElement('div');
    header.className = 'brandGroupHeader';
    header.dataset.initial = initial;
    header.textContent = initial;
    list.appendChild(header);

    // グループ内ブランド
    groups[initial].forEach(function(brand) {
      var row = document.createElement('div');
      row.className = 'brandItem';
      row.dataset.name = brand.key;
      row.dataset.key = brand.key.toLowerCase();
      row.dataset.initial = initial;

      var checkEl = document.createElement('span');
      checkEl.className = 'brand-check';
      var label = document.createElement('div');
      label.className = 'brandName';
      label.textContent = brand.displayName;

      row.appendChild(checkEl);
      row.appendChild(label);
      state.brandUi.itemsByKey[brand.key] = row;
      list.appendChild(row);
    });
  });

  // クリックイベント
  list.addEventListener('click', function(ev) {
    var item = ev.target.closest ? ev.target.closest('.brandItem') : null;
    if (!item) return;
    var key = String(item.dataset.name || '');
    if (!key) return;

    var isSelected = item.classList.contains('selected');
    if (isSelected) {
      item.classList.remove('selected');
      delete state.brandUi.selected[key];
    } else {
      item.classList.add('selected');
      state.brandUi.selected[key] = true;
    }
    updateBrandBtn_();
  });
}

function filterBrandList_() {
  var q = String($('brandSearch').value || '').trim();
  var list = $('brandList');
  var shown = 0;
  var visibleGroups = {};

  // ブランドアイテムのフィルタリング
  list.querySelectorAll('.brandItem').forEach(function(el) {
    var key = String(el.dataset.key || '');
    var initial = el.dataset.initial;
    // 検索クエリと頭文字フィルターの両方をチェック
    var matchQuery = matchesBrandSearch_(key, q);
    var matchInitial = !currentInitialFilter_ || initial === currentInitialFilter_;
    var ok = matchQuery && matchInitial;
    el.style.display = ok ? '' : 'none';
    if (ok) {
      shown++;
      visibleGroups[initial] = true;
    }
  });

  // グループヘッダーの表示/非表示
  list.querySelectorAll('.brandGroupHeader').forEach(function(header) {
    var initial = header.dataset.initial;
    var showHeader = currentInitialFilter_ ? (initial === currentInitialFilter_) : visibleGroups[initial];
    header.style.display = showHeader ? '' : 'none';
  });

  if ($('brandHint')) {
    var n = brandCount_();
    $('brandHint').textContent = n ? ('選択中：' + n + '件 / 表示：' + shown + '件') : ('表示：' + shown + '件');
  }
}

// =====================================================
// おすすめ商品
// =====================================================

// おすすめ対象の状態（S, A, AB または同等の日本語表現）
var RECOMMEND_STATES = ['S', 'A', 'AB', '新品', '美品', '良品', '新品同様', '未使用', '未使用に近い'];

function isRecommendableState_(state) {
  if (!state) return false;
  var s = String(state).trim().toUpperCase();
  for (var i = 0; i < RECOMMEND_STATES.length; i++) {
    if (s === RECOMMEND_STATES[i].toUpperCase() || s.indexOf(RECOMMEND_STATES[i].toUpperCase()) !== -1) return true;
  }
  return false;
}

function getRecommendedProducts_(maxCount, excludeIds) {
  if (!state.allProducts || !state.allProducts.length) return [];

  var cartIds = excludeIds || state.cart.ids || [];
  var cartItems = [];
  for (var i = 0; i < cartIds.length; i++) {
    var it = state.cart.itemsById[cartIds[i]];
    if (it) cartItems.push(it);
  }

  // カート内のブランド・カテゴリ・性別・サイズ・価格帯を収集
  var cartBrands = {}, cartCategories = {}, cartGenders = {}, cartSizes = {};
  var priceSum = 0, priceCount = 0;
  for (var i = 0; i < cartItems.length; i++) {
    var ci = cartItems[i];
    if (ci.brand) cartBrands[normalizeBrand_(ci.brand)] = true;
    if (ci.category) cartCategories[ci.category] = true;
    if (ci.gender) cartGenders[ci.gender] = true;
    if (ci.size) cartSizes[ci.size] = true;
    if (ci.price) { priceSum += ci.price; priceCount++; }
  }
  var avgPrice = priceCount > 0 ? (priceSum / priceCount) : 0;

  // フィルタリング＆スコアリング
  var candidates = [];
  for (var i = 0; i < state.allProducts.length; i++) {
    var p = state.allProducts[i];

    // カート内の商品は除外
    if (cartIds.indexOf(p.managedId) !== -1) continue;

    // 状態チェック（S, A, AB等）
    if (!isRecommendableState_(p.state)) continue;

    // 傷汚れ詳細がある場合は除外
    if (p.defectDetail && p.defectDetail.trim()) continue;

    // ブランド不明・記載なしは除外
    var brand = String(p.brand || '').trim().toLowerCase();
    if (!brand || brand === '不明' || brand === '記載なし' || brand === 'なし' || brand === '無し' || brand === 'ノーブランド' || brand === 'unknown' || brand === 'none') continue;

    // スコア計算
    var score = 0;
    if (cartBrands[normalizeBrand_(p.brand)]) score += 30;
    if (cartCategories[p.category]) score += 20;
    if (cartGenders[p.gender]) score += 15;
    if (cartSizes[p.size]) score += 10;
    if (avgPrice > 0 && p.price) {
      var priceDiff = Math.abs(p.price - avgPrice) / avgPrice;
      if (priceDiff <= 0.3) score += 5;
    }

    // カートが空の場合は価格が高い順にランダム
    if (cartItems.length === 0) {
      score = p.price || 0;
    }

    candidates.push({ product: p, score: score });
  }

  // スコア降順、同スコアなら価格降順でソート後、ランダム要素追加
  candidates.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return (b.product.price || 0) - (a.product.price || 0);
  });

  // 上位を取得してシャッフル（同スコア帯でランダム性を出す）
  var top = candidates.slice(0, Math.min(maxCount * 3, candidates.length));
  for (var i = top.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = top[i]; top[i] = top[j]; top[j] = temp;
  }

  var result = [];
  for (var i = 0; i < Math.min(maxCount, top.length); i++) {
    result.push(top[i].product);
  }
  return result;
}

function renderRecommendations_(containerId, sectionId, maxCount, isMainScreen) {
  var container = $(containerId);
  var section = $(sectionId);
  if (!container || !section) return;

  var recommendations = getRecommendedProducts_(maxCount || 6, state.cart.ids);

  if (recommendations.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  container.innerHTML = '';

  for (var i = 0; i < recommendations.length; i++) {
    var p = recommendations[i];
    var card = document.createElement('div');
    card.className = 'recommendCard';

    var imgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl, 200) : '';
    var fullImgUrl = p.imageUrl ? convertDriveImageUrl(p.imageUrl) : '';
    var img = document.createElement('img');
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23eee" width="100" height="100"/%3E%3Ctext x="50" y="55" text-anchor="middle" fill="%23999" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = p.noLabel || p.managedId;
    img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';

    var info = document.createElement('div');
    info.className = 'rcInfo';
    var brand = document.createElement('div');
    brand.className = 'rcBrand';
    brand.textContent = p.brand || '-';
    var price = document.createElement('div');
    price.className = 'rcPrice';
    price.textContent = yen(p.price);
    info.appendChild(brand);
    info.appendChild(price);

    card.appendChild(img);
    card.appendChild(info);

    (function(mid, iurl, mainScreen) {
      card.addEventListener('click', function() {
        if (!mainScreen) closeModal($('cartModal'));
        detailReturnTo_ = mainScreen ? null : 'cart';
        openDetailModal(mid, iurl);
      });
    })(p.managedId, fullImgUrl, isMainScreen);

    container.appendChild(card);
  }
}

function renderMainRecommendations_() {
  renderRecommendations_('mainRecommendList', 'mainRecommend', 8, true);
}

// =====================================================
// カートモーダル・送信
// =====================================================

/**
 * カート内の表示切替: true=カート一覧, false=お届け先フォーム
 */
function showCartSection_(showCart) {
  var cartList = $('cartList');
  var cartRecommend = $('cartRecommend');
  var cartActions = $('cartActions');
  var cartForm = $('cartFormSection');
  var title = $('cartModalTitle');
  var sumBox = $('cartSumBox');
  if (showCart) {
    if (cartList) cartList.style.display = '';
    if (cartRecommend) cartRecommend.style.display = '';
    if (cartActions) cartActions.style.display = 'flex';
    if (cartForm) cartForm.style.display = 'none';
    if (title) title.textContent = 'カート';
    // sumBoxを元の位置（cartFormSectionの前）に戻す
    if (sumBox && cartForm) {
      cartForm.parentNode.insertBefore(sumBox, cartForm);
    }
  } else {
    if (cartList) cartList.style.display = 'none';
    if (cartRecommend) cartRecommend.style.display = 'none';
    if (cartActions) cartActions.style.display = 'none';
    if (cartForm) cartForm.style.display = '';
    if (title) title.textContent = 'ご注文内容の確認';
    // sumBoxをフォーム内のformActionsの直前に移動（カートと同じ下部位置）
    if (sumBox && cartForm) {
      var formActs = cartForm.querySelector('.formActions');
      if (formActs) cartForm.insertBefore(sumBox, formActs);
      else cartForm.appendChild(sumBox);
    }
  }
}

function renderCartModal_() {
  showCartSection_(true); // カート一覧ビューで表示
  var listEl = $('cartList'); listEl.innerHTML = '';
  var ids = (state.cart.ids || []).slice();
  var sum = 0;
  
  for (var i = 0; i < ids.length; i++) {
    var id = ids[i];
    var it = state.cart.itemsById[id];
    if (!it) continue;
    var row = document.createElement('div'); row.className = 'cartRow';

    // 画像とテキストを囲むコンテナ
    var info = document.createElement('div'); info.className = 'cartInfo';

    // 商品画像
    var imgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl, 150) : '';
    var fullImgUrl = it.imageUrl ? convertDriveImageUrl(it.imageUrl) : '';
    var img = document.createElement('img'); img.className = 'cartImg';
    img.src = imgUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"%3E%3Crect fill="%23eee" width="50" height="50"/%3E%3Ctext x="25" y="30" text-anchor="middle" fill="%23999" font-size="10"%3ENo Image%3C/text%3E%3C/svg%3E';
    img.alt = it.noLabel || id;
    img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
    (function(mid, iurl) { img.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, fullImgUrl);

    var left = document.createElement('div'); left.className = 'cartLeft';
    var name = document.createElement('div'); name.className = 'cartName'; name.style.cursor = 'pointer';
    name.textContent = (it.noLabel ? it.noLabel : id) + (it.brand ? (' ' + it.brand) : '');
    (function(mid, iurl) { name.addEventListener('click', function(e) { e.stopPropagation(); closeModal($('cartModal')); detailReturnTo_ = 'cart'; openDetailModal(mid, iurl); }); })(id, fullImgUrl);
    var sub = document.createElement('div'); sub.className = 'cartSub';
    sub.textContent = [it.category, it.color, it.gender, it.size].filter(Boolean).join(' / ') + ' / ' + yen(it.price);
    left.appendChild(name); left.appendChild(sub);
    info.appendChild(img); info.appendChild(left);

    var btn = document.createElement('button'); btn.className = 'dangerBtn'; btn.type = 'button'; btn.textContent = '削除';
    (function(idRef) {
      btn.addEventListener('click', function() {
        var idx = state.cart.ids.indexOf(idRef);
        if (idx !== -1) state.cart.ids.splice(idx, 1);
        delete state.cart.itemsById[idRef];
        delete state.cart.digest[idRef]; // 確保ステータスを即時クリア
        saveCartStorage(); updateCartCount(); updateCardUi_(idRef);
        runApi('apiSyncHolds', state.userKey, state.cart.ids.slice()).catch(function() {});
        renderCartModal_();
      });
    })(id);
    row.appendChild(info); row.appendChild(btn); listEl.appendChild(row);
  }

  // おすすめ商品を表示
  renderRecommendations_('cartRecommendList', 'cartRecommend', 6);

  // 統一フォーマットで金額サマリーを描画
  renderSummary_();
}

/** 合計金額・送料表示だけを再計算（画面遷移なし） */
function updateCartPrices_() {
  renderSummary_();
}

function readForm_() {
  var f = {
    companyName: $('companyName').value || '', contact: $('contact').value || '',
    postal: $('postal').value || '', address: $('address').value || '',
    phone: $('phone').value || '', note: $('note').value || '', measureOpt: getMeasureOptValue_()
  };
  // ポイント利用
  var pts = parseInt($('usePoints').value, 10) || 0;
  if (pts > 0 && state.customer) f.usePoints = pts;
  // クーポン
  if (state.appliedCoupon && state.appliedCoupon.code) f.couponCode = state.appliedCoupon.code;
  // インボイス領収書
  if ($('invoiceReceipt') && $('invoiceReceipt').checked) f.invoiceReceipt = true;
  // 送料情報を追加
  var shipping = state.lastShipping || calculateShipping_();
  if (shipping && shipping.amount != null) {
    f.shippingAmount = shipping.amount;
    f.shippingSize = shipping.size || '';
    f.shippingArea = shipping.area || '';
    f.shippingPref = shipping.pref || '';
  }
  // アソート商品カートの金額を合算（両チャネル合算決済）
  var bulk = loadBulkCartStorage();
  if (bulk.subtotal > 0) {
    var bulkShip = calcBulkShipping_(bulk.totalQty);
    f.bulkProductAmount = bulk.subtotal;
    f.bulkShipping = bulkShip;
    f.bulkItemCount = bulk.totalQty;
  }
  return f;
}

function showPointSection_() {
  var section = $('pointUseSection');
  if (!section) return;
  if (state.customer && state.customer.points > 0) {
    section.style.display = '';
    $('pointAvailable').textContent = '（保有: ' + state.customer.points + ' pt）';
    $('usePoints').value = 0;
    $('usePoints').max = state.customer.points;
    updatePointDiscountInfo_();
  } else {
    section.style.display = 'none';
  }
}

function updatePointDiscountInfo_() {
  var info = $('pointDiscountInfo');
  if (!info) return;
  var pts = parseInt($('usePoints').value, 10) || 0;
  var max = (state.customer && state.customer.points) ? state.customer.points : 0;
  if (pts > max) { pts = max; $('usePoints').value = max; }
  if (pts < 0) { pts = 0; $('usePoints').value = 0; }
  if (pts > 0) {
    info.textContent = pts + 'ポイント利用で -' + yen(pts) + ' 割引（「変更を適用」で合計に反映）';
  } else {
    info.textContent = '';
  }
}

function applyPointDiscount_() {
  var pts = parseInt($('usePoints').value, 10) || 0;
  var max = (state.customer && state.customer.points) ? state.customer.points : 0;
  if (pts > max) { pts = max; $('usePoints').value = max; }
  if (pts < 0) { pts = 0; $('usePoints').value = 0; }
  if (pts > 0) showToast('ポイント割引を適用しました');
  renderSummary_();
}

// === クーポン機能 ===
function applyCoupon_() {
  var code = ($('couponCode').value || '').trim();
  if (!code) { showToast('クーポンコードを入力してください'); return; }

  var sum = 0;
  var ids = state.cart.ids || [];
  for (var i = 0; i < ids.length; i++) {
    var it = state.cart.itemsById[ids[i]];
    if (it) sum += Number(it.price || 0);
  }

  var email = ($('contact').value || '').trim();
  var info = $('couponInfo');
  info.innerHTML = '<span style="color:#888;">検証中...</span>';

  runApi('apiValidateCoupon', code, email, sum, 'detauri').then(function(res) {
    if (!res || !res.ok) {
      info.innerHTML = '<span style="color:#c00;">' + escapeHtml_(res && res.message ? res.message : 'クーポンが無効です') + '</span>';
      state.appliedCoupon = null;
      return;
    }
    state.appliedCoupon = { code: code.toUpperCase(), type: res.type, value: res.value, discountAmount: res.discountAmount, label: res.label, comboMember: res.comboMember || false, comboBulk: res.comboBulk || false };
    var discountText = res.type === 'shipping_free' ? '' : '（-' + yen(res.discountAmount) + '）';
    info.innerHTML = '<span style="color:#2e7d32;">&#10003; ' + escapeHtml_(res.label) + discountText + '適用済み</span>';
    $('couponCode').disabled = true;
    $('applyCouponBtn').style.display = 'none';
    $('removeCouponBtn').style.display = '';
    // 割引再計算（画面遷移せず金額だけ更新）
    updateCartPrices_();
    showToast('クーポンを適用しました');
  }).catch(function(e) {
    var msg = (e && e.message) ? e.message : 'エラーが発生しました';
    info.innerHTML = '<span style="color:#c00;">' + escapeHtml_(msg) + '</span>';
    state.appliedCoupon = null;
  });
}

function removeCoupon_() {
  state.appliedCoupon = null;
  $('couponCode').value = '';
  $('couponCode').disabled = false;
  $('applyCouponBtn').style.display = '';
  $('removeCouponBtn').style.display = 'none';
  $('couponInfo').innerHTML = '';
  updateCartPrices_();
  showToast('クーポンを解除しました');
}

function validateForm_(f) {
  if (!f.companyName.trim()) return '会社名/氏名は必須です';
  if (!f.contact.trim()) return 'メールアドレスは必須です';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.contact.trim())) return '有効なメールアドレスを入力してください';
  if (!String(f.postal || '').trim()) return '郵便番号は必須です';
  if (!String(f.address || '').trim()) return '住所は必須です';
  if (!String(f.phone || '').trim()) return '電話番号は必須です';
  // 離島チェック
  var address = String(f.address || '').trim();
  if (address && isRemoteIslandAddress_(address)) return '離島への配送は対象外です。恐れ入りますがご注文いただけません。';
  return '';
}

var submitting_ = false;
function submitNow_() {
  if (submitting_) return;
  submitting_ = true;
  if ((state.cart.ids || []).length === 0) { showToast('カートが空です'); submitting_ = false; return; }
  var ids = (state.cart.ids || []).slice();

  // === 管理者モード: バリデーション不要で受付番号に紐付け ===
  if (ADMIN_KEY) {
    $('submitBtn').disabled = false;
    submitting_ = false;
    var receiptNo = prompt('紐付け先の受付番号を入力してください（BASE注文キー）:');
    if (!receiptNo || !receiptNo.trim()) {
      showToast('受付番号が入力されませんでした');
      return;
    }
    submitting_ = true;
    $('submitBtn').disabled = true;
    setSending_(true, '紐付け登録中...');
    runApi('apiAdminLinkOrder', ADMIN_KEY, receiptNo.trim(), state.userKey, ids)
      .then(function(res) {
        if (!res || !res.ok) throw new Error(res && res.message ? res.message : '登録に失敗しました');
        // カートクリア
        state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
        saveCartStorage(); updateCartCount();
        // 完了モーダル表示
        $('doneReceipt').textContent = res.receiptNo || '';
        if ($('doneModalTitle')) $('doneModalTitle').textContent = '紐付け完了';
        if ($('doneMessage')) $('doneMessage').textContent = '受付番号「' + (res.receiptNo || '') + '」に' + (res.itemCount || ids.length) + '点の商品を紐付けました。';
        openModal($('doneModal'));
      })
      .catch(function(e) {
        showToast(e.message || '登録に失敗しました');
      })
      .finally(function() { setSending_(false); $('submitBtn').disabled = false; submitting_ = false; });
    return;
  }

  // === 通常モード: KOMOJU決済フロー ===
  var f = readForm_();
  var err = validateForm_(f);
  if (err) { showToast(err); submitting_ = false; return; }
  $('submitBtn').disabled = true;
  setSending_(true, '注文を準備中...');

  // ステップ1: CSRF更新 + reCAPTCHA + 確保同期を並列実行（高速化）
  Promise.all([
    runApi('apiGetCsrfToken', state.userKey).then(function(csrfRes) {
      if (csrfRes && csrfRes.ok && csrfRes.csrfToken) state.csrfToken = csrfRes.csrfToken;
    }).catch(function() {}),
    getRecaptchaToken_().catch(function() { return ''; }),
    runApi('apiSyncHolds', state.userKey, ids)
  ])
    .then(function(results) {
      var recaptchaToken = results[1] || '';
      var syncResult = results[2];
      if (!syncResult || !syncResult.ok) throw new Error(syncResult && syncResult.message ? syncResult.message : '確保に失敗しました');
      if (syncResult.failed && syncResult.failed.length) {
        state.cart.ids = state.cart.ids.filter(function(x) { return !syncResult.failed.find(function(f) { return f.id === x; }); });
        saveCartStorage(); updateCartCount(); renderCartModal_();
        throw new Error('一部確保できない商品があります');
      }
      // ステップ2: 注文送信
      setSending_(true, '注文送信中...');
      return runApi('apiSubmitEstimate', state.userKey, f, ids, { _runApiExtra_: true, recaptchaToken: recaptchaToken });
    })
    .then(function(res) {
      if (!res || !res.ok) throw new Error(res && res.message ? res.message : '注文送信に失敗しました');
      var sessionUrl = res.sessionUrl || '';
      if (!sessionUrl) throw new Error('決済URLの取得に失敗しました');
      // カートクリア（決済完了後にページに戻ってくるので先にクリア）
      state.cart.ids = []; state.cart.itemsById = {}; state.cart.digest = {}; state.lastShipping = null;
      saveCartStorage(); updateCartCount();
      // KOMOJU決済ページへリダイレクト
      setSending_(true, '決済ページへ移動中...');
      window.location.href = sessionUrl;
    })
    .catch(function(e) {
      showToast(e.message || '注文送信に失敗しました');
    })
    .finally(function() { setSending_(false); $('submitBtn').disabled = false; submitting_ = false; });
}

// =====================================================
// KOMOJU決済からの戻り処理
// =====================================================

function handlePaymentReturn_() {
  var params = new URLSearchParams(window.location.search);
  var receipt = params.get('receipt');
  var status = params.get('status');
  if (!receipt || !status) return;

  // URLからクエリパラメータを削除（履歴を汚さない）
  if (window.history && window.history.replaceState) {
    var cleanUrl = window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }

  if (status === 'complete') {
    // 決済確認中の表示
    $('doneReceipt').textContent = receipt;
    if ($('doneModalTitle')) $('doneModalTitle').textContent = '決済確認中...';
    if ($('doneMessage')) $('doneMessage').textContent = 'お支払いの確認をしています。しばらくお待ちください...';
    openModal($('doneModal'));
    // 決済ステータスを確認してから完了表示
    runApi('apiCheckPaymentStatus', receipt).then(function(res) {
      if (res && res.ok && (res.status === 'paid' || res.status === 'authorized')) {
        if ($('doneModalTitle')) $('doneModalTitle').textContent = '注文完了';
        if ($('doneMessage')) $('doneMessage').textContent = 'お支払いが完了しました。注文確認メールをお送りしましたのでご確認ください。商品の発送準備を進めてまいります。';
      } else if (res && res.ok && res.status === 'pending') {
        if ($('doneModalTitle')) $('doneModalTitle').textContent = '入金待ち';
        if ($('doneMessage')) $('doneMessage').textContent = 'ご注文を受け付けました。コンビニ決済・銀行振込をご選択の場合、入金確認後に注文が確定されます。';
      } else {
        if ($('doneModalTitle')) $('doneModalTitle').textContent = '決済確認中';
        if ($('doneMessage')) $('doneMessage').textContent = 'お支払いの確認に時間がかかっています。注文が確定されましたらメールでお知らせいたします。受付番号を控えておいてください。';
      }
    }).catch(function(e) {
      console.log('Payment status check on return:', e);
      if ($('doneModalTitle')) $('doneModalTitle').textContent = '決済確認中';
      if ($('doneMessage')) $('doneMessage').textContent = 'お支払いの確認に時間がかかっています。注文が確定されましたらメールでお知らせいたします。受付番号を控えておいてください。';
    });
  } else if (status === 'cancel') {
    // 決済キャンセル
    $('doneReceipt').textContent = receipt;
    if ($('doneModalTitle')) $('doneModalTitle').textContent = '決済キャンセル';
    if ($('doneMessage')) $('doneMessage').textContent = '決済がキャンセルされました。商品は自動的に解放されます。再度ご注文いただく場合はカートから商品を選択してください。';
    openModal($('doneModal'));
    // キャンセル処理をバックエンドに通知
    runApi('apiCancelOrder', receipt).catch(function() {});
  }
}

// =====================================================
// 設定
// =====================================================

function normalizeSettings_(s) {
  var src = (s && typeof s === 'object') ? s : {};
  var ui = (src.uiText && typeof src.uiText === 'object') ? src.uiText : {};
  var out = {};
  out.appTitle = String(src.appTitle || ui.appTitle || 'デタウリ.Detauri');
  out.minOrderCount = Number(src.minOrderCount != null ? src.minOrderCount : (ui.minOrderCount != null ? ui.minOrderCount : 10));
  out.shippingEstimateText = String(src.shippingEstimateText || ui.shippingEstimateText || '');
  out.notes = Array.isArray(src.notes) ? src.notes : (Array.isArray(ui.notes) ? ui.notes : []);
  out.nextSteps = Array.isArray(src.nextSteps) ? src.nextSteps : (Array.isArray(ui.nextSteps) ? ui.nextSteps : []);
  out.basePaymentUrl = String(src.basePaymentUrl || ui.basePaymentUrl || '');
  return out;
}

function setBaseLink_() {
  var a = $('baseLink');
  if (!a) return;
  var url = (state.settings && state.settings.basePaymentUrl) ? String(state.settings.basePaymentUrl) : '';
  if (!url) { a.textContent = ''; a.removeAttribute('href'); return; }
  a.textContent = url; a.href = url;
}

// =====================================================
// UI初期化
// =====================================================

function bindUi_() {
  $('overlay').addEventListener('click', closeAllModals);
  
  $('brandBtn').addEventListener('click', function() {
    $('brandSearch').value = '';
    filterBrandList_(); updateBrandBtn_(); openModal($('brandModal'));
    try { $('brandSearch').focus(); } catch (e) {}
  });
  $('brandCloseBtn').addEventListener('click', function() { closeModal($('brandModal')); });
  (function() {
    var brandDebounce;
    $('brandSearch').addEventListener('input', function() {
      clearTimeout(brandDebounce);
      brandDebounce = setTimeout(filterBrandList_, 200);
    });
  })();
  $('brandClearBtn').addEventListener('click', function() {
    // チェックボックスをクリア
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    // ビジュアル選択状態もクリア
    $('brandList').querySelectorAll('.brandItem.selected').forEach(function(el) {
      el.classList.remove('selected');
    });
    // 検索入力もクリア
    $('brandSearch').value = '';
    // 頭文字フィルターもリセット
    currentInitialFilter_ = null;
    // インデックスボタンの状態をリセット
    $('brandIndexNav').querySelectorAll('.brandIndexBtn').forEach(function(btn) {
      btn.classList.remove('filter-active');
      if (btn.dataset.initial === 'all') btn.classList.add('filter-active');
    });
    // 状態をクリア
    state.brandUi.selected = {};
    updateBrandBtn_();
    filterBrandList_();
  });
  $('brandApplyBtn').addEventListener('click', function() {
    state.query.filters.brand = Object.keys(state.brandUi.selected || {});
    state.query.page = 1; updateBrandBtn_(); closeModal($('brandModal')); filterAndRender(true);
  });
  
  var doFilter_ = function() { state.query.page = 1; filterAndRender(true); };
  // ソートチップ：ドロップダウン開閉
  $('sortChipBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.querySelectorAll('.multiSelectDropdown').forEach(function(d) {
      if (d.id !== 'sortDropdown') d.classList.remove('open');
    });
    $('sortDropdown').classList.toggle('open');
  });
  // ソート方向トグル
  $('sortDirToggle').addEventListener('click', function() {
    var dir = state.query.sort.dir === 'asc' ? 'desc' : 'asc';
    state.query.sort.dir = dir;
    this.textContent = dir === 'asc' ? '↑' : '↓';
    doFilter_();
  });

  $('btnReset').addEventListener('click', function() {
    state.query.filters = { brand: [], category: [], state: [], gender: [], size: [] };
    state.query.sort = { key: 'default', dir: 'asc' };
    state.query.page = 1;
    // ブランドフィルターをリセット
    var prev = Object.keys(state.brandUi.selected || {});
    for (var i = 0; i < prev.length; i++) { var cb = state.brandUi.cbByName[prev[i]]; if (cb) cb.checked = false; }
    state.brandUi.selected = {}; updateBrandBtn_();
    // マルチセレクトフィルターをリセット
    resetMultiSelectFilters();
    updateSortChip_();
    $('sortDirToggle').textContent = '↑';
    filterAndRender(true);
  });
  
  $('openCartBtn').addEventListener('click', function() { renderCartModal_(); openModal($('cartModal')); });
  // カートクリアボタンはrenderSummary_()内で動的生成
  $('cartCloseBtn').addEventListener('click', function() {
    showCartSection_(true); // カートビューに戻してから閉じる
    closeModal($('cartModal'));
  });
  $('goFormBtn').addEventListener('click', function() {
    var min = (state.settings && state.settings.minOrderCount) ? Number(state.settings.minOrderCount) : 10;
    var count = (state.cart.ids || []).length;
    if (count < min) {
      showToast(min + '点以上で購入可能です（現在' + count + '点）');
      return;
    }
    // 共有住所を読み込み（BulkLPで入力された住所を復元）
    loadSharedAddress_();
    // ログインユーザーの情報を自動入力
    if (state.customer) {
      if (state.customer.companyName && !$('companyName').value) $('companyName').value = state.customer.companyName;
      if (state.customer.email && !$('contact').value) $('contact').value = state.customer.email;
      if (state.customer.phone && !$('phone').value) $('phone').value = state.customer.phone;
      if (state.customer.postal && !$('postal').value) $('postal').value = state.customer.postal;
      if (state.customer.address && !$('address').value) $('address').value = state.customer.address;
    }
    showPointSection_();
    showCartSection_(false); // フォーム表示に切り替え
    // フォーム表示時に住所があれば送料を計算
    updateShippingDisplay_();
  });
  $('formBackBtn').addEventListener('click', function() { showCartSection_(true); });
  $('submitBtn').addEventListener('click', submitNow_);
  // 管理者モード: UI変更
  if (ADMIN_KEY) {
    $('submitBtn').textContent = '受付番号で紐付け';
    document.body.classList.add('admin-mode');
    var adminBar = $('adminBar');
    if (adminBar) adminBar.style.display = 'block';
    var adminExit = $('adminExit');
    if (adminExit) {
      adminExit.addEventListener('click', function() {
        if (confirm('管理者モードを解除しますか？\n再度アクセスするには ?admin=xxx のURLが必要です。')) {
          try { localStorage.removeItem('_nk_owner_key'); } catch(e) {}
          location.reload();
        }
      });
    }
    // --- 管理設定パネル ---
    (function() {
      var fab = $('adminSettingsFab');
      var panel = $('settingsPanel');
      var closeBtn = $('settingsClose');
      if (!fab || !panel) return;

      fab.addEventListener('click', function() {
        var isOpen = panel.classList.contains('open');
        if (isOpen) { panel.classList.remove('open'); return; }
        panel.classList.add('open');
        spLoadKomoju();
        spLoadDiscount();
      });
      if (closeBtn) closeBtn.addEventListener('click', function() { panel.classList.remove('open'); });

      // ログ
      function spLog(msg) {
        var el = $('spLog');
        if (!el) return;
        el.style.display = 'block';
        el.textContent = (el.textContent ? el.textContent + '\n' : '') + msg;
        el.scrollTop = el.scrollHeight;
      }

      // 管理ボタン
      function spRunAdmin(fn, label) {
        spLog('実行: ' + label);
        runApi(fn).then(function(res) {
          if (res && res.ok) { showToast(label + ' 完了'); spLog('完了'); }
          else { showToast(res && res.message ? res.message : label + ' 失敗'); spLog('失敗'); }
        }).catch(function(e) { showToast(e.message || label + ' 失敗'); spLog('失敗: ' + (e.message || '')); });
      }
      $('spBtnCompact').addEventListener('click', function() { spRunAdmin('adminCompactHolds', '期限切れ確保の整理'); });
      $('spBtnRebuild').addEventListener('click', function() { spRunAdmin('adminRebuildStates', '状態の再構築'); });
      $('spBtnClearCache').addEventListener('click', function() { spRunAdmin('adminClearProductsCache', '商品キャッシュ削除'); });
      $('spBtnApplyDv').addEventListener('click', function() { spRunAdmin('adminApplyStatusDropdown', 'ステータスのプルダウン適用'); });

      // KOMOJU 決済モード
      function spUpdateMode(mode, hasTestKey, hasLiveKey) {
        var badge = $('spModeBadge');
        var btn = $('spBtnToggleMode');
        var keys = $('spModeKeys');
        if (!badge || !btn) return;
        badge.textContent = (mode === 'live') ? '本番' : 'テスト';
        badge.className = 'sp-badge ' + (mode === 'live' ? 'live' : 'test');
        btn.disabled = false;
        btn.textContent = (mode === 'live') ? 'テストに切替' : '本番に切替';
        if (keys) keys.textContent = 'テストキー: ' + (hasTestKey ? '設定済' : '未設定') + ' ／ 本番キー: ' + (hasLiveKey ? '設定済' : '未設定');
      }
      function spLoadKomoju() {
        runApi('adminGetKomojuMode').then(function(res) {
          if (res && res.ok) spUpdateMode(res.mode, res.hasTestKey, res.hasLiveKey);
          else $('spModeBadge').textContent = '取得失敗';
        }).catch(function() { $('spModeBadge').textContent = 'エラー'; });
      }
      $('spBtnToggleMode').addEventListener('click', function() {
        var badge = $('spModeBadge');
        var target = (badge.textContent === '本番') ? 'テスト' : '本番';
        if (!confirm('決済モードを「' + target + '」に切り替えますか？')) return;
        $('spBtnToggleMode').disabled = true;
        spLog('実行: 決済モード切替 → ' + target);
        runApi('adminToggleKomojuMode').then(function(res) {
          if (!res || !res.ok) { showToast(res && res.message ? res.message : '切替失敗'); spLog('失敗'); $('spBtnToggleMode').disabled = false; return; }
          return runApi('adminGetKomojuMode');
        }).then(function(info) {
          if (info && info.ok) spUpdateMode(info.mode, info.hasTestKey, info.hasLiveKey);
          showToast('切替完了'); spLog('切替完了');
        }).catch(function(e) { showToast(e.message || '切替失敗'); spLog('失敗: ' + (e.message || '')); $('spBtnToggleMode').disabled = false; });
      });

      // 会員割引
      function spUpdateDiscount(enabled, rate, endDate, reason) {
        var badge = $('spDiscountBadge');
        var btn = $('spBtnToggleDiscount');
        var info = $('spDiscountInfo');
        if (!badge || !btn) return;
        badge.textContent = enabled ? 'ON' : 'OFF';
        badge.className = 'sp-badge ' + (enabled ? 'on' : 'off');
        btn.disabled = false;
        btn.textContent = enabled ? 'OFFにする' : 'ONにする';
        var t = '割引率: ' + Math.round((rate || 0) * 100) + '% ／ 期限: ' + (endDate || '未設定');
        if (reason === 'expired') t += '（期限切れ）';
        if (info) info.textContent = t;
      }
      function spLoadDiscount() {
        runApi('adminGetMemberDiscountStatus').then(function(res) {
          if (res && res.ok) spUpdateDiscount(res.enabled, res.rate, res.endDate, res.reason);
          else $('spDiscountBadge').textContent = '取得失敗';
        }).catch(function() { $('spDiscountBadge').textContent = 'エラー'; });
      }
      $('spBtnToggleDiscount').addEventListener('click', function() {
        var badge = $('spDiscountBadge');
        var target = (badge.textContent === 'ON') ? 'OFF' : 'ON';
        if (!confirm('会員割引を「' + target + '」に切り替えますか？')) return;
        $('spBtnToggleDiscount').disabled = true;
        spLog('実行: 会員割引切替 → ' + target);
        runApi('adminToggleMemberDiscount').then(function(res) {
          if (!res || !res.ok) { showToast(res && res.message ? res.message : '切替失敗'); spLog('失敗'); $('spBtnToggleDiscount').disabled = false; return; }
          spUpdateDiscount(res.enabled, res.rate, res.endDate, res.reason);
          showToast(res.message || '切替完了'); spLog(res.message || '切替完了');
          $('spBtnToggleDiscount').disabled = false;
        }).catch(function(e) { showToast(e.message || '切替失敗'); spLog('失敗: ' + (e.message || '')); $('spBtnToggleDiscount').disabled = false; });
      });
    })();
  }
  // 住所入力時に送料をリアルタイム更新 + 共有住所保存（debounce 300ms）
  if ($('address')) {
    (function() {
      var addrDebounce;
      $('address').addEventListener('input', function() {
        clearTimeout(addrDebounce);
        addrDebounce = setTimeout(function() { updateShippingDisplay_(); saveSharedAddress_(); }, 300);
      });
    })();
  }
  // 他のフォームフィールドでも共有住所を保存
  ['companyName','contact','postal','phone','note'].forEach(function(fid) {
    var el = $(fid);
    if (el) el.addEventListener('input', saveSharedAddress_);
  });
  $('doneCloseBtn').addEventListener('click', function() { closeModal($('doneModal')); });

}

function setupScrollTopButton_() {
  var btn = $('toTopBtn');
  if (!btn) return;
  var threshold = 400;
  var ticking = false;
  var update = function() {
    ticking = false;
    var chatOpen = window._chatbotIsOpen;
    var hasModal = !!document.querySelector('.modal.open');
    var sendingOn = $('sendingOverlay') && $('sendingOverlay').classList.contains('on');
    if (chatOpen || hasModal || sendingOn) { btn.classList.remove('show'); return; }
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > threshold) btn.classList.add('show'); else btn.classList.remove('show');
  };
  var onScroll = function() {
    if (!ticking) { ticking = true; requestAnimationFrame(update); }
  };
  btn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', onScroll);
  update();
}

// =====================================================
// アクセスログ（PV記録）
// =====================================================

function logPageView_() {
  if (IS_OWNER) return;  // オーナーのアクセスはログしない
  // ボット・クローラー除外
  var ua = navigator.userAgent || '';
  if (/HeadlessChrome|Google-Read-Aloud|bot|crawl|spider|slurp/i.test(ua)) return;
  var sw = screen.width || 0, sh = screen.height || 0;
  if ((sw === 0 && sh === 0) || (sw >= 2000 && sh >= 2000) || (sw === 400 && sh === 400)) return;
  try {
    var payload = {
      page: 'Index',
      userKey: state.userKey || '',
      url: window.location.href || '',
      referrer: document.referrer || '',
      userAgent: navigator.userAgent || '',
      language: navigator.language || '',
      screen: (screen.width || 0) + 'x' + (screen.height || 0)
    };
    runApi('apiLogPV', payload).catch(function(e) {
      console.log('PVログエラー:', e);
    });
  } catch (e) {
    console.log('PVログ送信失敗:', e);
  }
}

// =====================================================
// アソート商品ページへの遷移
// =====================================================
function navigateToBulk(e) {
  e.preventDefault();
  // キャッシュ済みならページ遷移せず即時切替（SPA方式）
  var cachedHtml = null;
  try {
    var raw = localStorage.getItem('bulk_html_cache_v7');
    if (raw) {
      var c = JSON.parse(raw);
      if (c && c.html && c.ts && (Date.now() - c.ts < 86400000)) {
        cachedHtml = c.html;
      }
    }
  } catch(ex) {}

  if (cachedHtml) {
    // 白フラッシュ防止: <html>タグに背景色を注入してからdocument.write()
    var safeHtml = cachedHtml.replace(/<html([^>]*)>/, '<html$1 style="background:#1a1a2e">');
    document.open();
    document.write(safeHtml);
    document.close();
    return;
  }

  // キャッシュなし → 通常遷移（オーバーレイ表示）
  var base = window.location.origin + window.location.pathname;
  var url = base + '?page=bulk';
  try { sessionStorage.setItem('_pageTransition', '1'); } catch(e) {}
  var overlay = document.getElementById('pageTransition');
  if (overlay) {
    overlay.querySelector('.pt-sub').textContent = 'アソート商品を読み込み中...';
    overlay.classList.add('active');
    setTimeout(function() { window.location.href = url; }, 150);
  } else {
    window.location.href = url;
  }
}

// =====================================================
// バックグラウンドプリフェッチ: アソートページHTMLを事前取得
// =====================================================
function prefetchBulkPage_() {
  var BULK_HTML_KEY = 'bulk_html_cache_v7';
  var BULK_HTML_TTL = 24 * 60 * 60 * 1000;
  try {
    var raw = localStorage.getItem(BULK_HTML_KEY);
    if (raw) {
      var c = JSON.parse(raw);
      if (c && c.html && c.ts && (Date.now() - c.ts < BULK_HTML_TTL)) {
        return; // キャッシュ有効 → プリフェッチ不要
      }
    }
  } catch(e) {}
  var GAS_URL = 'https://script.google.com/macros/s/AKfycbwLN23a03qQSGA91J-82_6HlIx0kA5yUYFRxjfbjFGfnZDqynKnyJhEPsoISSQps3SmXQ/exec';
  fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ action: 'apiBulkPage', args: [] }),
    redirect: 'follow'
  })
  .then(function(res) { return res.ok ? res.json() : null; })
  .then(function(data) {
    if (data && data.ok && data.html) {
      try {
        localStorage.setItem(BULK_HTML_KEY, JSON.stringify({ ts: Date.now(), html: data.html }));
        console.log('プリフェッチ完了: アソートページHTML');
      } catch(e) {}
    }
  })
  .catch(function() {}); // プリフェッチ失敗は無視
}

// =====================================================
// 起動
// =====================================================

function boot() {
  state.userKey = loadUserKey();
  var c = loadCartStorage();
  state.cart.ids = c.ids || [];
  state.cart.itemsById = c.itemsById || {};
  updateCartCount();

  bindUi_();
  setupScrollTopButton_();
  setupDetailModalEvents_();
  setupAuthUi_();
  updateAuthUi_();  // 初回表示（プロモバナー等）
  setupMultiSelectFilters();

  // KOMOJU決済からの戻りを処理
  handlePaymentReturn_();

  // セッション検証（ログイン状態復元）
  validateSession_();

  var mo = loadMeasureOpt_();
  if (mo) setMeasureOptValue_(mo);
  
  // キャッシュがあれば即座に表示
  var cached = loadProductCache_();
  if (cached && !cached.stale && cached.products) {
    console.log('キャッシュから即時表示:', cached.products.length + '件');
    applyProductData_(cached);
  } else if (cached && cached.stale && cached.data && cached.data.products) {
    console.log('古いキャッシュから即時表示:', cached.data.products.length + '件');
    applyProductData_(cached.data);
  } else {
    renderLoadingGrid_();
  }

  // ページ遷移オーバーレイのフェードアウト
  document.body.classList.remove('page-entering');
  document.body.style.background = '';
  var pt = document.getElementById('pageTransition');
  if (pt) { pt.classList.remove('active'); }

  // 最新データをバックグラウンドで取得（最優先）
  loadProductData()
    .then(function(data) {
      // キャッシュと件数が異なる場合のみ再描画
      var needsRender = !state.dataLoaded || state.allProducts.length !== (data.products || []).length;
      applyProductData_(data);
      if (needsRender) {
        console.log('最新データで更新: ' + state.allProducts.length + '件');
      }
      // 初回データロード完了後に非重要APIを遅延実行
      // CSRFトークン: 注文送信に必要だが初期描画には不要
      fetchCsrfToken_();
      // PVログ: バックグラウンドで十分
      setTimeout(logPageView_, 2000);
      // アソートページHTMLをバックグラウンドでプリフェッチ（シームレス切替用）
      setTimeout(prefetchBulkPage_, 3000);
    })
    .catch(function(err) {
      console.error('起動エラー:', err);
      if (!state.dataLoaded) {
        showToast('データの読み込みに失敗しました: ' + (err.message || err));
      }
      // エラー時でもCSRFトークンとPVログは実行
      fetchCsrfToken_();
      setTimeout(logPageView_, 2000);
    });
}

function applyProductData_(data) {
  state.allProducts = data.products || [];
  // 商品ハッシュマップを構築（O(1)検索用）
  state.productById = {};
  for (var pi = 0; pi < state.allProducts.length; pi++) {
    var p = state.allProducts[pi];
    if (p && p.managedId) state.productById[p.managedId] = p;
  }
  state.options = data.options || {};
  state.settings = normalizeSettings_(data.settings);

  // 会員割引設定をAPIから反映
  if (data.settings && data.settings.memberDiscount) {
    var md = data.settings.memberDiscount;
    MEMBER_DISCOUNT_ENABLED = !!md.enabled;
    MEMBER_DISCOUNT_RATE = MEMBER_DISCOUNT_ENABLED ? Number(md.rate || 0.10) : 0;
    MEMBER_DISCOUNT_END_DATE = md.endDate || '2026-09-30';
  }

  // 会員割引OFFの場合、ガイドセクションの会員割引表示を非表示にする
  var guideMember = $('guideMemberDiscount');
  var guideCombine = $('guideCombineDiscount');
  if (guideMember) guideMember.style.display = MEMBER_DISCOUNT_ENABLED ? '' : 'none';
  if (guideCombine) guideCombine.style.display = MEMBER_DISCOUNT_ENABLED ? '' : 'none';

  // 割引設定反映後にUI更新（バッジ・プロモバナー・価格）
  updateAuthUi_();
  updateCartPrice();

  $('appTitle').textContent = 'デタウリ.Detauri';
  setBaseLink_();

  // マルチセレクトフィルターを構築
  buildMultiSelectDropdown('category', state.options.category || []);
  // 状態フィルタはS→A→AB→B→C→D順にソート
  var stateOrder = ['S', 'A', 'AB', 'B', 'C', 'D', '新品', '美品', '良品'];
  var sortedStates = (state.options.state || []).slice().sort(function(a, b) {
    var idxA = stateOrder.indexOf(a);
    var idxB = stateOrder.indexOf(b);
    if (idxA === -1) idxA = 999;
    if (idxB === -1) idxB = 999;
    return idxA - idxB;
  });
  buildMultiSelectDropdown('state', sortedStates);
  buildMultiSelectDropdown('gender', state.options.gender || []);
  buildMultiSelectDropdown('size', state.options.size || []);
  setSortOptions(state.options.sort || [{ key: 'default', label: '標準' }]);
  if (!state.dataLoaded) {
    state.query.sort = { key: 'default', dir: 'asc' };
    updateSortChip_();
    $('sortDirToggle').textContent = '↑';
  }

  buildBrandListOnce_(state.options.brand || []);
  updateBrandBtn_();
  filterBrandList_();

  state.dataLoaded = true;
  filterAndRender(false);

  // メイン画面おすすめ商品を表示
  renderMainRecommendations_();
}

window.addEventListener('error', function(ev) {
  var msg = (ev && ev.error && ev.error.message) ? ev.error.message : (ev && ev.message ? ev.message : 'エラー');
  // Suppress cross-origin "Script error" messages (not useful to users)
  if (msg === 'Script error.' || msg === 'Script error') return;
  try { showToast(msg); } catch (e) {}
});

window.addEventListener('unhandledrejection', function(ev) {
  var r = ev ? ev.reason : null;
  var msg = (r && r.message) ? r.message : String(r || 'エラー');
  try { showToast(msg); } catch (e) {}
});

boot();
</script>

<!-- === AI Chatbot Widget === -->
<button class="chatbot-fab" id="chatbotFab" type="button" aria-label="チャットで質問する">
  <span class="chatbot-fab-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/><circle cx="8" cy="10" r="1.2"/><circle cx="12" cy="10" r="1.2"/><circle cx="16" cy="10" r="1.2"/></svg></span>
  <span class="chatbot-fab-close"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></span>
  <span class="chatbot-badge" id="chatbotBadge">1</span>
</button>

<div class="chatbot-panel" id="chatbotPanel">
  <div class="chatbot-header">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    AIアシスタント
    <span class="chatbot-header-actions">
      <button class="chatbot-header-toTop" id="chatbotHeaderToTop" type="button" aria-label="ページ上部へ" title="ページ上部へ">↑</button>
      <button class="chatbot-close-btn" id="chatbotCloseBtn" type="button" aria-label="閉じる" title="閉じる">×</button>
    </span>
  </div>
  <div class="chatbot-messages" id="chatbotMessages"></div>
  <div class="chatbot-input-area">
    <textarea id="chatbotInput" placeholder="質問を入力してください..." rows="1"></textarea>
    <button class="chatbot-send-btn" id="chatbotSend" type="button" aria-label="送信"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
</div>

<script>
(function(){
  var fab = document.getElementById('chatbotFab');
  var panel = document.getElementById('chatbotPanel');
  var messagesEl = document.getElementById('chatbotMessages');
  var input = document.getElementById('chatbotInput');
  var sendBtn = document.getElementById('chatbotSend');
  var badge = document.getElementById('chatbotBadge');
  var closeBtn = document.getElementById('chatbotCloseBtn');
  var headerToTop = document.getElementById('chatbotHeaderToTop');
  var toTopBtn = document.getElementById('toTopBtn');
  var isOpen = false;
  var chatHistory = [];
  var isSending = false;
  var greeted = false;

  // お問い合わせリンク等から外部的にチャットを閉じるためのグローバル関数
  window.closeChatbot = function(){
    if (!isOpen) return;
    isOpen = false;
    panel.classList.remove('open');
    fab.classList.remove('open');
    // 閉じたときにスクロール位置に応じてtoTopBtn再表示
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > 400) toTopBtn.classList.add('show');
  };

  // ── 定型FAQ ──
  var FAQ = [
    // --- 注文・購入 ---
    { q: '注文方法を教えて', category: '注文・購入',
      a: '【ご注文方法】\n1. 商品一覧からお好みの商品をカートに追加\n2. 10点以上でご注文可能です\n3. お届け先を入力すると送料が自動計算されます\n4. お支払い方法を選んで注文確定\n\n詳しくは画面上部の「商品ガイド」もご覧ください。' },
    { q: '最低注文数は？', category: '注文・購入',
      a: '最低注文数は10点からとなっております。\n10点以上であれば何点でもご注文いただけます。' },
    { q: 'カートの使い方は？', category: '注文・購入',
      a: '【カートの使い方】\n・商品の「カートに追加」ボタンで追加できます\n・カートアイコンをタップすると中身を確認できます\n・数量の変更や削除もカート内で行えます\n・商品の確保期間はカート追加から15分です\n\n※15分を過ぎると在庫が解放される場合があります。' },
    { q: '在庫の確保時間は？', category: '注文・購入',
      a: '商品の確保期間はカートに入れた時点から15分間です。\n15分を過ぎると他のお客様が購入できる状態に戻ります。\nお早めのご注文をおすすめします。' },
    { q: '注文後のキャンセルはできる？', category: '注文・購入',
      a: 'ご注文確定後のキャンセル・変更はお受けしておりません。\nご注文前に商品内容をよくご確認ください。\n\n万一、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。' },

    // --- 送料・配送 ---
    { q: '送料はいくら？', category: '送料・配送',
      a: '【送料について】\n送料はお届け先の地域と荷物のサイズによって異なります。\n\n・宅配便（小）：990円〜1,700円\n・宅配便（大）：1,260円〜2,280円\n・ダイヤモンド会員は送料無料！\n\n詳しくは画面上部の「送料表」ボタンからご確認ください。' },
    { q: '配送にかかる日数は？', category: '送料・配送',
      a: '決済完了後、通常2〜5営業日で発送いたします。\nお届けまでの日数は地域により異なりますが、発送から1〜3日程度です。\n\n※繁忙期や天候・災害等により遅延する場合がございます。' },
    { q: '送料無料になる条件は？', category: '送料・配送',
      a: 'ダイヤモンド会員のお客様は送料無料です！\n\nダイヤモンド会員になるには、累計購入額30万円以上が条件となります。\n詳しくは「会員ランクについて」をご確認ください。' },

    // --- 決済 ---
    { q: '決済方法は？', category: '決済',
      a: '【ご利用可能な決済方法】\n・クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）\n・Apple Pay\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n・PayPay\n・ペイジー（振込手数料はお客様負担）\n\nクレジットカード・Apple Pay・PayPayが最もスムーズにお手続きいただけます。' },
    { q: 'コンビニ決済の手数料は？', category: '決済',
      a: 'コンビニ決済をご利用の場合、別途220円の手数料がかかります。\n\n手数料を抑えたい場合は、クレジットカード・Apple Pay・PayPay決済がおすすめです。' },
    { q: '銀行振込の手数料は？', category: '決済',
      a: '銀行振込をご利用の場合、振込手数料はお客様のご負担となります。\n手数料の金額はご利用の金融機関により異なります。\nペイジーも同様です。' },

    // --- 割引・セール ---
    { q: '割引はある？', category: '割引・セール',
      a: '【現在の割引制度】\n\n1. 30点以上まとめ買い割引：10%OFF\n2. 会員登録割引：10%OFF（2026年9月末まで）\n3. 上記は併用可能！最大20%OFF\n\nたくさん買うほどお得です！' },
    { q: '30点割引の詳細は？', category: '割引・セール',
      a: '30点以上をまとめてご注文いただくと、商品代金が10%OFFになります。\n\n・30点以上であれば何点でも10%OFF\n・会員割引との併用OK\n・割引はカート内で自動計算されます' },
    { q: '会員割引の期間は？', category: '割引・セール',
      a: '会員登録で全品10%OFFの特典は2026年9月末までの期間限定です。\n\n・無料登録するだけで適用\n・30点まとめ買い割引と併用可能\n・期間中はいつでもご利用いただけます\n\nお早めの登録がおすすめです！' },

    // --- 会員 ---
    { q: '会員登録の方法は？', category: '会員',
      a: '【会員登録の方法】\n画面上部の「無料会員登録」ボタンからお手続きいただけます。\n\n・メールアドレスとパスワードの設定だけで完了\n・登録は無料です\n・登録直後から会員割引（10%OFF）が適用されます' },
    { q: '会員ランクについて', category: '会員',
      a: '【会員ランク制度】\n\n・レギュラー：初回登録時（10%OFF特典）\n・シルバー：累計5万円以上\n・ゴールド：累計15万円以上\n・ダイヤモンド：累計30万円以上（送料無料！）\n\nランクが上がるほど特典が充実します。' },
    { q: 'ダイヤモンド会員の特典は？', category: '会員',
      a: '【ダイヤモンド会員特典】\n・送料無料（国内全域）\n・優先在庫確保\n\n条件：累計購入額30万円以上\nたくさんご利用いただくほどお得になります！' },

    // --- 商品 ---
    { q: '状態ランクの見方は？', category: '商品',
      a: '【状態ランク一覧】\n・S：新品・未使用・タグ付きなど\n・A：使用感がほとんどない美品\n・AB：多少の使用感があるが状態良好\n・B：一般的な使用感・軽微なダメージあり\n・C：使用感強め・目立つダメージあり\n・D：ジャンク・難あり品\n\n各商品の詳細ページで写真とあわせてご確認ください。' },
    { q: '採寸データはある？', category: '商品',
      a: 'はい、すべての商品に採寸データが付いています。\n\n商品詳細ページで寸法（着丈・身幅・肩幅・袖丈など）をご確認いただけます。\nサイズ選びの参考にしてください。' },
    { q: '写真と実物は違う？', category: '商品',
      a: '商品写真はできるだけ実物に近い状態で撮影しておりますが、以下の点にご注意ください：\n\n・モニター環境により色味が多少異なる場合があります\n・写真はサンプルイメージの場合があります\n・状態ランクは目視による判定です\n\n気になる点がございましたらお気軽にお問い合わせください。' },
    { q: 'ブランドの検索方法は？', category: '商品',
      a: '【ブランド検索の方法】\n・画面上部のフィルター機能でブランドを選択できます\n・複数ブランドの同時選択も可能です\n・キーワード検索バーからブランド名で検索することもできます\n\nぜひご活用ください！' },

    // --- 返品・サポート ---
    { q: '返品・交換はできる？', category: '返品・サポート',
      a: '返品・交換は原則お受けしておりません。\n\nただし、商品内容が記載事項と大きく異なる場合は、商品到着後7日以内にご連絡ください。\n\n✉ お問い合わせ よりご連絡いただけます。' },
    { q: 'お問い合わせしたい', category: '返品・サポート',
      a: 'お問い合わせは以下の方法で承っております：\n\n✉ お問い合わせ フォームからご連絡ください。\n\n営業時間内にご返信いたします。\nお気軽にどうぞ！' },
    { q: '営業時間は？', category: '返品・サポート',
      a: '営業時間：平日 10:00〜18:00\n（土日祝はお休みです）\n\n営業時間外のお問い合わせは翌営業日にご返信いたします。' }
  ];

  var GREETING = 'こんにちは！デタウリ.Detauriへようこそ。\nご質問のカテゴリをお選びいただくか、下の入力欄から自由にご質問ください。';

  // ── 開閉 ──
  function toggleChat(){
    isOpen = !isOpen;
    window._chatbotIsOpen = isOpen;
    panel.classList.toggle('open', isOpen);
    fab.classList.toggle('open', isOpen);
    badge.classList.remove('show');
    if (isOpen && !greeted) {
      greeted = true;
      appendMessage('bot', GREETING);
      showCategoryButtons();
    }
    if (isOpen) {
      setTimeout(function(){ input.focus(); }, 200);
      scrollToBottom();
    }
  }

  fab.addEventListener('click', toggleChat);
  closeBtn.addEventListener('click', toggleChat);

  // ヘッダーのページ上部ボタン
  headerToTop.addEventListener('click', function(){
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // チャットボット開閉時にスクロールトップボタンの状態を更新
  // ※重複するscrollハンドラを廃止し、setupScrollTopButton_()の既存ハンドラに統合
  // chatbotのisOpen状態はwindow._chatbotIsOpen経由で共有
  window._chatbotIsOpen = false;

  // 初回バッジ表示（3秒後）
  setTimeout(function(){
    if (!isOpen) badge.classList.add('show');
  }, 3000);

  // ── クイック返信: カテゴリ一覧を表示 ──
  function showCategoryButtons(){
    var categories = [];
    var seen = {};
    FAQ.forEach(function(item){
      if (!seen[item.category]) { seen[item.category] = true; categories.push(item.category); }
    });
    var wrap = document.createElement('div');
    wrap.className = 'chatbot-quick-replies';
    wrap.style.cssText = 'margin-top:6px;';
    categories.forEach(function(cat){
      var b = document.createElement('button');
      b.className = 'chatbot-quick-btn';
      b.textContent = cat;
      b.type = 'button';
      b.addEventListener('click', function(){
        showQuestionsForCategory(cat);
      });
      wrap.appendChild(b);
    });
    messagesEl.appendChild(wrap);
    scrollToBottom();
  }

  // カテゴリ選択後 → そのカテゴリの質問ボタンを表示
  function showQuestionsForCategory(cat){
    // カテゴリ選択をユーザー発言として表示
    appendMessage('user', cat);

    var items = FAQ.filter(function(f){ return f.category === cat; });
    var botMsg = document.createElement('div');
    botMsg.className = 'chatbot-msg bot';
    botMsg.style.cssText = 'padding-bottom:6px;';
    botMsg.textContent = '「' + cat + '」に関するご質問をお選びください。';
    messagesEl.appendChild(botMsg);

    var wrap = document.createElement('div');
    wrap.className = 'chatbot-quick-replies';
    wrap.style.cssText = 'padding:0 2px;margin-top:4px;';
    items.forEach(function(item){
      var b = document.createElement('button');
      b.className = 'chatbot-quick-btn';
      b.textContent = item.q;
      b.type = 'button';
      b.addEventListener('click', function(){
        handleQuickReply(item);
      });
      wrap.appendChild(b);
    });
    // 「戻る」ボタン
    var back = document.createElement('button');
    back.className = 'chatbot-quick-btn';
    back.style.cssText = 'border-color:#94a3b8;color:#64748b;';
    back.textContent = '\u2190 カテゴリに戻る';
    back.type = 'button';
    back.addEventListener('click', function(){
      appendMessage('user', 'カテゴリに戻る');
      var note = document.createElement('div');
      note.className = 'chatbot-msg bot';
      note.textContent = 'カテゴリをお選びください。';
      messagesEl.appendChild(note);
      showCategoryButtons();
    });
    wrap.appendChild(back);
    messagesEl.appendChild(wrap);
    scrollToBottom();
  }

  function handleQuickReply(item){
    appendMessage('user', item.q);
    chatHistory.push({ role: 'user', content: item.q });
    // 回答をスクロール位置のアンカーにする
    var answerDiv = appendMessageAndReturn('bot', item.a);
    chatHistory.push({ role: 'assistant', content: item.a });
    // 回答後にカテゴリ選択を再表示
    showAfterAnswer(answerDiv);
  }

  // 回答後の案内＋カテゴリボタン表示（回答が見える位置にスクロール）
  function showAfterAnswer(answerEl){
    var note = document.createElement('div');
    note.className = 'chatbot-msg bot';
    note.textContent = '他にもご質問がありましたら、カテゴリをお選びいただくか、自由に入力してください。';
    messagesEl.appendChild(note);
    showCategoryButtons();
    // 回答の先頭が見える位置にスクロール
    scrollToElement(answerEl);
  }

  // ── 送信 ──
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', function(e){
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // テキストエリア自動リサイズ
  input.addEventListener('input', function(){
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
  });

  function sendMessage(){
    if (isSending) return;
    var text = input.value.trim();
    if (!text) return;
    if (text.length > 500) {
      appendMessage('bot', 'メッセージは500文字以内でお願いします。');
      return;
    }

    appendMessage('user', text);
    chatHistory.push({ role: 'user', content: text });
    input.value = '';
    input.style.height = 'auto';

    // まずFAQマッチを試みる
    var matched = matchFaq(text);
    if (matched) {
      var ansDiv = appendMessageAndReturn('bot', matched.a);
      chatHistory.push({ role: 'assistant', content: matched.a });
      showAfterAnswer(ansDiv);
      return;
    }

    // FAQに該当しない場合はAPI呼び出し
    isSending = true;
    sendBtn.disabled = true;
    var typingEl = showTyping();

    runApi('apiChatbot', getUserKey_(), { message: text, history: chatHistory.slice(-6) })
      .then(function(res){
        removeTyping(typingEl);
        var reply = (res && res.reply) ? res.reply : '';
        var ansDiv;
        if (!reply || isUnanswerable(reply)) {
          var fallback = '申し訳ございません。お探しの情報が見つかりませんでした。\n\n詳しくは ✉ お問い合わせ よりスタッフにお問い合わせください。\n担当者が直接ご対応いたします。';
          ansDiv = appendMessageAndReturn('bot', fallback);
          chatHistory.push({ role: 'assistant', content: fallback });
        } else {
          ansDiv = appendMessageAndReturn('bot', reply);
          chatHistory.push({ role: 'assistant', content: reply });
        }
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-12);
        showAfterAnswer(ansDiv);
      })
      .catch(function(err){
        removeTyping(typingEl);
        var fallback = '通信エラーが発生しました。\n\nお手数ですが ✉ お問い合わせ よりご連絡ください。';
        appendMessage('bot', fallback);
      })
      .finally(function(){
        isSending = false;
        sendBtn.disabled = false;
        input.focus();
      });
  }

  // FAQキーワードマッチ
  function matchFaq(text){
    var t = text.toLowerCase().replace(/[\s　?？!！。、.,]/g, '');
    var best = null;
    var bestScore = 0;
    FAQ.forEach(function(item){
      var score = 0;
      var keywords = getKeywords(item.q);
      keywords.forEach(function(kw){
        if (t.indexOf(kw) !== -1) score += kw.length;
      });
      if (score > bestScore) { bestScore = score; best = item; }
    });
    // スコアが閾値以上ならマッチとみなす
    return bestScore >= 2 ? best : null;
  }

  function getKeywords(q){
    // 質問文からキーワードを抽出
    var words = q.replace(/[\s　?？!！。、.,を・はのにてでがもとへ]/g, ' ').split(/\s+/).filter(function(w){ return w.length >= 2; });
    return words.map(function(w){ return w.toLowerCase(); });
  }

  // AI回答が「わからない」系かチェック
  function isUnanswerable(reply){
    var markers = ['わかりません', 'お答えできません', '情報がありません', '対応できません', 'お問い合わせください'];
    var r = reply.toLowerCase();
    return markers.some(function(m){ return r.indexOf(m) !== -1; });
  }

  function appendMessage(role, text){
    appendMessageAndReturn(role, text);
  }

  function appendMessageAndReturn(role, text){
    var div = document.createElement('div');
    div.className = 'chatbot-msg ' + role;
    if (role === 'bot') {
      var span = document.createElement('span');
      span.textContent = text;
      var safe = span.innerHTML;
      safe = safe.replace(/✉\s*お問い合わせ/g, '<a href="#" style="color:#3b82f6;text-decoration:underline;cursor:pointer;" onclick="event.preventDefault();if(typeof closeChatbot===\'function\')closeChatbot();openModal(document.getElementById(\'contactModal\'));return false;">✉ お問い合わせ</a>');
      div.innerHTML = safe;
    } else {
      div.textContent = text;
    }
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function showTyping(){
    var div = document.createElement('div');
    div.className = 'chatbot-msg typing';
    div.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function removeTyping(el){
    if (el && el.parentNode) el.parentNode.removeChild(el);
  }

  function scrollToBottom(){
    requestAnimationFrame(function(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // 指定要素が上端付近に見える位置にスクロール
  function scrollToElement(el){
    if (!el) return;
    requestAnimationFrame(function(){
      var containerTop = messagesEl.getBoundingClientRect().top;
      var elTop = el.getBoundingClientRect().top;
      var offset = elTop - containerTop;
      messagesEl.scrollTop = messagesEl.scrollTop + offset - 8;
    });
  }

  function getUserKey_(){
    if (typeof state !== 'undefined' && state && state.userKey) return state.userKey;
    try {
      var k = localStorage.getItem('detauri_userKey');
      if (k) return k;
    } catch(e){}
    return 'chatbot_anon_' + Math.random().toString(36).slice(2, 10);
  }
})();
</script>

</body>
</html>
