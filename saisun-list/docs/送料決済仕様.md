# 送料込み決済 実装仕様書

## 概要

商品代に加え、送料を自動計算してKOMOJU決済に含める仕組み。
上限を超える注文は後決済モードにフォールバックし、管理者が送料確定後に合算決済リンクを送付。

**ダイヤモンド会員は送料無料。**

---

## 現在の状態（実装済み）

| 項目 | 状態 |
|---|---|
| KOMOJU決済連携 | 実装済み（KOMOJU.gs） |
| 送料表モーダル | 実装済み（index.html） |
| 会員ランク制度 | 実装済み（CustomerAuth.gs, index.html） |
| ポイント利用 | 実装済み（SubmitFix.gs, index.html） |
| 注文送信 | 後決済モード（商品代のみ。送料は後から案内） |
| **送料自動計算 → 決済** | **未実装（本仕様の対象）** |

### 現在のフロー
```
商品選択 → お届け先入力 → 注文送信（商品代のみ）
  → 管理者が送料を確定 → メールで案内 → BASE決済 or KOMOJU決済
```

### 目標のフロー
```
商品選択 → お届け先入力 → 送料自動計算・表示
  → 上限内: KOMOJU決済（商品代+送料 一括）
  → 上限超: 後決済モード（管理者が送料確定後に決済リンク送付）
```

---

## 依頼管理シート列構成（30列 A-AD）

| 列 | ヘッダー | 用途 |
|---|---|---|
| A | 受付番号 | |
| B | 依頼日時 | |
| C | 会社名/氏名 | |
| D | 連絡先 | メール |
| E | 郵便番号 | |
| F | 住所 | |
| G | 電話番号 | |
| H | 商品名 | |
| I | 確認リンク | |
| J | 選択リスト | 管理番号（、区切り） |
| K | 合計点数 | |
| L | 合計金額 | 商品代+送料の合計 |
| M | 発送ステータス | 未着手/発送済/完了 etc |
| N | リスト同梱 | |
| O | xlsx送付 | |
| P | ステータス | 依頼中/完了/キャンセル etc |
| Q | 担当者 | |
| R | 入金確認 | 未対応/入金待ち/対応済 |
| S | インボイス発行 | 希望/空 |
| T | インボイス状況 | 送付済/取消済/空 |
| U | 予備 | |
| V | 備考 | ポイント利用情報含む |
| W | 配送業者 | |
| X | 伝票番号 | |
| Y | 作業報酬 | |
| Z | 更新日時 | |
| AA | 通知フラグ | LINE通知用 |
| AB | ポイント付与済 | PT |
| AC | 送料(店負担) | BASE送料=0の場合に送料表から自動計算 |
| AD | 送料(客負担) | BASE注文の送料（顧客支払い分） |

---

## 会員ランク制度（実装済み）

| ランク | 年間購入金額 | ポイント還元 | 特典 |
|---|---|---|---|
| レギュラー | - | 1% | - |
| シルバー | 5万円〜 | 3% | - |
| ゴールド | 20万円〜 | 5% | - |
| ダイヤモンド | 50万円〜 | 5% | **送料無料** |

- 過去12ヶ月の完了注文金額で判定（年間ローリング更新）
- 救済: ダイヤ/ゴールド更新切れ後1ヶ月以内に5万円以上購入→前ランク復活
- 復帰ゴールド限定: 年間35万円でダイヤモンド昇格

---

## 1. 送料テーブル（実装対象: Config.gs）

### 料金体系
- 送料表モーダル（index.html）に表示中の金額がそのまま顧客支払い送料

### エリアマッピング

```javascript
var SHIPPING_AREAS = {
  '北海道': 'hokkaido',
  '青森県': 'kita_tohoku', '岩手県': 'kita_tohoku', '秋田県': 'kita_tohoku',
  '宮城県': 'minami_tohoku', '福島県': 'minami_tohoku', '山形県': 'minami_tohoku',
  '東京都': 'kanto', '神奈川県': 'kanto', '埼玉県': 'kanto', '千葉県': 'kanto',
  '茨城県': 'kanto', '栃木県': 'kanto', '群馬県': 'kanto', '山梨県': 'kanto',
  '新潟県': 'shinetsu', '長野県': 'shinetsu',
  '愛知県': 'tokai', '静岡県': 'tokai', '岐阜県': 'tokai', '三重県': 'tokai',
  '石川県': 'hokuriku', '福井県': 'hokuriku', '富山県': 'hokuriku',
  '大阪府': 'kansai', '兵庫県': 'kansai', '京都府': 'kansai',
  '奈良県': 'kansai', '和歌山県': 'kansai', '滋賀県': 'kansai',
  '広島県': 'chugoku', '岡山県': 'chugoku', '島根県': 'chugoku',
  '山口県': 'chugoku', '鳥取県': 'chugoku',
  '香川県': 'shikoku', '愛媛県': 'shikoku', '高知県': 'shikoku', '徳島県': 'shikoku',
  '福岡県': 'kita_kyushu', '佐賀県': 'kita_kyushu', '大分県': 'kita_kyushu', '長崎県': 'kita_kyushu',
  '鹿児島県': 'minami_kyushu', '熊本県': 'minami_kyushu', '宮崎県': 'minami_kyushu',
  '沖縄県': 'okinawa'
};
```

### 送料テーブル

```javascript
var SHIPPING_RATES = {
//                        小      大       ※全て税込
  minami_kyushu:       [1320,  1700],
  kita_kyushu:         [1280,  1620],
  shikoku:             [1180,  1440],
  chugoku:             [1200,  1480],
  kansai:              [1100,  1260],
  hokuriku:            [1160,  1420],
  tokai:               [1180,  1440],
  shinetsu:            [1220,  1540],
  kanto:               [1300,  1680],
  minami_tohoku:       [1400,  1900],
  kita_tohoku:         [1460,  1980],
  hokkaido:            [1640,  2380],
  okinawa:             [2500,  3500]   // 沖縄本島のみ。離島は配送対象外
};
```

---

## 2. データ準備（発送方法の同期）

### 目的
厚み判定用に商品管理L列の発送方法をフロントまで渡す。

### データの流れ
```
仕入れ管理SS 商品管理(L列:発送方法) → 本SS データ1(Y列) → JSON → フロントエンド
```

### 変更対象

| ファイル | 変更内容 |
|---|---|
| コード.gs | `syncFull_()`: 商品管理L列をデータ1 Y列に書き込み |
| Config.gs | `readCols: 25`（Y列まで読み込み） |
| StateStore.gs | `pr_readProducts_()`: `row[24]`から`shippingMethod`を読み取りJSONに追加 |

---

## 3. 厚み判定ロジック（index.html）

### 判定基準

| shippingMethod の値 | 分類 |
|---|---|
| `ゆうパケットポスト` | 薄手 |
| それ以外（空含む） | 厚手 |

### 箱サイズ・上限ルール

| 構成 | サイズ | 上限点数 | 超過時 |
|---|---|---|---|
| 全品薄手 | 1〜10点:小 / 11〜40点:大 | 40点 | 後決済モード |
| 厚手のみ | 大のみ | 20点 | 後決済モード |
| 混合（厚手10点未満） | 1〜10点:小 / 11〜40点:大 | 40点 | 後決済モード |
| 混合（厚手10点以上） | 大のみ | 合計40点 | 後決済モード |

```javascript
function classifyThickness_(items) {
  var thick = 0, thin = 0;
  for (var i = 0; i < items.length; i++) {
    if (String(items[i].shippingMethod || '').trim() === 'ゆうパケットポスト') thin++;
    else thick++;
  }
  return { thick: thick, thin: thin, total: thick + thin };
}

function calcShippingSize_(thick, thin) {
  var total = thick + thin;
  if (thin === 0) {
    if (total > 20) return { size: null, reason: 'overLimit' };
    return { size: 'large', label: '大' };
  }
  if (thick === 0) {
    if (total > 40) return { size: null, reason: 'overLimit' };
    return total <= 10 ? { size: 'small', label: '小' } : { size: 'large', label: '大' };
  }
  if (total > 40) return { size: null, reason: 'overLimit' };
  if (thick >= 10) return { size: 'large', label: '大' };
  return total <= 10 ? { size: 'small', label: '小' } : { size: 'large', label: '大' };
}
```

---

## 4. 都道府県の自動検知（index.html）

住所入力フィールドから都道府県を抽出し、送料をリアルタイム表示。

```javascript
var PREFECTURES = [
  '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
  '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
  '新潟県','富山県','石川県','福井県','山梨県','長野県',
  '岐阜県','静岡県','愛知県','三重県',
  '滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県',
  '鳥取県','島根県','岡山県','広島県','山口県',
  '徳島県','香川県','愛媛県','高知県',
  '福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'
];

function detectPrefecture_(addressText) {
  var text = String(addressText || '').trim();
  for (var i = 0; i < PREFECTURES.length; i++) {
    if (text.indexOf(PREFECTURES[i]) === 0) return PREFECTURES[i];
  }
  var short;
  for (var j = 0; j < PREFECTURES.length; j++) {
    short = PREFECTURES[j].replace(/[都府県]$/, '');
    if (text.indexOf(short) === 0) return PREFECTURES[j];
  }
  return null;
}
```

---

## 5. フロントエンド送料計算（index.html）

### 送料計算メイン関数

```javascript
function calculateShipping_() {
  var items = getCartItems_();  // カート内商品（shippingMethod付き）
  var address = $('address').value;
  var pref = detectPrefecture_(address);

  // ダイヤモンド会員 → 送料無料
  if (state.customer && state.customer.rank && state.customer.rank.freeShipping) {
    return { amount: 0, label: '送料無料（ダイヤモンド会員特典）', canAutoPayment: true };
  }

  if (!pref) return { amount: null, label: '住所を入力すると送料が表示されます', canAutoPayment: false };

  var area = SHIPPING_AREAS[pref];
  if (!area || !SHIPPING_RATES[area]) return { amount: null, label: '送料は別途ご案内します', canAutoPayment: false };

  var t = classifyThickness_(items);
  var sizeResult = calcShippingSize_(t.thick, t.thin);

  if (!sizeResult.size) {
    // 上限超過 → 後決済モードにフォールバック
    return { amount: null, label: '点数が多いため送料は別途ご案内します', canAutoPayment: false };
  }

  var rateIdx = (sizeResult.size === 'small') ? 0 : 1;
  var amount = SHIPPING_RATES[area][rateIdx];

  return {
    amount: amount,
    label: yen(amount) + '（' + pref + '・' + sizeResult.label + '）',
    canAutoPayment: true,
    size: sizeResult.size,
    area: area
  };
}
```

### UI表示（カートモーダル内 sumBox 付近）

```
合計金額：                 ¥XX,XXX（会員10%OFF）
送料：                     ¥1,100（大阪府・小）   ← 新規追加
お支払い合計：              ¥XX,XXX               ← 新規追加
[お支払いへ進む]  or  [注文を送信]
```

- 住所入力の `input` イベントで `calculateShipping_()` を呼び出しリアルタイム更新
- ダイヤモンド会員は「送料無料（ダイヤモンド会員特典）」表示
- 上限超 or 沖縄 → 「送料は別途ご案内します」+後決済モードボタン

---

## 6. フロー分岐

### A: 上限内（送料自動計算 → KOMOJU決済）

```
住所入力 → 都道府県検知 → 厚み判定 → 箱サイズ決定 → 送料テーブル参照
  ↓
画面表示:
  商品代:       ¥12,000
  会員割引:     -¥1,200
  ポイント利用: -500pt
  送料:         ¥1,100（関西・小）
  合計:         ¥11,400
  [お支払いへ進む]
  ↓
KOMOJU決済セッション作成（amount = 商品代 - 割引 - ポイント + 送料）
  ↓
決済完了 → webhook → 依頼管理書き込み → 確認メール
```

#### KOMOJU.gs 変更点

```javascript
// apiCreateKomojuSession の metadata に送料情報追加
metadata: {
  receipt_no: receiptNo,
  company_name: String(info.companyName || ''),
  email: email,
  product_amount: productAmount,    // 追加
  shipping_amount: shippingAmount,  // 追加
  shipping_size: shippingSize       // 追加: 'small' or 'large'
}
```

#### SubmitFix.gs 変更点

```javascript
// apiSubmitEstimate に送料パラメータ追加
var shippingAmount = Number(f.shippingAmount || 0);
var totalPayment = discounted + shippingAmount;  // 商品代（割引・ポイント適用後）+ 送料

// L列（合計金額）に送料込みの金額を書き込み
data.discounted || 0,  // → totalPayment に変更

// V列（備考）に送料内訳を追記
// 【送料: ¥1,100（関西・小）】
```

### B: 上限超 or 判定不能（後決済モード）

```
住所入力 → 上限超過を検知
  ↓
画面表示:
  商品代:   ¥50,000
  送料:     別途ご案内
  [注文を送信]
  ↓
注文送信（現行フロー通り・決済なし）
  ↓
管理者が送料を確定
  ↓
管理者用: 合算決済リンク生成 → メール送付
  ↓
ユーザーが決済して完了
```

#### 管理者用: 決済リンク送付メニュー（コード.gs + KOMOJU.gs）

既存のメニューに追加:
```
管理メニュー → 決済リンク送付
  → 受付番号入力 → 送料入力 → 決済リンク生成 → メール送信
```

---

## 7. 変更対象ファイル一覧

| ファイル | 変更内容 | 状態 |
|---|---|---|
| **コード.gs** | `syncFull_`: 商品管理L列→データ1 Y列に発送方法を同期 | 実装済み |
| **Config.gs** | `readCols: 25`、`SHIPPING_AREAS`、`SHIPPING_RATES`（沖縄込み）、`calcShippingByAddress_`、離島判定 | 実装済み |
| **StateStore.gs** | `pr_readProducts_`: shippingMethod をJSONに追加 | 実装済み |
| **index.html** | 都道府県検知、厚み判定、送料計算・表示、フロー分岐UI、sumBox送料行追加、離島ブロック | 実装済み |
| **KOMOJU.gs** | metadata に送料情報追加。メルペイ削除。決済方法を最新化 | 実装済み |
| **SubmitFix.gs** | 送料パラメータ受け取り、L列に送料込み金額保存、備考に送料内訳、AD列に送料書き込み | 実装済み |
| **CustomerAuth.gs** | ランク判定でfreeShipping情報（実装済み・変更不要） | 実装済み |

---

## 8. 実装手順

次回のセッションで以下のように伝えてください:

> **「docs/送料決済仕様.md を実装して」**

段階的に進める場合:
1. **「送料のデータ準備を実装して」** — 発送方法の同期（コード.gs, Config.gs, StateStore.gs）
2. **「送料の自動計算UIを実装して」** — フロント送料計算・表示（index.html）
3. **「送料込みKOMOJU決済を実装して」** — 上限内の自動決済フロー（KOMOJU.gs, SubmitFix.gs）
4. **「管理者用の決済リンク送付を実装して」** — 上限超の手動決済フロー（コード.gs, KOMOJU.gs）

---

## 9. 送料列の実装状況（AC・AD列）

### 実装済み

| 項目 | 状態 | 詳細 |
|---|---|---|
| 依頼管理ヘッダー | 実装済み | AC=送料(店負担)、AD=送料(客負担) |
| Config.gs 送料テーブル | 実装済み | SHIPPING_AREAS、SHIPPING_RATES、calcShippingByAddress_ |
| BASE_注文→依頼管理 自動分別 | 実装済み | BASE送料>0→客負担、0→送料表計算→店負担 |
| SubmitFix.gs 列対応 | 実装済み | 空値で30列出力 |

### 送料分別ルール

```
BASE_注文同期時:
  送料 > 0 → AD列(客負担) に設定
  送料 = 0 → 送料表×住所(都道府県)×合計点数で計算 → AC列(店負担) に設定

点数計算ルール:
  確認リンク(I列)にデータあり → 1点として計算
  確認リンク(I列)空 → K列(合計点数)をそのまま使用

箱サイズ判定:
  合計点数 ≤ 10 → 小（SHIPPING_RATES[area][0]）
  合計点数 > 10  → 大（SHIPPING_RATES[area][1]）

注文に複数商品がある場合:
  最初の新規行にのみ送料を設定（重複計上防止）
```

### 決済機能搭載時の条件分岐手順

決済機能（KOMOJU等）を搭載する際、送料列に以下の条件分岐を追加する:

```
1. SubmitFix.gs (apiSubmitEstimate):
   - フロントから送料情報を受け取り（shippingAmount, shippingSize, shippingArea）
   - ダイヤモンド会員 → AC=0, AD=0（送料無料）
   - KOMOJU決済あり → AD列(客負担) に送料を設定
   - 後決済モード（決済なし） → AC列(店負担) に送料を設定
   - L列（合計金額）に送料を含めた合計を保存

2. KOMOJU.gs (apiCreateKomojuSession):
   - amount に送料を加算（商品代 + 送料）
   - metadata に shipping_amount, shipping_size を追加

3. KOMOJU Webhook 処理:
   - 決済完了時: AD列(客負担) に送料確定額を書き込み
   - 決済失敗時: 送料列は変更しない

4. 管理者用決済リンク送付（後決済モード→後決済）:
   - 管理者が送料を手動確定
   - 決済リンク生成時に AC→AD に送料を移動（店負担→客負担）
   - または送料確定額で新たにAD列を更新
```

---

## 10. 決定済み事項（2026-02-13 確定）

- [x] 沖縄県の送料 → **小: 2,500円 / 大: 3,500円**（沖縄本島のみ対応）
- [x] 離島の扱い → **配送対象外**（離島住所を検知して注文をブロック）
- [x] 送料の税込/税別表記 → **全て税込み**
- [x] 会員割引は送料にも適用するか → **送料は割引対象外**（商品代のみに適用）

## 11. 決済方法の対応状況

| 決済方法 | 状態 | 備考 |
|---|---|---|
| クレジットカード（Visa/Mastercard） | 利用可能 | |
| クレジットカード（JCB/AMEX/Diners/Discover 日本） | 申請中 | |
| コンビニ払い | 利用可能 | セブン-イレブンを除く |
| 銀行振込 | 利用可能 | |
| LINE Pay | 利用可能 | |
| PayPay | 申請中 | |
| Paidy（あと払い） | 申請中 | |
| メルペイ | 使用しない | 削除済み |
