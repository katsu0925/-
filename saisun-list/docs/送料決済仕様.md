# 送料込み決済 実装仕様書

## 概要

商品代に加え、送料を自動計算してKOMOJU決済に含める仕組み。
上限を超える注文は見積もりモードにフォールバックし、管理者が送料確定後に合算決済リンクを送付。

---

## 1. データ準備（発送方法の事前同期）

### 目的
送料計算時にシートを参照せず、フロントエンドで即座に判定できるようにする。

### データの流れ
```
商品管理シート(L列:発送方法) → データ1シート(Y列) → JSON → フロントエンド
```

### 変更対象

#### コード.gs
- `CONFIG.SRC_PRODUCT_COL_L: 12` を追加（商品管理 L列）
- `buildProductMap_()`: L列の発送方法も読み取り、`rec.l`（発送方法）として返す
- `syncFull_()`: 出力行に発送方法を追加、データ1の Y列（25列目）に書き込み
  - 現在の出力: B〜K列（10列）
  - Y列は独立列として別途書き込みが必要（L〜X列は採寸データ等が既にある）

#### Config.gs
- `APP_CONFIG.data.readCols` を 25 に変更（Y列まで読み込み）

#### StateStore.gs - `pr_readProducts_()`
- `row[24]`（Y列、0-indexed）から発送方法を読み取り
- 商品JSONに `shippingMethod` プロパティを追加

```javascript
// 追加箇所（pr_readProducts_ 内）
const shippingMethod = row.length > 24 ? String(row[24] || '').trim() : '';

list.push({
  // ...既存プロパティ...
  shippingMethod: shippingMethod  // 'ゆうパケットポスト' or 'ヤマト宅急便' etc.
});
```

---

## 2. 送料テーブル（Config.gs に定義）

### エリアマッピング

```javascript
const SHIPPING_AREAS = {
  '北海道': 'hokkaido',
  '青森県': 'kita_tohoku', '岩手県': 'kita_tohoku', '秋田県': 'kita_tohoku',
  '宮城県': 'minami_tohoku', '福島県': 'minami_tohoku', '山形県': 'minami_tohoku',
  '東京都': 'kanto', '神奈川県': 'kanto', '埼玉県': 'kanto', '千葉県': 'kanto',
  '茨城県': 'kanto', '栃木県': 'kanto', '群馬県': 'kanto', '山梨県': 'kanto',
  '新潟県': 'shinetsu', '長野県': 'shinetsu',
  '愛知県': 'tokai', '静岡県': 'tokai', '岐阜県': 'tokai', '三重県': 'tokai',
  '石川県': 'hokuriku', '福井県': 'hokuriku', '富山県': 'hokuriku',
  '大阪府': 'kansai', '兵庫県': 'kansai', '京都府': 'kansai',
  '奈良県': 'kansai', '和歌山県': 'kansai', '滋賀県': 'kansai',
  '広島県': 'chugoku', '岡山県': 'chugoku', '島根県': 'chugoku',
  '山口県': 'chugoku', '鳥取県': 'chugoku',
  '香川県': 'shikoku', '愛媛県': 'shikoku', '高知県': 'shikoku', '徳島県': 'shikoku',
  '福岡県': 'kita_kyushu', '佐賀県': 'kita_kyushu', '大分県': 'kita_kyushu', '長崎県': 'kita_kyushu',
  '鹿児島県': 'minami_kyushu', '熊本県': 'minami_kyushu', '宮崎県': 'minami_kyushu',
  '沖縄県': 'okinawa'  // 要確認：送料表に沖縄なし → 別途案内？
};
```

### 料金テーブル

```javascript
const SHIPPING_RATES = {
//                        小      大
  minami_kyushu:       [1320,  1700],
  kita_kyushu:         [1280,  1620],
  shikoku:             [1180,  1440],
  chugoku:             [1200,  1480],
  kansai:              [1100,  1260],
  hokuriku:            [1160,  1420],
  tokai:               [1180,  1440],
  shinetsu:            [1220,  1540],
  kanto:               [1300,  1680],
  minami_tohoku:       [1400,  1900],
  kita_tohoku:         [1460,  1980],
  hokkaido:            [1640,  2380]
};
```

---

## 3. 厚み判定ロジック

### 判定基準（商品管理 L列 / フロントの shippingMethod）

| shippingMethod の値 | 分類 |
|---|---|
| `ゆうパケットポスト` | **薄手** |
| それ以外（空含む） | **厚手** |

### フロントエンドでの判定（index.html）

```javascript
function classifyThickness(items) {
  var thick = 0, thin = 0;
  for (var i = 0; i < items.length; i++) {
    var method = String(items[i].shippingMethod || '').trim();
    if (method === 'ゆうパケットポスト') { thin++; } else { thick++; }
  }
  return { thick: thick, thin: thin, total: thick + thin };
}
```

---

## 4. 箱サイズ・上限ルール

| 構成 | サイズ | 上限点数 | 超過時 |
|---|---|---|---|
| 全品薄手 | 1〜10点:小 / 11〜40点:大 | 40点 | 見積もりモード |
| **厚手のみ** | **大のみ** | **20点** | 見積もりモード |
| 混合（厚手10点未満） | 1〜10点:小 / 11〜40点:大 | 40点 | 見積もりモード |
| 混合（厚手10点以上） | 大のみ | 合計40点 | 見積もりモード |

```javascript
function calcShippingSize(thick, thin) {
  var total = thick + thin;

  // 厚手のみ → 大のみ、20点上限
  if (thin === 0) {
    if (total > 20) return { size: null, reason: 'overLimit' };
    return { size: 'large', label: '大' };
  }

  // 全品薄手
  if (thick === 0) {
    if (total > 40) return { size: null, reason: 'overLimit' };
    return total <= 10
      ? { size: 'small', label: '小' }
      : { size: 'large', label: '大' };
  }

  // 混合
  if (total > 40) return { size: null, reason: 'overLimit' };
  if (thick >= 10) return { size: 'large', label: '大' };
  return total <= 10
    ? { size: 'small', label: '小' }
    : { size: 'large', label: '大' };
}
```

---

## 5. 都道府県の自動検知（index.html）

住所フィールドの入力値から都道府県を抽出する。

```javascript
var PREFECTURES = [
  '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
  '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
  '新潟県','富山県','石川県','福井県','山梨県','長野県',
  '岐阜県','静岡県','愛知県','三重県',
  '滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県',
  '鳥取県','島根県','岡山県','広島県','山口県',
  '徳島県','香川県','愛媛県','高知県',
  '福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'
];

function detectPrefecture(addressText) {
  var text = String(addressText || '').trim();
  for (var i = 0; i < PREFECTURES.length; i++) {
    if (text.indexOf(PREFECTURES[i]) === 0) return PREFECTURES[i];
  }
  // 「県」「府」「都」なしで入力された場合のフォールバック
  for (var j = 0; j < PREFECTURES.length; j++) {
    var short = PREFECTURES[j].replace(/[都府県]$/, '');
    if (text.indexOf(short) === 0) return PREFECTURES[j];
  }
  return null;
}
```

- 住所入力フィールド（`#address`）の `input` イベントで都道府県を検知
- 検知結果をリアルタイムで送料表示に反映
- 検知できない場合は「住所を入力すると送料が表示されます」と表示

---

## 6. フロー分岐

### ④-A: 上限内（自動計算 → KOMOJU即決済）

```
フォーム入力
  ↓ 住所から都道府県検知
  ↓ カート内商品の厚み判定（フロントのJSONデータから）
  ↓ 箱サイズ決定 + 送料テーブル参照
  ↓
画面表示:
  商品代:  ¥12,000
  送料:    ¥1,100（関西・小）
  合計:    ¥13,100
  [お支払いへ進む]
  ↓
KOMOJU決済セッション作成（amount = 商品代 + 送料）
  ↓
決済完了
```

#### KOMOJU セッション変更点（KOMOJU.gs）

```javascript
// 現在
var sessionData = {
  amount: Math.round(amount),
  // ...
};

// 変更後
var sessionData = {
  amount: Math.round(productAmount + shippingAmount),
  // ...
  metadata: {
    receipt_no: receiptNo,
    product_amount: productAmount,
    shipping_amount: shippingAmount,
    shipping_size: shippingSize,  // 'small' or 'large'
    // ...
  }
};
```

#### 依頼管理シートへの書き込み（SubmitFix.gs）
- 送料情報も保存（送料金額、箱サイズ、エリア）

---

### ④-B: 上限超（見積もりモード → 合算決済リンク送付）

```
フォーム入力
  ↓ 上限超過を検知
  ↓
画面表示:
  商品代:  ¥50,000
  送料:    別途ご案内
  ※ 送料は確定後メールでご案内します
  [見積もりを送信]
  ↓
見積もり送信（決済なし、依頼管理に書き込み）
  ↓
管理者が送料を確定（スプレッドシート上 or Admin画面）
  ↓
管理者が合算決済リンクを生成（商品代 + 送料）
  ↓
メールでユーザーに送付
  ↓
ユーザーが1回で決済して完了
```

#### 管理者用: 決済リンク生成機能（KOMOJU.gs に追加）

```javascript
/**
 * 管理者が送料確定後に商品代+送料の決済リンクを生成
 * @param {string} receiptNo - 受付番号
 * @param {number} productAmount - 商品代
 * @param {number} shippingAmount - 送料
 * @param {object} customerInfo - 顧客情報（メール等）
 */
function apiCreateShippingPaymentLink(receiptNo, productAmount, shippingAmount, customerInfo) {
  var totalAmount = productAmount + shippingAmount;
  return apiCreateKomojuSession(receiptNo, totalAmount, customerInfo);
}
```

- Admin.html にUI追加：受付番号入力 → 送料入力 → 決済リンク生成 → メール送信

---

## 7. 変更対象ファイル一覧

| ファイル | 変更内容 |
|---|---|
| **コード.gs** | `syncFull_`: 商品管理L列→データ1 Y列に発送方法を同期 |
| **Config.gs** | `readCols: 25`、送料テーブル・エリアマッピング定義 |
| **StateStore.gs** | `pr_readProducts_`: shippingMethod をJSONに追加 |
| **index.html** | 都道府県検知、厚み判定、送料計算・表示、フロー分岐UI |
| **KOMOJU.gs** | セッション作成に送料情報追加、管理者用決済リンク生成 |
| **SubmitFix.gs** | 送料情報の保存、④-A/④-B分岐 |
| **ApiPublic.gs** | 送料込みsubmit API追加 or 既存API拡張 |
| **Admin.html** | 管理者用: 送料入力 → 決済リンク生成・メール送信UI |

---

## 8. 開始方法

次回のセッションで以下のように伝えてください：

> **「docs/送料決済仕様.md の仕様を実装して」**

段階的に進める場合：
1. 「送料決済仕様のデータ準備（発送方法の同期）を実装して」
2. 「送料決済仕様のフロントエンド（送料計算・表示）を実装して」
3. 「送料決済仕様のKOMOJU決済連携を実装して」
4. 「送料決済仕様の管理者用決済リンク機能を実装して」

---

## 9. 未決定事項

- [ ] 沖縄県の送料（現在の送料表に含まれていない → 別途案内 or 料金追加）
- [ ] 離島の扱い
- [ ] 40点超の場合の大まかな上限（100点等）
- [ ] 会員割引は送料にも適用するか（通常は商品代のみ）
- [ ] 送料の税込/税別表記
