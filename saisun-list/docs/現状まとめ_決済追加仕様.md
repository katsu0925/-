# デタウリ.Detauri — 現状まとめ & 決済方法追加 実装仕様書

最終更新: 2026-02-15

---

## Part 1: 現状まとめ

### システム全体像

```
┌────────────────────────┐
│  フロントエンド          │  index.html (SPA)
│  Cloudflare Pages       │  HTML + CSS + JS 一体型
└────────┬───────────────┘
         │ fetch (JSON RPC)
┌────────▼───────────────┐
│  GAS Web App           │  Code.gs (doGet/doPost)
│  バックエンド            │  22個の.gsファイル
└────────┬───────────────┘
         │
    ┌────┼────┬────────────┐
    ▼    ▼    ▼            ▼
 データ1  依頼管理  顧客管理   外部サービス
 (商品)  (受注)   (認証)     KOMOJU/BASE/OpenAI
```

---

### 機能一覧と実装状況

#### フロントエンド (index.html)

| 機能 | 状態 | 概要 |
|---|---|---|
| 商品一覧表示 | 実装済 | ページネーション、画像表示、価格表示 |
| ブランド/カテゴリフィルター | 実装済 | マルチセレクト、ひらがな/カタカナ対応検索 |
| ソート機能 | 実装済 | 価格順、新着順、名前順 |
| 商品詳細モーダル | 実装済 | 採寸データ、傷汚れ詳細、画像ズーム |
| カートシステム | 実装済 | 追加/削除、15分確保、最低10点 |
| 送料自動計算 | 実装済 | 住所入力でリアルタイム計算 |
| KOMOJU決済連携 | 実装済 | クレジット/コンビニ/銀行振込 |
| 後決済モード | 実装済 | 上限超過時のフォールバック |
| 会員認証 | 実装済 | 登録/ログイン/セッション管理 |
| 会員ランク表示 | 実装済 | レギュラー〜ダイヤモンド |
| ポイント利用 | 実装済 | カート内でポイント適用 |
| マイページ | 実装済 | 注文履歴、プロフィール、ポイント |
| AIチャットボット | 実装済 | FAQ定型 + OpenAI GPT-4o-mini |
| 送料表モーダル | 実装済 | 地域別送料一覧、スクロールインジケーター |
| 商品ガイドモーダル | 実装済 | 注文方法、割引説明 |
| 特定商取引法モーダル | 実装済 | 法的表記 |
| お問い合わせモーダル | 実装済 | メールフォーム |
| プロモバナー | 実装済 | 会員割引告知、非表示可 |

#### バックエンド (GAS)

| 機能 | ファイル | 状態 |
|---|---|---|
| API ルーティング | Code.gs | 実装済 |
| 商品データ管理 | Product.gs, DateExport.gs | 実装済 |
| 商品管理連携 | コード.gs | 実装済 |
| 注文送信 | SubmitFix.gs | 実装済 |
| 決済処理 | KOMOJU.gs | 実装済 |
| 顧客認証 | CustomerAuth.gs | 実装済 |
| ランク/ポイント | CustomerAuth.gs | 実装済 |
| 在庫確保 | StateStore.gs, Orders.gs | 実装済 |
| ステータス管理 | Status.gs, StatusSync.gs | 実装済 |
| チャットボット | Chatbot.gs | 実装済 |
| 発送通知 | 発送通知.gs | 実装済 |
| BASE EC連携 | BASEAPI.gs, BASE_注文→依頼管理.gs | 実装済 |
| 管理画面 | Admin.html, ApiAdmin.gs | 実装済 |
| テストスイート | Tests.gs | 実装済 |
| reCAPTCHA v3 | Code.gs | 実装済 |
| CSRF対策 | Code.gs | 実装済 |
| レート制限 | Code.gs | 実装済 |

---

### 割引制度

| 割引 | 率 | 条件 | 適用対象 |
|---|---|---|---|
| 30点まとめ買い割引 | 10%OFF | 30点以上注文 | 商品代のみ |
| 会員割引 | 10%OFF | 会員登録済（2026年9月末まで） | 商品代のみ |
| 併用 | 最大20%OFF | 両方適用時 | 商品代のみ |

※送料は割引対象外

### 会員ランク制度

| ランク | 年間購入額 | ポイント還元 | 特典 |
|---|---|---|---|
| レギュラー | - | 1% | 会員割引 |
| シルバー | 5万円〜 | 3% | |
| ゴールド | 20万円〜 | 5% | |
| ダイヤモンド | 50万円〜 | 5% | **送料無料** |

---

### 現在の決済方法

| 決済方法 | 状態 | コンビニ手数料 | 入金ステータス |
|---|---|---|---|
| クレジットカード (Visa/Mastercard) | **利用可能** | - | 即時完了 |
| コンビニ払い | **利用可能** | 220円 | 入金待ち |
| 銀行振込 | **利用可能** | 振込手数料は顧客負担 | 入金待ち |
| クレジットカード (JCB/AMEX/Diners/Discover) | **申請中** | - | - |
| PayPay | **申請中** | - | - |
| Paidy（あと払い） | **申請中** | - | - |
| LINE Pay | サービス終了 | - | - |
| メルペイ | 使用しない | - | - |

---

### セキュリティ

| 項目 | 実装 |
|---|---|
| パスワード | SHA-256 × 10,000回 + ランダムソルト (v2形式) |
| セッション | 32文字ランダムID / 24時間（remember-me: 30日） |
| CSRF | 1時間有効トークン + タイミングセーフ比較 |
| reCAPTCHA | v3 / スコア閾値 0.3 |
| レート制限 | API別に設定（注文5回/h、確保30回/min等） |
| KOMOJU Webhook | HMAC-SHA256 署名検証 |
| 決済API検証 | Webhook受信後にAPIで裏取り確認 |

---

## Part 2: 決済方法追加 実装仕様書

### 追加予定の決済方法

| 決済方法 | KOMOJU payment_type | 手数料 | 入金タイミング |
|---|---|---|---|
| JCB/AMEX/Diners/Discover | `credit_card` | なし | 即時 |
| PayPay | `paypay` | なし | 即時 |
| Paidy（あと払い） | `paidy` | なし | 後払い |

---

### 1. JCB/AMEX/Diners/Discover 対応

#### 概要
KOMOJUのクレジットカード決済に追加ブランドが有効化される。コード変更は**最小限**。

#### 変更箇所

**変更不要なファイル:**
- `KOMOJU.gs` — `payment_types: ['credit_card']` は既に含まれている。KOMOJUダッシュボード側で対応ブランドが有効化されれば、同じ `credit_card` タイプで自動的にJCB/AMEX等が表示される
- `SubmitFix.gs` — 変更なし
- `index.html` — 決済はKOMOJUのホスト画面で行うため変更なし

**変更が必要なファイル:**

| ファイル | 変更内容 |
|---|---|
| `KOMOJU.gs` L22 | コメント更新: `※JCB/AMEX/Diners/Discover(日本)は申請中` → `利用可能` |
| `index.html` チャットボットFAQ | 決済方法の回答を更新 |
| `index.html` 特定商取引法モーダル | 「クレジットカード」の記載にブランド名追加 |
| `docs/送料決済仕様.md` | 対応状況テーブル更新 |

#### 実装手順

```
1. KOMOJUダッシュボードで新ブランドが有効化されたことを確認
2. 以下のコメント・テキストを更新:
```

**KOMOJU.gs (L22):**
```javascript
// 変更前:
'credit_card',      // クレジットカード（Visa/Mastercard）※JCB/AMEX/Diners/Discover(日本)は申請中

// 変更後:
'credit_card',      // クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）
```

**index.html — チャットボットFAQ（決済方法の回答）:**
```javascript
// 変更前:
a: '【ご利用可能な決済方法】\n・クレジットカード\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n\nクレジットカードが最もスムーズにお手続きいただけます。'

// 変更後:
a: '【ご利用可能な決済方法】\n・クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n\nクレジットカードが最もスムーズにお手続きいただけます。'
```

**作業時間目安: 10分**（テキスト更新のみ）

---

### 2. PayPay 対応

#### 概要
KOMOJUの `paypay` 決済タイプを追加。即時決済のため、クレジットカードと同じ入金フローになる。

#### 変更箇所

| ファイル | 変更内容 | 作業量 |
|---|---|---|
| `KOMOJU.gs` | paymentMethods に `'paypay'` 追加 | 1行 |
| `KOMOJU.gs` | 入金ステータス判定に PayPay 追加 | 数行 |
| `index.html` | チャットボットFAQ更新 | テキスト |
| `index.html` | 特定商取引法モーダル更新 | テキスト |
| `index.html` | トップ注記エリア更新 | テキスト |
| `Chatbot.gs` | システムプロンプト更新 | テキスト |
| `docs/送料決済仕様.md` | 対応状況テーブル更新 | テキスト |

#### 具体的な変更コード

**KOMOJU.gs — paymentMethods 配列 (L22-30):**
```javascript
// 変更前:
paymentMethods: [
  'credit_card',      // クレジットカード
  'konbini',          // コンビニ払い
  'bank_transfer'     // 銀行振込
  // 'paypay'         // PayPay — 申請中
  // 'paidy'          // Paidy（あと払い） — 申請中
],

// 変更後:
paymentMethods: [
  'credit_card',      // クレジットカード
  'konbini',          // コンビニ払い
  'bank_transfer',    // 銀行振込
  'paypay'            // PayPay
  // 'paidy'          // Paidy（あと払い） — 申請中
],
```

**KOMOJU.gs — 入金ステータス判定 (L299-306):**
```javascript
// 変更前:
var paymentStatus = '未対応';
if (paymentMethodType === 'konbini' || paymentMethodType === 'bank_transfer') {
  paymentStatus = '入金待ち';
}

// 変更後:
var paymentStatus = '未対応';
if (paymentMethodType === 'konbini' || paymentMethodType === 'bank_transfer') {
  paymentStatus = '入金待ち';
}
// PayPayは即時決済のため '未対応'（入金済み・処理待ち）のまま
```

> PayPayは即時決済なので、クレジットカードと同じ `'未対応'`（= 入金済み、対応待ち）ステータスでOK。コード変更はコメント追加のみ。

**index.html — チャットボットFAQ:**
```javascript
// 変更後:
a: '【ご利用可能な決済方法】\n・クレジットカード（Visa/Mastercard/JCB/AMEX等）\n・PayPay\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n\nクレジットカードまたはPayPayが最もスムーズにお手続きいただけます。'
```

**index.html — トップ注記エリア（決済方法表示部分）:**
```
クレジットカード / PayPay / コンビニ払い / 銀行振込
```

**Chatbot.gs — システムプロンプト内の決済方法記述を更新:**
```
決済方法: クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）、PayPay、コンビニ払い（手数料220円）、銀行振込（手数料は顧客負担）
```

**作業時間目安: 15分**

---

### 3. Paidy（あと払い）対応

#### 概要
KOMOJUの `paidy` 決済タイプを追加。**後払い**のため入金フローに注意が必要。

#### Paidyの特徴
- 顧客は購入時に支払い不要（メアド+電話番号で認証）
- 翌月にコンビニ/銀行振込で支払い
- KOMOJUが代金を立て替えて店舗に入金
- → 店舗側は**即時入金扱い**（KOMOJUから見ると captured）

#### 変更箇所

| ファイル | 変更内容 | 作業量 |
|---|---|---|
| `KOMOJU.gs` | paymentMethods に `'paidy'` 追加 | 1行 |
| `KOMOJU.gs` | 入金ステータス判定にPaidy追加（任意） | 数行 |
| `index.html` | チャットボットFAQ更新 | テキスト |
| `index.html` | 特定商取引法モーダル更新 | テキスト |
| `index.html` | トップ注記エリア更新 | テキスト |
| `Chatbot.gs` | システムプロンプト更新 | テキスト |
| `docs/送料決済仕様.md` | 対応状況テーブル更新 | テキスト |

#### 具体的な変更コード

**KOMOJU.gs — paymentMethods 配列:**
```javascript
// 変更後:
paymentMethods: [
  'credit_card',      // クレジットカード
  'konbini',          // コンビニ払い
  'bank_transfer',    // 銀行振込
  'paypay',           // PayPay
  'paidy'             // Paidy（あと払い）
],
```

**KOMOJU.gs — 入金ステータス判定:**
```javascript
var paymentStatus = '未対応';
if (paymentMethodType === 'konbini' || paymentMethodType === 'bank_transfer') {
  paymentStatus = '入金待ち';
}
// PayPay: 即時決済 → '未対応'（入金済み・処理待ち）
// Paidy: KOMOJUが立替入金 → '未対応'（入金済み・処理待ち）として扱う
```

> Paidyは顧客が後払いでもKOMOJUが立替入金するため、Webhook上は `payment.captured` が来る。
> したがって入金ステータスはクレカと同じ `'未対応'` でOK。

**index.html — チャットボットFAQ:**
```javascript
a: '【ご利用可能な決済方法】\n・クレジットカード（Visa/Mastercard/JCB/AMEX等）\n・PayPay\n・あと払い（Paidy）\n・コンビニ決済（別途手数料220円）\n・銀行振込（振込手数料はお客様負担）\n\nクレジットカード・PayPay・あと払いが最もスムーズにお手続きいただけます。'
```

**作業時間目安: 15分**

---

### 4. 全決済方法対応後の最終状態

#### KOMOJU.gs の paymentMethods:
```javascript
paymentMethods: [
  'credit_card',      // クレジットカード（Visa/Mastercard/JCB/AMEX/Diners/Discover）
  'konbini',          // コンビニ払い
  'bank_transfer',    // 銀行振込
  'paypay',           // PayPay
  'paidy'             // Paidy（あと払い）
],
```

#### 入金ステータスのマッピング:
```
credit_card  → '未対応'（即時決済 = 入金済み、処理待ち）
paypay       → '未対応'（即時決済 = 入金済み、処理待ち）
paidy        → '未対応'（KOMOJUが立替入金 = 入金済み、処理待ち）
konbini      → '入金待ち'（顧客が支払うまで待機）
bank_transfer→ '入金待ち'（顧客が振り込むまで待機）
```

#### Webhookイベントの対応:
```
payment.captured / payment.authorized
  → handlePaymentSuccess_() → confirmPaymentAndCreateOrder()
  → 全決済方法で同じフロー（変更不要）

payment.failed / payment.expired
  → handlePaymentFailed_() → 状態記録
  → 全決済方法で同じフロー（変更不要）
```

---

### 5. 変更ファイル一覧（決済追加すべて完了時）

| ファイル | 変更量 | 変更内容 |
|---|---|---|
| **KOMOJU.gs** | 小 | paymentMethods 配列に2行追加 + コメント更新 |
| **index.html** (FAQ) | 小 | 決済方法の回答テキスト更新（1箇所） |
| **index.html** (特商法) | 小 | 決済方法の記載更新 |
| **index.html** (トップ注記) | 小 | 決済方法テキスト更新 |
| **Chatbot.gs** | 小 | システムプロンプトの決済方法記述更新 |
| **docs/送料決済仕様.md** | 小 | 対応状況テーブル更新 |

#### 重要: 変更が不要なファイル
- `SubmitFix.gs` — 決済フローの分岐ロジックに変更なし
- `Code.gs` — APIルーティングに変更なし
- `CustomerAuth.gs` — 認証に変更なし
- `Config.gs` — 送料計算に変更なし
- `index.html` (JS) — 決済はKOMOJUホスト画面のため、フロントのJS変更なし

---

### 6. テスト手順

#### 各決済方法の共通テスト項目

```
□ テストモードで決済セッション作成 → KOMOJU画面に新しい決済方法が表示される
□ テスト決済を実行 → payment.captured Webhookが正常に処理される
□ 依頼管理シートに正しいデータが書き込まれる
  - AE列（決済方法）に正しい値 (credit_card / paypay / paidy)
  - AF列（決済ID）にKOMOJU payment ID
  - R列（入金確認）に正しいステータス
  - L列（合計金額）が正しい
□ 管理者宛メール・顧客宛メールが正常に送信される
□ 決済失敗テスト → payment.failed → 状態が正しく記録される
□ 本番モードに切り替え → 実決済テスト
```

#### PayPay固有のテスト

```
□ KOMOJU画面でPayPayが選択肢として表示される
□ PayPayアプリ連携の決済フローが動作する
□ QRコード表示が正常
```

#### Paidy固有のテスト

```
□ KOMOJU画面でPaidy（あと払い）が選択肢として表示される
□ メールアドレス + 電話番号での認証フローが動作する
□ 翌月払いの案内が正しく表示される
```

---

### 7. 実装手順（申請通過後にこう伝えてください）

#### JCBカード等のブランド追加が通った場合:
> **「JCB/AMEX等のクレジットカードブランド追加が通った。コメントとテキストを更新して」**

#### PayPayが通った場合:
> **「PayPay決済が通った。KOMOJU.gsにpaypayを追加して、FAQとチャットボットと特商法も更新して」**

#### Paidyが通った場合:
> **「Paidy決済が通った。KOMOJU.gsにpaidyを追加して、FAQとチャットボットと特商法も更新して」**

#### 全部まとめて通った場合:
> **「PayPay/Paidy/JCBカードブランド全部通った。決済方法を全部追加して」**

---

### 8. 注意事項

1. **KOMOJUダッシュボードでの有効化が前提**: コードの変更だけでは動作しない。KOMOJU管理画面で各決済方法が有効になっていることを確認すること
2. **テストモードで先にテスト**: `KOMOJU_MODE` が `test` の状態でテスト決済を行い、Webhookの動作を確認してから本番切り替え
3. **Webhook URLは変更不要**: 既存のWebhook URLがそのまま使える（新決済方法も同じエンドポイントに通知される）
4. **決済手数料はKOMOJU側で処理**: 加盟店手数料はKOMOJUが計算・徴収するため、コード側での手数料計算は不要
